/*! For license information please see hls.js.LICENSE.txt */
!function uv(cv){const hv=this;var e,t;e=this,t=function(){"use strict";var K,q,c,e=e=>e&&e.Math===Math&&e,l=e("object"==typeof globalThis&&globalThis)||e("object"==typeof window&&window)||e("object"==typeof hv&&hv)||e("object"==typeof global&&global)||Function("return this")();class v extends Error{constructor(e,t,i,r,n,a){super(n),this.type=e,this.details=t,this.fatal=i,this.response=r,this.handled=!1,a&&(this.stack=a),n&&(this._message=n)}get message(){return this._message||(this._message=this.constructor.name+` code=`+this.response),this._message}}class j extends v{constructor(e,t,i,r,n){super(e,t,i,r,n),this.response=r}}class A extends v{constructor(e,t){super(K.MEDIA_ERROR,q.MANIFEST_INCOMPATIBLE_ERROR,!0,e),this.platformCapabilityFilterBreakdown=t}}const pe={PlaylistNotReceived:-12884,CryptResponseReceivedSlowly:-16833,LivePlaylistUpdateError:-12888,NoResponseFromMediaRequest:-12889,IncompatibleAsset:-12927,CorruptStream:-16041,InternalError:-12645,CantSwitchInTime:-12644,VideoDecoderBadDataErr:-12909,InsufficientDataAvailable:-12928,AllocationFailed:-12862,PlaylistErrorMissingEXTM3U:-12269,PlaylistErrorInvalidEntry:-12264,PlaylistErrorBadTargetDuration:-12271,NoValidAlternates:-12925,FormatError:-12642,ContentHasGap:-15419,UnsupportedKeySystemError:-6e4,EmptyLoadSourceError:-60001,UndefinedItemIdError:-60002,ManifestParseError:-60003,DemuxWorkerError:-60004,DecryptWorkerError:-60005,OutOfRangeSeekError:-60006,ExceptionInKeyLoadError:-60007,FragmentAbortError:-60008,ManifestTimeoutError:-60009,PlaylistTimeoutError:-60010,FragmentTimeoutError:-60011,IncompleteSessionData:-60012,SessionDataLoadTimeout:-60013,FailedDemuxerSanityCheck:-60014,InvalidADTSSamplingIndex:-60015,DemuxerNotFound:-60016,InvalidInitTimestamp:-60017,NoAVSamplesFound:-60018,NoTSSyncByteFound:-60019,PESDidNotStartWithADTS:-60020,NoADTSHeaderInPES:-60021,InvalidDolbyAudioMagic:-60022,FailedToAllocateVideoMdat:-60023,FailedToAllocateAudioMdat:-60024,InsufficientEC3Data:-60025,InvalidEC3Magic:-60026,ReservedStreamType:-60027,InsufficientAC3Data:-60028,InvalidAC3Magic:-60029,InvalidAC3SamplingRateCode:-60030,LivePlaylistTooFar:-60031,XhrError:-60032,UnsupportedVideoCodec:-60033,UnsupportedByPlatformCaps:-60034,UnsupportedVideoDynamicRange:-60035,UnsupportedKeySystemAccess:-60036,SourceBufferRemoveError:-60037,SourceBufferAbortError:-60038,SourceBufferUpdatingError:-60039,ExceptionInLegacyEventHandler:-60040,ExceptionInKeyRequest:-60041,NoValidFirstAlternate:-60042,MixedLiveSyncDurationConfig:-60043,InvalidRequiredStartDuration:-60044,InvalidLoadImageIframe:-60045,NoSegmentDetailsEntity:-60046,NoSegmentDetails:-60047,InvalidMediaOptionType:-60048,IFrameVariantNotFound:-60049,MdatNotFound:-60050,DemuxRemuxProbeNotFound:-60051,ExpGolombNoAvailableBytes:-60052,createRPCWorkerNotBundled:-60053,createRPCServiceMissingFallbacks:-60054,RPCInlineInvokeCommandNotFound:-60055,RPCWorkerCommandNotFound:-60056,JSAESDecryptInvalidKey:-60057,InvalidAudioCodec:-60058,MismatchCodecFamily:-60059,TopologicalSortCycle:-60060,RankIdentifierComparisonError:-60061,URLParseError:-60062,NoIframeFragmentToPrefetch:-60063,NoVariantMediaOptionToPrefetch:-60064,NoFragmentFoundAtSearchPositionInPlaylist:-60065,WebVTTMalformedXTIMESTAMPMAP:-60066,PlayRejected:-60067,CrashInRtcLib:-60068,UnableToQueueInterstitialSourceMissingPrimaryItem:-60069,UnableToQueueInterstitialSourceIncorrectConfiguration:-60070,UnableToSetTimeToPauseBufferIncorrectConfiguration:-60071,UnableToDeQueueInterstitialSourceMissingMediaElementAdaptor:-60072,XhrSetupNetworkError:-60073,UnsupportedHDCPLevel:-60074,UnsupportedSecurityLevel:-60075,UnsupportedByMediaCapabilities:-60076,UnsupportedByMediaSource:-60077,UnsupportedAudioCodec:-60078,PlaylistErrorInvalidEXTXDEFINE:-61e3,PlaylistErrorMissingImportReference:-61001,PlaylistErrorInvalidSERVERURI:-61002,PlaylistErrorInvalidPATHWAYID:-61003,PlaylistErrorInvalidSCORE:-61004,KeySystemFailedToUpdateSession:-62e3,KeySystemFailedToGenerateLicenseRenewal:-62001,KeySystemFailedToGenerateLicenseRequest:-62002,KeySystemAbort:-62003,KeySystemUnexpectedStateTransition:-62004,KeySystemUnexpectedState:-62005,KeySystemCDMUnknownError:-62006,KeySystemRequestTimedOut:-62007,KeySystemUnexpectedMETHOD:-62008,KeySystemUnmatchedString:-62009,KeySystemInternalError:-62010,KeySystemOutputRestricted:-62011,KeySystemSetupError:-62012,KeySystemFailedToInitialize:-62013,KeySystemFailedToCreateSession:-62014,KeySystemUndefinedNavigator:-62015,KeySystemNoKeySystemsToTry:-62016,KeySystemNoConstructor:-62017,KeySystemNoKeySystemAccess:-62018,KeySystemCertificateLoadError:-62019,KeySystemFailedToReleaseLicense:-62020,KeySystemRequestMediaKeySystemAccessError:-62021,KeySystemSetServerCertificateError:-62022,KeySystemCouldNotCreateMediaKeySession:-62023,KeySystemCouldNotSetMediaKeys:-62024,KeySystemUndefinedChallenge:-62025,KeySystemExceedMaxKeys:-62026,SBEmptyMediaSource:-63e3,SBNullCurrentInitSegmentInfo:-63001,SBNullCurrentSBEntity:-63002,SBNullSourceBuffer:-63003,SBNotInitialized:-63004};(e=K=K||{}).NETWORK_ERROR="networkError",e.MEDIA_ERROR="mediaError",e.MUX_ERROR="muxError",e.KEY_SYSTEM_ERROR="keySystemError",e.OTHER_ERROR="otherError",(e=q=q||{}).MANIFEST_LOAD_ERROR="manifestLoadError",e.MANIFEST_LOAD_TIMEOUT="manifestLoadTimeOut",e.MANIFEST_PARSING_ERROR="manifestParsingError",e.MANIFEST_INCOMPATIBLE_ERROR="manifestIncompatibleError",e.LEVEL_LOAD_ERROR="levelLoadError",e.LEVEL_LOAD_TIMEOUT="levelLoadTimeOut",e.LEVEL_SWITCH_ERROR="levelSwitchError",e.AUDIO_TRACK_LOAD_ERROR="audioTrackLoadError",e.AUDIO_TRACK_LOAD_TIMEOUT="audioTrackLoadTimeOut",e.SUBTITLE_TRACK_LOAD_ERROR="subtitleTrackLoadError",e.SUBTITLE_TRACK_LOAD_TIMEOUT="subtitleTrackLoadTimeout",e.FRAG_LOAD_ERROR="fragLoadError",e.FRAG_LOOP_LOADING_ERROR="fragLoopLoadingError",e.FRAG_LOAD_TIMEOUT="fragLoadTimeOut",e.FRAG_DECRYPT_ERROR="fragDecryptError",e.FRAG_PARSING_ERROR="fragParsingError",e.FRAG_ABORT_ERROR="fragAbortError",e.REMUX_ALLOC_ERROR="remuxAllocError",e.BUFFER_ADD_CODEC_ERROR="bufferAddCodecError",e.BUFFER_APPEND_ERROR="bufferAppendError",e.BUFFER_APPENDING_ERROR="bufferAppendingError",e.BUFFER_STALLED_ERROR="bufferStalledError",e.BUFFER_FULL_ERROR="bufferFullError",e.BUFFER_SEEK_OVER_HOLE="bufferSeekOverHole",e.BUFFER_NUDGE_ON_STALL="bufferNudgeOnStall",e.SOURCE_BUFFER_ERROR="sourceBufferError",e.INTERNAL_EXCEPTION="internalException",e.WEBVTT_EXCEPTION="webVTTException",e.KEY_LOAD_ERROR="keyLoadError",e.KEY_LOAD_TIMEOUT="keyLoadTimeOut",e.KEY_SYSTEM_GENERIC_ERROR="keySystemGenericError",e.CERT_LOAD_ERROR="certificateLoadError",e.CERT_LOAD_TIMEOUT="certificateLoadTimeOut",e.SESSION_DATA_LOAD_ERROR="sessionDataLoadError",e.SESSION_DATA_LOAD_TIMEOUT="sessionDataLoadTimeOut",e.STEERING_MANIFEST_LOAD_ERROR="steeringManifestLoadError",e.STEERING_MANIFEST_LOAD_TIMEOUT="steeringManifestLoadTimeOut",e.STEERING_MANIFEST_PARSING_ERROR="steeringManifestParsingError",e.INTERSTITIAL_ASSET_LIST_LOAD_ERROR="interstitialAssetListLoadError",e.INTERSTITIAL_ASSET_LIST_LOAD_TIMEOUT="interstitialAssetListLoadTimeout",e.INTERSTITIAL_ASSET_LIST_PARSING_ERROR="interstitialAssetListParsingError",e.MEDIA_ELEMENT_ERROR="mediaElementError",e.UNKNOWN="";class me extends v{constructor(e,t,i,r){super(K.OTHER_ERROR,q.INTERNAL_EXCEPTION,e,t,i,r)}}class s extends v{constructor(e){super(K.MEDIA_ERROR,q.MEDIA_ELEMENT_ERROR,!0,pe.InternalError,e)}}class d{constructor(){this.t=[],this.o=[],this.l=[],this.h=null,this.p=null,this.m=null,this.g=null,this.t=[0,1,2,4,8,16,32,64,128,27,54],this.o=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.l=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.S=new Uint32Array(256),this.I=new Uint32Array(256),this.T=new Uint32Array(0),this.O()}M(e){var t=new DataView(e),i=Math.floor(t.byteLength/4),r=new Uint32Array(i);for(let e=0;e<i;e++)r[e]=t.getUint32(4*e);return r}O(){const e=this["S"],t=this["I"],i=this["o"],r=i[0],n=i[1],a=i[2],s=i[3],o=this["l"],l=o[0],d=o[1],u=o[2],c=o[3],h=new Uint32Array(256);let p=0,m=0,f=0;for(f=0;f<256;f++)h[f]=f<128?f<<1:f<<1^283;for(f=0;f<256;f++){var g=(g=m^m<<1^m<<2^m<<3^m<<4)>>>8^255&g^99;e[p]=g,t[g]=p;const o=h[p],f=h[o],v=h[f];var y=257*h[g]^16843008*g;r[p]=y<<24|y>>>8,n[p]=y<<16|y>>>16,a[p]=y<<8|y>>>24,s[p]=y,y=16843009*v^65537*f^257*o^16843008*p,l[g]=y<<24|y>>>8,d[g]=y<<16|y>>>16,u[g]=y<<8|y>>>24,c[g]=y,p?(p=o^h[h[h[v^o]]],m^=h[h[m]]):p=m=1}}expandKey(n){var a=this.M(n);let e=!0,t=0;for(;t<a.length&&e;)e=a[t]===this.T[t],t++;if(!e){this.T=a;var s=this.h=a.length;if(4!==s&&6!==s&&8!==s)throw new me(!1,pe.JSAESDecryptInvalidKey,"Invalid aes key size="+s);var o=this.p=4*(s+6+1);let e,t;var l=this.m=new Uint32Array(o),d=this.g=new Uint32Array(o),u=this.S,c=this["t"],n=this["l"],h=n[0],p=n[1],m=n[2],f=n[3];let i,r;for(e=0;e<o;e++)e<s?i=l[e]=a[e]:(r=i)&&(e%s==0?(r=u[(r=r<<8|r>>>24)>>>24]<<24|u[r>>>16&255]<<16|u[r>>>8&255]<<8|u[255&r],r^=c[e/s|0]<<24):6<s&&e%s==4&&(r=u[r>>>24]<<24|u[r>>>16&255]<<16|u[r>>>8&255]<<8|u[255&r]),l[e]=i=(l[e-s]^r)>>>0);for(t=0;t<o;t++)e=o-t,r=3&t?l[e]:l[e-4],d[t]=t<4||e<=4?r:h[u[r>>>24]]^p[u[r>>>16&255]]^m[u[r>>>8&255]]^f[u[255&r]],d[t]=d[t]>>>0}}A(e){return e<<24|(65280&e)<<8|(16711680&e)>>8|e>>>24}decrypt(e,t,i){var r,n,a=this.h?this.h+6:0,s=this["g"],o=this.I,l=this["l"],d=l[0],u=l[1],c=l[2],h=l[3],l=this.M(i);let p=l[0],m=l[1],f=l[2],g=l[3];var y=new Int32Array(e),v=new Int32Array(y.length);let I,S,b,T,A,E,O,w,R,M,P,C,k,L;for(var D=this.A;t<y.length;){for(R=D(y[t]),M=D(y[t+1]),P=D(y[t+2]),C=D(y[t+3]),A=R^(null!=(n=null==s?void 0:s[0])?n:0),E=C^(null!=(n=null==s?void 0:s[1])?n:0),O=P^(null!=(n=null==s?void 0:s[2])?n:0),w=M^(null!=(n=null==s?void 0:s[3])?n:0),k=4,L=1;L<a;L++)I=d[A>>>24]^u[E>>16&255]^c[O>>8&255]^h[255&w]^(null!=(r=null==s?void 0:s[k])?r:0),S=d[E>>>24]^u[O>>16&255]^c[w>>8&255]^h[255&A]^(null!=(r=null==s?void 0:s[k+1])?r:0),b=d[O>>>24]^u[w>>16&255]^c[A>>8&255]^h[255&E]^(null!=(r=null==s?void 0:s[k+2])?r:0),T=d[w>>>24]^u[A>>16&255]^c[E>>8&255]^h[255&O]^(null!=(r=null==s?void 0:s[k+3])?r:0),A=I,E=S,O=b,w=T,k+=4;I=o[A>>>24]<<24^o[E>>16&255]<<16^o[O>>8&255]<<8^o[255&w]^(null!=(n=null==s?void 0:s[k])?n:0),S=o[E>>>24]<<24^o[O>>16&255]<<16^o[w>>8&255]<<8^o[255&A]^(null!=(n=null==s?void 0:s[k+1])?n:0),b=o[O>>>24]<<24^o[w>>16&255]<<16^o[A>>8&255]<<8^o[255&E]^(null!=(n=null==s?void 0:s[k+2])?n:0),T=o[w>>>24]<<24^o[A>>16&255]<<16^o[E>>8&255]<<8^o[255&O]^(null!=(n=null==s?void 0:s[k+3])?n:0),k+=3,v[t]=D(I^p),v[t+1]=D(T^m),v[t+2]=D(b^f),v[t+3]=D(S^g),p=R,m=M,f=P,g=C,t+=4}return v.buffer}destroy(){this.T=new Uint32Array,this.h=null,this.p=null,this.S=new Uint32Array,this.I=new Uint32Array,this.o=[],this.l=[],this.m=null,this.g=null,this.t=[]}}class o{constructor(e,t){this.N=e,this.R=t,this.decrypt=(r,n,a,s,o)=>t=>{const i=l.crypto;if(null!=o&&o.useJSCrypto||null==i||!i.subtle){const a=new d;var e;a.expandKey(r);const i=a.decrypt(s,0,n);e=o.plainTextLength?i.slice(0,o.plainTextLength):function(e){var t=new Uint8Array(e),i=t[e.byteLength-1],r=e.byteLength-1;let n=0;if(1<=i&&i<=16)for(let e=r;e>r-i&&t[e]===i;e--)n++;return e=n===i?e.slice(0,r-i+1):e}(i),t(e,void 0,[e])}else i.subtle.importKey("raw",r,a,!1,["decrypt"]).then(e=>i.subtle.decrypt({name:a,iv:n},e,s)).then(e=>{t(e,void 0,[e])}).catch(e=>t(void 0,e))},e.register("decrypt",this.decrypt)}}(e=c=c||{}).MEDIA_ATTACHING="hlsMediaAttaching",e.MEDIA_ATTACHED="hlsMediaAttached",e.MEDIA_DETACHING="hlsMediaDetaching",e.MEDIA_DETACHED="hlsMediaDetached",e.BUFFER_CREATED="hlsBufferCreated",e.BUFFER_APPENDING="hlsBufferAppending",e.BUFFER_APPENDED="hlsBufferAppended",e.BUFFER_FLUSHED="hlsBufferFlushed",e.MANIFEST_LOADING="hlsManifestLoading",e.MANIFEST_LOADED="hlsManifestLoaded",e.MANIFEST_PARSED="hlsManifestParsed",e.LEVEL_SWITCHING="hlsLevelSwitching",e.LEVEL_SWITCHED="hlsLevelSwitched",e.LEVEL_LOADING="hlsLevelLoading",e.LEVEL_LOADED="hlsLevelLoaded",e.LEVEL_UPDATED="hlsLevelUpdated",e.LEVELS_CHANGED="hlsLevelsChanged",e.AUDIO_TRACKS_UPDATED="hlsAudioTracksUpdated",e.AUDIO_TRACK_SWITCH="hlsAudioTrackSwitch",e.AUDIO_TRACK_SWITCHED="hlsAudioTrackSwitched",e.AUDIO_TRACK_LOADED="hlsAudioTrackLoaded",e.SUBTITLE_TRACKS_UPDATED="hlsSubtitleTracksUpdated",e.SUBTITLE_TRACKS_CREATED="hlsSubtitleTracksCreated",e.SUBTITLE_TRACK_SWITCH="hlsSubtitleTrackSwitch",e.INLINE_STYLES_PARSED="hlsInlineStylesParsed",e.SESSION_DATA_COMPLETE="hlsSessionDataComplete",e.FRAG_LOADING="hlsFragLoading",e.FRAG_LOADED="hlsFragLoaded",e.FRAG_BUFFERED="hlsFragBuffered",e.FRAG_CHANGED="hlsFragChanged",e.INTERNAL_ERROR="hlsInternalError",e.ERROR="hlsError",e.DESTROYING="hlsDestroying",e.KEY_REQUEST_STARTED="hlsKeyRequestStarted",e.LICENSE_CHALLENGE_CREATED="hlsLicenseChallengeCreated",e.LICENSE_RELEASED="hlsLicenseReleased",e.KEY_LOADED="hlsKeyLoaded",e.UNRESOLVED_URI_LOADING="hlsUnresolvedUriLoading",e.DESIRED_RATE_CHANGED="hlsDesiredRateChanged",e.PLAYER_STATE_CHANGE="hlsPlayerStateChange",e.SEEKING="hlsSeeking",e.SEEKED="hlsSeeked",e.STALLED="hlsStalled",e.RESUME_FROM_STALL="hlsResumeFromStall",e.READY_TO_PREFETCH_NEXT_ITEM="hlsReadyToPrefetchNextItem",e.READY_FOR_NEXT_ITEM="hlsReadyForNextItem",e.ITEM_TRANSITIONED="hlsItemTransitioned",e.ITEM_PLAYING="hlsItemPlaying",e.ITEM_EVICTED="hlsItemEvicted",e.DATERANGE_UPDATED="hlsDaterangeUpdated",e.INTERSTITIALS_UPDATED="hlsInterstitialsUpdated",e.INTERSTITIAL_STARTED="hlsInterstitialStarted",e.INTERSTITIAL_ASSET_STARTED="hlsInterstitialAssetStarted",e.INTERSTITIAL_ASSET_ENDED="hlsInterstitialAssetEnded",e.INTERSTITIAL_ENDED="hlsInterstitialEnded",e.BUFFERED_TO_INTERSTITIAL_BOUNDARY="hlsBufferedToInterstitialBoundary",e.REACHED_TIME_TO_PAUSE_BUFFER="hlsReachedTimeToPauseBuffer",e.OFFLINE_FAIRPLAY_DEVICE_CAPS="hlsOfflineFairplayDeviceCaps";var E,L=c;(e=E=E||{}).FRAG_PARSING_INIT_SEGMENT="hlsFragParsingInitSegment",e.FRAG_PARSING_DATA="hlsFragParsingData",e.FRAG_PARSED="hlsFragParsed",e.INIT_PTS_FOUND="hlsInitPtsFound";class O extends v{constructor(e,t,i){super(K.MEDIA_ERROR,q.FRAG_PARSING_ERROR,e,t,i)}}class D extends v{constructor(e,t,i,r){super(K.MUX_ERROR,q.REMUX_ALLOC_ERROR,e,t,r),this.bytes=i}}function b(e){return null!=e&&"baseTime"in e&&"timescale"in e}function C(e){return e.baseTime/e.timescale}function x(e,t){return{baseTime:Math.floor(e*t),timescale:t}}function w(e,t){return{baseTime:Math.floor(e.baseTime*t/e.timescale),timescale:t}}function R(e,t){return b(e)&&!b(t)||(b(e)||!b(t))&&C(e)>C(t)?e:t}function _(e,t){return(e.baseTime*t.timescale-t.baseTime*e.timescale)/(e.timescale*t.timescale)}function u(e,t){return x(C(e)+t,e.timescale)}e=void 0!==l.Buffer?require("events").EventEmitter:class{constructor(){this.P={}}_(e,t,i=!1){return null==this.P[e]&&(this.P[e]=[]),i?this.P[e].splice(0,0,t):this.P[e].push(t),this}C(e,t){return null!=this.P[e]&&(this.P[e]=this.P[e].filter(e=>e.listener!==t.listener),0===this.P[e].length)&&delete this.P[e],this}on(e,t){return this._(e,{listener:t,once:!1})}off(e,t){return this.C(e,{listener:t})}addListener(e,t){return this.on(e,t)}once(e,t){return this._(e,{listener:t,once:!0})}removeListener(e,t){return this.off(e,t)}removeAllListeners(e){return e&&delete this.P[e],this}setMaxListeners(e){return this}getMaxListeners(){return 1/0}listeners(e){return null==this.P[e]?[]:this.P[e].map(e=>e.listener)}rawListeners(e){return this.listeners(e)}emit(e,...t){if(null==this.P[e])return!1;let i=!1;for(const r of this.P[e]){try{r.listener.apply(this,t)}catch(e){}i=!0}return i}listenerCount(e){return null==this.P[e]?0:this.P[e].length}prependListener(e,t){return this._(e,{listener:t,once:!1},!0)}prependOnceListener(e,t){return this._(e,{listener:t,once:!0},!0)}eventNames(){return Object.keys(this.P)}};class h extends e{trigger(e,t){this.emit(e,t)}}function p(e){return String.fromCharCode.apply(null,new Uint16Array(e))}function m(t){var e=new ArrayBuffer(2*t.length),i=new Uint16Array(e);for(let e=0;e<t.length;e++)i[e]=t.charCodeAt(e);return e}let f,g,De={strToUtf8array(e){var t=unescape(encodeURIComponent(e)),i=new Uint8Array(t.length);for(let e=0;e<t.length;e++)i[e]=t.charCodeAt(e);return i},utf8arrayToStr:e=>String.fromCharCode.apply(null,Array.from(e)),str2ab:m,ab2str:p};function $(e,t,i){var r,n;return e instanceof Uint8Array&&!t&&null==i?e:ArrayBuffer.isView(e)?(r=e.byteOffset+(null!=t?t:0),n=e.byteOffset+e.byteLength,n=null!=i?i:Math.max(0,n-r),new Uint8Array(e.buffer,r,n)):new Uint8Array(e,t,i)}function G(e,t,i){return e instanceof Uint8Array&&!t&&null==i?new Uint8Array(e):(e=$(e,t,i),(t=new Uint8Array(e.length)).set(e,0),t)}"undefined"!=typeof TextEncoder&&"undefined"!=typeof TextDecoder?De={strToUtf8array:e=>(f=f||new TextEncoder).encode(e),utf8arrayToStr:e=>(g=g||new TextDecoder("utf-8")).decode(e),str2ab:m,ab2str:p}:"function"==typeof(null==(Xe=l.Buffer)?void 0:Xe.from)&&(De={strToUtf8array(e){e=l.Buffer.from(e,"utf-8");return new Uint8Array(e.buffer,e.byteOffset,e.byteLength)},utf8arrayToStr:e=>l.Buffer.from(e).toString("utf-8"),str2ab:m,ab2str:p});const I={hexDump:function(e,t=1/0){if(!e)return"";var i=Array.isArray(e)||"length"in e?e:$(e);let r,n="";for(r=0;r<i.length&&r<t;r++){let e=i[r].toString(16);e.length<2&&(e="0"+e),n+=e}return n}};var M=I;function fe(e){return"number"==typeof e&&isFinite(e)}function xe(e,t){return fe(e)?e:t}function P(e,t){var i=Object.assign({},t);for(const r in t)if(r in e){const t=e[r];fe(t)&&(i[r]=t)}return i}function N(n,a,s=e=>!0){const o=n.length;if(0!==o){let t,i=Number.NEGATIVE_INFINITY,r=NaN;for(let e=0;e<o;e++){const o=n[e];s(o)&&(r=a(o))>=i&&(i=r,t=o)}return t}}function V(e,i=3){return JSON.stringify(e,(e,t)=>!isNaN(t)&&null!=t&&t.toFixed?Number(null==t?void 0:t.toFixed(i)):t)}const Q=["url","uri","relativeUrl","reloadURI"];let W=!0;function z(e){return e?W?"<redacted>":e:"undefined"}function Y(e){if(!e)return e;if("object"!=typeof e)return e;if(Array.isArray(e))return e.map(Y);if(e instanceof Set)return new Set(Array.from(e).map(Y));var t,i,r={};for([t,i]of Object.entries(e))r[t]=Y(i);return r}function X(e){return(" "+e).slice(1)}function J(t,e,i){var r;return Array.isArray(e)&&Array.isArray(i)&&e.length&&i.length&&([r,e]=null!=(r=ee(e,([e])=>e<=t))?r:e[0],fe(e=null!=(i=null==(e=i[e-i[0].mediaSeqNum])?void 0:e.start)?i:NaN))?[r,e]:[]}function Ne(e,t,i){var i=i.getTime(),[e,t]=J(i,e,t),t=t+(i-e)/1e3;return fe(t)?Math.max(0,t):0}function Z(e,t,i){var r,n;if(e&&0!==e.length)return[t,e]=(r=i,e=e,n=t,Array.isArray(e)&&Array.isArray(n)&&e.length&&n.length&&([t,e]=null!=(t=ee(e,([,e])=>n[e-n[0].mediaSeqNum].start<=r))?t:e[0],fe(e=null!=(e=null==(e=n[e-n[0].mediaSeqNum])?void 0:e.start)?e:NaN))?[t,e]:[]),fe(t=t+1e3*(i-e))?new Date(t):void 0}function ee(t,i){if(Array.isArray(t)&&!(t.length<1))for(let e=t.length-1;0<=e;e--){var r=t[e];if(i(r,e,t))return r}}function te(e){const a=new Map,s=[],o=new Set;return e.forEach(function(e){var t=e[0],e=e[1];a.has(t)||a.set(t,{id:t,afters:[]}),a.has(e)||a.set(e,{id:e,afters:[]}),null!=(t=a.get(t))&&t.afters.push(e)}),Array.from(a.keys()).forEach(e=>{!function t(e,i){var r=a.get(e);if(r){const n=r.id;o.has(e)||((i=Array.isArray(i)?i:[]).push(n),o.add(e),r.afters.forEach(function(e){if(0<=i.indexOf(e))throw new me(!1,pe.TopologicalSortCycle,`Cycle detected :  ${e} is in `+n);t(e.toString(),i.map(function(e){return e}))}),s.unshift(n))}}(e,[])}),s}function ie(e,t){return e.size===t.size&&Object.values(e).every(e=>t.has(e))}function re(e,t){return!(0<e)||null==t?void 0:t.split("\n").slice(0,e).join("\n")}function ne(e,r){if(e&&0!==e.length&&!(void 0!==r&&r<=0)){const n=new Date(e[0].timestampMs).getTime();return e.map(e=>{let t=1===e.messages.length&&"string"==typeof e.messages[0]&&e.messages[0]||V(1===e.messages.length?e.messages[0]:e.messages,3);var i=fe(r)&&t.length>r;return i&&(t=t.slice(0,r)),JSON.stringify([new Date(e.timestampMs).getTime()-n,t,e.level,+i])}).join("\n")}}function ae(e){let t=5381,i=e.length;for(;i;)t=33*t^e.charCodeAt(--i);return(t>>>0).toString()}function se(e,t){if(e===t)return!0;if(!e||!t)return!1;let i=Object.keys(e).length===Object.keys(t).length;for(const r of Object.keys(e))i=i&&(isNaN(e[r])&&isNaN(t[r])||e[r]===t[r]);return i}function oe(e,t,i){return 8e3*i/(t-e)}function le(e,t,i,r,n){let a,s,o,l=0;var d=navigator.userAgent.toLowerCase(),u=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350],c=(a=1+((192&t[i+2])>>>6),(60&t[i+2])>>>2);if(!(u.length-1<c))return s=(1&t[i+2])<<2,s|=(192&t[i+3])>>>6,/firefox/i.test(d)?6<=c?(a=5,o=new Array(4),l=c-3):(a=2,o=new Array(2)):-1!==d.indexOf("android")?(a=2,o=new Array(2)):(a=5,o=new Array(4),l=r&&(-1!==r.indexOf("mp4a.40.29")||-1!==r.indexOf("mp4a.40.5"))||!r&&6<=c?c-3:((r&&-1!==r.indexOf("mp4a.40.2")||!r&&1==s)&&(a=2,o=new Array(2)),c)),o[0]=a<<3,o[0]|=(14&c)>>1,o[1]|=(1&c)<<7,o[1]|=s<<3,5===a&&(o[1]|=(14&l)>>1,o[2]=(1&l)<<7,o[2]|=8,o[3]=0),{esdsConfig:o,samplerate:u[c],channelCount:s,segmentCodec:"aac",codec:"mp4a.40."+a};{const t=new O(!0,pe.InvalidADTSSamplingIndex,`invalid ADTS sampling index:`+c);e.trigger(L.INTERNAL_ERROR,t)}}class de{constructor(e,t,i,r,n){this.observer=e,this.remuxer=t,this.config=i,this.typeSupported=r,this.logger=n}static probe(e,t){throw new me(!0,pe.DemuxRemuxProbeNotFound)}resetTimeStamp(e){}resetInitSegment(e,t,i,r){}destroy(){}}class ue extends de{constructor(e,t,i,r,n){super(e,t,i,r,n),this.observer=e,this.remuxer=t,this.config=i,this.typeSupported=r,this.logger=n,this.esRemuxer=t}}class ce{constructor(e,t,i){this.observer=e,this.config=t,this.logger=i}resetInitSegment(){}resetTimeStamp(e){}destroy(){}}const he={name:"ID3"};class Fe{constructor(e,t){this.R=t,this.D=new Uint8Array,this.L=!1,this.F=null,this.j=0,this.B=[];let i,r,n,a,s=0;for(;;)if(n=Fe.readUTF(e,s,3),s+=3,"ID3"===n){this.U=e[s++],this.$=e[s++];const t=e[s++];128&t&&this.R.error(he,"id3 tag is unsynchronized"),64&t&&(this.V=!0),i=Fe.readSynchSafeUint32(e.subarray(s,s+4)),r=(s+=4)+i,this.V&&(s+=Fe.readSynchSafeUint32(e.subarray(s,s+4))),!fe(this.minor)||2<this.minor?this.q(e,s,r):this.R.error(he,"[id3] doesn't support older than v2.3 tags"),s=r}else{if("3DI"!==n)return void((a=s-=3)&&(this.j=a,this.D=e.slice(0,a)));s+=7}}static isHeader(e,t){return 73===e[t]&&68===e[t+1]&&51===e[t+2]&&e[t+3]<255&&e[t+4]<255&&e[t+6]<128&&e[t+7]<128&&e[t+8]<128&&e[t+9]<128}static readSynchSafeUint32(e){return 2097152*(127&e[0])+16384*(127&e[1])+128*(127&e[2])+(127&e[3])}static readUTF(e,t,i){let r="",n=t;for(var a=t+i;r+=String.fromCharCode(e[n++]),n<a;);return r}H(e,t){return e[t+4]<128&&e[t+5]<128&&e[t+6]<128&&e[t+7]<128}K(e){return"TXXX"===e.type?this.W(e):"WXXX"===e.type?this.G(e):"PRIV"===e.type?this.X(e):"T"===e.type[0]?this.Y(e):{key:e.type,data:e.data}}W(e){var t,i;if(!(fe(e.size)&&e.size<2)&&3===e.data[0])return t=1,t+=(i=null!=(i=this.J(e.data.subarray(t)))?i:"").length+1,{key:"TXXX",description:i,data:null!=(i=this.J(e.data.subarray(t)))?i:""}}G(e){var t,i;if(!(fe(e.size)&&e.size<2)&&3===e.data[0])return t=1,t+=(i=null!=(i=this.J(e.data.subarray(t)))?i:"").length+1,{key:"WXXX",description:i,data:De.utf8arrayToStr(e.data.subarray(t))}}Y(e){var t;if(!(fe(e.size)&&e.size<2)&&3===e.data[0])return t=e.data.subarray(1),{key:e.type,data:null!=(e=this.J(t))?e:""}}X(e){var t;if(!(fe(e.size)&&e.size<2))return{key:"PRIV",info:t=null!=(t=this.J(e.data))?t:"",data:e.data.slice(t.length+1)}}Z(e,t,i,r,n){var a=r+i;let s;return a<=n?s={type:t,data:e.slice(r,a)}:this.R.error(he,`id3 frame ${t} size ${i} exceeded `+n),s}q(e,t,i){let r,n,a,s;for(;t+8<=i;){if(!this.H(e,t))return void this.R.error(he,`[id3] illegal id3 frame @ offset ${t}. skip this id3 tag`);if(r=Fe.readUTF(e,t,4),t+=4,""===r)return;if(0===(n=Fe.readSynchSafeUint32(e.subarray(t,t+4))))return;t+=4,e[t++],e[t++],a=t;var o=this.Z(e,r,n,a,i);if(o){const e=this.K(o);e&&this.B.push(e)}if("PRIV"===r)if(53===n&&"com.apple.streaming.transportStreamTimestamp"===Fe.readUTF(e,t,44)){t=t+44+4;const i=1&e[t++];this.L=!0,s=((e[t++]<<23)+(e[t++]<<15)+(e[t++]<<7)+e[t++])/45,i&&(s+=47721858.84),s=Math.round(s),this.nt=s}else 45<=n&&"com.apple.streaming.audioDescription"===Fe.readUTF(e,t,36)?(t+=37,this.F=Fe.readUTF(e,t,4),t=t+4+(n-41)):t+=n;else t+=n}}J(e){let t,i,r="",n=0;const a=e.length;for(;n<a;){const a=e[n++];switch(a>>4){case 0:return r;case 1:case 2:case 3:case 4:case 5:case 6:case 7:r+=String.fromCharCode(a);break;case 12:case 13:t=e[n++],r+=String.fromCharCode((31&a)<<6|63&t);break;case 14:t=e[n++],i=e[n++],r+=String.fromCharCode((15&a)<<12|(63&t)<<6|(63&i)<<0)}}}get hasTimeStamp(){return this.L}get timeStamp(){return this.nt}get audioType(){return this.F}get length(){return this.j}get payload(){return this.D}get frames(){return this.B}get minor(){return this.U}get revision(){return this.$}}var Be=Fe;const Ue={name:"AACDemuxer"};class _e extends ue{constructor(){super(...arguments),this.st=NaN}resetInitSegment(e,t){this.ot=void 0,this.at=void 0,this.st=t}static probe(e,t){let i,r;for(i=new Be(e,t).length,r=Math.min(e.length-1,i+100);i<r;i++)if(255===e[i]&&240==(246&e[i+1]))return!0;return!1}append(e,t,i,r,n){var a=new Be(e,this.logger),s=a.hasTimeStamp&&fe(a.timeStamp)?90*a.timeStamp:9e4*t;let o,l,d,u,c,h,p,m,f,g;for(a.length&&(g=a.payload,a.frames.length&&(f=a.frames),m={id3Samples:[{pts:s,dts:s,data:g,frames:f}],inputTimescale:9e4}),d=a.length,h=e.length;d<h-1&&(255!==e[d]||240!=(246&e[d+1]));d++);if(!this.ot&&(this.ot=le(this.observer,e,d,void 0,this.logger),!this.ot))throw"failed to parse adts config";if(!this.at){const e={id:258,inputTimescale:9e4,timescale:NaN,duration:this.st,encrypted:!1,keyTagInfo:n},t={len:0,sequenceNumber:0,esSamples:[]};this.at={info:e,parsingData:t,type:"audio",config:this.ot}}"zaac"!==a.audioType&&"zach"!==a.audioType&&"zacp"!==a.audioType||(this.at.info.encrypted=!0),l=0;for(var y=9216e4/this.ot.samplerate;d+5<h&&(u=1&e[d+1]?7:9,o=(3&e[d+3])<<11|e[d+4]<<3|(224&e[d+5])>>>5,0<(o-=u))&&d+u+o<=h;)for(c=s+l*y,p={unit:e.subarray(d+u,d+u+o),pts:c,dts:c,keyTagInfo:n},this.at.parsingData.esSamples.push(p),this.at.parsingData.len+=o,d+=o+u,l++;d<h-1;d++){if(Be.isHeader(e,d)){const t=new Be(e.subarray(d),this.logger);if(0<t.length){d+=t.length;const e=t.hasTimeStamp&&fe(t.timeStamp)?90*t.timeStamp:s;null!=m&&m.id3Samples.push({pts:e,dts:e,data:t.payload,frames:t.frames})}else this.logger.error(Ue,`[id3] invalid length `+h)}if(255===e[d]&&240==(246&e[d+1]))break}this.esRemuxer.remuxEsTracks(this.at,void 0,m,void 0,t,i,r,n)}}class Ve{bsReadAndUpdate(e,t,i){e=this.ut(e,t,i);return this.dt(t,i),null!=e?e:0}bsWriteAndUpdate(e,t,i,r){e=this.ft(e,t,i,r);return this.dt(t,i),e}bsSkip(e,t){this.dt(e,t)}ut(i,r,n){if(i&&r){let t=r.byteOffset;const a=r["usedBits"];if(!(8<=a||32<a+n)){let e;const s=new Uint32Array(1),o=new Uint32Array(1),l=new Uint8Array(1);if(!(8<=a||32<n)){if(a){const r=8-a,s=n<r?r-n:0;o[0]=4278190080>>>32-r,e=(i[t]&o[0])>>>s,t+=1,n-=r}for(;0<n;){l[0]=i[t];const r=Math.min(n,8),a=8-r;o[0]=4278190080>>>24+a<<a,s[0]=(l[0]&o[0])>>a,e=e?e<<r|s[0]:s[0],t+=1,n-=r}return e}}}}ft(t,i,r,n){if(t&&i){let e=i.byteOffset;i=i["usedBits"];if(!(8<=i||32<i+r)){var a=new Uint32Array(1),s=new Uint32Array(1),o=new Uint32Array(1),l=new Uint8Array(1);for(a[0]=n,i&&(s[0]=a[0]<<32-r,o[0]=4278190080,l[0]=(s[0]&o[0])>>>24+i,t[e]&=~(o[0]>>>24+i),t[e]|=l[0],e+=1,r-=8-i);0<r;){s[0]=a[0]<<32-r,o[0]=4278190080,l[0]=(s[0]&o[0])>>>24;const i=r<0?8-r:0;t[e]&=~(o[0]>>>24>>>i<<i),t[e]|=l[0],r-=8,e+=1}return 0}}}dt(e,t){var i,r;!e||!t||32<e.usedBits+t||(r=e.usedBits%8,i=Math.floor((r+t)/8),r=(r+t)%8,e.byteOffset+=i,e.usedBits=r)}}function Qe(e,t){return 1536/e.samplerate*t}function He(e,t,i,r){let n;if(i+8>t.length)n=new O(!0,pe.InsufficientAC3Data);else if(11!==t[i]||119!==t[i+1])n=new O(!0,pe.InvalidAC3Magic);else{var a=t[i+4]>>6;if(!(3<=a)){var s=63&t[i+4],o=t[i+6]>>5;let e=0;(2==o||(1&o&&1!=o&&(e+=2),4&o))&&(e+=2);var l=(t[i+6]<<8|t[i+7])>>12-e&1,d=[2,1,2,3,3,4,4,5][o]+l,u=t[i+5]>>3,t=7&t[i+5];return{samplerate:Ke[a],channelCount:d,segmentCodec:"ac3",codec:"ac-3",extraData:a<<22|u<<17|t<<14|o<<11|l<<10|s>>1<<5}}n=new O(!0,pe.InvalidAC3SamplingRateCode,`invalid ac-3 samplingRateCode:`+a)}e.trigger(L.INTERNAL_ERROR,n)}function qe(e,t,i){let r;if(i+8>t.length)r=new O(!0,pe.InsufficientAC3Data);else if(11!==t[i]||119!==t[i+1])r=new O(!0,pe.InvalidAC3Magic);else{var n=t[i+4]>>6;if(!(3<=n))return t=63&t[i+4],2*je[3*t+n];r=new O(!0,pe.InvalidAC3SamplingRateCode,`invalid ac-3 samplingRateCode:`+n)}e.trigger(L.INTERNAL_ERROR,r)}const Ke=[48e3,44100,32e3],je=[64,69,96,64,70,96,80,87,120,80,88,120,96,104,144,96,105,144,112,121,168,112,122,168,128,139,192,128,140,192,160,174,240,160,175,240,192,208,288,192,209,288,224,243,336,224,244,336,256,278,384,256,279,384,320,348,480,320,349,480,384,417,576,384,418,576,448,487,672,448,488,672,512,557,768,512,558,768,640,696,960,640,697,960,768,835,1152,768,836,1152,896,975,1344,896,976,1344,1024,1114,1536,1024,1115,1536,1152,1253,1728,1152,1254,1728,1280,1393,1920,1280,1394,1920];class $e extends ue{constructor(){super(...arguments),this.st=NaN}resetInitSegment(e,t){this.ot=void 0,this.at=void 0,this.st=t}static probe(e,t){var t=new Be(e,t),i=t.length;return!!(t.hasTimeStamp&&11===e[i]&&119===e[i+1]&&(new Ve).bsReadAndUpdate(e,{byteOffset:i+5,usedBits:0},5)<16)}append(e,t,i,r,n){var a,s=new Be(e,this.logger),o=s.hasTimeStamp&&fe(s.timeStamp)?90*s.timeStamp:NaN,l=e.byteLength;let d=0,u=s.length;if(this.ot||(this.ot=He(this.observer,e,u,this.logger)),!this.ot)throw"failed to parse ac3 config";if(!this.at){const e={id:258,inputTimescale:9e4,timescale:NaN,duration:this.st,encrypted:!1,keyTagInfo:n},t={len:0,sequenceNumber:0,esSamples:[]};this.at={info:e,parsingData:t,type:"audio",config:this.ot}}var c=Qe(this.ot,this.at.info.inputTimescale);for("zac3"===s.audioType&&(this.at.info.encrypted=!0);u<l;){if(Be.isHeader(e,u)&&(u+=new Be(e.subarray(u),this.logger).length),11!==e[u]||119!==e[u+1]){const e=new O(!0,pe.InvalidAC3Magic);return void this.observer.trigger(L.INTERNAL_ERROR,e)}const t=null!=(a=qe(this.observer,e,u))?a:NaN,i=o+d*c,r={unit:e.subarray(u,u+t),pts:i,dts:i,keyTagInfo:n};this.at.parsingData.esSamples.push(r),this.at.parsingData.len+=t,u+=t,d++}this.esRemuxer.remuxEsTracks(this.at,void 0,{id3Samples:[{pts:o,dts:o,data:s.payload,frames:s.frames}],inputTimescale:this.at.info.inputTimescale},void 0,t,i,r,n)}}var Ge={getFrameLength:function(t,i,r,n){var a=new Ve;let s,o=!1,l=0;for(;r<i.length;){if(r+8>i.length)return s=new O(!0,pe.InsufficientEC3Data),void t.trigger(L.INTERNAL_ERROR,s);let e=0;if(Be.isHeader(i,r)&&(r+=e=new Be(i.subarray(r),n).length||0),11!==i[r]||119!==i[r+1])return s=new O(!0,pe.InvalidEC3Magic),void t.trigger(L.INTERNAL_ERROR,s);var d={byteOffset:r+2,usedBits:0},u=a.bsReadAndUpdate(i,d,2),c=a.bsReadAndUpdate(i,d,3);if(0===u||2===u)if(!0===o){if(0===c)break}else o=!0;else if(1!==u)return s=new O(!0,pe.ReservedStreamType),void t.trigger(L.INTERNAL_ERROR,s);c=2*(a.bsReadAndUpdate(i,d,11)+1);r+=c,l+=c+(e||0)}return l},getAudioConfig:function(t,i,r,n){var a={frmsiz:0,fscod:0,numblkscod:0,acmod:0,lfeon:0,bsid:0,strmtyp:0,substreamid:0,chanmape:0,chanmap:0,mixdef:0,mixdeflen:0,bsmod:0},s={fscod:0,acmod:0,lfeon:0,bsid:0,bsmod:0,chan_loc:0,data_rate:0,num_ind_sub:0,num_dep_sub:[],complexity_index_type_a:0},o=new Ve;let l,d=!1,u=0;for(;r<i.length;){if(r+8>i.length)return l=new O(!0,pe.InsufficientEC3Data),void t.trigger(L.INTERNAL_ERROR,l);let e=0;if(Be.isHeader(i,r)&&(r+=e=new Be(i.subarray(r),n).length||0),11!==i[r]||119!==i[r+1])return l=new O(!0,pe.InvalidEC3Magic),void t.trigger(L.INTERNAL_ERROR,l);const h={byteOffset:r+2,usedBits:0};if(a.strmtyp=o.bsReadAndUpdate(i,h,2),a.substreamid=o.bsReadAndUpdate(i,h,3),0===a.strmtyp||2===a.strmtyp){if(!0===d){if(0===a.substreamid)break}else d=!0;s.num_ind_sub++,s.num_dep_sub.push(0)}else{if(1!==a.strmtyp)return l=new O(!0,pe.ReservedStreamType),void t.trigger(L.INTERNAL_ERROR,l);s.num_dep_sub[s.num_ind_sub-1]++}if(a.frmsiz=o.bsReadAndUpdate(i,h,11),a.fscod=o.bsReadAndUpdate(i,h,2),3===a.fscod?(o.bsSkip(h,2),a.numblkscod=3):a.numblkscod=o.bsReadAndUpdate(i,h,2),a.acmod=o.bsReadAndUpdate(i,h,3),a.lfeon=o.bsReadAndUpdate(i,h,1),a.bsid=o.bsReadAndUpdate(i,h,5),o.bsSkip(h,5),o.bsReadAndUpdate(i,h,1)&&o.bsSkip(h,8),0===a.acmod&&(o.bsSkip(h,5),o.bsReadAndUpdate(i,h,1))&&o.bsSkip(h,8),1===a.strmtyp&&(a.chanmape=o.bsReadAndUpdate(i,h,1),a.chanmape)&&(a.chanmap=o.bsReadAndUpdate(i,h,16)),o.bsReadAndUpdate(i,h,1)&&(2<a.acmod&&o.bsSkip(h,2),1&a.acmod&&2<a.acmod&&o.bsSkip(h,6),4&a.acmod&&o.bsSkip(h,6),a.lfeon&&o.bsReadAndUpdate(i,h,1)&&o.bsSkip(h,5),0===a.strmtyp)){if(o.bsReadAndUpdate(i,h,1)&&o.bsSkip(h,6),0===a.acmod&&o.bsReadAndUpdate(i,h,1)&&o.bsSkip(h,6),o.bsReadAndUpdate(i,h,1)&&o.bsSkip(h,6),a.mixdef=o.bsReadAndUpdate(i,h,2),1===a.mixdef)o.bsSkip(h,5);else if(2===a.mixdef)o.bsSkip(h,12);else if(3===a.mixdef){a.mixdeflen=o.bsReadAndUpdate(i,h,5),o.bsReadAndUpdate(i,h,1)&&(o.bsSkip(h,5),o.bsReadAndUpdate(i,h,1)&&o.bsSkip(h,4),o.bsReadAndUpdate(i,h,1)&&o.bsSkip(h,4),o.bsReadAndUpdate(i,h,1)&&o.bsSkip(h,4),o.bsReadAndUpdate(i,h,1)&&o.bsSkip(h,4),o.bsReadAndUpdate(i,h,1)&&o.bsSkip(h,4),o.bsReadAndUpdate(i,h,1)&&o.bsSkip(h,4),o.bsReadAndUpdate(i,h,1)&&o.bsSkip(h,4),o.bsReadAndUpdate(i,h,1))&&(o.bsReadAndUpdate(i,h,1)&&o.bsSkip(h,4),o.bsReadAndUpdate(i,h,1))&&o.bsSkip(h,4),o.bsReadAndUpdate(i,h,1)&&(o.bsSkip(h,5),o.bsReadAndUpdate(i,h,1))&&(o.bsSkip(h,7),o.bsReadAndUpdate(i,h,1))&&o.bsSkip(h,8);const t=a.mixdeflen+2+(h.usedBits?1:0);h.byteOffset+=t}if(a.acmod<2&&(o.bsReadAndUpdate(i,h,1)&&o.bsSkip(h,14),0===a.acmod)&&o.bsReadAndUpdate(i,h,1)&&o.bsSkip(h,14),o.bsReadAndUpdate(i,h,1))if(0===a.numblkscod)o.bsSkip(h,5);else for(let e=0;e<a.numblkscod;e++)o.bsReadAndUpdate(i,h,1)&&o.bsSkip(h,5)}if(a.bsmod=0,o.bsReadAndUpdate(i,h,1)&&(a.bsmod=o.bsReadAndUpdate(i,h,3),o.bsSkip(h,2),2===a.acmod&&o.bsSkip(h,4),6<=a.acmod&&o.bsSkip(h,2),o.bsReadAndUpdate(i,h,1)&&o.bsSkip(h,8),0===a.acmod&&o.bsReadAndUpdate(i,h,1)&&o.bsSkip(h,8),a.fscod<3)&&o.bsSkip(h,1),0===a.strmtyp&&3!==a.numblkscod&&o.bsSkip(h,1),2===a.strmtyp&&(3===a.numblkscod?1:o.bsReadAndUpdate(i,h,1))&&o.bsReadAndUpdate(i,h,6),o.bsReadAndUpdate(i,h,1)){const t=o.bsReadAndUpdate(i,h,6);if(0===a.strmtyp&&0===a.substreamid&&1===t){const t=o.bsReadAndUpdate(i,h,7),r=o.bsReadAndUpdate(i,h,1),n=o.bsReadAndUpdate(i,h,8);0===t&&1===r&&1<=n&&n<=16&&(s.complexity_index_type_a=n)}}if(a.chanmape)s.chan_loc|=a.chanmap;else{const t=[40960,16384,40960,57344,41472,57856,47104,63488];s.chan_loc|=t[a.acmod]}0===a.strmtyp&&(s.fscod=a.fscod,s.bsid=a.bsid,s.bsmod=a.bsmod,s.acmod=a.acmod,s.lfeon=a.lfeon),s.chan_loc|=a.lfeon?1:0;const p=2*(a.frmsiz+1);r+=p,u+=p+(e||0)}let c=0;for(let e=0;e<16;e++)s.chan_loc&1<<e&&c++;s.lfeon&&c++;let h=10+3*s.num_ind_sub;const p=[48e3,44100,32e3][s.fscod];s.data_rate=p/1536*u*8,h=10+3*s.num_ind_sub;for(let e=0;e<s.num_ind_sub;e++)0<s.num_dep_sub[e]&&h++;0<s.complexity_index_type_a&&(h+=2);var m=new Uint8Array(h),f={byteOffset:0,usedBits:0};o.bsWriteAndUpdate(m,f,32,h),o.bsWriteAndUpdate(m,f,32,1684366131),o.bsWriteAndUpdate(m,f,13,s.data_rate),o.bsWriteAndUpdate(m,f,3,s.num_ind_sub);for(let e=0;e<s.num_ind_sub;e++)o.bsWriteAndUpdate(m,f,2,s.fscod),o.bsWriteAndUpdate(m,f,5,s.bsid),o.bsWriteAndUpdate(m,f,1,0),o.bsWriteAndUpdate(m,f,1,0===e?0:1),o.bsWriteAndUpdate(m,f,3,s.bsmod),o.bsWriteAndUpdate(m,f,3,s.acmod),o.bsWriteAndUpdate(m,f,1,s.lfeon),o.bsWriteAndUpdate(m,f,3,0),o.bsWriteAndUpdate(m,f,4,s.num_dep_sub[e]),0<s.num_dep_sub[e]?o.bsWriteAndUpdate(m,f,9,s.chan_loc):o.bsWriteAndUpdate(m,f,1,0);return 0<s.complexity_index_type_a&&(o.bsWriteAndUpdate(m,f,7,0),o.bsWriteAndUpdate(m,f,1,1),o.bsWriteAndUpdate(m,f,8,s.complexity_index_type_a)),{samplerate:p,channelCount:c,segmentCodec:"ec3",codec:"ec-3",extraDataBytes:m}}};class We extends ue{constructor(){super(...arguments),this.st=NaN}resetInitSegment(e,t){this.ot=void 0,this.at=void 0,this.st=t}static probe(e,t){var t=new Be(e,t),i=t.length;return!(!t.hasTimeStamp||11!==e[i]||119!==e[i+1]||16!==(new Ve).bsReadAndUpdate(e,{byteOffset:i+5,usedBits:0},5))}append(e,t,i,r,n){var a,s=new Be(e,this.logger),o=s.hasTimeStamp&&fe(s.timeStamp)?90*s.timeStamp:NaN,l=e.length;let d=0,u=s.length;if(this.ot||(this.ot=Ge.getAudioConfig(this.observer,e,u,this.logger)),!this.ot)throw"failed to parse ec-3 config";if(!this.at){const e={id:258,inputTimescale:9e4,timescale:NaN,duration:this.st,encrypted:!1,keyTagInfo:n},t={len:0,sequenceNumber:0,esSamples:[]};this.at={info:e,parsingData:t,type:"audio",config:this.ot}}var c=Qe(this.ot,this.at.info.inputTimescale);for("zec3"===s.audioType&&(this.at.info.encrypted=!0);u<l;){const t=null!=(a=Ge.getFrameLength(this.observer,e,u,this.logger))?a:NaN,i=o+d*c,r={unit:e.subarray(u,u+t),pts:i,dts:i,keyTagInfo:n};this.at.parsingData.esSamples.push(r),this.at.parsingData.len+=t,u+=t,d++}this.esRemuxer.remuxEsTracks(this.at,void 0,{id3Samples:[{pts:o,dts:o,data:s.payload,frames:s.frames}],inputTimescale:this.at.info.inputTimescale},void 0,t,i,r,n)}}const ze={BitratesMap:[32,64,96,128,160,192,224,256,288,320,352,384,416,448,32,48,56,64,80,96,112,128,160,192,224,256,320,384,32,40,48,56,64,80,96,112,128,160,192,224,256,320,32,48,56,64,80,96,112,128,144,160,176,192,224,256,8,16,24,32,40,48,56,64,80,96,112,128,144,160],SamplingRateMap:[44100,48e3,32e3,22050,24e3,16e3,11025,12e3,8e3],SamplesCoefficients:[[0,72,144,12],[0,0,0,0],[0,72,144,12],[0,144,144,12]],BytesInSlot:[0,1,1,4],onFrame:function(e,t,i,r,n,a,s){s+=a*(10368e4/r);e.esSamples.push({unit:t,pts:s,dts:s}),e.len+=t.length},onNoise:function(e,t){},parseFrames:function(t,i,r,n,a,s,o){var l,d,u,c;if(!(n<r+2)){if(255===i[r]||224==(224&i[r+1])){if(n<r+24)return-1;const o=i[r+1]>>3&3,e=i[r+1]>>1&3,h=i[r+2]>>4&15,p=i[r+2]>>2&3,m=!!(2&i[r+2]);if(1!=o&&0!=h&&15!=h&&3!=p)return l=1e3*[32,64,96,128,160,192,224,256,288,320,352,384,416,448,32,48,56,64,80,96,112,128,160,192,224,256,320,384,32,40,48,56,64,80,96,112,128,160,192,224,256,320,32,48,56,64,80,96,112,128,144,160,176,192,224,256,8,16,24,32,40,48,56,64,80,96,112,128,144,160][14*(3==o?3-e:3==e?3:4)+h-1],d=[44100,48e3,32e3,22050,24e3,16e3,11025,12e3,8e3][3*(3==o?0:2==o?1:2)+p],c=m?1:0,u=i[r+3]>>6==3?1:2,n<r+(c=3==e?(3==o?12:6)*l/d+c<<2:(3==o?144:72)*l/d+c|0)?-1:(ze.onFrame(t,i.subarray(r,r+c),l,d,u,a,s),c)}let e=r+2;for(;e<n;){if(255===i[e-1]&&224==(224&i[e]))return ze.onNoise(i.subarray(r,e-1),o),e-r-1;e++}}return-1},parse:function(e,t,i,r,n){var a=t.length;let s,o=0;for(;i<a&&0<(s=ze.parseFrames(e,t,i,a,o++,r,n));)i+=s},getAudioConfig:function(e,t){var i,r=e[t+1]>>3&3,n=e[t+1]>>1&3,a=e[t+2]>>4&15,s=e[t+2]>>2&3,o=e[t+2]>>1&1;if(1!=r&&0!=a&&15!=a&&3!=s)return i=3==r?3-n:3==n?3:4,i=1e3*ze.BitratesMap[14*i+a-1],a=3==r?0:2==r?1:2,a=ze.SamplingRateMap[3*a+s],s=e[t+3]>>6==3?1:2,e=ze.SamplesCoefficients[r][n],t=ze.BytesInSlot[n],{segmentCodec:"mp3",codec:"mp3",samplerate:a,channelCount:s,frameLength:parseInt(e*i/a+o,10)*t}},isHeaderPattern:function(e,t){return 255===e[t]&&224==(224&e[t+1])&&0!=(6&e[t+1])},probe:function(t,i){if(i+1<t.length&&ze.isHeaderPattern(t,i)){var r=4,n=ze.getAudioConfig(t,i);let e=r;r=i+(e=n&&n.frameLength?n.frameLength:e);if(r===t.length||r+1<t.length&&ze.isHeaderPattern(t,r))return!0}return!1}};var Ye,Xe,Je=ze;class Ze extends ue{constructor(){super(...arguments),this.st=NaN}resetInitSegment(e,t){this.ot=void 0,this.at=void 0,this.st=t}static probe(e,t){t=new Be(e,t);let i,r;if(t.hasTimeStamp)for(i=t.length,r=Math.min(e.length-1,i+100);i<r;i++)if(Je.probe(e,i))return!0;return!1}append(e,t,i,r,n){var a=new Be(e,this.logger),s=a.hasTimeStamp&&fe(a.timeStamp)?90*a.timeStamp:NaN;if(this.ot||(this.ot=Je.getAudioConfig(e,a.length)),!this.ot)throw"unable to parse mp3 header";if(!this.at){const e={id:258,inputTimescale:9e4,timescale:NaN,duration:this.st,encrypted:!1,keyTagInfo:n},t={len:0,sequenceNumber:0,esSamples:[]};this.at={info:e,parsingData:t,type:"audio",config:this.ot}}Je.parse(this.at.parsingData,e,a.length,s,this.logger),this.esRemuxer.remuxEsTracks(this.at,void 0,{id3Samples:[{pts:s,dts:s,data:a.payload,frames:a.frames}],inputTimescale:9e4},void 0,t,i,r)}}function et(e,t){if("mp4a.40.2"===e){if(1===t)return new Uint8Array([0,200,0,128,35,128]);if(2===t)return new Uint8Array([33,0,73,144,2,25,0,35,128]);if(3===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142]);if(4===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56]);if(5===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56]);if(6===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224])}else{if(1===t)return new Uint8Array([1,64,34,128,163,78,230,128,186,8,0,0,0,28,6,241,193,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(2===t)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(3===t)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94])}return null}const H={bin2str:e=>String.fromCharCode.apply(null,Array.from(e)),readUint16(e,t){e=e[t]<<8|e[t+1];return e<0?65536+e:e},readSint32:(e,t)=>e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3],readUint32(e,t){e=H.readSint32(e,t);return e<0?4294967296+e:e},writeUint32(e,t,i){e[t]=i>>24,e[t+1]=i>>16&255,e[t+2]=i>>8&255,e[t+3]=255&i},readUint64(e,t){var i=H.readUint32(e,t);return(i*=Math.pow(2,32))+H.readUint32(e,t+4)},writeUint64(e,t,i){var r=Math.pow(2,32)-1,n=Math.floor(i/(r+1)),i=Math.floor(i%(r+1));H.writeUint32(e,t,n),H.writeUint32(e,t+4,i)},containsBox(e,t){return!!this.findFirstBox(e,t)},findFirstBox(e,t){return this.findBox(e,t,1)[0]},findBox:(e,t,i=1/0)=>rt(e,0,t,tt,void 0,i),findFirstBoxWithOffset(e,t,i,r=!1){return this.findBoxWithOffset(e,t,i,r,1)[0]},findBoxWithOffset:(e,t,i,r=!1,n=1/0)=>rt(e,t,i,it,r?[]:void 0,n)};function tt(e){return e}function it(e,t,i,r,n){return{offset:t,type:i,data:e,boxSize:r,walkedPath:n?n.slice(0):void 0}}function rt(t,i,r,n,a,s){if(!r.length)return[];let o,l,d,u=[];for(let e=0;e<t.byteLength&&u.length<s;){if(o=H.readUint32(t,e),l=H.bin2str(t.subarray(e+4,e+8)),d=1<o?e+o:t.byteLength,l===r[0]){a&&a.push({offset:e+i,type:l,size:o});var c=t.subarray(e+8,d);if(1===r.length)u.push(n(c,e+i,l,o,a));else{const t=rt(c,e+i+8,r.slice(1),n,a?a.slice(0):void 0,s-u.length);t.length&&(u=u.concat(t),a=a?a.slice(0,-1):void 0)}}e=d}return u}const nt=Math.pow(2,32)-1;(Xe=Ye=Ye||{})[Xe.CENC=1667591779]="CENC",Xe[Xe.CBCS=1667392371]="CBCS";class k{static init(){let e;for(e in k.types={avc1:[],avcC:[],btrt:[],dinf:[],dref:[],esds:[],free:[],ftyp:[],hdlr:[],mdat:[],mdhd:[],mdia:[],mfhd:[],minf:[],moof:[],moov:[],mp4a:[],".mp3":[],dac3:[],"ac-3":[],dec3:[],"ec-3":[],mvex:[],mvhd:[],mzid:[],pasp:[],sdtp:[],stbl:[],stco:[],stsc:[],stsd:[],stsz:[],stts:[],tfdt:[],tfhd:[],traf:[],trak:[],trun:[],trex:[],tkhd:[],vmhd:[],smhd:[],uuid:[],encv:[],enca:[],frma:[],schm:[],schi:[],senc:[],saio:[],saiz:[],sinf:[],tenc:[],sbgp:[],seig:[],sgpd:[],pssh:[]},k.types)k.types.hasOwnProperty(e)&&(k.types[e]=[e.charCodeAt(0),e.charCodeAt(1),e.charCodeAt(2),e.charCodeAt(3)]);var t=new Uint8Array([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]),i=new Uint8Array([0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0]),t=(k.HDLR_TYPES={video:t,audio:i},new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1])),i=new Uint8Array([0,0,0,0,0,0,0,0]),i=(k.STTS=k.STSC=k.STCO=i,k.STSZ=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]),k.VMHD=new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0]),k.SMHD=new Uint8Array([0,0,0,0,0,0,0,0]),k.STSD=new Uint8Array([0,0,0,0,0,0,0,1]),new Uint8Array([105,115,111,109])),r=new Uint8Array([97,118,99,49]),n=new Uint8Array([0,0,0,1]);k.FTYP=k.box(k.types.ftyp,i,n,i,r),k.DINF=k.box(k.types.dinf,k.box(k.types.dref,t))}static set16(e,t,i){return t[i]=e>>8&255,t[i+1]=255&e,i+2}static set32(e,t,i){return t[i]=e>>24&255,t[i+1]=e>>16&255,t[i+2]=e>>8&255,t[i+3]=255&e,i+4}static box(e){var t=Array.prototype.slice.call(arguments,1);let i=8,r=t.length;for(var n=r;r--;)i+=t[r].byteLength;var a=new Uint8Array(i);for(a[0]=i>>24&255,a[1]=i>>16&255,a[2]=i>>8&255,a[3]=255&i,a.set(e,4),r=0,i=8;r<n;r++)a.set(t[r],i),i+=t[r].byteLength;return a}static free(e){return k.types||k.init(),k.box(k.types.free,e)}static mzid(t){k.types||k.init();var i=new Uint8Array(t.length);for(let e=0;e<t.length;e++)i[e]=t.charCodeAt(e);return k.box(k.types.mzid,i)}static hdlr(e){return k.box(k.types.hdlr,k.HDLR_TYPES[e])}static mdat(e){return k.box(k.types.mdat,e)}static mdhd(e,t){t*=e;var i=Math.floor(t/(nt+1)),t=Math.floor(t%(nt+1));return k.box(k.types.mdhd,new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,e>>24&255,e>>16&255,e>>8&255,255&e,i>>24,i>>16&255,i>>8&255,255&i,t>>24,t>>16&255,t>>8&255,255&t,85,196,0,0]))}static mdia(e){var t=k.mdhd(e.info.timescale,e.info.duration),i=k.hdlr(e.type),e=k.minf(e);return k.box(k.types.mdia,t,i,e)}static mfhd(e){return k.box(k.types.mfhd,new Uint8Array([0,0,0,0,e>>24,e>>16&255,e>>8&255,255&e]))}static minf(e){return"audio"===e.type?k.box(k.types.minf,k.box(k.types.smhd,k.SMHD),k.DINF,k.stbl(e)):k.box(k.types.minf,k.box(k.types.vmhd,k.VMHD),k.DINF,k.stbl(e))}static moof(e,t,i=null){k.types||k.init();e=k.traf(t,e,i);return k.box(k.types.moof,k.mfhd(t.sequenceNumber),e)}static moov(e){let t=e.length;for(var i=[];t--;)i[t]=k.trak(e[t]);return k.box.apply(null,[k.types.moov,k.mvhd(e[0].info.timescale,e[0].info.duration)].concat(i).concat(k.mvex(e)))}static mvex(e){let t=e.length;for(var i=[];t--;)i[t]=k.trex(e[t]);return k.box(k.types.mvex,...i)}static mvhd(e,t){t*=e;var i=Math.floor(t/(nt+1)),t=Math.floor(t%(nt+1)),e=new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,e>>24&255,e>>16&255,e>>8&255,255&e,i>>24,i>>16&255,i>>8&255,255&i,t>>24,t>>16&255,t>>8&255,255&t,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]);return k.box(k.types.mvhd,e)}static sdtp(e){var t=e.samples||[],i=new Uint8Array(4+t.length);let r,n;for(n=0;n<t.length;n++)r=t[n].flags,i[n+4]=r.dependsOn<<4|r.isDependedOn<<2|r.hasRedundancy;return k.box(k.types.sdtp,i)}static stbl(e){var e=k.stsd(e),t=k.box(k.types.stts,k.STTS),i=k.box(k.types.stsc,k.STSC),r=k.box(k.types.stsz,k.STSZ),n=k.box(k.types.stco,k.STCO);return k.box(k.types.stbl,e,t,i,r,n)}static avc1(e){let t,i,r,n=[],a=[];var s=e.info.encrypted?k.types.encv:k.types.avc1;for(t=0;t<e.config.sps.length;t++)i=e.config.sps[t],r=i.byteLength,n.push(r>>>8&255),n.push(255&r),n=n.concat(Array.prototype.slice.call(i));for(t=0;t<e.config.pps.length;t++)i=e.config.pps[t],r=i.byteLength,a.push(r>>>8&255),a.push(255&r),a=a.concat(Array.prototype.slice.call(i));var o=k.box(k.types.avcC,new Uint8Array([1,n[3],n[4],n[5],255,224|e.config.sps.length].concat(n).concat([e.config.pps.length]).concat(a))),l=e.config.width,d=e.config.height,u=e.config.pixelRatio[0],c=e.config.pixelRatio[1],h=e.info.encrypted&&e.info.keyTagInfo?k.sinf(e.info.keyTagInfo,e.type,k.types.avc1):new Uint8Array;return k.box(s,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,l>>8&255,255&l,d>>8&255,255&d,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),o,h,k.box(k.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])),k.box(k.types.pasp,new Uint8Array([u>>24,u>>16&255,u>>8&255,255&u,c>>24,c>>16&255,c>>8&255,255&c])))}static esds(e){var t=e.esdsConfig.length;return new Uint8Array([0,0,0,0,3,23+t,0,1,0,4,15+t,64,21,0,0,0,0,0,0,0,0,0,0,0,5].concat([t]).concat(e.esdsConfig).concat([6,1,2]))}static audioStsd(e){var t=e.samplerate;return new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,e.channelCount,0,16,0,0,0,0,t>>8&255,255&t,0,0])}static dac3(e){e=e.extraData;return new Uint8Array([e>>16&255,e>>8&255,255&e])}static dec3(e){return e.extraDataBytes}static mp4a(e,t){let i=k.types.mp4a,r=null;r=e.encrypted&&e.keyTagInfo?(i=k.types.enca,k.sinf(e.keyTagInfo,"audio",k.types.mp4a)):new Uint8Array;e=k.audioStsd(t),t=k.box(k.types.esds,k.esds(t));return k.box(i,e,t,r)}static mp3(e){return k.box(k.types[".mp3"],k.audioStsd(e))}static ac3(e,t){let i=k.types["ac-3"],r=null;return r=e.encrypted&&e.keyTagInfo?(i=k.types.enca,k.sinf(e.keyTagInfo,"audio",k.types["ac-3"])):new Uint8Array,k.box(i,k.audioStsd(t),k.box(k.types.dac3,k.dac3(t)),r)}static ec3(e,t){let i=k.types["ec-3"],r=null;return r=e.encrypted&&e.keyTagInfo?(i=k.types.enca,k.sinf(e.keyTagInfo,"audio",k.types["ec-3"])):new Uint8Array,k.box(i,k.audioStsd(t),k.box(k.types.dec3,k.dec3(t)),r)}static stsd(e){if("audio"!==e.type)return k.box(k.types.stsd,k.STSD,k.avc1(e));if("mp3"===e.config.segmentCodec&&"mp3"===e.config.codec)return k.box(k.types.stsd,k.STSD,k.mp3(e.config));if("ac3"===e.config.segmentCodec)return k.box(k.types.stsd,k.STSD,k.ac3(e.info,e.config));if("ec3"===e.config.segmentCodec)return k.box(k.types.stsd,k.STSD,k.ec3(e.info,e.config));if("aac"===e.config.segmentCodec)return k.box(k.types.stsd,k.STSD,k.mp4a(e.info,e.config));throw`unknown segmentCodec `+e.config.segmentCodec}static tkhd(e){var t=e.info.id,i=e.info.duration*e.info.timescale,r=Math.floor(i/(nt+1)),i=Math.floor(i%(nt+1));let n=0,a=0;return"video"===e.type&&(n=e.config.width,a=e.config.height),k.box(k.types.tkhd,new Uint8Array([1,0,0,7,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,t>>24&255,t>>16&255,t>>8&255,255&t,0,0,0,0,r>>24,r>>16&255,r>>8&255,255&r,i>>24,i>>16&255,i>>8&255,255&i,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,n>>8&255,255&n,0,0,a>>8&255,255&a,0,0]))}static traf(e,t,i=0){var r=k.senc(e),n=k.sdtp(e),a=r.boxData,s=a.length?k.saio(76,e.auxInfoFormat):new Uint8Array,r=a.length?k.saiz(r.defaultSampleInfoSize,r.sampleInfoSizes,e.auxInfoFormat):new Uint8Array,o=k.sbgp(e),l=k.sgpd(e),d=e.id,u=Math.floor(t/(nt+1)),t=Math.floor(t%(nt+1));return k.box(k.types.traf,k.box(k.types.tfhd,new Uint8Array([0,2,0,0,d>>24,d>>16&255,d>>8&255,255&d])),k.box(k.types.tfdt,new Uint8Array([1,0,0,0,u>>24,u>>16&255,u>>8&255,255&u,t>>24,t>>16&255,t>>8&255,255&t])),a,s,r,o,l,k.trun(e,n.length+a.length+o.length+l.length+s.length+r.length+16+20+8+16+8+8),n)}static trak(e){if("trakData"in e)return e.trakData;e.info.duration=e.info.duration||4294967295;var t=k.types.trak,i=k.tkhd(e),e=k.mdia(e);return k.box(t,i,e)}static trex(e){e=e.info.id;return k.box(k.types.trex,new Uint8Array([0,0,0,0,e>>24,e>>16&255,e>>8&255,255&e,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]))}static trun(e,t){var i=e.samples||[],r=i.length,e=12+16*r,n=new Uint8Array(e);let a,s,o,l,d,u;for(n.set([1,0,15,1,r>>>24&255,r>>>16&255,r>>>8&255,255&r,(t+=8+e)>>>24&255,t>>>16&255,t>>>8&255,255&t],0),a=0;a<r;a++)o=(s=i[a]).duration,l=s.size,d=s.flags,u=s.cts,n.set([o>>>24&255,o>>>16&255,o>>>8&255,255&o,l>>>24&255,l>>>16&255,l>>>8&255,255&l,d.isLeading<<2|d.dependsOn,d.isDependedOn<<6|d.hasRedundancy<<4|d.paddingValue<<1|d.isNonSync,61440&d.degradPrio,15&d.degradPrio,u>>>24&255,u>>>16&255,u>>>8&255,255&u],12+16*a);return k.box(k.types.trun,n)}static initSegment(e){k.types||k.init();var e=k.moov(e),t=new Uint8Array(k.FTYP.byteLength+e.byteLength);return t.set(k.FTYP),t.set(e,k.FTYP.byteLength),t}static saio(e,t){let i=12,r=0;t&&(r|=1,i+=8);var n=new Uint8Array(i);H.writeUint32(n,0,r),n[0]=0;let a=4;t&&(H.writeUint32(n,a,t.auxInfoType),H.writeUint32(n,a+4,t.auxInfoParameter),a+=8),H.writeUint32(n,a,1),a+=4;t=e+4+4;return H.writeUint32(n,a,t),k.box(k.types.saio,n)}static saiz(e,t,i){let r=9,n=0;i&&(n|=1,r+=8),fe(e)||(e=0);var a=t.length,s=(0===e&&(r+=a),new Uint8Array(r));H.writeUint32(s,0,n),s[0]=0;let o=4;if(i&&(H.writeUint32(s,o,i.auxInfoType),H.writeUint32(s,o+4,i.auxInfoParameter),o+=8),s[o++]=e,H.writeUint32(s,o,a),o+=4,0===e)for(const e of t)s[o++]=e;return k.box(k.types.saiz,s)}static senc(t){const i=t.samples||[],e=i.length;let r=0,n=NaN,a=!0;var s=[];if(!t.encrypted||e<=0)return{boxData:new Uint8Array,sampleInfoSizes:s,defaultSampleInfoSize:0};t=t.defaultPerSampleIVSize||0;for(const t of i)t.subsamples&&(r+=t.subsamples.length);if(r<=0)return{boxData:new Uint8Array,sampleInfoSizes:s,defaultSampleInfoSize:0};var o=new Uint8Array(2*e+e*t+6*r+4);let l=this.set32(e,o,0);for(const t of i){const i=t.subsamples||[];let e=2;t.iv&&(o.set(t.iv,l),l+=t.iv.byteLength,e+=t.iv.byteLength),l=this.set16(i.length,o,l);for(const t of i)l=this.set16(t[0],o,l),l=this.set32(t[1],o,l),e+=6;s.push(e),fe(n)||(n=e),a=a&&n===e,n=e}return{boxData:k.box(k.types.senc,new Uint8Array([0,0,0,2]),o),defaultSampleInfoSize:a?n:0,sampleInfoSizes:s}}static sinf(e,t,i){return k.box(k.types.sinf,k.frma(i),k.schm(),k.schi(e,t))}static frma(e){return k.box(k.types.frma,new Uint8Array(e))}static schm(){return k.box(k.types.schm,new Uint8Array([0,0,0,0,99,98,99,115,0,1,0,0]))}static schi(e,t){return k.box(k.types.schi,k.tenc(e,t))}static tenc(e,t){let i=0;"video"===t&&(i=25);t=new Uint8Array(17);if(t[0]=16,e.iv&&16===e.iv.byteLength&&t.set(e.iv,1),e.keyId)return k.box(k.types.tenc,new Uint8Array([1,0,0,0,0,i,1,0]),e.keyId,t);throw"tenc: no key id found in decryptdata"}static sbgp(e){return e.encrypted&&0!==e.samples.length&&e.samples[0].keyTagInfo?(e=e.samples.length,k.box(k.types.sbgp,new Uint8Array([0,0,0,0]),new Uint8Array(k.types.seig),new Uint8Array([0,0,0,1,e>>24&255,e>>16&255,e>>8&255,255&e,0,1,0,1]))):new Uint8Array}static sgpd(e){if(!e.encrypted||0===e.samples.length||!e.samples[0].keyTagInfo)return new Uint8Array;var t=e.samples[0].keyTagInfo;let i=0;"video"===e.type&&(i=25);e=new Uint8Array(17);if(e[0]=16,t.iv&&e.set(t.iv,1),t.keyId)return k.box(k.types.sgpd,new Uint8Array([1,0,0,0]),new Uint8Array(k.types.seig),new Uint8Array([0,0,0,37,0,0,0,1]),new Uint8Array([0,i,1,0]),t.keyId,e);throw"sgpd: no keyid in decryptdata"}static pssh(e,t,i){if(k.types||k.init(),!e)throw new TypeError("Bad system id");if(16!==e.byteLength)throw new RangeError("Invalid system id");let r,n,a;if(t){r=1,n=new Uint8Array(16*t.length);for(let e=0;e<t.length;e++){const i=t[e];if(16!==i.byteLength)throw new RangeError("Invalid key");n.set(i,16*e)}}else r=0,n=new Uint8Array;0<r?(a=new Uint8Array(4),t&&0<t.length&&new DataView(a.buffer).setUint32(0,t.length,!1)):a=new Uint8Array;var s=new Uint8Array(4);return i&&0<i.byteLength&&new DataView(s.buffer).setUint32(0,i.byteLength,!1),k.box(k.types.pssh,new Uint8Array([r,0,0,0]),e,a,n,s,i||new Uint8Array)}}var at,st,ot,y=k;(t=at=at||{})[t.SDR=0]="SDR",t[t.HDR=1]="HDR",t[t.HDR10=2]="HDR10",t[t.DolbyVision=3]="DolbyVision",t[t.HLG=4]="HLG",(t=st=st||{})[t.H264=16]="H264",t[t.HEVC=64]="HEVC",t[t.VP09=65]="VP09";const lt=new Set(["ac-3","mp4a.a5","mp4a.A5"]),dt=new Set(["ec-3","mp4a.a6","mp4a.A6"]),ut=((t=ot=ot||{})[t.Family=1]="Family",t[t.Profile=2]="Profile",t[t.Compatibility=3]="Compatibility",t[t.Tier=4]="Tier",t[t.Level=5]="Level",/^([^.]+)\.([^.]+)(?:\.([^.])\.([a-zA-Z])([^.]+))?/i),ct=/^mp4a\.40\.(.*)/,ht=/^avc[13]\./,pt=/^h(ev|vc)1\./,mt=/^dv(h1|he|a1|av)\./,ft=/^vp09\./,gt=/^av01\./,yt={aac:1024,mp3:1024,ac3:1536,ec3:1536},ge={isAC3:e=>lt.has(e),isEC3:e=>dt.has(e),isDolbyAtmos:(e,t)=>ge.isEC3(e)&&ge.isJOCChannels(t),isJOCChannels(e){e=e.split("/");return 1<e.length&&void 0!==e[1].split(",").find(e=>"JOC"===e)},isAAC(e){return Boolean(e&&("aac"===e||null!==(e=e.match(ct))&&"34"!==e[1]))},isMP3(e){return Boolean(e&&("mp3"===e||null!==(e=e.match(ct))&&"34"===e[1]))},isAVC:e=>ht.test(e),isXHEAAC:function(e){return"mp4a.40.42"===e},isALAC:function(e){return"alac"===e},isFLAC:function(e){return"fLaC"===e},isHEVC:e=>pt.test(e),isDolby:e=>mt.test(e),isVP09:e=>ft.test(e),isAV1:e=>gt.test(e),isCompatibleCodecString(e,t){var e=e.split(","),t=t.split(","),i=e.filter(e=>ge.isVideoCodec(e)),r=t.filter(e=>ge.isVideoCodec(e)),e=e.filter(e=>ge.isAudioCodec(e)),t=t.filter(e=>ge.isAudioCodec(e)),i=0===i.length&&0===r.length||i.length===r.length&&ge.isCompatibleVideoCodec(i[0],r[0]),r=0===e.length&&0===t.length||e.length===t.length&&ge.isCompatibleAudioCodec(e[0],t[0]);return i&&r},isVideoCodec:e=>ge.isAVC(e)||ge.isDolby(e)||ge.isHEVC(e)||ge.isVP09(e)||ge.isAV1(e),isAudioCodec:e=>ge.isAC3(e)||ge.isEC3(e)||ge.isAAC(e)||ge.isMP3(e),isCompatibleVideoCodec:(e,t)=>Boolean(e&&t&&(e===t||ge.isDolby(e)&&ge.isDolby(t)||ge.isHEVC(e)&&ge.isHEVC(t)||ge.isAVC(e)&&ge.isAVC(t)||ge.isVP09(e)&&ge.isVP09(t)||ge.isAV1(e)&&ge.isAV1(t))),isCompatibleAudioCodec:(e,t)=>Boolean(e&&t&&(e===t||ge.isAAC(e)&&ge.isAAC(t)||ge.isAC3(e)&&ge.isAC3(t)||ge.isEC3(e)&&ge.isEC3(t)||ge.isMP3(e)&&ge.isMP3(t))),isCompatibleImmersiveAudioType:e=>!("IMMERSIVE"===e||"BINAURAL"===e||"DOWNMIX"===e),getStickyAtmosStatus:(e,t,i)=>e&&t&&i&&ge.isEC3(t)?ge.isJOCChannels(i):null,getImmersiveAudioType(e){e=e.split("/");return 2<e.length&&("IMMERSIVE"===e[2]||"BINAURAL"===e[2]||"DOWNMIX"===e[2])?e[2]:"UNKNOWN"},getSegmentCodec(e){let t;if(ge.isAAC(e))t="aac";else if(ge.isAC3(e))t="ac3";else if(ge.isEC3(e))t="ec3";else{if("mp3"!==e)throw new me(!1,pe.InvalidAudioCodec,`invalid audio config, codec `+e);t="mp3"}return t},getChannelCount(e){return e&&fe(e=parseInt(e))?e:0},avc1toavcoti(e){var t,i=e.split(".");let r;return 2<i.length?(r=i.shift()+".",r=(r+=parseInt(null!=(t=i.shift())?t:"").toString(16))+("000"+parseInt(null!=(t=i.shift())?t:"").toString(16)).substr(-4)):r=e,r},getDynamicRangeType(e,t){let i=at.SDR;return t&&("PQ"===e&&ge.isDolby(t)?i=at.DolbyVision:"PQ"===e&&(ge.isHEVC(t)||ge.isVP09(t)||ge.isAV1(t))?i=at.HDR10:"HLG"===e&&(-1!==t.indexOf("hvc1")||ge.isVP09(t)||ge.isAV1(t))&&(i=at.HLG)),i},getCompressionType(e){let t=st.H264;return ge.isHEVC(e)||ge.isDolby(e)?t=st.HEVC:(ge.isVP09(e)||ge.isAV1(e))&&(t=st.VP09),t},isHigherCodecByFamily(e,t){if(!e)return!0;var i=ut.exec(e),r=ut.exec(t);if(!i||!r)return!1;const n=i[ot.Family],a=r[ot.Family];if(n!==a)throw new me(!1,pe.MismatchCodecFamily,`mismatch in codec family current/new: ${n}/`+a);switch(n){case"avc1":case"avc3":return r[ot.Profile]>i[ot.Profile];case"vp09":case"av01":return e<t;case"hvc1":case"hev1":const n="H"===i[ot.Tier]?1:0,a="H"===r[ot.Tier]?1:0;return r[ot.Profile]>i[ot.Profile]||r[ot.Compatibility]>i[ot.Compatibility]||a>n||r[ot.Level]>i[ot.Level];case"dvh1":return r[ot.Profile]>i[ot.Profile]||r[ot.Compatibility]>i[ot.Compatibility];default:return!0}}};class vt{static getTrack(e,t,i,r,n){let a;switch(ge.getSegmentCodec(i)){case"aac":var s=le(e,1===r?new Uint8Array([255,241,92,64,1,127,252]):new Uint8Array([255,241,92,128,1,191,252]),0,i);s&&(a={type:"audio",info:{id:t,timescale:s.samplerate,duration:0,encrypted:!1,keyTagInfo:void 0},config:s});break;case"ac3":case"ec3":{const i=He(e,new Uint8Array([11,119,69,17,128,64,47,132]),0);i&&(a={type:"audio",info:{id:t,timescale:i.samplerate,duration:0,encrypted:!1,keyTagInfo:void 0},config:i})}}return a}static getSample(e,t){let i;switch(e){case"mp4a.40.2":case"mp4a.40.5":i=1===t?new Uint8Array([0,208,0,7]):new Uint8Array([33,0,3,64,104,28]);break;case"ac-3":case"ec-3":i=new Uint8Array([11,119,69,17,128,64,47,132,41,3,253,214,124,253,243,215,233,95,185,123,78,20,40,106,97,190,74,253,43,218,208,140,191,176,144,120,214,181,44,124,129,251,91,109,187,109,198,225,43,172,116,140,176,123,38,144,211,247,225,64,29,53,175,96,16,57,121,87,78,203,81,37,7,72,228,132,37,169,38,231,97,229,247,194,208,8,12,83,74,139,137,17,22,26,221,203,107,113,94,93,75,33,208,247,146,105,39,143,6,36,1,227,108,70,11,180,152,218,182,218,209,59,85,104,201,70,37,82,219,68,55,225,144,99,149,0,119,26,14,69,164,241,204,222,81,177,142,80,20,100,97,143,101,221,140,113,31,208,124,25,64,29,49,77,140,30,155,74,214,204,138,229,109,172,95,130,70,230,134,88,59,179,212,155,232,0,0,0,0,0,173,234])}return i}static getSegment(e,i,r,n){if(e){var a=e.info["timescale"],s=e.config["segmentCodec"],o=vt.getSample(e.config.codec,e.config.channelCount);if(o){var l=[],e={id:e.info.id,sequenceNumber:i,type:"audio",encrypted:!1,samples:l,defaultPerSampleIVSize:0},d=yt[s],u=Math.ceil(n*a/d),i={baseTime:Math.round(u*d+r),timescale:a};let t=0;var s=u*o.byteLength+8,c=new Uint8Array(s);c[0]=s>>24&255,c[1]=s>>16&255,c[2]=s>>8&255,c[3]=255&s,y.types||y.init(),c.set(y.types.mdat,4),t+=8;for(let e=0;e<u;e++)l.push({duration:d,size:o.byteLength,cts:0,flags:{isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:1,isNonSync:0,paddingValue:0}}),c.set(o,t),t+=o.byteLength;n=y.moof(r,e),a=new Uint8Array(n.byteLength+c.byteLength);return a.set(n),a.set(c,n.byteLength),{silentFragData:a,endTs:i}}}}}let It=null;class St extends ce{constructor(e,t,i,r,n,a){super(e,t,n),this.vt=i,this.gt=a,this.yt=NaN,this.bt=NaN,this.St=null,this.wt=null,this.It=null,this.Tt=!1,this.Ot=!1,this.logger=n.child({name:"EsRemuxer"});t=navigator.userAgent||"";if(null===It){const e=t.match(/Chrome\/(\d+)/i);It=e?parseInt(e[1]):0}}resetTimeStamp(e){this.yt=this.bt=e,this.St=this.wt=null}resetInitSegment(){this.kt=void 0,this.Mt=void 0}remuxEsTracks(n,a,e,s,o,l,d,u,c,h){l||(this.Ot=this.Tt=!1);var l=this.Ot,p=this.Tt,m=n&&0<n.parsingData.esSamples.length,f=a&&0<a.parsingData.esSamples.length;let g;var y=void 0===c?o:c;let v=y,I=y;if(!this.kt){if(n&&n.config.codec&&(this.gt={id:n.info.id,codec:n.config.codec,channelCount:n.config.channelCount}),a&&h&&this.gt){const n=vt.getTrack(this.observer,this.gt.id,this.gt.codec,this.gt.channelCount,this.logger);if(n){this.Mt=Object.assign(Object.assign({},n),{info:Object.assign(Object.assign({},n.info),{inputTimescale:9e4}),parsingData:{len:0,sequenceNumber:0,esSamples:[]}});const e=Math.round(y*this.Mt.info.timescale);g=vt.getSegment(this.Mt,a.parsingData.sequenceNumber,e,h),a.parsingData.sequenceNumber++}}else this.Mt=void 0;this.updateInitPTSDTS(a,n,o),this.generateIS(this.Mt||n,a)}if(this.kt){let i,r,t=null;if(m&&f&&void 0===c){const e=Tt(a.parsingData.esSamples),s=(bt(n.parsingData.esSamples[0].pts,e)-e)/a.info.inputTimescale;v+=Math.max(0,s),I+=Math.max(0,-s)}if(a&&h&&this.Mt&&!g){const n=this.yt+Math.round((y+this.At)*this.Mt.info.timescale);g=vt.getSegment(this.Mt,a.parsingData.sequenceNumber,n,h)}if(m){if(fe(n.info.timescale)||(this.updateInitPTSDTS(a,n,o),this.generateIS(n,a)),t=this.remuxAudio(n,v,p,d,f?I:void 0,u),f){let e;t&&(e=C(t.endPTS)-C(t.startPTS)),fe(a.info.timescale)||(this.updateInitPTSDTS(a,n,o),this.generateIS(n,a)),i=this.remuxVideo(a,I,l,e,h)}}else(i=f?this.remuxVideo(a,I,l,void 0,h):i)&&n&&n.config.codec&&(t=this.remuxEmptyAudio(n,v,p,d,f?I:void 0,i,u));if(g&&i){let e=i.endDTS,t=i.endPTS;b(g.endTs)&&fe(g.endTs.baseTime)&&(e=R(i.endDTS,g.endTs),t=R(i.endPTS,g.endTs)),this.yt=C(t),this.bt=C(e),r={data1:i.data1,data2:g.silentFragData,startDTS:i.startDTS,startPTS:i.startPTS,endDTS:e,endPTS:t,type:"audiovideo",track:this.kt}}else if(i&&t)r={data1:i.data1,data2:t.data1,startDTS:(y=i.startDTS,m=t.startDTS,C(y)<C(m)?y:m),startPTS:i.startPTS,endDTS:i.endDTS,endPTS:i.endPTS,type:"audiovideo",track:this.kt,dropped:i.dropped,framesWithoutIDR:i.framesWithoutIDR,firstKeyframePts:i.firstKeyframePts};else if(i)r={data1:i.data1,startDTS:i.startDTS,startPTS:i.startPTS,endDTS:i.endDTS,endPTS:i.endPTS,type:"video",track:this.kt,dropped:i.dropped,framesWithoutIDR:i.framesWithoutIDR,firstKeyframePts:i.firstKeyframePts};else if(t)r={data1:t.data1,startDTS:t.startDTS,startPTS:t.startPTS,endDTS:t.endDTS,endPTS:t.endPTS,type:"audio",track:this.kt};else if(this.logger.error(`Missing video and audio data, iframeMediaStart=`+c),fe(c)){const n=x(c,1);r={data1:new Uint8Array(0),startDTS:n,startPTS:n,endDTS:n,endPTS:n,type:"video",track:this.kt,dropped:1,framesWithoutIDR:1,firstKeyframePts:n}}r&&(r.audioTrackInfo=this.gt),null!=s&&s.captionSamples.length&&r&&this.remuxText(s,r),null!=(o=null==e?void 0:e.id3Samples)&&o.length&&r&&this.remuxID3(e,r),this.observer.trigger(E.FRAG_PARSING_DATA,r)}else this.logger.error("failed to generate IS");this.observer.trigger(E.FRAG_PARSED)}updateInitPTSDTS(e,t,i){let r=1/0,n=1/0;const a=e?e.parsingData.esSamples:[],s=t?t.parsingData.esSamples:[];if(!fe(this.yt)){if(t&&s.length&&(r=n=s[0].pts-t.info.inputTimescale*i),e&&a.length&&e.config.sps&&e.config.pps){const t=e.info.inputTimescale,s=Tt(a),o=Math.round(t*i);e.info.timescale=t,r=Math.min(r,s-o),n=Math.min(n,bt(a[0].dts,s)-o),this.observer.trigger(E.INIT_PTS_FOUND,{initPTS:x(r,t)})}if(fe(r)&&fe(n))this.yt=r,this.bt=n;else{const e=new O(!1,pe.InvalidInitTimestamp);this.observer.trigger(L.INTERNAL_ERROR,e)}}}generateIS(e,t){const i=t?t.parsingData.esSamples:[],r=this.vt;let n,a="audio/mp4";if(e&&t&&i.length&&t.config.sps&&t.config.pps){const i=t.info.inputTimescale,r=(t.info.timescale=i,e.info.timescale=e.config.samplerate,k.initSegment([t,e]));n={type:"audiovideo",container:"video/mp4",codec:t.config.codec+`,`+e.config.codec,initSegment:r}}else if(e){e.info.timescale=e.config.samplerate,"mp3"===e.config.segmentCodec&&(r.mpeg?(a="audio/mpeg",e.config.codec=""):r.mp3&&(e.config.codec="mp3"));const t="mp3"===e.config.segmentCodec&&r.mpeg?new Uint8Array:k.initSegment([e]);n={type:"audio",container:a,codec:e.config.codec,initSegment:t}}else if(t&&i.length&&t.config.sps&&t.config.pps){const e=t.info.inputTimescale,i=(t.info.timescale=e,k.initSegment([t]));n={type:"video",container:"video/mp4",codec:t.config.codec,initSegment:i}}if(n){const e={track:this.kt=n};this.observer.trigger(E.FRAG_PARSING_INIT_SEGMENT,e)}else{const e=new O(!1,pe.NoAVSamplesFound);this.observer.trigger(L.INTERNAL_ERROR,e)}}remuxVideo(n,a,s,o,l){var d;let u,i,e,c=8,h=null!=(f=this.It)?f:NaN,p=Number.POSITIVE_INFINITY,r=Number.NEGATIVE_INFINITY,t=n.parsingData.dropped,m=this.wt;var f=!s&&!!this.config.forceKeyFrameOnDiscontinuity,g=n.parsingData.esSamples,y=n.info.inputTimescale,v=[],I=this.bt,S=n.info.encrypted,b=fe(l);let T=g.length,A=!1;s&&null!==m||(m=a*y-(g[0].pts-bt(g[0].dts,g[0].pts)));for(let e=0;e<T;e++){const a=g[e];a.pts=bt(a.pts,m+I),a.dts=bt(a.dts,m+I),a.dts<g[0<e?e-1:e].dts&&(A=!0)}A&&g.sort(function(e,t){var i=e.dts-t.dts,r=e.pts-t.pts;return i||r||e.id-t.id});let E=NaN;var s=g.findIndex(e=>e.key),f=(g[s]&&(E=g[s].pts),f&&(0<s?(g.splice(0,s),T=g.length,t+=s):-1===s&&(t+=g.length)),(e=b?(i=p=E=m=a*y,h=l*y/T,r=i+h*(T-1)):(i=g[0].dts,g[g.length-1].dts))-i),O=f?Math.round(f/(T-1)):h||y/30;i=Math.max(0,i);let w=0,R=0;for(let e=0;e<T;e++){const a=g[e],s=a.units,o=s.length;let t=0;for(let e=0;e<o;e++)t+=s[e].data.length;R+=t,w+=o,a.length=t,a.dts=Math.max(a.dts,i),b||(p=Math.min(a.pts,p),r=Math.max(a.pts,r))}b||(e=g[T-1].dts,r=Math.max(r,0,p+O));l=R+4*w+8;try{u=new Uint8Array(l)}catch(n){const a=new D(!1,pe.FailedToAllocateVideoMdat,l,`fail allocating video mdat `+l);return void this.observer.trigger(L.INTERNAL_ERROR,a)}var M=new DataView(u.buffer);M.setUint32(0,l),u.set(k.types.mdat,4);let P=!1;for(let t=0;t<T;t++){const a=g[t],s=a.units;let i=0;const f=[];let e,r=0;for(let e=0,t=s.length;e<t;e++){const a=s[e],o=a.data,d=a.data.byteLength;if(M.setUint32(c,d),c+=4,u.set(o,c),c+=d,i+=4+d,S)if(d<=48||1!==a.type&&5!==a.type)r+=4+d;else{let e=d-32;e%16==0&&(e-=16),f.push([r+36,e]),r=d-32-e}}if(0<r&&f.push([r,0]),b)e=0;else{if(t<T-1)h=g[t+1].dts-a.dts;else{const s=this.config,l=0<t?a.dts-g[t-1].dts:O;if(s.stretchShortVideoTrack&&null!==this.wt){const{maxBufferHole:n,maxSeekHole:f}=s,pe=Math.floor(Math.min(null!=(d=null!=n?n:f)?d:NaN,null!=f?f:NaN)*y),u=(o?p+o*y:(null!=(d=this.St)?d:NaN)+this.yt)-a.pts;!(u>pe)||(h=u-l)<0?h=l:P=!0}else h=l}e=Math.round(a.pts-a.dts)}v.push({size:i,duration:h,cts:e,flags:{isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:a.key?2:1,isNonSync:a.key?0:1,paddingValue:0},keyTagInfo:a.keyTagInfo,subsamples:f})}if(v.length&&It&&It<70){const n=v[0].flags;n.dependsOn=2,n.isNonSync=0}a=e+h,this.wt=a-(b?0:I),this.It=P||!h?O:h,this.Ot=!0,f={sequenceNumber:n.parsingData.sequenceNumber++,id:n.info.id,type:n.type,encrypted:n.info.encrypted,samples:v,defaultPerSampleIVSize:0},l=k.moof(i+this.At*y,f),n.parsingData.esSamples=[],f=new Uint8Array(l.byteLength+u.byteLength);return f.set(l),f.set(u,l.byteLength),{data1:f,startPTS:x(p/y,y),endPTS:x(r/y,y),startDTS:x(i/y,y),endDTS:x(a/y,y),type:"video",dropped:t,framesWithoutIDR:s,firstKeyframePts:x(E/y,y)}}remuxAudio(n,i,r,a,e,s){var o;const t=n.info.inputTimescale,l=t/n.info.timescale,d=("aac"===n.config.segmentCodec?1024:"mp3"===n.config.segmentCodec?1152:1536)*l,u=this.yt,c="mp3"===n.config.segmentCodec&&this.vt.mpeg,h=[],p=n.info.encrypted,m=void 0!==e;let f,g,y=c?0:8;var v=new Ve,I=n.parsingData.esSamples;let S=this.St||-1;const b=i*t,T=I.length&&0<S&&(a&&Math.abs(b-S)<9e3||Math.abs(bt(I[0].pts-u,b)-S)<20*d),A=this.Tt=r=r||!!T;I.forEach(e=>{e.pts=e.dts=bt(e.pts,b+u)}),A&&-1!==S||(S=0===e?0:a&&!m?b:I[0].pts-u);let E=Math.max(0,S+u);if("aac"===n.config.segmentCodec)for(let i=0,r=E;i<I.length;i++){const a=I[i],e=a.pts,o=e-r,pe=o/t;if(o<=-d&&m)0===i&&(E=r=e,this.St=E-u);else if(o>=d&&pe<1e4&&m){let t=Math.round(o/d);(r=e-t*d)<0&&(t--,r+=d),0===i&&(E=r,this.St=E-u);for(let e=0;e<t;e++){let e=et(n.config.codec,n.config.channelCount);e=e||a.unit.subarray(0),I.splice(i,0,{unit:e,pts:r,dts:r,keyTagInfo:s}),n.parsingData.len+=e.length,r+=d,i++}}r+=d}let O,w=null,R=null,M=0,P=I.length;for(;P--;)M+=I[P].unit.byteLength;for(let t=0,e=I.length;t<e;t++){const r=I[t],a=r.unit;let e=r.pts;if(null!==R)h[t-1].duration=Math.round((e-R)/l);else{if(A&&"aac"===n.config.segmentCodec&&(e=E),w=e,!(0<M))return null;M+=y;try{O=new Uint8Array(M)}catch(n){const i=new D(!1,pe.FailedToAllocateAudioMdat,M,`fail allocating audio mdat `+M);return this.observer.trigger(L.INTERNAL_ERROR,i),null}c||(new DataView(O.buffer).setUint32(0,M),O.set(k.types.mdat,4))}null!=O&&O.set(a,y);const s=a.byteLength,o=(y+=s,[]);if(p)if("ec3"===n.config.segmentCodec){let e=0;for(;e<a.byteLength;){const i=2*(v.bsReadAndUpdate(a,{byteOffset:e+2,usedBits:5},11)+1),r=(e+=i,Math.min(i,16));o.push([r,i-r])}}else{const n=Math.min(s,16);o.push([n,s-n])}f={size:s,cts:0,duration:0,flags:{isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:1,paddingValue:0,isNonSync:0},keyTagInfo:r.keyTagInfo,subsamples:o},h.push(f),R=e}i=h.length;if(i){let e=h[i-1].duration;if(2<=i&&(e=h[i-2].duration,f)&&(f.duration=e),E=(null!=R?R:NaN)+l*e,this.St=E-u,n.parsingData.len=0,c)g=new Uint8Array;else{const i={sequenceNumber:n.parsingData.sequenceNumber++,id:n.info.id,type:n.type,encrypted:n.info.encrypted,samples:h,defaultPerSampleIVSize:0};g=k.moof(((null!=w?w:NaN)+this.At*t)/l,i)}const r=new Uint8Array(g.byteLength+(null!=(o=null==O?void 0:O.byteLength)?o:NaN)),a=(r.set(g),O&&r.set(O,g.byteLength),n.parsingData.esSamples=[],{data1:r,startPTS:x((null!=w?w:NaN)/t,t),endPTS:x(E/t,t),startDTS:x((null!=w?w:NaN)/t,t),endDTS:x(E/t,t),type:"audio"});return this.Tt=!0,a}return null}remuxEmptyAudio(t,e,i,r,n,a,s){var o=t.info.inputTimescale,l=o/(t.config.samplerate||o),d=(null!=(d=this.St)?d:NaN)+this.yt,u=(1?d:C(a.startDTS)*o)+this.bt,d=C(a.endDTS)*o+this.bt,c=1024*l,h=Math.ceil((d-u)/c),p=et(t.config.codec,t.config.channelCount);if(!p)return this.logger.error("Unable to remuxEmptyAudio since we were unable to get a silent frame for given audio codec!"),null;var m=[];for(let e=0;e<h;e++){const i=u+e*c;m.push({unit:p,pts:i,dts:i,keyTagInfo:s}),t.parsingData.len+=p.length}return t.parsingData.esSamples=m,this.remuxAudio(t,e,i,r,n,s)}remuxID3(t,e){var i,r=t.id3Samples.length,n=t.inputTimescale;if(r){for(let e=0;e<r;e++)(i=t.id3Samples[e]).pts=i.pts/n,i.dts=i.dts/n;e.id3Samples=t.id3Samples}t.id3Samples=[]}remuxText(t,e){t.captionSamples.sort(function(e,t){return e.pts-t.pts});var i,r=t.captionSamples.length,n=t.inputTimescale;if(r){for(let e=0;e<r;e++)(i=t.captionSamples[e]).pts=i.pts/n;e.captionData||(e.captionData={}),e.captionData.ts=t.captionSamples}t.captionSamples=[]}get At(){var e;return null!=(e=this.config.audioPrimingDelay)?e:0}}function bt(e,t){var i;if(void 0!==t)for(i=t<e?-8589934592:8589934592;4294967296<Math.abs(e-t);)e+=i;return e}function Tt(e){const n=e[0].pts;return e.reduce((e,t)=>{let i=t.pts,r=i-e;return r<-4294967296&&(i=bt(i,n),r=i-e),0<r?e:i},n)}const At={name:"MP4EncryptionRemuxer"};class Et extends ce{constructor(e,t,i,r,n){super(e,t,n)}static _isCommonEncryptionInternal(e){return Boolean(e&&!("NONE"===e||"AES-128"===e))}static remuxInitSegment(r,d,u,c){if(!u)return r;let e=r;if(Et._isCommonEncryptionInternal(u.method)){const h=u.keyId;let l=!1;const p=[],t=H.findBoxWithOffset(r,0,["moov","trak"]);for(let e=0;e<t.length;++e){const m=t[e],f=m.data;let o,i=0;const g=H.findFirstBoxWithOffset(f,0,["mdia","minf","stbl","stsd"],!0);if(g){var n=g.data.subarray(8);let t=!0,e=H.findBoxWithOffset(n,g.offset+16,["enca"]);0===e.length&&(t=!1,e=H.findBoxWithOffset(n,g.offset+16,["encv"])),e.forEach(a=>{let e=null,s=null;i=t?(e=a.data.subarray(28),o="audio",g.offset+16+8+28):(e=a.data.subarray(78),o="video",g.offset+16+8+78),e&&H.findBoxWithOffset(e,i,["sinf"]).forEach(e=>{const t=e.data,i=H.findFirstBox(t,["frma"]),r=H.findFirstBox(t,["schm"]);if(i)if(r){var n=H.bin2str(r.subarray(4,8));if("aac "===H.bin2str(i.subarray(0,4))&&(y.types||y.init(),i.set(y.types.mp4a,0)),"cbcs"===n||"cenc"===n){c&&c.push(t);const e=H.findFirstBox(t,["schi","tenc"]);if(e){const d=8,c=(e.subarray(d,d+16),h&&e.set(h,d),e[6]),a=e[7];if(1===c&&0===a){const d=e[24];0<d&&u.iv&&d===u.iv.length&&e.set(u.iv,25)}}}else if("cbc2"===n){l=!0,y.types||y.init();const d=H.findFirstBoxWithOffset(t,0,["frma"]);if(d){const c=y.box(y.types.schi,y.tenc(u,o)),h=y.box(y.types.sinf,t.subarray(d.offset,d.boxSize),y.schm(),c),i=(s=y.box(y.types.trak,f.subarray(0,e.offset),h,f.subarray(e.offset+e.boxSize))).subarray(8),r=h.byteLength-e.boxSize;g.walkedPath&&(g.walkedPath.push({type:"stsd",offset:a.offset,size:a.boxSize}),g.walkedPath.forEach(e=>{H.writeUint32(i,e.offset,e.size+r)}))}}}else d.error(At,"missing schm box");else d.error(At,"missing frma box")}),s=s||r.subarray(m.offset,m.offset+m.boxSize),p.push(s)});n=H.findFirstBoxWithOffset(f,0,["edts"]);n&&(y.types||y.init(),f.set(y.types.free,n.offset+4))}}l&&(e=Et.remuxCbc2InitSegment(r,p,d)||r)}return e}static remuxCbc2InitSegment(e,t,i){const r=H.findFirstBoxWithOffset(e,0,["ftyp"]);if(!r)return i.error(At,"no ftyp found"),new Uint8Array;var n=H.findFirstBoxWithOffset(e,r.boxSize,["moov"]);let a=[],s=0;for(;n&&s<n.data.byteLength;){const e=H.readUint32(n.data,s),i=H.bin2str(n.data.subarray(s+4,s+8)),r=1<e?s+e:n.data.byteLength;"trak"===i?t&&(a=a.concat(t),t=void 0):a.push(n.data.subarray(s,r)),s=r}var i=y.box(y.types.moov,...a),o=new Uint8Array(r.boxSize+i.byteLength);return o.set(e.subarray(0,r.boxSize)),o.set(i,r.boxSize),o}static remuxOverflowSegment(i,e){y.types||y.init();var t=H.findBoxWithOffset(i,0,["moof","traf","tfdt"]);let r,n=i.byteLength;if(t.forEach(e=>{0===e.data[0]&&(n+=4)}),n>i.byteLength){r=new Uint8Array(n);let e=0,t=0;for(;t<i.byteLength;){const n=H.readUint32(i,t),a=H.bin2str(i.subarray(t+4,t+8)),s=1<n?t+n:i.byteLength;if("moof"===a){const n=Et.remuxOverflowMoof(i.subarray(t+8,s));r.set(n,e),e+=n.byteLength}else r.set(i.subarray(t,s),e),e+=n;t=s}}return r||i}static remuxOverflowMoof(e){let t=0;for(var i=[];t<e.byteLength;){const r=H.readUint32(e,t);if("traf"===H.bin2str(e.subarray(t+4,t+8))){const a=Et.remuxOverflowTraf(e.subarray(t+8,t+r));i.push(a)}else i.push(e.subarray(t,t+r));t=1<r?t+r:e.byteLength}const r=y.box(y.types.moof,...i),a=r.byteLength-e.byteLength-8;return H.findBoxWithOffset(r,0,["moof","traf","trun"]).forEach(e=>{var t;0!=(1&e.data[3])&&(t=H.readUint32(e.data,8),H.writeUint32(e.data,8,t+a))}),H.findBoxWithOffset(r,0,["moof","traf","saio"]).forEach(t=>{const i=1&t.data[0];let r=4;1&t.data[3]&&(r+=8);var n=H.readUint32(t.data,r);if(r+=4,i)for(let e=0;e<n;e++){const i=H.readUint64(t.data,r);H.writeUint64(t.data,r,i+a),r+=8}else for(let e=0;e<n;e++){const i=H.readUint32(t.data,r);H.writeUint32(t.data,r,i+a),r+=4}}),r}static remuxOverflowTraf(e){let t=0;for(var i=[];t<e.byteLength;){var r,n=H.readUint32(e,t);"tfdt"===H.bin2str(e.subarray(t+4,t+8))&&0===e[t+8]?(r=H.readUint32(e,t+12),r=y.box(y.types.tfdt,new Uint8Array([1,0,0,0,0,0,0,0,r>>24,r>>16&255,r>>8&255,255&r])),i.push(r)):i.push(e.subarray(t,t+n)),t=1<n?t+n:e.byteLength}return y.box(y.types.traf,...i)}remuxText(e,t){e.captionSamples.sort(function(e,t){return e.pts-t.pts}),e.captionSamples.length&&(t.captionData||(t.captionData={}),t.captionData.mp4=e.captionSamples),e.captionSamples=[]}remuxIFrame(r,n,a,s,o){if(n.samples&&n.samples.length&&n.samples[0].data){let e;var l=y.moof(r*n.timescale,n,this.logger),d=new Uint8Array(l.byteLength+n.samples[0].data.byteLength+8),l=(d.set(l),H.writeUint32(d,l.byteLength,n.samples[0].data.byteLength+8),d.set(y.types.mdat,l.byteLength+4),d.set(n.samples[0].data,l.byteLength+8),n.sequenceNumber++,n.timescale),u=x(r+s,l),l=x(r,l);let t,i;t=a?(e="audiovideo",a.sequenceNumber=n.sequenceNumber,n.sequenceNumber++,(i=vt.getSegment(a,a.sequenceNumber,r*a.info.timescale,s))?R(i.endTs,u):u):(e="video",u);n={data1:d,data2:null==i?void 0:i.silentFragData,startPTS:l,startDTS:l,endPTS:t,endDTS:t,type:e,dropped:0,track:o};this.observer.trigger(E.FRAG_PARSING_DATA,n),this.observer.trigger(E.FRAG_PARSED)}}remuxEmsgAndRawData(e,t,i,r,n,a,s,o,l,d,u){let c="video";t&&r?c="audiovideo":t?c="audio":r&&(c="video");t=Math.max(i,e),r={data1:d,track:u,startPTS:x(o,l),startDTS:x(o,l),endPTS:{baseTime:NaN,timescale:NaN},endDTS:{baseTime:NaN,timescale:NaN},largestVideoSampleSize:n,type:c,dropped:0};return t&&(r.endPTS=x(o+t,l),r.endDTS=x(o+t,l)),a&&a.captionSamples.length&&this.remuxText(a,r),s&&0<s.id3Samples.length&&this.remuxID3(s,r),this.observer.trigger(E.FRAG_PARSING_DATA,r),this.observer.trigger(E.FRAG_PARSED),r}remuxID3(t,e){var i,r=t.id3Samples.length;if(r){for(let e=0;e<r;e++)(i=t.id3Samples[e]).pts=i.pts-10,i.dts=i.dts-10;e.id3Samples=[...t.id3Samples]}t.id3Samples=[]}static remuxSampleAuxiliaryInfo(e,t){let i=!1,r=!1;var n=H.findBox(e,["moof","traf"]);for(const e of n){r=r||H.containsBox(e,["senc"]);for(const t of["saio","saiz"]){i=!0;const r=H.findBox(e,[t]);for(const e of r)if(!(e.length<8)&&0!=(1&H.readUint32(e,0))){const t=4;H.readUint32(e,t)!==Ye.CENC&&H.writeUint32(e,t,Ye.CENC)}}}return r||i}}const Ot=Math.pow(2,32)-1,wt=Math.pow(2,20)-1,Rt={name:"MP4Demuxer"},Mt=/\/emsg[-/]ID3/i;class Pt extends de{constructor(e,t,i,r=0,n){super(e,t,i,{},n),this.Et=!1,this.Nt=t,this.At=null!=(e=i.audioPrimingDelay)?e:0}resetTimeStamp(e){var t;fe(e)?null!=(t=this.Rt)&&t.audio&&!this.Rt.video?this.Pt={baseTime:Math.round(e*this.Rt.audio.timescale/9e4),timescale:this.Rt.audio.timescale}:this.Pt={baseTime:e,timescale:9e4}:this.Pt=void 0}static isHEVCFlavor(e){var t;return!!e&&("hvc1"===(e=(t=e.indexOf("."))<0?e:e.substring(0,t))||"hev1"===e||"chvc"===e||"qhvc"===e||"qhev"===e||"muxa"===e||"dvh1"===e||"dvhe"===e||"cdh1"===e||"qdh1"===e||"qdhe"===e)}resetInitSegment(t,i,r){if(this.Mt=void 0,t&&t.byteLength){var r=Et.remuxInitSegment(t,this.logger,r),n=this.Rt=Pt.parseInitSegment(r,this.logger);let e;var a=n.audioCodec,s=n.videoCodec;if(n.audio&&n.video?e={type:"audiovideo",container:"video/mp4",codec:a+","+s,initSegment:r}:(n.audio&&a&&(e={type:"audio",container:"audio/mp4",codec:a,initSegment:r}),n.video&&s&&(e={type:"video",container:"video/mp4",codec:s,initSegment:r})),n.video){const r=n.video,o=t.subarray(r.trakOffset,r.trakOffset+r.trakSize);this._t=Object.assign(Object.assign({},r),{info:{id:r.id,timescale:r.timescale,duration:i},trakData:o,sequenceNumber:0,samples:[]}),this.Et=!ge.isVP09(null!=s?s:"");i=null!=(t=n.caption)?t:{};this.Ct=Object.assign(Object.assign({},i),{sequenceNumber:0,captionSamples:[]})}if(n.audio&&a&&(this.xt=Object.assign({},n.audio)),n.caption&&(this.Et=!1,this.Ct=Object.assign(Object.assign({},n.caption),{sequenceNumber:0,captionSamples:[]})),this.Dt=e){const t={track:e};this.observer.trigger(E.FRAG_PARSING_INIT_SEGMENT,t)}}}static probe(e,t){return H.containsBox(e.subarray(0,Math.min(e.length,512e3)),["moof"])}static probeInitSegment(e){return H.containsBox(e.subarray(0,Math.min(e.length,512e3)),["moov","trak"])}static parseHvcC(e,t){let i;if(e&&1===e[0]){const t=e[1];i={profileSpace:t>>6,tierFlag:(32&t)>>5?"H":"L",profileIDC:31&t,profileCompat:H.readUint32(e,2),constraintIndicator:e.subarray(6,12),levelIDC:e[12]}}return i}static hvcCToCodecString(t,i){const r=t+"."+(i.profileSpace?String.fromCharCode(i.profileSpace+"A"-1):"")+i.profileIDC+"."+i.profileCompat.toString(16).toUpperCase()+"."+i.tierFlag+i.levelIDC;let n="";for(let e=i.constraintIndicator.length-1;0<=e;--e){const r=i.constraintIndicator[e];if(0!==r||""!==n){const t=r.toString(16).toUpperCase();n="."+(""===n?t:t+n)}}return r+n}static parseDvcC(e,t){let i;return i=e?{versionMajor:e[0],versionMinor:e[1],profile:e[2]>>1&127,level:e[2]<<5&32|e[3]>>3&31}:i}static dvcCToCodecString(e,t){return e+"."+Pt.checkAndAddLeadingZero(t.profile)+"."+Pt.checkAndAddLeadingZero(t.level)}static parseVpcC(e,t){let i;return i=e?{profile:e[4],level:e[5],bitDepth:e[6]>>4&15}:i}static vpcCToCodecString(e,t){return e+"."+Pt.checkAndAddLeadingZero(t.profile)+"."+Pt.checkAndAddLeadingZero(t.level)+"."+Pt.checkAndAddLeadingZero(t.bitDepth)}static parseAv1C(e,t){let i;if(e){const t=e[1]>>>3,r=(64&e[2])>>6,n=(32&e[2])>>5,a=(8&e[2])>>3,s=(4&e[2])>>2,o=3&e[2];i={profile:t,level:31&e[1],tierFlag:e[2]>>>7?"H":"M",bitDepth:2==t&&r?n?12:10:r?10:8,monochrome:(16&e[2])>>4,chromaSubsampling:``+a+s+o}}return i}static av1CToCodecString(e,t){var{profile:i,tierFlag:r,monochrome:n,chromaSubsampling:a}=t;return e+"."+i+"."+Pt.checkAndAddLeadingZero(t.level)+r+"."+Pt.checkAndAddLeadingZero(t.bitDepth)+"."+n+"."+a}static checkAndAddLeadingZero(e){return(e<10?"0":"")+e}static parseInitSegment(t,i){const r={foundLargeTimescale:!1,tracksById:{}},n=H.findBoxWithOffset(t,0,["moov","trak"]);for(let e=0;e<n.length;++e){const u=n[e],c=u.data,h=H.findFirstBox(c,["tkhd"]);if(h){var a=0===h[0]?12:20,a=H.readUint32(h,a),s=H.findFirstBox(c,["mdia","mdhd"]);if(s){var o=0===(d=s[0])?12:20,l=H.readUint32(s,o),d=(o+=4,1e6<=l&&(r.foundLargeTimescale=!0),0===d?H.readUint32(s,o):0),s=H.findFirstBox(c,["mdia","hdlr"]);if(s){o=H.bin2str(s.subarray(8,12)),s={soun:"audio",vide:"video",clcp:"caption",subt:"ttml"}[o]||o;if(s){o=H.findFirstBox(c,["mdia","minf","stbl","stsd"]);if(o){H.bin2str(o.subarray(12,16));o=Pt.parseStsd(o,i);let e;if("caption"===s){const t=Object.assign({id:a,type:s,timescale:l,duration:d,isTimingTrack:!1,sequenceNumber:0,captionSamples:[]},o);r.caption=t,e=t}else if("ttml"===s){const t=Object.assign({id:a,type:"ttml",timescale:l,duration:d,sequenceNumber:0},o);e=t,r.ttml=t,r.ttmlCodec=t.codec}else{const t=Object.assign({id:a,type:s,timescale:l,duration:d,isTimingTrack:!0,trakOffset:u.offset,trakSize:u.boxSize,sequenceNumber:0,samples:[],fragmentDuration:0},o);"video"===s?(r.video=t,r.videoCodec=t.codec):(r.audio=t,r.audioCodec=t.codec),e=t}r.tracksById[a]=e}}}}}}const u=H.findBoxWithOffset(t,0,["moov","mvex","trex"]);for(let e=0;e<u.length;++e){const i=u[e].data,n=H.readUint32(i,4),p=H.readUint32(i,16);r.tracksById[n]&&(r.tracksById[n].defaultSampleSize=p)}return r}static parseStsd(t,i){let r,n;const a=t.subarray(8);let s=H.bin2str(a.subarray(4,8)),e=null,o=null;"enca"===s?(e=H.findFirstBox(a,["enca"]))&&(o=e.subarray(28)):"encv"===s&&(e=H.findFirstBox(a,["encv"]))&&(o=e.subarray(78));t=!!o;if(r=0,o){const t=H.findBox(o,["sinf"]);for(let e=0;e<t.length;++e){const n=t[e],a=H.findFirstBox(n,["schm"]);if(a){const t=H.bin2str(a.subarray(4,8));if("cbcs"===t||"cenc"===t){const t=H.findFirstBox(n,["frma"]),i=(t&&(s=H.bin2str(t)),H.findFirstBox(n,["schi","tenc"]));i&&(r=i[7])}}}}let l;var d=a.subarray(86);switch(s){case"mp4a":n="mp4a.40.5";break;case"ac-3":case"ec-3":case"alac":case"fLaC":case"c608":default:n=s;break;case"avc1":case"avc3":n=s+".640028";break;case"hvc1":case"hev1":{const t=H.findFirstBox(d,["hvcC"]);l=Pt.parseHvcC(t,i),n=l?Pt.hvcCToCodecString(s,l):s+".2.4.H150.B0";break}case"dvh1":case"dvhe":{const t=H.findFirstBox(d,["dvcC"]);l=Pt.parseDvcC(t,i),n=l?Pt.dvcCToCodecString(s,l):s+".05.01";break}case"vp09":{const t=H.findFirstBox(d,["vpcC"]);l=Pt.parseVpcC(t,i),n=l?Pt.vpcCToCodecString(s,l):s;break}case"av01":{const t=H.findFirstBox(d,["av1C"]);l=Pt.parseAv1C(t,i),n=l?Pt.av1CToCodecString(s,l):s;break}}return{codec:n,encrypted:t,defaultPerSampleIVSize:r}}static has32BitTfdts(e){var t=H.findBox(e,["moof","traf","tfdt"]);let i=!1;for(let e=0;e<t.length;++e)if(0===t[e][0]){i=!0;break}return i}static getStartDtsTs(t,i,r){const n=H.findBox(i,["moof","traf"]);let a,s=Number.MAX_SAFE_INTEGER;for(let e=0;e<n.length;++e){const r=n[e],d=H.findBox(r,["tfhd"]);for(let e=0;e<d.length;++e){const n=d[e],u=H.readUint32(n,4),c=t.tracksById[u];var o;if(c&&c.isTimingTrack){o=c.timescale||9e4;let t=1/0;var l=H.findFirstBox(r,["tfdt"]);if(l){let e;const i=l[0];if(e=H.readUint32(l,4),1===i){const i=H.readUint32(l,8);e===Ot&&i>Ot-.5*o&&(t=0),e=e*(Ot+1)+i}t=e}isFinite(t)&&t/o<s&&(s=t/o,a={baseTime:t,timescale:o})}}}return a}static offsetStartDTS(t,i,r,n,a){const s=H.findBox(i,["moof","traf"]);for(let e=0;e<s.length;++e){var o=s[e],l=H.findBox(o,["tfhd"]);for(let e=0;e<l.length;++e){const s=l[e],m=H.readUint32(s,4),f=t.tracksById[m];if(f){var d=f.timescale||9e4,u="caption"===f.type?0:n,c=H.findBox(o,["tfdt"]);for(let e=0;e<c.length;++e){const t=c[0],i=t[0],n=f.type;if(0===i){let e=H.readUint32(t,4)-Math.round(r.baseTime*d/r.timescale);"video"===n&&e<0&&(e=0),e+=Math.round(u*d),e=Math.max(e,0),H.writeUint32(t,4,e)}else{const i=H.readUint32(t,4);i>wt&&a.error(Rt,`baseMediaDecodeTime larger than can be represented by float for upper 32 bits `+i);let e=i;e=(e=(e*=Math.pow(2,32))+H.readUint32(t,8))-Math.round(r.baseTime*d/r.timescale),"video"===n&&e<0&&(e=0),e+=Math.round(u*d),e=Math.max(e,0);var h=Math.floor(e/(Ot+1)),p=Math.floor(e%(Ot+1));H.writeUint32(t,4,h),H.writeUint32(t,8,p)}}}}}}static writeStartDTS(t,i,r,n){const a=H.findBox(i,["moof","traf"]);for(let e=0;e<a.length;++e){const n=a[e],u=H.findBox(n,["tfhd"]);for(let e=0;e<u.length;++e){const a=u[e],c=H.readUint32(a,4),h=t.tracksById[c];if(h){var s=h.timescale||9e4,o=Math.round(r*s)/s,l=H.findBox(n,["tfdt"]);for(let e=0;e<l.length;++e){const i=l[e];if(0===i[0])H.writeUint32(i,4,o*s);else{var d=o*s,d=Math.max(d,0);const r=Math.floor(d/(Ot+1)),n=Math.floor(d%(Ot+1));H.writeUint32(i,4,r),H.writeUint32(i,8,n)}}}}}}static parseSAIO(e,t){let i=0,r=0;var n=e[0];let a;r+=4,0!=(1&H.readUint32(e,0))&&(a={auxInfoType:H.readUint32(e,r),auxInfoParameter:H.readUint32(e,r+4)},r+=8);var s=16777215&H.readUint32(e,r);return 1==s?(r+=4,i=H.readUint32(e,r),1===n&&(r+=4,i=(i*=Math.pow(2,32))+H.readUint32(e,r))):null!=t&&t.error(Rt,`saio entry count error, count is: `+s),{auxInfoFormat:a,firstSubsampleOffset:i}}static parseSAIZ(t,i=1){var r=[];let e,n=0;n+=4,0!=(1&H.readUint32(t,0))&&(e={auxInfoType:H.readUint32(t,n),auxInfoParameter:H.readUint32(t,n+4)},n+=8);var a=t[n],s=(n++,H.readUint32(t,n));if(n+=4,0===a)for(let e=0;e<i&&e<s;++e)r.push(t[n++]);return{auxInfoFormat:e,defaultSampleInfoSize:a,sampleSizes:r,firstSampleInfoSize:r.length?r[0]:a}}static parseSubsample(e,t){var i={subsamples:[]};let r=0;for(e&&(i.iv=t.subarray(0,e),r+=e),r+=2;r+6<=t.byteLength;){const e=H.readUint16(t,r);r+=2;var n=H.readUint32(t,r);r+=4,i.subsamples.push([e,n])}return i}static isSEIMessage(e,t){return e?39===t||40===t:6===t}static parseCLCPSample(e,t,i,r){let n=0;var a=[];let s=0;for(;n<i;){var o=t+n;const r=H.readUint32(e,o);o+=4;var l=H.bin2str(e.subarray(o,o+4));if(o+=4,"cdat"!==l)break;{const t=r-8,d=e.subarray(o,o+t);s+=t,a.push(d),n+=r}}return{cdatList:a,cdatTotalSize:s}}static parseSamples(u,c,h,p,m,f,g){const y=h.timescale,v=h.id;let I,S=u,b=0,T=!1,A=0;const E=H.findBoxWithOffset(c,0,["moof"]);for(let e=0;e<E.length;++e){var t=E[e],i=t.data,r=t.offset,n=H.findBox(i,["traf"]);for(let e=0;e<n.length;++e){const E=n[e];let t;var a=H.findFirstBox(E,["tfdt"]);if(a){let e;const c=a[0];e=H.readUint32(a,4),1===c&&(e=(e*=Math.pow(2,32))+H.readUint32(a,8)),t=e/y}void 0!==t&&(S=t);var s=H.findBox(E,["tfhd"]);for(let t=0;t<s.length;++t){var O=s[t],w=H.readUint32(O,4),R=16777215&H.readUint32(O,0),M=0!=(1&R);let o=0;var P=0!=(2&R),C=0!=(8&R);let l=0;var k=0!=(16&R);let d=0;var L=0!=(32&R),R=!M&&0!=(131072&R);let e=8;if(fe(h.defaultSampleSize)&&(d=h.defaultSampleSize),w===v){if(M?(o=H.readUint32(O,e),e+=4,o=(o*=Math.pow(2,32))+H.readUint32(O,e),e+=4):R&&(o=r),P&&(H.readUint32(O,e),e+=4),C&&(l=H.readUint32(O,e),e+=4),k&&(d=H.readUint32(O,e),e+=4),L&&(H.readUint32(O,e),e+=4),"video"===h.type){let e=0,t=0;const m=H.findFirstBox(E,["saio"]),f=(m&&(e=Pt.parseSAIO(m,g).firstSubsampleOffset),H.findFirstBox(E,["saiz"]));f&&(t=Pt.parseSAIZ(f).firstSampleInfoSize),e&&t&&(I=Pt.parseSubsample(h.defaultPerSampleIVSize,c.subarray(o+e,o+e+t))),T=Pt.isHEVCFlavor(h.codec)}var D=H.findBox(E,["trun"]);for(let s=0;s<D.length;++s){const v=D[s],E=v[0],U=16777215&H.readUint32(v,0),_=0!=(1&U);let e=0;var x=0!=(4&U),N=0!=(256&U);let t=0;var F=0!=(512&U);let i=0;var B=0!=(1024&U),V=0!=(2048&U);let r=0;var Q=H.readUint32(v,4);let n=8,a=(_&&(e=H.readSint32(v,n),n+=4),x&&(n+=4),e+o);for(let e=0;e<Q&&(f<0||b<f);e++){if(N?(t=H.readUint32(v,n),n+=4):t=l,F?(i=H.readUint32(v,n),n+=4):i=d,i>A&&(A=i),B&&(n+=4),V&&(r=0===E?H.readUint32(v,n):H.readSint32(v,n),n+=4),"video"===h.type){if(fe(p))h.samples.push({data:c.subarray(a,a+i),size:i,duration:p*y,cts:0,flags:{isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:2,isNonSync:0,paddingValue:0},subsamples:I?I.subsamples:[],iv:I?I.iv:void 0});else if(h.fragmentDuration+=t,m){let e=0;for(;e<i;){const p=H.readUint32(c,a),m=31&c[a+=4];if(h.seiSamples||(h.seiSamples=[]),Pt.isSEIMessage(T,m)){const u=c.subarray(a,a+p);h.seiSamples.push({pts:S+r/y,type:m,data:u,sampleOffset:a,naluSize:p})}a+=p,e+=p+4}}}else if("audio"===h.type)h.fragmentDuration+=t;else if("caption"===h.type){const{cdatList:u,cdatTotalSize:p}=Pt.parseCLCPSample(c,a,i,g);if(a+=i,u.length){let t=new Uint8Array;if(1===u.length)t=new Uint8Array(u[0]);else if(1<u.length){let e=0;t=new Uint8Array(p);for(const p of u)t.set(p,e),e+=p.length}h.captionSamples.push({type:3,pts:S,bytes:t})}}b++,S+=t/y}}}}}}return A}static parseEmsg(e,t){let i,r,n,a,s,o="",l="",d=0;if(0===e[0]){for(;"\0"!==H.bin2str(e.subarray(d,d+1));)o+=H.bin2str(e.subarray(d,d+1)),d+=1;for(o+=H.bin2str(e.subarray(d,d+1)),d+=1;"\0"!==H.bin2str(e.subarray(d,d+1));)l+=H.bin2str(e.subarray(d,d+1)),d+=1;l+=H.bin2str(e.subarray(d,d+1)),d+=1,i=H.readUint32(e,12),r=H.readUint32(e,16),a=H.readUint32(e,20),s=H.readUint32(e,24),d=28}else{d+=4,i=H.readUint32(e,d),d+=4;const t=H.readUint32(e,d),r=(d+=4,H.readUint32(e,d));for(d+=4,n=Math.pow(2,32)*t+r,Number.isSafeInteger(n)||(n=Number.MAX_SAFE_INTEGER),a=H.readUint32(e,d),d+=4,s=H.readUint32(e,d),d+=4;"\0"!==H.bin2str(e.subarray(d,d+1));)o+=H.bin2str(e.subarray(d,d+1)),d+=1;for(o+=H.bin2str(e.subarray(d,d+1)),d+=1;"\0"!==H.bin2str(e.subarray(d,d+1));)l+=H.bin2str(e.subarray(d,d+1)),d+=1;l+=H.bin2str(e.subarray(d,d+1)),d+=1}return{schemeIdUri:o,value:l,timeScale:i,presentationTime:n,presentationTimeDelta:r,eventDuration:a,id:s,payload:e.subarray(d,e.byteLength)}}static extractID3PayloadCreateID3Track(e,t,i,r){const n=new Be(e.payload,r),a=new Uint8Array(e.payload),s=a.byteLength;let o=0,l=0,d=NaN;if(fe(e.presentationTime)?d=e.presentationTime/e.timeScale:fe(e.presentationTimeDelta)&&(d=t+e.presentationTimeDelta/e.timeScale),fe(d)){const c=e.eventDuration,h=a.subarray(0,10),p=H.bin2str(h.subarray(l,l+3));l+=3,"ID3"!==p&&r.error(Rt,"No ID3 tag found when extracting ID3 payload"),l+=2;var t=a.subarray(l,l+1),e=64&t[0],u=16&t[0];if(l+=1,Be.readSynchSafeUint32(a.subarray(l,l+4)),l+=4,e){const e=Be.readSynchSafeUint32(a.subarray(l,l+4));l=l+4+e}for(;l+2<s;){H.bin2str(a.subarray(l,l+4)),l+=4;const t=Be.readSynchSafeUint32(a.subarray(l,l+4)),s=(l+=4,d+o*c),h={data:a,pts:s,dts:s,keyTagInfo:void 0,frames:n.frames};i.id3Samples.push(h),l+=t,o++,u&&("DI3"!==H.bin2str(a.subarray(l,l+3))&&r.error(Rt,"End should be DI3 if footer present in extracting ID3 payload"),l=l+3+7)}l+2===s&&H.readUint16(a,l)}else r.error(Rt,"No pts found in emsg info when extracting ID3 payload")}append(e,t,i,r,n,a,s){let o=this.Rt,l=0,d=0,u=!1,c=!1,h=0;if(void 0===o&&(this.resetInitSegment(e,0),o=this.Rt),o){var p=this.Pt,m=Pt.getStartDtsTs(o,e,this.logger),p=(p||(this.Pt=p=m?{baseTime:m.baseTime-Math.round(t*m.timescale),timescale:m.timescale}:{baseTime:NaN,timescale:NaN},this.observer.trigger(E.INIT_PTS_FOUND,{initPTS:p})),o.foundLargeTimescale&&Pt.has32BitTfdts(e)&&!s&&(e=Et.remuxOverflowSegment(e,this.logger)),H.findBox(e,["emsg"]));if((null!=(f=o.video)&&f.encrypted||this.config.remuxSampleAuxiliaryInfo&&null!=(f=o.audio)&&f.encrypted)&&(this.config.remuxSampleAuxiliaryInfo?Et.remuxSampleAuxiliaryInfo(e,this.logger):H.findBox(e,["moof","traf"]).some(function(e){return H.containsBox(e,["senc"])||H.containsBox(e,["saiz"])&&H.containsBox(e,["saio"])})),s){const t=this._t.timescale,i=(s=Math.ceil(s*t)/t,m?this.At+C(m):NaN);if(this._t&&this.xt&&!this.Mt){const e=vt.getTrack(this.observer,this.xt.id,this.xt.codec,2,this.logger);if(!e)throw`unable to create silent audio track for codec `+this.xt.codec;this.Mt=Object.assign(Object.assign({},e),{sequenceNumber:0});const t=y.initSegment([this._t,this.Mt]),i=(this.Dt={type:"audiovideo",container:"video/mp4",codec:this.Mt.config.codec+","+this._t.codec,initSegment:t},{track:this.Dt});this.observer.trigger(E.FRAG_PARSING_INIT_SEGMENT,i)}Pt.parseSamples(i,e,this._t,s,!1,1,this.logger),this.Dt&&this.Nt.remuxIFrame(i,this._t,this.Mt,s,this.Dt),this._t.samples=[]}else{var f=m?C(m)-this.At:NaN,f=Math.max(0,f);if(p&&0<p.length){const e=p.map(e=>{e=Pt.parseEmsg(e,this.logger);return!this.Lt&&Mt.test(e.schemeIdUri)&&(this.Lt={id3Samples:[],inputTimescale:9e4}),e}),i=this.Lt;if(i)for(const r of e)Pt.extractID3PayloadCreateID3Track(r,t,i,this.logger)}(this._t&&(h=Pt.parseSamples(f,e,this._t,void 0,this.Et,-1,this.logger),l=this._t.fragmentDuration/this._t.timescale,u=!0,this._t.fragmentDuration=0,this.Ct)&&(this.Et?(Pt.extractSEICaptionsFromNALu(this._t.seiSamples,this.Ct),this._t.seiSamples=[]):Pt.parseSamples(f,e,this.Ct,void 0,!1,Number.MAX_SAFE_INTEGER,this.logger)),this.xt&&(Pt.parseSamples(f,e,this.xt,void 0,!1,-1,this.logger),d=this.xt.fragmentDuration/this.xt.timescale,c=!0,this.xt.fragmentDuration=0),this.Dt)?(this.Nt.remuxEmsgAndRawData(d,c,l,u,h,this.Ct,this.Lt,f,null!=(s=null==m?void 0:m.timescale)?s:NaN,e,this.Dt),this.Lt&&(this.Lt.id3Samples=[])):this.logger.error("missing remuxedInitDataTrack")}}else this.logger.error("mp4-demuxer > append > missing initData")}static extractSEICaptionsFromNALu(s,o){if(s){for(let a=0;a<s.length;++a){var l=s[a],d=l.pts;let t=0,e=(t++,0),i=0,r=!1,n=0;for(;!r&&t<l.data.length;){for(e=0;!(t>=l.data.length)&&(n=l.data[t++],e+=n,255===n););for(i=0;!(t>=l.data.length)&&(n=l.data[t++],i+=n,255===n););const s=l.data.length-t;if(4===e&&t<l.data.length){if(r=!0,181===l.data[t++]){const s=H.readUint16(l.data,t);if(t+=2,49===s){const s=H.readUint32(l.data,t);if(t+=4,1195456820===s&&3===l.data[t++]){const s=l.data[t++];t++;var u=31&s,c=[];if(64&s)for(let e=0;e<u;e++){const s=l.data[t++];if(s===(252&s)){const o=3&s;if(0==o||1==o){const s=l.data[t++],o=l.data[t++];c.push(s),c.push(o)}}else t+=2}0<c.length&&o.captionSamples.push({type:3,pts:d,bytes:c})}}}}else if(i<s)t+=i;else if(i>s)break}}return o}}}const Ct={name:"ExpGolomb"};class kt{constructor(e,t){this.Ft=e,this.R=t,this.Bt=e.byteLength,this.Ut=0,this.$t=0}get bytesAvailable(){return this.Bt}loadWord(){var e=this.Ft,t=this.Bt,i=e.byteLength-t,r=new Uint8Array(4),t=Math.min(4,t);if(0===t)throw new me(!1,pe.ExpGolombNoAvailableBytes);r.set(e.subarray(i,i+t)),this.Ut=new DataView(r.buffer).getUint32(0),this.$t=8*t,this.Bt-=t}skipBits(e){var t;this.$t>e||(t=(e-=this.$t)>>3,e-=t>>3,this.Bt-=t,this.loadWord()),this.Ut<<=e,this.$t-=e}readBits(e){var t=Math.min(this.$t,e),i=this.Ut>>>32-t;return 32<e&&this.R.error(Ct,"Cannot read more than 32 bits at a time"),this.$t-=t,0<this.$t?this.Ut<<=t:0<this.Bt&&this.loadWord(),0<(t=e-t)&&this.$t?i<<t|this.readBits(t):i}skipLZ(){let e;for(e=0;e<this.$t;++e)if(0!=(this.Ut&2147483648>>>e))return this.Ut<<=e,this.$t-=e,e;return this.loadWord(),e+this.skipLZ()}skipUEG(){this.skipBits(1+this.skipLZ())}skipEG(){this.skipBits(1+this.skipLZ())}readUEG(){var e=this.skipLZ();return this.readBits(e+1)-1}readEG(){var e=this.readUEG();return 1&e?1+e>>>1:-1*(e>>>1)}readBoolean(){return 1===this.readBits(1)}readUByte(){return this.readBits(8)}readUShort(){return this.readBits(16)}readUInt(){return this.readBits(32)}skipScalingList(e){let t,i,r=8,n=8;for(t=0;t<e;t++)0!==n&&(i=this.readEG(),n=(r+i+256)%256),r=0===n?r:n}readSPS(){let e,t,i,r=0,n=0,a=0,s=0;var o=this.readUByte.bind(this),l=this.readBits.bind(this),d=this.readUEG.bind(this),u=this.readBoolean.bind(this),c=this.skipBits.bind(this),h=this.skipEG.bind(this),p=this.skipUEG.bind(this),m=this.skipScalingList.bind(this),f=(o(),o());if(l(5),c(3),o(),p(),100===f||110===f||122===f||244===f||44===f||83===f||86===f||118===f||128===f){const e=d();if(3===e&&c(1),p(),p(),c(1),u())for(t=3!==e?8:12,i=0;i<t;i++)u()&&m(i<6?16:64)}p();f=d();if(0===f)d();else if(1===f)for(c(1),h(),h(),e=d(),i=0;i<e;i++)h();p(),c(1);f=d(),p=d(),l=l(1);0===l&&c(1),c(1),u()&&(r=d(),n=d(),a=d(),s=d());let g=[1,1];if(u()&&u())switch(o()){case 1:g=[1,1];break;case 2:g=[12,11];break;case 3:g=[10,11];break;case 4:g=[16,11];break;case 5:g=[40,33];break;case 6:g=[24,11];break;case 7:g=[20,11];break;case 8:g=[32,11];break;case 9:g=[80,33];break;case 10:g=[18,11];break;case 11:g=[15,11];break;case 12:g=[64,33];break;case 13:g=[160,99];break;case 14:g=[4,3];break;case 15:g=[3,2];break;case 16:g=[2,1];break;case 255:g=[o()<<8|o(),o()<<8|o()]}return{width:Math.ceil(16*(f+1)-2*r-2*n),height:(2-l)*(p+1)*16-(l?2:4)*(a+s),pixelRatio:g}}readSliceType(){return this.readUByte(),this.readUEG(),this.readUEG()}}const Lt=9e4;class Dt extends ue{constructor(e,t,i,r,n){super(e,t,i,r,n),this.Vt=!1,this.qt=!1,this.zt=!1}static probe(e,t){return 376<=e.length&&71===e[0]&&71===e[188]}resetInitSegment(e,t,i){this.Vt=!1,this.Ht=-1;var i={id:-1,inputTimescale:Lt,timescale:NaN,duration:0,encrypted:null!=i&&i.isEncrypted,keyTagInfo:i},r={len:0,sequenceNumber:0};this.Qt={info:Object.assign({},i),parsingData:Object.assign(Object.assign({},r),{esSamples:new Array,dropped:0}),config:{},container:"video/mp2t",type:"video"},this.Kt={info:Object.assign({},i),parsingData:Object.assign(Object.assign({},r),{esSamples:new Array}),container:"video/mp2t",type:"audio"},this.Lt={id:-1,inputTimescale:Lt,id3Samples:[]},this.Wt={inputTimescale:Lt,captionSamples:[]},this.Gt=t,e&&0!==e.length&&Dt.probe(e,this.logger)?this.Xt=e:this.Xt=void 0}append(e,t,i,r,n,a,s){this.zt=i,this.qt=void 0!==s,!i&&this.Kt&&(this.Kt.audioLastPTS=void 0,this.Kt.audioOverFlow=void 0,this.Kt.overflowMissingBytes=void 0);var o=this.Xt;o&&(this.Yt(o,n),this.Xt=void 0),this.Yt(e,n),this.Jt(t,i,r,n,a,s)}Yt(e,t){var i=this.Qt,r=this.Kt,n=this.Lt;let a,s,o,l,d,u=this.Vt,c=i.info.id,h=r.info.id,p=n.id,m=this.Ht,f=i.pesData,g=r.pesData,y=n.pesData,v=!1,I=e.length;for(I-=I%188,a=0;a<I;a+=188){if(71!==e[a]){const e=new O(!1,pe.NoTSSyncByteFound);return void this.observer.trigger(L.INTERNAL_ERROR,e)}if(s=!!(64&e[a+1]),o=((31&e[a+1])<<8)+e[a+2],1<(48&e[a+3])>>4){if((l=a+5+e[a+4])===a+188)continue}else l=a+4;switch(o){case c:s&&(f&&(d=this._parsePES(f))&&this._parseAVCPES(d,!1),f={data:[],size:0,keyTagInfo:t}),f&&(f.data.push(e.subarray(l,a+188)),f.size+=a+188-l);break;case h:if(s&&!this.qt){if(g&&(d=this._parsePES(g)))switch(r.segmentCodec){case"aac":this._parseAACPES(d);break;case"mp3":this._parseMPEGPES(d);break;case"ac3":case"ec3":this._parseDolbyPES(d)}g={data:[],size:0,keyTagInfo:t}}g&&(g.data.push(e.subarray(l,a+188)),g.size+=a+188-l);break;case p:s&&(y&&(d=this._parsePES(y))&&n.id3Samples.push(d),y={data:[],size:0}),y&&(y.data.push(e.subarray(l,a+188)),y.size+=a+188-l);break;case 0:s&&(l+=e[l]+1),m=this.Ht=this._parsePAT(e,l);break;case m:s&&(l+=e[l]+1);const o=this._parsePMT(e,l,this.typeSupported);0<(c=o.avcId)&&(i.info.id=c,i.info.encrypted=o.videoEncrypted),0<(h=o.audioId)&&(r.info.id=h,r.segmentCodec=o.audioSegmentCodec,r.info.encrypted=o.audioEncrypted),0<(p=o.id3Id)&&(n.id=p),v&&!u&&(v=!1,a=-188),u=this.Vt=!0;break;case 17:case 8191:break;default:v=!0}}if(f&&(d=this._parsePES(f))?(this._parseAVCPES(d,!0),i.pesData=void 0):i.pesData=f,g&&(d=this._parsePES(g))){switch(r.segmentCodec){case"aac":this._parseAACPES(d);break;case"mp3":this._parseMPEGPES(d);break;case"ac3":case"ec3":this._parseDolbyPES(d)}r.pesData=void 0}else r.pesData=g;y&&(d=this._parsePES(y))?(n.id3Samples.push(d),n.pesData=void 0):n.pesData=y}Jt(e,t,i,r,n,a){var s=this.Qt,o=this.Kt,l=this.Lt;let d,u;o.config&&o.segmentCodec&&(d={type:"audio",info:o.info,config:o.config,parsingData:o.parsingData});var c,o=s.config;"string"==typeof(c=o).codec&&Array.isArray(c.sps)&&Array.isArray(c.pps)&&"number"==typeof c.width&&"number"==typeof c.height&&Array.isArray(c.pixelRatio)&&(u={type:"video",info:s.info,config:o,parsingData:s.parsingData}),this.esRemuxer.remuxEsTracks(d,u,l,this.Wt,e,t,i,r,n,a)}destroy(){this.Gt=0}_parsePAT(e,t){return(31&e[t+10])<<8|e[t+11]}_parsePMT(e,t,i){var r,n={audioId:-1,avcId:-1,id3Id:-1,audioEncrypted:!1,videoEncrypted:!1},a=t+3+((15&e[t+1])<<8|e[t+2])-4;for(t+=12+((15&e[t+10])<<8|e[t+11]);t<a;){switch(r=(31&e[t+1])<<8|e[t+2],e[t]){case 207:n.audioEncrypted=!0;case 15:-1===n.audioId&&(n.audioId=r,n.audioSegmentCodec="aac");break;case 21:-1===n.id3Id&&(n.id3Id=r);break;case 219:n.videoEncrypted=!0;case 27:-1===n.avcId&&(n.avcId=r);break;case 3:case 4:!0!==i.mpeg&&!0!==i.mp3||-1===n.audioId&&(n.audioId=r,n.audioSegmentCodec="mp3");break;case 193:n.audioEncrypted=!0;case 129:!0===i.ac3&&-1===n.audioId&&(n.audioId=r,n.audioSegmentCodec="ac3");break;case 194:n.audioEncrypted=!0;case 135:!0===i.ec3&&-1===n.audioId&&(n.audioId=r,n.audioSegmentCodec="ec3")}t+=5+((15&e[t+3])<<8|e[t+4])}return n}_parsePES(e){let i,t,r,n,a,s,o=0;var l=e.data,d=e.keyTagInfo;let u=NaN,c=NaN;if(e&&0!==e.size){for(;l[0].length<19&&1<l.length;){const e=new Uint8Array(l[0].length+l[1].length);e.set(l[0]),e.set(l[1],l[0].length),l[0]=e,l.splice(1,1)}if(1===((i=l[0])[0]<<16)+(i[1]<<8)+i[2]&&!((r=(i[4]<<8)+i[5])&&r>e.size-6)){192&(t=i[7])&&(u=536870912*(14&i[9])+4194304*(255&i[10])+16384*(254&i[11])+128*(255&i[12])+(254&i[13])/2,64&t?(c=536870912*(14&i[14])+4194304*(255&i[15])+16384*(254&i[16])+128*(255&i[17])+(254&i[18])/2,54e5<u-c&&(u=c)):c=u),n=i[8],s=n+9,e.size-=s,a=new Uint8Array(e.size);for(let t=0,e=l.length;t<e;t++){let e=(i=l[t]).byteLength;if(s){if(s>e){s-=e;continue}i=i.subarray(s),e-=s,s=0}a.set(i,o),o+=e}return r&&(r-=n+3),{data:a,pts:u,dts:c,len:r,keyTagInfo:d}}}}pushAccesUnit(e,t){var i,r,n=e.avcSample;n&&n.units.length&&n.frame&&!this.Xt&&(r=(i=e.parsingData.esSamples).length,(!0===n.key||e.config.sps&&(r||this.zt))&&(n.id=r,n.keyTagInfo=t,e.info.encrypted)&&n.units.forEach(e=>{if(48<e.data.byteLength)switch(e.type){case 1:case 5:e.data=this.discardEPB(e.data)}}),r||isFinite(n.pts)?i.push(n):e.parsingData.dropped++)}_parseAVCPES(a,e){if(!a.data)throw"invalid pes data";const s=this.Gt,o=this.Qt,l=this.Wt,t=this._parseAVCNALu(a.data);let d,u,c,h=o.avcSample;const p=a.keyTagInfo;a.data=void 0,t.forEach(n=>{switch(n.type){case 1:if(h&&!this.qt){u=!0,h.frame=!0;const a=n.data;if(4<a.length){const n=new kt(a,this.logger).readSliceType();2!==n&&4!==n&&7!==n&&9!==n||(h.key=!0)}}break;case 5:u=!0,h||(h=this._createAVCSample(!0,a.pts,a.dts,""),o.avcSample=h),h&&(h.key=!0,h.frame=!0);break;case 6:u=!0,(d=new kt(this.discardEPB(n.data),this.logger)).readUByte();let e=0,t=0,i=!1,r=0;for(;!i&&1<d.bytesAvailable;){for(e=0;r=d.readUByte(),e+=r,255===r;);for(t=0;r=d.readUByte(),t+=r,255===r;);if(4===e&&0!==d.bytesAvailable){if(i=!0,181===d.readUByte()&&49===d.readUShort()&&1195456820===d.readUInt()&&3===d.readUByte()){const n=d.readUByte(),s=31&n,o=[n,d.readUByte()];for(c=0;c<s;c++)o.push(d.readUByte()),o.push(d.readUByte()),o.push(d.readUByte());this._insertSampleInOrder(l.captionSamples,{type:3,pts:a.pts,bytes:o})}}else if(t<d.bytesAvailable)for(c=0;c<t;c++)d.readUByte()}break;case 7:if(u=!0,!o.config.sps){const a=(d=new kt(n.data,this.logger)).readSPS(),l=(o.config.width=a.width,o.config.height=a.height,o.config.pixelRatio=a.pixelRatio,o.config.sps=[n.data],o.info.duration=s,n.data.subarray(1,4));let t="avc1.";for(c=0;c<3;c++){let e=l[c].toString(16);e.length<2&&(e="0"+e),t+=e}o.config.codec=t}break;case 8:u=!0,o.config.pps||(o.config.pps=[n.data]);break;case 9:u=!0,h&&this.pushAccesUnit(o,p),h=this._createAVCSample(!1,a.pts,a.dts,""),o.avcSample=h;break;case 12:u=!0;break;default:u=!1}h&&u&&h.units.push(n)}),e&&h&&(this.pushAccesUnit(o,p),o.avcSample=void 0)}_createAVCSample(e,t,i,r){return{id:NaN,key:e,pts:t,dts:i,units:new Array,debug:r}}_insertSampleInOrder(t,i){var r=t.length;if(0<r){if(i.pts>=t[r-1].pts)t.push(i);else for(let e=r-1;0<=e;e--)if(i.pts<t[e].pts){t.splice(e,0,i);break}}else t.push(i)}_getLastNalUnit(){const e=this.Qt;let t,i=e.avcSample;if(!i||0===i.units.length){const t=e.parsingData.esSamples;i=t[t.length-1]}if(i){const e=i.units;t=e[e.length-1]}return t}_parseAVCNALu(e){const t=e.byteLength;let i,r,n=0;var a=this.Qt;let s=a.naluState||0;var o=s,l=[];let d,u,c,h=-1;for(-1===s&&(h=0,c=31&e[0],s=0,n=1);n<t;)if(i=e[n++],s)if(1!==s)if(i)if(1===i){if(0<=h)d={data:e.subarray(h,n-s-1),type:c},l.push(d);else{const t=this._getLastNalUnit();if(t&&(o&&n<=4-o&&t.state&&(t.data=t.data.subarray(0,t.data.byteLength-o)),0<(r=n-s-1))){const i=new Uint8Array(t.data.byteLength+r);i.set(t.data,0),i.set(e.subarray(0,r),t.data.byteLength),t.data=i,t.state=0}}s=n<t?(u=31&e[n],h=n,c=u,0):-1}else s=0;else s=3;else s=i?0:2;else s=i?0:1;if(0<=h&&0<=s&&(d={data:e.subarray(h,t),type:c,state:s},l.push(d)),0===l.length){const t=this._getLastNalUnit();if(t){const i=new Uint8Array(t.data.byteLength+e.byteLength);i.set(t.data,0),i.set(e,t.data.byteLength),t.data=i}}return a.naluState=s,l}discardEPB(e){var t=e.byteLength,i=[];let r=1;for(;r<t-2;)0===e[r]&&0===e[r+1]&&3===e[r+2]?(i.push(r+2),r+=2):r++;if(0===i.length)return e;var n=t-i.length,a=new Uint8Array(n);let s=0;for(r=0;r<n;s++,r++)s===i[0]&&(s++,i.shift()),a[r]=e[s];return a}_parseAACPES(i){const r=this.Kt,{audioLastPTS:n,audioOverFlow:a,parsingData:{esSamples:s}}=r,o=i.keyTagInfo;let l,d,u=i.data,c=0;if(a){const i=r.overflowMissingBytes||0,l=(r.audioOverFlow=void 0,r.overflowMissingBytes=-1,a.byteLength);if(i<=0){const i=new Uint8Array(l+u.byteLength);i.set(a,0),i.set(u,l),u=i}else if(void 0!==n){const r=l-i,d=(a.set(u.subarray(0,i),r),{unit:a,pts:n,dts:n,keyTagInfo:o});s.push(d),c=i}}for(l=c,d=u.length;l<d-1&&(255!==u[l]||240!=(246&u[l+1]));l++);if(l!==c){let e,t;const n=l<d-1;if(t=n?(e=`AAC PES did not start with ADTS header,offset:`+l,pe.PESDidNotStartWithADTS):(e="No ADTS header found in AAC PES",pe.NoADTSHeaderInPES),!n){const a=new O(!n,t,e);return void this.observer.trigger(L.INTERNAL_ERROR,a)}}if(!r.config){const i=le(this.observer,u,l,void 0,this.logger);if(!i)throw"unable to parse adts header";r.config=i}var h=9216e4/r.config.samplerate;let p;if(isFinite(i.pts))p=i.pts;else{if(!a||void 0===n||!s.length)return;p=n+h}i=void 0!==n&&s.length?p-(n+h):0;void 0!==n&&1<Math.abs(i)&&(p=n+h);let m=n,f=0;for(;l<d;){let e;const n=1&u[l+1]?7:9;let t;if(l+n<=d){const i=(3&u[l+3])<<11|u[l+4]<<3|(224&u[l+5])>>>5;t=Math.max(0,i-n)}if(!n||!t){(e=new Uint8Array(d-l)).set(u.subarray(l,d),0),r.audioOverFlow=e;break}{m=p+f*h;const pe=t+n,c=Math.max(0,l+pe-d);if(r.overflowMissingBytes=c){(e=new Uint8Array(pe-n)).set(u.subarray(l+n,u.length),0),r.audioOverFlow=e;break}{const c={unit:e=u.subarray(l+n,l+pe),pts:m,dts:m,keyTagInfo:o};for(s.push(c),r.parsingData.len+=t,f++,l+=pe;l<d-1&&(255!==u[l]||240!=(246&u[l+1]));l++);}}}r.audioLastPTS=m}_parseMPEGPES(e){var t;"mp3"===(null==(t=this.Kt)?void 0:t.segmentCodec)&&Je.parse(this.Kt.parsingData,e.data,0,e.pts,this.logger)}_parseDolbyPES(e){var t,i=this.Kt,r=this.Gt;let n=e.data,a=e.pts;var s=e.keyTagInfo;let o=0,l=0,d=i.audioOverFlow;var u=i.audioLastPTS;if(!i.config){let e;if("ac3"===i.segmentCodec?e=He(this.observer,n,l,this.logger):"ec3"===i.segmentCodec&&(e=Ge.getAudioConfig(this.observer,n,l,this.logger)),!e)throw"unable to parse dolby header";i.config=e}if("ac3"!==i.config.segmentCodec&&"ec3"!==i.config.segmentCodec)throw"unexpected config type";var c=1536/i.config.samplerate*i.info.inputTimescale;if(d){const e=new Uint8Array(d.byteLength+n.byteLength);e.set(d,0),e.set(n,d.byteLength),n=e}var h=n.length;if(d&&u){const e=u+c;1<Math.abs(e-a)&&(a=e)}let p=0;for(;l+p<=h;){if(11!==n[l]||119!==n[l+1]){const e=new O(!0,pe.InvalidDolbyAudioMagic);return void this.observer.trigger(L.INTERNAL_ERROR,e)}"ac3"===i.segmentCodec?p=null!=(t=qe(this.observer,n,l))?t:NaN:"ec3"===i.segmentCodec&&(p=null!=(t=Ge.getFrameLength(this.observer,n,l,this.logger))?t:NaN);const e=a+o*c,d=(i.audioLastPTS=e,{unit:n.subarray(l,l+p),pts:e,dts:e,keyTagInfo:s});i.parsingData.esSamples.push(d),i.info.duration=r,i.parsingData.len+=p,l+=p,o++}d=l<h?n.subarray(l,h):void 0,i.audioOverFlow=d}}var xt,Nt=Dt;class Ft extends h{constructor(e,t,i,r){super(),this.vt=e,this.Zt=t,this.re=i,this.R=r}destroy(){this.removeAllListeners();var e=this.oe,t=this.le;e&&e.destroy(),t&&t.destroy()}push(i,r,n,a,s,o,l,d,u,c,h,p,m){if(i){let e=this.oe,t=this.le;var f=i;if(!e||!t||(s||o)&&(null==(i=this.ue)||!i.call(this,f,this.R))){const{vt:i,Zt:r}=this,n=[{demux:Pt,remux:Et},{demux:Nt,remux:St},{demux:We,remux:St},{demux:$e,remux:St},{demux:_e,remux:St},{demux:Ze,remux:St}];for(const a of n){const n=a.demux["probe"];if(n(f,this.R)){t=new a.remux(this,r,i,this.re,this.R,m),e=new a.demux(this,t,r,i,this.R),this.ue=n;break}}if(!e||!t){const i=new O(!0,pe.DemuxerNotFound);return void this.trigger(L.INTERNAL_ERROR,i)}this.le=t,this.oe=e}i=!this.fe||r&&this.fe.method!==r.method||r&&"NONE"!==r.method&&(this.fe.uri!==r.uri||this.fe.iv!==r.iv);if(this.fe=r,s||o||i){const i=n?new Uint8Array(n):void 0;e.resetInitSegment(i,d,r,s),t.resetInitSegment()}if(s){const i=c?C(c):void 0;e.resetTimeStamp(i),t.resetTimeStamp(i)}e.append(f,a,l,u,r,h,p)}}}function Bt(){let e=Date.now()+`-`+Math.random();return"undefined"!=typeof performance&&"function"==typeof performance.now&&(e+=`-`+performance.now()),e}class Ut{constructor(e,t){this.N=e,this.R=t,this.init=(t,n,a)=>e=>{const i=Bt(),r=this.pe[i]=new Ft(t,n,a,this.R);[E.INIT_PTS_FOUND,E.FRAG_PARSING_INIT_SEGMENT,E.FRAG_PARSING_DATA,E.FRAG_PARSED,L.INTERNAL_ERROR].forEach(t=>{r.on(t,e=>this.N.invoke("demuxer.event",[i,t,e])(()=>{}))}),e(i)},this.push=(i,r,n,a,s,o,l,d,u,c,h,p,m,f)=>e=>{var t=this.pe[i];t?(t.push(r,n,a,s,o,l,d,u,c,h,p,m,f),e()):e(void 0,`Demuxer with id "${i}" does not exist on push`)},this.destroy=i=>e=>{var t=this.pe[i];t?(t.destroy(),delete this.pe[i],e()):this.R.error(`Demuxer with id "${i}" does not exist on destroy`)},this.pe={},e.register("demuxer.init",this.init),e.register("demuxer.push",this.push),e.register("demuxer.destroy",this.destroy)}}class _t{constructor(e){this.me=e,this.handlers={},this.deferers={},this._messageHandler=e=>{var{type:e,id:t,command:i,args:r,result:n,error:a}=e.data;if(e===xt.Invoke)try{if(null==this.handlers[i])throw new me(!1,pe.RPCWorkerCommandNotFound,`command ${i} not found`);null!=r&&this.handlers[i](...r)(this.ge.bind(this,t,i))}catch(a){this.ge(t,i,null,new me(!1,pe.RPCWorkerCommandNotFound,`command ${i} not found`))}else e===xt.Result&&null!=this.deferers[t]&&(this.deferers[t](n,a),delete this.deferers[t])},e.addEventListener("message",this._messageHandler)}register(e,t){return null==this.handlers[e]&&(this.handlers[e]=t,!0)}unregister(e){return null==this.handlers[e]&&(delete this.handlers[e],!0)}invoke(i,r,n){return(e=_t._fallbackCallback)=>{var t=Bt(),e=(this.deferers[t]=e,{type:xt.Invoke,id:t,command:i,args:r});this.ye(e,n)}}teardown(e){this.me.removeEventListener("message",this._messageHandler),e()}ge(e,t,i,r,n){r instanceof Error&&(r=`[${r.name}] ${r.message}
`+r.stack);e={type:xt.Result,id:e,command:t,result:i,error:r};this.ye(e,n)}ye(e,t=[]){this.me.postMessage(e,t.map(e=>ArrayBuffer.isView(e)?e.buffer:e).filter(e=>void 0!==e))}}_t._fallbackCallback=(e,t)=>{if(null!=t)throw t},(t=xt=xt||{})[t.Invoke=0]="Invoke",t[t.Result=1]="Result",ArrayBuffer.isView||(ArrayBuffer.isView=function(e){return null!==e&&"object"==typeof e&&e.buffer instanceof ArrayBuffer}),void 0!==cv&&cv&&(t=new _t(l),Kn=(n=>{const t=(i=[])=>{const r={};return["fatal","error","warn","info","debug","trace","qe"].forEach(e=>{return r[e]=(t=e,(...e)=>{n.invoke("logger.log",[i,t,...e])((e,t)=>{if(null!=t)throw t})});var t}),r.child=e=>t([...i,e]),r};return t()})(t),new o(t,Kn),new Ut(t,Kn));var Vt={type:null,entityIds:null,skip:!1,payload:null},Qt=!1;function Ht(e,t,i){qt(e,t,i),Qt=!0}function qt(e,t,i){!1===Qt&&(Vt.type=e,Vt.entityIds=t,Vt.payload=i)}function Kt(e,t){return e.hasOwnProperty(t)}function jt(e){return Array.isArray(e)}function $t(e){return e.hasOwnProperty("active")}function Gt(e){return jt(e)}function Wt(e){var t,i,{active:e,ids:r,entities:n}=e;return Gt(e)?(t=r,(i=(r=e).filter(e=>-1<t.indexOf(e))).length===r.length?r:i):!1===Kt(n,e)?null:e}function zt(t,e){var i,r=Object.keys(t);return Object.getOwnPropertySymbols&&(i=Object.getOwnPropertySymbols(t),e&&(i=i.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),r.push.apply(r,i)),r}function S(r){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?zt(Object(n),!0).forEach(function(e){var t,i;t=r,i=n[e=e],e in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(n)):zt(Object(n)).forEach(function(e){Object.defineProperty(r,e,Object.getOwnPropertyDescriptor(n,e))})}return r}function Yt(e){e=function(e){if("object"!=typeof e||null===e)return e;var t=e[Symbol.toPrimitive];if(void 0===t)return String(e);t=t.call(e,"string");if("object"!=typeof t)return t;throw new TypeError("@@toPrimitive must return a primitive value.")}(e);return"symbol"==typeof e?e:String(e)}function Xt(e){return null==e}function Jt(e){return Xt(e)?[]:Array.isArray(e)?e:[e]}function Zt(e,t,i){i=2<arguments.length&&void 0!==i?i:{},t=Jt(t),e=e||[];return i.prepend?[...t,...e]:[...e,...t]}function ei(e){return"function"==typeof e}function ti(t){return e=>{if(ei(null==e?void 0:e.lift))return e.lift(function(e){try{return t(e,this)}catch(e){this.error(e)}});throw new TypeError("Unable to lift unknown Observable type")}}function ii(e,t,i,r){var n,a=arguments.length,s=a<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,r);else for(var o=e.length-1;0<=o;o--)(n=e[o])&&(s=(a<3?n(s):3<a?n(t,i,s):n(t,i))||s);3<a&&s&&Object.defineProperty(t,i,s)}function ri(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}function ni(e,s,o,l){return new(o=o||Promise)(function(i,t){function r(e){try{a(l.next(e))}catch(e){t(e)}}function n(e){try{a(l.throw(e))}catch(e){t(e)}}function a(e){var t;e.done?i(e.value):((t=e.value)instanceof o?t:new o(function(e){e(t)})).then(r,n)}a((l=l.apply(e,s||[])).next())})}function ai(e){return this instanceof ai?(this.v=e,this):new ai(e)}var si=e=>e&&"number"==typeof e.length&&"function"!=typeof e;function oi(e){return ei(null==e?void 0:e.then)}function li(e){e=e(e=>{Error.call(e),e.stack=(new Error).stack});return e.prototype=Object.create(Error.prototype),e.prototype.constructor=e}var di=li(t=>function(e){t(this),this.message=e?"".concat(e.length," errors occurred during unsubscription:\n").concat(e.map((e,t)=>"".concat(t+1,") ").concat(e.toString())).join("\n  ")):"",this.name="UnsubscriptionError",this.errors=e});function ui(e,t){e&&0<=(t=e.indexOf(t))&&e.splice(t,1)}class ci{constructor(e){this.initialTeardown=e,this.closed=!1,this._parentage=null,this._finalizers=null}unsubscribe(){var e;if(!this.closed){this.closed=!0;var t=this["_parentage"];if(t)if(this._parentage=null,Array.isArray(t))for(var i of t)i.remove(this);else t.remove(this);var r=this["initialTeardown"];if(ei(r))try{r()}catch(t){e=t instanceof di?t.errors:[t]}r=this["_finalizers"];if(r)for(var n of(this._finalizers=null,r))try{mi(n)}catch(t){e=null!=e?e:[],t instanceof di?e=[...e,...t.errors]:e.push(t)}if(e)throw new di(e)}}add(e){var t;if(e&&e!==this)if(this.closed)mi(e);else{if(e instanceof ci){if(e.closed||e._hasParent(this))return;e._addParent(this)}(this._finalizers=null!=(t=this._finalizers)?t:[]).push(e)}}_hasParent(e){var t=this["_parentage"];return t===e||Array.isArray(t)&&t.includes(e)}_addParent(e){var t=this["_parentage"];this._parentage=Array.isArray(t)?(t.push(e),t):t?[t,e]:e}_removeParent(e){var t=this["_parentage"];t===e?this._parentage=null:Array.isArray(t)&&ui(t,e)}remove(e){var t=this["_finalizers"];t&&ui(t,e),e instanceof ci&&e._removeParent(this)}}ci.EMPTY=((t=new ci).closed=!0,t);var hi=ci.EMPTY;function pi(e){return e instanceof ci||e&&"closed"in e&&ei(e.remove)&&ei(e.add)&&ei(e.unsubscribe)}function mi(e){ei(e)?e():e.unsubscribe()}var fi={onUnhandledError:null,onStoppedNotification:null,Promise:void 0,useDeprecatedSynchronousErrorHandling:!1,useDeprecatedNextContext:!1},gi={setTimeout(e,t){for(var i=gi["delegate"],r=arguments.length,n=new Array(2<r?r-2:0),a=2;a<r;a++)n[a-2]=arguments[a];return null!=i&&i.setTimeout?i.setTimeout(e,t,...n):setTimeout(e,t,...n)},clearTimeout(e){var t=gi["delegate"];return((null==t?void 0:t.clearTimeout)||clearTimeout)(e)},delegate:void 0};function yi(t){gi.setTimeout(()=>{var e=fi["onUnhandledError"];if(!e)throw t;e(t)})}function vi(){}var Ii=Si("C",void 0,void 0);function Si(e,t,i){return{kind:e,value:t,error:i}}var bi=null;function Ti(e){if(fi.useDeprecatedSynchronousErrorHandling){var t=!bi;if(t&&(bi={errorThrown:!1,error:null}),e(),t){var{errorThrown:t,error:i}=bi;if(bi=null,t)throw i}}else e()}class Ai extends ci{constructor(e){super(),this.isStopped=!1,e?pi(this.destination=e)&&e.add(this):this.destination=Ci}static create(e,t,i){return new Ri(e,t,i)}next(e){this.isStopped?Pi(Si("N",e,void 0),this):this._next(e)}error(e){this.isStopped?Pi(Si("E",void 0,e),this):(this.isStopped=!0,this._error(e))}complete(){this.isStopped?Pi(Ii,this):(this.isStopped=!0,this._complete())}unsubscribe(){this.closed||(this.isStopped=!0,super.unsubscribe(),this.destination=null)}_next(e){this.destination.next(e)}_error(e){try{this.destination.error(e)}finally{this.unsubscribe()}}_complete(){try{this.destination.complete()}finally{this.unsubscribe()}}}var Ei=Function.prototype.bind;function Oi(e,t){return Ei.call(e,t)}class wi{constructor(e){this.partialObserver=e}next(e){var t=this["partialObserver"];if(t.next)try{t.next(e)}catch(e){Mi(e)}}error(e){var t=this["partialObserver"];if(t.error)try{t.error(e)}catch(e){Mi(e)}else Mi(e)}complete(){var e=this["partialObserver"];if(e.complete)try{e.complete()}catch(e){Mi(e)}}}class Ri extends Ai{constructor(e,t,i){super(),i=ei(e)||!e?{next:null!=e?e:void 0,error:null!=t?t:void 0,complete:null!=i?i:void 0}:this&&fi.useDeprecatedNextContext?((t=Object.create(e)).unsubscribe=()=>this.unsubscribe(),{next:e.next&&Oi(e.next,t),error:e.error&&Oi(e.error,t),complete:e.complete&&Oi(e.complete,t)}):e,this.destination=new wi(i)}}function Mi(e){yi(e)}function Pi(e,t){var i=fi["onStoppedNotification"];i&&gi.setTimeout(()=>i(e,t))}var Ci={closed:!0,next:vi,error:function(e){throw e},complete:vi},ki="function"==typeof Symbol&&Symbol.observable||"@@observable";function Li(e){return e}function Di(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];return xi(t)}function xi(t){return 0===t.length?Li:1===t.length?t[0]:function(e){return t.reduce((e,t)=>t(e),e)}}class F{constructor(e){e&&(this._subscribe=e)}lift(e){var t=new F;return t.source=this,t.operator=e,t}subscribe(e,t,i){var r,n=(r=e)&&r instanceof Ai||r&&ei(r.next)&&ei(r.error)&&ei(r.complete)&&pi(r)?e:new Ri(e,t,i);return Ti(()=>{var{operator:e,source:t}=this;n.add(e?e.call(n,t):t?this._subscribe(n):this._trySubscribe(n))}),n}_trySubscribe(t){try{return this._subscribe(t)}catch(e){t.error(e)}}forEach(r,e){return new(e=Ni(e))((e,t)=>{var i=new Ri({next:e=>{try{r(e)}catch(e){t(e),i.unsubscribe()}},error:t,complete:e});this.subscribe(i)})}_subscribe(e){var t;return null==(t=this.source)?void 0:t.subscribe(e)}[ki](){return this}pipe(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];return xi(t)(this)}toPromise(e){return new(e=Ni(e))((e,t)=>{var i;this.subscribe(e=>i=e,e=>t(e),()=>e(i))})}}function Ni(e){return null!=(e=null!=e?e:fi.Promise)?e:Promise}function Fi(e){return ei(e[ki])}function Bi(e){return Symbol.asyncIterator&&ei(null==e?void 0:e[Symbol.asyncIterator])}function Ui(e){return new TypeError("You provided ".concat(null!==e&&"object"==typeof e?"an invalid object":"'".concat(e,"'")," where a stream was expected. You can provide an Observable, Promise, ReadableStream, Array, AsyncIterable, or Iterable."))}F.create=e=>new F(e);var _i="function"==typeof Symbol&&Symbol.iterator?Symbol.iterator:"@@iterator";function Vi(e){return ei(null==e?void 0:e[_i])}function Qi(r){var n,a,e,t=this,i=arguments;if(Symbol.asyncIterator)return n=function*(){var e=r.getReader();try{for(;;){var{value:t,done:i}=yield ai(e.read());if(i)return yield ai(void 0);yield yield ai(t)}}finally{e.releaseLock()}}.apply(t,i||[]),a=[],e={},s("next"),s("throw"),s("return"),e[Symbol.asyncIterator]=function(){return this},e;throw new TypeError("Symbol.asyncIterator is not defined.");function s(r){n[r]&&(e[r]=function(i){return new Promise(function(e,t){1<a.push([r,i,e,t])||o(r,i)})})}function o(e,t){try{(i=n[e](t)).value instanceof ai?Promise.resolve(i.value.v).then(l,d):u(a[0][2],i)}catch(e){u(a[0][3],e)}var i}function l(e){o("next",e)}function d(e){o("throw",e)}function u(e,t){e(t),a.shift(),a.length&&o(a[0][0],a[0][1])}}function Hi(e){return ei(null==e?void 0:e.getReader)}function qi(e){if(e instanceof F)return e;if(null!=e){if(Fi(e))return a=e,new F(e=>{var t=a[ki]();if(ei(t.subscribe))return t.subscribe(e);throw new TypeError("Provided object does not correctly implement Symbol.observable")});if(si(e))return n=e,new F(e=>{for(var t=0;t<n.length&&!e.closed;t++)e.next(n[t]);e.complete()});if(oi(e))return r=e,new F(t=>{r.then(e=>{t.closed||(t.next(e),t.complete())},e=>t.error(e)).then(null,yi)});if(Bi(e))return Ki(e);if(Vi(e))return i=e,new F(e=>{for(var t of i)if(e.next(t),e.closed)return;e.complete()});if(Hi(e))return Ki(Qi(e))}var i,r,n,a;throw Ui(e)}function Ki(e){return new F(t=>{!function(t,i){var r,n,a,s;return ni(this,void 0,void 0,function*(){try{for(r=function(s){var e,t;if(Symbol.asyncIterator)return(t=s[Symbol.asyncIterator])?t.call(s):(s=function(e){var t="function"==typeof Symbol&&Symbol.iterator,i=t&&e[t],r=0;if(i)return i.call(e);if(e&&"number"==typeof e.length)return{next:function(){return{value:(e=e&&r>=e.length?void 0:e)&&e[r++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}(s),e={},i("next"),i("throw"),i("return"),e[Symbol.asyncIterator]=function(){return this},e);throw new TypeError("Symbol.asyncIterator is not defined.");function i(a){e[a]=s[a]&&function(n){return new Promise(function(e,t){var i,r;i=e,e=t,r=(n=s[a](n)).done,t=n.value,Promise.resolve(t).then(function(e){i({value:e,done:r})},e)})}}}(t);!(n=yield r.next()).done;){var e=n.value;if(i.next(e),i.closed)return}}catch(e){a={error:e}}finally{try{n&&!n.done&&(s=r.return)&&(yield s.call(r))}finally{if(a)throw a.error}}i.complete()})}(e,t).catch(e=>t.error(e))})}function ji(e,t,i,r,n){return new $i(e,t,i,r,n)}class $i extends Ai{constructor(t,i,e,r,n,a){super(t),this.onFinalize=n,this.shouldUnsubscribe=a,this._next=i?function(e){try{i(e)}catch(e){t.error(e)}}:super._next,this._error=r?function(e){try{r(e)}catch(e){t.error(e)}finally{this.unsubscribe()}}:super._error,this._complete=e?function(){try{e()}catch(e){t.error(e)}finally{this.unsubscribe()}}:super._complete}unsubscribe(){var e;this.shouldUnsubscribe&&!this.shouldUnsubscribe()||(e=this["closed"],super.unsubscribe(),e)||null!=(e=this.onFinalize)&&e.call(this)}}class Gi extends ci{constructor(e,t){super()}schedule(e){return this}}var Wi={setInterval(e,t){for(var i=Wi["delegate"],r=arguments.length,n=new Array(2<r?r-2:0),a=2;a<r;a++)n[a-2]=arguments[a];return null!=i&&i.setInterval?i.setInterval(e,t,...n):setInterval(e,t,...n)},clearInterval(e){var t=Wi["delegate"];return((null==t?void 0:t.clearInterval)||clearInterval)(e)},delegate:void 0};class zi extends Gi{constructor(e,t){super(e,t),this.scheduler=e,this.work=t,this.pending=!1}schedule(e){var t,i=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0;return this.closed||(this.state=e,e=this.id,t=this.scheduler,null!=e&&(this.id=this.recycleAsyncId(t,e,i)),this.pending=!0,this.delay=i,this.id=null!=(e=this.id)?e:this.requestAsyncId(t,this.id,i)),this}requestAsyncId(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return Wi.setInterval(e.flush.bind(e,this),i)}recycleAsyncId(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;if(null!=i&&this.delay===i&&!1===this.pending)return t;null!=t&&Wi.clearInterval(t)}execute(e,t){if(this.closed)return new Error("executing a cancelled action");this.pending=!1;e=this._execute(e,t);if(e)return e;!1===this.pending&&null!=this.id&&(this.id=this.recycleAsyncId(this.scheduler,this.id,null))}_execute(e,t){var i,r=!1;try{this.work(e)}catch(e){r=!0,i=e||new Error("Scheduled action threw falsy error")}if(r)return this.unsubscribe(),i}unsubscribe(){var e,t,i;this.closed||({id:e,scheduler:t}=this,i=t["actions"],this.work=this.state=this.scheduler=null,this.pending=!1,ui(i,this),null!=e&&(this.id=this.recycleAsyncId(t,e,null)),this.delay=null,super.unsubscribe())}}var Yi={now:()=>(Yi.delegate||Date).now(),delegate:void 0};class Xi{constructor(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:Xi.now;this.schedulerActionCtor=e,this.now=t}schedule(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,i=2<arguments.length?arguments[2]:void 0;return new this.schedulerActionCtor(this,e).schedule(i,t)}}Xi.now=Yi.now;class Ji extends Xi{constructor(e){super(e,1<arguments.length&&void 0!==arguments[1]?arguments[1]:Xi.now),this.actions=[],this._active=!1}flush(e){var t,i=this["actions"];if(this._active)i.push(e);else{this._active=!0;do{if(t=e.execute(e.state,e.delay))break}while(e=i.shift());if(this._active=!1,t){for(;e=i.shift();)e.unsubscribe();throw t}}}}var Zi=new Ji(zi),er=Zi;function tr(e){return e&&ei(e.schedule)}function ir(e){return e instanceof Date&&!isNaN(e)}function rr(e,t,i){var r=0<arguments.length&&void 0!==e?e:0,e=1<arguments.length?t:void 0,n=2<arguments.length&&void 0!==i?i:er,a=-1;return null!=e&&(tr(e)?n=e:a=e),new F(e=>{var t=ir(r)?+r-n.now():r,i=0;return n.schedule(function(){e.closed||(e.next(i++),0<=a?this.schedule(void 0,a):e.complete())},t=t<0?0:t)})}function nr(e){return e[e.length-1]}function ar(e){return ei(nr(e))?e.pop():void 0}function sr(e){return tr(nr(e))?e.pop():void 0}function or(e,t,i,r,n){var a=3<arguments.length&&void 0!==r?r:0,s=4<arguments.length&&void 0!==n&&n,r=t.schedule(function(){i(),s?e.add(this.schedule(null,a)):this.unsubscribe()},a);if(e.add(r),!s)return r}function ye(s){return ti((t,i)=>{var r,n=null,a=!1,n=t.subscribe(ji(i,void 0,void 0,e=>{r=qi(s(e,ye(s)(t))),n?(n.unsubscribe(),n=null,r.subscribe(i)):a=!0}));a&&(n.unsubscribe(),n=null,r.subscribe(i))})}var lr=Array["isArray"],{getPrototypeOf:dr,prototype:ur,keys:cr}=Object;function hr(e){if(1===e.length){var t,i=e[0];if(lr(i))return{args:i,keys:null};if(i&&"object"==typeof i&&dr(i)===ur)return{args:(t=cr(i)).map(e=>i[e]),keys:t}}return{args:e,keys:null}}function pr(i,e){var r=1<arguments.length&&void 0!==e?e:0;return ti((e,t)=>{e.subscribe(ji(t,e=>or(t,i,()=>t.next(e),r),()=>or(t,i,()=>t.complete(),r),e=>or(t,i,()=>t.error(e),r)))})}function mr(i,e){var r=1<arguments.length&&void 0!==e?e:0;return ti((e,t)=>{t.add(i.schedule(()=>e.subscribe(t),r))})}function fr(i,r){if(i)return new F(t=>{or(t,r,()=>{var e=i[Symbol.asyncIterator]();or(t,r,()=>{e.next().then(e=>{e.done?t.complete():t.next(e.value)})},0,!0)})});throw new Error("Iterable cannot be null")}function gr(e,t){if(null!=e){if(Fi(e))return s=t,qi(e).pipe(mr(s),pr(s));if(si(e))return i=e,r=t,new F(e=>{var t=0;return r.schedule(function(){t===i.length?e.complete():(e.next(i[t++]),e.closed||this.schedule())})});if(oi(e))return s=t,qi(e).pipe(mr(s),pr(s));if(Bi(e))return fr(e,t);if(Vi(e))return n=e,a=t,new F(i=>{var r;return or(i,a,()=>{r=n[_i](),or(i,a,()=>{var e,t;try{({value:e,done:t}=r.next())}catch(e){return void i.error(e)}t?i.complete():i.next(e)},0,!0)}),()=>ei(null==r?void 0:r.return)&&r.return()});if(Hi(e))return t=t,fr(Qi(e),t)}var n,a,i,r,s;throw Ui(e)}function yr(e,t){return t?gr(e,t):qi(e)}function ve(r,n){return ti((e,t)=>{var i=0;e.subscribe(ji(t,e=>{t.next(r.call(n,e,i++))}))})}var vr=Array["isArray"];function Ir(i){return ve(e=>{return t=i,vr(e=e)?t(...e):t(e);var t})}function Sr(e,r){return e.reduce((e,t,i)=>(e[t]=r[i],e),{})}function br(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];var r=sr(t),n=ar(t),{args:a,keys:s}=hr(t);return 0===a.length?yr([],r):(a=new F(function(o,l,e){var d=2<arguments.length&&void 0!==e?e:Li;return s=>{Tr(l,()=>{for(var e=o["length"],r=new Array(e),n=e,a=e,t=0;t<e;t++)!function(i){Tr(l,()=>{var e=yr(o[i],l),t=!1;e.subscribe(ji(s,e=>{r[i]=e,t||(t=!0,a--),a||s.next(d(r.slice()))},()=>{--n||s.complete()}))},s)}(t)},s)}}(a,r,s?e=>Sr(s,e):Li)),n?a.pipe(Ir(n)):a)}function Tr(e,t,i){e?or(i,e,t):t()}function Ar(e,i,r,n,a,s,o,t){var l,d=[],u=0,c=0,h=()=>{!l||d.length||u||i.complete()},p=e=>u<n?m(e):d.push(e),m=e=>{s&&i.next(e),u++;var t=!1;qi(r(e,c++)).subscribe(ji(i,e=>{null!=a&&a(e),s?p(e):i.next(e)},()=>{t=!0},void 0,()=>{if(t)try{u--;for(;d.length&&u<n;)!function(){var e=d.shift();o?or(i,o,()=>m(e)):m(e)}();h()}catch(e){i.error(e)}}))};return e.subscribe(ji(i,p,()=>{l=!0,h()})),()=>{null!=t&&t()}}function Er(n,a,e){var i=2<arguments.length&&void 0!==e?e:1/0;return ei(a)?Er((i,r)=>ve((e,t)=>a(i,e,r,t))(qi(n(i,r))),i):("number"==typeof a&&(i=a),ti((e,t)=>Ar(e,t,n,i)))}function Or(s,t,o,l,d){return(e,i)=>{var r=o,n=t,a=0;e.subscribe(ji(i,e=>{var t=a++;n=r?s(n,e,t):(r=!0,e),l&&i.next(n)},d&&(()=>{r&&i.next(n),i.complete()})))}}function wr(e,t){return ti(Or(e,t,2<=arguments.length,!1,!0))}var Rr=Array["isArray"];function Mr(e){return Er(Li,0<arguments.length&&void 0!==e?e:1/0)}function Pr(e,t){return ei(t)?Er(e,t,1):Er(e,1)}var Cr=li(e=>function(){e(this),this.name="ObjectUnsubscribedError",this.message="object unsubscribed"});class Ie extends F{constructor(){super(),this.closed=!1,this.currentObservers=null,this.observers=[],this.isStopped=!1,this.hasError=!1,this.thrownError=null}lift(e){var t=new kr(this,this);return t.operator=e,t}_throwIfClosed(){if(this.closed)throw new Cr}next(t){Ti(()=>{if(this._throwIfClosed(),!this.isStopped)for(var e of(this.currentObservers||(this.currentObservers=Array.from(this.observers)),this.currentObservers))e.next(t)})}error(t){Ti(()=>{if(this._throwIfClosed(),!this.isStopped){this.hasError=this.isStopped=!0,this.thrownError=t;for(var e=this["observers"];e.length;)e.shift().error(t)}})}complete(){Ti(()=>{if(this._throwIfClosed(),!this.isStopped){this.isStopped=!0;for(var e=this["observers"];e.length;)e.shift().complete()}})}unsubscribe(){this.isStopped=this.closed=!0,this.observers=this.currentObservers=null}get observed(){var e;return 0<(null==(e=this.observers)?void 0:e.length)}_trySubscribe(e){return this._throwIfClosed(),super._trySubscribe(e)}_subscribe(e){return this._throwIfClosed(),this._checkFinalizedStatuses(e),this._innerSubscribe(e)}_innerSubscribe(e){var{hasError:t,isStopped:i,observers:r}=this;return t||i?hi:(this.currentObservers=null,r.push(e),new ci(()=>{this.currentObservers=null,ui(r,e)}))}_checkFinalizedStatuses(e){var{hasError:t,thrownError:i,isStopped:r}=this;t?e.error(i):r&&e.complete()}asObservable(){var e=new F;return e.source=this,e}}Ie.create=(e,t)=>new kr(e,t);class kr extends Ie{constructor(e,t){super(),this.destination=e,this.source=t}next(e){var t,i;null!=(i=null==(t=this.destination)?void 0:t.next)&&i.call(t,e)}error(e){var t,i;null!=(i=null==(t=this.destination)?void 0:t.error)&&i.call(t,e)}complete(){var e,t;null!=(t=null==(e=this.destination)?void 0:e.complete)&&t.call(e)}_subscribe(e){var t;return null!=(t=null==(t=this.source)?void 0:t.subscribe(e))?t:hi}}function Lr(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];return Mr(1)(yr(t,sr(t)))}var Se=new F(e=>e.complete());function Dr(r){return r<=0?()=>Se:ti((e,t)=>{var i=0;e.subscribe(ji(t,e=>{++i<=r&&(t.next(e),r<=i)&&t.complete()}))})}function xr(e){return ve(()=>e)}function Nr(i,t){return t?e=>Lr(t.pipe(Dr(1),ti((e,t)=>{e.subscribe(ji(t,vi))})),e.pipe(Nr(i))):Er((e,t)=>i(e,t).pipe(Dr(1),xr(e)))}function be(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];return yr(t,sr(t))}function Fr(e,t){var i=ei(e)?e:()=>e,r=e=>e.error(i());return new F(t?e=>t.schedule(r,0,e):r)}function Te(a,e){var s=1<arguments.length&&void 0!==e?e:Li;return a=null!=a?a:Br,ti((e,i)=>{var r,n=!0;e.subscribe(ji(i,e=>{var t=s(e);!n&&a(r,t)||(n=!1,r=t,i.next(e))}))})}function Br(e,t){return e===t}function Ur(r,n){return ti((e,t)=>{var i=0;e.subscribe(ji(t,e=>r.call(n,e,i++)&&t.next(e)))})}var _r=li(e=>function(){e(this),this.name="EmptyError",this.message="no elements in sequence"});function Vr(a,n){return n?e=>e.pipe(Vr((i,r)=>qi(a(i,r)).pipe(ve((e,t)=>n(i,e,r,t))))):ti((e,t)=>{var i=0,r=null,n=!1;e.subscribe(ji(t,e=>{r||(r=ji(t,void 0,()=>{r=null,n&&t.complete()}),qi(a(e,i++)).subscribe(r))},()=>{n=!0,r||t.complete()}))})}function Qr(i,e,t){var r=1<arguments.length&&void 0!==e?e:1/0,n=2<arguments.length?t:void 0,r=(r||0)<1?1/0:r;return ti((e,t)=>Ar(e,t,i,r,void 0,!0,n))}function Hr(i){return ti((e,t)=>{try{e.subscribe(t)}finally{t.add(i)}})}function qr(r){return r<=0?()=>Se:ti((e,t)=>{var i=[];e.subscribe(ji(t,e=>{i.push(e),r<i.length&&i.shift()},()=>{for(var e of i)t.next(e);t.complete()},void 0,()=>{i=null}))})}function Kr(){return ti((e,i)=>{var r,n=!1;e.subscribe(ji(i,e=>{var t=r;r=e,n&&i.next([t,e]),n=!0}))})}class jr extends Ie{constructor(e){super(),this._value=e}get value(){return this.getValue()}_subscribe(e){var t=super._subscribe(e);return t.closed||e.next(this._value),t}getValue(){var{hasError:e,thrownError:t,_value:i}=this;if(e)throw t;return this._throwIfClosed(),i}next(e){super.next(this._value=e)}}class $r extends Ie{constructor(){super(...arguments),this._value=null,this._hasValue=!1,this._isComplete=!1}_checkFinalizedStatuses(e){var{hasError:t,_hasValue:i,_value:r,thrownError:n,isStopped:a,_isComplete:s}=this;t?e.error(n):(a||s)&&(i&&e.next(r),e.complete())}next(e){this.isStopped||(this._value=e,this._hasValue=!0)}complete(){var{_hasValue:e,_value:t,_isComplete:i}=this;i||(this._isComplete=!0,e&&super.next(t),super.complete())}}class Gr extends Ie{constructor(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:1/0,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:1/0,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:Yi;super(),this._bufferSize=e,this._windowTime=t,this._timestampProvider=i,this._buffer=[],this._infiniteTimeWindow=!0,this._infiniteTimeWindow=t===1/0,this._bufferSize=Math.max(1,e),this._windowTime=Math.max(1,t)}next(e){var{isStopped:t,_buffer:i,_infiniteTimeWindow:r,_timestampProvider:n,_windowTime:a}=this;t||(i.push(e),r)||i.push(n.now()+a),this._trimBuffer(),super.next(e)}_subscribe(e){this._throwIfClosed(),this._trimBuffer();for(var t=this._innerSubscribe(e),{_infiniteTimeWindow:i,_buffer:r}=this,n=r.slice(),a=0;a<n.length&&!e.closed;a+=i?1:2)e.next(n[a]);return this._checkFinalizedStatuses(e),t}_trimBuffer(){var{_bufferSize:e,_timestampProvider:t,_buffer:i,_infiniteTimeWindow:r}=this,n=(r?1:2)*e;if(e<1/0&&n<i.length&&i.splice(0,i.length-n),!r){for(var a=t.now(),s=0,o=1;o<i.length&&i[o]<=a;o+=2)s=o;s&&i.splice(0,s+1)}}}function Wr(){for(var e,t,i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return 1===(r=1===(e=r).length&&Rr(e[0])?e[0]:e).length?qi(r[0]):new F((t=r,r=>{for(var n=[],e=0;n&&!r.closed&&e<t.length;e++)!function(i){n.push(qi(t[i]).subscribe(ji(r,e=>{if(n){for(var t=0;t<n.length;t++)t!==i&&n[t].unsubscribe();n=null}r.next(e)})))}(e)}))}function zr(e){var o,l=1/0;return null!=e&&("object"==typeof e?{count:l=1/0,delay:o}=e:l=e),l<=0?()=>Se:ti((t,i)=>{var r,n=0,a=()=>{var e,t;null!=r&&r.unsubscribe(),(r=null)!=o?(e="number"==typeof o?rr(o):qi(o(n)),t=ji(i,()=>{t.unsubscribe(),s()}),e.subscribe(t)):s()},s=()=>{var e=!1;r=t.subscribe(ji(i,void 0,()=>{++n<l?r?a():e=!0:i.complete()})),e&&a()};s()})}function Yr(e){var e=0<arguments.length&&void 0!==e?e:1/0,{count:d=1/0,delay:u,resetOnSuccess:t=!1}=e&&"object"==typeof e?e:{count:e};return d<=0?Li:ti((e,a)=>{var s,o=0,l=()=>{var n=!1;s=e.subscribe(ji(a,e=>{t&&(o=0),a.next(e)},void 0,e=>{var t,i,r;o++<d?(t=()=>{s?(s.unsubscribe(),s=null,l()):n=!0},null!=u?(i="number"==typeof u?rr(u):qi(u(e,o)),r=ji(a,()=>{r.unsubscribe(),t()},()=>{a.complete()}),i.subscribe(r)):t()):a.error(e)})),n&&(s.unsubscribe(),s=null,l())};l()})}function Xr(s){return ti((e,t)=>{var i,r,n=!1,a=()=>{i=e.subscribe(ji(t,void 0,void 0,e=>{r||(r=new Ie,s(r).subscribe(ji(t,()=>i?a():n=!0))),r&&r.next(e)})),n&&(i.unsubscribe(),i=null,n=!1,a())};a()})}function Jr(e){var{connector:h=()=>new Ie,resetOnError:p=!0,resetOnComplete:m=!0,resetOnRefCountZero:f=!0}=0<arguments.length&&void 0!==e?e:{};return e=>{var r,n,a,s=0,o=!1,l=!1,d=()=>{null!=n&&n.unsubscribe(),n=void 0},u=()=>{d(),r=a=void 0,o=l=!1},c=()=>{var e=r;u(),null!=e&&e.unsubscribe()};return ti((e,t)=>{s++,l||o||d();var i=a=null!=a?a:h();t.add(()=>{0!=--s||l||o||(n=Zr(c,f))}),i.subscribe(t),!r&&0<s&&(r=new Ri({next:e=>i.next(e),error:e=>{l=!0,d(),n=Zr(u,p,e),i.error(e)},complete:()=>{o=!0,d(),n=Zr(u,m),i.complete()}}),qi(e).subscribe(r))})(e)}}function Zr(e,t){if(!0!==t){if(!1!==t){for(var i=new Ri({next:()=>{i.unsubscribe(),e()}}),r=arguments.length,n=new Array(2<r?r-2:0),a=2;a<r;a++)n[a-2]=arguments[a];return t(...n).subscribe(i)}}else e()}function en(e,t,i){var r,n=!1;return e&&"object"==typeof e?{bufferSize:r=1/0,windowTime:t=1/0,refCount:n=!1,scheduler:i}=e:r=null!=e?e:1/0,Jr({connector:()=>new Gr(r,t,i),resetOnError:!0,resetOnComplete:!1,resetOnRefCountZero:n})}function tn(i){return Ur((e,t)=>i<=t)}function rn(){for(var e=arguments.length,i=new Array(e),t=0;t<e;t++)i[t]=arguments[t];var r=sr(i);return ti((e,t)=>{(r?Lr(i,e,r):Lr(i,e)).subscribe(t)})}function Ae(l,d){return ti((e,n)=>{var a=null,s=0,t=!1,o=()=>t&&!a&&n.complete();e.subscribe(ji(n,t=>{null!=a&&a.unsubscribe();var i=0,r=s++;qi(l(t,r)).subscribe(a=ji(n,e=>n.next(d?d(t,e,r,i++):e),()=>{a=null,o()}))},()=>{t=!0,o()}))})}function nn(e,t){return ei(t)?Ae(()=>e,t):Ae(()=>e)}function an(i){return ti((e,t)=>{qi(i).subscribe(ji(t,()=>t.complete(),vi)),t.closed||e.subscribe(t)})}function sn(n,e){var a=1<arguments.length&&void 0!==e&&e;return ti((e,i)=>{var r=0;e.subscribe(ji(i,e=>{var t=n(e,r++);(t||a)&&i.next(e),t||i.complete()}))})}function Ee(e,t,i){var n=ei(e)||t||i?{next:e,error:t,complete:i}:e;return n?ti((e,i)=>{null!=(t=n.subscribe)&&t.call(n);var t,r=!0;e.subscribe(ji(i,e=>{var t;null!=(t=n.next)&&t.call(n,e),i.next(e)},()=>{var e;r=!1,null!=(e=n.complete)&&e.call(n),i.complete()},e=>{var t;r=!1,null!=(t=n.error)&&t.call(n,e),i.error(e)},()=>{var e;r&&null!=(e=n.unsubscribe)&&e.call(n),null!=(e=n.finalize)&&e.call(n)}))}):Li}var on={leading:!0,trailing:!1};function ln(e,t,i){var i=2<arguments.length&&void 0!==i?i:on,p=rr(e,1<arguments.length&&void 0!==t?t:Zi);return function(e,t){var h=1<arguments.length&&void 0!==t?t:on;return ti((e,t)=>{var{leading:i,trailing:r}=h,n=!1,a=null,s=null,o=!1,l=()=>{null!=s&&s.unsubscribe(),s=null,r&&(c(),o)&&t.complete()},d=()=>{s=null,o&&t.complete()},u=e=>s=qi(p).subscribe(ji(t,l,d)),c=()=>{var e;n&&(n=!1,e=a,a=null,t.next(e),o||u(e))};e.subscribe(ji(t,e=>{n=!0,a=e,s&&!s.closed||(i?c():u(e))},()=>{o=!0,r&&n&&s&&!s.closed||t.complete()}))})}(()=>p,i)}var dn=li(t=>function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:null;t(this),this.message="Timeout has occurred",this.name="TimeoutError",this.info=e});function un(e,t){var{first:o,each:l,with:d=function(e){throw new dn(e)},scheduler:u=null!=t?t:Zi,meta:c=null}=ir(e)?{first:e}:"number"==typeof e?{each:e}:e;if(null==o&&null==l)throw new TypeError("No timeout provided.");return ti((e,t)=>{var i,r=null,n=0,a=e=>{i=or(t,u,()=>{try{s.unsubscribe(),qi(d({meta:c,lastValue:r,seen:n})).subscribe(t)}catch(e){t.error(e)}},e)},s=e.subscribe(ji(t,e=>{null!=i&&i.unsubscribe(),n++,t.next(r=e),0<l&&a(l)},void 0,void 0,()=>{null!=i&&i.closed||null==i||i.unsubscribe(),r=null}));n||a(null!=o?"number"==typeof o?o:+o-u.now():l)})}function cn(){for(var e=arguments.length,o=new Array(e),t=0;t<e;t++)o[t]=arguments[t];var l=ar(o);return ti((e,i)=>{for(var t=o.length,r=new Array(t),n=o.map(()=>!1),a=!1,s=0;s<t;s++)!function(t){qi(o[t]).subscribe(ji(i,e=>{r[t]=e,!a&&!n[t]&&(n[t]=!0,a=n.every(Li))&&(n=null)},vi))}(s);e.subscribe(ji(i,e=>{a&&(e=[e,...r],i.next(l?l(...e):e))}))})}var hn="id";function pn(e){return jt(e)&&0===e.length}function mn(e){return"function"==typeof e}function fn(){return Te((i,e)=>i===e||!(!jt(i)||!jt(e))&&(!(!pn(i)||!pn(e))||i.length===e.length&&!1===e.some((e,t)=>i[t]!==e)))}function gn(e){var t=typeof e;return null!=e&&("object"==t||"function"==t)}function yn(e,t,i){var r,n,a=2<arguments.length&&void 0!==i?i:hn,i=mn(t)?(n=t,function(){return!n(...arguments)}):(r=Jt(t),e=>!1===r.includes(gn(e)?e[a]:e));if(Array.isArray(e))return e.filter(i)}function vn(e,t,i,r){var n,a,s=3<arguments.length&&void 0!==r?r:hn;return a=mn(t)?t:(n=Jt(t),e=>!0===n.includes(gn(e)?e[s]:e)),e.map((e,t)=>!0===a(e,t)?gn(e)?S(S({},e),i):i:e)}var In,Sn=1,bn={};function Tn(e){return e in bn&&(delete bn[e],!0)}var{setImmediate:An,clearImmediate:En}={setImmediate(e){var t=Sn++;return bn[t]=!0,(In=In||Promise.resolve()).then(()=>Tn(t)&&e()),t},clearImmediate(e){Tn(e)}},On={setImmediate(){var e=On["delegate"];return((null==e?void 0:e.setImmediate)||An)(...arguments)},clearImmediate(e){var t=On["delegate"];return((null==t?void 0:t.clearImmediate)||En)(e)},delegate:void 0},wn=new class extends Ji{flush(e){this._active=!0;var t=this._scheduled;this._scheduled=void 0;var i,r=this["actions"];e=e||r.shift();do{if(i=e.execute(e.state,e.delay))break}while((e=r[0])&&e.id===t&&r.shift());if(this._active=!1,i){for(;(e=r[0])&&e.id===t&&r.shift();)e.unsubscribe();throw i}}}(class extends zi{constructor(e,t){super(e,t),this.scheduler=e,this.work=t}requestAsyncId(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return null!==i&&0<i?super.requestAsyncId(e,t,i):(e.actions.push(this),e._scheduled||(e._scheduled=On.setImmediate(e.flush.bind(e,void 0))))}recycleAsyncId(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;if(null!=i?0<i:0<this.delay)return super.recycleAsyncId(e,t,i);var i=e["actions"];null!=t&&(null==(i=i[i.length-1])?void 0:i.id)!==t&&(On.clearImmediate(t),e._scheduled=void 0)}}),Rn=new class extends Ji{}(class extends zi{constructor(e,t){super(e,t),this.scheduler=e,this.work=t}schedule(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0;return 0<t?super.schedule(e,t):(this.delay=t,this.state=e,this.scheduler.flush(this),this)}execute(e,t){return 0<t||this.closed?super.execute(e,t):this._execute(e,t)}requestAsyncId(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return null!=i&&0<i||null==i&&0<this.delay?super.requestAsyncId(e,t,i):(e.flush(this),0)}});function Mn(t){return new F(e=>{qi(t()).subscribe(e)})}function Pn(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];var r=ar(t),{args:s,keys:o}=hr(t),n=new F(e=>{var t=s["length"];if(t)for(var r=new Array(t),n=t,a=t,i=0;i<t;i++)!function(t){var i=!1;qi(s[t]).subscribe(ji(e,e=>{i||(i=!0,a--),r[t]=e},()=>n--,void 0,()=>{n&&i||(a||e.next(o?Sr(o,r):r),e.complete())}))}(i);else e.complete()});return r?n.pipe(Ir(r)):n}var Cn=["addListener","removeListener"],kn=["addEventListener","removeEventListener"],Ln=["on","off"];function Dn(i,r,n,e){if(ei(n)&&(e=n,n=void 0),e)return Dn(i,r,n).pipe(Ir(e));var[t,a]=ei(i.addEventListener)&&ei(i.removeEventListener)?kn.map(t=>e=>i[t](r,e,n)):ei(i.addListener)&&ei(i.removeListener)?Cn.map(xn(i,r)):ei(i.on)&&ei(i.off)?Ln.map(xn(i,r)):[];if(!t&&si(i))return Er(e=>Dn(e,r,n))(qi(i));if(t)return new F(r=>{function e(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];return r.next(1<t.length?t:t[0])}return t(e),()=>a(e)});throw new TypeError("Invalid event target")}function xn(i,r){return t=>e=>i[t](r,e)}function Nn(i,n,e){return e?Nn(i,n).pipe(Ir(e)):new F(r=>{function e(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];return r.next(1===t.length?t[0]:t)}var t=i(e);return ei(n)?()=>n(e,t):void 0})}function Fn(e,t,i){return Mn(()=>e()?t:i)}function Bn(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];var r=sr(t),n="number"==typeof nr(n=t)?n.pop():1/0,a=t;return a.length?1===a.length?qi(a[0]):Mr(n)(yr(a,r)):Se}var Un=new F(vi);function _n(e){return br(e).pipe(function(e,t){var i=1<arguments.length&&void 0!==t?t:Zi,l=()=>rr(e,i);return ti((e,t)=>{var i=!1,r=null,n=null,a=!1,s=()=>{var e;null!=n&&n.unsubscribe(),n=null,i&&(i=!1,e=r,r=null,t.next(e)),a&&t.complete()},o=()=>{n=null,a&&t.complete()};e.subscribe(ji(t,e=>{i=!0,r=e,n||qi(l()).subscribe(n=ji(t,s,o))},()=>{a=!0,i&&n&&!n.closed||t.complete()}))})}(0))}var Vn={resettable:!1,ttl:null,producerFn:void 0};function Qn(e){return!1===Xt(e)}var Hn,qn,Kn,jn=new Ie,$n=new Gr(50,5e3),Gn=new Ie,Wn="undefined"!=typeof window,zn={},Yn={},Xn=(Wn&&(window.$$stores=zn,window.$$queries=Yn),(Kn=Hn=Hn||{}).ASC="asc",Kn.DESC="desc",(t=qn=qn||{}).Set="Set",t.Add="Add",t.Update="Update",t.Remove="Remove",!0);function Jn(e){return void 0===e}function Zn(e,t){var i,r={};for(i of Object.keys(e))r[i]=t(e[i]);return r}function ea(t){Object.freeze(t);var i="function"==typeof t,r=Object.prototype.hasOwnProperty;return Object.getOwnPropertyNames(t).forEach(function(e){!r.call(t,e)||i&&("caller"===e||"callee"===e||"arguments"===e)||null===t[e]||"object"!=typeof t[e]&&"function"!=typeof t[e]||Object.isFrozen(t[e])||ea(t[e])}),t}function ta(e){return null!=e&&"false"!=="".concat(e)}function ia(e){return ta(e)&&"Object"===e.constructor.name}var ra=new Ie,na=new jr(!1),aa={activeTransactions:0,batchTransaction:null};function sa(){return 0<aa.activeTransactions}function Oe(e,t){t=1<arguments.length&&void 0!==t?t:void 0;sa()||(aa.batchTransaction=new Ie),aa.activeTransactions++,na.next(!0);try{return e.apply(t)}finally{Ht("@Transaction"),0==--aa.activeTransactions&&(aa.batchTransaction.next(!0),aa.batchTransaction.complete(),na.next(!1),ra.next(!0))}}function oa(){return function(e,t,i){var r=i.value;return i.value=function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];return Oe(()=>r.apply(this,t),this)},i}}function la(t){return function(e){return e.pipe(Ee(e=>Oe(()=>t(e))))}}class da{constructor(e){this.options=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},this.inTransaction=!1,this.cache={active:new jr(!1),ttl:null},this.onInit(e)}setLoading(){var t=0<arguments.length&&void 0!==arguments[0]&&arguments[0];t!==this._value().loading&&(Xn&&qt("Set Loading"),this._setState(e=>S(S({},e),{},{loading:t})))}setHasCache(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{restartTTL:!1};e!==this.cache.active.value&&this.cache.active.next(e),t.restartTTL&&(e=this.getCacheTTL())&&(null!==this.cache.ttl&&clearTimeout(this.cache.ttl),this.cache.ttl=setTimeout(()=>this.setHasCache(!1),e))}getValue(){return this.storeValue}setError(t){t!==this._value().error&&(Xn&&qt("Set Error"),this._setState(e=>S(S({},e),{},{error:t})))}_select(t){return this.store.asObservable().pipe(ve(e=>t(e.state)),Te())}_value(){return this.storeValue}_cache(){return this.cache.active}get config(){return this.constructor.akitaConfig||{}}get storeName(){return this.config.storeName||this.options.storeName||this.options.name}get deepFreeze(){return this.config.deepFreezeFn||this.options.deepFreezeFn||ea}get cacheConfig(){return this.config.cache||this.options.cache}get _producerFn(){return this.config.producerFn||this.options.producerFn||Vn.producerFn}get resettable(){return(Qn(this.config.resettable)?this.config:this.options).resettable}_setState(e){var t,i=!(1<arguments.length&&void 0!==arguments[1])||arguments[1];mn(e)?(t=e(this._value()),this.storeValue=Xn?this.deepFreeze(t):t):this.storeValue=e,this.store?sa()?this.handleTransaction():this.dispatch(this.storeValue,i):(this.store=new jr({state:this.storeValue}),Xn&&this.store.subscribe(e=>{var t,e=e["action"];e&&(t=this.storeName,Gn.next({storeName:t,action:e}))}))}reset(){this.isResettable()&&(Xn&&qt("Reset"),this._setState(()=>Object.assign({},this._initialState)),this.setHasCache(!1))}update(e){Xn&&qt("Update");var t=this._value(),e=mn(e)?mn(this._producerFn)?this._producerFn(t,e):e(t):e,e=this.akitaPreUpdate(t,S(S({},t),e)),t=ia(t)?e:new t.constructor(e);this._setState(t)}updateStoreConfig(e){this.options=S(S({},this.options),e)}akitaPreUpdate(e,t){return t}destroy(){var e;Wn&&window.hmrEnabled||this!==zn[this.storeName]||(delete zn[this.storeName],e=this.storeName,jn.next(e),this.setHasCache(!1),this.cache.active.complete(),this.store.complete())}onInit(e){var t,i;(zn[this.storeName]=this)._setState(()=>e),t=this.storeName,$n.next(t),this.isResettable()&&(this._initialState=e),Xn&&(t=this.storeName,i=this.constructor.name,t||console.error("@StoreConfig({ name }) is missing in ".concat(i)))}dispatch(e){var t=void 0;1<arguments.length&&void 0!==arguments[1]&&!arguments[1]||(t=Vt,Qt=!1),this.store.next({state:e,action:t})}watchTransaction(){(aa.batchTransaction?aa.batchTransaction.asObservable():be(!0)).subscribe(()=>{this.inTransaction=!1,this.dispatch(this._value())})}isResettable(){return!1!==this.resettable&&(this.resettable||Vn.resettable)}handleTransaction(){this.inTransaction||(this.watchTransaction(),this.inTransaction=!0)}getCacheTTL(){return this.cacheConfig&&this.cacheConfig.ttl||Vn.ttl}}class ua extends da{constructor(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};super(S(S({},{entities:{},ids:[],loading:!0,error:null}),e),t),this.options=t,this.entityActions=new Ie,this.entityIdChanges=new Ie}get selectEntityAction$(){return this.entityActions.asObservable()}get selectEntityIdChanges$(){return this.entityIdChanges.asObservable()}get idKey(){return this.config.idKey||this.options.idKey||hn}set(t){var i,r=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};Xt(t)||(Xn&&qt("Set Entity"),i=this.akitaPreAddEntity===ua.prototype.akitaPreAddEntity,this.setHasCache(!0,{restartTTL:!0}),this._setState(e=>{e=function(e){var t,{state:e,entities:a,idKey:i,preAddEntity:r,isNativePreAdd:n}=e,n=(i=jt(a)?(t=(i=function(e,t){var i,r={entities:{},ids:[]};for(i of a){var n=t(i);r.entities[n[e]]=n,r.ids.push(n[e])}return r}(i,r)).entities,i.ids):a.entities&&a.ids?(t=n?a.entities:Zn(a.entities,r),a.ids):(t=n?a:Zn(a,r),Object.keys(t).map(e=>isNaN(e)?e:Number(e))),S(S({},e),{},{entities:t,ids:i,loading:!1}));return $t(e)&&(n.active=Wt(n)),n}({state:e,entities:t,idKey:this.idKey,preAddEntity:this.akitaPreAddEntity.bind(this),isNativePreAdd:i});return!1===Jn(r.activeId)&&(e.active=r.activeId),e}),this.hasInitialUIState()&&this.handleUICreation(),this.entityActions.next({type:qn.Set,ids:this.ids}))}add(e){var t,i=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{loading:!1},e=Jt(e);pn(e)||(t=function(e){var t,i,r,{state:n,entities:e,idKey:a,options:s={},preAddEntity:o}=e,l={},d=[],u=!1;for(t of e)!1===Kt(n.entities,t[a])&&(l[r=(i=o(t))[a]]=i,s.prepend?d.unshift(r):d.push(r),u=!0);return u?{newState:S(S({},n),{},{entities:S(S({},n.entities),l),ids:s.prepend?[...d,...n.ids]:[...n.ids,...d]}),newIds:d}:null}({state:this._value(),preAddEntity:this.akitaPreAddEntity.bind(this),entities:e,idKey:this.idKey,options:i}))&&(Xn&&qt("Add Entity"),t.newState.loading=i.loading,this._setState(()=>t.newState),this.hasInitialUIState()&&this.handleUICreation(!0),this.entityActions.next({type:qn.Add,ids:t.newIds}))}update(t,y){var v,I;Jn(y)?super.update(t):pn(I=mn(t)?this.ids.filter(e=>t(this.entities[e])):Xt(t)?this.ids:Jt(t))||(Xn&&qt("Update Entity",I),this._setState(e=>{var t,i,r,n,a,{state:s,ids:e,idKey:o,newStateOrFn:l,preUpdateEntity:d,producerFn:u,onEntityIdChanges:c}=e={idKey:this.idKey,ids:I,preUpdateEntity:this.akitaPreUpdateEntity.bind(this),state:e,newStateOrFn:y,producerFn:this._producerFn,onEntityIdChanges:(e,t)=>{v={oldId:e,newId:t},this.entityIdChanges.next(S(S({},v),{},{pending:!0}))}},h={},p=!1;for(t of e)!1!==Kt(s.entities,t)&&(i=s.entities[t],a=void 0,n=(a=mn(l)?mn(u)?u(i,l):l(i):l).hasOwnProperty(o)&&a[o]!==i[o],r=t,n&&(p=!0,r=a[o]),n=S(S({},i),a),a=ia(i)?n:new(ia(a)?i:a).constructor(n),h[r]=d(i,a));var m,f=s.ids,g=s.entities;return p&&([m]=e,g=function(e,t){if(null==e)return{};var i,r=function(e,t){if(null==e)return{};for(var i,r={},n=Object.keys(e),a=0;a<n.length;a++)i=n[a],0<=t.indexOf(i)||(r[i]=e[i]);return r}(e,t);if(Object.getOwnPropertySymbols)for(var n=Object.getOwnPropertySymbols(e),a=0;a<n.length;a++)i=n[a],0<=t.indexOf(i)||Object.prototype.propertyIsEnumerable.call(e,i)&&(r[i]=e[i]);return r}(s.entities,[m].map(Yt)),f=s.ids.map(e=>e===m?r:e),c(m,r)),S(S({},s),{},{entities:S(S({},g),h),ids:f})}),v&&this.entityIdChanges.next(S(S({},v),{},{pending:!1})),this.entityActions.next({type:qn.Update,ids:I}))}upsert(e,i,r){var t=3<arguments.length&&void 0!==arguments[3]?arguments[3]:{},e=Jt(e),n=t=>e=>Kt(this.entities,e)===t,a=mn(r)?t.baseClass:r?r.baseClass:void 0,s=mn(a),t=e.filter(n(!0)),e=e.filter(n(!1)).map(e=>{var t="function"==typeof i?i({}):i,t=S(S({},mn(r)?r(e,t):t),{},{[this.idKey]:e});return s?new a(t):t});this.update(t,i),this.add(e),Xn&&Ht("Upsert Entity")}upsertMany(e){var t,i=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},r=[],n=[],a={};for(t of e){var s,o=this.akitaPreCheckEntity(t),l=o[this.idKey];Kt(this.entities,l)?(s=this._value().entities[l],l=S(S({},this._value().entities[l]),o),l=i.baseClass?new i.baseClass(l):l,l=(s=this.akitaPreUpdateEntity(s,l))[this.idKey],a[l]=s,n.push(l)):(s=i.baseClass?new i.baseClass(o):o,o=(l=this.akitaPreAddEntity(s))[this.idKey],r.push(o),a[o]=l)}Xn&&Ht("Upsert Many"),this._setState(e=>S(S({},e),{},{ids:r.length?[...e.ids,...r]:e.ids,entities:S(S({},e.entities),a),loading:!!i.loading})),n.length&&this.entityActions.next({type:qn.Update,ids:n}),r.length&&this.entityActions.next({type:qn.Add,ids:r}),r.length&&this.hasUIStore()&&this.handleUICreation(!0)}replace(e,t){var i=Jt(e);if(!pn(i)){var r,n={};for(r of i)n[r]=S(S({},t),{},{[this.idKey]:r});Xn&&qt("Replace Entity",e),this._setState(e=>S(S({},e),{},{entities:S(S({},e.entities),n)}))}}move(e,t){var i=this.ids.slice();i.splice(t<0?i.length+t:t,0,i.splice(e,1)[0]),Xn&&qt("Move Entity"),this._setState(e=>S(S({},e),{},{entities:S({},e.entities),ids:i}))}remove(t){var s,e;pn(this.ids)||(e=Qn(t),pn(s=mn(t)?this.ids.filter(e=>t(this.entities[e])):e?Jt(t):this.ids))||(Xn&&qt("Remove Entity",s),this._setState(e=>{var{state:e,ids:t}={state:e,ids:s};if(Xt(t))return S(S({},a=e),{},{entities:{},ids:[],active:Gt(a.active)?[]:null});var i,r=e.entities,n={};for(i of e.ids)!1===t.includes(i)&&(n[i]=r[i]);var a=S(S({},e),{},{entities:n,ids:e.ids.filter(e=>!1===t.includes(e))});return $t(e)&&(a.active=Wt(a)),a}),e||this.setHasCache(!1),this.handleUIRemove(s),this.entityActions.next({type:qn.Remove,ids:s}))}updateActive(e){var t=Jt(this.active);Xn&&qt("Update Active",t),this.update(t,e)}setActive(e){e=function(e,t,i){var r;if(jt(e))r=e;else if(gn(e)){if(Xt(i))return;e=Object.assign({wrap:!0},e);var n=t.indexOf(i);if(e.prev){var a=0===n;if(a&&!e.wrap)return;r=a?t[t.length-1]:t[n-1]}else if(e.next){a=t.length===n+1;if(a&&!e.wrap)return;r=a?t[0]:t[n+1]}}else{if(e===i)return;r=e}return r}(e,this.ids,this.active);void 0!==e&&(Xn&&qt("Set Active",e),this._setActive(e))}addActive(e){var i=Jt(e);pn(i)||i.every(e=>-1<this.active.indexOf(e))||(Xn&&qt("Add Active",e),this._setState(e=>{var t=Array.from(new Set([...e.active,...i]));return S(S({},e),{},{active:t})}))}removeActive(e){var t=Jt(e);pn(t)||t.some(e=>-1<this.active.indexOf(e))&&(Xn&&qt("Remove Active",e),this._setState(e=>S(S({},e),{},{active:Array.isArray(e.active)?e.active.filter(e=>-1===t.indexOf(e)):null})))}toggleActive(e){var e=Jt(e),t=t=>e=>this.active.includes(e)===t,i=e.filter(t(!0)),e=e.filter(t(!1));this.removeActive(i),this.addActive(e),Xn&&Ht("Toggle Active")}createUIStore(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},i={name:"UI/".concat(this.storeName),idKey:this.idKey};return this.ui=new ca(e,S(S({},i),t)),this.ui}destroy(){super.destroy(),this.ui instanceof ua&&this.ui.destroy(),this.entityActions.complete()}akitaPreUpdateEntity(e,t){return t}akitaPreAddEntity(e){return e}akitaPreCheckEntity(e){return e}get ids(){return this._value().ids}get entities(){return this._value().entities}get active(){return this._value().active}_setActive(t){this._setState(e=>S(S({},e),{},{active:t}))}handleUICreation(){var e=0<arguments.length&&void 0!==arguments[0]&&arguments[0],t=this.ids,i=mn(this.ui._akitaCreateEntityFn),r=e=>{var e=this.entities[e],t=i?this.ui._akitaCreateEntityFn(e):this.ui._akitaCreateEntityFn;return S({[this.idKey]:e[this.idKey]},t)},t=(e?this.ids.filter(e=>Jn(this.ui.entities[e])):t).map(r);e?this.ui.add(t):this.ui.set(t)}hasInitialUIState(){return this.hasUIStore()&&!1===Jn(this.ui._akitaCreateEntityFn)}handleUIRemove(e){this.hasUIStore()&&this.ui.remove(e)}hasUIStore(){return this.ui instanceof ca}}ii([oa(),ri("design:type",Function),ri("design:paramtypes",[Object,Object,Object,Object]),ri("design:returntype",void 0)],ua.prototype,"upsert",null),ii([oa(),ri("design:type",Function),ri("design:paramtypes",["function"==typeof(t="undefined"!=typeof T&&T)?t:Object]),ri("design:returntype",void 0)],ua.prototype,"toggleActive",null);class ca extends ua{constructor(){super(0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},1<arguments.length&&void 0!==arguments[1]?arguments[1]:{})}setInitialEntityState(e){this._akitaCreateEntityFn=e}}var ha=e=>e.pipe(Ur(e=>null!=e));function pa(e){return"string"==typeof e}class ma{constructor(e){this.store=e,this.__store__=e,Xn&&(Yn[e.storeName]=this)}select(t){var e,n;if(mn(t))e=t;else if(pa(t))e=e=>e[t];else{if(Array.isArray(t))return this.store._select(e=>e).pipe(Te((n=t,function(t,i){var r=mn(n[0]);return!1===n.some(e=>r?e(t)!==e(i):t[e]!==i[e])})),ve(i=>mn(t[0])?t.map(e=>e(i)):t.reduce((e,t)=>(e[t]=i[t],e),{})));e=e=>e}return this.store._select(e)}selectLoading(){return this.select(e=>e.loading)}selectError(){return this.select(e=>e.error)}getValue(){return this.store._value()}selectHasCache(){return this.store._cache().asObservable()}getHasCache(){return this.store._cache().value}get config(){return this.constructor.akitaQueryConfig}}function fa(t,i){return function(e){e=e[t];if(!Jn(e))return i?pa(i)?e[i]:i(e):e}}class ga extends ma{constructor(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};super(e),this.options=t,this.__store__=e}selectAll(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{asObject:!1};return this.select(e=>e.entities).pipe(ve(()=>this.getAll(e)))}getAll(){var e,t,c=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{asObject:!1,filterBy:void 0,limitTo:void 0};return(c.asObject?function(e){var r={},{filterBy:n,limitTo:a}=c,{ids:s,entities:o}=e;if(!n&&!a)return o;e=!1===Xt(a);if(n&&e)for(var l=0,t=0,i=s.length;t<i&&!function(t){if(l===a)return 1;var e=s[t],i=o[e];Jt(n).every(e=>e(i,t))&&(r[e]=i,l++)}(t);t++);else for(var d=Math.min(a||s.length,s.length),u=0;u<d;u++)!function(t){var e=s[t],i=o[e];if(!n)return r[e]=i;Jt(n).every(e=>e(i,t))&&(r[e]=i)}(u);return r}:(e=c,t=this.config||this.options,e.sortBy=e.sortBy||t&&t.sortBy,e.sortByOrder=e.sortByOrder||t&&t.sortByOrder,function(i){for(var r,e=[],{ids:n,entities:a}=i,{filterBy:s,limitTo:t,sortBy:o,sortByOrder:l}=c,d=0;d<n.length;d++)!function(t){var i=a[n[t]];if(!s)return e.push(i);Jt(s).every(e=>e(i,t))&&e.push(i)}(d);o&&(r=mn(o)?o:function(r,e){var n=1<arguments.length&&void 0!==e?e:Hn.ASC;return function(e,t){var i;return e.hasOwnProperty(r)&&t.hasOwnProperty(r)?(e="string"==typeof e[r]?e[r].toUpperCase():e[r],i=0,(t="string"==typeof t[r]?t[r].toUpperCase():t[r])<e?i=1:e<t&&(i=-1),n==Hn.DESC?-1*i:i):0}}(o,l),e=e.sort((e,t)=>r(e,t,i)));o=Math.min(t||e.length,e.length);return o===e.length?e:e.slice(0,o)}))(this.getValue())}selectMany(e,i){return e&&e.length?this.select(e=>e.entities).pipe(ve(t=>{return n=e=>fa(e,i)(t),e.reduce((e,t,i,r)=>{t=n(t);return void 0!==t&&e.push(t),e},[]);var n}),fn()):be([])}selectEntity(e,t){var i=e;return mn(e)&&(i=function(e,t){for(var i of Object.keys(t))if(!0===e(t[i]))return i}(e,this.getValue().entities)),this.select(e=>e.entities).pipe(ve(fa(i,t)),Te())}getEntity(e){return this.getValue().entities[e]}selectActiveId(){return this.select(e=>e.active)}getActiveId(){return this.getValue().active}selectActive(t){return jt(this.getActive())?this.selectActiveId().pipe(Ae(e=>this.selectMany(e,t))):this.selectActiveId().pipe(Ae(e=>this.selectEntity(e,t)))}getActive(){var e=this.getActiveId();return jt(e)?e.map(e=>this.getValue().entities[e]):ta(e)?this.getEntity(e):void 0}selectCount(e){return this.select(e=>e.entities).pipe(ve(()=>this.getCount(e)))}getCount(e){return(mn(e)?this.getAll().filter(e):this.getValue().ids).length}selectLast(e){return this.selectAt(e=>e[e.length-1],e)}selectFirst(e){return this.selectAt(e=>e[0],e)}selectEntityAction(e){var t,i;return Xt(e)?this.store.selectEntityAction$:(t=jt(e)?e=>e:e=>{e=e["ids"];return e},i=Jt(e),this.store.selectEntityAction$.pipe(Ur(e=>{e=e["type"];return i.includes(e)}),ve(e=>t(e))))}hasEntity(e){return Xt(e)?0<this.getValue().ids.length:mn(e)?this.getAll().some(e):jt(e)?e.every(e=>e in this.getValue().entities):e in this.getValue().entities}hasActive(e){var t=this.getValue().active,i=Qn(e);return Array.isArray(t)?i?t.includes(e):0<t.length:i?t===e:Qn(t)}createUIQuery(){this.ui=new ya(this.__store__.ui)}selectAt(e,t){return this.select(e=>e.ids).pipe(ve(e),Te(),Ae(e=>this.selectEntity(e,t)))}}class ya extends ga{constructor(e){super(e)}}function va(){return Math.random().toString(36).slice(2)}var Ia,Sa,ba,Ta,Aa,t="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:void 0!==hv?hv:{};(i=Ia=Ia||{})[i.Preroll=0]="Preroll",i[i.Midroll=1]="Midroll",i[i.Postroll=2]="Postroll",(i=Sa=Sa||{})[i.None=0]="None",i[i.Out=1]="Out",i[i.In=2]="In",i[i.InOut=3]="InOut",(i=ba=ba||{})[i.None=0]="None",i[i.Skip=1]="Skip",i[i.Jump=4]="Jump",i[i.SkipJump=5]="SkipJump",(i=Ta=Ta||{})[i.Highlight=0]="Highlight",i[i.Primary=1]="Primary",(i=Aa=Aa||{})[i.Point=0]="Point",i[i.Range=1]="Range";const Ea=()=>{var t={usedJSHeapSize:0,jsHeapSizeLimit:0,totalJSHeapSize:0};try{return(window.performance||{}).memory||t}catch(e){return t}},Oa=["SDR","PQ","HLG"];function wa(e){return"bitrate"in e}const Ra=/^(?:[^\/;?#]+:)?(?:\/\/)?([^\/\;?#]*)/,Ma=/^((?:[^\/;?#]+:)?)(\/\/[^\/\;?#]*)?(.*?)??(;.*?)?(\?.*?)?(#.*?)?$/,Pa=/^([^\/;?#]*)(.*)$/,Ca=/(?:\/|^)\.(?=\/)/g,ka=/(?:\/|^)\.\.\/(?!\.\.\/).*?(?=\/)/g,La={buildAbsoluteURL:function(e,t,i){if(i=i||{},e=e.trim(),0===(t=t.trim()).length){if(!i.alwaysNormalize)return e;const t=La.parseURL(e);if(t)return t.path=La.normalizePath(null!=(r=t.path)?r:""),La.buildURLFromParts(t);throw new me(!0,pe.URLParseError)}var r=La.parseURL(t);if(!r)throw new me(!0,pe.URLParseError);if(r.scheme)return i.alwaysNormalize?(r.path=La.normalizePath(null!=(n=r.path)?n:""),La.buildURLFromParts(r)):t;var n=La.parseURL(e);if(!n)throw new me(!0,pe.URLParseError);if(!n.netLoc&&n.path&&"/"!==n.path[0]){const e=Pa.exec(n.path);n.netLoc=null==e?void 0:e[1],n.path=null==e?void 0:e[2]}n.netLoc&&!n.path&&(n.path="/");var a={scheme:n.scheme,netLoc:r.netLoc,path:null,params:r.params,query:r.query,fragment:r.fragment};if(!r.netLoc&&(a.netLoc=n.netLoc,"/"!==(null==(t=r.path)?void 0:t[0])))if(r.path){const e=n.path,t=(null==e?void 0:e.substring(0,e.lastIndexOf("/")+1))+r.path;a.path=La.normalizePath(t)}else a.path=n.path,r.params||(a.params=n.params,r.query)||(a.query=n.query);return null===a.path&&(a.path=i.alwaysNormalize?La.normalizePath(null!=(e=r.path)?e:""):r.path),La.buildURLFromParts(a)},parseURL:function(e){e=Ma.exec(e);return e?{scheme:e[1]||"",netLoc:e[2]||"",path:e[3]||"",params:e[4]||"",query:e[5]||"",fragment:e[6]||""}:null},normalizePath:function(e){for(e=e.split("").reverse().join("").replace(Ca,"");e.length!==(e=e.replace(ka,"")).length;);return e.split("").reverse().join("")},buildURLFromParts:function(e){return e.scheme+e.netLoc+e.path+e.params+e.query+e.fragment},getHostName:function(e){if(e)return null!=(e=(e=Ra.exec(e))&&e[1])?e:""},getBaseURL:function(e){return(e=e&&La.parseURL(e))?e.scheme+e.netLoc+e.path:null}};var Da,xa,Na,Fa,Ba,Ua,_a,Va=La;function Qa(e){return null!=e&&!e.startsWith("http://")&&!e.startsWith("https://")}function Ha(e){return null!=e&&(0===e.indexOf("//")||-1!==e.indexOf("://")&&-1!==e.indexOf(".")&&-1!==e.indexOf("/")&&!(e.indexOf(":")>e.indexOf("/"))&&e.indexOf("://")<e.indexOf("."))}function qa(e,t){return Qa(e)?La.buildAbsoluteURL(t,e,{alwaysNormalize:!0}):La.buildAbsoluteURL(e,"",{alwaysNormalize:!0})}function Ka(e,t){var i;return null==e.url&&null!=e.relativeUrl?null!=(i=e.url)?i:qa(e.relativeUrl,t):e.url}function ja(e){return null!=e&&!Qa(e)&&null!=(e=La.getHostName(e))?e:null}const $a=[".*.itunes.apple.com"],Ga={deviceName:"&xapdn=",deviceModel:"&xapdm=",language:"&xapdl=",dsid:"&xapdsid=",subs:"&xapsub="};function Wa(e,t){return null==e||null==t||e===t}function za(e,t){var i,r,n=wa(e),a=wa(t),i=ja(e.url),r=t.url;return(!i||i===ja(r))&&(!n&&!a||n&&a&&Wa(e.pathwayID,t.pathwayID))}const Ya=6101,Xa=6110,Ja=6103,Za=6104,es=6105,ts=6106,is=6107,rs=6108,ns=6109,as=6111,ss=6112,os=6202,ls=6203,ds=((i=Da=Da||{}).Via="via",i.XAppleRequestUUID="x-apple-request-uuid",i.ContentHostname="ContentHostname",{avc1:1,avc3:1,hvc1:{SDR:2,HLG:10,PQ:11},hev1:{SDR:2,HLG:10,PQ:11},vp09:{SDR:3,HLG:14,PQ:13},av01:{SDR:4,HLG:15,PQ:16},dvh1:{PQ:12}}),us=4,cs=6,hs=10,ps=20,ms=((i=xa=xa||{})[i.DOVI=4]="DOVI",i[i.HEVC=3]="HEVC",i[i.VP09=2]="VP09",i[i.AVC=1]="AVC",i[i.UNKNOWN=0]="UNKNOWN",(i=Na=Na||{})[i.PQ=3]="PQ",i[i.HLG=2]="HLG",i[i.SDR=1]="SDR",i[i.UNKNOWN=0]="UNKNOWN",(i=Fa=Fa||{})[i.ALAC=7]="ALAC",i[i.FLAC=6]="FLAC",i[i.EC3=5]="EC3",i[i.AC3=4]="AC3",i[i.XHEAAC=3]="XHEAAC",i[i.AAC=2]="AAC",i[i.MP3=1]="MP3",i[i.UNKNOWN=0]="UNKNOWN",(i=Ba=Ba||{})[i.VALID=1]="VALID",i[i.INVALID=0]="INVALID",(i=Ua=Ua||{})[i.DO_NOTHING=0]="DO_NOTHING",i[i.FLUSH_ALL=1]="FLUSH_ALL",i[i.RESET_MEDIASOURCE=2]="RESET_MEDIASOURCE",[Da.Via,Da.XAppleRequestUUID]),fs=["fragLoadPolicy","keyLoadPolicy","certLoadPolicy","playlistLoadPolicy","manifestLoadPolicy","steeringManifestLoadPolicy","preloadHintLoadPolicy","partLoadPolicy"];(i=_a=_a||{}).Default="default",i.L2A="l2a";var gs,we,B,Re,ys,vs,Is,i={pollingStartMs:5e3,pollingIntervalMs:500,timeoutMs:2e3},Ss={maxNumRetry:4,retryDelayMs:0,maxRetryDelayMs:0},bs={maxNumRetry:6,retryDelayMs:1e3,maxRetryDelayMs:8e3},r={maxNumRetry:0,retryDelayMs:0,maxRetryDelayMs:0},n={maxNumRetry:0,retryDelayMs:0,maxRetryDelayMs:0},Ts={maxNumRetry:4,retryDelayMs:0,maxRetryDelayMs:0},As={maxNumRetry:3,retryDelayMs:500,maxRetryDelayMs:4e3};(a=gs=gs||{})[a.UHD=0]="UHD",a[a.HD=1]="HD",a[a.SD=2]="SD";const Es={maxNumRetry:3,retryDelayMs:1e3,maxRetryDelayMs:5e3},Os={maxNumRetry:3,retryDelayMs:0,maxRetryDelayMs:0},ws={default:{maxTimeToFirstByteMs:5e3,maxLoadTimeMs:2e4,autoRetry:!1,timeoutRetry:Os,errorRetry:Es},interstitial:{maxTimeToFirstByteMs:5e3,maxLoadTimeMs:2e4,autoRetry:!1,timeoutRetry:Os,errorRetry:Es},customURL:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,autoRetry:!1,timeoutRetry:Os,errorRetry:Es}},Rs={maxNumRetry:8,retryDelayMs:1e3,maxRetryDelayMs:2e4,backoff:"linear"},Ms=Object.assign(Object.assign({},Rs),{maxNumRetry:1}),Ps={default:{maxTimeToFirstByteMs:5e3,maxLoadTimeMs:2e4,autoRetry:!1,timeoutRetry:Ms,errorRetry:Rs},interstitial:{maxTimeToFirstByteMs:5e3,maxLoadTimeMs:2e4,autoRetry:!1,timeoutRetry:Ms,errorRetry:Rs},customURL:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,autoRetry:!1,timeoutRetry:Ms,errorRetry:Rs}},Cs={supportedStorebagVersion:"0.0.0",testGroupId:""},ks=Object.assign(Object.assign({enableContentSteering:!1,enableBoss:!0,startPosition:NaN,debug:!1,debugLevel:"info",buildType:void 0,attemptErrorRecovery:!1,useCustomURLLoaderForAuthOrCORSErrors:!1,abrTrickplayLevelLocked:!1,appendFreeBoxOnContentChange:!1,minFramesBeforeSwitchingLevel:11,minTargetDurations:3,maxBufferLength:60,maxBufferHole:.5,maxSeekHole:2,nudgeFromEventSeek:!0,jaggedSeekTolerance:0,appendTimeoutMs:1e4,discontinuitySeekTolerance:2,bufferedSegmentEjectionToleranceMs:.5,almostDryBufferSec:.5,maxTotalDurationTolerance:.1,changeType:!1,preferManagedMediaSource:!0,lowBufferThreshold:.5,lowBufferWatchdogPeriod:.5,highBufferWatchdogPeriod:3,seekWatchdogPeriod:5,nudgeOffset:.1,nudgeMaxRetry:3,maxFragLookUpTolerance:.2,liveSyncDurationCount:3,liveSyncDuration:void 0,liveMaxUnchangedPlaylistRefresh:3,liveEdgeForZeroStartPositon:!1,liveAllowTrickplay:!1,livePlaylistUpdateStaleness:2,liveAllowLowLatencyPlayback:!1,livePreloadHintCacheAge:6,liveLowLatencyThreshold:6,allowFastSwitchUp:!1,minQualityRatioForFastSwitchUp:2,attemptNextFragPreload:!0,desiredIframeFPS:8,leftMediaTimeToAutoPause:10,startTargetDurationFactor:.9,minRequiredStartDuration:4,minRequiredStartDurationLLHLS:2,maxRequiredStartDuration:15,instantBwDurationFactor:.5,enableWorker:!0,enableWebCrypto:!0,keySystemPreference:void 0,useMultipleKeySessions:!1,enablePlayReadyKeySystem:!1,useMediaKeySystemAccessFilter:!1,playReadyMessageFormat:"utf16",widevineProactiveRenewal:!0,allowKeySwitch:!0,livePlaylistRefreshDelay:2500,liveMinPlayingBufferLen:5,enableIFramePreloading:!0,enableItemPreloading:!1,enableInterstitialPlayback:!1,livePlaylistPreloadDelayMs:250,allowInterstitialAssetListDownload:!0,allowServerGeneratedInterstitials:!0,forcePauseOnInterstitialBoundary:!1,adjustedSeekToleranceMs:500,enablePartialInterstitialPlaybackForLiveEdge:!1,interstitialsConfiguredForAirPlayReceiver:!1,interstitialEarlyStartMs:0,abuttingInterstitialThresholdMs:33,useMediaCapabilities:!1,enableID3Cues:!0,certLoadPolicy:ws,keyLoadPolicy:Ps,manifestLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,autoRetry:!1,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}},interstitial:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,autoRetry:!1,timeoutRetry:{maxNumRetry:0,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:0,retryDelayMs:0,maxRetryDelayMs:0}},customURL:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:1e4,autoRetry:!1,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},trickPlaybackConfig:{enabled:!0,minIframeDuration:8},minSteeringRunway:2,partialAppendDurationSec:0,replaceItemAction:Ua.RESET_MEDIASOURCE},Cs),{playlistLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,autoRetry:!1,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:2,retryDelayMs:1e3,maxRetryDelayMs:8e3}},interstitial:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,autoRetry:!1,timeoutRetry:{maxNumRetry:0,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:0,retryDelayMs:0,maxRetryDelayMs:0}},customURL:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:1e4,autoRetry:!1,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:2,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},fragLoadPolicy:{default:{maxTimeToFirstByteMs:5e3,autoRetry:!1,timeoutRetry:Ss,errorRetry:bs,forceContentLenCheckIfNoHeader:!1,reportCDNServer:!0,requestStallConfig:i},interstitial:{maxTimeToFirstByteMs:5e3,autoRetry:!1,timeoutRetry:{maxNumRetry:0,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:0,retryDelayMs:0,maxRetryDelayMs:0},forceContentLenCheckIfNoHeader:!1,reportCDNServer:!0,requestStallConfig:i},customURL:{maxTimeToFirstByteMs:1e4,autoRetry:!1,timeoutRetry:Ss,errorRetry:bs,reportCDNServer:!0,requestStallConfig:i}},steeringManifestLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,autoRetry:!1,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}},interstitial:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,autoRetry:!1,timeoutRetry:{maxNumRetry:0,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:0,retryDelayMs:0,maxRetryDelayMs:0}},customURL:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:1e4,autoRetry:!1,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},preloadHintLoadPolicy:{default:{maxTimeToFirstByteMs:3e3,autoRetry:!1,timeoutRetry:r,errorRetry:n,forceContentLenCheckIfNoHeader:!1,reportCDNServer:!0},interstitial:{maxTimeToFirstByteMs:3e3,autoRetry:!1,timeoutRetry:r,errorRetry:n,forceContentLenCheckIfNoHeader:!1,reportCDNServer:!0},customURL:{maxTimeToFirstByteMs:3e3,autoRetry:!1,timeoutRetry:r,errorRetry:n,reportCDNServer:!0}},partLoadPolicy:{default:{maxTimeToFirstByteMs:2500,autoRetry:!1,timeoutRetry:Ts,errorRetry:As,forceContentLenCheckIfNoHeader:!1,reportCDNServer:!0},interstitial:{maxTimeToFirstByteMs:2500,autoRetry:!1,timeoutRetry:Ts,errorRetry:As,forceContentLenCheckIfNoHeader:!1,reportCDNServer:!0},customURL:{maxTimeToFirstByteMs:5e3,autoRetry:!1,timeoutRetry:Ts,errorRetry:As,reportCDNServer:!0}},maxNumAddLevelToPenaltyBox:4,firstAudioMustOverlapVideoStart:!1,keyMinHoldTimeBeforeCleanup:15e3,keyPrefetchMinHoldTimeBeforeCleanup:3e5,appendErrorMaxRetry:3,xhrSetup:void 0,audioPrimingDelay:0,remuxSampleAuxiliaryInfo:!1,enableCEA708Captions:!0,customTextTrackCueRenderer:!1,enableWebVTT:!0,captionsTextTrack1Label:"English",captionsTextTrack1LanguageCode:"en",captionsTextTrack2Label:"Spanish",captionsTextTrack2LanguageCode:"es",condenseSubtitleTrack:!1,nativeTextTrackChangeHandling:!0,earlyFragTolerance:7,vttConcurrentLoadCount:1,trottleCheckInterval:2e3,subtitleLeadTime:30,lateTolerance:2,dynamicTextTrackCreation:!1,stretchShortVideoTrack:!1,forceKeyFrameOnDiscontinuity:!0,abrAlgorithm:_a.Default,abrBandWidthFactor:.95,abrBandWidthUpFactor:.9,abrLowSampleCount:3,abrLowSampleBandwidthFactor:.7,abrSamplePeriodMs:200,abrSafeDurationCountForPeakBitrate:2.5,maxStarvationDelay:4,useStickyAtmosFilter:!1,resolutionLimits:{[gs.SD]:{maxWidth:858,maxHeight:576},[gs.HD]:{maxWidth:3440,maxHeight:1440},[gs.UHD]:{maxWidth:1/0,maxHeight:1/0}},enableRtcReporting:!1,rtcIntervalTimeout:3e5,rtcLogHistoryNumLines:0,rtcLogHistoryMaxLineLength:200,rtcExcludeKeysList:[],rtcFragInfoWindowSize:10,rtcUseSendBeacon:!1,useHTTPPlaybackSessionId:!1,warmupCdms:!1,createDummySessionOnStart:!1,maintainMediaKeysBetweenSessions:!0,enablePerformanceLogging:!1,rtcErrStackNumLines:0,overridePlaybackRate:!1,nativeControlsEnabled:!1,useCustomMediaFunctions:!0,timeAccuracyThresholdSeconds:.25,contentGapPlaythroughIntervalSeconds:.5,enableAdaptiveStartup:!0,heuristicStartupRestrictions:{minValidBitrate:2e6,maxValidBitrate:5e6,maxPreferredBitrate:3e6,minValidHeight:400,maxValidHeight:800},bandwidthHistoryWindowSize:12e4,bandwidthHistoryTTL:6e5,bandwidthHistoryAggregationMethod:"quadratic-time-weighted",bandwidthHistoryMinStableEntrySizeBits:5e4,defaultTargetDuration:10,defaultPartTargetDuration:1,targetStartupMs:4e3,bandwidthHistoryStorageKey:"AppleHLS-bandwidth-estimation",storageKeyPrefix:"AppleHLS-",storage:{get:"undefined"==typeof localStorage?void 0:localStorage.getItem.bind(localStorage),set:"undefined"==typeof localStorage?void 0:localStorage.setItem.bind(localStorage)},minFragmentCount:1,minPlaylistCount:1,enableQueryParamsForITunes:!1,gapless:!1,supportGaplessVideo:!1,useViewportSizeForLevelCap:!1,statDefaults:{playlistLoadTimeMs:500,playlistParseTimeMs:50,fragParseTimeMs:100,fragBufferCreationDelayMs:200,dataFragAppendMs:100,initFragAppendMs:100},disableVideoCodecList:new Set([]),disableAudioCodecList:new Set([Fa.ALAC,Fa.FLAC,Fa.XHEAAC]),useHighestVideoCodecPrivate:!0,sessionDataAutoLoad:{"com.apple.hls.chapters":!0,"_hls.localized-rendition-names":!0},canUseNetworkResourcesForLiveStreamingWhilePaused:!1,liveResumeAtWindowStart:!1,liveOldCueRemovalOffsetSec:600}),Ls=s=>(e,t,i)=>{let r=0,n=0;for(const{timestamp:i,value:a}of e){const e=Math.pow(Math.max(0,i-t)/1e3,s);r+=e*a,n+=e}return r/n},Ds={"uniform-time-weighted":Ls(0),"linear-time-weighted":Ls(1),"quadratic-time-weighted":Ls(2),"quadratic-window-weighted":(e,t,i)=>{let r=0,n=0;for(var{timestamp:a,value:s,duration:o}of e){const e=Math.pow(Math.max(0,a-t)/1e3,2)*o/i;r+=e*s,n+=e}return r/n}},xs="default-stats";function Ns(e){return null!=(e=e.serviceName)?e:xs}const Fs={itemId:"Nah",mediaOptionId:"Nah"},Me=Object.assign(Object.assign({},Fs),{mediaOptionType:void 0}),Bs=e=>{var{itemId:e,mediaOptionId:t}=e;return"Nah"!==e&&"Nah"!==t};function Us(e){return null!=e&&null!=e.relativeUrl}const _s=(e,t)=>e.itemId===t.itemId&&e.mediaOptionId===t.mediaOptionId,Vs=((a=we=we||{})[a.Variant=0]="Variant",a[a.AltAudio=1]="AltAudio",a[a.Subtitle=2]="Subtitle",["variant","altAudio","subtitle"]),Qs=[we.Variant,we.AltAudio,we.Subtitle],Hs=[we.Variant,we.AltAudio],qs=((Ss=B=B||{})[Ss.Variant=0]="Variant",Ss[Ss.AltAudio=1]="AltAudio",["variant","altAudio"]);function Ks(e){switch(e){case we.Variant:return B.Variant;case we.AltAudio:return B.AltAudio;default:return null}}function js(e){return e===B.Variant?we.Variant:we.AltAudio}class $s{constructor(e=0){this.Se=e,this.we=[]}recordLogs(e){this.Se&&(e={timestampMs:e.ts,messages:e.messages,level:e.level.value},this.we.push(e),this.we.length>this.Se)&&this.we.shift()}getLogs(){return this.we}}(bs=void 0||{}).Loading="loading",bs.Loaded="loaded",bs.LoadError="load error",bs.CacheInsert="cache insert",bs.CacheHit="cache hit",bs.CacheCheck="cache check",(i=void 0||{}).Immediate="immediate",i.Delayed="delayed",i.EndOfRefresh="finalized",(r=Re=Re||{})[r.ContentSteeringPathwayCloner=0]="ContentSteeringPathwayCloner",r[r.PlatformFilter=1]="PlatformFilter",r[r.PermanentRemovalFilter=2]="PermanentRemovalFilter",r[r.PenaltyBoxFilter=3]="PenaltyBoxFilter",r[r.PathwayPenaltyBoxFilter=4]="PathwayPenaltyBoxFilter",r[r.CompatibleIdsFilter=5]="CompatibleIdsFilter",r[r.HDRFilter=6]="HDRFilter",r[r.ViewportFilter=7]="ViewportFilter",r[r.HDCPFilter=8]="HDCPFilter",r[r.MatchingPathwayFilter=9]="MatchingPathwayFilter",r[r.PathwayFilter=10]="PathwayFilter",r[r.ImageVariantFilter=11]="ImageVariantFilter",r[r.MediaFilterBasedOnMode=12]="MediaFilterBasedOnMode",r[r.BitrateFilter=13]="BitrateFilter",r[r.SdrOnlyFilter=14]="SdrOnlyFilter",r[r.NonIframeOnlyFilter=15]="NonIframeOnlyFilter",r[r.IframeOnlyFilter=16]="IframeOnlyFilter",r[r.ValidFallbackFilter=17]="ValidFallbackFilter",r[r.ValidAlternatesFilter=18]="ValidAlternatesFilter",r[r.ErrorHandlingValidAlternatesFilter=19]="ErrorHandlingValidAlternatesFilter",r[r.HostRankFilter=20]="HostRankFilter",r[r.MediaFilteringBasedOnImageIframes=21]="MediaFilteringBasedOnImageIframes",r[r.ResolutionTierFilter=22]="ResolutionTierFilter",r[r.PathwayRankSelector=23]="PathwayRankSelector",r[r.LowerPivotQualitySelector=24]="LowerPivotQualitySelector",r[r.HigherPivotQualitySelector=25]="HigherPivotQualitySelector",r[r.LowerQualitySelector=26]="LowerQualitySelector",r[r.HigherQualitySelector=27]="HigherQualitySelector",r[r.PivotAudioGroupSelector=28]="PivotAudioGroupSelector",r[r.FirstLevelSelector=29]="FirstLevelSelector",r[r.FallbackSelector=30]="FallbackSelector",r[r.QualitySelector=31]="QualitySelector",r[r.BestAbrLevelSelector=32]="BestAbrLevelSelector",r[r.GenericTransformer=33]="GenericTransformer",(n=ys=ys||{})[n.ABR=0]="ABR",n[n.ABRLowestLevel=1]="ABRLowestLevel",n[n.ABRIframe=2]="ABRIframe",n[n.ABRIframeLowestLevel=3]="ABRIframeLowestLevel",n[n.ErrorHandling=4]="ErrorHandling",n[n.FirstSelection=5]="FirstSelection",n[n.FirstSelectionIframe=6]="FirstSelectionIframe",n[n.ImageVariant=7]="ImageVariant",n[n.ErrorHandlingSdrOnly=8]="ErrorHandlingSdrOnly",n[n.MaybeCompatibleOptions=9]="MaybeCompatibleOptions";class Gs{constructor(e,t={}){this.variants=e,this.generation=t}}(Ts=vs=vs||{})[Ts.NO=0]="NO",Ts[Ts.YES=1]="YES",(As=Is=Is||{}).UNKNOWN="unkn",As.VIDEO="vide",As.AUDIO="soun",As.SUBTITLE="sbtl",As.CLOSEDCAPTION="clcp";class Ws{constructor(){this.Ie=null,this.Te=null,this.Oe=null}get forward(){var e;return 0<(null!=(e=null==(e=this.timeline)?void 0:e.rate)?e:0)}get isStarted(){return Boolean(this.Ie)}start(e){this.Oe=null,this.Te=Object.assign({},e);const t={rootTimeSeconds:performance.now()/1e3,rate:1};this.Ie={timeline:t,getCurrentTime:()=>({seconds:performance.now()/1e3,timeline:t})}}pause(){this.isStarted&&(this.Oe=this.getCurrentTime())}stop(){this.pause(),this.Ie=null,this.Te=null}get timeline(){return this.Te}getCurrentTime(){var e,t,i;return this.Oe||(this.Ie&&(e=this.Ie.getCurrentTime())&&this.timeline?(t=this.timeline,i=e.timeline,{seconds:(e.seconds-i.rootTimeSeconds)/i.rate*t.rate+t.rootTimeSeconds,timeline:t}):null)}}class zs extends Error{constructor(e,t,i=!1){super(e),this.statusCode=t,this.isCustomUrl=i}get isAuthOrCorsError(){return 401===this.statusCode||403===this.statusCode||407===this.statusCode||0===this.statusCode||this.statusCode===pe.XhrSetupNetworkError}}class Ys extends v{constructor(e,t,i,r=!1,n,a){super(K.NETWORK_ERROR,e,t,i,a),this.isCustomUrl=r,this.timeoutType=n,this.response=i}get isTimeout(){return void 0!==this.timeoutType}}class Xs extends Ys{constructor(e,t,i=!1,r,n){super(void 0!==r?q.MANIFEST_LOAD_TIMEOUT:q.MANIFEST_LOAD_ERROR,e,t,i,r,n)}}class Js extends Ys{constructor(e,t,i,r,n,a,s){super(function(e){switch(i){case we.Variant:return e?q.LEVEL_LOAD_TIMEOUT:q.LEVEL_LOAD_ERROR;case we.AltAudio:return e?q.AUDIO_TRACK_LOAD_TIMEOUT:q.AUDIO_TRACK_LOAD_ERROR;case we.Subtitle:return e?q.SUBTITLE_TRACK_LOAD_TIMEOUT:q.SUBTITLE_TRACK_LOAD_ERROR}return q.UNKNOWN}(void 0!==a),e,t,Qa(n),a,s),this.mediaOptionType=i,this.mediaOptionId=r,this.url=n}}class Zs extends Ys{constructor(e,t,i=!1,r){super(q.SESSION_DATA_LOAD_ERROR,e,t,i,void 0,r)}}class eo extends Ys{constructor(e,t,i,r=!1,n,a,s){super(void 0!==a?q.FRAG_LOAD_TIMEOUT:q.FRAG_LOAD_ERROR,e,t,r,a,s),this.mediaOptionId=i.mediaOptionId,this.mediaOptionType=i.mediaOptionType,this.stats=n}}class to extends Error{constructor(e,t,i=!1,r){super(),this.message=e,this.isCustomUrl=i,this.timeoutType=r,this.stats=t}}class io extends Ys{constructor(e,t,i,r,n,a=!1){super(q.FRAG_ABORT_ERROR,!1,n,a),this.candidateMediaOptions=t,this.bwSample=i,this.fragId=r,this.mediaOptionId=e.mediaOptionId,this.mediaOptionType=e.mediaOptionType}}class ro extends Ys{constructor(e,t,i=!1,r){super(void 0!==r?q.CERT_LOAD_TIMEOUT:q.CERT_LOAD_ERROR,e,t,i,r)}}function no(e,t){return!e.url||Qa(e.url)?t.customURL:t.default}function ao(e,t){let i;return e instanceof Ys?i=e.isTimeout?t.timeoutRetry:t.errorRetry:e instanceof dn?i=t.timeoutRetry:e instanceof zs&&(i=t.errorRetry),i}function so(t,i,r,n){return e=>e.pipe(ye(e=>{if(e instanceof to)throw new Js(r,pe.PlaylistTimeoutError,t,i,n,e.timeoutType);if(e instanceof zs)throw new Js(r,e.statusCode,t,i,n,void 0,e.message);throw e}))}function oo(t,i){return e=>e.pipe(ye(e=>{if(e instanceof to)throw new eo(i,pe.FragmentTimeoutError,t,e.isCustomUrl,e.stats,e.timeoutType);if(e instanceof zs)throw new eo(i,e.statusCode,t,e.isCustomUrl,void 0,void 0,e.message);throw e}))}function lo(e){var t=e.type,i=e.liveOrEvent;let r="VOD";"EVENT"===t&&i?r="EVENT":t&&0!==t.length&&"LIVE"!==t||!i||(r="LIVE"),e.type!==r&&(e.type=r)}function uo(e,t,i,r,n){t=co(e,t,r);return i.load(e,t).pipe(ye(e=>e instanceof zs&&e.isAuthOrCorsError?Fr(new zs(`Tried to recover via customUrl, but got auth or cors error: originalStatus=${n.statusCode} retryStatus=`+e.statusCode,e.statusCode,!0)):Fr(e)))}function co(e,t,i){var e=e["extendMaxTTFB"],{maxLoadTimeMs:r,maxTimeToFirstByteMs:n}=t,r=(null!=r?r:0)-(performance.now()-i),e=fe(e)&&0<e?e:n-(performance.now()-i);return Object.assign(Object.assign({},t),{maxLoadTimeMs:r,maxTimeToFirstByteMs:e})}const ho=/(\d+)-(\d+)\/(\d+)/,po=/^CDN-Server:/im,mo=/^Age/im,fo=/^$/;function go(e,t,i){const r=setInterval(()=>{!0===t()&&clearInterval(r)},i);e.push(()=>clearInterval(r)),r}function yo(e,t,i){const r=setTimeout(t,i);e.push(()=>clearTimeout(r)),r}function vo(g,y){return Mn(function(){const e=g["extendMaxTTFB"],{maxTimeToFirstByteMs:i,maxLoadTimeMs:t,requestStallConfig:s}=y,o=new $r,l=[];let r=new XMLHttpRequest;const d={trequest:performance.now(),tfirst:NaN,tload:NaN,tdataack:NaN,loaded:0,total:NaN,complete:!1};let u=NaN;const n=[{name:"readystatechange",listener:function e(){var t=this.readyState,i=performance.now();if(!(t<2)&&(isNaN(d.tfirst)&&(d.tfirst=i),3<=t)&&isNaN(u)){if(u=i,s){const{pollingStartMs:r,pollingIntervalMs:n,timeoutMs:a}=s;yo(l,()=>{go(l,()=>performance.now()-u>=a&&(o.error(new to(`No download progress made after ${a} ms`,d,!1,"RequestStall")),!0),n)},r)}this.removeEventListener("readystatechange",e)}}},{name:"loadend",listener:function(){if(d.complete=!0,200<=this.status&&this.status<300){d.tload=performance.now();var e=this.getAllResponseHeaders().toLowerCase();if(d.contentType=Io(this,"Content-Type",e)||void 0,y.reportCDNServer&&po.test(e)&&(d.cdnServer=this.getResponseHeader("CDN-Server")||void 0),d.contentLength=y.forceContentLenCheckIfNoHeader?function(e,t){let i;var r=Io(e,"Content-Encoding",t),n=Io(e,"Transfer-Encoding",t),r=!r||"identity"===r.toLowerCase(),n=!n||"identity"===n.toLowerCase();return r&&n&&(fe(i=function(e){e=ho.exec(e||"");return e?parseInt(e[2])-parseInt(e[1])+1:void 0}(Io(e,"Content-Range",t)))||(i=parseInt(null!=(r=Io(e,"Content-Length",t))?r:""))),i}(this,e):void 0,i=this,n=e,(r=g).collectServerInstanceInfo&&(r.serverInstanceInfo={},r.collectServerInstanceInfo.forEach(e=>{var t;r.serverInstanceInfo&&(t=Io(i,e,n))&&(r.serverInstanceInfo[e]=t)})),"arraybuffer"===g.responseType)d.loaded=this.response.byteLength;else if(d.loaded=this.responseText.length,mo.test(e)){const g=this.getResponseHeader("Age");d.age=g?parseInt(g):NaN}else d.age=NaN;d.tdataack=performance.now(),d.total=d.loaded,g.checkContentLength&&(0===d.total||fe(d.contentLength)&&d.total!=d.contentLength)&&o.error(new zs("Network error",this.status,!1));e=[this,d];o.next(e)}else o.error(new zs("Network error",this.status,!1));var i,r,n;o.complete(),fo.test("")}},{name:"progress",listener:function(e){var{loaded:e,total:t,lengthComputable:i}=e;d.loaded<e&&(u=performance.now()),d.loaded=e,i&&(d.total=t)}}],a=g.onProgress;if(a){const y=a.cb,e=a.samplePeriodMs,i=a.getData;if(fe(e))go(l,function(){let t=!1;try{t=y(g.url,r.status,d,i?r.response:void 0)}catch(e){t=!0,o.error(e)}return t},e);else{const e=function(){let t=!1;try{t=y(g.url,this.status,d,i?this.response:void 0)}catch(e){t=!0,o.error(e)}t&&this.removeEventListener("progress",e)};n.push({name:"progress",listener:e})}}for(const{name:g,listener:y}of n)r.addEventListener(g,y);var{url:c,method:h,byteRangeOffset:p,responseType:m,body:f}=g;g.mimeType&&r.overrideMimeType(g.mimeType);try{const y=g.xhrSetup;r.open(h,g.url,!0),y&&y(r,c)}catch(e){o.error(new zs(e.message,0===r.status?pe.XhrSetupNetworkError:r.status,!1))}if(r.responseType=m,p&&fe(p.start)&&fe(p.end)&&0<=p.start&&p.end>p.start){const{start:g,end:y}=p;r.setRequestHeader("Range",`bytes=${g}-`+(y-1))}if(g.headers)for(const[y,e]of Object.entries(g.headers))r.setRequestHeader(y,e);if("POST"===h&&f?r.send(f):r.send(),isFinite(i)&&0<i){const g=fe(e)&&0<e?e:i;yo(l,()=>{fe(d.tfirst)||o.error(new to("TTFB Timeout",d,!1,"TTFB"))},g)}return fe(t)&&0<t&&yo(l,()=>{fe(d.tload)||o.error(new to("Max load timeout",d,!1,"MaxLoad"))},t),o.pipe(ye(function(e){if(e instanceof v)throw e;if(e instanceof dn)throw new to(e.message,d,!1,"Other");if(e instanceof zs||e instanceof to)throw e;throw new zs(e.message,pe.XhrError,!1)}),Hr(()=>{r.abort();for(const i of l)"function"==typeof i?i():(i instanceof ci||"object"==typeof i&&"unsubscribe"in i)&&i.unsubscribe();for(var{name:e,listener:t}of n)r.removeEventListener(e,t);r=void 0}))})}function Io(e,t,i){return 0<=i.indexOf(t.toLowerCase())?e.getResponseHeader(t):null}function So(t){return e=>e.pipe(ve(e=>{return[e.response.data,e.stats,null!=(e=t.serverInstanceInfo)?e:{}]}))}function bo(t,i,r){const n=Object.assign(Object.assign({},t),{method:"GET",responseType:"arraybuffer"});if(Qa(n.url))return r.load(n,i).pipe(So(n));{const t=performance.now(),e=vo(n,i).pipe(ve(([e,t])=>{return[e.response,t,null!=(e=n.serverInstanceInfo)?e:{}]}));return e.pipe(ye(e=>{if(r.retryErrorAsCustomURL&&e instanceof zs&&e.isAuthOrCorsError)return uo(n,i,r,t,e).pipe(So(n));throw e}))}}const To=(r,e,t,i,n,a,s,o,l,d)=>{const{relativeUrl:u,byteRangeOffset:c,keyTagInfo:h,iframe:p,isInitSegment:m}=r,f=Va.buildAbsoluteURL(e,u,{alwaysNormalize:!0}),g=null!=(e=null==h?void 0:h.method)?e:"NONE",{start:y,end:v}=null!=c?c:{},I=no({url:f},n);let S,b=y,T=v,A=!1,E=fe(y)||fe(v)?c:void 0;if("AES-128"===g&&v&&(p||m)){const r=v-(null!=y?y:0);r%16&&(T=v+(16-r%16)),fe(y)&&0!==y&&(A=!0,b=y-16),fe(b)&&fe(T)&&(E={start:b,end:T})}return l&&fe(r.mediaSeqNum)&&r.mediaOptionType===we.Variant&&(S=[],null!=(e=I.reportHTTPResponseHeaders)&&e.forEach(function(e){ms.includes(e)&&Array.isArray(S)&&S.push(e)}),0===S.length)&&(S=void 0),bo({url:f,byteRangeOffset:E,checkContentLength:!0,extendMaxTTFB:d,collectServerInstanceInfo:S,onProgress:o,xhrSetup:i.xhrSetup,appItemId:t},I,a).pipe(ve(([e,t,i])=>{if(A){const t=e;r.keyTagInfo&&(r.keyTagInfo.iv=new Uint8Array(t.slice(0,16))),e=t.slice(16)}return i[Da.ContentHostname]=Va.getHostName(f),{mediaFragment:r,loadedData:$(e),bwSample:t,serverInfo:i}}),oo(r,!1))},Ao={search:function(e,t){let i,r,n=0,a=(null==e?void 0:e.length)-1;for(;n<=a;){var s=t(r=e[i=(n+a)/2|0]);if(0<s)n=i+1;else{if(!(s<0))return r;a=i-1}}}};var Eo,Oo,wo=Ao;class Ro extends da{constructor(){super({interstitials:[],interstitialAssets:[],pastInterstitials:[],activeInterstitialId:null,activeInterstitialAssetId:null,playingInterstitialId:null,playingInterstitialAssetId:null,realCurrentTimeOffsetMap:{},interstitialAltAudioSelectedMatchingInfoMap:{},interstitialSubtitleSelectedMatchingInfoMap:{},interstitialAssetAltAudioSelectedMatchingInfoMap:{},interstitialAssetSubtitleSelectedMatchingInfoMap:{},integratedTimeline:Ro.defaultIntegratedTimeline},{name:"interstitials",resettable:!0})}}Ro.defaultIntegratedTimeline={duration:NaN,segments:[]};class Mo extends ma{constructor(e){super(e),this.store=e,this.interstitials$=this.select("interstitials"),this.pastInterstitials$=this.select("pastInterstitials"),this.interstitialAssets$=this.select("interstitialAssets"),this.activeInterstitialId$=this.select("activeInterstitialId"),this.activeInterstitialAssetId$=this.select("activeInterstitialAssetId"),this.playingInterstitialId$=this.select("playingInterstitialId"),this.playingInterstitialAssetId$=this.select("playingInterstitialAssetId"),this.interstitialAltAudioSelectedMatchingInfoMap$=this.select("interstitialAltAudioSelectedMatchingInfoMap"),this.interstitialSubtitleSelectedMatchingInfoMap$=this.select("interstitialSubtitleSelectedMatchingInfoMap"),this.interstitialAssetAltAudioSelectedMatchingInfoMap$=this.select("interstitialAssetAltAudioSelectedMatchingInfoMap"),this.interstitialAssetSubtitleSelectedMatchingInfoMap$=this.select("interstitialAssetSubtitleSelectedMatchingInfoMap"),this.integratedTimeline$=this.select("integratedTimeline")}getInterstitialForId(t){var e;return null!=(e=null==(e=this.getValue())?void 0:e.interstitials.find(e=>e.identifier===t))?e:null}getInterstitialAssetForId(t){var e;return null!=(e=null==(e=this.getValue())?void 0:e.interstitialAssets.find(e=>e.identifier===t))?e:null}get interstitials(){var e;return null!=(e=null==(e=this.getValue())?void 0:e.interstitials)?e:[]}get pastInterstitials(){var e;return null!=(e=null==(e=this.getValue())?void 0:e.pastInterstitials)?e:[]}get interstitialAssets(){var e;return null!=(e=null==(e=this.getValue())?void 0:e.interstitialAssets)?e:[]}get activeInterstitialId(){var e;return null!=(e=null==(e=this.getValue())?void 0:e.activeInterstitialId)?e:null}get activeInterstitialAssetId(){var e;return null!=(e=null==(e=this.getValue())?void 0:e.activeInterstitialAssetId)?e:null}get playingInterstitialId(){var e;return null!=(e=null==(e=this.getValue())?void 0:e.playingInterstitialId)?e:null}get playingInterstitialAssetId(){var e;return null!=(e=null==(e=this.getValue())?void 0:e.playingInterstitialAssetId)?e:null}get playableInterstitials$(){return this.interstitials$.pipe(ve(e=>e.filter(e=>this.ke(e))))}get playableInterstitials(){return this.interstitials.filter(e=>this.ke(e))}get playableInterstitialsForSeek(){return this.interstitials.filter(e=>!e.hasPlayed||e.hasPlayed&&!e.playOnce).reverse()}get integratedTimeline(){var e;return null!=(e=null==(e=this.getValue())?void 0:e.integratedTimeline)?e:Ro.defaultIntegratedTimeline}get realCurrentTimeOffsetMap(){var e;return null!=(e=null==(e=this.getValue())?void 0:e.realCurrentTimeOffsetMap)?e:{}}get interstitialAltAudioSelectedMatchingInfoMap(){var e;return null!=(e=null==(e=this.getValue())?void 0:e.interstitialAltAudioSelectedMatchingInfoMap)?e:{}}get interstitialAssetAltAudioSelectedMatchingInfoMap(){var e;return null!=(e=null==(e=this.getValue())?void 0:e.interstitialAssetAltAudioSelectedMatchingInfoMap)?e:{}}getAlternateMatchingInfoForInterstitialId(e){return{audioMatchingInfo:this.getAltAudioSelectedMatchingInfoForInterstitialId(e),subtitleMatchingInfo:this.getSubtitleSelectedMatchingInfoForInterstitialId(e)}}getAlternateMatchingInfoForInterstitialAssetId(e,t){return{audioMatchingInfo:this.getAltAudioSelectedMatchingInfoForInterstitialAssetId(e,t),subtitleMatchingInfo:this.getSubtitleSelectedMatchingInfoForInterstitialAssetId(e,t)}}getAltAudioSelectedMatchingInfoForInterstitialId(e){var t;return null==(t=this.getValue())?void 0:t.interstitialAltAudioSelectedMatchingInfoMap[e]}getAltAudioSelectedMatchingInfoForInterstitialAssetId(e,t){var i=this.getValue();return null!=(e=null==i?void 0:i.interstitialAssetAltAudioSelectedMatchingInfoMap[e])?e:null==i?void 0:i.interstitialAltAudioSelectedMatchingInfoMap[t]}get interstitialSubtitleSelectedMatchingInfoMap(){var e;return null!=(e=null==(e=this.getValue())?void 0:e.interstitialSubtitleSelectedMatchingInfoMap)?e:{}}get interstitialAssetSubtitleSelectedMatchingInfoMap(){var e;return null!=(e=null==(e=this.getValue())?void 0:e.interstitialAssetSubtitleSelectedMatchingInfoMap)?e:{}}getSubtitleSelectedMatchingInfoForInterstitialId(e){var t;return null==(t=this.getValue())?void 0:t.interstitialSubtitleSelectedMatchingInfoMap[e]}getSubtitleSelectedMatchingInfoForInterstitialAssetId(e,t){var i=this.getValue();return null!=(e=null==i?void 0:i.interstitialAssetSubtitleSelectedMatchingInfoMap[e])?e:i.interstitialSubtitleSelectedMatchingInfoMap[t]}ke(e){var t=!e.hasPlayed||e.hasPlayed&&!e.playOnce,e=this.pastInterstitials.includes(e.identifier);return!(!t||e)}}class Po{constructor(e){this.Me=e,this.Ae=new Mo(e)}get interstitialQuery(){return this.Ae}addInterstitials(e){const t=this.Ae.interstitials.reduce((e,t)=>(e[t.identifier]=!0,e),{}),i=e.filter(e=>!t[e.identifier]);this.Me.update(({interstitials:e})=>({interstitials:Zt(e,i)}))}updateInterstitial(t,i){this.Me.update(({interstitials:e})=>({interstitials:vn(e,t,i,"identifier")}))}removeInterstitials(t){this.Me.update(({interstitials:e})=>({interstitials:yn(e,t,"identifier")}))}addInterstitialToPastEvents(t){this.Me.update(({pastInterstitials:e})=>({pastInterstitials:function(e,t,i,r){var n=3<arguments.length&&void 0!==r?r:hn,a=gn(i);return e.some(e=>a?e[n]===t:e===t)?vn(e,t,i,n):Zt(e,a?S(S({},i),{},{[n]:t}):i)}(e,t,t,"identifier")}))}removeInterstitialsFromPastEvents(t){this.Me.update(({pastInterstitials:e})=>({pastInterstitials:yn(e,t,"identifier")}))}removeInterstitialsFromPastEventsFromTime(r){var e=this.Ae.interstitials.reduce((e,t)=>{var i;return C(null!=(i=t.startTime)?i:{baseTime:0,timescale:1})>=r&&t.cueType===Ia.Midroll&&e.push(t.identifier),e},new Array);this.removeInterstitialsFromPastEvents(e)}addInterstitialAsset(t){this.interstitialQuery.interstitialAssets.find(e=>e.identifier===t.identifier)||this.Me.update(({interstitialAssets:e})=>({interstitialAssets:Zt(e,t)}))}updateInterstitialAsset(t,i){this.Me.update(({interstitialAssets:e})=>({interstitialAssets:vn(e,t,i,"identifier")}))}removeInterstitialAssets(t){this.Me.update(({interstitialAssets:e})=>({interstitialAssets:yn(e,t,"identifier")}))}setActiveInterstitialId(t){t&&!this.Ae.interstitials.find(e=>e.identifier===t)||this.Me.update({activeInterstitialId:t})}setPlayingInterstitialId(t,e=!1){t&&!this.Ae.interstitials.find(e=>e.identifier===t)&&!e||this.Me.update({playingInterstitialId:t})}setActiveInterstitialAssetId(t){t&&!this.Ae.interstitialAssets.find(e=>e.identifier===t)||this.Me.update({activeInterstitialAssetId:t})}setPlayingInterstitialAssetId(t,e=!1){t&&!this.Ae.interstitialAssets.find(e=>e.identifier===t)&&!e||this.Me.update({playingInterstitialAssetId:t})}updateRealCurrentTimeOffsetMap(e,t){var i=Object.assign({},this.Ae.realCurrentTimeOffsetMap);i[e]=t,this.Me.update({realCurrentTimeOffsetMap:i})}clearRealCurrentTimeOffsetMap(e){var t=Object.assign({},this.Ae.realCurrentTimeOffsetMap);delete t[e],this.Me.update({realCurrentTimeOffsetMap:t})}updateIntegratedTimeline(e){this.Me.update({integratedTimeline:e})}updateAltAudioSelectedMatchingInfoForInterstitial(e,t){var i=Object.assign({},this.Ae.interstitialAltAudioSelectedMatchingInfoMap);null==t?delete i[e]:i[e]=t,this.Me.update({interstitialAltAudioSelectedMatchingInfoMap:i})}updateAltAudioSelectedMatchingInfoForInterstitialAsset(e,t){var i=Object.assign({},this.Ae.interstitialAssetAltAudioSelectedMatchingInfoMap);null==t?delete i[e]:i[e]=t,this.Me.update({interstitialAssetAltAudioSelectedMatchingInfoMap:i})}updateSubtitleSelectedMatchingInfoForInterstitial(e,t){var i=Object.assign({},this.Ae.interstitialSubtitleSelectedMatchingInfoMap);null==t?delete i[e]:i[e]=t,this.Me.update({interstitialSubtitleSelectedMatchingInfoMap:i})}updateSubtitleSelectedMatchingInfoForInterstitialAsset(e,t){var i=Object.assign({},this.Ae.interstitialAssetSubtitleSelectedMatchingInfoMap);null==t?delete i[e]:i[e]=t,this.Me.update({interstitialAssetSubtitleSelectedMatchingInfoMap:i})}destroy(){this.Me.destroy()}reset(){this.Me.reset()}}function Co(e){return new j(K.MEDIA_ERROR,q.INTERSTITIAL_ASSET_LIST_PARSING_ERROR,!1,pe.FormatError,e)}function ko(){return e=>e.pipe(ve(e=>({responseText:e.response.data.toString(),responseURL:e.response.uri,stats:e.stats})))}(a=Eo=Eo||{})[a.Primary=0]="Primary",a[a.Interstitial=1]="Interstitial";const Lo=(t,i,e,r,n)=>{const a=Object.assign(Object.assign({},t),{method:"GET",responseType:"text",extendMaxTTFB:e});if(Qa(a.url))return r.load(a,i).pipe(ko());{const t=performance.now();return vo(a,i).pipe(ve(([e,t])=>({responseText:e.responseText,responseURL:e.responseURL,stats:t})),ye(e=>{if(r.retryErrorAsCustomURL&&e instanceof zs&&e.isAuthOrCorsError)return uo(a,i,r,t,e).pipe(ko());throw e}))}};function Do(e){var t;let i=0;return i=e&&(i=e.playoutLimit?C(e.playoutLimit):null!=(t=e.duration)?t:0,fe(t=C(e.resumptionOffset)))?t:i}function xo(e,c,h,p,m,f){const{interstitials:t,startOffset:g}=e;return yr(t).pipe(Pr(u=>yr(u.urls).pipe(Er(e=>{var t,i,r,n,a,s,o,l,d;return-1===e.indexOf(".m3u")?(t=new URL(e),fe(g)&&t.searchParams.append("_HLS_start_offset",g.toString()),t=t.toString(),i=u.identifier,r=t,n=i,a=c,s=h,o=p,l=m,d=f,Mn(()=>{var e=no({url:r},l),t={url:r,xhrSetup:o.xhrSetup,forInterstitialAssetList:!0,interstitialId:n,appItemId:a};let i;if(s.allowInterstitialAssetListDownload)i=Lo(t,e,0,d);else{const r=Object.assign(Object.assign({},t),{method:"GET",responseType:"text",extendMaxTTFB:0});i=d.load(r,e).pipe(ko())}return i.pipe(ve(({responseText:r})=>{{var n=r;let t,e,i;try{try{t=JSON.parse(n)}catch(n){throw Co("interstitial asset list JSON format is malformed")}if(null==t)throw Co("interstitial asset list is empty");if(!Array.isArray(t.ASSETS))throw Co("invalid interstitial asset list ASSETS data type");const e=function(e){for(const i of e.assets){const e="string"!=typeof(t=i).uri?Co("invalid interstitial asset URI data type"):Ha(t.uri)?"number"!=typeof t.duration?Co("invalid interstitial asset DURATION data type"):void 0:Co("interstitial asset uri is not absolute "+t.uri);if(null!=e)return e}var t}(i={assets:t.ASSETS.map(e=>({uri:e.URI,duration:e.DURATION}))});if(null!=e)throw e;return i}catch(n){throw e=n instanceof j?n:Co(`unknown exception when parsing interstitial asset list: `+n)}}}))}).pipe(ye(()=>be({assets:[]})))):be({assets:[{uri:e,duration:u.duration}]})}),wr((e,t)=>[...e,...t.assets],[]),ve(e=>({id:u.identifier,assets:e})))),wr((e,t)=>(e[t.id]=t.assets,e),{}))}function No(e,t){return!(null==(e=e)||e.length<1)&&-1<(i=e.findIndex(e=>e.itemId===t))?{element:e[i],index:i}:{element:null,index:-1};var i}function Fo(e){return e&&-1===e.indexOf("interstitial")}function Bo(e,t,i){return e.startTime?C(e.startTime):([t,i]=J(e=e.startDate,t,i),(e-t)/1e3+i)}function Uo(g,e,t,y,v,I){var i={duration:g,segments:[]};if(0===v.length)return i;const r=v[0],n=v[v.length-1],S=r.start-t,a=n.start-t;if(0===e.length){const g=Z(y,v,S),e={segmentType:Eo.Primary,timeMapping:{source:{start:S,end:a+n.duration},target:{start:S,end:a+n.duration}},startDate:g,interstitialEventIdentifier:void 0};return i.segments.push(e),i}let b=0,T=0;return e.reduce((e,t,i,r)=>{var n,a,s;const o=Vo(t,g,y,v)+b,l=null!=(n=t.duration)?n:0,d=Do(t);let u=0;fe(d)&&0<d&&(u-=d),t.timelineOccupancy===Aa.Range&&(u+=l);const c=r[i-1],h=(c&&c.timelineOccupancy===Aa.Range&&(Vo(c,g,y,v)+b===o?T+=null!=(a=c.duration)?a:0:T=0),Z(y,v,o)),p=t.timelineOccupancy===Aa.Range?b+T:b,m={segmentType:Eo.Interstitial,timeMapping:(n=t,r=p,i=g,a=null!=(a=n.duration)?a:0,i=Vo(n,i,y,v),{source:{start:0,end:a},target:{start:i+r,end:i+(n.timelineOccupancy===Aa.Range?a:0)+r}}),startDate:h,interstitialEventIdentifier:t.identifier},f=e.segments.splice(-1,1,m)[0];if(t.cueType===Ia.Preroll){const I=t.timelineOccupancy===Aa.Range?l:0,i=Z(y,v,I),r=f?f.timeMapping.target.start:0,n={segmentType:Eo.Primary,timeMapping:_o(t,I,I,T,r,g,y,v,!1),startDate:i,interstitialEventIdentifier:void 0};e.segments.push(n)}else if(t.cueType===Ia.Midroll){const i=null!=(s=null==f?void 0:f.timeMapping.source.start)?s:S,r=null!=(s=null==f?void 0:f.timeMapping.target.start)?s:S,n=o,a=Z(y,v,r),l={segmentType:Eo.Primary,timeMapping:_o(t,i,r,T,b,n,y,v,!0),startDate:a,interstitialEventIdentifier:void 0},d=((s=l.timeMapping).source.end-s.source.start>I.abuttingInterstitialThresholdMs/1e3&&e.segments.splice(-1,0,l),t.timelineOccupancy===Aa.Range?o+Math.abs(u)+T:o+T),c=Z(y,v,d),h=t.timelineOccupancy===Aa.Range?b+T:b,p={segmentType:Eo.Primary,timeMapping:_o(t,o,o,T,h,g,y,v,!1),startDate:c,interstitialEventIdentifier:void 0};e.segments.splice(e.segments.length,0,p)}else{const I=S,i=Z(y,v,I),r={segmentType:Eo.Primary,timeMapping:_o(t,I,I,T,0,g,y,v,!0),startDate:i,interstitialEventIdentifier:void 0};e.segments.splice(0,0,r)}return b+=u,e.duration=g+b,e},i)}function _o(e,t,i,r,n,a,s,o,l){s=Vo(e,a,s,o);if(l)return{source:{start:t,end:s},target:{start:i,end:s+n}};l=null!=(o=e.duration)?o:0,t=Do(e),i=fe(t);let d=s+n,u=i?a-t:a;return e.timelineOccupancy===Aa.Range&&(d+=l,u+=l),{source:{start:(i?s+t:s)+r,end:a},target:{start:d,end:u}}}function Vo(e,t,i,r){let n=0;return e.cueType===Ia.Midroll?n=Bo(e,i,r):e.cueType===Ia.Postroll&&(n=t),n}function Qo(t,i,r,n,a,s){let o=NaN;var l=[];for(let e=0;e<i.length;e++){var d=i[e];if(!d)break;if(fe(o)){const m=i[o];if(!m)break;var u=s["abuttingInterstitialThresholdMs"],c=Bo(m,r,n),h=Do(m),c=c+h,p=Bo(d,r,n);if(c+(fe(u)?u/1e3:0)<p)break;if(p<c){const t=h-(c-p);if(!m.playoutLimit||C(m.playoutLimit)>t){const i=x(t,1e3),r=(a&&a.updateInterstitial(m.identifier,{playoutLimit:i}),l.findIndex(e=>e.identifier===m.identifier));0<=r&&(l[r]=Object.assign(Object.assign({},m),{playoutLimit:i}))}}l.push(d),o++}else d.identifier===t.identifier&&(o=e)}return l}function Ho(e){var{method:t,isEncrypted:i,uri:r,format:n,formatversions:a}=e;return{method:t,isEncrypted:i,uri:r,format:n,formatversions:a,iv:e.ivBuf?new Uint8Array(e.ivBuf):null,keyId:e.keyIdBuf?new Uint8Array(e.keyIdBuf):null,key:e.keyBuf?new Uint8Array(e.keyBuf):null,pssh:e.psshBuf?new Uint8Array(e.psshBuf):null}}function qo(e){return null!=(e=null==e?void 0:e.mediaOptionKeys.map(e=>e.mediaOptionId))?e:[]}(Ss=Oo=Oo||{}).MustRequestResponse="MustRequestResponse",Ss.WaitingForKeyResponse="WaitingForKeyResponse",Ss.GotKeyResponse="GotKeyResponse";const Ko={id:"fairplaystreaming",systemStringPrefix:"com.apple.fps",keyFormatString:"com.apple.streamingkeydelivery",securityLevels:{AppleBaseline:0,AppleMain:1,Main:1,Baseline:0}},jo={id:"playready",systemStringPrefix:"com.microsoft.playready",keyFormatString:"com.microsoft.playready",securityLevels:{SL2000:0,SL3000:1}},$o={id:"widevine",systemStringPrefix:"com.widevine.alpha",keyFormatString:"urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed",securityLevels:{WIDEVINE_SOFTWARE:0,WIDEVINE_HARDWARE:1}};function Go(e){return e.replace(/\+/g,"-").replace(/\//g,"_").replace(/\=+$/,"")}class Wo{static strToBase64Encode(e){return btoa(e)}static base64DecodeToStr(e){return atob(e)}static base64Encode(e){return btoa(String.fromCharCode(...e))}static base64UrlEncode(e){return Go(Wo.base64Encode(e))}static base64Decode(e){return Uint8Array.from(atob(e),e=>e.charCodeAt(0))}}class zo{static strToBase64Encode(e){return l.Buffer.from(e).toString("base64")}static base64DecodeToStr(e){return l.Buffer.from(e,"base64").toString()}static base64Encode(e){return l.Buffer.from(e).toString("base64")}static base64UrlEncode(e){return Go(zo.base64Encode(e))}static base64Decode(e){e=l.Buffer.from(e,"base64");return new Uint8Array(e.buffer,e.byteOffset,e.byteLength)}}var Yo,Xo,Jo,Zo=void 0!==l.Buffer?zo:Wo;const el={avc1:"video/mp4",avc3:"video/mp4",dvav:"video/mp4",dva1:"video/mp4",hev1:"video/mp4",hvc1:"video/mp4",dvh1:"video/mp4",dvhe:"video/mp4"},tl={mp4a:"audio/mp4","ac-3":"audio/mp4","ec-3":"audio/mp4"};function il(e){var e=De.strToUtf8array(e).subarray(0,16),t=new Uint8Array(16);return t.set(e,16-e.length),t}const rl={getCapabilities:function(e,t){const r={videoCapabilities:[],audioCapabilities:[]};return e&&e.forEach(e=>{var t,i=e.split(".")[0].trim();i in el&&null!=(t=r.videoCapabilities)&&t.push({contentType:el[i]+";codecs="+e,robustness:""})}),t&&t.forEach(e=>{var t,i=e.split(".")[0].trim();i in tl&&null!=(t=r.audioCapabilities)&&t.push({contentType:tl[i]+";codecs="+e,robustness:""})}),r},changeEndianness:function(e){function t(e,t,i){var r=e[t];e[t]=e[i],e[i]=r}t(e,0,3),t(e,1,2),t(e,4,5),t(e,6,7)},getKeyIdBytes:il,convertDataUriToArrayBytes:function(e){const t=e.split(":");let i=null;if("data"===t[0]&&2===t.length){const e=t[1].split(";"),r=e[e.length-1].split(",");if(2===r.length){const t="base64"===r[0],n=r[1];i=t?(e.splice(-1,1),Zo.base64Decode(n)):il(n)}}return i},makeKeyIdsInitData:function(e){e={kids:e.map(Zo.base64UrlEncode)};return De.strToUtf8array(JSON.stringify(e))},parsePSSHList:function(e){var i=new DataView(e);let r=0;for(var n={};r<i.buffer.byteLength;){const e=r,t=i.getUint32(r);r+=4;var a=e+t;if(1886614376!==i.getUint32(r))r=a;else{switch(r+=4,i.getUint8(r)){case 0:case 1:r+=1;break;default:r=a}r+=3;let t="";for(let e=0;e<16;++e,++r)switch(t+=i.getUint8(r).toString(16),e){case 4:case 6:case 8:case 10:t+="-"}r+=4,n[t]=i.buffer.slice(e,a)}}return n}};class nl{constructor(e,t,i="",r=null,n=null,a=[]){if(this.method=t,this.uri=i,this.iv=r,this.format=n,this.formatversions=a,this.key=null,this.keyId=null,this.pssh=null,this.isEncrypted=this.method&&"NONE"!==this.method,this.formatversions&&0!==this.formatversions.length||(this.formatversions=[1]),this.isEncrypted){var s=rl.convertDataUriToArrayBytes(this.uri);if(s)switch(n){case jo.keyFormatString:{this.format=jo.keyFormatString,this.pssh=s;const e=new Uint16Array(s.buffer,s.byteOffset,s.byteLength/2),t=String.fromCharCode.apply(null,Array.from(e)),i=t.substring(t.indexOf("<"),t.length),r=(new DOMParser).parseFromString(i,"text/xml").getElementsByTagName("KID")[0];if(r){var o;if(o=r.childNodes[0]?r.childNodes[0].nodeValue:r.getAttribute("VALUE")){const t=Zo.base64Decode(o).subarray(0,16);rl.changeEndianness(t),this.keyId=t}}break}case $o.keyFormatString:this.format=$o.keyFormatString,22<=(this.pssh=s).length&&(this.keyId=s.subarray(s.length-22,s.length-6));break;case Ko.keyFormatString:this.format=Ko.keyFormatString;default:{let e=s.subarray(0,16);if(16!==e.length){const t=new Uint8Array(16);t.set(e,16-e.length),e=t}this.keyId=e;break}}this.keyId&&16===this.keyId.byteLength||(this.keyId=e.upsertKey(this.uri))}}get keyTagInfo(){var{method:e,isEncrypted:t,uri:i,iv:r,keyId:n,key:a,format:s,formatversions:o,pssh:l}=this;return{method:e,isEncrypted:t,uri:i,iv:r,keyId:n,key:a,format:s,formatversions:o,pssh:l}}}class al{constructor(){this.generatedKeyUriToKeyIdMap=new Map}upsertKey(e,t){let i=this.generatedKeyUriToKeyIdMap.get(e);if(!i){const t=al.generatedKeyIdInt;al.generatedKeyIdInt=(al.generatedKeyIdInt+1)%al.MAX_KEYID;var r=new Uint8Array(16);new DataView(r.buffer,12,4).setUint32(0,t),i=r,this.generatedKeyUriToKeyIdMap.set(e,i)}return i}clear(e){this.generatedKeyUriToKeyIdMap.clear()}}al.generatedKeyIdInt=0,al.MAX_KEYID=29;const Pe=be(void 0),sl=be(null);function ol(e,t,i=1){return e.pipe(Ur(t),Dr(i))}function ll(...e){return new F(function(e,t){const i=e.length;let r=0;var n={error:t.error.bind(t),complete:()=>{++r===i&&t.complete()}};for(const i of e){if(t.closed)break;t.add(i.subscribe(n))}}.bind(null,e))}function dl(e){return{add:e.add.bind(e),error:e.error.bind(e)}}function Ce(e,t){e.add(t.subscribe(e))}class ul extends Ys{constructor(e,t,i=[],r="Other",n){super(q.KEY_LOAD_TIMEOUT,!1,t,void 0,r,n),this.keyuri=e,this.response=t,this.mediaOptionIds=i,this.timeoutType=r}}(bs=Yo=Yo||{})[bs.InvalidState=0]="InvalidState",bs[bs.Abort=1]="Abort",bs[bs.AlreadyFailedKey=2]="AlreadyFailedKey",bs[bs.HttpError=3]="HttpError",bs[bs.LicenseServerError=4]="LicenseServerError",bs[bs.InsufficientCPC=5]="InsufficientCPC";class cl extends Ys{constructor(e,t,i,r,n=!1,a=[],s){super(q.KEY_LOAD_ERROR,n,t,void 0,void 0,s),this.keyuri=e,this.isOkToRetry=i,this.keyErrorReason=r,this.mediaOptionIds=a}}class hl extends v{constructor(e,t,i,r,n=[],a){super(K.OTHER_ERROR,q.KEY_SYSTEM_GENERIC_ERROR,r,t,a),this.keyuri=e,this.response=t,this.isOkToRetry=i,this.fatal=r,this.mediaOptionIds=n}}function pl(e,t){let i;return e instanceof cl?i=new cl(e.keyuri,e.response,e.isOkToRetry,e.keyErrorReason,e.fatal,t,e.message):e instanceof ul?i=new ul(e.keyuri,e.response,t,e.timeoutType,e.message):e instanceof hl?i=new hl(e.keyuri,e.response,e.isOkToRetry,e.fatal,t,e.message):e&&(i=new me(e.fatal,pe.ExceptionInKeyRequest,e.message,e.stack)),i&&e&&(i.stack=e.stack),i}const ml=["clearkey","fairplaystreaming","playready","widevine"];(i=Xo=Xo||{}).NONE="NONE",i.GET_REQUEST_INFO="GET_REQUEST_INFO",i.GET_CHALLENGE="GET_CHALLENGE",i.GET_KEY_RESPONSE="GET_KEY_RESPONSE",i.PROCESS_LICENSE="PROCESS_LICENSE";class fl extends e{trigger(e,t){try{this.emit(e,e,t),"hlsFragLoadProgress"!==e.toString()&&(("hlsInternalError"===e||"hlsError"===e)&&t&&t.length&&JSON.stringify(t[0],["fatal","details","reason"]),e.toString())}catch(e){}}}class gl{constructor(e,t){this.target=e,this._this=t}eventWithOptions(e,t,i,r=this._this){let n;return n=t?Dn(this.target,e,t):Dn(this.target,e),this.target instanceof fl&&(n=n.pipe(ve(([,e])=>e))),i&&(r&&(i=i.bind(r)),n=n.pipe(Ee(i))),n}event(e,t,i=this._this){return this.eventWithOptions(e,void 0,t,i)}listen(e,t,i,r=this._this){return this.event(e,i,r).pipe(an(t)).subscribe()}}function yl(e,t){return new gl(e,t)}function vl(e,t,i){var r;return{currentTarget:null!=(r=null==i?void 0:i.currentTarget)?r:e,target:null!=(r=null==i?void 0:i.target)?r:e,type:t}}class Il{constructor(e,t,i,r){this.session=e,this.onkeystatuseschange=t,this.onkeymessage=i,this.R=r,this.Ee=new jr(!1),this.Ne=new jr(!1);e=yl(this.session);e.listen("keystatuseschange",this.Ee.pipe(Ur(e=>!0===e)),this.onkeystatuseschange),e.listen("message",this.Ne.pipe(Ur(e=>!0===e)),this.onkeymessage)}get isClosing(){return this.Ee.value}get isClosed(){return this.Ne.value}destroy(){this.Ee.next(!0);const e=this.session;return yr(e.remove().catch(e=>{}).then(()=>e.close()).catch(e=>{})).pipe(Ee(()=>{this.Ee.next(!1),this.Ne.next(!0)}),Hr(()=>{this.Ee.next(!1),this.Ne.next(!0)}))}}class Sl{constructor(e,t){this.decryptdata=e,this.Re=new jr(Xo.NONE),this.destroy$=new Ie,this.Pe=!1,this.oldSessions=[],this.session=t}get requestState(){return this.Re.value}get onKeyRequestState$(){return this.Re}destroy(){this.destroy$.next(),this.clearRenewal(),this.abort(),this.session=void 0,this.requestInfo=void 0,this._e=void 0,this.oldSessions=[]}abort(){var e;this.requestState!==Xo.NONE&&(e=new cl(this.decryptdata.uri,pe.KeySystemAbort,!0,Yo.Abort),this.error(e))}get licenseChallenge(){return this._e}get shouldReuseSession(){return this.Pe}cacheChallenge(e,t){this._e=e,this.Pe=t}clearChallenge(){this._e=void 0}clearRenewal(){var e;null!=(e=this.renewal)&&e.unsubscribe(),this.renewal=void 0}setKeyRequestState(e){if(e===Xo.GET_REQUEST_INFO&&this.clearRenewal(),this.Ce){const t=new cl(this.decryptdata.uri,pe.KeySystemUnexpectedStateTransition,!0,Yo.InvalidState,void 0,void 0,`Unexpected state transition ${this.requestState}->`+e);this.error(t)}this.Re.next(e);const t=new $r;return e===Xo.NONE?(t.complete(),this.Ce=void 0):this.Ce=t,t}resolveState(e,t){if(!this.Ce)return!1;if(e!==this.requestState){const t=new cl(this.decryptdata.uri,pe.KeySystemUnexpectedState,!0,Yo.InvalidState,void 0,void 0,`Unexpected state ${this.requestState} != `+e);return this.error(t),!1}if(t instanceof Error)return this.error(t),!1;{const e=this.Ce;return this.Ce=void 0,e.next(t),e.complete(),!0}}setRequestInfo(e,t,i,r){var n=this.decryptdata.uri,a=performance.now(),t=(r.pin&&t.setPinnedKey(n,a+e),this.resolveState(Xo.GET_REQUEST_INFO,r));return!t||null!=i&&i.report(21,{keyuri:n,timestamp:a}),t}setKeyResponse(e,t){let i=NaN;null!=t.renewalInMs?i=t.renewalInMs:null!=t.renewalDate&&(i=t.renewalDate.getTime()-Date.now()),(!isFinite(i)||i<=0||i>=Math.pow(2,31))&&(i=NaN);var r=t.license||t.ckc,t={statusCode:t.statusCode||0,license:r&&$(r),renewalInMs:i};this.resolveState(Xo.GET_KEY_RESPONSE,t)}error(e){var t;this.Ce&&(t=this.Ce,this.Ce=void 0,t.error(e)),this.clearRenewal(),this.setKeyRequestState(Xo.NONE)}}function bl(e){return`uri=${z(e.uri)} keyId=`+M.hexDump(e.keyId)}class Tl{constructor(e,t,i,r,n,a,s,o,l){this.mediaKeys=e,this.systemString=t,this.config=i,this.useSingleKeySession=n,this.sessionHandler=a,this.customUrlLoader=s,this.ksService=o,this.logger=l,this.alwaysResolveLicense=!1,this.destroy$=new Ie,this.xe=new $r,this.De=!1,this.Le=Math.round(performance.now()),this._keyStatusChange$=new Ie,this.ksQuery=o.query,this.isDestroying=!1,this.shouldDestroyMediaKeys=!i.maintainMediaKeysBetweenSessions,this.sessions=[],this.keyIdToKeyInfo={},this.keyUriToKeyInfo={},this.sessionIdToKeyUri={},this.eventEmitter=r,this.Fe=this.handleKeyStatusesChange.bind(this),this.je=this.handleKeyMessage.bind(this),this._signalRenewal=this._signalRenewal.bind(this)}get keyStatusChange$(){return this._keyStatusChange$}destroy(){this.isDestroying=!0,this.destroy$.next();for(const e of Object.values(this.keyIdToKeyInfo))this._abortKeyRequest(e);const e=this.sessions.map(e=>e.destroy()),t=Fn(()=>0===e.length,Pe,Pn(e)).pipe(xr(void 0),Hr(()=>{this.keyIdToKeyInfo={},this.keyUriToKeyInfo={},this.sessionIdToKeyUri={}}));return this.eventEmitter=void 0,t}waitForCertificate(e=1/0){return this.needsCert?0<e&&e<Math.pow(2,31)?this.xe.pipe(un(e)):this.xe:be(!1)}setServerCertificate(e){if(!this.needsCert)return be(!1);if(!this.De){const i=performance.now();this.De=!0,yr(this.mediaKeys.setServerCertificate(e)).pipe(ve(e=>{var t;return null!=(t=this.sessionHandler)&&t.report(ps,{eventId:3,range:{tbegin:i,tend:performance.now()}}),null==e||e}),ye(e=>{throw this.logger.error(`setServerCertificate error=`+e.message),new hl("",pe.KeySystemSetServerCertificateError,!1,!1)}),an(this.destroy$)).subscribe(this.xe)}return this.xe}ensureKeyContext(e){var t,i,r,n=e.uri,e=(this.keyUriToKeyInfo[n]||(this.keyUriToKeyInfo[n]=new Sl(e)),this.keyUriToKeyInfo[n]);return e.session||(this.useSingleKeySession&&0<this.sessions.length?e.session=this.sessions[0].session:(i=performance.now(),(r=this.mediaKeys.createSession())&&(this.sessions.push(new Il(r,this.Fe,this.je,this.logger)),null!=(t=this.sessionHandler))&&t.report(ps,{eventId:4,range:{tbegin:i,tend:performance.now()},keyuri:n,keyRequestState:e.requestState}),e.session=r)),e}createDummySession(){var e=this.mediaKeys.createSession();e?this.sessions.push(new Il(e,this.Fe,this.je,this.logger)):this.logger.error(this.systemString+` FAIL: could not create MediaKeysSession`)}startKeyRequest(i){const r=i.uri,n=this.ensureKeyContext(i);var e;return null!=n&&n.session?(e=De.utf8arrayToStr(i.keyId),this.keyIdToKeyInfo[e]=n,Pn([this.getKeyRequestInfo(n),this.waitForCertificate()]).pipe(Ae(([e])=>{var t;return null!=(t=this.sessionHandler)&&t.report(22,{keyuri:r,keyFormat:this.systemString,timestamp:performance.now()}),this.generateLicenseChallenge(n,e).pipe(ye(e=>{var t;throw this.logger.error(`${this.systemString} generateLicenseChallenge Failed ${e.message} `+bl(i)),null!=(t=this.sessionHandler)&&t.report(26,{timestamp:performance.now(),keyuri:r}),e}))}),Ae(e=>{var t;if(0===e.length)throw new hl(r,pe.KeySystemFailedToGenerateLicenseRequest,!0,!1);return null!=(t=this.sessionHandler)&&t.report(23,{timestamp:performance.now(),keyuri:r,cdmVersion:this.cdmVersion}),this.getKeyRequestResponse(n,e)}),Ae(e=>{var t;return null!=(t=this.sessionHandler)&&t.report(24,{timestamp:performance.now(),keyuri:r}),n.clearChallenge(),this.handleParsedKeyResponse(n,e).pipe(ye(e=>{var t;throw this.logger.error(`${this.systemString} ParseKeyResponse Failed ${bl(i)} error=`+e.message),null!=(t=this.sessionHandler)&&t.report(27,{timestamp:performance.now(),keyuri:r}),e}))}),ve(()=>{var e;return null!=(e=this.sessionHandler)&&e.report(25,{timestamp:performance.now(),keyuri:r}),n.setKeyRequestState(Xo.NONE),this.removeSessions(n.decryptdata,!1).subscribe(),i}),ye(e=>{throw this.handleKeyExchangeError(n,e),e}),Hr(()=>{this._abortKeyRequest(n)}))):(this.logger.error(this.systemString+` FAIL: could not create MediaKeysSession`),Fr(()=>new hl(i.uri,pe.KeySystemFailedToCreateSession,!1,!0)))}_abortKeyRequest(e){var t,i;e&&(i=e.decryptdata.uri,e.decryptdata.keyId&&De.utf8arrayToStr(e.decryptdata.keyId),e.requestState!==Xo.NONE&&null!=(t=this.sessionHandler)&&t.report(28,{timestamp:performance.now(),keyuri:i,keyErrorType:"keyAborted"}),e.abort())}handleKeyExchangeError(e,t){e.error(t),e.decryptdata.keyId&&De.utf8arrayToStr(e.decryptdata.keyId)}removeKey(e){return this.removeKeyInternal(e)}removeKeyInternal(t){var i=this.keyUriToKeyInfo[t.uri];if(i&&i.session){var r=i.session;i.abort(),i.destroy();let e="";return i.decryptdata.keyId&&(e=De.utf8arrayToStr(i.decryptdata.keyId)),delete this.keyIdToKeyInfo[e],delete this.keyUriToKeyInfo[t.uri],this.removeSession(r)}return Pe}removeSessions(e,t){var i=this.keyUriToKeyInfo[e.uri];if(i){const r=i.oldSessions.map(e=>this.removeSession(e));return i.oldSessions=[],Fn(()=>0===r.length,Pe,Pn(r)).pipe(Ae(()=>t?this.removeKeyInternal(e):Pe))}return Pe}removeSession(t){var e=this.sessions.findIndex(e=>e.session===t),i=this.sessions[e];return-1<e&&this.sessions.splice(e,1),delete this.sessionIdToKeyUri[t.sessionId],i?i.destroy():Pe}getKeyRequestInfo(e){const t=e.decryptdata,i=t.uri,r=e.setKeyRequestState(Xo.GET_REQUEST_INFO),n={id:this.Le++,resolve:e.setRequestInfo.bind(e,this.config.keyMinHoldTimeBeforeCleanup,this.ksService,this.sessionHandler),keyuri:i,appItemIds:this.ksQuery.getAppItemIds(i),decryptdata:t,timestamp:Date.now()};return null!=(e=this.eventEmitter)&&e.trigger(L.KEY_REQUEST_STARTED,n),r.pipe(Hr(()=>{var e;null!=(e=n.oncomplete)&&e.call(n)}))}setKeyRequestInfo(e,t){e=this.keyUriToKeyInfo[e];return!!e&&e.setRequestInfo(this.config.keyMinHoldTimeBeforeCleanup,this.ksService,this.sessionHandler,t)}sanitizeRequest(e){return e}_generateLicenseChallengeInternal(t,e,i){const r=t.decryptdata,n=t.session,a=r.uri;let s;if(null==n)return this.logger.error("key session is null, this should not happen"),Fr(()=>new hl(a,pe.KeySystemInternalError,!1,!0));const o=t.setKeyRequestState(Xo.GET_CHALLENGE);if(n.generateRequestPromise)s=gr(n.generateRequestPromise,Rn).pipe(Ae(()=>this.generateRequestInitialized(t,"usable"===i)));else{const i=this.generateInitData(r,e),o=performance.now();n.generateRequestPromise=n.generateRequest(i.initDataType,i.initData),s=gr(n.generateRequestPromise,Rn).pipe(Ee(()=>{var e;this.sessionIdToKeyUri[n.sessionId]=a,null!=(e=this.sessionHandler)&&e.report(ps,{eventId:5,range:{tbegin:o,tend:performance.now()},keyuri:r.uri,keyRequestState:t.requestState})}),ye(e=>{throw new hl(t.decryptdata.uri,pe.KeySystemFailedToGenerateLicenseRequest,!1,!0,void 0,e.message)}))}return Pn([o,s]).pipe(ve(e=>e[0]))}generateLicenseChallenge(e,t){const i=e.decryptdata,r=e.session,n=i.uri,a=i.keyId;if(null==r)return this.logger.error("key session is null, this should not happen"),Fr(()=>new hl(n,pe.KeySystemInternalError,!1,!0));let s;if(e.licenseChallenge&&e.resolveState(Xo.GET_CHALLENGE,e.licenseChallenge),t=this.sanitizeRequest(t),e.requestInfo=t,this.systemString===jo.systemStringPrefix){const e=G(a);rl.changeEndianness(e),s=r.keyStatuses.get(e)}else s=r.keyStatuses.get(a);return this._generateLicenseChallengeInternal(e,t,s)}getKeyRequestResponse(e,t){const i=e.decryptdata.uri,r={id:this.Le++,resolve:e.setKeyResponse.bind(e,this.logger),keyuri:i,licenseChallenge:t,keysystem:this.systemString,keyId:e.decryptdata.keyId,appItemIds:this.ksQuery.getAppItemIds(i)},n=e.setKeyRequestState(Xo.GET_KEY_RESPONSE).pipe(Hr(()=>{var e;null!=(e=r.oncomplete)&&e.call(r)}));return null!=(t=this.eventEmitter)&&t.trigger(L.LICENSE_CHALLENGE_CREATED,r),n}setParsedResponse(e,t){e=this.keyUriToKeyInfo[e];e&&e.setKeyResponse(this.logger,t)}makeProcessLicenseRequestMessage(e,t,i){return t}handleParsedKeyResponse(i,e){var t=i.decryptdata.uri,{statusCode:e,license:r,renewalInMs:n}=e,r=r&&0!==r.byteLength?r:void 0;if(0!==e)throw new cl(t,xe(e,0),!1,Yo.LicenseServerError);if(!r)throw new cl(t,e,!0,Yo.HttpError);fe(n)&&this._scheduleRenewal(i,n);const a=i.session;if(null==a)throw this.logger.error("Key session is null"),new hl(i.decryptdata.uri,pe.InternalError,!1,!0);const s=this.makeProcessLicenseRequestMessage(i,r,n),o=performance.now(),l=yr(a.update(s).catch(function(e,t,i,r,n){throw new hl(e,t,i,r,void 0,n.message)}.bind(null,i.decryptdata.uri,pe.KeySystemFailedToUpdateSession,!1,!0))).pipe(Ee(()=>{var e;if(this.alwaysResolveLicense)i.resolveState(Xo.PROCESS_LICENSE,void 0);else{const e=i.decryptdata.keyId,t=a.keyStatuses.get(e);this.handleKeyStatusForKey(t,i)}null!=(e=this.sessionHandler)&&e.report(ps,{eventId:6,range:{tbegin:o,tend:performance.now()},keyuri:i.decryptdata.uri,keyRequestState:i.requestState})}));return Pn([i.setKeyRequestState(Xo.PROCESS_LICENSE),l]).pipe(xr(void 0))}handleKeyStatusesChange(e){e.target.keyStatuses.forEach((e,t,i)=>{t=G(t),this.systemString===jo.systemStringPrefix&&rl.changeEndianness(t),t=De.utf8arrayToStr(t),t=this.keyIdToKeyInfo[t];t&&this.handleKeyStatusForKey(e,t)})}handleKeyStatusForKey(e,t){if(t){var i=t.decryptdata,r=i.uri;switch(e){case"internal-error":this.logger.error(this.systemString+` internal-error for key `+bl(i)),this._signalError(t,new hl(r,pe.KeySystemInternalError,!1,!1));break;case"usable":t.requestState===Xo.PROCESS_LICENSE&&t.resolveState(Xo.PROCESS_LICENSE,void 0);break;case"output-restricted":t.session&&this.removeSession(t.session).pipe(an(this.destroy$)).subscribe(),this._signalError(t,new hl(r,pe.KeySystemOutputRestricted,!1,!1,void 0));break;case"expired":this._signalRenewal(t)}}}_scheduleRenewal(e,t){if(!isFinite(t)||t<=0)return this._signalRenewal(e);e.clearRenewal(),e.renewal=be(e).pipe(function(e,t){var i=rr(e,1<arguments.length&&void 0!==t?t:Zi);return Nr(()=>i)}(t),Ee(this._signalRenewal),an(this.destroy$)).subscribe()}_signalRenewal(e){e.clearRenewal(),this._keyStatusChange$.next({decryptdata:e.decryptdata,status:"needs-renewal"})}_signalError(e,t){this._keyStatusChange$.next({decryptdata:e.decryptdata,status:"error",error:t}),e.error(t)}}const Al="org.w3.clearkey",El={id:"clearkey",systemStringPrefix:Al,keyFormatString:Al,securityLevels:{NONE:0}},Ol={initDataTypes:["keyids","cenc"]},wl={initDataTypes:["cenc"]},Rl=new Uint8Array([148,206,134,251,7,255,79,67,173,184,147,210,250,150,140,162]);Jo=Jo||{},Jo[Jo.ISOFFLINE=2]="ISOFFLINE";class Ml extends Tl{constructor(e,t,i,r,n,a,s,o,l){super(e,t,i,r,n,a,s,o,l),this._hasSetRenewal=!1}static get systemId(){return Rl}static get requestAccessConfig(){return wl}get needsCert(){return!0}sanitizeRequest(e){return{assetId:e&&e.assetId&&$(e.assetId),ssc:e&&e.ssc&&$(e.ssc),sessionId:e&&e.sessionId,isOffline:Boolean(e&&e.isOffline)}}_scheduleRenewal(e,t){this.useSingleKeySession?this._hasSetRenewal||(this._hasSetRenewal=!0,rr(t).pipe(Ee(()=>{var e=Object.values(this.keyUriToKeyInfo)[0];e&&this._signalRenewal(e)}),Hr(()=>{this._hasSetRenewal=!1}),an(this.destroy$)).subscribe()):super._scheduleRenewal(e,t)}makeKeyRequests(e){var t=[];for(const i of e){const e=i.decryptdata,r=i.requestInfo,n=e.keyId;t.push({keyId:n,assetId:r&&r.assetId,ssc:r&&r.ssc,versionList:e.formatversions})}return t}getSchemeAndFlags(e,t){e="ISO-23001-7"===e.method?Ye.CENC:Ye.CBCS;let i=0;return t&&(i|=Jo.ISOFFLINE),{scheme:e,flags:i}}generateInitData(e,t){var{scheme:i,flags:r}=this.getSchemeAndFlags(e,t.isOffline),e=this.makeKeyRequests([{decryptdata:e,requestInfo:t}]);return{initData:this.makeFpsKeySystemInitData(i,r,e),initDataType:"cenc"}}generateRequestInitialized(t,e){var e=this.makeKeyRequestMessage(t,e),i=t.session;if(null==i)return this.logger.error("Key is session is null"),Se;const r=performance.now();return yr(i.update(e)).pipe(Ee(()=>{var e;t.requestInfo=void 0,null!=(e=this.sessionHandler)&&e.report(ps,{eventId:6,range:{tbegin:r,tend:performance.now()},keyuri:t.decryptdata.uri,keyRequestState:t.requestState})}),ye(e=>{throw new hl(t.decryptdata.uri,pe.KeySystemFailedToGenerateLicenseRenewal,!1,!0,e.message)}))}resolveSPCPromise(e,t){e.resolveState(Xo.GET_CHALLENGE,t)}}const Pl=1919710053;function Cl(e,t,i){if(!(i+4>e.byteLength)){t=t.getUint32(i);if(!((i+=4)+t>e.byteLength))return e=e.slice(i,i+t),{pos:i+=t,data:e}}}function kl(t){var i={},r=new DataView(t.buffer);let n=4;const a=r.getUint32(n);n+=4;for(let e=0;e<a&&n<t.byteLength&&!(n+16>t.byteLength);++e){const a=t.slice(n,n+16);if((n+=16)+4>t.byteLength)break;var s=Cl(t,r,n);if(!s)break;n=s.pos,i[De.utf8arrayToStr(a)]=s.data}return i}function Ll(e,t,i,r){var n=r?r.byteLength:0;return t.setUint32(i,n),n&&e.set(r,i+4),i+(4+n)}function Dl(e){let t=4;for(const i of e)t+=28+(i.assetId?i.assetId.byteLength:0)+(i.ssc?i.ssc.byteLength:0)+(i.versionList?4*i.versionList.length:0);return t}function xl(e,t,i,r){t.setUint32(i,r.length),i+=4;for(const n of r)if(e.set(n.keyId,i),i=Ll(e,t,i+=16,n.assetId||new Uint8Array),i=Ll(e,t,i,n.ssc||new Uint8Array),t.setUint32(i,n.versionList?n.versionList.length:0),i+=4,n.versionList)for(const e of n.versionList)t.setUint32(i,e),i+=4;return i}class Nl extends Ml{constructor(e,t,i,r,n,a,s,o){super(e,t,i,r,void 0===i.useMultipleKeySessions||!i.useMultipleKeySessions,n,a,s,o),this.Be=!1,i.createDummySessionOnStart&&this.createDummySession()}makeProcessLicenseRequestMessage(i,r,n){{i=[{keyId:i.decryptdata.keyId,expirySec:n/1e3,ckc:r}];var a=this.Be;let e=0;for(const a of i)e+=24+a.ckc.byteLength;let t=0;var s=new Uint8Array(8+e),o=new DataView(s.buffer);a?o.setUint32(0,1868786531):o.setUint32(0,1667982195),o.setUint32(4,i.length),t+=8;for(const a of i)s.set(a.keyId,t),t+=16,o.setUint32(t,a.expirySec),t+=4,t=Ll(s,o,t,a.ckc);return s}}makeFpsKeySystemInitData(e,t,i){this.Ue(t)&&(this.Be=!0);e=e,t=t,r=Dl(i=i),n=0,r=new Uint8Array(8+r),(a=new DataView(r.buffer)).setUint32(n,e),a.setUint32(n+4,1<<24|16777215&t),xl(r,a,n+=8,i);var r,n,a,e=r;return y.pssh(Nl.systemId,[],e)}Ue(e){return(e&Jo.ISOFFLINE)===Jo.ISOFFLINE}makeKeyRequestMessage(e){null!=(n=e.requestInfo)&&n.isOffline&&(this.Be=!0);var t,i,r,n=e.requestInfo;return n=[{keyId:e.decryptdata.keyId,assetId:n&&n.assetId,ssc:n&&n.ssc,versionList:e.decryptdata.formatversions}],e=this.Be,t=Dl(n),i=0,t=new Uint8Array(4+t),r=new DataView(t.buffer),e?r.setUint32(0,1868788331):r.setUint32(0,1668442994),xl(t,r,i+=4,n),t}handleKeyMessage(e){var t;if(!(e.message.byteLength<4)){const i=$(e.message),r=new DataView(e.message),n=r.getUint32(0);if(!this.isDestroying||n===Pl)switch(n){case 1667592820:break;case 1919837559:{const e=kl(i);for(const t in e)if(Object.prototype.hasOwnProperty.call(e,t)){const e=this.keyIdToKeyInfo[t];e&&this._signalRenewal(e)}break}case 1936745331:{const e=kl(i);for(const t in e)if(Object.prototype.hasOwnProperty.call(e,t)){const i=this.keyIdToKeyInfo[t],r=e[t];i&&r&&this.resolveSPCPromise(i,r)}break}case Pl:this._handleLicenseRelease(i);break;case 1667525993:{const e=Cl(i,r,4);e&&(this.cdmVersion=De.utf8arrayToStr(e.data));break}case 1869767536:{const e=Cl(i,r,4);if(e){const i=e.data;null!=(t=this.eventEmitter)&&t.trigger(L.OFFLINE_FAIRPLAY_DEVICE_CAPS,{capability:i})}break}}}}_handleLicenseRelease(e){new DataView(e.buffer).getUint32(4),null!=(e=this.eventEmitter)&&e.trigger(L.LICENSE_RELEASED,{keysystem:this.systemString,itemId:"",releaseRecord:{}})}}r=Nl;const Fl={fpsd:De.strToUtf8array("fpsd"),fpsi:De.strToUtf8array("fpsi"),fpsk:De.strToUtf8array("fpsk"),fkri:De.strToUtf8array("fkri"),fkai:De.strToUtf8array("fkai"),fkcx:De.strToUtf8array("fkcx"),fkvl:De.strToUtf8array("fkvl")};const Bl={initDataTypes:["cenc"]},Ul=new Uint8Array([154,4,240,121,152,64,66,134,171,146,230,91,224,136,95,149]);class _l extends Tl{constructor(e,t,i,r,n,a,s,o){super(e,t,i,r,!1,n,a,s,o),this.shouldDestroyMediaKeys=!0,this.alwaysResolveLicense=!0}static get systemId(){return Ul}static get requestAccessConfig(){return Bl}get needsCert(){return!1}generateInitData(e){e=e.pssh;return{initData:y.pssh(_l.systemId,[],e),initDataType:"cenc"}}removeKey(e){return super.removeSessions(e,!0)}ensureKeyContext(e){var t=e.uri,t=this.keyUriToKeyInfo[t];return null!=t&&t.session&&(t.oldSessions.push(t.session),t.session=void 0),super.ensureKeyContext(e)}generateRequestInitialized(e){var t=e.licenseChallenge;return e.requestInfo=void 0,e.resolveState(Xo.GET_CHALLENGE,void 0!==t?t:new me(!1,pe.KeySystemUndefinedChallenge)),Pe}handleKeyMessage(e){var t,i,r;this.isDestroying||(r=new DOMParser,e=ArrayBuffer.isView(e.message)?e.message.buffer:e.message,e=new("utf16"===this.config.playReadyMessageFormat?Uint16Array:Uint8Array)(e),e=String.fromCharCode.apply(null,Array.from(e)),(i=r.parseFromString(e,"application/xml").getElementsByTagName("PlayReadyKeyMessage")[0])&&"LicenseAcquisition"===i.getAttribute("type")&&(i=r.parseFromString(e,"application/xml").getElementsByTagName("Challenge")[0])&&"base64encoded"===i.getAttribute("encoding")&&0!==i.childNodes.length&&(e=Zo.base64Decode(null!==i.childNodes[0].nodeValue?i.childNodes[0].nodeValue:""),i=De.utf8arrayToStr(e),t=null,t=(r=r.parseFromString(i,"application/xml").getElementsByTagName("KID")[0]).childNodes[0]?r.childNodes[0].nodeValue:r.getAttribute("VALUE"),i=Zo.base64Decode(null!==t?t:"").subarray(0,16),rl.changeEndianness(i),r=this.keyIdToKeyInfo[De.utf8arrayToStr(i)])&&(r.cacheChallenge(e,!1),r.resolveState(Xo.GET_CHALLENGE,e)))}}n=_l;const Vl={initDataTypes:["cenc","keyids"]},Ql=new Uint8Array([237,239,139,169,121,214,74,206,163,200,39,220,213,29,33,237]),Hl={clearkey:El,fairplaystreaming:Ko,playready:jo,widevine:$o},ql={clearkey:[["org.w3.clearkey",class extends Tl{constructor(e,t,i,r,n,a,s,o){super(e,t,i,r,!1,n,a,s,o)}static get requestAccessConfig(){return Ol}get needsCert(){return!1}getKeyRequestResponse(e,t){return bo({url:e.decryptdata.uri,xhrSetup:this.config.xhrSetup},{maxLoadTimeMs:0,maxTimeToFirstByteMs:0,autoRetry:!1,timeoutRetry:void 0,errorRetry:void 0},this.customUrlLoader).pipe(ve(([e])=>{e=$(e);return{statusCode:0,license:this.parseResponse(t,e),renewalInMs:NaN}}),ye(()=>be({statusCode:0,license:void 0,renewalInMs:NaN})))}parseResponse(e,t){e={kty:"oct",kid:Zo.base64UrlEncode(e),k:Zo.base64UrlEncode(t)};return De.strToUtf8array(JSON.stringify({keys:[e]}))}generateInitData(e){e=e.keyId;return{initData:rl.makeKeyIdsInitData([e]),initDataType:"keyids"}}generateRequestInitialized(){return Pe}sanitizeRequest(e){return e}handleKeyMessage(e){var t;this.isDestroying||"license-request"===e.messageType&&(e=$(e.message),1===(e=JSON.parse(De.utf8arrayToStr(e).trim())).kids.length)&&(e=Zo.base64Decode(e.kids[0]),t=De.utf8arrayToStr(e),t=this.keyIdToKeyInfo[t])&&t.resolveState(Xo.GET_CHALLENGE,e)}}]],fairplaystreaming:[["com.apple.fps.3_0",class extends Ml{constructor(e,t,i,r,n,a,s,o){super(e,t,i,r,!1,n,a,s,o),this.sessions=[],this.keyIdToKeyInfo={},this.keyUriToKeyInfo={},this.sessionIdToKeyUri={}}static get needsCert(){return!0}handleKeyExchangeError(e,t){this.removeKey(e.decryptdata).subscribe(),super.handleKeyExchangeError(e,t)}_abortKeyRequest(e){return!this.isDestroying&&e&&e.requestState!==Xo.NONE&&this.removeKey(e.decryptdata).subscribe(),super._abortKeyRequest(e)}makeFpsKeySystemInitData(e,t,i){var r=e,e=t,t=i,n=[Fl.fpsd,(r=r,e=e,i=new Uint8Array(4),y.set32(r,i,0),y.box(Fl.fpsi,new Uint8Array([0,e>>16&255,e>>8&255,255&e]),i))];for(const r of t)n.push(function(t,e,i,r){var n=[Fl.fpsk],t=y.box(Fl.fkri,new Uint8Array([0,0,0,0]),t);if(n.push(t),e&&e.byteLength&&n.push(y.box(Fl.fkai,e)),i&&i.byteLength&&n.push(y.box(Fl.fkcx,i)),r&&r.length){const t=new Uint8Array(4*r.length);let e=0;for(const i of r)y.set32(i,t,e),e+=4;n.push(y.box(Fl.fkvl,t))}return y.box.apply(null,n)}(r.keyId,r.assetId,r.ssc,r.versionList));return r=y.box.apply(null,n),y.pssh(Ml.systemId,null,r)}makeKeyRequestMessage(e,t){return t?De.strToUtf8array("renew"):new Uint8Array}makeProcessLicenseRequestMessage(e,t,i){e=JSON.stringify([{keyID:Zo.base64Encode(e.decryptdata.keyId),payload:Zo.base64Encode(t)}]);return De.strToUtf8array(e)}handleKeyMessage(e){const t=e.target,i=t.sessionId,r=e.messageType,n=this.sessionIdToKeyUri[i];let a=null;if(n)a=this.keyUriToKeyInfo[n];else for(const e of Object.values(this.keyUriToKeyInfo))e&&e.session===t&&(a=e);if(a)switch(r){case"license-request":{const t=$(e.message),i=De.utf8arrayToStr(t);try{JSON.parse(i).forEach(e=>{var t=Zo.base64DecodeToStr(e.keyID),e=Zo.base64Decode(e.payload),t=this.keyIdToKeyInfo[t];t&&this.resolveSPCPromise(t,e)})}catch(e){this.resolveSPCPromise(a,t)}break}case"license-renewal":{const t=$(e.message);this.resolveSPCPromise(a,t);break}case"license-release":this._handleLicenseRelease(t,a)}}_handleLicenseRelease(e,i){const t=performance.now();e.update(De.strToUtf8array("acknowledged")).then(()=>{var e;null!=(e=this.sessionHandler)&&e.report(ps,{eventId:6,range:{tbegin:t,tend:performance.now()},keyuri:i.decryptdata.uri,keyRequestState:i.requestState})}).catch(e=>{var t;this.logger.error(`Promise error: `+e.message),null!=(t=this.sessionHandler)&&t.report(us,{hlsError:new hl(i.decryptdata.uri,pe.KeySystemFailedToReleaseLicense,!1,!1,e.message)})})}}],["com.apple.fps",r]],playready:[["com.microsoft.playready.recommendation",n]],widevine:[["com.widevine.alpha",class extends Tl{constructor(e,t,i,r,n,a,s,o){super(e,t,i,r,!1,n,a,s,o),this.shouldDestroyMediaKeys=!0}static get systemId(){return Ql}static get requestAccessConfig(){return Vl}get needsCert(){return!0}removeKey(e){return super.removeSessions(e,!0)}ensureKeyContext(e){var t=e.uri,t=this.keyUriToKeyInfo[t];return!t||t.shouldReuseSession&&t.licenseChallenge||null!=t&&t.session&&(t.oldSessions.push(t.session),t.session=void 0),super.ensureKeyContext(e)}_scheduleRenewal(e,t){this.config.widevineProactiveRenewal&&super._scheduleRenewal(e,t)}generateInitData(e){return{initData:e.pssh||new Uint8Array,initDataType:"cenc"}}generateRequestInitialized(e){var t=e.licenseChallenge;return e.requestInfo=void 0,e.resolveState(Xo.GET_CHALLENGE,void 0!==t?t:new me(!1,pe.KeySystemUndefinedChallenge)),Pe}handleKeyMessage(i){if(!this.isDestroying){const r=i.target;let e=null,t=null;if(r.sessionId in this.sessionIdToKeyUri)e=this.sessionIdToKeyUri[r.sessionId],t=this.keyUriToKeyInfo[e];else for(const[i,n]of Object.entries(this.keyUriToKeyInfo))if(n.session===r){e=i,t=n;break}if(t)switch(i.messageType){case"license-request":{const r=$(i.message);t.resolveState(Xo.GET_CHALLENGE,r);break}case"license-renewal":if(!this.config.widevineProactiveRenewal){const r=$(i.message);t.cacheChallenge(r,!0),this._signalRenewal(t)}}}}}]]},Kl=El.id;class jl{constructor(e){this.Zt=e,this.$e={},this.Ve=new Ie}createMediaKeys(i,e,t,r,n,a){let s=(this.Zt.maintainMediaKeysBetweenSessions?jl.idToMediaKeysInfoMap:this.$e)[i];return s||(e=rl.getCapabilities(e,t),t=new $r,jl.requestKeySystemAccess(i,e,n,r,a).pipe(Ae(e=>{this.Zt.maintainMediaKeysBetweenSessions?jl.idToMediaKeysInfoMap[i].keySystemAccess=e:this.$e[i].keySystemAccess=e;const t=performance.now();return yr(e.createMediaKeys()).pipe(Ee(()=>{null!=a&&a.report(ps,{eventId:1,range:{tbegin:t,tend:performance.now()}})}))}),ye(e=>{if(e instanceof hl)throw e;throw new hl("",pe.KeySystemFailedToInitialize,!1,!0,void 0,e.message)}),an(jl.destroy$)).subscribe(t),s=this.Zt.maintainMediaKeysBetweenSessions?jl.idToMediaKeysInfoMap[i]={mediaKeys$:t,keySystemAccess:null}:this.$e[i]={mediaKeys$:t,keySystemAccess:null}),s.mediaKeys$}destroyMediaKeys(){this.Zt.maintainMediaKeysBetweenSessions?(jl.destroy$.next(),jl.idToMediaKeysInfoMap={}):(this.Ve.next(),this.$e={})}static getKeySystemIdForDecryptData(e){let t;if(e){t=Kl;var i=e.format;for(const e of ml){var r=Hl[e];if((null==r?void 0:r.keyFormatString)===i){t=e;break}}}if(t)return t;throw Error("No matching key system")}static requestKeySystemAccess(e,t,i,r,n){if("undefined"==typeof navigator||void 0===navigator.requestMediaKeySystemAccess)return Fr(()=>new hl("",pe.KeySystemUndefinedNavigator,!1,!0));const a=ql[e];let s=Fr(()=>new hl("",pe.KeySystemNoKeySystemsToTry,!1,!0));for(const e of a){const a=e[0],l=e[1],pe=(o=i)&&"object"==typeof o?i:l.requestAccessConfig,d=[Object.assign({},pe,t)];s=s.pipe(ye(()=>jl.requestKeySystemInternal(a,d,r,n)))}var o;return s}static requestKeySystemInternal(e,t,i,r){const n=performance.now();return Mn(()=>yr(navigator.requestMediaKeySystemAccess(e,t)).pipe(Ee(()=>{null!=r&&r.report(ps,{eventId:0,range:{tbegin:n,tend:performance.now()}})}),ye(e=>{throw new hl("",pe.KeySystemRequestMediaKeySystemAccessError,!1,!0,void 0,e.message)})))}make(e,t,i,r,n,a,s,o){var l=this.Zt.maintainMediaKeysBetweenSessions?null==(u=jl.idToMediaKeysInfoMap[e])?void 0:u.keySystemAccess:null==(u=this.$e[e])?void 0:u.keySystemAccess;if(!l)throw new hl("",pe.KeySystemNoKeySystemAccess,!1,!0);let d;var u=Hl[e].systemStringPrefix;for(const t of ql[e])if(t[0]===l.keySystem){d=t[1];break}if(d)return new d(t,u,i,r,n,a,s,o);throw new hl("",pe.KeySystemNoConstructor,!1,!0)}static get availableKeySystems(){return Object.keys(Hl)}static getKeySystemFormat(e){e=Hl[e];return e?e.keyFormatString:""}static getKeySystemSecurityLevel(e){e=Hl[e];return e?e.securityLevels:void 0}}jl.idToMediaKeysInfoMap={},jl.destroy$=new Ie;const $l=["avc1.42E01E"],Gl=["mp4a.40.2"];function Wl(e,t,i){i=qo(i);return t?t instanceof dn?t=new ul(e,pe.KeySystemRequestTimedOut):t instanceof zs&&(t=new cl(e,t.statusCode,!1,Yo.HttpError,void 0,void 0,t.message)):t=new hl(e,pe.KeySystemCDMUnknownError,!1,!1),(t instanceof cl||t instanceof ul||t instanceof hl)&&(t.keyuri=e,t.mediaOptionIds=[...i]),t}class zl{constructor(e,t,i,n,r,a,s,o,l=void 0,d=void 0,u=new jl(i)){this.ze=e,this.Zt=i,this.He=n,this.Qe=a,this.Ke=s,this.We=l,this.Ge=d,this.Xe=u,this.Ye=new Ie,this.Je=new Ie,this.Ze=new jr(null),this.ei=new Ie,this.ni=new $r,this.ri={},this.oi=null,this.ai={},this.ci=r,this.ksQuery=e.query,this.R=o.child({name:"eme"}),this.Zt.warmupCdms&&this.di(this.gi(this.Zt.keySystemPreference).keyTagInfo).subscribe();a=t.pipe(Ae(t=>{var e=this.bi,i=[];let r;return this.bi=t,e&&i.push(e.clearMediaKeys()),(r=t&&(this.keySystem?i.push(this.Si(t)):i.push(ol(n.platformInfo$,e=>!0===(null==e?void 0:e.requiresCDMAttachOnStart)).pipe(Ae(()=>this.Si(t)))),this.wi())?this.ksQuery.selectCount().pipe(ve(e=>4<=e),Te(),Ae(e=>e?Pe.pipe(Qr(()=>{const t=performance.now(),e=this.ksQuery.getAll();let i=1/0;return e.forEach(e=>{e.minHoldTime>t&&(i=Math.min(e.minHoldTime,i))}),fe(i)?rr(i):Se},1),Ae(()=>_n([t.mediaQuery.bufferedSegmentsTuple$,t.mediaQuery.updating$]).pipe(Ur(([,e])=>!1===e),ve(([e])=>{const t=new Set;return e.forEach(e=>e.forEach(e=>{e=null==(e=e.frag.keyTagInfo)?void 0:e.uri;e&&t.add(e)})),t}),Te(ie)))):Se),Er(this.Ii.bind(this))):r)?Bn(Lr(...i),r):Lr(...i)}));Bn(a,this.Ze.pipe(Ae(e=>e?e.keyStatusChange$.pipe(Ee(e=>{var t=e.decryptdata.uri,i=this.ksQuery.getKeyInfo(t);"needs-renewal"===e.status?this.ze.updateKeyRequestState(t,Oo.MustRequestResponse,e=>e===Oo.GotKeyResponse):(i=Wl(t,e.error,i),this.ze.setError(t,i,!0)),this.ei.next(e)})):Se))).pipe(ye(e=>Se),Hr(()=>{this.bi=void 0,this.ci=void 0}),an(this.Ye)).subscribe()}get keyStatusChange$(){return this.ei}get keySystem(){return this.Ze.value}destroy(){const e=this.bi;this.Ye.next();let t=Pe;this.oi=null;var i=this.keySystem;let r=Pe;if(i){const e=this.ksQuery.getAll();t=this.Ti(e,!1),this.Ze.next(null),i.shouldDestroyMediaKeys&&this.Xe.destroyMediaKeys(),r=i.destroy()}this.ze.removeAll();i=[Lr(t,r)];return e&&i.push(e.clearMediaKeys()),this.ri={},Pn(i).pipe(ve(()=>{}))}Si(e){return(this.keySystem?e.setMediaKeys(this.keySystem.mediaKeys,this.Qe):this.Oi(this.gi(this.Zt.keySystemPreference))).pipe(ve(()=>{this.ni.next(!0),this.ni.complete()}))}gi(e){e=e?jl.getKeySystemFormat(e):Ko.keyFormatString;return new nl(new al,"NONE",void 0,null,e,[1])}wi(){return!0===this.Zt.useMultipleKeySessions||"widevine"===this.Zt.keySystemPreference||"playready"===this.Zt.keySystemPreference}static _eligibleForCleanup(e,t,i){return"AES-128"!==i.decryptdata.method&&i.requestState!==Oo.WaitingForKeyResponse&&!t.has(i.keyUri)&&(e>=i.minHoldTime||0===i.mediaOptionKeys.length&&fe(i.minHoldTime))}Ii(e){var t=performance.now();this.ksQuery.getCount();const i=this.ksQuery.getAll({filterBy:zl._eligibleForCleanup.bind(null,t,e)}),r=new Array;return Oe(()=>{for(const t of i){var e=Ho(t.decryptdata);r.push(this.Mi(t.keyUri,e))}}),this.ksQuery.getCount(),r.length?Pn(r):Pe}Mi(e,t,i=!0){this.Je.next(e),i&&null!=(i=this.ksQuery.getEntity(e))&&i.error||this.ze.removeKey(e);i=this.keySystem;return null===i?Pe:i.removeKey(t)}removeItems(t){Oe(()=>{for(const e of t)this.ze.removeItemFromKeys(e)})}removeItemsAndKeys(e){var t;return this.wi()?(this.removeItems(e),t=this.ksQuery.getAll({filterBy:e=>fe(e.minHoldTime)&&0===e.mediaOptionKeys.length}),this.Ti(t,!0)):(this.removeItems(e),Pe)}Ti(e,t){var i=[];for(const r of e)i.push(this.Mi(r.keyUri,Ho(r.decryptdata),t));return i.length?Pn(i).pipe(Ae(()=>Pe)):Pe}get availableKeySystems(){return jl.availableKeySystems}initialize(e){var t=this.Zt.keySystemPreference;for(const n of jl.availableKeySystems){var i=e[n];if(i&&t===n){var r=i.certificate,i=i.serverCertUrl?Va.buildAbsoluteURL(window.location.href,i.serverCertUrl):void 0;let e=this.ri[n];e?e.info$.value.certificate||e.info$.next({serverCertUrl:i,certificate:r}):e=this.ri[n]={info$:new jr({serverCertUrl:i,certificate:r}),request$:void 0}}}}generateRequest(e,t){return t.pin&&this.ze.setPinnedKey(e,performance.now()+this.Zt.keyMinHoldTimeBeforeCleanup),!!this.keySystem&&this.keySystem.setKeyRequestInfo(e,t)}setLicenseResponse(e,t){this.keySystem&&this.keySystem.setParsedResponse(e,t)}getKeyFromDecryptData(e,t,i,r){var n;if(!e||!e.isEncrypted)return null!=(n=this.He.platformInfo)&&n.requiresCDMAttachOnStart?ol(this.ni,e=>e).pipe(ve(()=>e)):be(e);let a;return Oe(()=>{a=this.Ai(e,t,i,r)}),a}Ai(i,r,n,e){var a;let s=null,o=performance.now()+e;r&&(s=r.mediaOptionId);const l=i.uri,d=(this.ksQuery.hasEntity(l)&&(null!=r&&this.ze.addMediaOption(l,r),(null==(a=this.ksQuery.getEntity(l))?void 0:a.minHoldTime)===1/0&&(o=1/0),this.ze.updateMinHoldTime(l,o)),this.ksQuery.getKeyInfo(l));if(((null==d?void 0:d.error)instanceof cl||(null==d?void 0:d.error)instanceof hl)&&!1===d.error.isOkToRetry){let e=Fr(()=>d.error);return e=this.We?e.pipe(this.We):e}if(d&&d.requestState!==Oo.MustRequestResponse)return d.requestState===Oo.GotKeyResponse?be(Ho(d.decryptdata)):this.ai[l];{if(this.Je.next(l),!(r||d&&0!==d.mediaOptionKeys.length))return Fr(()=>new cl(l,pe.KeySystemAbort,!1,Yo.Abort,void 0,void 0,"Key not associated with any items"));let e;this.ze.upsertKey({keyUri:l,decryptdata:function(e){var{method:t,isEncrypted:i,uri:r,format:n,formatversions:a}=e;return{method:t,isEncrypted:i,uri:r,format:n,formatversions:a,ivBuf:null==(t=e.iv)?void 0:t.buffer,keyIdBuf:null==(i=e.keyId)?void 0:i.buffer,keyBuf:null==(r=e.key)?void 0:r.buffer,psshBuf:null==(n=e.key)?void 0:n.buffer}}(i),minHoldTime:o,mediaOptionKeys:r?[r]:[],requestState:Oo.WaitingForKeyResponse});const a=i.method;switch(a){case"SAMPLE-AES":case"ISO-23001-7":case"SAMPLE-AES-CTR":{const a=n.keyLoadPolicy.customURL;if(!d&&r&&!1===this.Zt.allowKeySwitch){const i=r.mediaOptionType;if(i!==we.Subtitle&&1<this.ksQuery.getCount(e=>e.mediaOptionKeys.some(e=>e.mediaOptionType===i))){e=Fr(()=>new cl(l,pe.KeySystemExceedMaxKeys,!1,Yo.Abort,!1));break}}e=this.fetchKeyEME(i,n).pipe(un(void 0!==a.maxLoadTimeMs?a.maxLoadTimeMs:0));break}case"AES-128":e=this.fetchKeyHTTP(i.uri,i,n.keyLoadPolicy);break;default:return Fr(()=>new me(!1,pe.KeySystemUnexpectedMETHOD,`Unexpected METHOD attribute `+a))}let t=e.pipe(ve(e=>{var t=e.decryptdata;return this.ze.updateKeyValue(l,t.key),e.mediaOptionId=s,null!=(t=this.ci)&&t.trigger(L.KEY_LOADED,e),e.decryptdata}),ye(e=>{var t=this.ksQuery.getKeyInfo(l);throw e=Wl(l,e,t),this.ze.setError(l,e,!1),null!=(t=this.Qe)&&t.report(28,{timestamp:performance.now(),keyuri:l,mediaOptionId:null!=s?s:void 0,mediaOptionIds:e.mediaOptionIds}),e}));return t=(t=this.We?t.pipe(this.We):t).pipe(Jr(),an(Wr(this.Je.pipe(Ur(e=>e===l)),this.Ye).pipe())),(this.ai[l]=t).subscribe({error:e=>{this.ze.setError(l,e,!0)},complete:()=>{var e;null!=(e=this.ksQuery.getKeyInfo(l))&&e.requestState,this.ze.updateKeyRequestState(l,Oo.MustRequestResponse,e=>e===Oo.WaitingForKeyResponse),this.ai[l]===t&&delete this.ai[l]}}),t}}fetchKeyEME(i,r){return this.Oi(i).pipe(Ae(({keySystem:e,keySystemId:t})=>Pn([e.startKeyRequest(i),this.Ei(t,e,r.certLoadPolicy)])),ve(([e])=>{var t=performance.now(),i=e.uri;return{timestamp:t,keyuri:i,decryptdata:e,appItemIds:this.ksQuery.getAppItemIds(i)}}))}fetchKeyHTTP(e,t,i){return zl.fetchKeyHTTP(e,this.Zt,t,i,this.Ke,this.ksQuery,this.R)}static fetchKeyHTTP(t,e,i,r,n,a,s){e={url:t,xhrSetup:e.xhrSetup};return bo(e,no(e,r),n).pipe(ve(([e])=>(i.key=G(e),{decryptdata:i,keyuri:t,timestamp:performance.now(),appItemIds:a.getAppItemIds(t)})))}Ni(t){return Mn(()=>{if(!this.ci||!this.oi)throw new hl("",pe.KeySystemFailedToInitialize,!1,!1);let e=this.keySystem;return e||(e=this.Xe.make(this.oi,t,this.Zt,this.ci,this.Qe,this.Ke,this.ze,this.R),this.Ze.next(e)),be({keySystem:e,keySystemId:this.oi})})}Oi(e){return this.di(e).pipe(Ae(e=>{var t;return Pn([this.Ni(e),null!=(t=null==(t=this.bi)?void 0:t.setMediaKeys(e,this.Qe))?t:Pe])}),ve(e=>e[0]))}di(e){var t=jl.getKeySystemIdForDecryptData(e);if(null==this.oi)this.oi=t;else if(this.oi!==t)throw new hl(e.uri,pe.KeySystemUnmatchedString,!1,!1,void 0,`New key system string does not match existing ${t} !== `+this.oi);return this.Xe.createMediaKeys(this.oi,$l,Gl,this.R,null==(e=this.He.platformInfo)?void 0:e.keySystemConfig,this.Qe)}Ri(e,t){t=no({url:e},t);let i=bo({url:e,xhrSetup:this.Zt.xhrSetup},t,this.Ke).pipe(ve(([e])=>$(e)),ye(e=>{if(e instanceof to)throw new ro(!0,pe.KeySystemCertificateLoadError,e.isCustomUrl,e.timeoutType);if(e instanceof zs)throw new ro(!1,e.statusCode,e.isCustomUrl);throw new me(!0,pe.KeySystemCertificateLoadError)}));return i=this.Ge?i.pipe(this.Ge(t)):i}Ei(e,t,i){let r=this.ri[e];const{info$:n,request$:a}=r=r||(this.ri[e]={info$:new jr({}),request$:void 0});if(!t.needsCert)return be(!1);if(a)return a;let s=ol(n,({serverCertUrl:e,certificate:t})=>null!=e||null!=t);e=null!=(e=null!=(e=i.customURL.maxTimeToFirstByteMs)?e:i.customURL.maxLoadTimeMs)?e:NaN,e=(s=fe(e)&&0<e?s.pipe(un({each:e,with:()=>{throw r&&(r.request$=void 0),new ul("",pe.KeySystemCertificateLoadError)}})):s).pipe(Ae(({serverCertUrl:e,certificate:t})=>t?be(t):e?this.Ri(e,i):Se),Ae(e=>(n.next({certificate:e}),t.setServerCertificate(e))),Jr(),an(this.Ye));return(r.request$=e).pipe(ye(()=>Se)).subscribe(),r.request$}}function Yl(){return Ur(e=>null!=e)}function Xl(t,a,s){return e=>new F(i=>{let r=0,n=t;return e.subscribe({next:e=>{try{var t=n;n=e,a(t,e)||i.next(s([t,e],r++))}catch(e){i.error(e)}},error:i.error.bind(i),complete:i.complete.bind(i)})})}class Jl extends ga{constructor(e){super(e)}getKeyInfo(e){e=this.getEntity(e);return null!=e&&e.error?Object.assign(Object.assign({},e),{error:pl(e.error,qo(e))}):e}getKeyRequestState$(e){return this.selectEntity(e,e=>null==e?void 0:e.requestState)}getKeyStatus$(e){return this.selectEntity(e,e=>null==e?void 0:e.status)}getKeyError$(e){return this.selectEntity(e,e=>pl(null==e?void 0:e.error,qo(e))).pipe(Yl())}getAppItemIds(e){var t=new Set,i=null==(e=this.getEntity(e))?void 0:e.mediaOptionKeys;if(i)for(const e of i)e.appItemId&&t.add(e.appItemId);return Array.from(t)}}class Zl extends ua{constructor(){super({},{name:"key-system-store",idKey:"keyUri"})}}class ed{constructor(e,t){this.Me=e,this.Pi=t,this._i=new Jl(this.Me)}get query(){return this._i}upsertKey(i){const r={};function n(e,t){for(const i of e){const{itemId:e,mediaOptionId:r,appItemId:n,mediaOptionType:a}=i;t[e+r]={itemId:e,mediaOptionId:r,appItemId:n,mediaOptionType:a}}}n(i.mediaOptionKeys,r),this.Me.upsert(i.keyUri,e=>{var t=Object.assign(Object.assign({},e),i);return"mediaOptionKeys"in e&&n(e.mediaOptionKeys,r),t.mediaOptionKeys=Object.values(r),t},()=>Object.assign(Object.assign({},i),{mediaOptionKeys:Object.values(r)}))}removeKey(e){this.Me.remove(e)}removeItemFromKeys(i){const e=this._i.getAll();Oe(()=>{e.forEach(e=>{var t;e.mediaOptionKeys.some(e=>e.itemId===i)&&(t=e.mediaOptionKeys.filter(e=>e.itemId!==i),this.Me.update(e.keyUri,{mediaOptionKeys:t}))})})}removeAll(){this.Me.remove()}updateKeyValue(e,t){var i=this._i.getEntity(e);i&&(t={requestState:Oo.GotKeyResponse,decryptdata:null==i.decryptdata.keyBuf&&null!=t?Object.assign(Object.assign({},i.decryptdata),{keyBuf:t.buffer}):i.decryptdata},this.Me.update(e,t))}updateKeyStatus(e,t){var i=this._i.getEntity(e);null!=i&&i.status!==t&&this.Me.update(e,{status:t})}updateKeyRequestState(e,t,i){var r=this._i.getEntity(e);null==r||i&&!1===i(r.requestState)||this.Me.update(e,{requestState:t})}updateMinHoldTime(e,t){var i=null==(i=this._i.getEntity(e))?void 0:i.minHoldTime;null!=i&&i!==t&&this.Me.update(e,{minHoldTime:t})}setPinnedKey(e,t){var i=null==(i=this._i.getEntity(e))?void 0:i.minHoldTime;if(null!=i&&i!==1/0){const r=this.query.getAll({filterBy:e=>e.minHoldTime===1/0}).map(e=>e.keyUri);Oe(()=>{0<r.length&&this.Me.update(r,{minHoldTime:t}),this.Me.update(e,{minHoldTime:1/0})})}}addMediaOption(e,t){var{itemId:i,mediaOptionId:r,appItemId:n,mediaOptionType:a}=t,s=null==(s=this._i.getEntity(e))?void 0:s.mediaOptionKeys;s&&!s.some(e=>_s(e,t))&&this.Me.update(e,{mediaOptionKeys:[...s,{itemId:i,mediaOptionId:r,appItemId:n,mediaOptionType:a}]})}setError(e,t,i){t={error:pl(t)};i&&(t.requestState=Oo.MustRequestResponse),this.Me.update(e,t)}}var td={},Ts={},As={},a={},Ss=(Object.defineProperty(a,"__esModule",{value:!0}),a.isValidScrollSetting=a.isValidPositionAlignSetting=a.isValidLineAlignSetting=a.isValidLineAndPositionSetting=a.isValidDirectionSetting=a.isValidAlignSetting=a.isValidPercentValue=void 0,a.isValidPercentValue=function(e){return"number"==typeof e&&0<=e&&e<=100},a.isValidAlignSetting=function(e){return"string"==typeof e&&["start","center","end","left","right","middle"].includes(e)},a.isValidDirectionSetting=function(e){return"string"==typeof e&&["","rl","lr"].includes(e)},a.isValidLineAndPositionSetting=function(e){return"number"==typeof e||"auto"===e},a.isValidLineAlignSetting=function(e){return"string"==typeof e&&["start","center","end"].includes(e)},a.isValidPositionAlignSetting=function(e){return"string"==typeof e&&["line-left","center","line-right","auto","left","start","middle","end","right"].includes(e)},a.isValidScrollSetting=function(e){return["","up"].includes(e)},{}),id=(Object.defineProperty(Ss,"__esModule",{value:!0}),{"&amp;":"&","&lt;":"<","&gt;":">","&lrm;":"‎","&rlm;":"‏","&nbsp;":" "}),rd={c:"span",i:"i",b:"b",u:"u",ruby:"ruby",rt:"rt",v:"span",lang:"span"},nd={v:"title",lang:"lang"},ad={rt:"ruby"},sd={"text-combine-upright":"-webkit-text-combine:horizontal; text-orientation: mixed;"};class od{static parseTimeStamp(e){function t(e){var[e,t,i,r]=e.map(e=>e?parseInt(""+e):0);return 3600*e+60*t+i+r/1e3}e=/^(\d+):(\d{2})(:\d{2})?\.(\d{3})/.exec(e);return e?e[3]?t([e[1],e[2],e[3].substring(1),e[4]]):59<parseInt(e[1])?t([e[1],e[2],null,e[4]]):t([null,e[1],e[2],e[4]]):null}static parseContent(e,t,i){var r=t.text;function n(e){return id[e]}for(var a,s,o,l,d,t=e.document.createElement("div"),u=[],c=t;null!==(d=void 0,d=r?(d=(d=/^([^<]*)(<[^>]+>?)?/.exec(r))[1]||d[2],r=r.substr(d.length),d):null);)if("<"!==d[0])c.appendChild(e.document.createTextNode(d.replace(/&(amp|lt|gt|lrm|rlm|nbsp);/g,n)));else{if("/"===d[1]){u.length&&u[u.length-1]===d.substr(2).replace(">","")&&(u.pop(),c=c.parentNode);continue}var h=od.parseTimeStamp(d.substr(1,d.length-2)),p=void 0;if(h){p=e.document.createProcessingInstruction("timestamp",h.toString()),c.appendChild(p);continue}if(!(h=/^<([^.\s/0-9>]+)(\.[^\s\\>]+)?([^>\\]+)?(\\?)>?$/.exec(d)))continue;if(d=h[1],a=h[2],s=h[3],l=o=void 0,!(p=(l=rd[d])?((o=e.document.createElement(l)).dataset.localName=l,(l=nd[d])&&s&&(o[l]=s.trim()),a&&(i[a]?(d=function(e){var t,i="";for(t in e)i+=sd[t]||t+":"+e[t]+";";return i}(i[a]),o.setAttribute("style",d)):console.info("WebVTT: parseContent: Style referenced, but no style defined for '".concat(a,"'!"))),o):null))continue;if(l=c,ad[(s=p).dataset.localName]&&ad[s.dataset.localName]!==l.dataset.localName)continue;u.push(h[1]),c.appendChild(p),c=p}return t}}Ss.default=od;var bs=t&&t.__decorate||function(e,t,i,r){var n,a=arguments.length,s=a<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,r);else for(var o=e.length-1;0<=o;o--)(n=e[o])&&(s=(a<3?n(s):3<a?n(t,i,s):n(t,i))||s);return 3<a&&s&&Object.defineProperty(t,i,s),s},ld=(Object.defineProperty(As,"__esModule",{value:!0}),As.VTTCue=void 0,a),dd=Ss,i=bs([function(e){var t=e;return"undefined"!=typeof window&&null!=window.VTTCue&&((t=window.VTTCue).create=e.create,t.fromJSON=e.fromJSON,t.prototype.toJSON=e.prototype.toJSON),t}],class{constructor(e,t,i){this._id="",this._pauseOnExit=!1,this._region=null,this._vertical="",this._snapToLines=!0,this._line="auto",this._lineAlign="start",this._position="auto",this._positionAlign="auto",this._size=100,this._align="center",this.hasBeenReset=!1,this._startTime=e,this._endTime=t,this._text=i}get id(){return this._id}set id(e){this._id=""+e}get pauseOnExit(){return this._pauseOnExit}set pauseOnExit(e){this._pauseOnExit=!!e}get startTime(){return this._startTime}set startTime(e){if("number"!=typeof e)throw new TypeError("Start time must be set to a number: ".concat(e));this._startTime=e,this.hasBeenReset=!0}get endTime(){return this._endTime}set endTime(e){if("number"!=typeof e)throw new TypeError("End time must be set to a number: ".concat(e));this._endTime=e,this.hasBeenReset=!0}get text(){return this._text}set text(e){this._text=""+e,this.hasBeenReset=!0}get region(){return this._region}set region(e){this._region=e,this.hasBeenReset=!0}get vertical(){return this._vertical}set vertical(e){if(!ld.isValidDirectionSetting(e))throw new SyntaxError("An invalid or illegal string was specified for vertical: ".concat(e));this._vertical=e,this.hasBeenReset=!0}get snapToLines(){return this._snapToLines}set snapToLines(e){this._snapToLines=!!e,this.hasBeenReset=!0}get line(){return this._line}set line(e){if(!ld.isValidLineAndPositionSetting(e))throw new SyntaxError("An invalid number or illegal string was specified for line: ".concat(e));this._line=e,this.hasBeenReset=!0}get lineAlign(){return this._lineAlign}set lineAlign(e){if(!ld.isValidLineAlignSetting(e))throw new SyntaxError("An invalid or illegal string was specified for lineAlign: ".concat(e));this._lineAlign=e,this.hasBeenReset=!0}get position(){return this._position}set position(e){if(!ld.isValidLineAndPositionSetting(e))throw new Error("Position must be between 0 and 100 or auto: ".concat(e));this._position=e,this.hasBeenReset=!0}get positionAlign(){return this._positionAlign}set positionAlign(e){if(!ld.isValidPositionAlignSetting(e))throw new SyntaxError("An invalid or illegal string was specified for positionAlign: ".concat(e));this._positionAlign=e,this.hasBeenReset=!0}get size(){return this._size}set size(e){if(e<0||100<e)throw new Error("Size must be between 0 and 100: ".concat(e));this._size=e,this.hasBeenReset=!0}get align(){return this._align}set align(e){if(!ld.isValidAlignSetting(e))throw new SyntaxError("An invalid or illegal string was specified for align: ".concat(e));this._align=e,this.hasBeenReset=!0}getCueAsHTML(){return dd.default.parseContent(window,this,{})}static create(t){var i;if(t.hasOwnProperty("startTime")&&t.hasOwnProperty("endTime")&&t.hasOwnProperty("text"))return i=new this(t.startTime,t.endTime,t.text),Object.keys(t).forEach(e=>{i.hasOwnProperty(e)&&(i[e]=t[e])}),i;throw new Error("You must at least have start time, end time, and text.")}static fromJSON(e){return this.create(JSON.parse(e))}toJSON(){var t={};return Object.keys(this).forEach(e=>{this.hasOwnProperty(e)&&"getCueAsHTML"!==e&&"hasBeenReset"!==e&&"displayState"!==e&&(t[e]=this[e])}),t}}),e=(As.VTTCue=i,{}),r=t&&t.__decorate||function(e,t,i,r){var n,a=arguments.length,s=a<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,r);else for(var o=e.length-1;0<=o;o--)(n=e[o])&&(s=(a<3?n(s):3<a?n(t,i,s):n(t,i))||s);return 3<a&&s&&Object.defineProperty(t,i,s),s},ud=(Object.defineProperty(e,"__esModule",{value:!0}),e.VTTRegion=void 0,a),n=r([function(e){var t=e;return"undefined"!=typeof window&&null!=window.VTTRegion&&((t=window.VTTRegion).create=e.create,t.fromJSON=e.fromJSON,t.prototype.toJSON=e.prototype.toJSON),t}],class{constructor(){this._id="",this._lines=3,this._regionAnchorX=0,this._regionAnchorY=100,this._scroll="",this._viewportAnchorX=0,this._viewportAnchorY=100,this._width=100}get id(){return this._id}set id(e){if("string"!=typeof e)throw new Error("ID must be a string.");this._id=e}get lines(){return this._lines}set lines(e){if("number"!=typeof e)throw new TypeError("Lines must be set to a number.");this._lines=e}get regionAnchorX(){return this._regionAnchorX}set regionAnchorX(e){if(!ud.isValidPercentValue(e))throw new TypeError("RegionAnchorX must be between 0 and 100.");this._regionAnchorX=e}get regionAnchorY(){return this._regionAnchorY}set regionAnchorY(e){if(!ud.isValidPercentValue(e))throw new TypeError("RegionAnchorY must be between 0 and 100.");this._regionAnchorY=e}get scroll(){return this._scroll}set scroll(e){if("string"==typeof e){e=e.toLowerCase();if(ud.isValidScrollSetting(e))return void(this._scroll=e)}throw new SyntaxError("An invalid or illegal string was specified.")}get viewportAnchorX(){return this._viewportAnchorX}set viewportAnchorX(e){if(!ud.isValidPercentValue(e))throw new TypeError("ViewportAnchorX must be between 0 and 100.");this._viewportAnchorX=e}get viewportAnchorY(){return this._viewportAnchorY}set viewportAnchorY(e){if(!ud.isValidPercentValue(e))throw new TypeError("ViewportAnchorY must be between 0 and 100.");this._viewportAnchorY=e}get width(){return this._width}set width(e){if(!ud.isValidPercentValue(e))throw new TypeError("Width must be between 0 and 100.");this._lines=e}toJSON(){var t={};return Object.keys(this).forEach(e=>{this.hasOwnProperty(e)&&(t[e]=this[e])}),t}static create(t){var i=new this;return Object.keys(t).forEach(e=>{i.hasOwnProperty(e)&&(i[e]=t[e])}),i}static fromJSON(e){return this.create(JSON.parse(e))}}),bs=(e.VTTRegion=n,{});Object.defineProperty(bs,"__esModule",{value:!0});{i=Ts;var cd=t&&t.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){e[r=void 0===r?i:r]=t[i]}),a=t&&t.__exportStar||function(e,t){for(var i in e)"default"===i||t.hasOwnProperty(i)||cd(t,e,i)},hd=(Object.defineProperty(i,"__esModule",{value:!0}),i.VTTRegion=i.VTTCue=i.WebVTTParser=i.ParsingError=void 0,As),pd=(Object.defineProperty(i,"VTTCue",{enumerable:!0,get:function(){return hd.VTTCue}}),e),md=(Object.defineProperty(i,"VTTRegion",{enumerable:!0,get:function(){return pd.VTTRegion}}),Ss);class iv extends Error{constructor(e,t){super(),this.name="ParsingError",this.code="number"==typeof e?e:e.code,t?this.message=t:e instanceof iv&&(this.message=e.message)}}(i.ParsingError=iv).Errors={BadSignature:new iv(0,"Malformed WebVTT signature."),BadTimeStamp:new iv(1,"Malformed time stamp.")};class rv{constructor(){this.values={}}set(e,t){this.get(e)||""===t||(this.values[e]=t)}get(e,t,i){return"object"==typeof t&&"string"==typeof i?this.has(e)?this.values[e]:t[i]:this.has(e)?this.values[e]:t}has(e){return e in this.values}alt(e,t,i){for(var r=0;r<i.length;++r)if(t===i[r]){this.set(e,t);break}}integer(e,t){/^-?\d+$/.test(t)&&this.set(e,parseInt(t,10))}percent(e,t){if(t.match(/^([\d]{1,3})(\.[\d]*)?%$/))try{var i=parseFloat(t);if(0<=i&&i<=100)return this.set(e,i),!0}catch(e){}return!1}}class nv{constructor(e,t,i){this.window=e,this.state="INITIAL",this.styleCollector="",this.buffer="",this.decoder=t||new TextDecoder("utf8"),this.regionList=[],this.alreadyCollectedLine="",this.onStylesParsedCallback=i,this._styles={},this.middleOrCenter="center";t=new hd.VTTCue(0,0,"middleOrCenter");try{t.align="center","center"!==t.align&&(this.middleOrCenter="middle")}catch(e){this.middleOrCenter="middle"}}static StringDecoder(){return{decode:e=>{if(!e)return"";if("string"!=typeof e)throw new Error("Error - expected string data.");return decodeURIComponent(encodeURIComponent(e))}}}reportOrThrowError(e){if(!(e instanceof iv&&"function"==typeof this.onparsingerror))throw e;this.onparsingerror(e)}parseOptions(e,t,i,r){var n,a;for(n of r?e.split(r):[e])"string"==typeof n&&2===(a=n.split(i)).length&&t(a[0],a[1])}parseCue(t,e,a){var s,i=t,r=()=>{var e=md.default.parseTimeStamp(t);if(null===e)throw new iv(iv.Errors.BadTimeStamp,"Malformed timestamp: "+i);return t=t.replace(/^[^\sa-zA-Z-]+/,""),e},n=()=>{t=t.replace(/^\s+/,"")};if(n(),e.startTime=r(),n(),"--\x3e"!==t.substr(0,3))throw new iv(iv.Errors.BadTimeStamp,"Malformed time stamp (time stamps must be separated by '--\x3e'): ".concat(i));t=t.substr(3),n(),e.endTime=r(),n(),r=t,n=e,s=new rv,this.parseOptions(r,(e,t)=>{var i,r;switch(e){case"region":for(var n=a.length-1;0<=n;n--)if(a[n].id===t){s.set(e,a[n].region);break}break;case"vertical":s.alt(e,t,["rl","lr"]);break;case"line":r=(i=t.split(","))[0],s.integer(e,r),s.percent(e,r)&&s.set("snapToLines",!1),s.alt(e,r,["auto"]),2===i.length&&s.alt("lineAlign",i[1],["start","middle","center","end"]);break;case"position":i=t.split(","),s.percent(e,i[0]),2===i.length&&s.alt("positionAlign",i[1],["line-left","line-right","center","auto","left","start","middle","end","right"]);break;case"size":s.percent(e,t);break;case"align":s.alt(e,t,["start","center","end","left","right","middle"])}},/:/,/\s/),n.region=s.get("region",null),n.vertical=s.get("vertical",""),n.line=s.get("line",void 0===n.line?"auto":n.line),r=s.get("lineAlign","start"),n.lineAlign="center"===r||"middle"===r?this.middleOrCenter:r,n.snapToLines=s.get("snapToLines",!0),n.size=s.get("size",100),r=s.get("align","center"),n.align="center"===r||"middle"===r?this.middleOrCenter:r,n.position=s.get("position","auto"),r=s.get("positionAlign",{start:"start",left:"start",center:"center",middle:"middle",right:"end",end:"end"},n.align),n.positionAlign="center"===r||"middle"===r?this.middleOrCenter:{start:"start","line-left":"start",left:"start",center:"center",middle:"middle","line-right":"end",right:"end",end:"end"}[r]}parseRegion(e){var n=new rv;this.parseOptions(e,(e,t)=>{switch(e){case"id":n.set(e,t);break;case"width":n.percent(e,t);break;case"lines":n.integer(e,t);break;case"regionanchor":case"viewportanchor":var i,r=t.split(",");2===r.length&&((i=new rv).percent("x",r[0]),i.percent("y",r[1]),i.has("x")&&i.has("y"))&&(n.set(e+"X",i.get("x")),n.set(e+"Y",i.get("y")));break;case"scroll":n.alt(e,t,["up"])}},/=/,/\s/),n.has("id")&&((e=new pd.VTTRegion).width=n.get("width",100),e.lines=n.get("lines",3),e.regionAnchorX=n.get("regionanchorX",0),e.regionAnchorY=n.get("regionanchorY",100),e.viewportAnchorX=n.get("viewportanchorX",0),e.viewportAnchorY=n.get("viewportanchorY",100),e.scroll=n.get("scroll",""),this.onregion&&this.onregion(e),this.regionList.push({id:n.get("id"),region:e}))}parseStyle(e){var t,e=e.split("}");for(t of(e.pop(),e)){var i=null,r=null,n=t.split("{");n[0]&&(i=n[0].trim()),n[1]&&(r=(e=>{for(var t,i,r={},n=e.split(";"),a=0;a<n.length;a++)n[a].includes(":")&&(t=(i=n[a].split(":",2))[0].trim(),i=i[1].trim(),""!==t)&&""!==i&&(r[t]=i);return r})(n[1])),i&&r&&(this._styles[i]=r)}this.onStylesParsedCallback&&this.onStylesParsedCallback(this._styles)}parseHeader(e){this.parseOptions(e,function(e,t){"Region"===e&&this.parseRegion(t)},/:/)}parse(e){e&&(this.buffer+=this.decoder.decode(e,{stream:!0}));var t=()=>{for(var e=this.buffer,t=0,i={start:e.length,length:0};t<e.length;){var r=((e,t)=>{var i={start:-1,length:-1};if("\r"===e[t])i.start=t,i.length=1;else if("\n"===e[t])i.start=t,i.length=1;else if("<"===e[t]&&t+1<e.length&&"b"===e[t+1]&&t+2<e.length&&"r"===e[t+2]){for(var r=t+2;r<e.length&&">"!==e[r++];);i.start=t,i.length=r-t}return i})(e,t);if(0<r.length){i=r;break}++t}var n=e.substr(0,i.start);return this.buffer=e.substr(i.start+i.length),n};try{if("INITIAL"===this.state){if(!/\r\n|\n/.test(this.buffer))return this;this.alreadyCollectedLine="";var i=t(),r=/^(ï»¿)?WEBVTT([ \t].*)?$/.exec(i);if(!r||!r[0])throw new iv(iv.Errors.BadSignature);this.state="HEADER"}for(;this.buffer;){if(!/\r\n|\n/.test(this.buffer))return this;switch(this.alreadyCollectedLine?(i=this.alreadyCollectedLine,this.alreadyCollectedLine=""):i=t(),this.state){case"HEADER":i.includes(":")?this.parseHeader(i):i||(this.state="ID");continue;case"NOTE":i||(this.state="ID");continue;case"STYLE":i?this.styleCollector+=i:(this.parseStyle(this.styleCollector),this.state="ID",this.styleCollector="");continue;case"ID":if(/^NOTE($|[ \t])/.test(i)){this.state="NOTE";break}if(/^STYLE($|[ \t])/.test(i)){this.state="STYLE";break}if(!i)continue;if(this.cue=new hd.VTTCue(0,0,""),this.state="CUE",!i.includes("--\x3e")){this.cue.id=i;continue}case"CUE":try{this.parseCue(i,this.cue,this.regionList)}catch(e){this.reportOrThrowError(e),this.cue=null,this.state="BADCUE";continue}this.state="CUETEXT";continue;case"CUETEXT":var n=i.includes("--\x3e");if(!i||n){this.alreadyCollectedLine=i,this.oncue&&this.oncue(this.cue),this.cue=null,this.state="ID";continue}this.cue.text&&(this.cue.text+="\n"),this.cue.text+=i;continue;case"BADCUE":i||(this.state="ID");continue}}}catch(e){this.reportOrThrowError(e),"CUETEXT"===this.state&&this.cue&&this.oncue&&this.oncue(this.cue),this.cue=null,this.state="INITIAL"===this.state?"BADWEBVTT":"BADCUE"}return this}flush(){try{if(this.buffer+=this.decoder.decode(),!this.cue&&"HEADER"!==this.state||(this.buffer+="\n\n",this.parse()),"INITIAL"===this.state)throw new iv(iv.Errors.BadSignature)}catch(e){this.reportOrThrowError(e)}return this.onflush&&this.onflush(),this}styles(){return this._styles}}i.default=nv,i.WebVTTParser=nv,a(bs,i)}var fd,r={};{n=r;var gd=t&&t.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){e[r=void 0===r?i:r]=t[i]}),e=t&&t.__exportStar||function(e,t){for(var i in e)"default"===i||t.hasOwnProperty(i)||gd(t,e,i)},yd=(Object.defineProperty(n,"__esModule",{value:!0}),n.VTTCue=n.WebVTTRenderer=n.BoxPosition=n.CueStyleBox=n.StyleBox=void 0,As),vd=(Object.defineProperty(n,"VTTCue",{enumerable:!0,get:function(){return yd.VTTCue}}),Ss),Id=[/^(::cue\()(\..*)(\))/,/^(::cue\()(#.*)(\))/,/^(::cue\()(c|i|b|u|ruby|rt|v|lang)(\))/],Sd=[[1470,1470],[1472,1472],[1475,1475],[1478,1478],[1488,1514],[1520,1524],[1544,1544],[1547,1547],[1549,1549],[1563,1563],[1566,1610],[1645,1647],[1649,1749],[1765,1766],[1774,1775],[1786,1805],[1807,1808],[1810,1839],[1869,1957],[1969,1969],[1984,2026],[2036,2037],[2042,2042],[2048,2069],[2074,2074],[2084,2084],[2088,2088],[2096,2110],[2112,2136],[2142,2142],[2208,2208],[2210,2220],[8207,8207],[64285,64285],[64287,64296],[64298,64310],[64312,64316],[64318,64318],[64320,64321],[64323,64324],[64326,64449],[64467,64829],[64848,64911],[64914,64967],[65008,65020],[65136,65140],[65142,65276],[67584,67589],[67592,67592],[67594,67637],[67639,67640],[67644,67644],[67647,67669],[67671,67679],[67840,67867],[67872,67897],[67903,67903],[67968,68023],[68030,68031],[68096,68096],[68112,68115],[68117,68119],[68121,68147],[68160,68167],[68176,68184],[68192,68223],[68352,68405],[68416,68437],[68440,68466],[68472,68479],[68608,68680],[126464,126467],[126469,126495],[126497,126498],[126500,126500],[126503,126503],[126505,126514],[126516,126519],[126521,126521],[126523,126523],[126530,126530],[126535,126535],[126537,126537],[126539,126539],[126541,126543],[126545,126546],[126548,126548],[126551,126551],[126553,126553],[126555,126555],[126557,126557],[126559,126559],[126561,126562],[126564,126564],[126567,126570],[126572,126578],[126580,126583],[126585,126588],[126590,126590],[126592,126601],[126603,126619],[126625,126627],[126629,126633],[126635,126651],[1114109,1114109]];class av{applyStyles(e,t){for(var i in t=t||this.div,e)e.hasOwnProperty(i)&&(t.style[i]=e[i])}formatStyle(e,t){return 0===e?"0":e+t}}class sv extends(n.StyleBox=av){constructor(e,t,i,r,n){super();var a={start:"left","line-left":"left",left:"left",center:"center",middle:"center","line-right":"right",right:"right",end:"right"}[(this.cue=t).positionAlign]||t.align,a={textAlign:a="middle"===a?"center":a,whiteSpace:"pre-line",position:"absolute"},s=(a.direction=this.determineBidi(this.cueDiv),a.writingMode=this.directionSettingToWritingMode(t.vertical),a.unicodeBidi="plaintext",this.div=e.document.createElement("div"),this.applyStyles(a),a={backgroundColor:r.backgroundColor,display:"inline-block"},this.parseOpacity(a.backgroundColor)&&(a.padding="5px",a.borderRadius="5px"),this.backgroundDiv=e.document.createElement("div"),this.applyStyles(a,this.backgroundDiv),(a={color:i.color,backgroundColor:i.backgroundColor,textShadow:i.textShadow,fontSize:i.fontSize,fontFamily:i.fontFamily,position:"relative",left:"0",right:"0",top:"0",bottom:"0",display:"inline-block",textOrientation:"upright"}).writingMode=this.directionSettingToWritingMode(t.vertical),a.unicodeBidi="plaintext",this.cueDiv=vd.default.parseContent(e,t,n),this.applyStyles(a,this.cueDiv),this.backgroundDiv.appendChild(this.cueDiv),this.div.appendChild(this.backgroundDiv),0);if("number"==typeof t.position){r=t.positionAlign||t.align;if(r)switch(r){case"start":case"left":s=t.position;break;case"center":case"middle":s=t.position-t.size/2;break;case"end":case"right":s=t.position-t.size}}""===t.vertical?this.applyStyles({left:this.formatStyle(s,"%"),width:this.formatStyle(t.size,"%")}):this.applyStyles({top:this.formatStyle(s,"%"),height:this.formatStyle(t.size,"%")})}determineBidi(e){var t=[],i="";if(e&&e.childNodes)for(a(t,e);i=function e(t){var i,r,n;return t&&t.length?(r=(i=t.pop()).textContent||i.innerText)?(n=/^.*(\n|\r)/.exec(r))?(t.length=0,n[0]):r:"ruby"===i.tagName?e(t):i.childNodes?(a(t,i),e(t)):void 0:null}(t);)for(var r=0;r<i.length;r++)if(function(e,t){for(var i of t)if(e>=i[0]&&e<=i[1])return!0;return!1}(i.charCodeAt(r),Sd))return"rtl";return"ltr";function a(e,t){for(var i=t.childNodes.length-1;0<=i;i--)e.push(t.childNodes[i])}}parseOpacity(e){return e&&"string"==typeof e&&(e=(e=e.replace(/ /g,"").replace("rgba(","").replace(")","")).split(","))&&4<=e.length?e[3]:null}directionSettingToWritingMode(e){return""===e?"horizontal-tb":"lr"===e?"vertical-lr":"vertical-rl"}move(e){this.applyStyles({top:this.formatStyle(e.top,"px"),bottom:this.formatStyle(e.bottom,"px"),left:this.formatStyle(e.left,"px"),right:this.formatStyle(e.right,"px"),height:this.formatStyle(e.height,"px"),width:this.formatStyle(e.width,"px")})}}n.CueStyleBox=sv;class ov{constructor(e){var t,i,r,n,a,s,o;e instanceof sv&&e.cue?(s=e.cue)&&""!==s.vertical?this.property="width":this.property="height":e instanceof ov&&(this.property=e.property||"height"),e instanceof sv&&e.div?(r=e.div.offsetHeight,n=e.div.offsetWidth,a=e.div.offsetTop,o=(i=((s=e.div.firstChild)||e.div).getBoundingClientRect())&&i[this.property]||null,s&&s.firstChild&&(s=s.firstChild)&&"string"==typeof s.textContent&&(t=o/this.calculateNewLines(s.textContent))):e instanceof ov&&(i=e),this.left=i.left,this.right=i.right,this.top=i.top||a,this.height=i.height||r,this.bottom=i.bottom||a+(i.height||r),this.width=i.width||n,this.lineHeight=null!==o?o:i.lineHeight,this.singleLineHeight=null!==t?t:i.singleLineHeight,this.singleLineHeight||(this.singleLineHeight=41)}calculateNewLines(e){for(var t=1,i=0;i<e.length;i++)"\n"===e[i]&&t++;return t}move(e,t){switch(t=void 0!==t?t:this.singleLineHeight,e){case"+x":this.left+=t,this.right+=t;break;case"-x":this.left-=t,this.right-=t;break;case"+y":this.top+=t,this.bottom+=t;break;case"-y":this.top-=t,this.bottom-=t}}overlaps(e){return this.left<e.right&&this.right>e.left&&this.top<e.bottom&&this.bottom>e.top}overlapsAny(e){for(var t of e)if(this.overlaps(t))return!0;return!1}within(e){return this.top>=e.top&&this.bottom<=e.bottom&&this.left>=e.left&&this.right<=e.right}moveIfOutOfBounds(e,t){switch(t){case"+x":this.left<e.left&&(this.left=e.left,this.right=this.left+this.width);break;case"-x":this.right>e.right&&(this.right=e.right,this.left=this.right-this.width);break;case"+y":this.top<e.top&&(this.top=e.top,this.bottom=this.top+this.height);break;case"-y":this.bottom>e.bottom&&(this.bottom=e.bottom,this.top=this.bottom-this.height)}}toCSSCompatValues(e){return{top:this.top-e.top,bottom:e.bottom-this.bottom,left:this.left-e.left,right:e.right-this.right,height:this.height,width:this.width}}static getSimpleBoxPosition(e){var t=null,e=(e instanceof av&&e.div?t=e.div:e instanceof HTMLElement&&(t=e),t.offsetHeight||0),i=t.offsetWidth||0,r=t.offsetTop||0,n=r+e,t=t.getBoundingClientRect(),{left:a,right:s}=t;return t.top&&(r=t.top),t.height&&(e=t.height),t.width&&(i=t.width),{left:a,right:s,top:r,height:e,bottom:n=t.bottom?t.bottom:n,width:i}}static getBoxPosition(e,t){if(e&&0<e.length){for(var i=0,r=e[0][t],n=0;n<e.length;n++)t in["top","right"]?e[n][t]>r&&(r=e[i=n][t]):t in["bottom","left"]&&e[n][t]<r&&(r=e[i=n][t]);return e[i]}return null}static moveToMinimumDistancePlacement(e,t,i){"height"===e.property?"+y"===t?(e.top=i.topMostBoxPosition.bottom+0,e.bottom=e.top+e.height):"-y"===t&&(e.bottom=i.bottomMostBoxPosition.top-0,e.top=e.bottom-e.height):"width"===e.property&&("+x"===t?(e.left=i.rightMostBoxPosition.right+0,e.right=e.left+e.width):"-x"===t&&(e.right=i.leftMostBoxPosition.left-0,e.left=e.right-e.width))}static moveBoxToLinePosition(e,s,o){var t,n=e.cue,i=new ov(e),r=function(){if("number"==typeof n.line&&(n.snapToLines||0<=n.line&&n.line<=100))return n.line;if(!n.track||!n.track.textTrackList||!n.track.textTrackList.mediaElement)return-1;for(var e=0,t=n.track,i=t.textTrackList,r=0;r<i.length&&i[r]!==t;r++)"showing"===i[r].mode&&e++;return-1*++e}(),a=[];if(n.snapToLines){var l=0;switch(n.vertical){case"":a=["+y","-y"],t="height";break;case"rl":a=["+x","-x"],t="width";break;case"lr":a=["-x","+x"],t="width"}var d=i.lineHeight,u=s[t]+d,c=a[0];if(r<0){var h=0;switch(n.vertical){case"":h=s.height-d-.05*s.height;break;case"rl":case"lr":h=-s.width+d+.05*s.width}l=h,a=a.reverse()}else{switch(n.vertical){case"":case"lr":l=d*Math.round(r);break;case"rl":l=s.width-d*Math.round(r)}Math.abs(l)>u&&(l=l<0?-1:1,l*=Math.ceil(u/d)*d)}i.move(c,l)}else{var u=""===n.vertical?s.height:s.width,p=i.lineHeight/u*100;switch(n.lineAlign){case"center":case"middle":r-=p/2;break;case"end":r-=p}switch(n.vertical){case"":e.applyStyles({top:e.formatStyle(r,"%")});break;case"rl":e.applyStyles({right:e.formatStyle(r,"%")});break;case"lr":e.applyStyles({left:e.formatStyle(r,"%")})}a=["+y","-y","+x","-x"],"+y"===n.axis?a=["+y","-y","+x","-x"]:"-y"===n.axis&&(a=["-y","+y","+x","-x"]),i=new ov(e)}c=function(e,t){for(var i,r=0;r<t.length;r++){e.moveIfOutOfBounds(s,t[r]);for(var n=0,a=!1;e.overlapsAny(o)&&!(9<n);)a?e.move(t[r]):(o&&0<o.length&&(i=i||{topMostBoxPosition:ov.getBoxPosition(o,"top"),bottomMostBoxPosition:ov.getBoxPosition(o,"bottom"),leftMostBoxPosition:ov.getBoxPosition(o,"left"),rightMostBoxPosition:ov.getBoxPosition(o,"right")},ov.moveToMinimumDistancePlacement(e,t[r],i)),a=!0),n++}return e}(i,a);e.move(c.toCSSCompatValues(s))}}n.BoxPosition=ov;class lv{constructor(e,t){var i=!(2<arguments.length&&void 0!==arguments[2])||arguments[2];if(!e)return null;this.window=e,this.overlay=t,this.loggingEnabled=i,this.foregroundStyleOptions={fontFamily:"Helvetica",fontSize:"36px",color:"rgba(255, 255, 255, 1)",textShadow:"",backgroundColor:"rgba(0, 0, 0, 0)"},this.backgroundStyleOptions={backgroundColor:"rgba(0, 0, 0, 0.5)"},this.globalStyleCollection={};i=e.document.createElement("div");i.style.position="absolute",i.style.left="0",i.style.right="0",i.style.top="0",i.style.bottom="0",i.style.margin="1.5%",this.paddedOverlay=i,t.appendChild(this.paddedOverlay),this.initSubtitleCSS()}initSubtitleCSS(){var e=[new yd.VTTCue(0,0,"String to init CSS - Won't be visible to user")];this.paddedOverlay.style.opacity="0",this.processCues(e),this.processCues([]),this.paddedOverlay.style.opacity="1"}convertCueToDOMTree(e){return e?vd.default.parseContent(this.window,e,this.globalStyleCollection):null}setStyles(e){function t(e,t,i){for(var r in t)t.hasOwnProperty(r)&&(!0===i&&void 0!==e[r]||!1===i)&&(e[r]=t[r])}for(var i in e){var r=!1,n=null,a=("::cue"===i?(n=this.foregroundStyleOptions,r=!0):"::-webkit-media-text-track-display"===i&&(n=this.backgroundStyleOptions,r=!0),e[i]);if(!0===r)t(n,a,r);else for(var s=0;s<Id.length;s++){var o,l=Id[s].exec(i);l&&4===l.length&&(l=l[2],t(o={},a,r),this.globalStyleCollection[l]=o)}}this.initSubtitleCSS(),this.loggingEnabled&&(console.log("WebVTTRenderer setStyles foregroundStyleOptions: "+JSON.stringify(this.foregroundStyleOptions)),console.log("WebVTTRenderer setStyles backgroundStyleOptions: "+JSON.stringify(this.backgroundStyleOptions)),console.log("WebVTTRenderer setStyles globalStyleCollection: "+JSON.stringify(this.globalStyleCollection)))}processCues(e){if(e){for(;this.paddedOverlay.firstChild;)this.paddedOverlay.removeChild(this.paddedOverlay.firstChild);if(function(e){for(var t=0;t<e.length;t++)if(e[t].hasBeenReset||!e[t].displayState)return!0;return!1}(e)){var t=[],i=ov.getSimpleBoxPosition(this.paddedOverlay);1<e.length&&(e=function(e){for(var t=[],i=0,r=0;r<e.length;r++){var n=e[r];if("number"!=typeof n.line)return e;i+=n.line,t.push(n)}return 50<(i/=e.length)?(t.forEach(function(e){e.axis="-y"}),t.sort((e,t)=>t.line-e.line)):(t.forEach(function(e){e.axis="+y"}),t.sort((e,t)=>e.line-t.line)),t}(e));for(var r=0;r<e.length;r++){var n=e[r],a=new sv(this.window,n,this.foregroundStyleOptions,this.backgroundStyleOptions,this.globalStyleCollection);this.paddedOverlay.appendChild(a.div),ov.moveBoxToLinePosition(a,i,t),n.displayState=a.div,t.push(ov.getSimpleBoxPosition(a))}}else for(var s=0;s<e.length;s++)this.paddedOverlay.appendChild(e[s].displayState)}}setSize(e,t){e&&(this.overlay.style.width=e+"px"),t&&(this.overlay.style.height=t+"px")}getOverlay(){return this.overlay}}n.default=lv,n.WebVTTRenderer=lv,e(bs,n)}a=td,fd=t&&t.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){e[r=void 0===r?i:r]=t[i]}),i=t&&t.__exportStar||function(e,t){for(var i in e)"default"===i||t.hasOwnProperty(i)||fd(t,e,i)},Object.defineProperty(a,"__esModule",{value:!0}),i(Ts,a),i(r,a);const bd=9e4;function Td(e,t,i){return e.substr(i||0,t.length)===t}function Ad(e){var t=Math.floor(e),i=t+.5,r=t+1;return i<=e?r-e<=e-i?r:i:i-e<=e-t?i:t}function Ed(e,t=0,i=8589934592){return Number.isFinite(t)?t+(t<e?-1:1)*(i/2<(t=Math.abs(e-t)%i)?i-t:-t):e}function Od(e){let t=e;return Rd.hasOwnProperty(e)&&(t=Rd[e]),String.fromCharCode(t)}function wd(t){var i=[];for(let e=0;e<t.length;e++)i.push(t[e].toString(16));return i}const Rd={42:225,92:233,94:237,95:243,96:250,123:231,124:247,125:209,126:241,127:9608,128:174,129:176,130:189,131:191,132:8482,133:162,134:163,135:9834,136:224,137:32,138:232,139:226,140:234,141:238,142:244,143:251,144:193,145:201,146:211,147:218,148:220,149:252,150:8216,151:161,152:42,153:8217,154:9473,155:169,156:8480,157:8226,158:8220,159:8221,160:192,161:194,162:199,163:200,164:202,165:203,166:235,167:206,168:207,169:239,170:212,171:217,172:249,173:219,174:171,175:187,176:195,177:227,178:205,179:204,180:236,181:210,182:242,183:213,184:245,185:123,186:125,187:92,188:94,189:95,190:124,191:8764,192:196,193:228,194:214,195:246,196:223,197:165,198:164,199:9475,200:197,201:229,202:216,203:248,204:9487,205:9491,206:9495,207:9499},Md=15,Pd=100,Cd={17:1,18:3,21:5,22:7,23:9,16:11,19:12,20:14},kd={17:2,18:4,21:6,22:8,23:10,19:13,20:15},Ld={25:1,26:3,29:5,30:7,31:9,24:11,27:12,28:14},Dd={25:2,26:4,29:6,30:8,31:10,27:13,28:15},xd=["white","green","blue","cyan","red","yellow","magenta","black","transparent"],Nd={verboseFilter:{DATA:3,DEBUG:3,INFO:2,WARNING:2,TEXT:1,ERROR:0},time:null,verboseLevel:0,setTime:function(e){this.time=e},log:function(e,t){var i=this.verboseFilter[e];this.verboseLevel>=i&&console.log(this.time+" ["+e+"] "+t)}};class Fd{constructor(e,t,i,r,n){this.foreground=e||"white",this.underline=t||!1,this.italics=i||!1,this.background=r||"black",this.flash=n||!1}reset(){this.foreground="white",this.underline=!1,this.italics=!1,this.background="black",this.flash=!1}setStyles(e){Object.assign(this,e)}isDefault(){return"white"===this.foreground&&!this.underline&&!this.italics&&"black"===this.background&&!this.flash}equals(e){return this.foreground===e.foreground&&this.underline===e.underline&&this.italics===e.italics&&this.background===e.background&&this.flash===e.flash}copy(e){this.foreground=e.foreground,this.underline=e.underline,this.italics=e.italics,this.background=e.background,this.flash=e.flash}toString(){return"color="+this.foreground+", underline="+this.underline+", italics="+this.italics+", background="+this.background+", flash="+this.flash}}class Bd{constructor(e,t,i,r,n,a){this.uchar=e||" ",this.penState=new Fd(t,i,r,n,a)}reset(){this.uchar=" ",this.penState.reset()}setChar(e,t){this.uchar=e,this.penState.copy(t)}setPenState(e){this.penState.copy(e)}equals(e){return this.uchar===e.uchar&&this.penState.equals(e.penState)}copy(e){this.uchar=e.uchar,this.penState.copy(e.penState)}isEmpty(){return" "===this.uchar&&this.penState.isDefault()}}class Ud{constructor(){this.cueStartTime=null,this.chars=[];for(let e=0;e<Pd;e++)this.chars.push(new Bd);this.Ci=0,this.xi=new Fd}equals(t){let i=!0;for(let e=0;e<Pd;e++)if(!this.chars[e].equals(t.chars[e])){i=!1;break}return i}copy(t){for(let e=0;e<Pd;e++)this.chars[e].copy(t.chars[e])}isEmpty(){let t=!0;for(let e=0;e<Pd;e++)if(!this.chars[e].isEmpty()){t=!1;break}return t}setCursor(e){this.Ci!==e&&(this.Ci=e),this.Ci<0?(Nd.log("ERROR","Negative cursor position "+this.Ci),this.Ci=0):this.Ci>Pd&&(Nd.log("ERROR","Too large cursor position "+this.Ci),this.Ci=Pd)}moveCursor(e){var t=this.Ci+e;if(1<e)for(let e=this.Ci+1;e<t+1;e++)this.chars[e].setPenState(this.xi);this.setCursor(t)}backSpace(){this.moveCursor(-1),this.chars[this.Ci].setChar(" ",this.xi)}insertChar(e){144<=e&&this.backSpace();var t=Od(e);this.Ci>=Pd?Nd.log("ERROR","Cannot insert "+e.toString(16)+" ("+t+") at position "+this.Ci+". Skipping it!"):(this.chars[this.Ci].setChar(t,this.xi),this.moveCursor(1))}clearFromPos(e){let t;for(t=e;t<Pd;t++)this.chars[t].reset()}clear(){this.clearFromPos(0),this.Ci=0,this.xi.reset()}clearToEndOfRow(){this.clearFromPos(this.Ci)}getTextString(){var t=[];let i=!0;for(let e=0;e<Pd;e++){var r=this.chars[e].uchar;" "!==r&&(i=!1),t.push(r)}return i?"":t.join("")}setPenStyles(e){this.xi.setStyles(e),this.chars[this.Ci].setPenState(this.xi)}}class _d{constructor(){this.nrRollUpRows=null,this.lastOutputScreen=null,this.rows=[];for(let e=0;e<Md;e++)this.rows.push(new Ud);this.Di=14,this.reset()}reset(){for(let e=0;e<Md;e++)this.rows[e].clear();this.Di=14}equals(t){let i=!0;for(let e=0;e<Md;e++)if(!this.rows[e].equals(t.rows[e])){i=!1;break}return i}copy(t){for(let e=0;e<Md;e++)this.rows[e].copy(t.rows[e])}isEmpty(){let t=!0;for(let e=0;e<Md;e++)if(!this.rows[e].isEmpty()){t=!1;break}return t}backSpace(){this.rows[this.Di].backSpace()}clearToEndOfRow(){this.rows[this.Di].clearToEndOfRow()}insertChar(e){this.rows[this.Di].insertChar(e)}setPen(e){this.rows[this.Di].setPenStyles(e)}moveCursor(e){this.rows[this.Di].moveCursor(e)}setCursor(e){Nd.log("INFO","setCursor: "+e),this.rows[this.Di].setCursor(e)}setPAC(t){var i;Nd.log("INFO","pacData = "+JSON.stringify(t));let r=t.row-1;if(this.nrRollUpRows&&r<this.nrRollUpRows-1&&(r=this.nrRollUpRows-1),this.nrRollUpRows&&this.Di!==r){for(let e=0;e<Md;e++)this.rows[e].clear();const t=this.Di+1-this.nrRollUpRows,i=this.lastOutputScreen;if(i){const e=i.rows[t].cueStartTime;if(fe(e)&&fe(Nd.time)&&e<Nd.time)for(let e=0;e<this.nrRollUpRows;e++)this.rows[r-this.nrRollUpRows+e+1].copy(i.rows[t+e])}}this.Di=r;const e=this.rows[this.Di];if(null!==t.indent){const r=t.indent,n=Math.max(r-1,0);e.setCursor(t.indent),t.color=null!=(i=e.chars[n].penState.foreground)?i:""}const n={foreground:t.color,underline:t.underline,italics:t.italics,background:"black",flash:!1};this.setPen(n)}setBkgData(e){Nd.log("INFO","bkgData = "+JSON.stringify(e)),this.backSpace(),this.setPen(e),this.insertChar(32)}setRollUpRows(e){this.nrRollUpRows=e}rollUp(){var e;null===this.nrRollUpRows?Nd.log("DEBUG","roll_up but nrRollUpRows not set yet"):(Nd.log("INFO","TEXT "+this.getDisplayText()),e=this.Di+1-this.nrRollUpRows,(e=this.rows.splice(e,1)[0]).clear(),this.rows.splice(this.Di,0,e),Nd.log("INFO","Rolling up"))}getDisplayText(t){t=t||!1;var i=[];let e="",r;for(let e=0;e<Md;e++){var n=this.rows[e].getTextString();n&&(r=e+1,i.push(t?"Row "+r+": '"+n+"'":n.trim()))}return e=0<i.length?t?"["+i.join(" | ")+"]":i.join("\n"):e}getTextAndFormat(){return this.rows}}class Vd{constructor(e,t){this.Li=null,this.cueStartTime=null,this.lastCueEndTime=null,this.Fi=e,this.Bi=t,this.Ui=0,this.$i=new _d,this.Vi=new _d,this.qi=new _d,this.zi=this.$i.rows[14],this.Hi=this.$i}reset(){this.Li=null,this.$i.reset(),this.Vi.reset(),this.qi.reset(),this.zi=this.$i.rows[14],this.Hi=this.$i,this.Li=null,this.cueStartTime=null,this.lastCueEndTime=null}getHandler(){return this.Bi}setHandler(e){this.Bi=e}setPAC(e){this.Hi.setPAC(e)}setBkgData(e){this.Hi.setBkgData(e)}setMode(e){e!==this.Li&&(this.Li=e,Nd.log("INFO","MODE="+e),"MODE_POP-ON"===this.Li?this.Hi=this.Vi:(this.Hi=this.$i,this.Hi.reset()),"MODE_ROLL-UP"!==this.Li&&(this.$i.nrRollUpRows=null,this.Vi.nrRollUpRows=null),this.Li=e)}insertChars(t){for(let e=0;e<t.length;e++)this.Hi.insertChar(t[e]);var e=this.Hi===this.$i?"DISP":"NON_DISP";Nd.log("INFO",e+": "+this.Hi.getDisplayText(!0)),"MODE_PAINT-ON"!==this.Li&&"MODE_ROLL-UP"!==this.Li||(Nd.log("TEXT","DISPLAYED: "+this.$i.getDisplayText(!0)),this.outputDataUpdate())}ccRCL(){Nd.log("INFO","RCL - Resume Caption Loading"),this.setMode("MODE_POP-ON")}ccBS(){Nd.log("INFO","BS - BackSpace"),"MODE_TEXT"!==this.Li&&(this.Hi.backSpace(),this.Hi===this.$i)&&this.outputDataUpdate()}ccAOF(){}ccAON(){}ccDER(){Nd.log("INFO","DER- Delete to End of Row"),this.Hi.clearToEndOfRow(),this.outputDataUpdate()}ccRU(e){Nd.log("INFO","RU("+e+") - Roll Up"),this.Hi=this.$i,this.setMode("MODE_ROLL-UP"),this.Hi.setRollUpRows(e)}ccFON(){Nd.log("INFO","FON - Flash On"),this.Hi.setPen({flash:!0})}ccRDC(){Nd.log("INFO","RDC - Resume Direct Captioning"),this.setMode("MODE_PAINT-ON")}ccTR(){Nd.log("INFO","TR"),this.setMode("MODE_TEXT")}ccRTD(){Nd.log("INFO","RTD"),this.setMode("MODE_TEXT")}ccEDM(){Nd.log("INFO","EDM - Erase Displayed Memory"),this.$i.reset(),this.outputDataUpdate(!0)}ccCR(){Nd.log("INFO","CR - Carriage Return"),this.Hi.rollUp(),this.outputDataUpdate(!0)}ccENM(){Nd.log("INFO","ENM - Erase Non-displayed Memory"),this.Vi.reset()}ccEOC(){var e;Nd.log("INFO","EOC - End Of Caption"),"MODE_POP-ON"===this.Li&&(e=this.$i,this.$i=this.Vi,this.Vi=e,this.Hi=this.Vi,Nd.log("TEXT","DISP: "+this.$i.getDisplayText())),this.outputDataUpdate(!0)}ccTO(e){Nd.log("INFO","TO("+e+") - Tab Offset"),this.Hi.moveCursor(e)}ccMIDROW(e){var t={flash:!1,underline:!1,italics:!1};t.underline=e%2==1,t.italics=46<=e,t.italics?t.foreground="white":(e=Math.floor(e/2)-16,t.foreground=["white","green","blue","cyan","red","yellow","magenta"][e]),Nd.log("INFO","MIDROW: "+JSON.stringify(t)),this.Hi.setPen(t)}outputDataUpdate(e=!1){var t=Nd.time;null!==t&&this.Bi&&(this.Bi.updateData&&this.Bi.updateData(t,this.$i),null!==this.cueStartTime||this.$i.isEmpty()?this.$i.equals(this.qi)||(this.Bi.newCue&&fe(this.cueStartTime)&&(this.Bi.newCue(this.cueStartTime,t,this.qi),!0===e)&&this.Bi.dispatchCue&&this.Bi.dispatchCue(),this.cueStartTime=this.$i.isEmpty()?null:t):this.cueStartTime=t,this.qi.copy(this.$i))}cueSplitAtTime(e){!this.Bi||this.$i.isEmpty()||(this.Bi.newCue&&fe(this.cueStartTime)&&this.Bi.newCue(this.cueStartTime,e,this.$i),this.cueStartTime=e)}}var Qd,Hd,qd={newCue:function(e,t,i,r,n,a){let s,o,l,d,u;var c,h,p={foreground:void 0,background:void 0,italics:!1,underline:!1,flash:!1,styleStack:[]};for([c,h]of r.rows.entries())if(o=!0,l=0,d="",!h.isEmpty()){for(let e=0;e<h.chars.length;e++)h.chars[e].uchar.match(/\s/)&&o?l++:(d+=this.getFormattedChar(h.chars[e],p),o=!1);(h.cueStartTime=t)===i&&(i+=1e-4),d=d.trim().replace(/<br(?: \/)?>/gi,"\n"),d+=this.closeStyles(p),s=new td.VTTCue(t,i,d),16<=l?l--:l++,u=!navigator.userAgent.match(/Firefox\//)&&7<c?c:c+1,s.snapToLines=!1,s.line=10+5.33*u,s.align="left",s.position=this.getPosition(l,n,a),e.addCue(s)}},getPosition:function(e,t,i){let r=1.3333333333333333,n=10+e/32*80,a=10,s=90;return 1.7777777777777777===(r=t&&i&&1.6<=t/i?1.7777777777777777:r)&&(n=12.5+.75*n,a=20,s=80),Math.max(a,Math.min(s,n+(navigator.userAgent.match(/Firefox\//)?50:0)))},getRootStyleTag:function(e){var t=e[0];return"c"===t?t:e},closeStyles:function(t){let i="";for(let e=t.styleStack.length-1;0<=e;--e)i+="</"+this.getRootStyleTag(t.styleStack[e])+">",t.styleStack.pop();return i},beginStyleAndBalance:function(e,t){let i="";return"c"===t[0]&&(i+=this.closeStyleAndBalance(e,"c")),i+="<"+t+">",e.styleStack.push(t),i},closeStyleAndBalance:function(t,i){var r=t.styleStack.length;let n=0,a="";for(let e=r-1;0<=e;--e){var s=t.styleStack[e],o=this.getRootStyleTag(s);if(i[0]===s[0]){a+="</"+o+">",t.styleStack.splice(r-1-n);break}"c"===o[0]?(t.background="",t.foreground="",t.flash=!1,a+="</c>"):"u"===o[0]?(t.underline=!1,a+="</u>"):"i"===o[0]&&(t.italics=!1,a+="</i>"),n++}return a},getFormattedChar:function(e,t){let i="",r=e.uchar,n="";var a=e.penState.foreground!==t.foreground,s=e.penState.background!==t.background,o=e.penState.flash!==t.flash;return(a||s||o)&&(n="."+e.penState.foreground,n+=".bg_"+e.penState.background,e.penState.flash&&o&&(n+=".blink"),e.penState.foreground||e.penState.background||e.penState.blink?i+=this.beginStyleAndBalance(t,"c"+n):i+=this.closeStyleAndBalance(t,"c"),a&&(t.foreground=e.penState.foreground),s&&(t.background=e.penState.background),o)&&(t.flash=null!=(a=e.penState.flash)&&a),e.penState.underline!==t.underline&&(i+=e.penState.underline?this.beginStyleAndBalance(t,"u"):this.closeStyleAndBalance(t,"u"),t.underline=null!=(s=e.penState.underline)&&s),e.penState.italics!==t.italics&&(i+=e.penState.italics?this.beginStyleAndBalance(t,"i"):this.closeStyleAndBalance(t,"i"),t.italics=null!=(o=e.penState.italics)&&o),i+r}};function Kd(e){e=/:asset_(.*)_/.exec(e);return e&&1<e.length?e[1]:void 0}function jd(e){e=/interstitial:(.*):asset_(.*)_/.exec(e);let t,i;return e&&(1<e.length&&(t=e[1]),2<e.length)&&(i=e[2]),{interstitialId:t,interstitialAssetId:i}}function ke(e){return null!=e&&"object"==typeof e&&0<(null!=(e=e.interstitialId)?e:"").length}class $d{constructor(e,t){this.Qi=e,this.Ki=t,this.Wi=null,this.Gi=null,this.Xi=null}dispatchCue(){null!==this.Wi&&null!==this.Gi&&(this.Qi.addCues("cc"+this.Ki,this.Wi,this.Gi,this.Xi),this.Wi=null)}newCue(e,t,i){(null===this.Wi||this.Wi>e)&&(this.Wi=e),this.Gi=t,this.Xi=i,this.Qi.createHTMLCaptionsTrack(this.Ki)}}const Gd=9e4,Wd=/^(\d{2,}):(\d{2}):(\d{2}):(\d{2})\.?(\d+)?$/,zd=/^(\d*(?:\.\d*)?)(h|m|s|ms|f|t)$/,Yd={extractXML(e){e=H.findFirstBox(e,["mdat"]);return e?De.utf8arrayToStr(e):""},generateCues(e,t,a,i){const r=(new DOMParser).parseFromString(e,"text/xml"),n=r.getElementsByTagName("tt")[0],s="preserve"!==n.getAttribute("xml:space"),o=[];if(n){const l=w(t,Gd),d={frameRate:30,subFrameRate:1,frameRateMultiplier:0,tickRate:0},u=Object.keys(d).reduce((e,t)=>{var i=n.getAttribute(`ttp:`+t),i=i&&fe(parseInt(i))?parseInt(i):null;return e[t]=i||d[t],e},{frameRate:30,subFrameRate:1,frameRateMultiplier:0,tickRate:0});r.querySelectorAll("p").forEach(e=>{var t=function r(e,n){return[].slice.call(e.childNodes).reduce((e,t,i)=>{return"br"===t.nodeName&&i?e+"\n":null!=(i=t.childNodes)&&i.length?e+r(t,n):n?e+(null!=(i=null==(i=t.textContent)?void 0:i.trim().replace(/\s+/g," "))?i:""):e+t.textContent},"")}(e,s),i=Xd(e.getAttribute("begin"),u),r=Xd(e.getAttribute("dur"),u);let n=Xd(e.getAttribute("end"),u);!n&&fe(i)&&r&&(n=i+r);r=C({baseTime:Ed(Ed(0)-l.baseTime,a*Gd),timescale:Gd});if(t&&fe(i)&&fe(n)){i=Ed(i+r-0,0,95443.7176888889),n=Ed(n+r-0,0,95443.7176888889);const e=new VTTCue(i,n,t);e.id=ae(Ad(e.startTime).toString())+ae(Ad(e.endTime-e.startTime).toString())+ae(e.text),o.push(e)}})}else i.error("[subtitle] Invalid ttml");return o}};function Xd(e,t){if(!e)return null;let i=e?([n,a,s]=e.split(":"),[s,r]=s.split("."),3600*parseInt(n)+60*parseInt(a)+parseInt(s)+parseInt(r)/1e3):null;var r,n,a,s;return null===i&&(Wd.test(e)?i=(n=e,a=t,n=Wd.exec(n),s=(0|n[4])+(0|n[5])/a.subFrameRate,3600*(0|n[1])+60*(0|n[2])+(0|n[3])+s/a.frameRate):zd.test(e)&&(i=function(e,t){var e=zd.exec(e),i=Number(e[1]);switch(e[2]){case"h":return 3600*i;case"m":return 60*i;case"ms":return 1e3*i;case"f":return i/t.frameRate;case"t":return i/t.tickRate}return i}(e,t))),i}(As=Qd=Qd||{}).CloseEnough="CloseEnough",As.TooFar="TooFar",As.Unknown="Unknown",(Ss=Hd=Hd||{})[Ss.TryAgain=1]="TryAgain",Ss[Ss.Complete=2]="Complete";const Jd=e=>"cc1"===e||"cc2"===e;function Zd(t){var i=[];for(let e=0;e<t.length;e++){var r=t[e];("captions"===r.kind||"subtitles"===r.kind||"metadata"===r.kind&&r.customTextTrackCueRenderer)&&i.push(r)}return i}function eu(e){if(e&&e.cues)for(;0<e.cues.length;)e.removeCue(e.cues[0])}class tu extends F{constructor(e,t,i,r){super(e=>{if(this.Yi){const t=yl(this.Yi,this);if(e.add(t.event(L.INLINE_STYLES_PARSED,this.onInlineStylesParsed).pipe(Hr(()=>this.destroy())).subscribe()),e.add(rr(0,this.Zt.trottleCheckInterval).pipe(Ae(()=>(this.Ji(),Pe))).subscribe()),this.Zt.enableInterstitialPlayback&&(this.Zt.nativeTextTrackChangeHandling=!1),this.Zt.nativeTextTrackChangeHandling)if(this.bi.textTracks&&"onchange"in this.bi.textTracks){const t=yl(this.bi.textTracks,this);e.add(t.event("change",this.Zi).subscribe())}else e.add(rr(0,500).pipe(Ae(()=>(this.Zi(),Pe))).subscribe())}}),this.Zt=t,this.tn=NaN,this.sn=NaN,this.ln=!1,this.un=!1,this.cn=!1,this.hn=0,this.dn=0,this.fn=0,this.vn=0,this.pn=new Ie,this.yn={},this.Yi=i,this.R=r.child({name:"legible"}),this.bi=e,this.Sn=e.id3TextTrack,this.wn=!0,this.Tn=qd,this.On=[],this.Mn=[],this.An={},this.En={},this.Nn=0,this.gotTracks=!1,this.needNextSubtitle$=new jr(!0)}reset(){this.resetTracks(),this.Rn=this.Pn=void 0,this._n=void 0,this.Cn=this.xn=void 0}destroy(){this.pn.next(),this.reset(),this.nativeSubtitleTrackChange$=void 0,this.yn={},this.Yi=void 0}handlePlayingItemChanged(e){var{playingInterstitialId:e,subtitleMediaOption:t}=e;this.un=!!e,this.Dn(t)}convertCuesIntoSubtitleFragInfo(t,i){var r={};if(null!=t&&0<t.length)for(let e=0;e<t.length;e++){var n,a=t[e];fe(a.fragSN)&&a.itemId===i&&((n=r[a.fragSN])?(n.count++,n.startTime=Math.min(a.startTime,n.startTime),n.endTime=Math.max(a.endTime,n.endTime)):r[a.fragSN]={count:1,startTime:a.startTime,endTime:a.endTime})}return r}Ji(){let e=!1;this.bi.mediaQuery.currentTime>=this.Nn-this.Zt.subtitleLeadTime&&(e=!0),this.needNextSubtitle$.next(e)}checkReadyToLoadNextSubtitleFragment$(e,t){return e.mediaSeqNum===(null==(e=t[0])?void 0:e.mediaSeqNum)?be(!0):(this.Ji(),this.needNextSubtitle$)}getNextFragment(e,t){t=t.mediaSeqNum+1;return t<e.fragments.length?e.fragments[t-e.startSN]:null}Ln(e,t,i,r){var n=this.convertCuesIntoSubtitleFragInfo(t,r.itemId);let a={len:0,start:e,end:e},s=e,o=e,l=NaN,d=NaN;for(const t in n)if(Object.prototype.hasOwnProperty.call(n,t)){var u=Number(t);if(fe(u)){var c=n[u];if(c&&(!i||this.Fn(u,c.count,i))){if(u===r.startSN&&e<c.startTime&&(s=o=a.start=a.end=e=c.startTime),e>=c.startTime&&(s===e||fe(l)&&1<u-l)&&(s=o=c.startTime),!(e>=c.startTime||fe(l)&&u-l==1)){d=u;break}o=c.endTime,l=u}}}return{fragInfoMap:n,bufferInfo:a={len:o-s,start:s,end:o},prevFragSN:l,nextFragSN:d}}findFrags$(e,t,i){i=this.findFragmentsForPosition(i,t,e),t=i.foundFrags;if(t&&0!==t.length)return this.Nn=0,this.needNextSubtitle$.next(!0),i}reviewParsedFrag(i,r,n,a,e){var s=r.frag,o=r.cueRange,t=n.subtitleBufferInfo,l=n.subtitleParsedInfo,r=n.foundFrags;let d=!0;if(s.gap)return Qd.CloseEnough;if(r&&r.length&&s.mediaSeqNum===r[0].mediaSeqNum){if(this.selectedMediaOption==this.jn&&this.un)return Qd.CloseEnough;if(!n.timelineEstablished)return e?Qd.TooFar:Qd.CloseEnough;if(!o)return Qd.Unknown;if(o.startTime<i){const r=a.fragments,n=s.mediaSeqNum-a.startSN;let e=n,t=o.startTime;for(;e<r.length&&!((t+=r[e].duration)>=i);++e);d=e-n<=this.Zt.earlyFragTolerance}else if(o.startTime>i&&s.mediaSeqNum!==a.startSN){if(!t||!l)return Qd.TooFar;const r=o.startTime-i,n=t.prevFragSN;if(!fe(n))return Qd.TooFar;d=s.mediaSeqNum===n+1&&(null==(e=t.fragInfoMap[n])?void 0:e.count)===(null==(a=l[n])?void 0:a.count)||r<=this.Zt.lateTolerance}}return d?Qd.CloseEnough:Qd.TooFar}Bn(e){return e&&!fe(e.startTime)&&0===e.count}Fn(e,t,i){i=i?i[e]:null;return(null==i?void 0:i.count)===t||this.Bn(i)}isFragLoadingNeeded(e,t){if(!e)return!1;var i=t.subtitleParsedInfo,r=t.subtitleBufferInfo;if(i&&r){const t=null==(r=r.fragInfoMap[e.mediaSeqNum])?void 0:r.count;return!this.Fn(e.mediaSeqNum,null!=t?t:0,i)}return!0}Un(e,t,i){var r=t.mediaSeqNum-e.startSN-1;return r<0||r>e.fragments.length-1?(this.R.error(`[subtitle] getEarlierFragmentInSameDisco index ${r} out of range`),t):(e=e.fragments[r])&&e.discoSeqNum===t.discoSeqNum&&!i[t.mediaSeqNum]?e:t}inferSubtitleFragmentForPosition(r,n,a,s,o){var l,d,i,u;let c=null,h=NaN,e=null,p=NaN,m=null;if(s&&a&&fe(s.prevFragSN)&&(h=s.prevFragSN-o.startSN,e=a[s.prevFragSN]),s&&a&&fe(s.nextFragSN)&&(p=s.nextFragSN-o.startSN,m=a[s.nextFragSN]),s&&a&&fe(h)&&0<=h&&h<o.fragments.length&&e){let t=e.startTime,i=null;const u=fe(p)?p:o.fragments.length;for(let e=h;e<u;++e){const p=o.fragments[e];if(p&&(!fe(n)||p.discoSeqNum===n)){if(!(i||fe(n)&&p.discoSeqNum!==n)){const r=null==(l=s.fragInfoMap[p.mediaSeqNum])?void 0:l.count;this.Fn(p.mediaSeqNum,null!=r?r:0,a)||(i=p)}if(e===u-1){c={foundFrag:p,timelineEstablished:!0};break}if(t+p.duration>r&&e>h){c={foundFrag:p,timelineEstablished:!0};break}t+=p.duration}}!c&&i&&(c={foundFrag:i,timelineEstablished:!1})}else if(s&&a&&fe(p)&&0<=p&&p<o.fragments.length&&m){let t=m.startTime,i=null;for(let e=p-1;0<=e;--e){const h=o.fragments[e];if(h&&(!fe(n)||h.discoSeqNum===n)){if(!fe(n)||h.discoSeqNum===n){const r=null==(d=s.fragInfoMap[h.mediaSeqNum])?void 0:d.count;this.Fn(h.mediaSeqNum,null!=r?r:0,a)||(i=h)}if(t<=r){c={foundFrag:h,timelineEstablished:!0};break}t-=h.duration}}!c&&i&&(c={foundFrag:i,timelineEstablished:!1})}else{let t=!0;for(let e=0;e<o.fragments.length;++e){const h=o.fragments[e];if(h&&s&&a&&fe(n)&&h.discoSeqNum===n){const n=null!=(u=null==(i=s.fragInfoMap[h.mediaSeqNum])?void 0:i.count)?u:0;if(!this.Fn(h.mediaSeqNum,n,a)&&(t=!1,r>=h.start&&r<h.start+h.duration)){c={foundFrag:h,timelineEstablished:!1};break}}}t||(c=c||{foundFrag:o.fragments[0],timelineEstablished:!1})}return c}$n(t,i,r,n,a,s){var e,o,l,d=[],u=null==r?void 0:r.foundFrag;if(!u)return{foundFrags:void 0,subtitleParsedInfo:void 0,subtitleBufferInfo:void 0,timelineEstablished:null!=(e=null==r?void 0:r.timelineEstablished)&&e};let c=-1;for(let e=u?u.mediaSeqNum-s.startSN:s.fragments.length;e<s.fragments.length&&d.length<t;++e){const t=s.fragments[e];if(t.discoSeqNum===i&&n&&a){const i=null==(o=a.fragInfoMap[t.mediaSeqNum])?void 0:o.count;this.Fn(t.mediaSeqNum,null!=i?i:0,n)||(d.push(t),t.mediaSeqNum>c&&(c=t.mediaSeqNum))}}for(let e=(void 0!==s.parts?s.parts.length:0)-1;0<=e;e--){const r=null==(l=s.parts)?void 0:l[e];if(r&&r.discoSeqNum===i){if(r.mediaSeqNum<=c)break;if(r.start<u.start+u.duration)break;d.push(r)}}return{foundFrags:d,subtitleParsedInfo:null!=n?n:void 0,subtitleBufferInfo:null!=a?a:void 0,timelineEstablished:null==r?void 0:r.timelineEstablished}}findFragmentsForPosition(e,t,i){let r=i.itemId+i.mediaOptionId;var n=this.availableMediaOptions.find(e=>e.mediaOptionId===i.mediaOptionId);n&&ke(n)&&(r="interstitial");let a=this.bi.mediaQuery.getParsedSubtitleRecordsForMediaOption(r);this.Zt.condenseSubtitleTrack&&n&&fe(n.persistentID)&&!ke(n)&&(a&&0<Object.keys(a).length?this.yn[n.persistentID]=a:this.yn[n.persistentID]&&(a=this.yn[n.persistentID]));var n=this.getCuesOfEnabledTrack(null==(n=this.selectedMediaOption)?void 0:n.mediaOptionId,!1),n=this.Ln(e,n,a,i),s=n.bufferInfo,e=Math.max(e,s.end),s=this.inferSubtitleFragmentForPosition(e,t,a,n,i);return this.$n(1/0,t,s,a,n,i)}get selectedMediaOption(){let e=this.Vn;return this.un&&(e=this.jn),this.selectedTrack||e}set selectedMediaOption(e){this.selectedTrack="groupId"in e?e:void 0}get selectedTrack(){return this.un?this.qn:this.zn}set selectedTrack(e){!this.ln&&e===this.zn||this.ln&&e===this.qn||(e&&ke(e)?this.qn=e:this.zn=e,this.Hn(e))}Qn(t){return this.availableMediaOptions.find(e=>e.mediaOptionId===t)}Hn(e){var t;!this.bi.textTracks||e&&ke(e)&&!this.un||e&&!ke(e)&&this.un||(e=this.selectedTrack?this.getExistingHTMLTextTrack(this.selectedTrack):void 0,t=Zd(this.bi.textTracks),this.Kn(t,e))}Dn(e){var t;this.bi.textTracks&&(t=Zd(this.bi.textTracks),e=e?this.getExistingHTMLTextTrack(e):void 0,this.Kn(t,e))}Kn(t,i){for(let e=0;e<t.length;e++){var r=t[e];r===i&&"showing"!==t[e].mode?t[e].mode="showing":r!==i&&"hidden"!==t[e].mode&&(t[e].mode="hidden")}}get availableMediaOptions(){var e;return this.un?null!=(e=this.Wn)?e:[]:null!=(e=this.Gn)?e:[]}Zi(){var r,n;if(this.bi&&this.nativeSubtitleTrackChange$){let t=!1,i=NaN;var a=Zd(this.bi.textTracks);for(let e=0;e<a.length;e++)a[e].seen?"showing"===a[e].mode&&(i=this.selectedTrack&&ke(this.selectedTrack)?null!=(r=this.selectedTrack.persistentID)?r:NaN:null!=(n=a[e].persistentId)?n:NaN):(a[e].seen=!0,t=!0);if(!t){const r=this.selectedTrack;if((null==r?void 0:r.persistentID)!==i){const r=this.availableMediaOptions.find(function(e){return e.persistentID===i}),n=null!=r?r:this.Vn;n&&this.nativeSubtitleTrackChange$.next(n)}}}}addCues(e,t,i,r){var n,a,s,o=this.Mn;let l=!1;for(let e=o.length;e--;){const r=o[e],d=(n=r[0],a=r[1],s=t,Math.min(a,i)-Math.max(n,s));if(0<=d&&(r[0]=Math.min(r[0],t),r[1]=Math.max(r[1],i),l=!0,.5<d/(i-t)))return}let d;l||o.push([t,i]),d=(d=this.cn?this.An["i"+e]:d)||this.An[e],this.Tn.newCue(d,t,i,r,this.bi.offsetWidth,this.bi.offsetHeight)}getExistingHTMLTextTrackWithChannelNumber(t){var i=this.bi;if(i)for(let e=0;e<i.textTracks.length;e++){var r=i.textTracks[e],n="cc"+t;if(Jd(n)&&!0===r[n])return r}return null}sendAddTrackEvent(e,t){let i=null;try{i=new window.Event("addtrack")}catch(e){(i=document.createEvent("Event")).initEvent("addtrack",!1,!1)}i.track=e,t.dispatchEvent(i)}createHTMLCaptionsTrackGuts(e,t,i,r){var n="cc"+e;if(!this.An[n]){e=this.getExistingHTMLTextTrackWithChannelNumber(e);if(e)this.An[n]=e,eu(this.An[n]),this.sendAddTrackEvent(this.An[n],this.bi);else{const e=this.createHTMLTextTrackGuts("captions",t,i,r);e&&Jd(n)&&(e[n]=!0,this.An[n]=e)}}return this.An[n]}createHTMLCaptionsTrack(e){return this.createHTMLCaptionsTrackGuts(e,this.Zt[1===e?"captionsTextTrack1Label":"captionsTextTrack2Label"],this.Zt.captionsTextTrack1LanguageCode,!1)}htmlTextTrackBelongToThisItem(e){return Object.values(this.En).includes(e)}getExistingHTMLTextTrack(e){var t;if(ke(e))return e.mediaType===Is.CLOSEDCAPTION?1===this.Xn(e)?this.Cn:this.xn:this._n;let i=this.Zt.condenseSubtitleTrack?this.En[null!=(t=e.persistentID)?t:NaN]:this.En[e.id];return i||this.getExistingHTMLTextTrackFromPreviousItem(e)||(i=this.Zt.dynamicTextTrackCreation?this.createHTMLTextTrack(e):i)}getExistingHTMLTextTrackFromPreviousItem(t){var i,r=t.mediaType===Is.SUBTITLE?"subtitles":"captions",n=this.bi.textTracks;let a=-1;for(let e=0;e<n.length;++e){var s=n[e];if((null!=(i=s.originalKind)?i:s.kind)===r&&s.forced===t.forced&&s.language===t.lang&&!this.htmlTextTrackBelongToThisItem(s)){a=e;break}}return n[a]}getExistingHTMLTextTrackWithSubtitleTrackId(t){var e=this.availableMediaOptions.find(e=>e.id===t);return e?this.getExistingHTMLTextTrack(e):void 0}getExistingHTMLTextTrackIndex(e){var t=this.getExistingHTMLTextTrack(e),i=this.bi.textTracks;let r=-1;for(let e=0;e<i.length;++e)if(i[e]===t){r=e;break}return r}setExistingHTMLTextTrack(e,t){if(fe(e.persistentID))return t.persistentId=e.persistentID,this.Zt.condenseSubtitleTrack?this.En[e.persistentID]=t:this.En[e.id]=t}createHTMLTextTrack(t,i=void 0){var e;if(i)this.fn+=1;else{if("sbtl"===t.mediaType)this.hn+=1,i=this.createHTMLTextTrackGuts("subtitles",t.name,t.lang,null!=(e=t.forced)&&e);else{let e=1;t.inStreamID&&(e=Number(t.inStreamID.substring(2))),this.dn+=1,i=this.createHTMLCaptionsTrackGuts(e,t.name,t.lang,!1)}i?this.setExistingHTMLTextTrack(t,i):(this.R.error(`failed to create HTML text track for track ${t.id}: persistent id ${t.persistentID} name ${t.name} lang ${t.lang} inStreamID `+t.inStreamID),this.vn+=1)}return i}createHTMLTextTrackGuts(t,i,r,n){var a=this.bi;if(a){let e=!1;"metadata"!==t&&this.Zt.customTextTrackCueRenderer&&(e=!0,t="metadata");a=a.addTextTrack(t,i,r);return e&&(a.customTextTrackCueRenderer=!0,a.originalKind=t),a.forced=n,a}}Xn(e){let t=1;return t=e.inStreamID?Number(e.inStreamID.substring(2)):t}removeEarlierId3Cues(e){var t=this.bi.id3TextTrack;if(t&&t.cues&&0<t.cues.length)for(;0<t.cues.length;){var i=t.cues[0];if(!(i.startTime<e))break;t.removeCue(i)}}removeEarlierCues(e,t=50){return this.removeCues(e,!0,t)}removeLaterCues(e,t=-1){return this.removeCues(e,!1,t)}removeCues(t,i=!0,r=50){if(this.bi){var n=this.bi.textTracks;for(let e=0;n&&e<n.length;e++){var a=n[e];if(a&&a.cues&&0<a.cues.length){let e=0;for(;0<a.cues.length&&(e<r||r<0);){const r=i?a.cues[0]:a.cues[a.cues.length-1];if(!(i?r.endTime<t:r.startTime>=t))break;a.removeCue(r),e++}}}i?(this.Yn(t),this.bi.removeEarlierParsedSubtitleFragmentRecord(t)):(this.Jn(t),this.bi.removeLaterParsedSubtitleFragmentRecord(t))}}Yn(t){var i=this.Mn;let r=0;for(let e=0;e<i.length&&!(i[e][0]>t);e++)i[e][1]<t?r++:i[e][0]<t&&i[e][1]>=t&&(i[e][0]=t);0<r&&i.splice(0,r)}Jn(t){var i=this.Mn;let r=0;for(let e=i.length-1;0<=e&&!(i[e][1]<=t);e--)i[e][0]>=t?r++:i[e][0]<t&&i[e][1]>=t&&(i[e][0]=t);0<r&&i.splice(-r,r)}_removeHtmlTextTrackMappings(){Object.entries(this.En).forEach(([e,t])=>{fe(e)&&t&&(this.En[e]=void 0)})}resetTracks(){var e;this.gotTracks=!1,this._clearAllTracks(),this.Mn=[],null!=(e=this.bi)&&e.clearAllParsedSubtitleFragmentRecord(),this._removeHtmlTextTrackMappings(),this.yn={}}_clearAllTracks(){var e=this.bi;if(e){var t=e.textTracks;for(let e=0;t&&e<t.length;e++)eu(t[e])}}_isInterstitialTextTrack(e){return e===this._n||e===this.Cn||e===this.Cn}endLoadingInterstitials(){this.Wn=[],this.jn=void 0,this.qn=void 0,this.ln=!1}getCuesOfEnabledTrack(e,t=!1){if(!e)return[];let i=[];if(t){const t=this._getCuesOfEnabledTrack(e);for(let e=0;e<t.length;e++){var r=t[e];Boolean(r.webVTTCue)&&i.push(r)}}else i=this._getCuesOfEnabledTrack(e);return i}_getCuesOfEnabledTrack(e){var t=this.Qn(e);let i;if(t&&ke(t))i=t.mediaType===Is.SUBTITLE?"interstitial":1===this.Xn(t)?"interstitialCC1":"interstitialCC2";else{const e=this.Zt.condenseSubtitleTrack?null==t?void 0:t.persistentID:null==t?void 0:t.id;i=null!=e?e:NaN}e=this.En[i];return t&&ke(t)&&this.un&&e&&this.Zn(t,e),e&&e.cues?Array.from(e.cues):[]}Zn(e,t){e.persistentID!==t.persistentId&&(t.persistentId=e.persistentID,eu(t),this.bi.clearParsedSubtitleRecordsForMediaOption("interstitial"))}ns(){eu(this._n),eu(this.Cn),eu(this.xn),this.bi.clearParsedSubtitleRecordsForMediaOption("interstitial")}ss(){for(let e=0;e<this.bi.textTracks.length;++e)this.bi.textTracks[e].persistentId=void 0}attachSubtitleTracks(){this.gotTracks&&(this.hn=0,this.dn=0,this.fn=0,this.vn=0,this.ss(),this.On.forEach(e=>{var t;"sbtl"===e.mediaType&&this.Zt.dynamicTextTrackCreation||(t=this.getExistingHTMLTextTrack(e),this.createHTMLTextTrack(e,t))}))}setTracks(e,t,i){this.En={},this.Mn=[],this.Zt.enableWebVTT&&(this.On=e||[]),this.gotTracks=!0,this.Gn=e,this.Vn=i,this.attachSubtitleTracks(),this.selectedTrack=t,this.nativeSubtitleTrackChange$=new Ie,this.bi.textTracksCreated=!0}setInterstitialTracks(e,t,i){this.En||(this.En={}),this.ln=!0;let r=!1,n=!1,a=!1;e.forEach(e=>{e.mediaType===Is.SUBTITLE?r=!0:1===this.Xn(e)?n=!0:a=!0}),!this._n&&r&&(this._n=this.createHTMLTextTrackGuts("subtitles","interstitialTextTrack","interstitialMulti",!1),this.En.interstitial=this._n),!this.Cn&&n&&(this.Cn=this.createHTMLTextTrackGuts("captions","interstitialCCTrack1","interstitialMulti",!1),this.Cn)&&(this.En.interstitialCC1=this.Cn,this.An.icc1=this.Cn),!this.xn&&a&&(this.xn=this.createHTMLTextTrackGuts("captions","interstitialCCTrack2","interstitialMulti",!1),this.xn)&&(this.En.interstitialCC2=this.xn,this.An.icc2=this.xn),this.Wn=e,this.jn=i,(this.selectedTrack=t)&&(t.mediaType===Is.SUBTITLE?this._n&&(this._n.persistentId=t.persistentID):1===this.Xn(t)?this.Cn&&(this.Cn.persistentId=t.persistentID):this.xn&&(this.xn.persistentId=t.persistentID)),this.nativeSubtitleTrackChange$=new Ie}onInlineStylesParsed(e){}processSubtitleFrag(e,t,i,r,n,a=!0){e=this.getExistingHTMLTextTrackIndex(e);return t&&r.byteLength?a?this._parseVTTs(e,t,i,r,n).pipe(ve(e=>(e&&fe(e.startTime)&&(this.Nn=Math.max(this.Nn,e.endTime)),e))):this._parseTTML(e,t,i,r,this.R).pipe(ve(e=>(e&&fe(e.startTime)&&(this.Nn=Math.max(this.Nn,e.endTime)),e))):be(void 0)}rs(e,n,t,a){const s=this.bi.textTracks[e],i={count:0,startTime:Number.POSITIVE_INFINITY,endTime:0},o=new jr(0);o.pipe(pr(Zi),wr((e,t)=>{var i=performance.now();let r=t;for(;r<a.length&&(r-t<100||performance.now()-i<200);++r){const t=a[r];!s||s.cues&&s.cues.getCueById(t.id)||(t.fragSN=n.mediaSeqNum,t.webVTTCue=!0,t.itemId=n.itemId,s.addCue(t),e.count++),e.startTime=Math.min(t.startTime,e.startTime),e.endTime=Math.max(t.endTime,e.endTime)}return r<a.length?o.next(r):o.complete(),e},i),Ee(()=>{let e="interstitial";this.selectedTrack&&!ke(this.selectedTrack)&&(e=this.selectedTrack.itemId+this.selectedTrack.mediaOptionId),this.bi.archiveParsedSubtitleFragmentRecord(e,n.mediaSeqNum,i)}),Hr(()=>{t.complete()})).subscribe(t)}_parseVTTs(f,g,y,v,I){return new F(t=>{{var i=v,r=y,n=g.start,a=(g.discoSeqNum,e=>{this.rs(f,g,t,e)}),s=e=>{},u=e=>{var t;null!=(t=this.Yi)&&t.trigger(L.INLINE_STYLES_PARSED,{styles:e,appItemId:I})};this.R;const c=De.utf8arrayToStr(new Uint8Array(i)).trim().replace(/\r\n|\n\r|\n|\r/g,"\n").split("\n"),h=w(r,bd);let o=0,l=0;const p=[];let d=null,e=!0;const m=new td.WebVTTParser(window,td.WebVTTParser.StringDecoder(),u);m.oncue=function(e){var t=C({baseTime:Ed(Ed(o)-h.baseTime,n*bd),timescale:bd});e.startTime=Ed(e.startTime+t-l,0,95443.7176888889),e.endTime=Ed(e.endTime+t-l,0,95443.7176888889),e.id=ae(Ad(e.startTime).toString())+ae(Ad(e.endTime-e.startTime).toString())+ae(e.text),e.text=decodeURIComponent(encodeURIComponent(e.text)),0<e.endTime&&p.push(e)},m.onparsingerror=function(e){d=e},m.onflush=function(){d&&s?d:a(p)},c.forEach(s=>{e&&Td(s,"X-TIMESTAMP-MAP=")?(e=!1,s.substr(16).split(",").forEach(e=>{if(Td(e,"LOCAL:")){let t;try{t=(i=e.substr(6),r=parseInt(i.substr(-3)),n=parseInt(i.substr(-6,2)),a=parseInt(i.substr(-9,2)),i=9<i.length?parseInt(i.substr(0,i.indexOf(":"))):0,fe(r)&&fe(n)&&fe(a)&&fe(i)?(r+=1e3*n)+6e4*a+36e5*i:-1)}catch(e){t=-1}-1!==t?l=t/1e3:d=new me(!1,pe.WebVTTMalformedXTIMESTAMPMAP,`Malformed X-TIMESTAMP-MAP: `+s)}else Td(e,"MPEGTS:")&&(o=parseInt(e.substr(7)));var i,r,n,a})):"<br/>"!==s&&"<br>"!==s&&(s=(s=s.replace(/<br\/>/g,"")).replace(/<br>/g,""),m.parse(s+"\n"))}),m.flush()}})}_parseTTML(t,i,e,r,n){const a=Yd.extractXML(r),s=Yd.generateCues(a,e,i.start,n);return new F(e=>{this.rs(t,i,e,s)})}_ensureParser(){var e,t;this.ls||(e=new $d(this,1),t=new $d(this,2),this.ls=new class{constructor(e=1,t,i){this.us=e,this.hs=-1,this.ds=null,this.fs=null,this.vs=[new Vd(1,t),new Vd(2,i)],this.gs={padding:0,char:0,cmd:0,other:0}}getHandler(e){return this.vs[e].getHandler()}setHandler(e,t){this.vs[e].setHandler(t)}addData(e,t){let i,r,n,a=null;Nd.setTime(e);for(let e=0;e<t.length;e+=2)r=127&t[e],n=127&t[e+1],16<=r&&r<=31&&r===this.ds&&n===this.fs?(this.ds=null,this.fs=null,Nd.log("DEBUG","Repeated command ("+wd([r,n])+") is dropped")):0!=r||0!=n?(Nd.log("DATA","["+wd([t[e],t[e+1]])+"] -> ("+wd([r,n])+")"),!(i=(i=(i=(i=this.parseCmd(r,n))||this.parseMidrow(r,n))||this.parsePAC(r,n))||this.parseBackgroundAttributes(r,n))&&(a=this.parseChars(r,n))&&(this.hs&&0<=this.hs?this.vs[this.hs-1].insertChars(a):Nd.log("WARNING","No channel found yet. TEXT-MODE?")),i?this.gs.cmd+=2:a?this.gs.char+=2:(this.gs.other+=2,Nd.log("WARNING","Couldn't parse cleaned data "+wd([r,n])+" orig: "+wd([t[e],t[e+1]])))):this.gs.padding+=2}parseCmd(e,t){var i,r;return((20===e||21===e||28===e||29===e)&&32<=t&&t<=47||(23===e||31===e)&&33<=t&&t<=35)&&(r=this.vs[(i=20===e||23===e?1:2)-1],20===e||21===e||28===e||29===e?32===t?r.ccRCL():33===t?r.ccBS():34===t?r.ccAOF():35===t?r.ccAON():36===t?r.ccDER():37===t?r.ccRU(2):38===t?r.ccRU(3):39===t?r.ccRU(4):40===t?r.ccFON():41===t?r.ccRDC():42===t?r.ccTR():43===t?r.ccRTD():44===t?r.ccEDM():45===t?r.ccCR():46===t?r.ccENM():47===t&&r.ccEOC():r.ccTO(t-32),this.ds=e,this.fs=t,this.hs=i,!0)}parseMidrow(e,t){var i;return(17===e||25===e)&&32<=t&&t<=47&&((i=17===e?1:2)!==this.hs?(Nd.log("ERROR","Mismatch channel in midrow parsing"),!1):((i=this.vs[i-1]).insertChars([32]),i.ccMIDROW(t),Nd.log("DEBUG","MIDROW ("+wd([e,t])+")"),this.ds=e,this.fs=t,!0))}parsePAC(e,t){var i=null,r=null;return((17<=e&&e<=23||25<=e&&e<=31)&&64<=t&&t<=127||(16===e||24===e)&&64<=t&&t<=95)&&(i=e<=23?1:2,r=(64<=t&&t<=95?1==i?Cd:Ld:1==i?kd:Dd)[e],r=this.interpretPAC(r,t),this.vs[i-1].setPAC(r),this.ds=e,this.fs=t,this.hs=i,!0)}interpretPAC(e,t){e={color:void 0,italics:!1,indent:null,underline:!1,row:e};return e.underline=1==(1&(t=95<t?t-96:t-64)),t<=13?e.color=["white","green","blue","cyan","red","yellow","magenta","white"][Math.floor(t/2)]:t<=15?(e.italics=!0,e.color="white"):e.indent=4*Math.floor((t-16)/2),e}parseChars(e,t){let i=null,r=null,n=null;var a;if(17<=(n=25<=e?(i=2,e-8):(i=1,e))&&n<=19?(a=t,a=17===n?t+80:18===n?t+112:t+144,Nd.log("INFO","Special char '"+Od(a)+"' in channel "+i),r=[a],this.ds=e,this.fs=t):32<=e&&e<=127&&(r=0===t?[e]:[e,t],this.ds=null,this.fs=null),r){const e=wd(r);Nd.log("DEBUG",`Char codes =  `+e.join(","))}return r}parseBackgroundAttributes(e,t){var i,r;return((16===e||24===e)&&32<=t&&t<=47||(23===e||31===e)&&45<=t&&t<=47)&&(i={underline:!1},16===e||24===e?(r=Math.floor((t-32)/2),i.background=xd[r],t%2==1&&(i.background=i.background+"_semi")):45===t?i.background="transparent":(i.foreground="black",47===t&&(i.underline=!0)),this.vs[(e<24?1:2)-1].setBkgData(i),this.ds=null,this.fs=null,!0)}reset(){for(let e=0;e<this.vs.length;e++)this.vs[e]&&this.vs[e].reset();this.ds=null,this.fs=null}cueSplitAtTime(t){for(let e=0;e<this.vs.length;e++)this.vs[e]&&this.vs[e].cueSplitAtTime(t)}}(0,e,t))}setupForFrag(e){var t;e&&e.mediaOptionType===we.Variant&&!e.iframe&&(t=e.mediaSeqNum,e=e.discoSeqNum,t===this.tn+1&&e===this.sn||this.resetClosedCaptionParser(),this.tn=t,this.sn=e)}resetClosedCaptionParser(){var e;null!=(e=this.ls)&&e.reset()}addLegibleSamples(e,t,i,r,n,a){this.cn=!!a,t&&this.addClosedCaptionSamples(e,t),i&&0<i.length&&this.addId3Samples(e,i,r,C(n))}addClosedCaptionSamples(e,t){t.mp4?this.addMP4CaptionSamples(e,t.mp4):t.ts&&this.addTSCaptionSamples(e,t.ts)}addMP4CaptionSamples(e,i){var r;if(this.wn&&this.Zt.enableCEA708Captions){var n=C(e);this._ensureParser();for(let e=0;e<i.length;e++){let t=i[e].pts-n;var a=i[e].bytes;for(let e=0;e<a.length;e+=2){const i=[];i.push(a[e]),e+1<a.length?i.push(a[e+1]):i.push(80),null!=(r=this.ls)&&r.addData(t,i),t+=.03336666666666667}}}}addTSCaptionSamples(e,t){var i;if(this.wn&&this.Zt.enableCEA708Captions){var r=C(e);this._ensureParser();for(let e=0;e<t.length;e++){var n=t[e].pts-r,a=function(t){var i=31&t[0];let r,n,a,s=2;var o=[];for(let e=0;e<i;e++)r=t[s++],n=127&t[s++],a=127&t[s++],0==n&&0==a||0!=(4&r)&&0==(3&r)&&(o.push(n),o.push(a));return o}(t[e].bytes);null!=(i=this.ls)&&i.addData(n,a)}}}addId3Samples(e,t,r,n){var a;if(this.Zt.enableID3Cues){const s=window.WebKitDataCue||window.VTTCue||window.TextTrackCue,o=C(e);for(let e=0;e<t.length;e++){const l=this._adjustID3PtsForRollover(t[e].pts,r)-o;let i=this._adjustID3PtsForRollover(e<t.length-1?t[e+1].pts:n,r)-o;l===i&&(i+=1e-4),!t[e].frames||null!=(a=t[e].frames)&&a.forEach(e=>{var t;e&&!this.id3shouldIgnore(e)&&((t=new s(l,i,"")).value=e,this.Sn.addCue(t))})}}}_adjustID3PtsForRollover(e,t){return Ed(e*t.timescale,t.baseTime,Math.pow(2,33))/t.timescale}id3shouldIgnore(e){return"PRIV"===e.key&&("com.apple.streaming.transportStreamTimestamp"===e.info||"com.apple.streaming.audioDescription"===e.info)}}class iu{constructor(e,t=!1){this.R=e,this.retryErrorAsCustomURL=t,this.ys={},this.gotRequest$=new Ie,this.Le=Math.round(performance.now())}load(u,c){return new F(e=>{const{url:t,extendMaxTTFB:i}=u,r=c["maxTimeToFirstByteMs"],n={trequest:performance.now(),tfirst:NaN,tload:NaN,tdataack:NaN,loaded:0,total:NaN,complete:!1},a=this.ys[t]=new $r,s=fe(i)&&0<i?i:r,o=a.pipe(un(s),Ae(e=>(n.tfirst=performance.now(),this.Ss(e,u,c,n))),ye(e=>{if(e instanceof dn)throw new to(e.message,n,!0,"TTFB");throw e}),Hr(()=>{delete this.ys[t]})),l=(u.onProgress&&u.onProgress.cb(t,0,n,null),o.subscribe(e)),d={id:this.Le++,resolve:e=>{a.next(e),a.complete()},uri:t,responseType:u.responseType,userAgent:navigator.userAgent,forInterstitialAssetList:!!u.forInterstitialAssetList,interstitialId:u.interstitialId,interstitialAssetId:u.interstitialAssetId,appItemId:null!=(e=u.appItemId)?e:""};return this.gotRequest$.next(d),()=>{var e;l.unsubscribe(),null!=(e=d.oncomplete)&&e.call(d),delete this.ys[t]}})}setCustomUrlResponse(e,t){var i=this.ys[e];i&&(i.next(t),i.complete(),delete this.ys[e])}Ss(e,t,i,r){r.tload=performance.now();var n=e.status;return 200<=n&&n<300||0===n&&e.data?("arraybuffer"===t.responseType&&e.data instanceof ArrayBuffer?r.loaded=e.data.byteLength:r.loaded=e.data.toString().length,r.tdataack=performance.now(),r.total=r.loaded,r.complete=!0,gr(be({status:n,response:e,stats:r}),Rn)):300!==n&&302!==n&&303!==n&&305!==n||t.url===e.uri?Fr(new zs("Unable to load custom url",n,!0)):this.ws(e.uri,t,i,r)}ws(e,t,i,n){var r=t["extendMaxTTFB"],{maxLoadTimeMs:a,maxTimeToFirstByteMs:s}=i,a=fe(a)?a-(performance.now()-n.trequest):void 0,r=fe(r)&&0<r?r:s-(performance.now()-n.trequest),s=Object.assign(Object.assign({},i),{maxLoadTimeMs:a,maxTimeToFirstByteMs:r}),i=Object.assign(Object.assign({},t),{url:e});if(fe(a)&&a<=0)throw new to("",n,Qa(e),"MaxLoad");if(r<=0)throw new to("",n,Qa(e),"TTFB");return Qa(e)?this.load(i,s):vo(i,s).pipe(ve(([e,t])=>{var{responseURL:i,status:r}=e,i=i||"",r=(n.tload=performance.now(),{status:r,uri:i,data:e.response});return n.tdataack=performance.now(),n.loaded=n.total=t.loaded,n.complete=!0,{status:e.status,response:r,stats:n}}))}}class ru{constructor(e,t,i){this.Is=e,this.Ke=t,this.Ts=(e,t)=>{const i=t["sessionDataAutoLoad"],r=Object.assign({},e);return e.complete||e.itemList&&(r.complete=e.itemList.every(e=>!(i[e["DATA-ID"]]&&!e.VALUE&&!e._STATUS&&e.URI))),r},this.R=i.child({name:"SessionDataLoader"})}loadSessionData(n,a){const s=a["sessionDataAutoLoad"],t=n.itemList||[];let o=be(n);return t.forEach(e=>{const i=e["DATA-ID"],r=e.URI;if(r&&s[i])if("_hls.localized-rendition-names"===i&&function(e){var t=e.split(":");if("data"===t[0]&&2===t.length){const e=t[1].split(";"),i=e[e.length-1].split(",");return 2===i.length?"base64"===i[0]:void 0}}(r)){const n=rl.convertDataUriToArrayBytes(r);let t="";null!=n&&(t=De.utf8arrayToStr(n)),void(o=o.pipe(Ae(e=>be(this.Os(e,i,"VALUE",t)))))}else{const s=Va.buildAbsoluteURL(n.baseUrl,r,{alwaysNormalize:!0}),e="";o=o.pipe(Ae(t=>this.Ms(s,i,n.appItemId,e,a,t,this.Is,this.Ke).pipe(ye(e=>(this.R.error(`Error loading SessionData > url=${z(s)}, id=${i}, err=`+e),be(t))))))}}),o.pipe(ve(e=>{if(t.length<1)return e;e=this.Ts(e,a);if(e.complete)return e;throw new me(!1,pe.IncompleteSessionData)}),Hr(()=>{}))}Ms(r,n,e,t,a,s,i,o){const l={url:r,method:"GET",responseType:t,xhrSetup:a.xhrSetup,mimeType:"application/xml",appItemId:e},d=no({url:r},a.fragLoadPolicy);let u;if(Qa(r))u=o(l,d).pipe(ve(e=>this.As(s,n,e.response.data.toString(),e.response.data)));else{const r=performance.now();u=i(l,d).pipe(ve(([e])=>this.As(s,n,e.response,e.responseXML)),ye(e=>{if(a.useCustomURLLoaderForAuthOrCORSErrors&&e instanceof zs&&e.isAuthOrCorsError)return t=l,i=d,o(t,co(t,i,r)).pipe(ve(e=>this.As(s,n,e.response.data.toString(),e.response.data)));var t,i;throw e}))}return u.pipe(ye(e=>(e instanceof dn?e=new Zs(!1,pe.SessionDataLoadTimeout,Qa(r)):e instanceof zs&&(e=new Zs(!1,e.statusCode,Qa(r),e.message)),this.R.error(`Unable to load SessionData > err=`+e),be(this.Es(s,n,e)))))}As(e,t,i,r){let n=null,a=e;if(s=i,(o=/[\s]*<\?xml/i).lastIndex=0,((o=o.exec(s))||/[\s]*<plist/i.exec(s))&&(n=r)){const i=function n(e){if(!e)return null;let a=null;var s=e.childNodes;if(s)if(e.tagName){const t=null==(e=e.tagName)?void 0:e.toLowerCase();if("plist"===t){a=[];for(let e=0;e<s.length;++e){const t=s[e];t.tagName&&a.push(n(t))}1===a.length&&(a=a[0])}if("array"===t){a=[];for(let e=0;e<s.length;++e){const t=s[e];t.tagName&&a.push(n(t))}}if("dict"===t){let t,i,r=0;a={};for(let e=0;e<s.length;e++){var o=s[e],l=null==(l=o.tagName)?void 0:l.toLowerCase();l&&(r%2==0?"key"===l&&(t=n(o),r++):(i=n(o),a[t]=i,t=null,i=null,r++))}t&&(a[t]=i,t=null,i=null)}else if("key"===t){const e=s[0];a=e?e.nodeValue:null}else if("string"===t){const e=s[0];a=e?e.nodeValue:null}else if("integer"===t){const e=s[0];a=e&&e.nodeValue?parseInt(e.nodeValue):0}else if("float"===t){const e=s[0];a=e&&e.nodeValue?parseFloat(e.nodeValue):0}else if("date"===t){const e=s[0];a=e&&e.nodeValue?new Date(e.nodeValue):null}else if("data"===t){const e=s[0];a=e&&e.nodeValue?atob(e.nodeValue):null}else"true"===t?a=!0:"false"===t&&(a=!1)}else if(!(s.length<1)){a=[];for(let e=0;e<s.length;++e){const t=s[e];t.tagName&&a.push(n(t))}1===a.length&&(a=a[0])}return a}(n);a=this.Os(e,t,"VALUE",i)}else if(o=i,(s=/[\s]*[\{\[]/).lastIndex=0,s.exec(o))try{const r=JSON.parse(i);a=this.Os(e,t,"VALUE",r)}catch(r){this.R.error(`JSON parser error: `+r),a=this.Os(e,t,"VALUE",i),a=this.Os(a,t,"_STATUS",-1)}else a=this.Os(e,t,"VALUE",i);var s,o;return a}Os(t,i,r,n){let a=t;if(t.itemList){let e;var s=[...t.itemList];for(e=0;e<t.itemList.length;++e){const t=Object.assign({},s[e]);if(t["DATA-ID"]===i){t[r]=n,s[e]=t;break}}e===t.itemList.length&&this.R.error(`Can't set ${r} of session data `+i),a=Object.assign(Object.assign({},t),{itemList:s})}else this.R.error(`Can't set ${r} on uninitialized session data`);return a}Es(e,t,i){return this.Os(e,t,"_STATUS",i.response)}}const nu=new Set(["buildType","customTextTrackCueRenderer","debug","debugLevel","disableVideoCodecList","disableAudioCodecList","enablePerformanceLogging","enableQueryParamsForITunes","enableRtcReporting","nativeControlsEnabled","offlinePlayback","playReadyMessageFormat","rtcIntervalTimeout","sessionDataAutoLoad","storage","storageKeyPrefix","supportedStorebagVersion","useCustomMediaFunctions","useHighestVideoCodecPrivate","xhrSetup"]);function au(e,t){var i=e.split(".").map(e=>Number.parseInt(e)),r=t.split(".").map(e=>Number.parseInt(e));for(let e=0;e<Math.min(i.length,r.length);e++){if(i[e]<r[e])return!1;if(i[e]>r[e])return!0}return!0}function su(t){var i=Math.random();let r=0;for(let e=0;e<t.length;e++)if(i<(r+=t[e]))return e;return t.length-1}function ou(e){try{return JSON.stringify(e)}catch(e){return'"[Circular]"'}}var lu,du,uu,cu,hu,pu=function(e,t,i){var r=i&&i.stringify||ou;if("object"==typeof e&&null!==e){var n=t.length+1;if(1===n)return e;var a=new Array(n);a[0]=r(e);for(var s=1;s<n;s++)a[s]=r(t[s]);return a.join(" ")}if("string"!=typeof e)return e;var o=t.length;if(0===o)return e;for(var l,d="",u=0,c=-1,h=e&&e.length||0,p=0;p<h;){if(37===e.charCodeAt(p)&&p+1<h){switch(c=-1<c?c:0,e.charCodeAt(p+1)){case 100:o<=u||(c<p&&(d+=e.slice(c,p)),null!=t[u]&&(d+=Number(t[u]),c=p+=2));break;case 79:case 111:case 106:o<=u||(c<p&&(d+=e.slice(c,p)),void 0!==t[u]&&(d+="string"==(l=typeof t[u])?"'"+t[u]+"'":"function"==l?t[u].name||"<anonymous>":r(t[u]),c=p+2,p++));break;case 115:o<=u||(c<p&&(d+=e.slice(c,p)),d+=String(t[u]),c=p+2,p++);break;case 37:c<p&&(d+=e.slice(c,p)),d+="%",c=p+2,p++}++u}++p}return-1===c?e:(c<h&&(d+=e.slice(c)),d)},mu=gu,fu=function(){function t(e){return void 0!==e&&e}try{return"undefined"==typeof globalThis&&Object.defineProperty(Object.prototype,"globalThis",{get:function(){return delete Object.prototype.globalThis,this.globalThis=this},configurable:!0}),globalThis}catch(e){return t(hv)||t(window)||t(this)||{}}}().console||{},e={mapHttpRequest:bu,mapHttpResponse:bu,wrapRequestSerializer:Tu,wrapResponseSerializer:Tu,wrapErrorSerializer:Tu,req:bu,res:bu,err:function(e){var t,i={type:e.constructor.name,msg:e.message,stack:e.stack};for(t in e)void 0===i[t]&&(i[t]=e[t]);return i}};function gu(a){(a=a||{}).browser=a.browser||{};var s=a.browser.transmit;if(s&&"function"!=typeof s.send)throw Error("pino: transmit option must have a send function");var e=a.browser.write||fu,o=(a.browser.write&&(a.browser.asObject=!0),a.serializers||{}),l=(t=a.browser.serialize,i=o,Array.isArray(t)?t.filter(function(e){return"!stdSerializers.err"!==e}):!0===t&&Object.keys(i)),t=a.browser.serialize,i=(Array.isArray(a.browser.serialize)&&-1<a.browser.serialize.indexOf("!stdSerializers.err")&&(t=!1),"function"==typeof e&&(e.error=e.fatal=e.warn=e.info=e.debug=e.trace=e),!1===a.enabled&&(a.level="silent"),a.level||"info"),r=Object.create(e),n=(r.log||(r.log=Au),Object.defineProperty(r,"levelVal",{get:function(){return"silent"===this.level?1/0:this.levels.values[this.level]}}),Object.defineProperty(r,"level",{get:function(){return this._level},set:function(e){if("silent"!==e&&!this.levels.values[e])throw Error("unknown level "+e);this._level=e,yu(n,r,"error","log"),yu(n,r,"fatal","error"),yu(n,r,"warn","error"),yu(n,r,"info","log"),yu(n,r,"debug","log"),yu(n,r,"trace","log")}}),{transmit:s,serialize:l,asObject:a.browser.asObject,levels:["error","fatal","warn","info","debug","trace"],timestamp:"function"==typeof(e=a).timestamp?e.timestamp:!1===e.timestamp?Eu:Ou});return r.levels=gu.levels,r.level=i,r.setMaxListeners=r.getMaxListeners=r.emit=r.addListener=r.on=r.prependListener=r.once=r.prependOnceListener=r.removeListener=r.removeAllListeners=r.listeners=r.listenerCount=r.eventNames=r.write=r.flush=Au,r.serializers=o,r._serialize=l,r._stdErrSerialize=t,r.child=function(t){var e,i,r;if(t)return e=t.serializers,l&&e&&(i=Object.assign({},o,e),r=!0===a.browser.serialize?Object.keys(i):l,delete t.serializers,vu([t],r,i,this._stdErrSerialize)),n.prototype=this,new n(this);throw new Error("missing bindings for child Pino");function n(e){this._childLevel=1+(0|e._childLevel),this.error=Iu(e,t,"error"),this.fatal=Iu(e,t,"fatal"),this.warn=Iu(e,t,"warn"),this.info=Iu(e,t,"info"),this.debug=Iu(e,t,"debug"),this.trace=Iu(e,t,"trace"),i&&(this.serializers=i,this._serialize=r),s&&(this._logEvent=Su([].concat(e._logEvent.bindings,t)))}},s&&(r._logEvent=Su()),r}function yu(e,t,i,r){var u,c,h,p,n=Object.getPrototypeOf(t);t[i]=!(t.levelVal>t.levels.values[i])&&(n[i]||fu[i]||fu[r])||Au,c=t,h=i,!(u=e).transmit&&c[h]===Au||(c[h]=(p=c[h],function(){for(var e,t,i,r,n,a,s=u.timestamp(),o=new Array(arguments.length),l=Object.getPrototypeOf&&Object.getPrototypeOf(this)===fu?fu:this,d=0;d<o.length;d++)o[d]=arguments[d];u.serialize&&!u.asObject&&vu(o,this._serialize,this.serializers,this._stdErrSerialize),u.asObject?p.call(l,function(e,t,i,r){e._serialize&&vu(i,e._serialize,e.serializers,e._stdErrSerialize);var n=i.slice(),i=n[0],a={},s=(r&&(a.time=r),a.level=gu.levels.values[t],1+(0|e._childLevel));if(s<1&&(s=1),null!==i&&"object"==typeof i){for(;s--&&"object"==typeof n[0];)Object.assign(a,n.shift());i=n.length?pu(n.shift(),n):void 0}else"string"==typeof i&&(i=pu(n.shift(),n));return void 0!==i&&(a.msg=i),a}(this,h,o,s)):p.apply(l,o),u.transmit&&(l=u.transmit.level||c.level,e=gu.levels.values[l],(t=gu.levels.values[h])<e||(e=this,s={ts:s,methodLevel:h,methodValue:t,transmitLevel:l,transmitValue:gu.levels.values[u.transmit.level||c.level],send:u.transmit.send,val:c.levelVal},t=o,l=s.send,i=s.ts,r=s.methodLevel,n=s.methodValue,s=s.val,a=e._logEvent.bindings,vu(t,e._serialize||Object.keys(e.serializers),e.serializers,void 0===e._stdErrSerialize||e._stdErrSerialize),e._logEvent.ts=i,e._logEvent.messages=t.filter(function(e){return-1===a.indexOf(e)}),e._logEvent.level.label=r,e._logEvent.level.value=n,l(r,e._logEvent,s),e._logEvent=Su(a)))}))}function vu(e,t,i,r){for(var n in e)if(r&&e[n]instanceof Error)e[n]=gu.stdSerializers.err(e[n]);else if("object"==typeof e[n]&&!Array.isArray(e[n]))for(var a in e[n])t&&-1<t.indexOf(a)&&a in i&&(e[n][a]=i[a](e[n][a]))}function Iu(i,r,n){return function(){var e=new Array(1+arguments.length);e[0]=r;for(var t=1;t<e.length;t++)e[t]=arguments[t-1];return i[n].apply(this,e)}}function Su(e){return{ts:0,messages:[],bindings:e||[],level:{label:"",value:0}}}function bu(){return{}}function Tu(e){return e}function Au(){}function Eu(){return!1}function Ou(){return Date.now()}gu.levels={values:{fatal:60,error:50,warn:40,info:30,debug:20,trace:10},labels:{10:"trace",20:"debug",30:"info",40:"warn",50:"error",60:"fatal"}},gu.stdSerializers=e,gu.stdTimeFunctions=Object.assign({},{nullTime:Eu,epochTime:Ou,unixTime:function(){return Math.round(Date.now()/1e3)},isoTime:function(){return new Date(Date.now()).toISOString()}});const wu=()=>{};function Ru(e,t){t=(e=t in e?e:console)[t]||e.log;return t?t.bind(e):wu}function Mu(r,n,t,i,a){var{time:s,sessionId:o,critical:l,name:d,isEnabled:u,msg:c}=a;if((!u||u.value)&&!(t.size&&!t.has(d)||i.has(d))){let e="";if("data"in a)try{const r=[],n=[];e=JSON.stringify(a.data,(e,t)=>{if("object"==typeof t&&null!==t){var i=n.indexOf(t);if(-1!==i)return`[Circular object reference: '${r[i]}']`;r.push(e),n.push(t)}return t})}catch(r){e=`Log serialization error: "${r}"`}r((u=new Date(s),t=u.getTimezoneOffset(),i=Pu(Math.floor(Math.abs(t)/60)),a=Pu(Math.abs(t)%60),t=t<=0?"UTC+"+i:"UTC-"+i,t=a?t+":"+a:t,u.getFullYear()+"-"+Pu(u.getMonth()+1)+"-"+Pu(u.getDate())+" "+Pu(u.getHours())+":"+Pu(u.getMinutes())+":"+Pu(u.getSeconds())+"."+(u.getMilliseconds()/1e3).toFixed(3).slice(2,5)+" "+t+`| [SessionID: ${o}] | [${n}] >${l?" [QE Critical]":""} [${d}] ${c||""} `+e))}}function Pu(e){return e<10?"0"+e:e.toString()}function Cu(e,t,i){return e.has(t)?e.get(t):(i=i(),e.set(t,i),i)}class ku extends Map{constructor(e,t){super(Array.isArray(e)?e:Array.isArray(t)?t:null),this.max=ku.DEFAULT_MAX,"number"==typeof e?this.max=e:"number"==typeof t&&(this.max=t)}get(e){let t;return super.has(e)?(this.stats&&(this.stats.hits=this.stats.hits?1:this.stats.hits+1),t=super.get(e),super.delete(e),t&&super.set(e,t)):this.stats&&(this.stats.misses=this.stats.misses?1:this.stats.misses+1),t}set(e,t){return this.size>=this.max&&super.delete(super.keys().next().value),super.set(e,t),this}}ku.DEFAULT_MAX=5;const Lu=[Re.ContentSteeringPathwayCloner,Re.PathwayPenaltyBoxFilter,Re.PermanentRemovalFilter,Re.PenaltyBoxFilter,Re.CompatibleIdsFilter,Re.HDRFilter,Re.ResolutionTierFilter,Re.ViewportFilter,Re.HDCPFilter,Re.MatchingPathwayFilter],Du=Lu.filter(e=>{switch(e){case Re.CompatibleIdsFilter:case Re.MatchingPathwayFilter:return!1;default:return!0}}).concat(Re.PathwayFilter),xu={[ys.ABR]:[...Lu,Re.HostRankFilter,Re.NonIframeOnlyFilter,Re.BitrateFilter],[ys.ABRLowestLevel]:[...Lu,Re.HostRankFilter,Re.NonIframeOnlyFilter,Re.ValidAlternatesFilter,Re.LowerQualitySelector],[ys.ABRIframe]:[...Lu,Re.IframeOnlyFilter,Re.BitrateFilter],[ys.ABRIframeLowestLevel]:[...Lu,Re.IframeOnlyFilter,Re.LowerQualitySelector],[ys.ErrorHandling]:[...Lu,Re.PathwayRankSelector,Re.LowerPivotQualitySelector,Re.PivotAudioGroupSelector,Re.ValidFallbackFilter,Re.ErrorHandlingValidAlternatesFilter,Re.FallbackSelector],[ys.ErrorHandlingSdrOnly]:function(){var e=[];for(const t of Lu)switch(t){case Re.CompatibleIdsFilter:break;case Re.HDRFilter:e.push(Re.SdrOnlyFilter);break;default:e.push(t)}return e.push(Re.PathwayRankSelector,Re.LowerPivotQualitySelector,Re.PivotAudioGroupSelector,Re.ValidFallbackFilter,Re.ErrorHandlingValidAlternatesFilter,Re.FallbackSelector),e}(),[ys.FirstSelection]:Du.concat(Re.NonIframeOnlyFilter,Re.FirstLevelSelector),[ys.FirstSelectionIframe]:Du.concat(Re.IframeOnlyFilter,Re.FirstLevelSelector),[ys.ImageVariant]:[Re.ContentSteeringPathwayCloner,Re.MediaFilteringBasedOnImageIframes,Re.MatchingPathwayFilter],[ys.MaybeCompatibleOptions]:Du};class Nu{constructor(e,t,i,r,n){this.store=e,this.transformersCache=t,this.selection$Cache=i,this.itemId=r,this.logger=n,this._selectTransformers=e=>t=>e.map(e=>t[e]).filter(e=>e)}variantFor(e){var{transformersCache:t,_inputVariants:i}=this;return this._applyTransformers(i,this._transformers(e),t)[0]}variantsFor(e){var{transformersCache:t,_inputVariants:i}=this;return this._applyTransformers(i,this._transformers(e),t)}variantFor$(e){const{selection$Cache:t,transformersCache:i}=this;var r;return t.has(e)?t.get(e):(r=_n([this._inputVariants$,this._transformers$(e)]).pipe(ve(([e,t])=>this._applyTransformers(e,t,i)[0]),Te(),Jr()),t.set(e,r),r)}get numVariants(){return this._inputVariants.variants.length}get _inputVariants(){return this.store.getEntity(this.itemId).inputVariants}get _inputVariants$(){return this.store.inputVariantsChanged$}_transformers(e){return this._selectTransformers(xu[e])(this.store.getEntity(this.itemId).transformers)}_transformers$(e){return this.store.tranformersChanged$.pipe(this._selectTransformers$(xu[e]))}_selectTransformers$(t){return e=>e.pipe(ve(this._selectTransformers(t)),fn())}_produceVariants(e,t,i){return Cu(e,t.generation,()=>{var e=i(t.variants);return e===t.variants?t:new Gs(e)})}_applyTransformers(e,t,i){let r=e;for(const e of t){const t=r.variants,n=Cu(i,e,Nu.newTransformerCache);if(r=this._produceVariants(n,r,e.apply.bind(e)),this.Ns(`Boss transformerID: `+Re[e.id],t,r.variants,this.logger),0===r.variants.length)break}return r.variants}static newTransformerCache(){var e=new ku;return e.stats=Nu.TransformerCacheStats,e}Ns(e,t,i,r){t.filter(e=>!i.includes(e)).map(e=>e.mediaOptionId)}}Nu.TransformerCacheStats={hits:0,misses:0};class Fu{constructor(){this.inputVariantsChanged$=new Ie,this.tranformersChanged$=new Ie,this.Rs={}}getEntity(e){if(e)return this.Rs[e]}addEntity(e){this.Rs[e.itemId]=e}updateInputVariants(e,t){e=this.Rs[e];e&&(e.inputVariants=new Gs(t),this.inputVariantsChanged$.next(e.inputVariants))}updateTransformers(e,t,i){e=this.Rs[e];e&&(e.transformers[t]=i,this.tranformersChanged$.next(e.transformers))}deleteTransformers(e,t){e=this.Rs[e];e&&(delete e.transformers[t],this.tranformersChanged$.next(e.transformers))}removeEntityByID(e){delete this.Rs[e]}resetStore(){this.Rs={}}}const Bu="UNRESTRICTED",Uu={NONE:0,"TYPE-0":1,"TYPE-1":2,"TYPE-2":3,[Bu]:4},_u={0:"NONE",1:"TYPE-0",2:"TYPE-1",3:"TYPE-2",4:Bu};class Vu extends null{constructor(){}static isRestrictedLevel(e){return!(!e||e===Bu)&&e in Uu}static getNextLowerHdcpLevel(e){e=Uu[e||Bu];return _u[Math.max(0,e-1)]}static isAllowed(e,t){t=t||Bu;return t===Bu||Uu[e||"NONE"]<=Uu[t]}}class Qu{constructor(e){this.Ps=e}get name(){return this.Ps.name}get priority(){return this.Ps.priority}get expiry(){return this.Ps.expiry}filter(n,e){const a=this.Ps.initFn&&this.Ps.initFn(n,e)||(e?Object.assign({},e):{});let t=n;return this.Ps.firstPassFn&&n.forEach((e,t)=>{var i,r;return null==(r=(i=this.Ps).firstPassFn)?void 0:r.call(i,e,t,a,n)}),this.Ps.filterFn&&(t=n.filter((e,t)=>{var i,r;return null==(r=(i=this.Ps).filterFn)?void 0:r.call(i,e,t,a,n)})),this.Ps.finalFn&&this.Ps.finalFn(t,a,n),t}}function Hu(e,t,i){return(t||[]).reduce((e,t)=>t.filter(e,i),Array.from(e))}function qu(e,t){return e-t}function Ku(e){return()=>e}function ju(i){return(e,t)=>-1*i(e,t)}function $u(...r){return(e,t)=>{for(const i of r){const r=i(e,t);if(r)return r}return 0}}function Gu(n,a,{AgtB:s,AltB:o,ABgtPvt:l,ABltPvt:d,ABeqPvt:u,AeqPvt:c,BeqPvt:h}={}){return(e,t)=>{var i=n(e,a),r=n(t,a);return u&&0===i&&0===r?u(e,t):c&&0===i?c(e,t):h&&0===r?h(e,t):0<=i&&r<0||0<i&&r<=0?s?s(e,t):1:i<=0&&0<r||i<0&&0<=r?o?o(e,t):-1:0<=i&&0<=r?l?l(e,t):0:i<=0&&r<=0&&d?d(e,t):0}}const Wu={clearkey:El,fairplaystreaming:Ko,playready:jo,widevine:$o},zu={getKeySystemFormat(e){e=Wu[e];return e?e.keyFormatString:""},getKeySystemSecurityLevel(e){e=Wu[e];return e?e.securityLevels:null}},Yu=(e,t)=>{let i=!0,r=(e.videoCodec&&t.videoCodec&&(i=ge.isCompatibleVideoCodec(e.videoCodec,t.videoCodec)),!1),n=(e.videoRange&&t.videoRange?r=e.videoRange==t.videoRange:e.videoRange||t.videoRange||(r=!0),!0);return e.audioCodec&&t.audioCodec&&(n=ge.isCompatibleAudioCodec(e.audioCodec,t.audioCodec)),i&&r&&n};function Xu(e,t,i){let r;return fe(e)&&fe(t)&&(e=Math.min(e,t),r=e>i[gs.HD].maxHeight?gs.UHD:e>i[gs.SD].maxHeight?gs.HD:gs.SD),r}function Ju(e=!0){return(e||!l.MediaSource?l.ManagedMediaSource:void 0)||l.MediaSource||l.WebKitMediaSource}function Zu(e,t,i){var r=(e,t,i)=>(e-t)*(e-i)<=0;return r(e,i.minValidBitrate,i.maxValidBitrate)&&r(t,i.minValidHeight,i.maxValidHeight)}function ec(e,t,i,r,n){return e.enableAdaptiveStartup&&!!t&&fe(t.avgBandwidth)&&fe(t.avgLatencyMs)&&!!i&&fe(i.avgPlaylistLoadTimeMs)&&!!r&&fe(r.avgParseTimeMs)&&!!n&&fe(n.avgBufferCreateMs)&&fe(n.avgDataFragAppendMs)&&fe(n.avgInitFragAppendMs)}function tc(e,t,i,r,n,a){var s,o,l,d;return!ec(t,i,r,n,a)||({defaultTargetDuration:t,targetStartupMs:s}=t,r=r["avgPlaylistLoadTimeMs"],n=n["avgParseTimeMs"],{avgBufferCreateMs:a,avgInitFragAppendMs:o,avgDataFragAppendMs:l}=a,{avgBandwidth:i,avgLatencyMs:d}=i,e.bandwidth<=i&&(e.avgBandwidth||e.bandwidth)*t/i*1e3+r+a+1*(d+n+(o+l))<=s)}function ic(){const r=new Set,n=new Set,i=(e,t)=>{return i=e,t=t?"audio":"video",r.has(i)||n.has(i)||(((e,t)=>{var i=Ju();let r=i.isTypeSupported(e+`/mp4;codecs=`+t);return r="mp4a.40.34"===t?r||i.isTypeSupported(e+`/mpeg`):r})(t,i)?r:n).add(i),n.has(e);var i};return e=>{let t=!1;return!(e.audioCodecList&&(t=e.audioCodecList.some(e=>i(e,!0)))||(t=e.videoCodecList?e.videoCodecList.some(e=>i(e,!1)):t))}}function rc(e,t){for(const i in e)if(e[i].type===t)return e[i];return{}}function nc(e,t){t=zu.getKeySystemSecurityLevel(t);return null!=e&&null!=t&&void 0!==t[e]}function ac(e,t){return!fe(e)||!fe(t)||e<=t}function sc(e,t){if(!e||"number"==typeof e)return fe(e)?e:void 0;const i=fe(t),r={framerate:NaN,bitrate:NaN},n=Object.entries(e);for(const[e,a]of n){const n=r.framerate,s=parseFloat(e);fe(s)&&fe(a)&&(fe(n)?i?s>n&&s<=t&&(r.framerate=s,r.bitrate=a):s<n&&(r.framerate=s,r.bitrate=a):(r.framerate=s,r.bitrate=a))}return fe(r.bitrate)?r.bitrate:void 0}function oc(e){return e.every(e=>e.iframes)}function lc(e){return"PQ"===e.videoRange||"HLG"===e.videoRange}function dc(e,t){var i,r,n=1.35;return!(!fe(t.width)||!fe(t.height))&&(i=e.width<t.width*n,r=e.height<t.height*n,e=e.width*e.height<t.width*t.height*n,i)&&r&&e}const uc=(e=[])=>{const t=e.reduce((e,t,i,r)=>(e[t]=r.length-i,e),{});let i=-1;const r={};return e=>Object.prototype.hasOwnProperty.call(t,e)?t[e]:Object.prototype.hasOwnProperty.call(r,e)?r[e]:r[e]=i--},cc=(e,i=uc(e))=>(e,t)=>i(e.pathwayID)-i(t.pathwayID);function hc(e,{hasScore:i,pivotVariant:r,pathwayPriority:t,enableSteering:n,preferHostOverQuality:a,preferCloseToPivotQuality:s}={hasScore:!1,pivotVariant:null,pathwayPriority:null,enableSteering:!1,preferHostOverQuality:!0,preferCloseToPivotQuality:!1}){const o=(e,t)=>e.bitrate-t.bitrate,l=i?$u((e,t)=>i&&fe(e.score)&&fe(t.score)?e.score-t.score:0,ju(o)):o,d=(()=>{const t={};let i=0;if(null!=r){const i=ja(r.url);i&&(t[i]=e)}return e=>{e=ja(e.url);return null==e?-1:(Object.prototype.hasOwnProperty.call(t,e)||(t[e]=i++),t[e])}})(),u=(e,t)=>ju(qu)(d(t),d(e)),c=[];return null!=t&&n&&c.push(cc(t)),a&&c.push(u),s&&null!=r?c.push(Gu(ju(l),r,{AeqPvt:Ku(1),BeqPvt:Ku(-1),ABgtPvt:l,ABltPvt:ju(l)})):(null!=r&&c.push(Gu(l,r)),c.push(l)),a||c.push(u),null!=r&&c.push(Gu((e,t)=>null==e.audioAlternates||null==t.audioAlternates||(e.audioAlternates&&0<e.audioAlternates.length?e.audioAlternates[0].groupId:void 0)===(t.audioAlternates&&0<t.audioAlternates.length?t.audioAlternates[0].groupId:void 0)?1:-1,r)),$u(...c)}function pc(e,t){e=[...e],r=t[0];var r,i,n,a,e=e.filter(t=>{const i=performance.now();return!r||r.every(e=>e.expiry<=i||t.mediaOptionId!==e.id)});return a=t[1],e=e.filter(t=>!a||a.every(e=>t.mediaOptionId!==e)),i=e,n=t[2],e=i.filter(t=>!n||n.some(e=>e===t.mediaOptionId))}function mc(e,t,i,r){return e&&null!=(e=e.find(e=>!(0<(null==r?void 0:r.length)&&r.includes(e.mediaOptionId)||fe(t)&&e.persistentID!==t)))?e:null}function fc(e,t){var i=e.bitrate;return e.iframes?(e=e.frameRate||1,i*(t.minIframeDuration/e)):i}function gc(e){let t=0;var{avgPlaylistLoadTimeMs:e,avgLatencyMs:i}=e;return fe(e)?t=e:fe(i)&&(t=i),t}function yc(e,t,i,r,n,a,s,o){var l=n.avgBandwidth,d=t.bitrate,u=wc(i,e,r),r=d*u,t=Math.max(t.bandwidth||0,t.bitrate),c=gc(n),h=xe(n.avgLatencyMs,0)/1e3,r=r/l,l=null==i||i.liveOrEvent,p=Mc(n,!1,!1),n=Mc(n,o,l);let m=0;if(a){const t=(null==(l=null==(o=a.sbTuple[we.Variant])?void 0:o.buffered)?void 0:l.len)||0,r=i?vc(e,i,a):Ic(u,e.maxStarvationDelay);m=Math.max(0,Math.ceil((r-t)/u))}o=h+r+p,l=t/d*r,a=h+l+p;return{totalTime:h+r+n+(m=null==i||!i.liveOrEvent||i.ptsKnown&&!Sc(i.totalduration,c,s)?m:1)*o,avgTime:o,peakTotalTime:h+l+n+m*a,peakAvgTime:a}}function vc(e,t,i){var r;let n=1/0;var a=i.playingFrags[t.mediaOptionType];if(a){const{mediaSeqNum:e,part:i,partIndex:r}=a;var a=i?Oc(t.parts,e,r):Oc(t.fragments,e);n=null!=(a=null==a?void 0:a.duration)?a:1/0}var{minRequiredStartDuration:i,maxRequiredStartDuration:a,startTargetDurationFactor:e,liveAllowLowLatencyPlayback:s,minRequiredStartDurationLLHLS:o}=e,{targetduration:l,averagetargetduration:d,partTargetDuration:u}=t,e=e*Math.min(n,d,l,a,s&&fe(u)?u:1/0);let c=i;return s&&null!=(r=t.parts)&&r.length&&(c=o),Math.max(c,e)}function Ic(e,t){return fe(e)?Math.min(e,t):t}function Sc(e,t,i){return t=fe(t)?t:0,!fe(i)||performance.now()-i+t>1e3*e}function bc(e,t){t=fe(t.avgParseTimeMs)?t.avgParseTimeMs:0;return performance.now()<e?t/1e3:Math.max(0,t-(performance.now()-e))/1e3}function Tc(e,t){t=fe(t.avgDataFragAppendMs)?t.avgDataFragAppendMs:0;return performance.now()<e?t/1e3:Math.max(0,t-(performance.now()-e))/1e3}function Ac(t,i){i&&Object.keys(i).sort().forEach(e=>{e&&t.searchParams.set(e,i[e])})}function Ec(t,i,r){for(let e=0;e<t.length;e++){t[e]=Object.assign({},t[e]);var n=t[e];if(!n.url&&n.relativeUrl&&(n.url=qa(n.relativeUrl,r)),i["URI-REPLACEMENT"]["PER-RENDITION-URIS"]&&n.stableRenditionID&&i["URI-REPLACEMENT"]["PER-RENDITION-URIS"][n.stableRenditionID])n.url=i["URI-REPLACEMENT"]["PER-RENDITION-URIS"][n.stableRenditionID];else if(n.url){const t=i["URI-REPLACEMENT"].HOST,r=i["URI-REPLACEMENT"].PARAMS,a=new URL(n.url);a&&(t&&(a.host=t),r&&Ac(a,r),n.url=a.href)}n.groupId=`${n.groupId}_"${i.ID}"`,n.mediaOptionId=n.mediaOptionId+`_`+i.ID}}function Oc(e,t,i=NaN){if(null!=e&&e.length)return fe(i)?e.find(e=>e.mediaSeqNum===t&&e.partIndex===i):e[t-(null==(e=e[0])?void 0:e.mediaSeqNum)]}function wc(e,t,i){return i?null!=(i=null==e?void 0:e.partTargetDuration)?i:t.defaultPartTargetDuration:null!=(i=null==e?void 0:e.targetduration)?i:t.defaultTargetDuration}function Rc(e,t,i){return e&&t&&0<i}function Mc(t,i,e){let r=bc(1/0,t)+Tc(1/0,t);if(i){const i=t["avgInitFragAppendMs"];fe(i)&&(r+=i/1e3)}if(e){const i=t["avgPlaylistParseTimeMs"];let e=gc(t);fe(i)&&(e+=i),r+=e/1e3}return r}function Pc(e){return e?ge.isDolby(e)?xa.DOVI:ge.isHEVC(e)?xa.HEVC:ge.isVP09(e)?xa.VP09:ge.isAVC(e)?xa.AVC:xa.UNKNOWN:xa.UNKNOWN}function Cc(e){return null==e?void 0:e.substring(0,4)}function kc(e){return e?ge.isALAC(e)?Fa.ALAC:ge.isFLAC(e)?Fa.FLAC:ge.isEC3(e)?Fa.EC3:ge.isAC3(e)?Fa.AC3:ge.isXHEAAC(e)?Fa.XHEAAC:ge.isAAC(e)?Fa.AAC:ge.isMP3(e)?Fa.MP3:Fa.UNKNOWN:Fa.UNKNOWN}function Lc(e){return"PQ"===e?Na.PQ:"HLG"===e?Na.HLG:"SDR"===e?Na.SDR:Na.UNKNOWN}class Dc{constructor(...e){this._s=e}ensureSameIdentifierLength(e){if(this._s.length!==e._s.length)throw new me(!1,pe.RankIdentifierComparisonError,`Identifiers have non-matching lengths! (${this._s.length} vs ${e._s.length})`)}isGreaterThan(t){this.ensureSameIdentifierLength(t);for(let e=0;e<this._s.length;++e){if(this._s[e]<t._s[e])return!1;if(this._s[e]>t._s[e])return!0}return!1}isEqualTo(i){return this.ensureSameIdentifierLength(i),this._s.every((e,t)=>e===i._s[t])}}class xc{apply(i){let r,e=i;return this.initFn&&(r=this.initFn(i)),this.firstPassFn&&i.forEach((e,t)=>this.firstPassFn(e,t,i,r)),this.filterFn&&(e=i.filter((e,t)=>this.filterFn(e,t,i,r))),this.finalFn&&this.finalFn(e,i,r),e.length===i.length?i:e}}(bs=lu=lu||{})[bs.SelectMinimum=0]="SelectMinimum",bs[bs.SelectMaximum=1]="SelectMaximum";class Nc extends xc{constructor(e){super(),this.removed=e,this.id=Re.PermanentRemovalFilter,this.filterFn=(t,e,i)=>!this.removed||this.removed.every(e=>t.mediaOptionId!==e)}}class Fc extends xc{constructor(e){super(),this.compatibleIds=e,this.id=Re.CompatibleIdsFilter,this.filterFn=(t,e,i)=>!this.compatibleIds||this.compatibleIds.some(e=>e===t.mediaOptionId)}}class Bc extends xc{constructor(e){super(),this.penaltyBoxInfo=e,this.id=Re.PenaltyBoxFilter,this.filterFn=(t,e,i)=>{const r=performance.now();return!this.penaltyBoxInfo||this.penaltyBoxInfo.every(e=>e.expiry<=r||t.mediaOptionId!==e.id)}}}class Uc extends xc{constructor(e){super(),this.pathwayPenaltyBox=e,this.id=Re.PathwayPenaltyBoxFilter,this.filterFn=(t,e,i)=>{const r=performance.now();return!this.pathwayPenaltyBox||this.pathwayPenaltyBox.every(e=>e.expiry<=r||t.pathwayID!==e.id)}}}class _c extends xc{constructor(e,t){super(),this.hasHdrLevels=e,this.preferHDR=t,this.id=Re.HDRFilter,this.filterFn=(e,t,i)=>(this.hasHdrLevels&&this.preferHDR)===lc(e)}}class Vc extends xc{constructor(e){super(),this.viewportInfo=e,this.id=Re.ViewportFilter,this.initFn=e=>{let t=NaN;for(const i of e)i&&!i.iframes&&i.videoCodec&&(t=!t||i.bitrate<t?i.bitrate:t);return{lowestBitrate:t}},this.filterFn=(e,t,i,r)=>!(e&&r&&this.viewportInfo&&e.videoCodec&&r.lowestBitrate)||dc({width:e.width,height:e.height},this.viewportInfo)||e.bitrate===r.lowestBitrate}}class Qc extends xc{constructor(e,t){super(),this.Cs=e,this.xs=t,this.id=Re.ResolutionTierFilter,this.filterFn=e=>Xu(e.width,e.height,this.xs)===this.Cs}}class Hc extends xc{constructor(e){super(),this.maxHdcpLevel=e,this.id=Re.HDCPFilter,this.filterFn=(e,t,i)=>!Vu.isRestrictedLevel(this.maxHdcpLevel)||Vu.isAllowed(e.hdcpLevel,this.maxHdcpLevel)}}class qc extends xc{constructor(e,t){super(),this.enabledUrl=e,this.baseUrl=t,this.id=Re.HostRankFilter,this.initFn=e=>this.Ds(this.enabledUrl),this.Ds=e=>Ha(e)?ja(e):ja(this.baseUrl),this.filterFn=(e,t,i,r)=>{var n;return this.Ds(null!=(n=e.url)?n:e.relativeUrl)===r}}}class Kc extends xc{constructor(e,t,i=!1,r=null){super(),this.fromVariant=e,this.shouldSwitchHosts=t,this.shouldDownswitch=i,this.excludingOptions=r,this.id=Re.ValidFallbackFilter,this.filterFn=(e,t,i)=>this.Ls(e)}Ls(t){var e=!(t.iframes!==this.fromVariant.iframes||this.shouldSwitchHosts&&za(this.fromVariant,t)),i=this.shouldDownswitch?t.bitrate<this.fromVariant.bitrate:t.bitrate<=this.fromVariant.bitrate;return e&&i&&!(null!=(e=this.excludingOptions)&&e.some(e=>e===t.mediaOptionId))}}class jc extends xc{constructor(){super(...arguments),this.id=Re.MediaFilteringBasedOnImageIframes,this.filterFn=(e,t,i)=>e.iframes&&!!e.imageCodec}}class $c{constructor(e=lu.SelectMinimum){this.rule=e}apply(e){const t=this.makeComparator(e),i=[...e],r=i.splice(0,1);for(const e of i){const i=t(e,r[0]);0===i&&r.push(e),(this.rule===lu.SelectMinimum&&i<0||this.rule===lu.SelectMaximum&&0<i)&&r.splice(0,r.length,e)}return r.length===e.length?e:r}}(n=du=du||{})[n.SelectLowerQuality=0]="SelectLowerQuality",n[n.SelectHigherQuality=1]="SelectHigherQuality";class Gc extends $c{constructor(e=du.SelectHigherQuality){super(e===du.SelectHigherQuality?lu.SelectMaximum:lu.SelectMinimum),this.qualityRule=e,this.id=Re.QualitySelector}makeComparator(e){const i=e.every(e=>null!=e.score),t=(e,t)=>e.bitrate-t.bitrate;return i?$u((e,t)=>i&&fe(e.score)&&fe(t.score)?e.score-t.score:0,ju(t)):t}}class Wc extends xc{constructor(e,t){super(),this.minBitrate=e,this.maxBitrate=t,this.id=Re.BitrateFilter,this.filterFn=(e,t,i)=>e.bitrate>=this.minBitrate&&e.bitrate<=this.maxBitrate}}const zc=(e,t)=>e===t?0:t<e?1:-1;class Yc extends $c{constructor(e,t,i,r,n,a=du.SelectHigherQuality){super(a===du.SelectHigherQuality?lu.SelectMaximum:lu.SelectMinimum),this.config=e,this.bandwidthHistory=t,this.playlistEstimate=i,this.fragEstimate=r,this.bufferEstimate=n,this.qualityRule=a,this.id=Re.FirstLevelSelector}makeComparator(e){const r=ec(this.config,this.bandwidthHistory,this.playlistEstimate,this.fragEstimate,this.bufferEstimate),i=e.every(e=>null!=e.score),t=(e,t)=>e.bitrate-t.bitrate,n=(e,t)=>{return r?(e=tc(e,this.config,this.bandwidthHistory,this.playlistEstimate,this.fragEstimate,this.bufferEstimate)?1:0,t=tc(t,this.config,this.bandwidthHistory,this.playlistEstimate,this.fragEstimate,this.bufferEstimate)?1:0,zc(e,t)):0};return i?$u(n,(e,t)=>i&&fe(e.score)&&fe(t.score)?e.score-t.score:0,ju(t)):$u((e,t)=>{return r?0:(e=Zu(e.bitrate,e.height,this.config.heuristicStartupRestrictions),t=Zu(t.bitrate,t.height,this.config.heuristicStartupRestrictions),zc(e,t))},(e,t)=>{e=Lc(e.videoRange),t=Lc(t.videoRange);return zc(e,t)},(e,t)=>{e=Pc(e.videoCodec),t=Pc(t.videoCodec);return zc(e,t)},(e,t)=>{e=e.audioChannelCount||1,t=t.audioChannelCount||1;return zc(e,t)},(e,t)=>{e=kc(e.audioCodec),t=kc(t.audioCodec);return zc(e,t)},n,(e,t)=>{var i;return r?0:(i=this.config.heuristicStartupRestrictions["maxPreferredBitrate"],e=e.bitrate<i,t=t.bitrate<i,zc(e,t))},(e,t)=>{e=e.height,t=t.height;return zc(e,t)},t)}}class Xc extends xc{constructor(){super(...arguments),this.id=Re.SdrOnlyFilter,this.filterFn=(e,t,i)=>!1===lc(e)}}class Jc extends $c{constructor(e,t=du.SelectHigherQuality){super(t===du.SelectHigherQuality?lu.SelectMaximum:lu.SelectMinimum),this.criteria=e,this.qualityRule=t,this.id=Re.FallbackSelector}makeComparator(e){return hc(e.length,this.criteria)}}class Zc extends xc{constructor(e,t,i,r,n,a,s,o){super(),this.currentAudioIsAtmos=e,this.altAudioFilterParams=t,this.subtitleFilterParams=i,this.audioPersistentId=r,this.subtitlePersistentId=n,this.mediaOptionMask=a,this.excludingOptions=s,this.switchingAudioLanguage=o,this.id=Re.ValidAlternatesFilter,this.filterFn=(t,e,i)=>{var r,n=pc(null!=(n=t.subtitleAlternates)?n:[],this.subtitleFilterParams);let a=pc(null!=(s=t.audioAlternates)?s:[],this.altAudioFilterParams);this.switchingAudioLanguage||null==this.currentAudioIsAtmos||(a=(s=a,r=this.currentAudioIsAtmos,0===(o=s.filter(e=>!!e.channels&&r===ge.isJOCChannels(e.channels))).length&&r?s:o));{var[s,o,t,l,d,u=[]]=[t,this.audioPersistentId,this.subtitlePersistentId,a,this.mediaOptionMask,this.excludingOptions];let e=!1;var c,h,l=function(e,t,i,r,n){e=fe(i)?mc(e,i,0,n):void 0,i=fe(r)?mc(t,r,0,n):void 0;return[e||Me,i||Me]}(l,n,o,t,u);return c=[s,...l],h=d,e=[we.Variant,we.AltAudio,we.Subtitle].reduce((e,t)=>e&&h[t]===Bs(c[t]),!0)?!0:e}}}}class eh extends xc{constructor(e){super(),this.iframeMode=e,this.id=Re.MediaFilterBasedOnMode,this.filterFn=(e,t,i)=>e.iframes===this.iframeMode}}class th extends xc{constructor(e){super(),this.currentPathwayID=e,this.id=Re.MatchingPathwayFilter,this.filterFn=(e,t,i)=>Wa(e.pathwayID,this.currentPathwayID)}}class ih extends class{apply(e){var t=this.getNewVariants(e);return 0===t.length?e:t.concat(e)}}{constructor(e,t,i){super(),this.pathwayClones=e,this.mvpUrl=t,this.clonedPathwayMapping=i,this.id=Re.ContentSteeringPathwayCloner}Fs(t){const i=new Map;let r,e,n=!1;if(this.pathwayClones.forEach(e=>{i.has(e["BASE-ID"])||t.has(e["BASE-ID"])||(n=!0),i.set(e.ID,e),r?r.push([e["BASE-ID"],e.ID]):r=[[e["BASE-ID"],e.ID]]}),n){try{e=te(r)}catch(t){return}this.pathwayClones=[],e.forEach(e=>{i.has(e)&&this.pathwayClones.push(i.get(e))})}}getNewVariants(t){var i;const r=new Map;t.forEach(e=>{r.has(e.pathwayID)?r.get(e.pathwayID).push(e):r.set(e.pathwayID,[e])}),this.Fs(r);for(let e=0;e<this.pathwayClones.length;e++){const n=this.pathwayClones[e],a=[],s=n["BASE-ID"];if(!r.has(n.ID)&&!this.clonedPathwayMapping.has(n.ID)&&(r.has(s)||this.clonedPathwayMapping.has(s))){const t=null!=(i=r.get(s))?i:this.clonedPathwayMapping.get(s),o=new Map,l=new Map;t.forEach(e=>{var t=Object.assign({},e);if(t.mediaOptionId=t.mediaOptionId+`_`+n.ID,a.push(t),t.pathwayID=n.ID,!t.url&&t.relativeUrl&&(t.url=qa(t.relativeUrl,this.mvpUrl)),t.url){var i=new URL(t.url);if(n["URI-REPLACEMENT"].HOST&&(i.hostname=n["URI-REPLACEMENT"].HOST),n["URI-REPLACEMENT"].PARAMS&&Ac(i,n["URI-REPLACEMENT"].PARAMS),n["URI-REPLACEMENT"]["PER-VARIANT-URIS"]&&e.stableVariantID&&n["URI-REPLACEMENT"]["PER-VARIANT-URIS"][e.stableVariantID]?t.url=n["URI-REPLACEMENT"]["PER-VARIANT-URIS"][e.stableVariantID]:t.url=i.href,t.audioAlternates&&0<t.audioAlternates.length){const e=`${t.audioAlternates.find(e=>!!e).groupId}_"${n.ID}"`;if(o.has(e))t.audioAlternates=o.get(e);else{const e=[...t.audioAlternates];Ec(e,n,this.mvpUrl),t.audioAlternates=e;i=t.audioAlternates.find(e=>!!e).groupId;o.set(i,t.audioAlternates)}}if(t.subtitleAlternates&&0<t.subtitleAlternates.length){const e=`${t.subtitleAlternates.find(e=>!!e).groupId}_"${n.ID}"`;if(l.has(e))t.subtitleAlternates=l.get(e);else{const e=[...t.subtitleAlternates];Ec(e,n,this.mvpUrl),t.subtitleAlternates=e;i=t.subtitleAlternates.find(e=>!!e).groupId;l.set(i,t.subtitleAlternates)}}t.closedcaption&&(t.closedcaption=`${t.closedcaption}_"${n.ID}"`)}}),this.clonedPathwayMapping.set(n.ID,a)}}let n=[];for(const[t,i]of this.clonedPathwayMapping)n=n.concat(i);return n}}class rh{constructor(e){this.Me=e,this.js={[Re.LowerQualitySelector]:new Gc(du.SelectLowerQuality),[Re.HigherQualitySelector]:new Gc(du.SelectHigherQuality),[Re.SdrOnlyFilter]:new Xc,[Re.NonIframeOnlyFilter]:new eh(!1),[Re.IframeOnlyFilter]:new eh(!0),[Re.MediaFilteringBasedOnImageIframes]:new jc},this.Bs=new Map,this.transformersCache=new Map,this.selection$Cache=new Map}getQuery(e,t){return this.transformersCache.has(e)||this.transformersCache.set(e,new WeakMap),this.selection$Cache.has(e)||this.selection$Cache.set(e,new ku),this.Bs.has(e)?this.Bs.get(e):(t=new Nu(this.Me,this.transformersCache.get(e),this.selection$Cache.get(e),e,t),this.Bs.set(e,t),t)}setVariants(e,t){this._addEmptyEntity(e),this.Me.updateInputVariants(e,t)}setTransformer(e,t,i){this._addEmptyEntity(e),this.Me.updateTransformers(e,t,i)}setMultipleTransformers(e,t){for(var[i,r]of t)this.setTransformer(e,i,r)}removeTransformer(e,t){this._addEmptyEntity(e),this.Me.deleteTransformers(e,t)}destroyItems(e){e.forEach(this.destroyItem.bind(this))}destroyItem(e){this.transformersCache.delete(e),this.selection$Cache.delete(e),this.Me.removeEntityByID(e),this.Bs.delete(e)}endItem(){this.transformersCache.clear(),this.selection$Cache.clear(),this.Bs.clear(),this.Me.resetStore()}destroy(){this.transformersCache.clear(),this.selection$Cache.clear(),this.Bs.clear(),this.Me.resetStore()}_addEmptyEntity(e){this.Me.getEntity(e)||this.Me.addEntity({itemId:e,inputVariants:new Gs([]),transformers:Object.assign({},this.js)})}}const nh={timeRangesToBufferedRange(t){var i=[];for(let e=0;t&&e<t.length;e++)i.push({start:t.start(e),end:t.end(e)});return i},getBufferedInfo(e,t,i){let r,n,a,s,o;var l=this.getBufferedTimeRanges(e,i),d=Math.max(i,.001);for(o=0,r=0,n=a=t;o<l.length;o++){const{start:e,end:i}=l[o];if(t+d>=e&&t<i)n=e,a=i,r=a-t;else if(t+d<e){s=e;break}}return{len:r,start:n,end:a,nextStart:s}},getBufferedTimeRanges(e,t){var i=[],r=e.map(({start:e,end:t})=>({start:e,end:t}));r.sort((e,t)=>e.start-t.start||t.end-e.end);for(let e=0;e<r.length;e++){var n,a=i.length;a&&(n=i[a-1].end,r[e].start-n<=t)?r[e].end>n&&(i[a-1].end=r[e].end):i.push(r[e])}return i},isTimeRangeContainedInRanges(t,i,r=.25){for(let e=0;e<t.length;e++)if(i.start>=t[e].start-r&&i.end<=t[e].end+r)return!0;return!1}};function ah(e,i){return null==e&&null==i||null!=e&&null!=i&&e.combined===i.combined&&e.sbTuple.every((e,t)=>e===i.sbTuple[t])}function sh(e){return`${e.itemId}|${e.mediaOptionId}|${e.mediaSeqNum}|`+e.discoSeqNum+(e.partIndex?`|`+e.partIndex:"")}function oh(e){return null!=e&&"iframeMediaDuration"in e&&"iframeMediaStart"in e}function lh(e,t){return e===t||e&&t&&e.itemId===t.itemId&&e.mediaOptionId===t.mediaOptionId&&e.mediaSeqNum===t.mediaSeqNum&&e.discoSeqNum===t.discoSeqNum&&(!e.part&&!t.part||e.part===t.part&&e.partIndex===t.partIndex)}function dh(e,t){return e===t||e&&t&&e.itemId===t.itemId&&e.mediaOptionId===t.mediaOptionId&&e.mediaSeqNum===t.mediaSeqNum&&e.discoSeqNum===t.discoSeqNum}function uh(e,t){return t&&e&&t.part&&!e.part&&t.itemId===e.itemId&&t.mediaOptionId===e.mediaOptionId&&t.mediaSeqNum===e.mediaSeqNum}function ch(e){if(!e)return"";let t=["mediaOptionId","mediaSeqNum","discoSeqNum","start","duration"];return null!=e&&e.part&&(t=[...t,"part","partIndex"]),JSON.stringify(e,t)}function hh(e){var{itemId:e,mediaOptionId:t,discoSeqNum:i,keyTagInfo:r}=e;return{itemId:e,mediaOptionId:t,discoSeqNum:i,keyId:I.hexDump(null==r?void 0:r.keyId)}}function ph(e,i){return null==e||e.length!==i.length||e.some((e,t)=>e.start!==i[t].start||e.end!==i[t].end)}(t=uu=uu||{}).Seek="Seek",t.HighBuffer="HighBuffer",t.LowBuffer="LowBuffer",t.BufferHole="BufferHole",(Ts=cu=cu||{})[Ts.AlmostDry=0]="AlmostDry",Ts[Ts.LowWater=1]="LowWater",Ts[Ts.HighWater=2]="HighWater",Ts[Ts.AboveHighWater=3]="AboveHighWater";class mh extends ua{constructor(){super({},{name:"media-element-store"}),this.Us=new ga(this),this.$s=""}get activeId(){return this.$s}startMediaSession(i,r,n,a){return this.$s=`media session: `+(new Date).toISOString(),Oe(()=>{var e=a,t=Math.max(e,r-e),e={id:this.activeId,desiredRate:!i.autoplay&&i.paused?0:1,paused:i.paused,gotPlaying:!1,seeking:i.seeking,seekTo:null,flushing:!1,readyState:i.readyState,ended:i.ended,bufferedRanges:[],contentGapRanges:[],haveEnough:!1,stopStreaming:!1,mediaSourceEntity:null,expectSeekingEvent:!1,expectedSbCount:NaN,bufferMonitorInfo:{waterLevelType:null,almostDryWaterLevelSeconds:n,lowWaterLevelSeconds:e,highWaterLevelSeconds:t,maxBufferSeconds:r},mediaOptionParsedSubtitleRecord:{},textTracksCreated:!1,waitingForDisco:!1};this.add(e),this.setActive(this.activeId)}),this.activeId}Vs(e,t,i){var r=this.Us.getActive(),n=null==r?void 0:r.mediaSourceEntity;if(r&&n)return(r={}).mediaSourceEntity=Object.assign(Object.assign({},n),{sourceBufferEntities:n.sourceBufferEntities?[...n.sourceBufferEntities]:[null,null]}),(n=null!=(n=r.mediaSourceEntity.sourceBufferEntities[e])?n:i)?(r.mediaSourceEntity.sourceBufferEntities[e]=Object.assign(Object.assign({},n),t),r):void 0}qs(e,t,i){e=this.Vs(e,t,i);e&&this.updateActive(e)}setMediaSourceEntity(e,t){var i=this.Us.getActive();i&&this.updateActive({mediaSourceEntity:null!=e&&null!=t?{objectUrl:e,readyState:t,duration:NaN,sourceBufferEntities:[null,null]}:null,bufferedRanges:[],haveEnough:!1,stopStreaming:!1,expectSeekingEvent:!1,readyState:0,bufferMonitorInfo:Object.assign(Object.assign({},i.bufferMonitorInfo),{waterLevelType:null}),seeking:!1})}set mediaElementDuration(e){var t=this.Us.getActive(),i=null==t?void 0:t.mediaElementDuration;t&&i!==e&&this.updateActive({mediaElementDuration:e})}set primaryContentMediaElementDuration(e){var t=this.Us.getActive(),i=null==t?void 0:t.primaryContentMediaElementDuration;t&&i!==e&&(!fe(i)||0<e&&i<e)&&this.updateActive({primaryContentMediaElementDuration:e})}set msReadyState(e){var t=this.Us.getActive(),i=null==(i=null==t?void 0:t.mediaSourceEntity)?void 0:i.readyState;t&&i!==e&&this.updateActive({mediaSourceEntity:Object.assign(Object.assign({},t.mediaSourceEntity),{readyState:e})})}set readyState(e){var t,i=this.Us.getActive();i&&(null==i?void 0:i.readyState)!==e&&(t={readyState:e},e>=HTMLMediaElement.HAVE_METADATA&&(t.expectSeekingEvent=null!=i.seekTo),this.updateActive(t))}set ended(e){var t=this.Us.getActive(),i=null==t?void 0:t.ended;t&&i!==e&&this.updateActive({ended:e})}set msDuration(e){var t=this.Us.getActive(),i=null==(i=null==t?void 0:t.mediaSourceEntity)?void 0:i.duration;t&&i!==e&&this.updateActive({mediaSourceEntity:Object.assign(Object.assign({},t.mediaSourceEntity),{duration:e})})}set textTracksCreated(e){var t=this.Us.getActive(),i=null==t?void 0:t.textTracksCreated;t&&i!==e&&this.updateActive({textTracksCreated:e})}set expectedSbCount(e){var t=this.Us.getActive(),i=null==t?void 0:t.expectedSbCount;t&&i!==e&&this.updateActive({expectedSbCount:e})}setSeekToPos(e,t=!1,i,r,n){var a,s=this.Us.getActive();s&&(a={},fe(e)?(a.seekTo={pos:e,fromEvent:t,discoSeqNum:i,inContentGap:r,startPos:n},a.gotPlaying=!1,a.haveEnough=!1,a.stopStreaming=!1,a.expectSeekingEvent=s.readyState>=HTMLMediaElement.HAVE_METADATA):a.seekTo=null,t&&(a.seeking=fe(e),a.stopStreaming=!1,a.expectSeekingEvent=!1),this.updateActive(a))}setLiveSeekableRange(e){this.updateActive({liveSeekableRange:e})}set seeking(e){this.updateActive({seeking:e,expectSeekingEvent:!1})}set paused(e){var t={paused:e};(t.paused=e)&&(t.gotPlaying=!1),this.updateActive(t)}gotPlayingEvent(){var e=this.Us.getActive();!e||e.gotPlaying||e.paused||this.updateActive({gotPlaying:!0})}set desiredRate(e){this.updateActive({desiredRate:e})}set haveEnough(e){var t;(null==(t=this.Us.getActive())?void 0:t.haveEnough)!==e&&this.updateActive({haveEnough:e})}set stopStreaming(e){var t;(null==(t=new ga(this).getActive())?void 0:t.stopStreaming)!==e&&this.updateActive({stopStreaming:e})}set flushing(e){var t;!(null==(t=this.Us.getActive())||!t.flushing)!=!!e&&this.updateActive({flushing:e})}set waitingForDisco(e){var t;!(null==(t=this.Us.getActive())||!t.waitingForDisco)!=!!e&&this.updateActive({waitingForDisco:e})}setSourceBufferUpdating(e,t){var i=this.Us.getActive();null!=(i=null==(i=null==i?void 0:i.mediaSourceEntity)?void 0:i.sourceBufferEntities)&&i[e]&&this.qs(e,{updating:t})}setTimestampOffset(e,t){var i=this.Us.getActive(),i=null==(i=null==(i=null==i?void 0:i.mediaSourceEntity)?void 0:i.sourceBufferEntities)?void 0:i[e];i&&i.timestampOffset!==t&&this.qs(e,{timestampOffset:t})}setBufferedRangesUpdated(e,t,a,s,o,l){var i=this.Us.getActive();if(i){var r=null==(r=null==(r=i.mediaSourceEntity)?void 0:r.sourceBufferEntities)?void 0:r[e],n=null==r?void 0:r.bufferedRanges,d=i.bufferedRanges,n=s||ph(n,t),d=s||ph(d,a),u=l&&null!=(null==r?void 0:r.inFlight);if(null!=r&&r.updating||n||d||u){var r={},u=null==(u=null==(u=i.mediaSourceEntity)?void 0:u.sourceBufferEntities)?void 0:u[e];if(u){r.mediaSourceEntity=Object.assign(Object.assign({},i.mediaSourceEntity),{sourceBufferEntities:[...i.mediaSourceEntity.sourceBufferEntities]});const a=Object.assign({},u);a.updating=!1,(n||l)&&(a.bufferedRanges=[...t],a.bufferedSegments=[...u.bufferedSegments]),l&&(s?a.inFlight=null:(i=a,n=o,t=i.inFlight,u=i.bufferedSegments,t&&fe(t.startPTS)&&fe(t.endPTS)&&function(i,r,n){if(0===i.length||i[0].startPTS>=r.endPTS)return i.splice(0,0,r);let a=!1;for(let t=i.length-1;-1<t;t--){let e=i[t];var s=e.endPTS-e.startPTS,o=Math.max(r.startPTS,e.startPTS),l=Math.min(r.endPTS,e.endPTS),d=l-o;l<o||d<=n||((d=(1-d/s)*e.bytes)<=0?(!e.evicting&&lh(e.frag,r.frag)&&(r.rebuffered=!0),i.splice(t,1)):((e=Object.isFrozen(e)?i[t]=Object.assign({},e):e).bytes=d,e.startPTS<r.startPTS?e.endPTS=o:(e.startPTS=l,a||(i.splice(t,0,r),a=!0))))}if(!a){let e=i.length-1;for(;0<e&&i[e].startPTS>r.startPTS;)e--;i.splice(e+1,0,r)}}(u,t,n),i.inFlight=null));{var c=a;l=s;var h=o;const p=c.bufferedSegments,m=nh.getBufferedTimeRanges(c.bufferedRanges,h);let i,r=0,n=!1;if(m.length)for(let e=p.length-1;-1<e;e--){let t=p[e];(t=Object.isFrozen(t)?p[e]=Object.assign({},t):t).partialFrag&&!t.evicting&&(t.evicting=!0);const h=!t.frag.iframe,f=(h&&t.frag.isLastFragment&&e===p.length-1&&(i=t.frag),t.endPTS-t.startPTS),g=function(e,t){var i=t.endPTS-t.startPTS,r=function(e,t){let i,r=0;for(const s of e)if(s.start<=t.endPTS&&s.end>t.startPTS){n=t,a=s;const e=Math.min(n.endPTS,a.end)-Math.max(n.startPTS,a.start);e>r&&(i=s,r=e)}else if(0<r)break;var n,a;return i}(e,t);if(r){const e=Math.max(r.start,t.startPTS),n=Math.min(r.end,t.endPTS),a=n-e;return{overlapStart:e,overlapEnd:n,appendedDuration:a,appendedBytes:t.bytes*a/i}}}(m,t);if(g){const{overlapStart:c,overlapEnd:p,appendedDuration:m,appendedBytes:e}=g;r+=e,h&&(m<f&&fe(t.appendStart)&&fe(t.appendEnd)&&(t.appendStart<c||t.appendEnd>p)&&(t.evicting=!0),t.appendStart=c,t.appendEnd=p)}else p.splice(e,1),n=t.frag===i}else p.length&&p.splice(0,p.length);c.totalDuration=i&&!n&&0<m.length?m[m.length-1].end:1/0,c.gotQuotaExceeded=c.gotQuotaExceeded||l,c.totalBytes=r,c.maxTotalBytes=Math.max(c.totalBytes,c.maxTotalBytes)}r.mediaSourceEntity.sourceBufferEntities[e]=a}d&&(r.bufferedRanges=[...a]),this.updateActive(r)}}}updateContentGapRanges(e){this.updateActive({contentGapRanges:e})}updateSourceBufferEntity(e,t){var{mimeType:t,audioCodec:i,videoCodec:r}=t;this.qs(e,{mimeType:t,audioCodec:i,videoCodec:r,initSegmentInfo:null})}setSourceBufferEntity(e,t){var{mimeType:t,audioCodec:i,videoCodec:r}=t;this.qs(e,{},{mimeType:t,audioCodec:i,videoCodec:r,updating:!1,bufferedRanges:[],timestampOffset:0,inFlight:null,bufferedSegments:[],totalBytes:0,maxTotalBytes:0,gotQuotaExceeded:!1,totalDuration:1/0})}setInflightSegment(e,t){this.qs(e,{inFlight:t})}updateInFlightRange(e,t){var i=this.Us.getActive(),r=null==(r=null==i?void 0:i.inFlightRanges)?void 0:r[e];!i||null==r&&null==t||null!=r&&null!=t&&r.start===t.start&&r.end===t.end||((r=i.inFlightRanges?[...i.inFlightRanges]:[null,null])[e]=t,this.updateActive({inFlightRanges:r}))}setInitSegmentEntity(e,t){this.qs(e,{initSegmentInfo:t})}setStallInfo(e){var t=this.Us.getActive(),i=null==t?void 0:t.stallInfo;t&&(null==i?void 0:i.currentTime)!==(null==e?void 0:e.currentTime)&&this.updateActive({stallInfo:e})}setNudgeInfo(e){this.updateActive({nudgeInfo:e})}updateWaterLevels(e,t){var i=this.Us.getActive(),r=null==(r=null==i?void 0:i.bufferMonitorInfo)?void 0:r.waterLevelType;i&&!ah(r,{combined:e,sbTuple:t})&&this.updateActive({bufferMonitorInfo:Object.assign(Object.assign({},i.bufferMonitorInfo),{waterLevelType:{combined:e,sbTuple:[...t]}})})}set bufferMonitorTargetDuration(e){var t,i,r,n,a=this.Us.getActive();!a||!fe(e)||e<=0||({maxBufferSeconds:n,lowWaterLevelSeconds:t,highWaterLevelSeconds:i}=a.bufferMonitorInfo,r=Math.min(e,n),n=Math.max(r,n-e),r===t&&n===i)||this.updateActive({bufferMonitorInfo:Object.assign(Object.assign({},a.bufferMonitorInfo),{lowWaterLevelSeconds:r,highWaterLevelSeconds:n})})}archiveParsedSubtitleFragmentRecord(e,t,i){var r,n=this.Us.getActive();n&&((r=(r=(n={mediaOptionParsedSubtitleRecord:Object.assign({},n.mediaOptionParsedSubtitleRecord)}).mediaOptionParsedSubtitleRecord[e])?Object.assign({},r):{})[t]=i,n.mediaOptionParsedSubtitleRecord[e]=r,this.updateActive(n))}clearAllParsedSubtitleFragmentRecord(){var e=null==(e=this.Us.getActive())?void 0:e.mediaOptionParsedSubtitleRecord;e&&0===Object.keys(e).length||this.updateActive({mediaOptionParsedSubtitleRecord:{}})}clearParsedSubtitleFragmentRecord(e){var t,i=this.Us.getActive();i&&null!=(t=i.mediaOptionParsedSubtitleRecord)&&t[e]&&(delete(t=Object.assign({},i.mediaOptionParsedSubtitleRecord))[e],this.updateActive({mediaOptionParsedSubtitleRecord:t}))}removeOldSubtitleFragmentRecord(t){const i=this.Us.getActive();if(i){const n={mediaOptionParsedSubtitleRecord:{}};for(const a of Object.keys(i.mediaOptionParsedSubtitleRecord)){let e;var r=i.mediaOptionParsedSubtitleRecord[a];for(const i of Object.keys(r)){const n=Number(i),s=r[n];s.endTime>t&&((e=e||{})[n]=s)}null!=e&&(n.mediaOptionParsedSubtitleRecord[a]=e)}this.updateActive(n)}}removeLaterSubtitleFragmentRecord(t){const i=this.Us.getActive();if(i){const n={mediaOptionParsedSubtitleRecord:{}};for(const a of Object.keys(i.mediaOptionParsedSubtitleRecord)){let e;var r=i.mediaOptionParsedSubtitleRecord[a];for(const i of Object.keys(r)){const n=Number(i),s=r[n];s.startTime<t&&((e=e||{})[n]=s)}e&&(n.mediaOptionParsedSubtitleRecord[a]=e)}this.updateActive(n)}}}function Le(e,t=0){e=xe(null==e?void 0:e.itemStartOffsets[we.Variant],0);return Math.max(e-t,0)}function fh(e){return fe(e)&&0!==e&&1!==e}function gh(e){return fe(e)&&(0===e||1===e)}class yh extends Error{}class vh{constructor(e){this.value=e,this.zs=[],this.Hs=0,this.Qs=0}lock(e,t=!1){return this.Ks(!0,e,t)}unlock(){this.Ws(!0)}readLock(e,t=!1){return this.Ks(!1,e,t)}readUnlock(){this.Ws(!1)}Gs(){const t=[];this.zs=this.zs.filter(e=>!this.Xs(e.rw)||(e.rw?++this.Hs:++this.Qs,t.push(e),!1));for(const e of t)e.observer.next(this.value),e.observer.complete()}Xs(e){return e&&0===this.Hs&&0===this.Qs||!e&&0===this.Hs}Ks(s,o,i=!1){"boolean"==typeof o&&([i,o]=[o,void 0]);var e=new F(e=>{var t=this.Xs(s);if(i&&!t)throw new yh;t?(s?++this.Hs:++this.Qs,e.next(),e.complete()):this.zs.push({rw:s,observer:e})});return o?e.pipe(Er(()=>{{var i=this.value,r=e=>{this.value=e},n=()=>this.Ws(s),a=o;if(!a)return be(i);let e,t;try{e=a(i,r)}catch(i){t=Fr(()=>i)}return(t=t||(void 0===e?be(i):yr(e))).pipe(Hr(n))}})):e}Ws(e){e?this.Hs=Math.max(this.Hs-1,0):this.Qs=Math.max(this.Qs-1,0),this.Gs()}}class Ih extends F{constructor(){super(e=>this.Ys.pipe(Ur(e=>0===e),Dr(1),xr(void 0)).subscribe(e)),this.Ys=new jr(0)}wrap(e){return Mn(()=>(this.add(),yr(e))).pipe(Ee({error:e=>this.Ys.error(e)}),Hr(()=>this.done()))}add(e=1){this.Ys.next(this.Ys.value+e)}done(e=1){this.Ys.next(this.Ys.value-e)}}function Sh(t,e){return[{threshold:e.highWaterLevelSeconds,level:cu.HighWater},{threshold:e.lowWaterLevelSeconds,level:cu.LowWater},{threshold:e.almostDryWaterLevelSeconds,level:cu.AlmostDry}].find(({threshold:e})=>e<t)}function bh(t,e){return[{threshold:e.almostDryWaterLevelSeconds,level:cu.AlmostDry},{threshold:e.lowWaterLevelSeconds,level:cu.LowWater},{threshold:e.highWaterLevelSeconds,level:cu.HighWater},{threshold:1/0,level:cu.AboveHighWater}].find(({threshold:e})=>t<=e)}function Th(t,i){const r=[null,null];return[B.Variant,B.AltAudio].forEach(e=>{null!=t.sourceBufferEntityByType(e)&&(r[e]=bh(t.getCurrentWaterLevelByType(e,i),t.bufferMonitorInfo).level)}),{combined:bh(t.getCurrentWaterLevel(i),t.bufferMonitorInfo).level,sbTuple:r}}function Ah(i,r){return br([i.combinedBuffer$,i.seeking$]).pipe(Ae(()=>ol(i.updating$,e=>!e)),pr(Zi),ve(()=>i.getCurrentWaterLevel(r)),Te(),Ae(e=>{var t=be(Th(i,r));return 0===e?t:t.pipe(Qr(()=>br([i.paused$,i.stallInfo$]).pipe(ve(([e,t])=>!e&&null==t),Te(),Ae(e=>e?function t(i,r,e){const n=i.getCurrentWaterLevel(r),a=Sh(n,i.bufferMonitorInfo);if(a){const e=a["threshold"];return rr(Math.ceil(1e3*(n-e))).pipe(Ae(()=>{const e=Sh(i.getCurrentWaterLevel(r),i.bufferMonitorInfo);return(null==e?void 0:e.level)===a.level?t(i,r):Pe}),ve(()=>Th(i,r)))}return Se}(i,r):Se),Dr(1))))}))}class Eh extends ga{constructor(e,t,i){super(t),this.Js=e,this.R=i}get mediaElementDuration$(){return this.selectActive(({mediaElementDuration:e})=>e)}get primaryContentMediaElementDuration(){var e;return null!=(e=null==(e=this.getActive())?void 0:e.primaryContentMediaElementDuration)?e:1/0}get mediaElementDuration(){var e;return null!=(e=null==(e=this.getActive())?void 0:e.mediaElementDuration)?e:1/0}get msDuration(){var e;return null!=(e=null==(e=this.mediaSourceEntity)?void 0:e.duration)?e:1/0}get minSBDuration(){var e;let i=Number.POSITIVE_INFINITY;return null!=(e=null==(e=this.mediaSourceEntity)?void 0:e.sourceBufferEntities)&&e.forEach((e,t)=>{e&&(i=fe(e.totalDuration)?Math.min(i,e.totalDuration):Number.NEGATIVE_INFINITY)}),fe(i)?i:1/0}get currentTime(){return this.Js.currentTime}get clientWidth(){return this.Js.clientWidth}get clientHeight(){return this.Js.clientHeight}getBufferedDuration(e=.5){var t=nh.timeRangesToBufferedRange(this.Js.buffered),t=nh.getBufferedInfo(t,this.currentTime,e);return t.end-t.start}get mediaSourceEntity(){var e;return null==(e=this.getActive())?void 0:e.mediaSourceEntity}get msReadyState(){var e;return null==(e=this.mediaSourceEntity)?void 0:e.readyState}get sourceBufferEntities(){var e;return null==(e=this.mediaSourceEntity)?void 0:e.sourceBufferEntities}sourceBufferEntityByType(e){var t;return null==(t=this.sourceBufferEntities)?void 0:t[e]}initSegmentEntityByType(e){return null==(e=this.sourceBufferEntityByType(e))?void 0:e.initSegmentInfo}get maxBufferSize(){var e=null==(e=this.sourceBufferEntities)?void 0:e[B.Variant];let t=1/0;return t=null!=e&&e.gotQuotaExceeded?null!=(e=e.maxTotalBytes)?e:1/0:t}get seekable(){return this.Js.seekable}get liveSeekableRange(){var e;return null==(e=this.getActive())?void 0:e.liveSeekableRange}get liveSeekableRange$(){return this.selectActive(({liveSeekableRange:e})=>e)}get seekableTimeRanges(){return Oh(this.liveSeekableRange,this.seekable)}get seekableTimeRanges$(){return br([this.liveSeekableRange$,this.mediaElementDuration$]).pipe(ve(([e])=>Oh(e,this.seekable)))}get isPlayingAtLive(){var{liveSeekableRange:e,isIframeRate:t}=this;return null!=e&&!t&&this.currentTime>=e.boundary+(performance.now()-e.tupdate)/1e3}get expectSeekingEvent(){var e;return null!=(e=null==(e=this.getActive())?void 0:e.expectSeekingEvent)&&e}get desiredRate(){var e;return(null==(e=this.getActive())?void 0:e.desiredRate)||0}get desiredRate$(){return this.selectActive(({desiredRate:e})=>null!=e?e:0)}get effectiveRate(){return this.isIframeRate?this.desiredRate:this.paused?0:1}get playbackRate(){return this.Js.playbackRate}get isIframeRate(){return fh(this.desiredRate)}get isIframeRate$(){return this.desiredRate$.pipe(ve(fh))}get msObjectUrl$(){return this.selectActive(({mediaSourceEntity:e})=>null==e?void 0:e.objectUrl).pipe(Te())}get msReadyState$(){return this.selectActive(({mediaSourceEntity:e})=>{return null!=(e=null==e?void 0:e.readyState)?e:null})}get readyState(){var e;return null!=(e=null==(e=this.getActive())?void 0:e.readyState)?e:0}get readyState$(){return this.selectActive(({readyState:e})=>null!=e?e:0)}get mediaSourceEntity$(){return this.selectActive(({mediaSourceEntity:e})=>e)}get expectedSbCount$(){return this.selectActive(({expectedSbCount:e})=>e)}get expectedSbCount(){var e;return null==(e=this.getActive())?void 0:e.expectedSbCount}get paused$(){return this.selectActive(({paused:e})=>e)}get paused(){var e;return null==(e=null==(e=this.getActive())?void 0:e.paused)||e}get flushing$(){return this.selectActive(({flushing:e})=>e)}get flushing(){var e;return null!=(e=null==(e=this.getActive())?void 0:e.flushing)&&e}get waitingForDisco$(){return this.selectActive(({waitingForDisco:e})=>e)}get waitingForDisco(){var e;return null!=(e=null==(e=this.getActive())?void 0:e.waitingForDisco)&&e}get gotPlaying(){var e;return null!=(e=null==(e=this.getActive())?void 0:e.gotPlaying)&&e}get gotPlaying$(){return this.selectActive(({gotPlaying:e})=>e)}get seekTo(){var e;return null==(e=this.getActive())?void 0:e.seekTo}get seekTo$(){return this.selectActive(({seekTo:e})=>e)}get seeking(){var e;return null!=(e=null==(e=this.getActive())?void 0:e.seeking)&&e}get seeking$(){return this.selectActive(({seeking:e})=>e)}get seekToPos$(){return this.selectActive(({seekTo:e})=>null==e?void 0:e.pos).pipe(Te())}get seekInProgress(){var e;return fe(null==(e=this.seekTo)?void 0:e.pos)}get seekInProgress$(){return this.selectActive(({seekTo:e})=>fe(null==e?void 0:e.pos)).pipe(Te())}get nudgeTarget$(){return this.selectActive(({nudgeInfo:e})=>null==e?void 0:e.nudgeTarget)}get nudgeCount(){var e;return null!=(e=null==(e=null==(e=this.getActive())?void 0:e.nudgeInfo)?void 0:e.nudgeCount)?e:0}get inFlightRange(){var e;return null==(e=this.getActive())?void 0:e.inFlightRanges}get inFlightRanges$(){return this.selectActive(({inFlightRanges:e})=>e)}get sourceBufferEntities$(){return this.selectActive(({mediaSourceEntity:e})=>null==e?void 0:e.sourceBufferEntities)}sourceBufferEntityByType$(t){return this.selectActive(({mediaSourceEntity:e})=>{return null==(e=null==e?void 0:e.sourceBufferEntities)?void 0:e[t]})}bufferedSegmentsByType$(t){return this.selectActive(({mediaSourceEntity:e})=>{return null!=(e=null==(e=null==(e=null==e?void 0:e.sourceBufferEntities)?void 0:e[t])?void 0:e.bufferedSegments)?e:[]})}getBufferedSegmentsByType(e){return null!=(e=null==(e=this.sourceBufferEntityByType(e))?void 0:e.bufferedSegments)?e:[]}get bufferedSegmentsTuple$(){return this.selectActive(e=>{var t;return[null!=(t=null==(t=null==(t=null==(t=null==e?void 0:e.mediaSourceEntity)?void 0:t.sourceBufferEntities)?void 0:t[B.Variant])?void 0:t.bufferedSegments)?t:[],null!=(e=null==(t=null==(e=null==(t=null==e?void 0:e.mediaSourceEntity)?void 0:t.sourceBufferEntities)?void 0:e[B.AltAudio])?void 0:t.bufferedSegments)?e:[]]})}get timeupdate$(){var e=yl(this.Js);return this.Zs||(this.Zs=e.event("timeupdate").pipe(ln(125,void 0,{leading:!0,trailing:!0}),ve(()=>this.currentTime),Ur(e=>fe(e)),Jr())),this.Zs}get playingEvent$(){return yl(this.Js).event("playing").pipe(ve(()=>{}))}get mediaElementEntity$(){return this.selectActive(e=>Boolean(e))}get ended$(){return this.selectActive(e=>{return null!=(e=null==e?void 0:e.ended)&&e})}get ended(){var e;return(null==(e=this.getActive())?void 0:e.ended)||!1}sbUpdating$(t){return this.selectActive(e=>{return null!=(e=null==(e=null==(e=null==(e=null==e?void 0:e.mediaSourceEntity)?void 0:e.sourceBufferEntities)?void 0:e[t])?void 0:e.updating)&&e})}sbUpdating(e){var t;return null!=(e=null==(t=null==(t=null==(t=null==(t=this.getActive())?void 0:t.mediaSourceEntity)?void 0:t.sourceBufferEntities)?void 0:t[e])?void 0:t.updating)&&e}get updating(){var e=this.sbUpdating(B.Variant),t=this.sbUpdating(B.AltAudio);return e||t}get updating$(){return br([this.sbUpdating$(B.Variant),this.sbUpdating$(B.AltAudio)]).pipe(ve(e=>e.some(e=>e)),Te())}get bufferedRangeTuple$(){return this.selectActive(e=>{var t;return[null==(t=null==(t=null==(t=null==e?void 0:e.mediaSourceEntity)?void 0:t.sourceBufferEntities)?void 0:t[B.Variant])?void 0:t.bufferedRanges,null==(t=null==(e=null==(t=null==e?void 0:e.mediaSourceEntity)?void 0:t.sourceBufferEntities)?void 0:e[B.AltAudio])?void 0:t.bufferedRanges]})}get bufferedRangeTuple(){return[this.getBufferedRangeByType(B.Variant),this.getBufferedRangeByType(B.AltAudio)]}getBufferedRangeByType$(t){return this.selectActive(e=>{return null!=(e=null==(e=null==(e=null==(e=null==e?void 0:e.mediaSourceEntity)?void 0:e.sourceBufferEntities)?void 0:e[t])?void 0:e.bufferedRanges)?e:[]})}getBufferedRangeByType(e){var t;return null!=(e=null==(t=null==(t=this.sourceBufferEntities)?void 0:t[e])?void 0:t.bufferedRanges)?e:[]}get combinedBuffer$(){return this.selectActive(e=>{return null!=(e=null==e?void 0:e.bufferedRanges)?e:[]})}get combinedBuffer(){var e;return null!=(e=null==(e=this.getActive())?void 0:e.bufferedRanges)?e:[]}gotFirstAppend$(e){var t=ol(br([this.combinedBuffer$,this.updating$]),([e,t])=>0<(null==e?void 0:e.length)&&!t);return e?gr(t,e):t}get desiredPos(){var e;return xe(null==(e=this.seekTo)?void 0:e.pos,this.currentTime)}getMediaBufferInfo(i,e){const t=this.getBufferInfo(i,e),r=[null,null];t.forEach((e,t)=>{r[t]=null!=(e=null==(t=e.bufferedSegments.find(e=>e.startPTS<=i&&e.endPTS>i))?void 0:t.frag)?e:null});e=this.getCombinedBufferInfo(i,e);return{pos:i,playbackRate:this.playbackRate,sbTuple:t,combined:e,playingFrags:r}}getBufferInfo(n,a,s){var e;const t=null==(e=this.sourceBufferEntities)?void 0:e.map(e=>null==e?void 0:e.bufferedRanges),i={buffered:{start:n,end:n,len:0},bufferedSegments:[]},o=[i,i];return t&&t.forEach((e,i)=>{if(e){var r=nh.getBufferedInfo(e,n,a);let t=null!=(e=this.sourceBufferEntities[i].bufferedSegments)?e:[];if(s){let e=!1;for(const n of t=t.filter(e=>e.frag.itemId===s))n.startPTS<r.end&&n.endPTS>=r.start&&(e=!0,r.start=Math.max(r.start,n.startPTS),r.end=Math.min(r.end,n.endPTS));e||(r.start=r.end=n),r.len=r.start-r.end}o[i]={buffered:r,bufferedSegments:t}}}),o}getCombinedBufferInfo(e,t){var i=this.getActive();return i?nh.getBufferedInfo(i.bufferedRanges,e,t):null}getContentGapRanges(){var e=this.getActive();return e?e.contentGapRanges:[]}hasGaps$(){return this.selectActive(e=>0<(null==e?void 0:e.contentGapRanges.length))}avoidContentGap(t,i,e){let r=t;var n=this.getActive();if(n)for(let e=0;e<n.contentGapRanges.length;e++){var a=n.contentGapRanges[e];if(t>a.start-i&&t<a.end){r=a.end;break}}return r}get bufferMonitorInfo(){var e;return null!=(e=null==(e=this.getActive())?void 0:e.bufferMonitorInfo)?e:null}get bufferMonitorThresholds$(){return this.selectActive(e=>{var t,i,r,e=null==e?void 0:e.bufferMonitorInfo;return e?({almostDryWaterLevelSeconds:e,lowWaterLevelSeconds:t,highWaterLevelSeconds:i,maxBufferSeconds:r}=e,{almostDryWaterLevelSeconds:e,lowWaterLevelSeconds:t,highWaterLevelSeconds:i,maxBufferSeconds:r}):null}).pipe(Te((e,t)=>(null==e?void 0:e.lowWaterLevelSeconds)===(null==t?void 0:t.lowWaterLevelSeconds)))}get highWaterLevelSeconds(){var e;return null==(e=this.bufferMonitorInfo)?void 0:e.highWaterLevelSeconds}get lowWaterLevelSeconds(){var e;return null==(e=this.bufferMonitorInfo)?void 0:e.lowWaterLevelSeconds}get waterLevelType$(){return this.selectActive(e=>{return null!=(e=null==e?void 0:e.bufferMonitorInfo.waterLevelType)?e:null})}waterLevelForType(e){var t;return null!=(t=null==(t=null==(t=this.bufferMonitorInfo)?void 0:t.waterLevelType)?void 0:t.sbTuple[e])?t:null}waterLevelChangedForType$(t){return this.waterLevelType$.pipe(ve(e=>null==e?null:null==t?e.combined:e.sbTuple[t]))}isBufferedToEnd$(r,t=!0){return _n([this.combinedBuffer$,this.selectActive(e=>e.bufferMonitorInfo).pipe(Yl(),ve(e=>t?e.almostDryWaterLevelSeconds:Math.max(e.almostDryWaterLevelSeconds,e.lowWaterLevelSeconds/2))),this.seeking$]).pipe(ve(([e,t])=>{var i=this.minSBDuration;return!(!e||!fe(i))&&(e=nh.getBufferedInfo(e,this.currentTime,r).end,Math.abs(i-e)<=t)}),Te())}get haveEnough(){var e;return null!=(e=null==(e=this.getActive())?void 0:e.haveEnough)&&e}get haveEnough$(){return this.selectActive(({haveEnough:e})=>e)}get stopStreaming(){var e;return null!=(e=null==(e=this.getActive())?void 0:e.stopStreaming)&&e}withinFragDurationOfContentGap(t,i=10){var r=this.getContentGapRanges();for(let e=0;e<r.length;e++)if(t>r[e].start-i&&t<r[e].start)return!0;return!1}static likelyToKeepUp(e,t,i){return t&&e&&i>=e.HAVE_FUTURE_DATA}get playbackLikelyToKeepUp(){return Eh.likelyToKeepUp(this.Js,this.haveEnough,this.readyState)}get playbackLikelyToKeepUp$(){return br([this.haveEnough$,this.readyState$]).pipe(ve(([e,t])=>Eh.likelyToKeepUp(this.Js,e,t)),Te())}getCurrentWaterLevel(e){var t=this.currentTime,i=null!=(i=null==(i=this.getActive())?void 0:i.bufferedRanges)?i:[];return nh.getBufferedInfo(i,t,e).len}getCombinedMediaSourceBufferInfo(e){var t=this.currentTime,[i,r]=null!=(i=null==(i=null==(i=this.getActive())?void 0:i.mediaSourceEntity)?void 0:i.sourceBufferEntities)?i:[void 0,void 0];return[nh.getBufferedInfo(null!=(i=null==i?void 0:i.bufferedRanges)?i:[],t,e),nh.getBufferedInfo(null!=(i=null==r?void 0:r.bufferedRanges)?i:[],t,e)]}getCurrentWaterLevelByType(e,t){var i=this.currentTime,e=this.sourceBufferEntityByType(e),e=null!=(e=null==e?void 0:e.bufferedRanges)?e:[];return nh.getBufferedInfo(e,i,t).len}canContinuePlaybackWithoutGap(e,t,i,r){if("LIVE"!==e.type)return!0;if(!e.ptsKnown)return!1;var n=this.currentTime,i=performance.now()+i.avgPlaylistLoadTimeMs+1e3*e.targetduration,a=e.fragments,s=a[0].start,a=a[a.length-1].start+a[a.length-1].duration,i=s+(i-t)/1e3;let o=this.getBufferInfo(n,r)[Ks(e.mediaOptionType)].buffered["end"];return i<=(o=o>=s-r&&o<=a?a:o)+r}get stallInfo$(){return this.selectActive(e=>{return null!=(e=null==e?void 0:e.stallInfo)?e:null})}get stallInfo(){var e;return null!=(e=null==(e=this.getActive())?void 0:e.stallInfo)?e:null}get textTracks(){return this.Js.textTracks}get textTracksCreated$(){return this.selectActive(e=>null==e?void 0:e.textTracksCreated)}get mediaOptionParsedSubtitleRecord(){var e;return null==(e=this.getActive())?void 0:e.mediaOptionParsedSubtitleRecord}getParsedSubtitleRecordsForMediaOption(e){return this.mediaOptionParsedSubtitleRecord?this.mediaOptionParsedSubtitleRecord[e]||{}:null}gotQuotaExceeded(e){return null!=(e=null==(e=this.sourceBufferEntityByType(e))?void 0:e.gotQuotaExceeded)&&e}maxTotalBytesByType(e){return null!=(e=null==(e=this.sourceBufferEntityByType(e))?void 0:e.maxTotalBytes)?e:1/0}likelyToExceedBuffer(t,i,r,n,a){var s,o,l=xe(t,this.currentTime);let d=!1,u=0;const c=null!=(t=this.highWaterLevelSeconds)?t:1/0,h=this.sourceBufferEntityByType(i);if(h&&h.gotQuotaExceeded&&fe(r)&&fe(h.maxTotalBytes)){if(!a){const t=this.getBufferedRangeByType(i);a=nh.getBufferedInfo(t,l,n)}const t=this.getBufferedSegmentsByType(i);let e=0;for(const i of t){const{startPTS:t,endPTS:n,appendStart:d,appendEnd:c}=i,h=Math.max(a.start,null!=d?d:t),p=Math.min(a.end,null!=c?c:n);p<=l||h>a.end||h>=p||(s=p-h,o=n-t,(e+=i.bytes*s/o)>=r&&0===u&&(u=a.end-p))}d=e+r>h.maxTotalBytes}return u=d?Math.min(u,c):c,{likelyToExceed:d,safeWaterLevel:u}}}function Oh(e,t){let i=nh.timeRangesToBufferedRange(t);if(e){const t=[];for(const r of i)r.end<e.start||r.start>e.edge||t.push({start:Math.max(e.start,r.start),end:Math.min(e.edge,r.end)});i=t}return i}class wh{constructor(e,t,i,r,n){this.bi=e,this.er=t,this.R=r,this.ir=n,this.rr=i.useCustomMediaFunctions,this.lr=i.overridePlaybackRate}install(){const e=this.er;e&&(this.rr&&e&&e.play&&e.pause&&(e.originalPlay||(e.originalPlay=e.play.bind(e)),e.originalPause||(e.originalPause=e.pause.bind(e)),e.play=()=>(this.bi.checkForReplay(),this.bi.desiredRate=1,0<e.currentTime&&!e.paused&&!e.ended&&2<e.readyState?Promise.resolve():new Promise((e,t)=>{this.dr||(this.dr=[]),this.dr.push({resolve:e,reject:t})})),e.pause=()=>{this.bi.desiredRate=0}),"function"==typeof HTMLMediaElement&&this.lr&&Object.defineProperty(e,"playbackRate",{enumerable:!0,configurable:!0,get:function(){return 1},set:function(e){Object.getOwnPropertyDescriptor(HTMLMediaElement.prototype,"playbackRate").set.call(this,e)}}),this.vr=null,this.expectPauseEvent=this.expectPlayEvent=!1)}uninstall(){var e=this.er;e&&(e.originalPlay&&(e.play=e.originalPlay,delete e.originalPlay),e.originalPause&&(e.pause=e.originalPause,delete e.originalPause),this.lr)&&(e.playbackRate=1,delete e.playbackRate),this.vr=null,this.expectPauseEvent=this.expectPlayEvent=!1}play(){var e,t;this.er&&(t=this.bi.flushing,this.vr||t||(this.expectPlayEvent=this.expectPlayEvent||this.er.paused,t={type:"play",pos:this.er.currentTime},null!=(e=this.ir)&&e.report(35,t),this.vr=this.pr(),this.vr&&this.vr.then(()=>{this.vr=null,this.gr(null)}).catch(e=>{this.vr=null,this.expectPlayEvent=!1,this.gr(e||new me(!1,pe.PlayRejected)),"NotAllowedError"===(null==e?void 0:e.name)&&(this.bi.desiredRate=0)})))}pause(e=!1){var t,i;this.er&&(i={type:"pause",pos:this.er.currentTime},null!=(t=this.ir)&&t.report(35,i),e?(this.gr(null),this.yr()):this.vr?this.vr.then(()=>{var e=this.bi.mediaQuery;(0===this.bi.desiredRate||e.seeking&&!e.playbackLikelyToKeepUp)&&this.yr()}).catch(e=>{}):this.yr())}gr(t){var e,i=null==(e=this.dr)?void 0:e.length;if(t)for(let e=0;e<i;e++)this.dr[e].reject(t);else for(let e=0;e<i;e++)this.dr[e].resolve();this.dr=[]}pr(){return(this.er.originalPlay||this.er.play.bind(this.er))()}yr(){return this.expectPauseEvent=this.expectPauseEvent||!this.er.paused,(this.er.originalPause||this.er.pause.bind(this.er))()}}class Rh extends Error{}class Mh extends v{constructor(e,t,i,r,n){super(K.MEDIA_ERROR,e,t,i,n),this.sbType=r,this.response=i}}class Ph extends Mh{constructor(e,t,i,r){super(q.BUFFER_ADD_CODEC_ERROR,!1,e,t,r),this.mediaOptionId=i,this.mediaOptionType=js(this.sbType)}}class Ch extends Mh{constructor(e,t,i,r,n,a){super(e,t,i,r,a),this.isTimeout=n,this.mediaOptionType=js(this.sbType)}}class kh extends Ch{constructor(e,t,i,r){super(q.BUFFER_FULL_ERROR,!1,e,t,!1,r),this.maxTotalBytes=i}}class Lh extends Ch{constructor(e,t,i){super(q.BUFFER_APPEND_ERROR,!1,e,t,!0,i)}}class Dh extends Ch{constructor(e,t,i,r){super(q.BUFFER_APPEND_ERROR,!1,e,t,!1,r),this.mediaOptionId=i,this.mediaOptionType=js(this.sbType)}}class xh extends Ch{constructor(e,t,i){super(q.BUFFER_APPEND_ERROR,!1,e,t,!1,i),this.mediaOptionType=js(this.sbType)}}class Nh extends v{constructor(e,t,i,r,n,a=NaN,s){super(K.MEDIA_ERROR,e,t,i,s),this.stallType=r,this.bufferLen=n,this.nudgePosition=a,this.response=i}}class Fh extends F{constructor(a,e,s,o,l,d,u,c,h){super(e=>{const t=yl(d),i=this.R=c.child({sb:l});a.setSourceBufferEntity(l,u),u.mimeType.includes("audio/mpeg")&&(this.updateMp3Timestamps=!0);var r=[t.event("updatestart").pipe(Ee(()=>{a.setSourceBufferUpdating(l,!0)})),t.event("updateend").pipe(Ee(()=>{var e=nh.timeRangesToBufferedRange(d.buffered),t=nh.timeRangesToBufferedRange(s.buffered);a.setBufferedRangesUpdated(l,e,t,!1,h.maxBufferHole,!0),this.Sr()})),t.event("error").pipe(Ee(()=>{i.error(`[sb${this.type}] error`);var e=null!=(e=this.Js.error)?e:new xh(pe.SourceBufferUpdatingError,this.type,"SourceBufferUpdatingError");this.Sr(e)})),t.event("abort").pipe(Ee(()=>{this.Sr()}))];"onbufferedchange"in t.target&&r.push(t.event("bufferedchange").pipe(Ee(e=>{var t;if(null!=(t=e.removedRanges)&&t.length){const e=nh.timeRangesToBufferedRange(d.buffered),t=nh.timeRangesToBufferedRange(s.buffered);a.setBufferedRangesUpdated(l,e,t,!1,h.maxBufferHole,!1),this.Sr()}})));const n=Bn(...r).pipe(Ae(()=>Se)).subscribe(e);return()=>{n.unsubscribe();try{"open"===o.readyState&&d.abort(),o.removeSourceBuffer(d)}catch(e){}}}),this.wr=a,this.Ir=e,this.Js=s,this.type=l,this.sourceBuffer=d,this.config=h,this.updateMp3Timestamps=!1,this.Tr=[],this.Or=new Ie,this.Mr=new Ie,this.Ar=h.appendTimeoutMs}get buffered(){return this.sourceBuffer.buffered}Sr(e){this.wr.setSourceBufferUpdating(this.type,!1),e?this.Mr.next(e):this.Or.next(),this.Er()}Nr(){return Bn(this.Or,this.Mr.pipe(ve(e=>{throw e}))).pipe(Dr(1))}Er(){var e;0===this.Tr.length||this.sourceBuffer.updating||null==(e=this.Tr.shift())||e.subscriber.closed||e.work.subscribe(e.subscriber)}Rr(e,t){this.Tr.push({work:e,subscriber:t}),this.Er()}appendBuffer(i,r,n){return new F(e=>{var t=this._appendBufferAsync(i,r,n);this.Rr(t,e)})}clearInitSegmentInfo(){this.wr.setInitSegmentEntity(this.type,null)}Pr(e){e=hh(e);this.wr.setInitSegmentEntity(this.type,e)}_r(e){this.clearInitSegmentInfo(),this.abort()}_appendBufferAsync(s,o,l){return new F(t=>{let e=NaN,i=null;const r=("startPTS"in o?o.frag:o).mediaOptionId,n="startPTS"in o?o.frag.mediaOptionType:void 0;let a=this.Nr().pipe(ve(()=>("initParsedData"in o?this.Pr(o):o.partialFrag&&this._r(o),{fragmentType:n,startAppend:e,endAppend:performance.now(),bytesAppend:s.byteLength})));(a=fe(this.Ar)&&0<this.Ar?a.pipe(un(this.Ar)):a).pipe(ye(e=>{e instanceof dn?(this.sourceBuffer.abort(),this.clearInitSegmentInfo(),e=new Lh(pe.InternalError,this.type,`Append took longer than ${this.Ar}ms`)):e instanceof Mh&&(e=new Dh(e.response,this.type,r));var t=this.Ir.sbUpdating(this.type);throw this.R.error(`[sb${this.type}] got error=${e} updating=${this.updating} storeUpdating=`+t),!this.updating&&t&&this.wr.setBufferedRangesUpdated(this.type,nh.timeRangesToBufferedRange(this.sourceBuffer.buffered),nh.timeRangesToBufferedRange(this.Js.buffered),!0,this.config.maxBufferHole,!0),e})).subscribe(t);try{"startPTS"in o&&(i={startPTS:o.startPTS,endPTS:o.endPTS,bytes:o.bytes,frag:Object.assign({},o.frag),partialFrag:o.partialFrag}),this.wr.setInflightSegment(this.type,i),this.wr.setSourceBufferUpdating(this.type,!0),e=performance.now(),fe(l)&&this.sourceBuffer.timestampOffset!==l&&(this.sourceBuffer.timestampOffset=l),this.sourceBuffer.appendBuffer(s)}catch(e){if(22===e.code)this.wr.setBufferedRangesUpdated(this.type,nh.timeRangesToBufferedRange(this.sourceBuffer.buffered),nh.timeRangesToBufferedRange(this.Js.buffered),!0,this.config.maxBufferHole,!0),t.error(new kh(pe.AllocationFailed,this.type,this.maxTotalBytes,e.message));else{if(this.wr.setInflightSegment(this.type,null),this.Js.error)throw new Dh(pe.VideoDecoderBadDataErr,this.type,r,e.message);t.error(e)}}})}remove(i,r){return new F(e=>{var t=new F(t=>{this.Nr().subscribe(t);try{this.wr.setSourceBufferUpdating(this.type,!0),this.sourceBuffer.remove(i,r)}catch(e){t.error(new Mh(q.SOURCE_BUFFER_ERROR,!1,pe.SourceBufferRemoveError,this.type,e.message))}});this.Rr(t,e)})}abort(){try{this.sourceBuffer.abort()}catch(e){throw this.R.error(`[sb${this.type}] abort error `+e),new Mh(q.SOURCE_BUFFER_ERROR,!1,pe.SourceBufferAbortError,this.type,e.message)}}get updating(){return this.sourceBuffer.updating}get timestampOffset(){return this.sourceBuffer.timestampOffset}set timestampOffset(e){this.sourceBuffer.timestampOffset=e}get gotQuotaExceeded(){var e;return null!=(e=null==(e=this.Ir.sourceBufferEntityByType(this.type))?void 0:e.gotQuotaExceeded)&&e}get bufferedSegments(){var e;return null!=(e=null==(e=this.Ir.sourceBufferEntityByType(this.type))?void 0:e.bufferedSegments)?e:[]}get totalBytes(){var e;return null!=(e=null==(e=this.Ir.sourceBufferEntityByType(this.type))?void 0:e.totalBytes)?e:0}get maxTotalBytes(){var e=null!=(e=null==(e=this.Ir.sourceBufferEntityByType(this.type))?void 0:e.maxTotalBytes)?e:1/0;return this.gotQuotaExceeded?e:1/0}changeType(e){var t;let i=!1;if(this.config.changeType&&"function"==typeof this.sourceBuffer.changeType)try{this.sourceBuffer.changeType(e),i=!0}catch(i){null!=(t=this.R)&&t.error(`changeType(${e}) failed: `+i.msg)}return i}}class Bh extends F{constructor(a,s,e,o,t,i){super(e=>{var t=yl(o),i=[t.event("sourceopen").pipe(Ee(e=>{fe(this.Cr)&&(this.commitMediaSourceAndMediaElementStoreDuration(this.Cr),this.Cr=null);e=null!=(e=null==e?void 0:e.target)?e:o;s.msReadyState=e.readyState})),Bn(t.event("sourceclose"),t.event("sourceended")).pipe(Ee(e=>{e=(null!=(e=null==e?void 0:e.target)?e:o).readyState;s.msReadyState=e})),this.Dr.pipe(Ae(e=>e?Bn(...e.filter(e=>null!=e)):Se))];if("onstartstreaming"in t.target){const a=Bn(t.event("startstreaming"),t.event("endstreaming")).pipe(Ee(e=>{e=null==e?void 0:e.type;s.stopStreaming="endstreaming"===e}));i.push(a)}const r=Bn(...i).pipe(Ae(()=>Se)).subscribe(e),n=URL.createObjectURL(o);if(a.disableRemotePlayback=!0,l.WebKitPlaybackTargetAvailabilityEvent)try{a.removeAttribute("src"),Uh(a),_h(a,n),a.load()}catch(e){a.src=n}else a.src=n;return s.setMediaSourceEntity(n,o.readyState),()=>{r.unsubscribe(),this.Cr=null,URL.revokeObjectURL(n),this.Lr===n&&(Uh(a),a.removeAttribute("src"),a.load(),s.setMediaSourceEntity(null)),this.Dr.next(null)}}),this.Js=a,this.wr=s,this.Ir=e,this.Fr=o,this.R=t,this.Cr=i,this.Dr=new jr(null)}addAirPlaySource(e){var t=this.Js;!t.src&&0<t.childElementCount&&!Qa(e)&&(t.disableRemotePlayback=!1,Uh(t,1),_h(t,e,"application/vnd.apple.mpegurl"))}get Lr(){var e=this.Js,e=(null==e?void 0:e.firstChild)||e;return null==e?void 0:e.src}get readyState(){return this.Fr.readyState}set duration(e){this.Fr.duration=e}get duration(){return this.Fr.duration}commitMediaSourceAndMediaElementStoreDuration(e){try{this.duration!==e&&(this.duration=e,this.wr.msDuration=e)}catch(e){}}endOfStream(e){this.Fr.endOfStream(e)}createSourceBuffers(e,o){Oe(()=>{const a=this.Fr;try{const s=[null,null];e.forEach((t,i)=>{if(t){var{mimeType:r,mediaOptionId:n}=t;let e;try{e=a.addSourceBuffer(r)}catch(t){const o=this.Js;throw(!o.src&&1<o.childElementCount||!o.disableRemotePlayback)&&(o.disableRemotePlayback=!0,Uh(o,1)),new Ph(pe.IncompatibleAsset,i,n,t.message)}s[i]=new Fh(this.wr,this.Ir,this.Js,this.Fr,i,e,t,this.R,o)}}),this.Dr.next(s)}catch(e){if(e instanceof v)throw e;throw new Rh(`error initializing sourcebuffers ${e.message} readyState=`+a.readyState)}})}get needSourceBuffers(){return null==this.Dr.value||null==this.Dr.value[0]}get sourceBuffers(){return this.Dr.value}getSourceBufferByType(e){var t=this.Dr.value;return t?t[e]:null}updateLiveSeekableRange(e,t){var i=this.Fr;null!=i&&i.setLiveSeekableRange&&"open"===(null==i?void 0:i.readyState)&&i.setLiveSeekableRange(e,t)}clearLiveSeekableRange(){var e=this.Fr;null!=e&&e.clearLiveSeekableRange&&"open"===(null==e?void 0:e.readyState)&&e.clearLiveSeekableRange()}}function Uh(e,t=0){for(;e.childElementCount>t;)e.removeChild(e.children[e.childElementCount-1])}function _h(e,t,i="video/mp4"){var r=hv.document.createElement("source");r.type=i,r.src=t,e.appendChild(r)}function Vh(t,e,i,r,n,a){var s=r.some(e=>e.start<=t&&e.end>t),a=a&&a.some(e=>e&&e.start<=t&&t<=e.end);return!(!s&&a||1!==e||i||0===r.length||n&&!s)}function Qh(e,t,i,r,n,a,s){var o=performance.now()-i;return{type:e,isLowBufferStall:r.len<=n||!a,tstalled:i,stallDurationMs:o,currentTime:t,gotPlaying:s}}class Hh extends F{constructor(b,T,e,t,i,r,n,a){super(e=>{T.logger=this.R;const l=this.Zt,t=T.startMediaSession(b,l.maxBufferLength,l.almostDryBufferSec,l.defaultTargetDuration),i=qh(b,T,this.jr,this,this.Br,this.errorRecovery,l,this.R,this.Ur),r=this.$r.pipe(Ae(e=>e||Se)),n=this.Vr.pipe(Ur(e=>!!e),Ae(({start:e,end:t,cb:i})=>this.flushAll(e,t).pipe(Ae(()=>ol(this.jr.updating$,e=>!1===e)),Ee(()=>i())))),a=this.jr.seekTo$.pipe((o=b,d=this.jr,c=(u=this).wr,h=this.Zt,p=(p=this.R).child({name:"seek"}),e=>e.pipe(Ur(e=>e&&fe(e.pos)),Ae(function(e){return ol(br([d.readyState$,d.flushing$]),([e,t])=>e>=o.HAVE_METADATA&&!1===t).pipe(ve(()=>e),Ae(function({pos:e,fromEvent:t,inContentGap:i}){u.checkForInconsistentStoreBufferRangesAndUpdate();var r=!t&&o.currentTime!==e;return o.paused||i||!t&&!r||u.pause(),r&&(o.currentTime=e),ol(d.haveEnough$,e=>e).pipe(ve(()=>({pos:e,fromEvent:t})))}),Ae(function({pos:e,fromEvent:t}){var i=d.getCombinedBufferInfo(e,0),r=i.nextStart;if((!t||h.nudgeFromEventSeek)&&0===i.len&&fe(r)&&e<r&&r-e<=h.maxSeekHole){const o=u.isPosBetweenJaggedStart(e);if(!h.jaggedSeekTolerance||!o)return u.seekTo=r,Se}t=d.desiredRate;return o.paused&&0!==t&&u.play(),!1===d.seeking&&!1===o.seeking?be(!0):ol(d.seeking$,e=>!e&&!1===o.seeking)}),pr(wn),Ae(function(){return c.setSeekToPos(null),Se}),ye(e=>(p.error(`error during seek `+e.message),c.setSeekToPos(null),Se)))})))),s=this.jr.desiredRate$.pipe((m=b,f=this.jr,g=this,e=>e.pipe(Ae(e=>0===e?(m.paused||g.pause(),Se):f.paused$.pipe(Ae(e=>e?br([f.seekInProgress$,f.haveEnough$]).pipe(Ee(([e,t])=>{!e&&t&&m.paused&&!m.ended&&g.play()})):Se))),Ae(()=>Se))));var o,d,u,c,h,p,m,f,g;this.qr=this.qr||new wh(this,b,l,this.R,this.Ur),this.qr.install();const y=this.Hr.pipe(Ae(e=>{return e?Bn(function(a,n){const{lowBufferThreshold:u,lowBufferWatchdogPeriod:c,highBufferWatchdogPeriod:h,seekWatchdogPeriod:v}=n,e=_n([a.desiredRate$,a.ended$,a.combinedBuffer$,a.seekToPos$,a.inFlightRanges$]).pipe(ve(e=>{var[e,t,i,r,n]=e;return Vh(a.currentTime,e,t,i,isFinite(r),n)}),Te()),t=_n([e,a.seekToPos$,a.gotPlaying$]).pipe(Ae(e=>{var t,p,m,f,g,y,s,o,l,d,[e,i,r]=e;return e?(e=a.nudgeCount,t=v+1*e,isFinite(i)||!r?(s=a,o=performance.now(),i=t,l=u,d=e,rr(1e3*i).pipe(Ae(()=>{var{currentTime:e,desiredRate:t,ended:i,combinedBuffer:r,seekInProgress:n,inFlightRange:a}=s;return Vh(e,t,i,r,n,a)&&(t=s.getCombinedBufferInfo(e,0),null===(i=s.stallInfo)||i.type===uu.Seek||1===d&&i.type===uu.HighBuffer)?be(Qh(uu.Seek,e,o,t,l,s.haveEnough,s.gotPlaying)):Se}))):(p=a,m=c,f=h+1*e,g=u,y=n.maxBufferHole,new F(l=>{let d,u=p.currentTime,c=performance.now();function h(e){c=performance.now(),u=e}Ce(dl(l),Bn(be(!0),p.timeupdate$.pipe(ve(function(){var e=p.currentTime;return u!==e&&h(e),!1})),gr(p.combinedBuffer$,Zi).pipe(Ae(()=>{var{desiredRate:e,ended:t,combinedBuffer:i,seekInProgress:r,inFlightRange:n,currentTime:a}=p;return Vh(a,e,t,i,r,n)?be(!0):(l.complete(),Se)}))).pipe(Ae(function e(t){var i=performance.now(),r=p.currentTime;if(u!==r)return h(r),Se;r=c;if(r===d)return Se;var n=p.getCombinedBufferInfo(u,0);let a,s;a=n.len<=g||!p.haveEnough?n.nextStart&&n.nextStart<=n.end+y?(s=f,uu.BufferHole):(s=m,uu.LowBuffer):(s=f,uu.HighBuffer);var o=r+Math.max(100,1e3*s);return o-i<=0?(d=r,l.next(Qh(a,u,r,n,g,p.haveEnough,p.gotPlaying)),Se):rr(o-i).pipe(Ae(e.bind(null,!0)))})))}))):be(null)}),Jr()),i=t.pipe(Ae(e=>e?_n([a.seeking$,a.paused$]).pipe(Ae(([e,t])=>{if(e||t)return Se;let i=a.currentTime;return ol(Bn(Pe,a.timeupdate$),()=>{var e=i;return(i=a.currentTime)>e}).pipe(ve(()=>(performance.now(),null)))})):Se));return Bn(t,i)}((this.R,this.jr),this.Zt).pipe(Ee(e=>{T.setStallInfo(e)})),this.mediaQuery.stallInfo$.pipe((r=T,n=(i=this).Zt,a=this.R,e=>e.pipe(Vr(e=>{if(e){var h=i,t=r,p=n,m=a;const f=h.mediaQuery;return Bn(_n([f.seekTo$,f.nudgeTarget$]).pipe(Ur(([e,t])=>e&&fe(e.pos)&&fe(t)&&(e.pos<t||e.pos-t>p.maxSeekHole)),xr(null)),f.stallInfo$).pipe(cn(f.desiredRate$),pr(Zi),ve(([e,i],r)=>{if(e){var n=f.getCombinedBufferInfo(e.currentTime,0),i=fh(i);{var a=h,s=p,o=m,l=e,e=i,i=r,{type:r,isLowBufferStall:l,currentTime:d}=l,u=n.len,c=s.maxSeekHole;let t=NaN;if(l){const o=n.nextStart-d<=c?n.nextStart:1/0;if(fe(o))t=o;else if(a.mediaQuery.msDuration-d<s.nudgeOffset)t=d+s.nudgeOffset;else if(0<a.mediaQuery.getContentGapRanges().length){const s=a.mediaQuery.getContentGapRanges();for(let e=0;e<s.length;e++)if(!(s[e].start<d)&&s[e].start-d<=c){t=s[e].start;break}}}else if(i<s.nudgeMaxRetry)t=d+s.nudgeOffset;else if(e)o.error(`still stuck in high buffer @${d} after ${s.nudgeMaxRetry}, non fatal in iframeMode`);else{o.error(`still stuck in high buffer @${d} after ${s.nudgeMaxRetry}, raise fatal error`);const l=new Nh(q.BUFFER_STALLED_ERROR,!0,pe.VideoDecoderBadDataErr,r,u);if(!a.errorRecovery||!a.errorRecovery.shouldAttemptErrorRecovery(l))throw l;a.errorRecovery.recoverFromFatalError()}return fe(t)&&a.nudgeSeek(t,i+1),t}}return NaN}),sn(e=>fe(e)),Hr(()=>{t.setNudgeInfo(null)}))}return be(NaN)})))),(t=this.mediaQuery,s=T,o=l.maxBufferHole,ol(t.readyState$,e=>e>=HTMLMediaElement.HAVE_METADATA).pipe(Ae(()=>t.bufferMonitorThresholds$),Ae(e=>fe(null==e?void 0:e.lowWaterLevelSeconds)&&fe(null==e?void 0:e.highWaterLevelSeconds)?Ah(t,o):Se),Te(ah),Ee(({combined:e,sbTuple:t})=>{s.updateWaterLevels(e,t)})))):Se;var i,r,n,a,t,s,o})),v=l["contentGapPlaythroughIntervalSeconds"],I=1e3*v,S=this.mediaQuery.hasGaps$().pipe(Ae(e=>e?br([this.mediaQuery.timeupdate$,this.mediaQuery.desiredRate$]).pipe(pr(Zi),Ae(([e,t])=>e===this.mediaQuery.avoidContentGap(e,this.Zt.timeAccuracyThresholdSeconds,this.R)?Se:0===t?(this.qr.pause(!0),Se):(b.paused&&this.play(),function(e,t){e=0<arguments.length&&void 0!==e?e:0;return rr(e=e<0?0:e,e,1<arguments.length&&void 0!==t?t:Zi)}(I).pipe(ve(()=>{var e=this.mediaQuery.currentTime+v,t=e>this.msDuration;return this.seekWithOptions(e,void 0,!1,!1,!0),t&&this.pause(),t}),sn(e=>!e))))):Se));Bn(i,r,a,s,y,n,S).pipe(Ae(()=>Se),Hr(()=>{this.toggleTrickPlaybackMode(!1),T.remove(t),this.qr.uninstall(),this.qr=void 0,this.Br=void 0,this.errorRecovery=void 0,T.logger=void 0})).subscribe(e)}),this.Js=b,this.wr=T,this.Zt=e,this.R=r,this.Qr=n,this.Ur=a,this.Vr=new Ie,this.$r=new jr(null),this.Hr=new jr(!0),this.Kr=new vh,this.jr=new Eh(b,T,this.R),this.R=r.child({name:"mse"}),this.Wr(b),this.qr=new wh(this,b,e,this.R,this.Ur),this.Br=t,this.errorRecovery=i}get Gr(){return this.$r.value}get Xr(){var e;return null!=(e=null==(e=this.Gr)?void 0:e.sourceBuffers)?e:[]}get needSourceBuffers(){return!this.Xr[0]}get mediaQuery(){return this.jr}Yr(e){var t=null==(t=null==(t=this.Gr)?void 0:t.sourceBuffers)?void 0:t[e];return t?nh.timeRangesToBufferedRange(t.sourceBuffer.buffered):null}Wr(e){this.Sn=e.addTextTrack("metadata","id3"),this.Sn.mode="hidden"}checkForInconsistentStoreBufferRangesAndUpdate(){var e=nh.timeRangesToBufferedRange(this.Js.buffered),t=this.Yr(B.Variant),i=this.Yr(B.AltAudio),r=null!=(r=null==(r=this.mediaQuery.sourceBufferEntityByType(B.Variant))?void 0:r.bufferedRanges)?r:null,n=null!=(n=null==(n=this.mediaQuery.sourceBufferEntityByType(B.AltAudio))?void 0:n.bufferedRanges)?n:null;this.Jr(t,r)&&this.Zr(e,B.Variant),this.Jr(i,n)&&this.Zr(e,B.AltAudio)}updateInFlightRange(e,t){this.wr.updateInFlightRange(Ks(e),t)}Jr(e,i){return!(null==e&&null==i||(null==e?void 0:e.length)==(null==i?void 0:i.length)&&!e.find(t=>{var e=Ao.search(i,e=>t.start>=e.start&&t.end<=e.end?0:t.end<e.start?-1:1);return null==e||e.start!=t.start||e.end!=t.end||void 0}))}Zr(e,t){var i=this.Yr(t);i&&!this.mediaQuery.sbUpdating(t)&&this.wr.setBufferedRangesUpdated(t,i,e,!1,this.Zt.maxBufferHole,!1)}destroyMediaSource(){this.$r.next(null)}reset(){this.stopMonitors(),this.textTracksCreated=!1,this.primaryContentDuration=0,this.clearLiveSeekableRange()}makeMediaSource(){return new(Ju(this.Zt.preferManagedMediaSource))}openMediaSource(t){const i=this.makeMediaSource();Oe(()=>{var e;i?(e=new Bh(this.Js,this.wr,this.mediaQuery,i,this.R,t),this.$r.next(e)):this.$r.next(null)})}createSourceBuffers(e){var t=this.Gr;if(!t)throw new me(!0,pe.SBEmptyMediaSource);t.createSourceBuffers(e,this.Zt)}oo(i){const r=this.mediaQuery.mediaSourceEntity.objectUrl;return br([this.mediaQuery.msReadyState$,this.mediaQuery.msObjectUrl$]).pipe(Ae(([e,t])=>t!==r?be(null):"open"===e||"ended"===e?be(i):Se))}get ao(){return this.mediaQuery.isIframeRate?[B.Variant,B.AltAudio]:[B.AltAudio,B.Variant]}uo(e){e.forEach(e=>{null!=e&&e.dataSeg&&(e.dataSeg.flushBeforeAppend={start:0,end:0})})}do(e){return e.reduce((e,t)=>{t=!t||null==(t=t.dataSeg)?void 0:t.switchPosition;return fe(t)?fe(e)?Math.min(e,t):t:e},void 0)}checkForReplay(){var e=this.Js;e.paused&&!e.seeking&&e.duration&&e.currentTime&&e.currentTime>=e.duration-this.Zt.maxTotalDurationTolerance&&(this.seekTo=0)}isCompatibleWithSourceBuffers(e){return Kh(e,this.wr,this.Gr,this.mediaQuery.sourceBufferEntities,this.mediaQuery.expectedSbCount,this.Zt.changeType?Object.assign(Object.assign({},this.Zt),{changeType:!1}):this.Zt)}resetMediaSourceIfNeeded(i,r){const{mediaQuery:n,wr:e}=this,t=n["sourceBufferEntities"],a=n.getActive()["expectedSbCount"];if(!t||this.needSourceBuffers)return this.oo(i);const s=Kh(i,e,this.Gr,t,a,this.Zt);if(s.compatible)return this.oo(i);let o=s.boundary;const l=s.allowance,d=this.do(i);if(fe(d)&&(o=d),!fe(o))return be(null);const u=n.getCombinedBufferInfo(n.currentTime,this.Zt.maxBufferHole);var c=fh(this.mediaQuery.desiredRate)?rr(1e3*(u.end-n.currentTime)):Wr(ol(br([Bn(be(n.currentTime),n.timeupdate$),n.seekToPos$]),([e,t])=>0===u.len||o-e<=.001||o-t<=.001).pipe(ve(([e,t])=>o-e<=.001?e:t)),ol(n.stallInfo$.pipe(ve(e=>{return null!=(e=null==e?void 0:e.currentTime)?e:NaN})),e=>e>=o-l-this.Zt.discontinuitySeekTolerance));return this.wr.waitingForDisco=!0,c.pipe(ve(()=>o),Ae(e=>{performance.now();var t=n.currentTime,e=this.vo(r,e,t);return this.resetMediaSource(Math.max(t,e),s.discoSeqNum,this.msDuration),this.oo(i).pipe(Ee(()=>{var e,t,i,r,n;performance.now(),this.liveSeekableRange&&({start:e,end:t,edge:i,boundary:r,tupdate:n}=this.liveSeekableRange,this.updateLiveSeekableRange(e,t,i,r,n))}))}),Hr(()=>{this.wr.waitingForDisco=!1}))}vo(e,t,i){let r=t;t=null==(t=null==(t=this.Xr[we.Variant])?void 0:t.bufferedSegments)?void 0:t.length;return r=t&&e&&this.Xr[we.Variant].bufferedSegments[t-1].frag.itemId!==e.itemId?fe(e.initialSeekTime)?e.initialSeekTime:Le(e):r}resetMediaSource(e=NaN,t,i){var r=this.mediaQuery.seekTo;r&&fe(r.pos)&&(e=r.pos,t=r.discoSeqNum),fe(e)||(e=this.mediaQuery.currentTime),this.restartMonitors(),Oe(()=>{0<this.Xr.length&&(this.openMediaSource(i),this.seekWithOptions(e,t,!1,!1))})}setExpectedSbCount(e){this.wr.expectedSbCount=e}get expectedSbCount(){return this.mediaQuery.expectedSbCount}createFreeBox(e,t,i){var r=t.itemId,e=this.mediaQuery.getBufferedSegmentsByType(e),e=e[e.length-1],n=(null==(n=this.Br.playingItem)?void 0:n.itemId)!==r&&e&&e.frag.itemId!==r,a=e&&(null==e?void 0:e.frag.discoSeqNum)!==t.discoSeqNum;if(this.Zt.appendFreeBoxOnContentChange&&this.Br.inGaplessMode&&(n||a)){const e=a?r+`_disco:`+t.discoSeqNum:r,i=y.mzid(e);return y.free(i)}}po(e,t,i){var{mediaQuery:r,R:n}=this,a=null==(a=this.Xr)?void 0:a[e],r=null==(r=r.sourceBufferEntities)?void 0:r[e];if(null==t||!t.initSeg)return sl;if(!a||!r)throw new me(!0,pe.SBNotInitialized,`_appendInitSegment ${B[e]} not initialized buffer=${a} entity=`+r);t=t["initSeg"],r=r.initSegmentInfo;if((s=hh(t))&&r&&s.itemId===r.itemId&&s.mediaOptionId===r.mediaOptionId&&s.discoSeqNum===r.discoSeqNum&&s.keyId===r.keyId)return sl;var s=[a.appendBuffer(t.data,t).pipe()],r=this.createFreeBox(e,t,n);if(r){const e=a.appendBuffer(r,t).pipe();s.unshift(e)}n=js(e);return Lr(...s).pipe(i(a,n,t.mediaOptionId,this.Zt,this.mediaQuery))}yo(e,t,i){const r=this["mediaQuery"],n=null==(d=this.Xr)?void 0:d[e],a=null==(d=r.sourceBufferEntities)?void 0:d[e];if(null==t||!t.dataSeg)return sl;if(!n||!a)throw new me(!0,pe.SBNotInitialized,`_sbAppendData ${B[e]} not initialized buffer=${n} entity=`+a);const s=a.initSegmentInfo,{dataSeg:o,offsetTimestamp:l}=t;if(!s)throw new me(!0,pe.SBNullCurrentInitSegmentInfo,`appendDataSegments: sb[${qs[e]}] null currentInitSegmentInfo`);if(!a)throw new me(!0,pe.SBNullCurrentSBEntity,`appendDataSegments: sb[${qs[e]}] null currentSbEntity`);if(!n)throw new me(!0,pe.SBNullSourceBuffer,`appendDataSegments: sb[${qs[e]}] null source buffer`);var d=C(o.startPts);let u=-1*C(l);n.updateMp3Timestamps&&.1<Math.abs(n.timestampOffset-d)&&(u=d+u);const c=n.timestampOffset!==u,h=d+u,p=C(o.endPts)+u,m=o.firstKeyframePts?C(o.firstKeyframePts)+u:void 0,{part:f,partIndex:g}=o,y={startPTS:h,endPTS:p,firstKeyframePts:m,bytes:o.data2?o.data1.byteLength+o.data2.byteLength:o.data1.byteLength,partialFrag:o.partialFrag,frag:{itemId:o.itemId,mediaOptionId:o.mediaOptionId,mediaOptionType:o.mediaOptionType,mediaSeqNum:o.mediaSeqNum,discoSeqNum:o.discoSeqNum,keyTagInfo:o.keyTagInfo,isLastFragment:o.isLastFragment,iframe:o.iframe,framesWithoutIDR:o.framesWithoutIDR,dropped:o.dropped,part:f,partIndex:g}},v=js(e);let I=Pe;d=t.dataSeg.flushBeforeAppend,d&&d.start!==d.end&&(I=this.flushData(e,d.start,d.end)),t={fragmentType:we.Variant,bytesAppend:0,startAppend:1/0,endAppend:-1/0};return I.pipe(Ae(()=>be(o.data1,o.data2).pipe(Yl()).pipe(Pr(e=>n.appendBuffer(e,y,u).pipe(i(n,v,o.mediaOptionId,this.Zt,this.mediaQuery))))),wr((e,t)=>(e.bytesAppend+=t.bytesAppend,e.startAppend=Math.min(t.startAppend,e.startAppend),e.endAppend=Math.max(t.endAppend,e.endAppend),e),t),Ee(()=>{r.getBufferedRangeByType(e),c&&this.wr.setTimestampOffset(e,n.timestampOffset)}))}appendDataSegments(t,i){var e=this.ao.map(e=>{if(null==t[e])return null;const r={sbType:e,initAppend:null,dataAppend:null};return Lr(Mn(()=>this.po(e,t[e],i)),Mn(()=>this.yo(e,t[e],i))).pipe(wr((e,t,i)=>(0===i?r.initAppend=t:r.dataAppend=t,e),r))}).filter(e=>Boolean(e));return 0===e.length?be([]):Pn(e)}adjustJaggedStart(e){const{mediaQuery:t,R:i}=this,{sourceBufferEntities:n,seekTo:a}=t;if(!n)throw new me(!0,pe.SBNullCurrentSBEntity);const s=t.desiredPos;if(t.avoidContentGap(s,0,i)===s){var o=fe(this.Zt.jaggedSeekTolerance)?this.Zt.jaggedSeekTolerance:0;let r=NaN;if(n.forEach((e,t)=>{if(e){var i=nh.getBufferedInfo(e.bufferedRanges,s,0);if(0===i.len){const e=i["nextStart"];fe(e)&&(!fe(r)||e>r)&&(r=e)}}}),fe(r)&&e.end>r&&r-s>o){const t=e.start;fe(t)&&fe(null==a?void 0:a.startPos)&&a.startPos>=t&&s+this.Zt.maxSeekHole<t||(this.seekTo=r)}}}So(e,t){const i=this.Js.textTracks[e];i&&t.forEach(e=>{i.addCue(e)})}wo(e,t,i){return 0===e.buffered.length?Pe:e.remove(t,i).pipe()}flushAll(i,r,n=!1){return 0===this.Xr.length?Pe:Pn(this.Xr.map((e,t)=>e?this.flushData(t,i,r,n):Pe)).pipe(xr(void 0))}flushAndCallback(e,t,i){this.Vr.next({start:e,end:t,cb:i})}flushData(t,o,l,d=!1){var e=this["mediaQuery"];return ol(e.updating$,e=>!1===e).pipe(Ae(()=>{const r=this.Xr[t];if(!r)return Pe;let n,a,s=Pe;var e=-1===navigator.userAgent.toLowerCase().indexOf("firefox");if(this.flushing=!0,e)return this.wo(r,o,l);for(let i=0;i<r.buffered.length;i++){let e,t;n=r.buffered.start(i),a=r.buffered.end(i),t=l===1/0?(e=o,l):(e=Math.max(n,o),Math.min(a,l)),Math.min(t,a)>e&&(d||.5<Math.min(t,a)-e)&&(s=s.pipe(Ae(()=>this.wo(r,e,t))))}return s}),Hr(()=>{this.flushing=!1}))}static convertInitSegToCompatInfo(e){return{mimeType:e.mimeType,audioCodec:e.initParsedData.audioCodec,videoCodec:e.initParsedData.videoCodec,startPTSSec:void 0,endPTSSec:void 0,discoSeqNum:e.discoSeqNum,mediaOptionId:e.mediaOptionId}}static combineAppendDataInfoWithCompatInfo(e,t,i,r,n=0){const a=[...t];e.forEach((e,t)=>{null!=e&&e.initSeg&&(a[t]=Hh.convertInitSegToCompatInfo(e.initSeg)),1===r&&(a[1]=null)});var t=null==(t=a[B.Variant])?void 0:t.videoCodec,s=Cc(t);if(i&&i.has(s)){const e=i.get(s);a[B.Variant].mimeType=a[B.Variant].mimeType.replace(t,e),a[B.Variant].videoCodec=e}return a}static maxDurationFromAppendDataTuple(e){return e.reduce((e,t)=>t&&fe(t.duration)?Math.max(t.duration,e):e,0)}Io(e){const t=e.sourceBufferEntities,i=[null,null];return null!=t&&t.forEach((e,t)=>{e&&(i[t]={mimeType:e.mimeType,audioCodec:e.audioCodec,videoCodec:e.videoCodec,startPTSSec:void 0,endPTSSec:void 0,discoSeqNum:void 0,mediaOptionId:null==(t=e.initSegmentInfo)?void 0:t.mediaOptionId})}),i}avAppend(e,t,i,r,n){const{mediaQuery:a,R:s}=this,d=a.expectedSbCount,u=this.Io(a);return t.every(e=>null==e)?be([null,null]):(null==e?this.resetMediaSourceIfNeeded(t,r):be(t)).pipe(Dr(1),Ae(e=>{if(!e)return be([null,null]);let o=NaN,l=NaN;if(this.needSourceBuffers){o=performance.now();const i=Hh.combineAppendDataInfoWithCompatInfo(e,u,n,d,s);this.createSourceBuffers(i),l=performance.now(),this.uo(e)}var t=Hh.maxDurationFromAppendDataTuple(e);return(!fe(this.msDuration)||this.msDuration<t)&&(this.msDuration=t),e.forEach(e=>{e=null==e?void 0:e.dataSeg;null!=e&&e.cues&&fe(null==e?void 0:e.texttrackIdx)&&this.So(e.texttrackIdx,e.cues)}),this.appendDataSegments(e,i).pipe(ve(e=>{var t,i=[null,null];for(const r of e){const{sbType:e,initAppend:n,dataAppend:a}=r,s={fragmentType:js(e),bufferCreationStart:e===B.Variant?o:NaN,bufferCreationEnd:e===B.Variant?l:NaN,startInitAppend:null!=(t=null==n?void 0:n.startAppend)?t:NaN,endInitAppend:null!=(t=null==n?void 0:n.endAppend)?t:NaN,initBytesAppend:null!=(t=null==n?void 0:n.bytesAppend)?t:NaN,startDataAppend:null!=(t=null==a?void 0:a.startAppend)?t:NaN,endDataAppend:null!=(t=null==a?void 0:a.endAppend)?t:NaN,dataBytesAppend:null!=(t=null==a?void 0:a.bytesAppend)?t:NaN};i[e]=s}return i}))}),Dr(1))}endStream(){try{this.Gr.endOfStream()}catch(e){}}setMediaKeys(e,t){const i=performance.now();return this.Qr.wrap(this.Kr.lock(()=>yr(this.Js.setMediaKeys(e))).pipe(Ee(()=>{null!=t&&t.report(ps,{eventId:2,range:{tbegin:i,tend:performance.now()}})}),Xr(e=>e.pipe(Ae((e,t)=>{if(t<3)return rr(100*t);throw new me(!1,pe.KeySystemCouldNotCreateMediaKeySession)})))))}clearMediaKeys(){return Mn(()=>{var e,t;return this.Js?(null!=(t=(e=this.mediaQuery).getCombinedBufferInfo(e.currentTime,0))&&t.len?ol(e.combinedBuffer$,e=>!e).pipe(ve(()=>null)):Pe).pipe(Ae(()=>{const e=-1<navigator.userAgent.toLowerCase().indexOf("chrome");let t=this.setMediaKeys(null,null);if(e){const e=this.Js.src;this.Js.src="",t=t.pipe(Ee(()=>this.Js.src=e))}return t})):Pe})}set seekTo(e){this.seekWithOptions(e,void 0,!1)}seekWithOptions(e,t,i,r=!1,n){var a=this.liveSeekableRange,s=this.Js.currentTime,o=fe(this.Js.duration)?this.Js.duration:1/0;let l=0,d=o;if(i&&a){const{start:t,edge:i,end:n,tupdate:u}=a,c=(performance.now()-u)/1e3;if(l=Math.min(o,n,t+c),d=Math.min(o,n,i+c),!r&&e>=d&&s>=d)return!1}const u=Math.max(l,Math.min(d,e));return this.wr.setSeekToPos(u,!1,t,n,s),!0}updateContentGapRanges(e,r){var n=.25,a=null==(a=this.mediaQuery)?void 0:a.getContentGapRanges();if(a){let t=[...a],i=(t.sort((e,t)=>t.start-e.start),!0);for(let e=0;e<t.length;e++){const a=t[e];if(r.start>a.start-n&&r.start<a.start+n&&r.end>a.end-n&&r.end<a.end+n)return void(i=!1)}i&&(t.push(r),t.sort()),1<t.length&&(t=nh.getBufferedTimeRanges(t,n)),this.wr.updateContentGapRanges(t)}}nudgeSeek(e,t){Oe(()=>{this.wr.setSeekToPos(e),this.wr.setNudgeInfo({nudgeTarget:e,nudgeCount:t})})}set desiredRate(e){this.wr.desiredRate=e}toggleTrickPlaybackMode(e){if(this.Zt.overridePlaybackRate){const t=e?2:1;try{this.Js.playbackRate=t}catch(e){this.R.error({name:"iframes"},`Exception when setting playbackRate=${t}: `+e.message)}}const t=this.To;e&&void 0===t?(this.To=this.Js.muted,this.Js.muted=e):e||void 0===t||(this.Js.muted=t,this.To=void 0)}play(){this.qr.play()}pause(){this.qr.pause()}get expectPlayEvent(){return this.qr.expectPlayEvent}set expectPlayEvent(e){this.qr.expectPlayEvent=e}get expectPauseEvent(){return this.qr.expectPauseEvent}set expectPauseEvent(e){this.qr.expectPauseEvent=e}get expectSeekingEvent(){return this.mediaQuery.expectSeekingEvent}set textTracksCreated(e){var t=this["wr"];t.textTracksCreated=e}get msDuration(){return this.jr.msDuration}set msDuration(e){this.Gr.commitMediaSourceAndMediaElementStoreDuration(e)}set primaryContentDuration(e){this.wr.primaryContentMediaElementDuration=e}set haveEnough(e){this.wr.haveEnough=e}set flushing(e){this.wr.flushing=e}stopMonitors(){this.Hr.value&&this.Hr.next(!1)}startMonitors(){this.Hr.value||this.Hr.next(!0)}restartMonitors(){this.stopMonitors(),this.startMonitors()}set bufferMonitorTargetDuration(e){this.wr.bufferMonitorTargetDuration=e}get textTracks(){return this.Js.textTracks}get id3TextTrack(){return this.Sn}addTextTrack(e,t,i){return this.Js.addTextTrack(e,t,i)}dispatchEvent(e){return this.Js.dispatchEvent(e)}get offsetWidth(){return this.Js.offsetWidth}get offsetHeight(){return this.Js.offsetHeight}get liveSeekableRange(){return this.mediaQuery.liveSeekableRange}get seekable(){return this.mediaQuery.seekable}archiveParsedSubtitleFragmentRecord(e,t,i){return this.wr.archiveParsedSubtitleFragmentRecord(e,t,i)}removeEarlierParsedSubtitleFragmentRecord(e){this.wr.removeOldSubtitleFragmentRecord(e)}removeLaterParsedSubtitleFragmentRecord(e){this.wr.removeLaterSubtitleFragmentRecord(e)}clearParsedSubtitleRecordsForMediaOption(e){return this.wr.clearParsedSubtitleFragmentRecord(e)}clearAllParsedSubtitleFragmentRecord(){return this.wr.clearAllParsedSubtitleFragmentRecord()}updateLiveSeekableRange(e,t,i,r,n){var a;const s=this.mediaQuery.liveSeekableRange,o=Math.max(null!=(a=null==s?void 0:s.start)?a:0,e),l=Math.max(null!=(a=null==s?void 0:s.end)?a:0,t),d=Math.max(null!=(e=null==s?void 0:s.edge)?e:0,i),u=Math.max(null!=(a=null==s?void 0:s.boundary)?a:0,r);Oe(()=>{this.wr.setLiveSeekableRange({start:o,end:l,edge:d,boundary:u,tupdate:n}),this.Gr.updateLiveSeekableRange(o,l)})}clearLiveSeekableRange(){null!=this.liveSeekableRange&&Oe(()=>{this.wr.setLiveSeekableRange(void 0),this.Gr.clearLiveSeekableRange()})}isPosBetweenJaggedStart(e){if(this.Zt.jaggedSeekTolerance&&this.Xr[B.Variant]&&this.Xr[B.AltAudio]){const i=this.mediaQuery.getBufferInfo(e,this.Zt.jaggedSeekTolerance),t=[B.Variant,B.AltAudio].reduce((e,t)=>{return i[t].buffered.len&&(t=i[t].buffered.start,e)?[Math.min(t,e[0]),Math.max(t,e[1])]:null},[Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY]);if(t&&t[1]-e<=this.Zt.jaggedSeekTolerance)return!0}return!1}addAirPlaySource(e){this.Gr.addAirPlaySource(e)}}const qh=(i,l,d,u,c,r,h,n,a)=>{if(!i)return Se;const e=yl(i),p=e=>{var t=e.currentTarget,i=t.readyState;l.readyState=i,l.ended=t.ended,"playing"!=e.type&&(e.type,t.currentTime.toFixed(3),t.duration.toFixed(3))};return Bn(e.event("durationchange").pipe(ve(e=>vl(i,"durationchange",e)),la(e=>{var t=e.currentTarget;l.mediaElementDuration=t.duration,p(e)})),e.event("seeking").pipe(ve(e=>vl(i,"seeking",e)),la(e=>{var t=e.currentTarget,i=t.currentTime;if(l.seeking=t.seeking,t.readyState>=t.HAVE_METADATA){const e=d.seekTo;if(!e||1e-5<Math.abs(e.pos-i)){if(!e||!e.fromEvent){if(c.inGaplessMode&&!h.enableInterstitialPlayback){var r=i;var n=c;var a=u;var s=l;let e=!1;var o=Le(n.playingItem),o=(r<o&&(r=o,e=!0),Le(n.loadingItem));n.isPreloading&&(o<r&&(r=o,e=!0),n.dequeueSource("SeekToUnbufferedTimeRanges")),e?a.resetMediaSource(r):s.setSeekToPos(r,!0);return}if(u&&!u.expectSeekingEvent&&(t.controls||h.nativeControlsEnabled)&&u.liveSeekableRange&&u.seekWithOptions(i,void 0,!0,!0))return}l.setSeekToPos(i,!0)}}p(e)})),e.event("seeked").pipe(ve(e=>vl(i,"seeked",e)),la(e=>{var t=e.target;l.seeking=t.seeking,p(e)})),e.event("play").pipe(ve(e=>vl(i,"play",e)),la(e=>{var t=e.currentTarget,i=(l.paused=t.paused,u.expectPlayEvent),t=t.controls||h.nativeControlsEnabled;!i&&t&&(u.checkForReplay(),l.desiredRate=1),u.expectPlayEvent=!1,p(e)})),e.event("playing").pipe(ve(e=>vl(i,"playing",e)),la(e=>{var t=e.currentTarget;l.paused=t.paused,l.gotPlayingEvent(),p(e)})),e.event("pause").pipe(ve(e=>vl(i,"pause",e)),la(e=>{var t=e.currentTarget,i=(l.paused=t.paused,u.expectPauseEvent),t=t.controls||h.nativeControlsEnabled;!i&&t&&(l.desiredRate=0),u.expectPauseEvent=!1,p(e)})),e.event("waiting").pipe(ve(e=>vl(i,"waiting",e)),la(e=>{p(e)})),Bn(e.event("loadedmetadata").pipe(ve(e=>vl(i,"loadedmetadata",e))),e.event("loadeddata").pipe(ve(e=>vl(i,"loadeddata",e))),e.event("canplay").pipe(ve(e=>vl(i,"canplay",e))),e.event("canplaythrough").pipe(ve(e=>vl(i,"canplaythrough",e))),e.event("emptied").pipe(ve(e=>vl(i,"emptied",e))),e.event("ended").pipe(ve(e=>vl(i,"ended",e)))).pipe(la(p)),e.event("error").pipe(Ae(e=>{var t=i.error;if(t instanceof MediaError&&h.attemptErrorRecovery&&r.shouldAttemptErrorRecovery(new s(t.message)))return r.recoverFromFatalError(),Se;throw t}))).pipe(ye(e=>{let t;try{var i,r;e instanceof MediaError?(r=(i=null==c?void 0:c.playingItem)&&ke(i),null!=a&&a.report(3,{mediaError:e,forInterstitial:r}),h.attemptErrorRecovery&&(t=new s(e.message))):n.error(`media event error: `+(null==e?void 0:e.message))}catch(e){n.error(`MediaError may be undefined on the platform: `+(null==e?void 0:e.message))}if(t)throw t;return Se}),Ae(()=>Se))};function Kh(e,s,o,l,t,d){const i=l.filter(e=>Boolean(e)).length,r=e.filter(e=>Boolean(e)).length,u=[null,null];e.forEach((r,n)=>{if(r){var a=r["offsetTimestamp"],s=r.initSeg.mimeType,{audioCodec:o,videoCodec:l}=r.initSeg.initParsedData,d=r["dataSeg"];let e=NaN,t=NaN,i=r.initSeg.discoSeqNum;if(d&&a){const r=C(a);e=C(d.startPts)-r,t=C(d.endPts)-r,fe(i)||(i=d.discoSeqNum)}u[n]={audioCodec:o,videoCodec:l,mimeType:s,startPTSSec:e,endPTSSec:t,discoSeqNum:i,mediaOptionId:r.initSeg.mediaOptionId}}});let c=i===t,n=r===t;if(1===r&&r<t&&0!==i){const s=e[we.Variant]?we.Variant:we.AltAudio,o=1-s,t=u[s],d=u[o]=function(e,t,i){const r=null==e?void 0:e.bufferedSegments;if(!r)return null;var n=r.find(e=>e.frag.discoSeqNum===t);if(null==n)return null;{const{audioCodec:a,videoCodec:r,mimeType:s}=e;return{mimeType:s,audioCodec:a,videoCodec:r,startPTSSec:n.startPTS,endPTSSec:n.endPTS,discoSeqNum:t,mediaOptionId:i}}}(l[o],t.discoSeqNum,t.mediaOptionId);if(!d&&s===we.Variant&&u[s]){const e=l[s].videoCodec,o=u[s].videoCodec;if(c=c&&(e===o||ge.isCompatibleVideoCodec(e,o)))return{compatible:c,boundary:NaN,allowance:NaN,discoSeqNum:u[s].discoSeqNum}}n=null!=d}let h=NaN,p=NaN,m=NaN;return n&&u.forEach((t,i)=>{if(!t)return null;fe(m)?m!==t.discoSeqNum&&(m=NaN):m=t.discoSeqNum;var r=l[i];if(r){const l=r.audioCodec,n=r.videoCodec,a=r.mimeType,{audioCodec:h,videoCodec:p,mimeType:m}=t;let e=d.changeType;if(e){const t=null==(r=o.sourceBuffers)?void 0:r[i];t&&(!!l==!!h&&!!n==!!p?a!==m&&"string"==typeof m&&(e=t.changeType(m))&&s.updateSourceBufferEntity(i,u[i]):e=!1)}e||(c=(c=c&&(n===p||ge.isCompatibleVideoCodec(n,p)))&&(l===h||ge.isCompatibleAudioCodec(l,h)))}else c=!1;h=fe(h)?(p=Math.abs(t.startPTSSec-h),Math.max(t.startPTSSec,h)):(p=0,t.startPTSSec)}),{compatible:c&&n,boundary:h,allowance:p,discoSeqNum:m}}function jh(e){return e.matches}class $h extends ma{constructor(e){super(e),this.store=e,this.displaySupportsHdr$=this.select("supportsHdr"),this.platformInfo$=this.select("platformInfo"),this.viewportInfo$=this.select("viewportInfo")}get platformInfo(){return this.getValue().platformInfo}get displaySupportsHdr(){return this.getValue().supportsHdr}get supportsHdrMediaQuery(){return this.getValue().supportsHdrMediaQuery}get viewportInfo(){return this.getValue().viewportInfo}}class Gh extends da{constructor(){super({supportsHdrMediaQuery:!1,supportsHdr:!0},{name:"platform"})}}class Wh{constructor(e){this.Me=e,this._i=new $h(e)}get query(){return this._i}updateSupportsHdr(e,t){this.Me.update({supportsHdr:e,supportsHdrMediaQuery:t})}updatePlatformInfo(e){this.Me.update({platformInfo:e})}updateViewportInfo(e){this.Me.update({viewportInfo:e})}}function zh(e){let t=!1;var i=""!==e.identifier,r=0<e.urls.length,n=fe(null==(n=e.startTime)?void 0:n.baseTime)||fe(e.startDate);return t=i&&r&&n?!0:t}const Yh={ID:(e,t)=>Object.assign(Object.assign({},e),{identifier:t}),"START-DATE":(e,t,i,r,n)=>{var t=new Date(Date.parse(t)).getTime(),[r,n]=J(t,null!=r?r:[],null!=n?n:[]),t=t&&null!=n?t-r+1e3*n:NaN;return Object.assign(Object.assign({},e),{startTime:{baseTime:t,timescale:1e3}})},DURATION:(e,t)=>Object.assign(Object.assign({},e),{duration:parseFloat(t)}),"X-ASSET-LIST":(e,t)=>Object.assign(Object.assign({},e),{urls:[t]}),"X-ASSET-URI":(e,t)=>Object.assign(Object.assign({},e),{urls:[t]}),"X-RESUME-OFFSET":(e,t)=>Object.assign(Object.assign({},e),{resumptionOffset:{baseTime:1e3*parseFloat(t),timescale:1e3}}),"X-PLAYOUT-LIMIT":(e,t)=>Object.assign(Object.assign({},e),{playoutLimit:{baseTime:1e3*parseFloat(t),timescale:1e3}}),"X-SNAP":(e,t)=>{var i=-1<t.indexOf("IN"),t=-1<t.indexOf("OUT");let r=Sa.None;return i&&t?r=Sa.InOut:i?r=Sa.In:t&&(r=Sa.Out),Object.assign(Object.assign({},e),{snapOptions:r})},"X-RESTRICT":(e,t)=>{var i=-1<t.indexOf("SKIP"),t=-1<t.indexOf("JUMP");let r=ba.None;return i&&t?r=ba.SkipJump:i?r=ba.Skip:t&&(r=ba.Jump),Object.assign(Object.assign({},e),{referenceRestrictions:r})},"X-CONTENT-MAY-VARY":(e,t)=>Object.assign(Object.assign({},e),{contentMayVary:"YES"===t}),"X-TIMELINE-STYLE":(e,t)=>Object.assign(Object.assign({},e),{timelineStyle:"PRIMARY"===t?Ta.Primary:Ta.Highlight}),"X-TIMELINE-OCCUPIES":(e,t)=>Object.assign(Object.assign({},e),{timelineOccupancy:"RANGE"===t?Aa.Range:Aa.Point}),CUE:Xh,"X-CUE":Xh,default:(e,t,i)=>{return 0!==(null==i?void 0:i.indexOf("X-"))||((e=Object.assign({},e)).extraAttributes[i]=t),e}};function Xh(e,t){let i=Ia.Midroll,r=(-1<t.indexOf("PRE")?i=Ia.Preroll:-1<t.indexOf("POST")&&(i=Ia.Postroll),!1);return-1<t.indexOf("ONCE")&&(r=!0),Object.assign(Object.assign({},e),{cueType:i,playOnce:r})}function Jh(i,e){var{daterangeTags:t,pdtToMSN:r}=i;let n=[];return n=t&&!ke(i)&&e.allowServerGeneratedInterstitials&&0<r.length?Object.entries(t).reduce((e,[,t])=>{t=function(e,t,i){if(!e||"com.apple.hls.interstitial"!==e.CLASS)return null;let r={extraAttributes:{},resumptionOffset:{baseTime:NaN,timescale:1e3},identifier:"",cueType:Ia.Midroll,snapOptions:Sa.None,referenceRestrictions:ba.None,startTime:{baseTime:NaN,timescale:1e3},urls:[],hasPlayed:!1,playOnce:!1,assets:[],timelineOccupancy:Aa.Point,timelineStyle:Ta.Highlight,contentMayVary:!1};for(const a in e){var n;Object.prototype.hasOwnProperty.call(e,a)&&(n=e[a],r=(Yh[a]||Yh.default)(r,n,a,t,i))}return zh(r)?r:null}(t,i.pdtToMSN,i.fragments);return t&&e.push(t),e},[]):n}class Zh extends F{constructor(e,t){super(e=>{null!=t&&t.add(),e.add(this.Oo.pipe(Er(([e,t,i])=>e(...t).pipe(Ee({next(e){i(e,null)},error(e){i(null,e)}})))).subscribe())}),this.Mo=e,this.teardownWG$=t,this.Oo=new Ie}register(e,i){return this.Mo.register(e,(...t)=>e=>{this.Oo.next([i,t,e])})}invoke(e,t,r){return new F(i=>{this.Mo.invoke(e,t,r)((e,t)=>{null!=t?i.error(t):(i.next(e),i.complete())})})}}class ep extends Zh{constructor(e){super(e)}decrypt(e,t,i,r,n){return this.invoke("decrypt",[e,t,i,r,n],[e,t,r])}}class tp extends Zh{constructor(e){super(e),this.Ao=e,this.Eo={},this.No=(e,t,i)=>()=>{null!=this.Eo[e]&&this.Eo[e].observer.trigger(t,i)},this.Ao.register("demuxer.event",this.No)}init(e,t,i){return{maxSeekHole:r,maxBufferHole:n,audioPrimingDelay:a,stretchShortVideoTrack:s,forceKeyFrameOnDiscontinuity:o,remuxSampleAuxiliaryInfo:l}=[t][0],this.invoke("demuxer.init",[e,t={maxSeekHole:r,maxBufferHole:n,audioPrimingDelay:a,stretchShortVideoTrack:s,forceKeyFrameOnDiscontinuity:o,remuxSampleAuxiliaryInfo:l},i],[]).pipe(ve(e=>{var t=new ip(this,e);return this.Eo[e]=t}));var r,n,a,s,o,l}}class ip{constructor(e,t){this.N=e,this.Ro=t,this.observer=new h}push(e,t,i,r,n,a,s,o,l,d,u,c,h,p){return this.N.invoke("demuxer.push",[this.Ro,e,t,i,r,n,a,s,o,l,d,u,c,h],null!=(t=null==p?void 0:p.map(e=>e.buffer))?t:[e.buffer])}destroy(){this.observer.removeAllListeners(),this.N.invoke("demuxer.destroy",[this.Ro],[]).subscribe()}}class rp{constructor(){this.handlers={}}register(e,t){return null==this.handlers[e]&&(this.handlers[e]=t,!0)}unregister(e){return null==this.handlers[e]&&(delete this.handlers[e],!0)}invoke(e,i){return(t=rp._fallbackCallback)=>{try{if(null==this.handlers[e])throw new me(!0,pe.RPCInlineInvokeCommandNotFound,`command ${e} not found`);this.handlers[e](...i)(t)}catch(e){t(void 0,e)}}}teardown(e){this.handlers={},e()}}rp._fallbackCallback=(e,t)=>{if(null!=t)throw t};const np=e=>{e=e.child({name:"InlineRPCService"});var t=new rp;return new o(t,e),new Ut(t,e),t};let ap;const sp=t=>{try{if(null==ap){const t=new Blob(["var exports = {};var module = { exports: exports };function define(f){f()};define.amd = true;("+uv.toString()+")(true);"],{type:"text/javascript"}),r=URL.createObjectURL(t);ap=new Worker(r)}var e=new _t(ap);return i=e,a=t.child({name:"WorkerRPCService"}),i.register("logger.log",(i,r,...n)=>t=>{try{let e=a;for(const a of i)e=e.child(a);"function"==typeof e[r]&&e[r](...n),t()}catch(e){t(void 0,e)}}),e}catch(e){throw t.error("Failed to create WebWorker.",e),e}var i,a},op=(...r)=>t=>{for(let e=0;e<r.length;e++){var i=r[e];try{return i(t)}catch(t){if(e===r.length-1)throw t}}throw new me(!0,pe.createRPCServiceMissingFallbacks)},lp=e=>op(sp,np)(e);class dp{constructor(e,t,i){this.Po=t,this.R=i,this._o=null,this.Yi=e,this.Co=this.xo(),this.Do=[],this.Lo=[]}reset(){this.Yi=void 0,this._o=null,this.Do=[],this.Lo=[],this.Co=this.xo()}destroy(){this.reset()}setRTCQuery(e){this._o=e}setupReporter(e){this.Fo={SessionID:this.Po,ClientName:null==e?void 0:e.clientName,ServiceName:null==e?void 0:e.serviceName}}addPlayTime(e){var t=null==(t=this._o)?void 0:t.entity(e);t&&(e=t.sessionControlRecord,t=performance.now()-e.eventStartTime,"PLAY"===e.state)&&(this.Co.PlayTimeWC=(this.Co.PlayTimeWC||0)+t)}updatePlaybackInfo(e){var t;null!==e&&(this.Co.ViFrDr=(null==(t=null==(t=this._o)?void 0:t.entity(e))?void 0:t.sessionControlRecord.droppedVideoFrames)||0)}updateStallCount(e){var t;"PLAY"===(null==(e=null==(t=null==(t=this._o)?void 0:t.entity(e))?void 0:t.sessionControlRecord)?void 0:e.state)&&this.Co.StallCount++}updateMediaEngineStallCount(e){var t;"PLAY"===(null==(e=null==(t=null==(t=this._o)?void 0:t.entity(e))?void 0:t.sessionControlRecord)?void 0:e.state)&&this.Co.MediaEngineStallCount++}updateCanPlay(e){var t;this.Co.StartupTime=null!=(e=null==(t=null==(t=this._o)?void 0:t.entity(e))?void 0:t.sessionControlRecord.eventStartTime)?e:0}updateFragLoaded(e,t){var i;if(this.Yi){const{itemId:r,frag:n,stats:a}=t,{mediaOptionType:s,start:o,duration:l}=n,{loaded:d,tload:u,trequest:c}=a,h=d,p=u-c,m=o,f=o+l;if(s===we.Variant){this.Co.NetBytes+=h,this.Co.ADT+=p;const t=this.jo({bytes:h,adt:p},++this.Co.fragmentCnt,this.Co.NetBytes,this.Co.ADT),n=(this.Co.OBRLast=t.obrLast,this.Co.OBRMean=t.obrMean,this.Bo(this.Co,t.obr),null!=(i=this.Yi.realCurrentTime)?i:NaN);fe(n)&&n>m&&!e&&this.Co.overdue++,this.Uo(m,f,this.Co.lastStartPTS,this.Co.lastEndPTS)&&this.addToAccessLog(r),this.Co.startPTS||(this.Co.startPTS=m),this.Co.lastStartPTS=m,this.Co.lastEndPTS=f,this.Co.videoBytes+=h,this.Co.videoDuration+=l}else s===we.AltAudio&&(this.Co.audioBytes+=h,this.Co.audioDuration+=l)}}addToAccessLog(e){var t=this.$o(e),i=null==(i=null==(i=this._o)?void 0:i.entity(e))?void 0:i.sessionControlRecord.curLevelUrl,r=null==(r=null==(r=this._o)?void 0:r.entity(e))?void 0:r.playEndedRecord.PlayType;if(i&&""!==i&&this.Yi){i=this.Vo(e,i,t,r);if(i){const e=this.Do.length-20;0<e&&this.Do.splice(0,e),this.Do.push(i)}this.Co=this.xo();i=null==(r=null==(t=this._o)?void 0:t.entity(e))?void 0:r.switchCompleteRecord.MediaDur;this.Co.lastMediaDur=i||this.Yi.bufferedDuration}}addToErrorLog(e,t){var i=null==(i=this._o)?void 0:i.entity(e);if(i){var r=Number(("mediaError"===t?i.playErrorRecord:i.nwErrorRecord).ErrCode),i=i.sessionControlRecord.curLevelUrl,i=this.qo(e,i,{domain:t,code:r});if(i){const e=this.Lo.length-20;0<e&&this.Lo.splice(0,e),this.Lo.push(i)}}}getAccessLog(e){var t,i;const r=this.Do.slice(0),n=null==(t=this._o)?void 0:t.entity(e);if(r&&n){const t=n.sessionControlRecord.curLevelUrl;if(t&&""!==t){const n=this.$o(e),a=this.Vo(e,t,n,null==(i=null==(i=this._o)?void 0:i.entity(e))?void 0:i.playEndedRecord.PlayType);a&&(a["c-provisional-entry"]=!0,r.push(a))}}return r}get errorLog(){return this.Lo}xo(){return{fragmentCnt:0,overdue:0,startPTS:0,obrMax:0,obrMin:0,audioBytes:0,audioDuration:0,videoBytes:0,videoDuration:0,svrAddrChanged:0,svrAddr:"",PlayTimeWC:0,ViFrDr:0,StallCount:0,MediaEngineStallCount:0,ADT:0,NetBytes:0,StartupTime:0,OBRMean:0,OBRLast:0}}zo(e){return e?"object"==typeof e?e.toString():e:""}Ho(t){var i=Va.parseURL(t);if(i&&i.netLoc){const t=i.netLoc.indexOf(":");let e=0<=t?i.netLoc.slice(0,t):i.netLoc;e.startsWith("//")&&(e=e.slice(2)),this.Co.svrAddr?e!==this.Co.svrAddr&&this.Co.svrAddrChanged++:this.Co.svrAddrChanged=0,this.Co.svrAddr=e}}Vo(e,t,i,r){t=this.zo(t);this.Ho(t);let n=null==(a=null==(a=this._o)?void 0:a.entity(e))?void 0:a.switchCompleteRecord.MediaDur;n=(n=n||this.Yi&&this.Yi.bufferedDuration||0)||0;var a={uri:t,"s-ip":this.Co.svrAddr,"s-ip-changes":this.Co.svrAddrChanged,"sc-wwan-count":-1,"c-transfer-duration":this.Co.ADT,bytes:this.Co.NetBytes,"c-total-media-requests":this.Co.fragmentCnt,"cs-guid":this.Fo?null==(e=this.Fo)?void 0:e.SessionID:"undefined","c-start-time":this.Co.startPTS,"c-startup-time":this.Co.StartupTime,"c-duration-watched":this.Co.PlayTimeWC/1e3,"c-frames-dropped":this.Co.ViFrDr,"c-stalls":this.Co.StallCount+this.Co.MediaEngineStallCount,"c-duration-downloaded":this.Co.lastMediaDur?n-this.Co.lastMediaDur:n,"c-overdue":this.Co.overdue,"c-avg-video-bitrate":8*this.Co.videoBytes/(this.Co.videoDuration||1),"c-observed-max-bitrate":this.Co.obrMax,"c-observed-min-bitrate":this.Co.obrMin,"sc-indicated-bitrate":i.bandwidth||0,"sc-indicated-avg-bitrate":i.avgBandwidth||0,"c-observed-bitrate":this.Co.OBRMean,"c-switch-bitrate":this.Co.OBRLast,"c-provisional-entry":!1};return a["s-playback-type"]=r,this.Co.audioBytes&&(a["c-avg-audio-bitrate"]=8*this.Co.audioBytes/(this.Co.audioDuration||1)),a}qo(e,t,i){t=this.zo(t);return this.Ho(t),{date:new Date,"cs-guid":this.Fo?this.Fo.SessionID+"-"+e:"undefined",uri:t,"s-ip":this.Co.svrAddr,status:""+i.code,domain:i.domain}}Uo(e,t,i,r){return void 0!==e&&void 0!==i&&(1<e-(r=void 0===r?0:r)||1<i-t)}jo(e,t,i,r){i=8*i/(r/1e3);return{obr:i,obrLast:8*e.bytes/(e.adt/1e3),obrMean:i/t}}Bo(e,t){(!e.obrMax||t>e.obrMax)&&(e.obrMax=t),(!e.obrMin||t<e.obrMin)&&(e.obrMin=t)}$o(e){var t=null==(t=null==(t=this._o)?void 0:t.entity(e))?void 0:t.sessionControlRecord.curLevelUrl,i=null==(e=null==(i=null==(i=this._o)?void 0:i.entity(e))?void 0:i.sessionControlRecord.manifestData)?void 0:e.variantList;return t&&i&&i[t]?i[t]:{}}}class up{constructor(e){this.Qo=e}entity(e){return this.Qo.getEntity(e)}playEnded(e){return null==(e=this.Qo.getEntity(e))?void 0:e.playEndedRecord}periodic(e){return null==(e=this.Qo.getEntity(e))?void 0:e.periodicRecord}sessionControlRecord(e){return null==(e=this.Qo.getEntity(e))?void 0:e.sessionControlRecord}playStalled(e){return null==(e=this.Qo.getEntity(e))?void 0:e.playStalledRecord}mediaEngineStalled(e){return null==(e=this.Qo.getEntity(e))?void 0:e.mediaEngineStalledRecord}keySessionComplete(e){return null==(e=this.Qo.getEntity(e))?void 0:e.keySessionCompleteRecord}playLikelyToKeepUp(e){return null==(e=this.Qo.getEntity(e))?void 0:e.playLikelyToKeepUpRecord}playRateChanged(e){return null==(e=this.Qo.getEntity(e))?void 0:e.playRateChangedRecord}switchComplete(e){return null==(e=this.Qo.getEntity(e))?void 0:e.switchCompleteRecord}seekComplete(e){return null==(e=this.Qo.getEntity(e))?void 0:e.seekCompleteRecord}variantEnded(e){return null==(e=this.Qo.getEntity(e))?void 0:e.variantEndedRecord}playError(e){return null==(e=this.Qo.getEntity(e))?void 0:e.playErrorRecord}nwError(e){return null==(e=this.Qo.getEntity(e))?void 0:e.nwErrorRecord}debugInfo(e){return null==(e=this.Qo.getEntity(e))?void 0:e.debugInfoRecord}interstitialPlayTime(e){return null!=(e=null==(e=this.Qo.getEntity(e))?void 0:e.periodicRecord.InterstitialPlayTime)?e:0}errorRecovery(e){return null==(e=this.Qo.getEntity(e))?void 0:e.errorRecoveryRecord}}(i=hu=hu||{})[i.AudioCodec=0]="AudioCodec",i[i.VideoCodec=1]="VideoCodec",i[i.HdcpLevel=2]="HdcpLevel",i[i.SecurityLevel=3]="SecurityLevel",i[i.KeySystemAccess=4]="KeySystemAccess",i[i.MediaCapabilities=5]="MediaCapabilities",i[i.MediaSource=6]="MediaSource",i[i.PlatformCaps=7]="PlatformCaps",i[i.VideoRange=8]="VideoRange";class cp{constructor(e,t=10){this.R=e,this.Ko=t,this.Rs={}}createEntity(e,t,i,r=!1,n=void 0,a){t={itemId:e,sessionControlRecord:{state:"INIT",rate:0,oldRate:0,eventStartTime:performance.now(),sessionStartTime:performance.now(),lastLikelyToKeepUpTime:performance.now(),lastPeriodicTime:performance.now(),lastWaitForCanPlay:performance.now(),playLikelyToKeepUpEventCounter:1,periodicEventCounter:1,keySessionCompleteEventCounter:1,activeKeySessions:{},intervalVariantList:{},sessionVariantList:{}},playEndedRecord:{HLSJSVersion:t,InterstitialsEnabled:i,IsLoopingPlayer:r},periodicRecord:{},playStalledRecord:{},keySessionCompleteRecord:{},playLikelyToKeepUpRecord:{},playRateChangedRecord:{},playErrorRecord:{},mediaEngineStalledRecord:{},switchCompleteRecord:{},variantEndedRecord:{},nwErrorRecord:{},debugInfoRecord:{},seekCompleteRecord:{},errorRecoveryRecord:{}};n&&(t.playEndedRecord.TestGroupId=n),a&&(t.playEndedRecord.HdcpLevel=a),this.Rs[e]=t}addEntity(e){this.Rs[e.itemId]=e}removeEntityByID(e){delete this.Rs[e]}resetStore(){this.Rs={}}getEntity(e){if(e)return this.Rs[e]}getAllItemIds(){return Object.keys(this.Rs)}updateEnded(e,r){var n=this.getEntity(e);if(n){var{sessionControlRecord:n,playEndedRecord:a}=n,s=(a.AvgVideoBitrate=8*(n.sessionVideoBytes||0)/(n.sessionVideoDuration||1),a.AvgAudioBitrate=8*(n.sessionAudioBytes||0)/(n.sessionAudioDuration||1),1e3*Math.round((a.NetBytes||0)/1e3)),o=(a.NetBytes=s,a.ADT||1),l=o+(a.SegmentProcessTime||1),d=o+(a.SegmentProcessTime||0)+(a.SegmentParseTime||1),o=(a.TWOBR=8*s/(o/1e3),a.PerceivedTWOBR=8*s/(l/1e3),a.NetTWOBR=8*s/(d/1e3),this.Wo("PLAY"===n.state?performance.now()-n.eventStartTime:0,n.sessionVariantList||{},n.curLevelUrl)),s=(a.PlayerTWIBR=o.twIBR,a.PlayerTWIABR=o.twIABR,a.TWBitRk=o.twBRnk,null!=(l=n.curLevelUrl)?l:n.levelUrlLoaded),d=this.Go(s,n);a.TargetDur=d.targetduration,a.Codecs=d.codecs,a.VariantList=null==(o=n.manifestData)?void 0:o.varListString;let t="",i=(n.playlistMimeTypes&&(n.playlistMimeTypes.forEach(e=>{t+=e+","}),t=t.slice(0,-1)),"");n.segmentMimeTypes&&(n.segmentMimeTypes.forEach(e=>{i+=e+","}),i=i.slice(0,-1)),a.PlaylistMimeType=t,a.SegmentMimeType=i,a.Rate=n.rate,a.CurrentMediaTime=fe(r)?1e3*r:void 0;l=this.Xo(n.bufferedRangeTuple);a.VariantBufferInfo=l[B.Variant],a.AudioBufferInfo=l[B.AltAudio],this.Yo(a,n),this.Jo(e)}}updatePeriodic(t,i,r,n){var a=this.getEntity(t);if(a){var{sessionControlRecord:a,periodicRecord:s,playEndedRecord:o}=a;s.EventCounter=a.periodicEventCounter,s.PInterval=performance.now()-a.lastPeriodicTime,s.AvgVideoBitrate=8*(a.intervalVideoBytes||0)/(a.intervalVideoDuration||1),s.AvgAudioBitrate=8*(a.intervalAudioBytes||0)/(a.intervalAudioDuration||1);let e=s.NetBytes||0;r&&(s.NetBytes=e=1e3*Math.round(e/1e3),s.IsLastPeriodic=!0);var r=s.ADT||1,l=r+(s.SegmentProcessTime||1),d=r+(s.SegmentProcessTime||0)+(s.SegmentParseTime||1),r=(s.TWOBR=8*e/(r/1e3),s.PerceivedTWOBR=8*e/(l/1e3),s.NetTWOBR=8*e/(d/1e3),this.Wo("PLAY"===a.state?performance.now()-a.eventStartTime:0,a.sessionVariantList||{},a.curLevelUrl)),l=(s.PlayerTWIBR=r.twIBR,s.PlayerTWIABR=r.twIABR,s.TWBitRk=r.twBRnk,this.Go(a.curLevelUrl,a)),r=(s.TargetDur=l.targetduration,s.VariantList=null==(d=a.manifestData)?void 0:d.varListString,s.Rate=a.rate,s.CurrentMediaTime=fe(i)?1e3*i:void 0,this.Xo(a.bufferedRangeTuple)),l=(s.VariantBufferInfo=r[B.Variant],s.AudioBufferInfo=r[B.AltAudio],this.Zo(a));if(l&&(s.MedianBufferAppendLatency=l.bufLatencyInfo.median,s.MaxBufferAppendLatency=l.bufLatencyInfo.max,s.MedianBufferAppendSize=l.bufSizeInfo.median,s.MaxBufferAppendSize=l.bufSizeInfo.max,s.MedianSeekLatency=l.seekLatencyInfo.median,s.MaxSeekLatency=l.seekLatencyInfo.max,s.MedianPlayLatency=l.playLatencyInfo.median,s.MaxPlayLatency=l.playLatencyInfo.max,s.MedianLiveEdgeDist=l.liveEdgeDistInfo.median,s.MaxLiveEdgeDist=l.liveEdgeDistInfo.max),s.LLState=a.llState,s.VariantFragLoadInfo=a.variantFragLoadInfo,s.VariantFragParseInfo=a.variantFragParseInfo,s.VariantFragAppendInfo=a.variantFragAppendInfo,s.AudioFragLoadInfo=a.audioFragLoadInfo,s.AudioFragParseInfo=a.audioFragParseInfo,s.AudioFragAppendInfo=a.audioFragAppendInfo,s.LastVariantBufferAppendTime=null==(d=a.lastBufferAppendTimeForType)?void 0:d[we.Variant],s.LastAudioBufferAppendTime=null==(i=a.lastBufferAppendTimeForType)?void 0:i[we.AltAudio],n){s.Rss=Math.round(n.rss/1e3),s.PeakRss=Math.round(n.peakRSS/1e3),s.TotalJSHeapSize=Math.round(n.totalHeapSize/1e3),s.TotalJSHeapSizeWorkers=Math.round(n.totalHeapSizeWorkers/1e3),s.UsedJSHeapSize=Math.round(n.usedHeapSize/1e3),s.UsedJSHeapSizeWorkers=Math.round(n.usedHeapSizeWorkers/1e3),s.UsedArrayBufferSize=Math.round(n.usedArrayBufferSize/1e3),s.AudioBufferUsage=n.audioBufferUsage,s.VideoBufferUsage=n.videoBufferUsage;const t=Ea()["jsHeapSizeLimit"];s.JSHeapSizeLimit=Math.round(t/1e3)}else{const{jsHeapSizeLimit:t,totalJSHeapSize:i,usedJSHeapSize:r}=Ea();s.JSHeapSizeLimit=Math.round(t/1e3),s.TotalJSHeapSize=Math.round(i/1e3),s.UsedJSHeapSize=Math.round(r/1e3)}s.MediaControlTimestamps=a.mediaControlTimestamps,this.ea(s,o),this.Yo(s,a),this.Jo(t)}}updateStalled(t,i,r){var n=this.getEntity(t);if(n){var{sessionControlRecord:n,variantEndedRecord:a,periodicRecord:s,playEndedRecord:o,playStalledRecord:l,mediaEngineStalledRecord:d}=n,{type:u,stallDurationMs:c,currentTime:h}=r.stallInfo;let e;n.rate=0,e=i?(a.StallCount=(a.StallCount||0)+1,s.StallCount=(s.StallCount||0)+1,o.StallCount=(o.StallCount||0)+1,"networkError"===o.ErrDomain&&(l.NwErrTime=o.NwErrTime,l.NwErrCode=o.ErrCode),l):(a.MediaEngineStallCount=(a.MediaEngineStallCount||0)+1,s.MediaEngineStallCount=(s.MediaEngineStallCount||0)+1,o.MediaEngineStallCount=(o.MediaEngineStallCount||0)+1,d);var i=this.Go(n.curLevelUrl,n),l=performance.now(),a=(e.CurrentMediaTime=fe(h)?1e3*h:void 0,this.Xo(n.bufferedRangeTuple));e.VariantBufferInfo=a[B.Variant],e.AudioBufferInfo=a[B.AltAudio],e.MediaDur=r.mediaDur,e.Codecs=i.codecs,e.LastLikelyToKeepUp=l-n.lastLikelyToKeepUpTime,e.LastSwitch=l-(n.lastSwitchTime||0),e.StallDetectionTime=c,e.StallType=u,e.BufferLength=r.bufferLen,e.LaSwDir=n.lastSwitchDir,e.TargetDur=i.targetduration,e.Rate=n.rate,e.ForInterstitial=r.forInterstitial,e.VariantFragLoadInfo=n.variantFragLoadInfo,e.VariantFragParseInfo=n.variantFragParseInfo,e.VariantFragAppendInfo=n.variantFragAppendInfo,e.AudioFragLoadInfo=n.audioFragLoadInfo,e.AudioFragParseInfo=n.audioFragParseInfo,e.AudioFragAppendInfo=n.audioFragAppendInfo,e.LastVariantBufferAppendTime=null==(s=n.lastBufferAppendTimeForType)?void 0:s[we.Variant],e.LastAudioBufferAppendTime=null==(d=n.lastBufferAppendTimeForType)?void 0:d[we.AltAudio],e.MediaElementPaused=r.mediaElementPaused,e.MediaElementSeeking=r.mediaElementSeeking,e.MediaElementReadyState=r.mediaElementReadyState,e.HaveEnough=r.haveEnough,e.GotPlaying=r.stallInfo.gotPlaying,e.SeekStart=null==(h=r.seekInfo)?void 0:h.startPos,e.SeekEnd=null==(a=r.seekInfo)?void 0:a.pos,e.FromEvent=null==(l=r.seekInfo)?void 0:l.fromEvent,e.SeekInContentGap=null==(c=r.seekInfo)?void 0:c.inContentGap,e.SeekDiscoSeqNum=null==(u=r.seekInfo)?void 0:u.discoSeqNum,e.MediaControlTimestamps=n.mediaControlTimestamps,e.AbrContext=n.abrContext,this.ea(e,o),this.Yo(e,n),this.na(e,o.PlayTimeWC||0,o.PlayTime||0),this.Jo(t)}}updateKeyLoaded(e,t){const i=this.getEntity(e);if(i){var r=i["sessionControlRecord"];if(r.activeKeySessions)if("identity"===t.keyFormat){const e={},i=t.timestamp;e.keyFormat=t.keyFormat,e.keyDeliveryTime=t.adt,e.currentMediaTime=t.currentTime,e.forInterstitial=t.forInterstitial,e.mediaOptionId=t.mediaOptionId,e.keyInitTime=i-r.sessionStartTime,r.activeKeySessions[t.keyuri]=e}else r.activeKeySessions[t.keyuri].mediaOptionId=t.mediaOptionId;this.ra(e,t.keyuri)}}updateLicenseResponseProcessed(e,t){e=this.getEntity(e);if(e){var i=e["sessionControlRecord"];if(i.activeKeySessions){const e=i.activeKeySessions[t.keyuri];e.licenseResponseProcessTime=t.timestamp-(e.licenseResponseSubmitTime||0),i.lastKeyDeliveryTime=e.keyDeliveryTime=t.timestamp-(e.licenseChallengeStartTime||0),e.currentMediaTime=t.currentTime,i.finishedKeyUri=t.keyuri}}}updateLicenseChallengeError(e,t){e=this.getEntity(e);if(e){var i=e["sessionControlRecord"];if(i.activeKeySessions){const e=i.activeKeySessions[t.keyuri];i.lastKeyErrorType=e.keyErrorType="licenseChallengeError"}}}updateLicenseResponseError(e,t){e=this.getEntity(e);if(e){var i=e["sessionControlRecord"];if(i.activeKeySessions){const e=i.activeKeySessions[t.keyuri];i.lastKeyErrorType=e.keyErrorType="licenseResponseError"}}}updateKeyAborted(e,t){var i=this.getEntity(e);i&&(i=i["sessionControlRecord"],i.activeKeySessions&&(i.activeKeySessions[t.keyuri].keyErrorType="keyAborted",i.finishedKeyUri=t.keyuri),this.ra(e,t.keyuri))}updateKeyErrorThrown(e,i){var r;const n=this.getEntity(e);if(n){var a=n["sessionControlRecord"];if(a.activeKeySessions){let t="";(null!=(r=i.mediaOptionIds)?r:[]).forEach(e=>t+=e+","),t=t.substring(0,t.length-1);const n=a.activeKeySessions[i.keyuri];n.mediaOptionId=i.mediaOptionId,n.mediaOptionIdsForKey=t,a.finishedKeyUri=i.keyuri}this.ra(e,i.keyuri)}}updateCanPlay(e,t){var i,r,n,a,s,o,l=this.getEntity(e);l&&({sessionControlRecord:l,playLikelyToKeepUpRecord:i,playRateChangedRecord:r,playEndedRecord:n}=l,{sessionStartTime:s,lastWaitForCanPlay:o,playLikelyToKeepUpEventCounter:a}=(this.oa(t.oldRate||0,t.newRate||0)?l.iFrameToggle=!0:l.iFrameToggle=!1,l),a=performance.now()-(1===a?s:o),i.StartupTime=r.StartupTime=a,s=this.Go(l.curLevelUrl,l),i.EventCounter=l.playLikelyToKeepUpEventCounter,i.MediaDur=t.mediaDur,i.Codecs=s.codecs,i.TargetDur=s.targetduration,i.ForInterstitial=t.forInterstitial,i.PlayerStartPos=t.currentTime,i.CurrentMediaTime=fe(t.currentTime)?1e3*t.currentTime:void 0,o=this.Xo(l.bufferedRangeTuple),i.VariantBufferInfo=o[B.Variant],i.AudioBufferInfo=o[B.AltAudio],i.PlaylistADT=this.aa(l.startupLatencyInfo,"PlaylistLoad"),i.PlaylistParseTime=this.aa(l.startupLatencyInfo,"PlaylistParse"),i.ADT=this.aa(l.startupLatencyInfo,"SegmentLoad"),i.SegmentParseTime=this.aa(l.startupLatencyInfo,"SegmentParse"),i.BufferAppendTime=this.aa(l.startupLatencyInfo,"BufferAppend"),this.ea(i,n),this.Yo(i,l),this.na(i,n.PlayTimeWC||0,n.PlayTime||0),this.Jo(e))}updateRateChanged(e,t){var i,r,n,a,s=this.getEntity(e);s&&({sessionControlRecord:s,playRateChangedRecord:i,playEndedRecord:r}=s,s.rate=100*(t.newRate||0),0<(t.newRate||0)&&0===s.oldRate&&(s.playInfo||(s.playInfo=[]),s.playInfo.push({latency:t.latency||0}),s.curLevelUrl||""===t.url||(s.curLevelUrl=t.url)),n=this.Go(s.curLevelUrl,s),i.Rate=s.rate,i.CurrentMediaTime=fe(t.currentTime)?1e3*t.currentTime:void 0,a=this.Xo(s.bufferedRangeTuple),i.VariantBufferInfo=a[B.Variant],i.AudioBufferInfo=a[B.AltAudio],i.MediaDur=t.mediaDur,i.Codecs=n.codecs,i.ForInterstitial=t.forInterstitial,this.ea(i,r),this.Yo(i,s),this.na(i,r.PlayTimeWC||0,r.PlayTime||0),this.Jo(e))}updateMediaError(e,t,i,r,n){var a=this.getEntity(e);if(a){var{sessionControlRecord:a,periodicRecord:s,playErrorRecord:o,playEndedRecord:l}=a;if(s.PlayerErrCount=(s.PlayerErrCount||0)+1,l.PlayerErrCount=(l.PlayerErrCount||0)+1,a.rate=0,s.FatalPlayerErrCount=(s.FatalPlayerErrCount||0)+1,l.FatalPlayerErrCount=(l.FatalPlayerErrCount||0)+1,t instanceof A){o.PlatformCapabilitiesFilterBreakdown=[];for(const[e,i]of t.platformCapabilityFilterBreakdown)o.PlatformCapabilitiesFilterBreakdown.push([hu[e],i])}l.ErrCode=o.ErrCode=t.details,l.ErrReason=o.ErrReason=t.response,l.ErrIsFatal=o.ErrIsFatal=!0,l.ErrDomain=o.ErrDomain="mediaError",this.ua(e,i,r,n)}}prepareNonFatalPlayError(e){var t,i,r,n,a,e=this.getEntity(e);return!(!e||({sessionControlRecord:e,playEndedRecord:t,playErrorRecord:i}=e,r=null!=(r=e.nonFatalPlayErrList)?r:{},(a=null!=(a=Object.keys(r))?a:[]).length<=0)||(n=a[0],a=a[0].split("/"),i.ErrDomain="mediaError",i.ErrIsFatal=!1,i.ErrCode=a[0],i.ErrReason=parseInt(a[1]),i.PlayerErrCount=r[n].count,i.NonFatalErrTimestamps=r[n].timestamps,i.AbrContext=e.abrContext,i.HdcpLevel=t.HdcpLevel,this.ea(i,t),this.Yo(i,e),this.na(i,t.PlayTimeWC||0,t.PlayTime||0),delete r[n],0))}updateMediaElementError(e,t,i,r,n){let a;try{a=JSON.parse(t.message)}catch(e){}var s=a?parseInt(a.ErrReason):void 0,o=a?parseInt(a.ErrDetail):void 0,l=this.getEntity(e);if(!l)return!1;l=l["playErrorRecord"];l.ErrDomain=l.ErrCode="mediaElementError",l.ErrIsFatal=!0,l.ErrCodeMediaElement=t.code,l.ErrReason=s,l.ErrDetail=o,this.ua(e,i,r,n)}updateDebugInfo(e,t,i,r,n,a){var s,o,l=this.getEntity(e);l&&({playEndedRecord:l,debugInfoRecord:s,sessionControlRecord:o}=l,s.ErrCode=null==t?void 0:t.details,s.ErrReason=null==t?void 0:t.response,s.ErrDomain=(null==t?void 0:t.type)===K.NETWORK_ERROR?"networkError":"mediaError",s.ErrStack=i,s.LogHistory=r,s.ContentUrl=n,s.MatchedPattern=a,this.ea(s,l),this.Yo(s,o),this.na(s,l.PlayTimeWC||0,l.PlayTime||0),this.Jo(e))}updateErrorRecoveryRecord(e){var t,i,r,{itemId:e,hlsError:n,level:a,isFirstAttempt:s,contentUrl:o}=e,l=this.getEntity(e);l&&({playEndedRecord:l,errorRecoveryRecord:t,sessionControlRecord:i}=l,{details:n,response:r}=n,t.ErrCode=n,t.ErrReason=r,t.ContentUrl=o,t.MediaOptionId=a,t.EventCounter=s?1:2,this.ea(t,l),this.Yo(t,i),this.na(t,l.PlayTimeWC||0,l.PlayTime||0),this.Jo(e))}updateLevelSwitched(i,r,n,a,s,o){var l=this.getEntity(i);if(l){var{sessionControlRecord:l,switchCompleteRecord:d,periodicRecord:u,playEndedRecord:c}=l,u=(u.SwCnt=(u.SwCnt||0)+1,c.SwCnt=(c.SwCnt||0)+1,performance.now()),c=l.curLevelUrl,h=this.Go(c,l),p=this.Go(n,l);let e,t=!1;c?(e=p.bandwidth<h.bandwidth?"Down":"Up",t=p.iframes):e="Up",d.BadSw=this.ha(e,l.lastSwitchDir,t,l.lastLevelIsIframe,u,l.lastSwitchTime,r),l.lastSwitchDir=e,l.lastSwitchTime=u,l.lastLevelIsIframe=t,l.curLevelUrl=n,l.variantStartTimeMedia=fe(s)?1e3*s:void 0,this.va(i,a,s,o)}}updateLevelLoadError(i,r,n,a,s){var o=this.getEntity(i);if(o){var{sessionControlRecord:o,switchCompleteRecord:l,periodicRecord:d,playEndedRecord:u}=o,c=performance.now();let e,t=!1;if(o.curLevelUrl){const i=this.Go(o.curLevelUrl,o),n=this.Go(r.url,o);e=n.bandwidth<i.bandwidth?"Down":"Up",t=n.iframes}else e="Up";d.SwCnt=(d.SwCnt||0)+1,u.SwCnt=(u.SwCnt||0)+1,l.BadSw=this.ha(e,o.lastSwitchDir,t,o.lastLevelIsIframe,c,o.lastSwitchTime,a),l.SwFail=!0,this.va(i,n,s,r.forInterstitial)}}updateVariantEnd(e,t,i){var r,n,a,s=this.getEntity(e);s&&({sessionControlRecord:s,variantEndedRecord:r,playEndedRecord:n}=s,a=this.Go(s.curLevelUrl,s),t=fe(t)?1e3*t:void 0,r.Rate=s.rate,r.VarAvgBitrate=a.avgBandwidth,r.VarPeakBitrate=a.bandwidth,r.VarBitRk=a.brRnk,r.VarSTTime=s.variantStartTimeMedia,r.VarEndTime=t,r.CurrentMediaTime=t,t=this.Xo(s.bufferedRangeTuple),r.VariantBufferInfo=t[B.Variant],r.AudioBufferInfo=t[B.AltAudio],r.IFR=a.framerate,s.decodedFramesForVariant&&s.decodedFramesForVariantSampleCount&&(r.ODR=s.decodedFramesForVariant/s.decodedFramesForVariantSampleCount),r.Codecs=a.codecs,r.AvgVideoBitrate=8*(s.variantVideoBytes||0)/(s.variantVideoDuration||1),r.AvgAudioBitrate=8*(s.variantAudioBytes||0)/(s.variantAudioDuration||1),r.ForInterstitial=i,this.ea(r,n),this.Yo(r,s),this.na(r,n.PlayTimeWC||0,n.PlayTime||0),this.Jo(e))}updateNonFatalError(e,t){var i,r,n,e=this.getEntity(e);e&&({sessionControlRecord:e,periodicRecord:i,playEndedRecord:r}=e,n=(new Date).getTime()/1e3,t.type===K.NETWORK_ERROR?(e.nonFatalNwErrList||(e.nonFatalNwErrList={}),this.ma(e.nonFatalNwErrList,t,n),i.NwErrCount=(i.NwErrCount||0)+1,r.NwErrCount=(r.NwErrCount||0)+1):(e.nonFatalPlayErrList||(e.nonFatalPlayErrList={}),this.ma(e.nonFatalPlayErrList,t,n),i.PlayerErrCount=(i.PlayerErrCount||0)+1,r.PlayerErrCount=(r.PlayerErrCount||0)+1))}ma(e,t,i){var r;let n,a=t.details+"/"+t.response;if(t instanceof Ys&&(a+="/"+(null!=(r=t.isCustomUrl)?r:"")+"/"+(null!=(r=t.timeoutType)?r:""),n={isCustomUrl:t.isCustomUrl,timeoutType:t.timeoutType}),e[a])e[a].count=e[a].count+1,e[a].timestamps.length<10&&e[a].timestamps.push(i);else{const r={count:1,details:t.details,response:t.response,timestamps:[i],networkInfo:n};e[a]=r}}updateNwError(e,t,i,r){var n,a,s,o=this.getEntity(e);o&&({sessionControlRecord:o,periodicRecord:s,playEndedRecord:n,nwErrorRecord:a}=o,s.NwErrCount=(s.NwErrCount||0)+1,n.NwErrCount=(n.NwErrCount||0)+1,o.rate=0,s.FatalNwErrCount=(s.FatalNwErrCount||0)+1,n.FatalNwErrCount=(n.FatalNwErrCount||0)+1,n.ErrCode=a.ErrCode=t.details,n.ErrReason=a.ErrReason=t.response,n.ErrIsFatal=a.ErrIsFatal=!0,n.ErrDomain=a.ErrDomain="networkError",s=null!=(s=o.curLevelUrl)?s:o.levelUrlLoaded,s=this.Go(s,o),a.NwErrCount=1,a.CurrentMediaTime=fe(i)?1e3*i:void 0,i=this.Xo(o.bufferedRangeTuple),a.VariantBufferInfo=i[B.Variant],a.AudioBufferInfo=i[B.AltAudio],a.Codecs=s.codecs,a.Rate=o.rate,a.KeyErrorType=o.lastKeyErrorType,a.KeyDeliveryTime=o.lastKeyDeliveryTime,a.ForInterstitial=r,a.VariantFragLoadInfo=o.variantFragLoadInfo,a.VariantFragParseInfo=o.variantFragParseInfo,a.VariantFragAppendInfo=o.variantFragAppendInfo,a.AudioFragLoadInfo=o.audioFragLoadInfo,a.AudioFragParseInfo=o.audioFragParseInfo,a.AudioFragAppendInfo=o.audioFragAppendInfo,a.LastVariantBufferAppendTime=null==(i=o.lastBufferAppendTimeForType)?void 0:i[we.Variant],a.LastAudioBufferAppendTime=null==(s=o.lastBufferAppendTimeForType)?void 0:s[we.AltAudio],a.HdcpLevel=n.HdcpLevel,t instanceof Ys&&(a.IsCustomUrlRequest=t.isCustomUrl,a.TimeoutErrorType=t.timeoutType),a.AbrContext=o.abrContext,this.ea(a,n),this.Yo(a,o),this.na(a,n.PlayTimeWC||0,n.PlayTime||0),this.Jo(e))}prepareNonFatalNwError(e){var t,i,r,n,a,s,e=this.getEntity(e);return!(!e||({sessionControlRecord:e,playEndedRecord:i,nwErrorRecord:r}=e,n=null!=(n=e.nonFatalNwErrList)?n:{},(a=null!=(a=Object.keys(n))?a:[]).length<=0)||(a=a[0],r.ErrDomain="networkError",r.ErrIsFatal=!1,s=n[a],r.ErrCode=s.details,r.ErrReason=s.response,void 0!==s.networkInfo&&(r.IsCustomUrlRequest=null!=(t=s.networkInfo.isCustomUrl)&&t,r.TimeoutErrorType=s.networkInfo.timeoutType),r.NwErrCount=n[a].count,r.NonFatalErrTimestamps=n[a].timestamps,r.AbrContext=e.abrContext,r.HdcpLevel=i.HdcpLevel,this.ea(r,i),this.Yo(r,e),this.na(r,i.PlayTimeWC||0,i.PlayTime||0),delete n[a],0))}updateInterstitialPlayTime(e,t){var i,r,n,a,s,e=this.getEntity(e);e&&({playEndedRecord:e,periodicRecord:i,variantEndedRecord:r,playStalledRecord:n,playErrorRecord:a,mediaEngineStalledRecord:s}=e,e.InterstitialPlayTime=(e.InterstitialPlayTime||0)+t,i.InterstitialPlayTime=(i.InterstitialPlayTime||0)+t,r.InterstitialPlayTime=(r.InterstitialPlayTime||0)+t,n.InterstitialPlayTime=(n.InterstitialPlayTime||0)+t,a.InterstitialPlayTime=(a.InterstitialPlayTime||0)+t,s.InterstitialPlayTime=(s.InterstitialPlayTime||0)+t)}updateMediaControlTimestamps(e,t){var e=this.getEntity(e);e&&((e=e.sessionControlRecord).mediaControlTimestamps||(e.mediaControlTimestamps=[]),e.mediaControlTimestamps.push([t.type,t.pos]))}finalize(t,e){var i=this.getEntity(t);if(i){var r=i["sessionControlRecord"];switch(e){case Ya:r.state="STOP",r.oldRate=0,i.playEndedRecord={};break;case Xa:{r.lastPeriodicTime=performance.now(),r.periodicEventCounter+=1,r.bufferAppendInfo=[],r.playInfo=[],r.seekInfo=[],r.liveEdgeInfo=[],r.mediaControlTimestamps=[];const t=r.intervalVariantList;t&&Object.keys(t).forEach(e=>{t[e].playTime=0}),i.periodicRecord={};break}case Ja:r.state="STALL",r.oldRate=0,r.mediaControlTimestamps=[],i.playStalledRecord={};break;case Za:r.keySessionCompleteEventCounter+=1,r.activeKeySessions&&r.finishedKeyUri&&delete r.activeKeySessions[r.finishedKeyUri],delete r.keySystemInitEvents,i.keySessionCompleteRecord={};break;case es:"PLAY"===r.state&&!r.iFrameToggle||(r.state="CANPLAY",r.lastLikelyToKeepUpTime=performance.now(),r.playLikelyToKeepUpEventCounter+=1),r.startupLatencyInfo=[],i.playLikelyToKeepUpRecord={};break;case ts:{const{playEndedRecord:t,playStalledRecord:e,mediaEngineStalledRecord:n,playErrorRecord:a,nwErrorRecord:s}=i;0!==r.rate?(r.state="PLAY",delete t.LastStall,delete t.LastMediaEngineStall,delete t.LastPause,delete a.LastPause,delete s.LastPause):(r.state="PAUSE",delete e.LastResume,delete n.LastResume,delete a.LastResume,delete s.LastResume),r.oldRate=r.rate,i.playRateChangedRecord={};break}case is:r.state="PLAYERROR",i.playErrorRecord={};break;case rs:r.state="MEDIAENGINESTALL",r.oldRate=0,r.mediaControlTimestamps=[],i.mediaEngineStalledRecord={};break;case ns:i.switchCompleteRecord={},r.prevLevelUrl=r.curLevelUrl;break;case as:r.decodedFramesForVariant=0,r.decodedFramesForVariantSampleCount=0,i.variantEndedRecord={};break;case ss:i.seekCompleteRecord={};break;case os:r.state="NWERROR",i.nwErrorRecord={};break;case ls:i.debugInfoRecord={}}r.eventStartTime=performance.now()}}updatePlaybackInfo(e,t){var i,r,n,a,e=this.getEntity(e);e&&({sessionControlRecord:e,periodicRecord:i,playEndedRecord:r}=e,fe(t.liveEdgeDist)&&(e.liveEdgeInfo?e.liveEdgeInfo.push({liveEdgeDist:t.liveEdgeDist}):e.liveEdgeInfo=[{liveEdgeDist:t.liveEdgeDist}]),e.llState=t.llState,e.bufferedRangeTuple=t.bufferedRangeTuple,e.droppedVideoFrames&&t.droppedVideoFrames<e.droppedVideoFrames&&(e.droppedVideoFrames=0),e.decodedFrameCount&&t.decodedFrameCount<e.decodedFrameCount&&(e.decodedFrameCount=0),n=t.droppedVideoFrames-(e.droppedVideoFrames||0),a=t.decodedFrameCount-(e.decodedFrameCount||0),e.droppedVideoFrames=t.droppedVideoFrames,e.decodedFrameCount=t.decodedFrameCount,e.decodedFramesForVariant?e.decodedFramesForVariant+=a:e.decodedFramesForVariant=a,e.decodedFramesForVariantSampleCount?e.decodedFramesForVariantSampleCount+=1:e.decodedFramesForVariantSampleCount=1,n)&&(3<=n?(i.GroupViFrDr=(i.GroupViFrDr||0)+n,i.GroupViFrDrEvtCount=(i.GroupViFrDrEvtCount||0)+1,r.GroupViFrDr=(r.GroupViFrDr||0)+n,r.GroupViFrDrEvtCount=(r.GroupViFrDrEvtCount||0)+1):(i.SparseViFrDr=(i.SparseViFrDr||0)+n,i.SparseViFrDrEvtCount=(i.SparseViFrDrEvtCount||0)+1,r.SparseViFrDr=(r.SparseViFrDr||0)+n,r.SparseViFrDrEvtCount=(r.SparseViFrDrEvtCount||0)+1))}updateBufferAppended(e,t){var i,e=this.getEntity(e);e&&(e=e["sessionControlRecord"],e.bufferAppendInfo||(e.bufferAppendInfo=[]),e.bufferAppendInfo.push({latency:t.endAppend-t.startAppend,size:t.bytesAppend}),this.ya(e,{type:"BufferAppend",tbegin:t.startAppend,tend:t.endAppend}),i=Math.round(performance.now()-e.sessionStartTime),i={fragId:t.fragId,tbegin:t.startAppend,tend:t.endAppend,fragStart:t.fragStart,fragDuration:t.fragDuration,timestamp:i},t.fragmentType===we.Variant?(e.variantFragAppendInfo||(e.variantFragAppendInfo=[]),e.variantFragAppendInfo.push(i),e.variantFragAppendInfo.length>this.Ko&&e.variantFragAppendInfo.shift()):t.fragmentType===we.AltAudio&&(e.audioFragAppendInfo||(e.audioFragAppendInfo=[]),e.audioFragAppendInfo.push(i),e.audioFragAppendInfo.length>this.Ko)&&e.audioFragAppendInfo.shift(),(i=null!=(i=e.lastBufferAppendTimeForType)?i:{})[t.fragmentType]=Math.round(t.endAppend-e.sessionStartTime),e.lastBufferAppendTimeForType=i)}updateSeek(e,t){e=this.getEntity(e);if(e){const{seekInfo:i,combinedBuffer:r}=t,n=e["seekCompleteRecord"];n.SeekStart=i.startPos,n.SeekEnd=i.pos,n.FromEvent=i.fromEvent,n.IsSeekPosBuffered=r.some(e=>e.start<=i.pos&&i.pos<=e.end)}}updateSeeked(e,t){var i,r,n=this.getEntity(e);n&&({sessionControlRecord:n,playEndedRecord:i,seekCompleteRecord:r}=n,n.seekInfo||(n.seekInfo=[]),n.seekInfo.push(t),r.SeekLatency=t.latency,this.ea(r,i),this.Yo(r,n),this.na(r,i.PlayTimeWC||0,i.PlayTime||0),this.Jo(e))}updateManifestParsed(e,t){e=this.getEntity(e);if(e){const{sessionControlRecord:i,playLikelyToKeepUpRecord:r,periodicRecord:n,playEndedRecord:a}=e,{tload:s,trequest:o,tparsed:l}=t.manifestParsedData.stats,d=s-o,u=(r.MasterPlaylistADT=d,n.MasterPlaylistADT=d,a.MasterPlaylistADT=d,this.ya(i,{type:"PlaylistParse",tbegin:l.tbegin,tend:l.tend}),this.ba(t.manifestParsedData.levels));a.IsAudioOnly=t.isAudioOnly,a.IsGapless=t.isGapless,a.IsFirstItem=t.isFirstItem,a.ForInterstitial=t.forInterstitial,a.ItemID=t.itemID,a.MaxVideoQltyIndex=u.maxVideoQltyIndex,a.MaxReWd=u.maxWidth,a.MaxReHt=u.maxHeight,Object.keys(u.variantList).forEach(e=>{e=u.variantList[e].width||0;3800<=e?i.support4KStart=performance.now():1850<=e&&e<2e3&&(i.supportHDStart=performance.now())}),i.manifestData={variantList:u.variantList,varListString:u.varListString}}}updateFragLoaded(e){var t=e["itemId"],t=this.getEntity(t);if(t){var{sessionControlRecord:t,periodicRecord:i,playEndedRecord:r}=t;i.MediaRequestsSent=(i.MediaRequestsSent||0)+1,r.MediaRequestsSent=(r.MediaRequestsSent||0)+1;const l=e.stats,d=null==l?void 0:l.contentType,u=null==l?void 0:l.loaded,c=(null==l?void 0:l.tload)-(null==l?void 0:l.trequest),h=(null==l?void 0:l.tdataack)-(null==l?void 0:l.tload);null!=l&&l.cdnServer&&(r.LastMediaCDNServer=null==(n=l.cdnServer)?void 0:n.toLowerCase()),e.serverInfo&&(r.ServerInfo=e.serverInfo),t.segmentMimeTypes||(t.segmentMimeTypes=[]),t.segmentMimeTypes.findIndex(e=>e==d)<0&&t.segmentMimeTypes.push(d);var n=Math.round((u||0)/1e3),a=Math.round(performance.now()-t.sessionStartTime),n={fragId:sh(e.frag),trequest:l.trequest,tfirst:l.tfirst,tload:l.tload,tdataack:l.tdataack,kBytes:n,timestamp:a},{duration:s,mediaOptionType:o}=(this.ya(t,{type:"SegmentLoad",tbegin:l.trequest,tend:l.tload}),e.frag);o===we.Variant?(t.variantVideoBytes=(t.variantVideoBytes||0)+u,t.variantVideoDuration=(t.variantVideoDuration||0)+s,t.intervalVideoBytes=(t.intervalVideoBytes||0)+u,t.intervalVideoDuration=(t.intervalVideoDuration||0)+s,t.sessionVideoBytes=(t.sessionVideoBytes||0)+u,t.sessionVideoDuration=(t.sessionVideoDuration||0)+s,t.variantFragLoadInfo||(t.variantFragLoadInfo=[]),t.variantFragLoadInfo.push(n),t.variantFragLoadInfo.length>this.Ko&&t.variantFragLoadInfo.shift(),t.obrLast=8*u/(c/1e3),r.NetBytes&&r.ADT&&(t.obrMean=8*r.NetBytes/(r.ADT/1e3)),t.abrContext||(t.abrContext=[]),t.abrContext.push({fragId:sh(e.frag),instantBandwidth:e.bwStatus.instantBw,avgBandwidth:e.bwEstimate.avgBandwidth,observedBitrateIncludingLatency:oe(l.trequest,l.tload,l.loaded),latency:l.tfirst-l.trequest,isAbort:!1,timestamp:a}),t.abrContext.length>this.Ko&&t.abrContext.shift(),i.NetBytes=(i.NetBytes||0)+u,i.ADT=(i.ADT||0)+c,i.SegmentProcessTime=(i.SegmentProcessTime||0)+h,r.ADT=(r.ADT||0)+c,r.NetBytes=(r.NetBytes||0)+u,r.SegmentProcessTime=(r.SegmentProcessTime||0)+h):o===we.AltAudio&&(t.variantAudioBytes=(t.variantAudioBytes||0)+u,t.variantAudioDuration=(t.variantAudioDuration||0)+s,t.intervalAudioBytes=(t.intervalAudioBytes||0)+u,t.intervalAudioDuration=(t.intervalAudioDuration||0)+s,t.sessionAudioBytes=(t.sessionAudioBytes||0)+u,t.sessionAudioDuration=(t.sessionAudioDuration||0)+s,t.audioFragLoadInfo||(t.audioFragLoadInfo=[]),t.audioFragLoadInfo.push(n),t.audioFragLoadInfo.length>this.Ko)&&t.audioFragLoadInfo.shift()}}updateFragParsed(e,t){var i,r,n,a,e=this.getEntity(e);e&&({sessionControlRecord:e,playEndedRecord:i,periodicRecord:r}=e,a=null!=(a=null==(a=null==t?void 0:t.initFragSample)?void 0:a.tparsed)?a:{tbegin:0,tend:0},n=null!=(n=null==(n=null==t?void 0:t.fragSample)?void 0:n.tparsed)?n:{tbegin:0,tend:0},this.ya(e,{type:"SegmentParse",tbegin:a.tbegin,tend:a.tend}),this.ya(e,{type:"SegmentParse",tbegin:n.tbegin,tend:n.tend}),a=1e3*Math.round((t.largestVideoSampleSize||0)/1e3),(!i.LargestVideoSampleSize||a>i.LargestVideoSampleSize)&&(i.LargestVideoSampleSize=a),(!r.LargestVideoSampleSize||a>r.LargestVideoSampleSize)&&(r.LargestVideoSampleSize=a),n=Math.round(performance.now()-e.sessionStartTime),a={fragId:t.fragSample.fragId,initFragTBegin:null==(r=null==(i=null==t?void 0:t.initFragSample)?void 0:i.tparsed)?void 0:r.tbegin,initFragTEnd:null==(i=null==(a=null==t?void 0:t.initFragSample)?void 0:a.tparsed)?void 0:i.tend,fragTBegin:null==(a=null==(r=null==t?void 0:t.fragSample)?void 0:r.tparsed)?void 0:a.tbegin,fragTEnd:null==(r=null==(i=null==t?void 0:t.fragSample)?void 0:i.tparsed)?void 0:r.tend,timestamp:n},t.fragSample.type===we.Variant?(e.variantFragParseInfo||(e.variantFragParseInfo=[]),e.variantFragParseInfo.push(a),e.variantFragParseInfo.length>this.Ko&&e.variantFragParseInfo.shift()):t.fragSample.type===we.AltAudio&&(e.audioFragParseInfo||(e.audioFragParseInfo=[]),e.audioFragParseInfo.push(a),e.audioFragParseInfo.length>this.Ko)&&e.audioFragParseInfo.shift())}updateFragBuffered(t,i){t=this.getEntity(t);if(t){var{periodicRecord:t,playEndedRecord:r}=t;let e=0;i.endDataAppend&&i.startDataAppend&&(e=i.endDataAppend-i.startDataAppend),i.fragmentType===we.Variant&&(t.SegmentParseTime=(t.SegmentParseTime||0)+e,r.SegmentParseTime=(r.SegmentParseTime||0)+e)}}updateFragAborted(e,t){var i,e=this.getEntity(e);e&&(e=e["sessionControlRecord"],i=Math.round(performance.now()-e.sessionStartTime),e.abrContext||(e.abrContext=[]),t.timestamp=i,e.abrContext.push(t),e.abrContext.length>this.Ko)&&e.abrContext.shift()}updateLevelLoaded(e,t){e=this.getEntity(e);if(e){const{sessionControlRecord:n,periodicRecord:a,playEndedRecord:s}=e,{stats:o,mediaOptionDetails:l}=t,{targetduration:d,totalduration:u,type:c}=l,h=l.url||"",p=o.tload-o.trequest;this.ya(n,{type:"PlaylistLoad",tbegin:o.trequest,tend:o.tload}),a.PlaylistADT=(a.PlaylistADT||0)+p,s.PlaylistADT=(s.PlaylistADT||0)+p,a.MaxPlaylistDT=Math.max(a.MaxPlaylistDT||0,p),s.MaxPlaylistDT=Math.max(s.MaxPlaylistDT||0,p),s.PlayType=c,s.ContentDur||(s.ContentDur=300*Math.round((u||0)/300));var e=n["manifestData"],t=(e&&e.variantList&&e.variantList[h]&&(e.variantList[h].targetduration=d||0),n.playlistMimeTypes||(n.playlistMimeTypes=[]),n.playlistMimeTypes.findIndex(e=>e==o.contentType)<0&&n.playlistMimeTypes.push(o.contentType),n.levelUrlLoaded=h),e=this.Go(t,n),i=n.intervalVariantList,r=n.sessionVariantList;i&&!i[t]&&(i[t]=Object.assign({},e)),r&&!r[t]&&(r[t]=Object.assign({},e))}}updateLevelParsed(e,t){var e=this.getEntity(e);e&&(e=e["sessionControlRecord"],this.ya(e,{type:"PlaylistParse",tbegin:t.tbegin,tend:t.tend}))}updateLevelsChanged(e,t){e=this.getEntity(e);if(e){const{sessionControlRecord:r,playEndedRecord:i}=e,n=this.ba(t);i.MaxVideoQltyIndex=n.maxVideoQltyIndex,i.MaxReWd=n.maxWidth,i.MaxReHt=n.maxHeight,r.manifestData={variantList:n.variantList,varListString:n.varListString},Object.keys(n.variantList).forEach(e=>{var t=r.intervalVariantList,i=r.sessionVariantList,t=(t&&t[e]&&(t[e].brRnk=n.variantList[e].brRnk),i&&i[e]&&(i[e].brRnk=n.variantList[e].brRnk),n.variantList[e].width||0);3800<=t?r.support4KStart=performance.now():1850<=t&&t<2e3&&(r.supportHDStart=performance.now())})}}updateKeySystemEvents(e,t){e=this.getEntity(e);if(e){var i=e["sessionControlRecord"];if(4===t.eventId&&t.keyuri){const e={};i.activeKeySessions&&(i.activeKeySessions[t.keyuri]=e)}var r=[t.eventId,t.keyRequestState,Math.round(t.range.tbegin-i.sessionStartTime),Math.round(t.range.tend-i.sessionStartTime)];if(i.activeKeySessions&&t.keyuri&&i.activeKeySessions[t.keyuri]){const e=i.activeKeySessions[t.keyuri];e.keySystemEvents||(e.keySystemEvents=[]),e.keySystemEvents.push(r)}else 1===i.keySessionCompleteEventCounter&&(i.keySystemInitEvents||(i.keySystemInitEvents=[]),i.keySystemInitEvents.push(r))}}updateLicenseChallengeRequested(t,i){const r=this.getEntity(t);if(r){t=r["sessionControlRecord"];if(t.activeKeySessions){let e=t.activeKeySessions[i.keyuri];e||(t.activeKeySessions[i.keyuri]=e={});const r=i.timestamp;e.licenseChallengeStartTime=r,e.forInterstitial=i.forInterstitial,"INIT"===t.state&&(e.keyInitTime=r-t.sessionStartTime)}}}updateLicenseChallengeReceived(e,t){e=this.getEntity(e);if(e){var i=e["sessionControlRecord"];if(i.activeKeySessions){const e=i.activeKeySessions[t.keyuri];e.licenseChallengeRequestTime=t.timestamp-(e.licenseChallengeStartTime||0)}}}updateLicenseChallengeSubmitted(e,t){e=this.getEntity(e);if(e){var i=e["sessionControlRecord"];if(i.activeKeySessions){const e=i.activeKeySessions[t.keyuri];e.keyFormat=t.keyFormat,e.licenseChallengeSubmitTime=t.timestamp}}}updateLicenseChallengeCreated(e,t){e=this.getEntity(e);if(e){var i=e["sessionControlRecord"];if(i.activeKeySessions){const e=i.activeKeySessions[t.keyuri];e.cdmVersion=t.cdmVersion,e.licenseChallengeCreationTime=t.timestamp-(e.licenseChallengeSubmitTime||0)}}}updateLicenseResponseRequested(e,t){var e=this.getEntity(e);e&&(e=e["sessionControlRecord"],e=e.activeKeySessions?e.activeKeySessions[t.keyuri]:void 0)&&(e.licenseResponseRequestTime=t.timestamp)}updateLicenseResponseReceived(e,t){var e=this.getEntity(e);e&&(e=e["sessionControlRecord"],e=e.activeKeySessions?e.activeKeySessions[t.keyuri]:void 0)&&(e.licenseResponseReceiveTime=t.timestamp-(e.licenseResponseRequestTime||0))}updateLicenseResponseSubmitted(e,t){var e=this.getEntity(e);e&&(e=e["sessionControlRecord"],e=e.activeKeySessions?e.activeKeySessions[t.keyuri]:void 0)&&(e.licenseResponseSubmitTime=t.timestamp)}updateWaitForCanPlay(e){var e=this.getEntity(e);e&&(e=e["sessionControlRecord"],e.lastWaitForCanPlay=performance.now())}ra(e,t){var i,r,n,a=this.getEntity(e);a&&({sessionControlRecord:a,keySessionCompleteRecord:i,playEndedRecord:r}=a,t=a.activeKeySessions?a.activeKeySessions[t]:void 0)&&(i.EventCounter=a.keySessionCompleteEventCounter,1===a.keySessionCompleteEventCounter&&(i.KeySystemInitEvents=a.keySystemInitEvents),i.KeySystemEvents=t.keySystemEvents,i.KeyFormat=t.keyFormat,i.CDMVersion=t.cdmVersion,i.MediaOptionId=null!=(n=t.mediaOptionId)?n:"keyRenewal",i.LicenseChallengeRequestTime=t.licenseChallengeRequestTime,i.LicenseChallengeCreationTime=t.licenseChallengeCreationTime,i.LicenseResponseReceiveTime=t.licenseResponseReceiveTime,i.LicenseResponseProcessTime=t.licenseResponseProcessTime,i.KeyDeliveryTime=t.keyDeliveryTime,i.CurrentMediaTime=fe(t.currentMediaTime)?1e3*t.currentMediaTime:void 0,n=this.Xo(a.bufferedRangeTuple),i.VariantBufferInfo=n[B.Variant],i.AudioBufferInfo=n[B.AltAudio],i.LargestVideoSampleSize=r.LargestVideoSampleSize,i.KeyInitTime=t.keyInitTime,t.keyErrorType&&(i.KeyErrorType=t.keyErrorType,i.MediaOptionIdsForKey=t.mediaOptionIdsForKey),i.ForInterstitial=t.forInterstitial,this.ea(i,r),this.Yo(i,a),this.na(i,r.PlayTimeWC||0,r.PlayTime||0),this.Jo(e))}ua(e,t,i,r){var n,a,s,o,l=this.getEntity(e);l&&({sessionControlRecord:l,playErrorRecord:n,playEndedRecord:a}=l,s=null!=(s=l.curLevelUrl)?s:l.levelUrlLoaded,s=this.Go(s,l),o=performance.now(),n.PlayerErrCount=1,n.MediaDur=t,n.CurrentMediaTime=fe(i)?1e3*i:void 0,t=this.Xo(l.bufferedRangeTuple),n.VariantBufferInfo=t[B.Variant],n.AudioBufferInfo=t[B.AltAudio],n.Codecs=s.codecs,n.LastLikelyToKeepUp=o-l.lastLikelyToKeepUpTime,n.LastSwitch=o-(l.lastSwitchTime||0),n.LargestVideoSampleSize=a.LargestVideoSampleSize,n.VideoQltyIndex=s.qltyIndex,n.Rate=l.rate,n.KeyErrorType=l.lastKeyErrorType,n.KeyDeliveryTime=l.lastKeyDeliveryTime,n.ForInterstitial=r,n.VariantFragLoadInfo=l.variantFragLoadInfo,n.VariantFragParseInfo=l.variantFragParseInfo,n.VariantFragAppendInfo=l.variantFragAppendInfo,n.AudioFragLoadInfo=l.audioFragLoadInfo,n.AudioFragParseInfo=l.audioFragParseInfo,n.AudioFragAppendInfo=l.audioFragAppendInfo,n.LastVariantBufferAppendTime=null==(i=l.lastBufferAppendTimeForType)?void 0:i[we.Variant],n.LastAudioBufferAppendTime=null==(t=l.lastBufferAppendTimeForType)?void 0:t[we.AltAudio],n.HdcpLevel=a.HdcpLevel,n.AbrContext=l.abrContext,this.ea(n,a),this.Yo(n,l),this.na(n,a.PlayTimeWC||0,a.PlayTime||0),this.Jo(e))}va(e,t,i,r){var n,a,s,o,l=this.getEntity(e);l&&({sessionControlRecord:l,switchCompleteRecord:n,playEndedRecord:a}=l,s=this.Go(l.prevLevelUrl,l),o=this.Go(l.curLevelUrl,l),n.FrBitRnk=s.brRnk,n.ToBitRnk=o.brRnk,n.TimeToBitrate=performance.now()-l.sessionStartTime,n.MediaDur=t,n.CurrentMediaTime=fe(i)?1e3*i:void 0,t=this.Xo(l.bufferedRangeTuple),n.VariantBufferInfo=t[B.Variant],n.AudioBufferInfo=t[B.AltAudio],n.Rate=l.rate,n.LastPlayerIBR=s.bandwidth,n.LastPlayerIABR=s.avgBandwidth,n.ForInterstitial=r,n.AbrContext=l.abrContext,this.Sa(e,o),this.ea(n,a),this.Yo(n,l),this.na(n,a.PlayTimeWC||0,a.PlayTime||0),this.Jo(e))}ea(e,t){e.HLSJSVersion=t.HLSJSVersion,e.PlayType=t.PlayType,e.LastMediaCDNServer=t.LastMediaCDNServer,e.MaxVideoQltyIndex=t.MaxVideoQltyIndex,e.MaxReWd=t.MaxReWd,e.MaxReHt=t.MaxReHt,e.InterstitialsEnabled=t.InterstitialsEnabled,e.IsGapless=t.IsGapless,e.IsLoopingPlayer=t.IsLoopingPlayer,e.IsAudioOnly=t.IsAudioOnly,e.IsFirstItem=t.IsFirstItem,e.ItemID=t.ItemID,e.ServerInfo=t.ServerInfo,e.TestGroupId=t.TestGroupId}Yo(e,t){e.OBRLast=t.obrLast,e.OBRMean=t.obrMean;var i=null!=(i=t.curLevelUrl)?i:t.levelUrlLoaded,i=this.Go(i,t);e.ReWd=i.width,e.ReHt=i.height,e.PlayerIBR=i.bandwidth,e.PlayerIABR=i.avgBandwidth,e.BitRnk=i.brRnk}na(e,t,i){e.PlayTimeWC=t,e.PlayTime=i}ba(e){const r={};let n=0,a=0,s=0,o=0;const l=this.Ia(e);e.forEach(e=>{var t=this.Ta(e.levelCodec),i=this.Oa(t,e.videoRange)||0,t={codecs:e.levelCodec,width:e.width,height:e.height,bandwidth:e.bandwidth,avgBandwidth:e.avgBandwidth,framerate:e.frameRate,iframes:e.iframes,brRnk:this.Ma(e.bandwidth,t,l),qltyIndex:i,targetduration:0,playTime:0},i=(o=i>o?i:o,e.url&&(r[e.url]=t),(e.width||0)*(e.height||0));i>s&&(s=i,n=e.width||0,a=e.height||0)});e=0<Object.keys(r).length?Object.values(r).map(e=>e.bandwidth+":"+e.avgBandwidth).join(","):"";return{variantList:r,varListString:e,maxVideoQltyIndex:o,maxWidth:n,maxHeight:a}}Ia(e){let i=0;return e.forEach(e=>{var t=e.bandwidth||0,e=this.Aa(t,this.Ta(e.levelCodec)),t=Math.max(t,e);i=t>i?t:i}),i}Aa(e,t){return t&&"object"==typeof ds[t]?1.5*e:1*e}Ta(e){return e&&e.split(",").map(e=>e.split(".")[0].trim()).find(e=>!!ds[e])}Oa(e,t){if(e)return"object"==typeof ds[e]&&t?ds[e][t]:ds[e]}Ma(e,t,i){e=Math.max(1,this.Aa(e,t));return Math.ceil(100*e/i)}ya(e,t){1===e.playLikelyToKeepUpEventCounter&&(e.startupLatencyInfo||(e.startupLatencyInfo=[]),e.startupLatencyInfo.push(t))}aa(e,t){const i=null==e?void 0:e.filter(e=>e.type===t).sort((e,t)=>e.tbegin-t.tbegin),r=[];return null!=i&&i.forEach(e=>{var t=r[r.length-1];0===r.length||t.tend<e.tbegin?r.push({tbegin:e.tbegin,tend:e.tend}):t.tend=Math.max(t.tend,e.tend)}),r.reduce((e,t)=>e+(t.tend-t.tbegin),0)}Wo(o,l,d){var e={twBRnk:0,twIBR:0,twIABR:0};if(l){let i=0,r=0,n=0,a=0,s=0;Object.values(l).forEach(e=>{let t=e.playTime;d&&e===l[d]&&(t+=o||0),t&&(r+=e.bandwidth*t,i+=e.brRnk*t,n+=t,e.avgBandwidth)&&(a+=e.avgBandwidth*t,s+=t)}),n&&(e.twBRnk=i/n,e.twIBR=r/n),a&&s&&(e.twIABR=a/s)}return e}Zo(e){const t=e.bufferAppendInfo,i=[],r=[];t&&t.forEach&&t.forEach(e=>{i.push(e.latency),r.push(e.size)});var n=this.Ea(i),a=this.Ea(r),s=e.seekInfo,s=this.Ea((null!=s?s:[]).map(e=>e.latency)),o=e.playInfo,o=this.Ea((null!=o?o:[]).map(e=>e.latency)),e=e.liveEdgeInfo;return{bufLatencyInfo:n,bufSizeInfo:a,seekLatencyInfo:s,playLatencyInfo:o,liveEdgeDistInfo:this.Ea((null!=e?e:[]).map(e=>e.liveEdgeDist))}}Ea(e){let t=0,i=0;if(e){var r=e.filter(e=>0<e);if(0<r.length){t=r.reduce((e,t)=>Math.max(e,t));const e=r.length,n=r.sort((e,t)=>e-t),a=Math.ceil(e/2);i=e%2==0?(n[a]+n[a-1])/2:n[a-1]}}return{max:t,median:i}}Go(e,t){return e&&t.manifestData&&t.manifestData.variantList&&t.manifestData.variantList[e]?t.manifestData.variantList[e]:{}}Xo(e){var t;const i=null!=(t=null==e?void 0:e[B.Variant])?t:[],r=[],n=(0<i.length&&i.forEach(e=>{r.push([Number(e.start.toFixed(2)),Number(e.end.toFixed(2))])}),null!=(t=null==e?void 0:e[B.AltAudio])?t:[]),a=[];return 0<n.length&&n.forEach(e=>{a.push([Number(e.start.toFixed(2)),Number(e.end.toFixed(2))])}),[0<r.length?r:void 0,0<a.length?a:void 0]}Sa(e,t){var i,r,e=this.getEntity(e);e&&({playEndedRecord:e,switchCompleteRecord:i,sessionControlRecord:r}=e,!e.StallCount&&!e.MediaEngineStallCount&&t.height&&t.width&&(r.support4KStart&&3800<=t.width&&(r.maxReWd||0)<3800?i.TimeTo4K=performance.now()-r.support4KStart-(e.PauseTime||0):r.supportHDStart&&1850<=t.width&&t.width<2e3&&(r.maxReWd||0)<1850&&(i.TimeToHD=performance.now()-r.supportHDStart-(e.PauseTime||0))),r.maxReWd=Math.max(r.maxReWd||0,t.width||0),r.maxReHt=Math.max(r.maxReHt||0,t.height||0))}oa(e,t){e=Math.abs(e),t=Math.abs(t);return e!==t&&(1<e||1<t)&&!(1<e&&1<t)}ha(e,t,i,r,n,a,s){let o=a&&t&&(!0===r||!1===r)&&n-a<1e4&&t!==e&&r===i&&!s?!0:!1;return o}Na(e,t,i){e=(e||0)+t-i;return 0<e?e:0}Jo(e){const t=this.getEntity(e);if(t){var{sessionControlRecord:i,playStalledRecord:r,mediaEngineStalledRecord:n,switchCompleteRecord:a,playRateChangedRecord:s,variantEndedRecord:o,playErrorRecord:l,nwErrorRecord:d,periodicRecord:u,playEndedRecord:c}=t,h=performance.now()-i.eventStartTime;switch(i.state){case"INIT":case"CANPLAY":u.InitTime=(u.InitTime||0)+h,c.InitTime=(c.InitTime||0)+h;break;case"PAUSE":u.PauseTime=(u.PauseTime||0)+h,c.PauseTime=(c.PauseTime||0)+h,s.LastPause=(s.LastPause||0)+h,c.LastPause=(c.LastPause||0)+h,l.LastPause=(l.LastPause||0)+h,d.LastPause=(d.LastPause||0)+h;break;case"STALL":o.StallTime=(o.StallTime||0)+h,u.StallTime=(u.StallTime||0)+h,c.StallTime=(c.StallTime||0)+h,s.LastStall=(s.LastStall||0)+h,l.LastStall=(l.LastStall||0)+h,c.LastStall=(c.LastStall||0)+h;break;case"MEDIAENGINESTALL":o.MediaEngineStallTime=(o.MediaEngineStallTime||0)+h,u.MediaEngineStallTime=(u.MediaEngineStallTime||0)+h,c.MediaEngineStallTime=(c.MediaEngineStallTime||0)+h,s.LastMediaEngineStall=(s.LastMediaEngineStall||0)+h,l.LastMediaEngineStall=(l.LastMediaEngineStall||0)+h,c.LastMediaEngineStall=(c.LastMediaEngineStall||0)+h;break;case"NWERROR":c.NwErrTime=(c.NwErrTime||0)+h,u.NwErrTime=(u.NwErrTime||0)+h;break;case"PLAYERROR":u.PlayErrTime=(u.PlayErrTime||0)+h,c.PlayErrTime=(c.PlayErrTime||0)+h;break;case"PLAY":{s.RateChangePlayTime=(s.RateChangePlayTime||0)+h,a.PlayTimeLastSW=(a.PlayTimeLastSW||0)+h*(i.oldRate/100),r.LastResume=(r.LastResume||0)+h,n.LastResume=(n.LastResume||0)+h,l.LastResume=(l.LastResume||0)+h,d.LastResume=(d.LastResume||0)+h;const e=(r.StallDetectionTime||0)+(n.StallDetectionTime||0),t=(o.VarPlayTimeWC=this.Na(o.VarPlayTimeWC,h,e),o.VarPlayTime=this.Na(o.VarPlayTime,h*(i.oldRate/100),e),u.PlayTimeWC=this.Na(u.PlayTimeWC,h,e),u.PlayTime=this.Na(u.PlayTime,h*(i.oldRate/100),e),c.PlayTimeWC=this.Na(c.PlayTimeWC,h,e),c.PlayTime=this.Na(c.PlayTime,h*(i.oldRate/100),e),i.curLevelUrl);if(t&&i.intervalVariantList&&i.sessionVariantList){let e=i.intervalVariantList[t];e&&(e.playTime=(e.playTime||0)+h),(e=i.sessionVariantList[t])&&(e.playTime=(e.playTime||0)+h)}break}}}}}const hp={name:"rtc-service"};class pp{constructor(e,t,i,r,n,a){this.Zt=t,this.hlsjsVersion=i,this.Ra=r,this.R=n,this.Pa=a,this.pn=new Ie,this._a=void 0,this.Ca=!1,this.xa=null,this.Da=Number.NEGATIVE_INFINITY,this.La=0,this.Fa=0,this.Yi=e,this.Ba=t.rtcIntervalTimeout||3e5,this.Ua=null,this.rtcStore=new cp(this.R,t.rtcFragInfoWindowSize),this.rtcQuery=new up(this.rtcStore),this.$a=new Set(this.Zt.rtcExcludeKeysList),r.setRTCQuery(this.rtcQuery)}setReportingAgent(e){var t;this._a=e,null!=(t=null==(e=this._a)?void 0:e.setRTCPatternMatchingHandler)&&t.call(e,this.Va.bind(this))}destroy(){this.pn.next(),this.qa(),this.removeItemList(this.rtcStore.getAllItemIds()),this.rtcStore.resetStore(),this.Yi=void 0}detachMedia(){this.qa();try{var e=this.Ha(!0);this.Qa(e)}catch(e){}}endItem(e){this.qa(),this.Qa(e)}itemTransitioned(e,t,i,r,n){this.Qa(e),this.setPeriodic(t),this.Ka({mediaDur:i,currentTime:r,forInterstitial:n})}removeItemList(e){e.forEach(e=>{this.Qa(e)})}setPeriodic(e){this.qa(),this.Ua=setInterval(this.Wa.bind(this,e),this.Ba)}report(i,r){try{switch(i){case 0:this.Ga(r);break;case 1:this.Ka(r);break;case 2:this.Xa(r);break;case 3:this.Ya(r);break;case us:this.Ja(r);break;case 5:this.Za(r);break;case cs:this.il(r);break;case 7:this.rl(r);break;case 8:this.ol(r);break;case 9:this.al(r);break;case hs:this.ll(r);break;case 11:this.ul(r);break;case 12:this.cl(r);break;case 13:this.hl(r);break;case 14:this.dl(r);break;case 15:this.fl(r);break;case 16:this.vl(r);break;case 17:this.yl(r);break;case 18:this.bl(r);break;case 19:this.Sl(r);break;case ps:this.wl(r);break;case 21:this.Il(r);break;case 22:this.Tl(r);break;case 23:this.Ol(r);break;case 24:this.Ml(r);break;case 25:this.Al(r);break;case 26:this.El(r);break;case 27:this.Nl(r);break;case 28:this.Rl(r);break;case 29:this.Pl(r);break;case 30:this._l(r);break;case 31:this.Cl(r);break;case 32:this.xl(r);break;case 33:this.Dl(r);break;case 34:this.Ll(r);break;case 35:this.Fl(r);break;case 36:this.jl(r)}}catch(i){const r=new me(!1,pe.CrashInRtcLib,i.message,i.stack);let e,t;(this.Zt.rtcErrStackNumLines||this.Zt.rtcLogHistoryNumLines)&&(e=re(this.Zt.rtcErrStackNumLines,this.Zt.rtcErrStackNumLines?r.stack:void 0),t=ne(null==(n=this.Pa)?void 0:n.call(this),this.Zt.rtcLogHistoryMaxLineLength));var n=this.Bl(r,e,t,void 0,this.Ha());this.Ul(ls,n)}}Ga(e){this.rtcStore.updateErrorRecoveryRecord(e),this.$l(e.itemId,6204)}Ka(e){var t=this.La,i=this.Fa||1;1<Math.abs(t)&&1<Math.abs(i)||(e.oldRate=t,e.newRate=i,this.rtcStore.updateCanPlay(null!=(t=this.Ha(!0))?t:"",e),this.$l(this.Ha(!0),es),e.latency=fe(this.Da)?performance.now()-this.Da:0,e.url=null!=(i=this.Vl)?i:"",this.rtcStore.updateRateChanged(this.Ha(!0),e),this.$l(this.Ha(!0),ts))}Xa(e){var t;if(this.Yi){var i=e.hlsError;if(i){var r=re(this.Zt.rtcErrStackNumLines,this.Zt.rtcErrStackNumLines?i.stack:void 0),n=ne(null==(t=this.Pa)?void 0:t.call(this),this.Zt.rtcLogHistoryMaxLineLength);if(i.type===K.NETWORK_ERROR?(this.rtcStore.updateNwError(this.Ha(),i,this.Yi.realCurrentTime,null!=(t=e.forInterstitial)&&t),this.$l(this.Ha(),os)):(this.rtcStore.updateMediaError(this.Ha(),i,this.Yi.bufferedDuration,this.Yi.realCurrentTime,null!=(t=e.forInterstitial)&&t),this.$l(this.Ha(),is)),this.Zt.rtcErrStackNumLines||this.Zt.rtcLogHistoryNumLines)if(this.Ha())this.rtcStore.updateDebugInfo(this.Ha(),i,r,n,e.contentUrl),this.$l(this.Ha(),ls);else{const t=this.Bl(i,r,n,e.contentUrl,"teardown-fatal-err");this.Ul(ls,t)}}}}Ya(e){this.Yi&&e.mediaError&&(this.rtcStore.updateMediaElementError(this.Ha(),e.mediaError,this.Yi.bufferedDuration,this.Yi.realCurrentTime,null!=(e=e.forInterstitial)&&e),this.$l(this.Ha(),is))}Ja(e){!this.Yi||!e.hlsError||e.hlsError instanceof io||this.rtcStore.updateNonFatalError(this.Ha(),e.hlsError)}Za(e){var t=e["frag"];this.Yi&&this.ql(t.mediaOptionType)&&(e.serverInfo=null!=(t=this.serverInfoInstance)?t:{},this.rtcStore.updateFragLoaded(e),this.Ra.updateFragLoaded(this.Ca,e))}il(e){this.rtcStore.updateFragParsed(this.Ha(),e)}rl(e){var t,i;this.ql(e.fragmentType)&&(t=e.fragmentType,i=e.dataBytesAppend,void 0!==t)&&void 0!==i&&this.rtcStore.updateFragBuffered(this.Ha(),e)}ol(e){var t,i=e["mediaOptionDetails"];i&&(t=this.Ha(),i.mediaOptionType===we.Variant)&&i.url&&this.rtcStore.updateLevelLoaded(t,e)}al(e){this.rtcStore.updateLevelParsed(this.Ha(),e)}ll(e){this.Yi&&(e.forInterstitial=this.Yi.interstitialActive,this.rtcStore.updateLevelLoadError(this.Ha(),e,this.Yi.bufferedDuration,this.Ca,this.Yi.realCurrentTime||void 0),this.$l(this.Ha(),ns))}ul(e){var t;this.Yi&&({oldVariant:e,url:t}=e,e&&(this.rtcStore.updateVariantEnd(this.Ha(),this.Yi.realCurrentTime,this.Yi.interstitialActive),this.$l(this.Ha(),as)),this.rtcStore.updateLevelSwitched(this.Ha(),this.Ca,t,this.Yi.bufferedDuration,null!=(e=this.Yi.realCurrentTime)?e:void 0,this.Yi.interstitialActive),this.$l(this.Ha(),ns))}cl(e){this.Vl=e}hl(e){this.rtcStore.updateLevelsChanged(this.Ha(),e)}dl(e){var t;this.Yi&&(e.isAudioOnly=this.Yi.inGaplessMode,e.isGapless=this.Yi.inGaplessMode,e.isFirstItem=this.Yi.isFirstItem,e.itemID=((null==(t=this.Yi.reportingAgent)?void 0:t.SessionID)||va())+"-"+this.Ha(),e.forInterstitial=this.Yi.interstitialActive,this.rtcStore.updateManifestParsed(this.Ha(),e),this.Ha())}fl(e){var{event:t,seekInfo:i}=e;if("SEEKING"===t&&i)this.Ca=!0,this.xa=performance.now(),this.rtcStore.updateSeek(this.Ha(!0),e),this.rtcStore.updateWaitForCanPlay(this.Ha(!0));else if("SEEKED"===t){this.Ca=!1;let e=0;this.xa&&(e=performance.now()-this.xa),this.xa=null,this.rtcStore.updateSeeked(this.Ha(!0),{latency:e}),this.$l(this.Ha(!0),ss)}}vl(e){var t;if(this.Yi){var{oldRate:i,newRate:r}=e;if(i!==r){if(0===r||1<Math.abs(i)&&1<Math.abs(r)){const e=null!=(t=this.Yi.bufferedDuration)?t:0,n=null!=(t=this.Yi.realCurrentTime)?t:0;this.Vl&&(this.rtcStore.updateRateChanged(this.Ha(!0),{oldRate:i,newRate:r,latency:0,mediaDur:e,currentTime:n,url:this.Vl,forInterstitial:this.Yi.interstitialActive}),this.$l(this.Ha(!0),ts))}else 1!==i&&1===r&&(this.Da=performance.now()),this.rtcStore.updateWaitForCanPlay(this.Ha(!0));this.La=i,this.Fa=r}}}yl(e){fe(e.startAppend)&&fe(e.endAppend)&&this.rtcStore.updateBufferAppended(this.Ha(),e)}bl(e){var t=this.Ha(!0);if(t){var i=null==(i=this.rtcQuery)?void 0:i.entity(t);if(i&&this.Yi){e.mediaDur=this.Yi.bufferedDuration,e.forInterstitial=this.Yi.interstitialActive,this.rtcStore.updateWaitForCanPlay(t);var i=i.sessionControlRecord.state,{type:r,isLowBufferStall:n}=e.stallInfo;if("PLAY"===i){i=r===uu.LowBuffer||r===uu.Seek&&n;if(this.rtcStore.updateStalled(this.Ha(!0),i,e),this.$l(this.Ha(!0),i?Ja:rs),this.Zt.rtcLogHistoryNumLines&&n){const e=ne(null==(r=this.Pa)?void 0:r.call(this),this.Zt.rtcLogHistoryMaxLineLength),i=null==(n=this.Yi.playingItem)?void 0:n.url;this.rtcStore.updateDebugInfo(t,void 0,void 0,e,i),this.$l(this.Ha(),ls,!0)}}}}}Sl(e){this.rtcStore.updatePlaybackInfo(this.Ha(!0),e),this.Ra.updatePlaybackInfo(this.Ha(!0))}wl(e){this.rtcStore.updateKeySystemEvents(this.Ha(),e)}Il(e){this.rtcStore.updateLicenseChallengeReceived(this.Ha(),e)}Tl(e){this.rtcStore.updateLicenseChallengeSubmitted(this.Ha(),e)}Ol(e){this.rtcStore.updateLicenseChallengeCreated(this.Ha(),e),this.rtcStore.updateLicenseResponseRequested(this.Ha(),e)}Ml(e){this.rtcStore.updateLicenseResponseReceived(this.Ha(),e),this.rtcStore.updateLicenseResponseSubmitted(this.Ha(),e)}Al(e){var t;this.Yi&&(e.currentTime=null!=(t=this.Yi.realCurrentTime)?t:void 0,this.rtcStore.updateLicenseResponseProcessed(this.Ha(),e))}El(e){this.rtcStore.updateLicenseChallengeError(this.Ha(),e)}Nl(e){this.rtcStore.updateLicenseResponseError(this.Ha(),e)}Rl(e){var t,i=this.Ha();i&&(t=null==(t=this.rtcQuery)?void 0:t.entity(i))&&(i=t.sessionControlRecord.activeKeySessions)&&i[e.keyuri]&&("keyAborted"===e.keyErrorType?this.rtcStore.updateKeyAborted(this.Ha(),e):this.rtcStore.updateKeyErrorThrown(this.Ha(),e),this.$l(this.Ha(),Za))}Pl(e){this.rtcStore.updateLicenseChallengeRequested(this.Ha(),e)}_l(e){this.Yi&&(this.rtcStore.updateKeyLoaded(this.Ha(),e),this.$l(this.Ha(),Za))}Cl(e){this.$l(e.itemId,6121)}xl(e){this.$l(e.itemId,6122)}Dl(e){var{itemId:e,playTime:t}=e;this.rtcStore.updateInterstitialPlayTime(e,t||0),this.$l(e,6123)}Ll(e){this.$l(e.itemId,6124)}Fl(e){this.rtcStore.updateMediaControlTimestamps(this.Ha(),e)}jl(e){this.rtcStore.updateFragAborted(this.Ha(),e)}ql(e){return void 0!==e&&(e===we.Variant||e===we.AltAudio||(this.R.error(hp,'Should not have media option type = "%s" in RTC',Vs[e]),!1))}Ha(e=!1,t=!1){if(!this.Yi)return null;let i=this.Yi.currentItem;return null==(i=this.Yi.isPreloading?e?this.Yi.playingItem:this.Yi.loadingItem:i)?null:!t&&null!=(e=i.parentItemId)?e:i.itemId}Wa(e){var t,i;this.Yi&&(this.zl(e),this.rtcStore.updatePeriodic(e,null!=(t=this.Yi.realCurrentTime)?t:void 0,!1,null==(i=(t=this.Zt).performanceStats)?void 0:i.call(t)),this.$l(e,Xa))}qa(){this.Ua&&clearInterval(this.Ua),this.Ua=null}zl(e){for(;this.rtcStore.prepareNonFatalNwError(e);)this.Ul(os,this.rtcQuery.nwError(e));for(;this.rtcStore.prepareNonFatalPlayError(e);)this.Ul(is,this.rtcQuery.playError(e))}Va(){var e,t;this.Yi&&(this.Zt.rtcErrStackNumLines||this.Zt.rtcLogHistoryNumLines)&&(e=ne(null==(e=this.Pa)?void 0:e.call(this),this.Zt.rtcLogHistoryMaxLineLength),t=null==(t=this.Yi.playingItem)?void 0:t.url,this.rtcStore.updateDebugInfo(this.Ha(),void 0,void 0,e,t),this.$l(this.Ha(),ls,!0))}Qa(e){var t,i;e&&this.Yi&&this.rtcStore.getEntity(e)&&(this.rtcStore.updateVariantEnd(e,null!=(t=this.Yi.realCurrentTime)?t:void 0,this.Yi.interstitialActive),this.$l(e,as),this.zl(e),this.rtcStore.updatePeriodic(e,null!=(t=this.Yi.realCurrentTime)?t:void 0,!0,null==(i=(t=this.Zt).performanceStats)?void 0:i.call(t)),this.$l(e,Xa),this.rtcStore.updateEnded(e,null!=(i=this.Yi.realCurrentTime)?i:void 0),this.$l(e,Ya),this.rtcStore.removeEntityByID(e))}$l(e,t,i){if(e){switch(this.Ra.addPlayTime(e),t){case Ya:this.Ul(t,this.rtcQuery.playEnded(e));break;case Ja:this.Ra.updateStallCount(e),this.Ul(t,this.rtcQuery.playStalled(e));break;case Za:this.Ul(t,this.rtcQuery.keySessionComplete(e));break;case es:this.Ra.updateCanPlay(e),this.Ul(t,this.rtcQuery.playLikelyToKeepUp(e));break;case ts:this.Ul(t,this.rtcQuery.playRateChanged(e));break;case is:this.Ra.addToErrorLog(e,"mediaError"),this.Ul(t,this.rtcQuery.playError(e));break;case rs:this.Ra.updateMediaEngineStallCount(e),this.Ul(t,this.rtcQuery.mediaEngineStalled(e));break;case ns:this.Ra.addToAccessLog(e),this.Ul(t,this.rtcQuery.switchComplete(e));break;case ss:this.Ul(t,this.rtcQuery.seekComplete(e));break;case as:this.Ul(t,this.rtcQuery.variantEnded(e));break;case os:this.Ra.addToErrorLog(e,"networkError"),this.Ul(t,this.rtcQuery.nwError(e));break;case ls:this.Ul(t,this.rtcQuery.debugInfo(e),i);break;case 6204:this.Ul(t,this.rtcQuery.errorRecovery(e));break;case Xa:case 6121:case 6122:case 6123:case 6124:this.Ul(t,this.rtcQuery.periodic(e));break;default:return void this.R.error(hp,`Unknown rtc event eventGroupId:`+e)}this.rtcStore.finalize(e,t)}}Ul(e,t,r){if(t&&(e!==Xa||t.PlayTimeWC||t.ADT)){var n=e===Ya||e===Xa?1:0;if(this._a){let i={};Object.entries(t).forEach(([e,t])=>{this.$a.has(e)||("object"==typeof(t=fe(t)?Number(Number(t).toFixed(2)):t)?"ServerInfo"===e?Object.entries(null!=t?t:{}).forEach(([e,t])=>{i[e]=t}):this.Hl(e)&&(i[e]=t):i[e]=t)}),i=JSON.parse(JSON.stringify(i));try{this._a.issueReportingEvent(e,i,n,(e,t,i)=>{},r).then(e=>{})}catch(e){}}}}Hl(e){return"VariantFragLoadInfo"===e||"VariantFragParseInfo"===e||"VariantFragAppendInfo"===e||"AudioFragLoadInfo"===e||"AudioFragParseInfo"===e||"AudioFragAppendInfo"===e||"VariantBufferInfo"===e||"AudioBufferInfo"===e||"KeySystemEvents"===e||"KeySystemInitEvents"===e||"MediaControlTimestamps"===e||"NonFatalErrTimestamps"===e||"AbrContext"===e||"PlatformCapabilitiesFilterBreakdown"===e}Bl(e,t,i,r,n){return{ErrCode:e.details,ErrReason:e.response,ErrDomain:e.type===K.NETWORK_ERROR?"networkError":"mediaError",ErrStack:t,LogHistory:i,ContentUrl:r,HLSJSVersion:this.hlsjsVersion,InterstitialsEnabled:this.Zt.enableInterstitialPlayback,ItemID:n,TestGroupId:this.Zt.testGroupId}}}const mp={cache:{},setCombinedEstimate:function(e,t,i,r){if(void 0!==e.storage.set){var n={avgLatencyMs:t.avgLatencyMs,avgBandwidth:t.avgBandwidth},n={bwRecord:Object.assign({},n,{expires:Date.now()+e.bandwidthHistoryTTL}),serviceStats:{maxDuration:t.maxDurationSec,avgFragParseTimeMs:t.avgParseTimeMs,avgFragBufferCreationDelayMs:t.avgBufferCreateMs,avgPlaylistLoadTimeMs:t.avgPlaylistLoadTimeMs,avgPlaylistParseTimeMs:t.avgPlaylistParseTimeMs,avgInitFragAppendMs:t.avgInitFragAppendMs,avgDataFragAppendMs:t.avgDataFragAppendMs}},t=(this.cache[r]=void 0,e.storageKeyPrefix+r);try{e.storage.set(t,JSON.stringify(n))}catch(e){}}},getCombinedEstimate:function(e,t,i){if(void 0===e.storage.get)return this.convertStorageJsonToCombinedEstimate(void 0);let r;const n=this.cache[i];if(n)r=n;else try{const t=e.storageKeyPrefix+i,n=e.storage.get(t);r=n?JSON.parse(n):void 0}catch(e){}null!=r&&r.bwRecord&&void 0!==r.bwRecord.expires&&r.bwRecord.expires<Date.now()&&(r.bwRecord={avgLatencyMs:NaN,avgBandwidth:NaN,expires:r.bwRecord.expires});var a=this.convertStorageJsonToCombinedEstimate(r);return this.cache[i]=r,a},convertStorageJsonToCombinedEstimate:function(e){var t=null==e?void 0:e.bwRecord,e=null==e?void 0:e.serviceStats;return{avgLatencyMs:(null==t?void 0:t.avgLatencyMs)||NaN,avgBandwidth:(null==t?void 0:t.avgBandwidth)||NaN,maxDurationSec:(null==e?void 0:e.maxDuration)||NaN,avgParseTimeMs:(null==e?void 0:e.avgFragParseTimeMs)||NaN,avgBufferCreateMs:(null==e?void 0:e.avgFragBufferCreationDelayMs)||NaN,avgPlaylistLoadTimeMs:(null==e?void 0:e.avgPlaylistLoadTimeMs)||NaN,avgPlaylistParseTimeMs:(null==e?void 0:e.avgPlaylistParseTimeMs)||NaN,avgInitFragAppendMs:(null==e?void 0:e.avgInitFragAppendMs)||NaN,avgDataFragAppendMs:(null==e?void 0:e.avgDataFragAppendMs)||NaN}},getBandwidthEstimate:function(e,t,i){e=this.getCombinedEstimate(e,t,i),t={avgLatencyMs:null==e?void 0:e.avgLatencyMs,avgBandwidth:null==e?void 0:e.avgBandwidth};return fe(t.avgLatencyMs)||(t.avgLatencyMs=NaN),fe(t.avgBandwidth)||(t.avgBandwidth=NaN),t},getPlaylistEstimate:function(e,t,i){e=this.getCombinedEstimate(e,t,i),t={avgPlaylistLoadTimeMs:null==e?void 0:e.avgPlaylistLoadTimeMs,avgPlaylistParseTimeMs:null==e?void 0:e.avgPlaylistParseTimeMs};return fe(t.avgPlaylistLoadTimeMs)||(t.avgPlaylistLoadTimeMs=NaN),fe(t.avgPlaylistParseTimeMs)||(t.avgPlaylistParseTimeMs=NaN),t},getFragEstimate:function(e,t,i){e=this.getCombinedEstimate(e,t,i),t={maxDurationSec:null==e?void 0:e.maxDurationSec,avgParseTimeMs:null==e?void 0:e.avgParseTimeMs};return fe(t.maxDurationSec)||(t.maxDurationSec=NaN),fe(t.avgParseTimeMs)||(t.avgParseTimeMs=NaN),t},getBufferEstimate:function(e,t,i){e=this.getCombinedEstimate(e,t,i),t={avgBufferCreateMs:null==e?void 0:e.avgBufferCreateMs,avgInitFragAppendMs:null==e?void 0:e.avgInitFragAppendMs,avgDataFragAppendMs:null==e?void 0:e.avgDataFragAppendMs};return fe(t.avgBufferCreateMs)||(t.avgBufferCreateMs=NaN),fe(t.avgInitFragAppendMs)||(t.avgInitFragAppendMs=NaN),fe(t.avgDataFragAppendMs)||(t.avgDataFragAppendMs=NaN),t}};var fp,gp,yp,U,vp,Ip,Sp,bp,Tp,Ap=mp;function Ep(e,t){return e.start!==t.start?e.start-t.start:e.end-t.end}function Op(e,t,i){let r=e.length-1;for(;0<=r&&i(t,e[r])<=0;)--r;e.splice(r+1,0,t)}class wp{constructor(e,t){this.Ql=[],this.Kl=[],this.Wl=1,this.Gl=e.bandwidthHistoryWindowSize,this.Xl=e.bandwidthHistoryAggregationMethod,this.Yl=this.Yl.bind(this),this.Jl=new jr(t),this.Zl=e.bandwidthHistoryMinStableEntrySizeBits}get estimate$(){return this.Jl.asObservable()}record(e){var t,{trequest:e,tfirst:i,tload:r,bitsDownloaded:n}=e;e===r||i===r||isNaN(i)||isNaN(r)||(t=Math.max(1,r-i),this.tu(e,i),this.nu(i,r,1e3*n/t),this.Jl.closed)||(e=this.getEstimate(),this.Jl.next(e))}getEstimate(){var e,t,i,r;return this.Ql.length<this.Wl?{avgLatencyMs:NaN,avgBandwidth:NaN}:(e=performance.now()-this.Gl,t=Ds[this.Xl],i=this.Ql.map(({start:e,end:t})=>{e=t-e;return{timestamp:t,value:e,duration:e}}),this.Kl=function(r){for(var t=[],n=function(t,i){if(t.length){for(let e=0;e<t.length;e++)if(t[e].start>i.start||t[e].start===i.start&&t[e].end>i.end){t.splice(e,0,i);break}}else t.push(i)};r.length;){var a=r[0];r.shift();let e={start:-1,end:-1,bitsPerSec:0};if(t.length&&(e=t[t.length-1]),0===t.length||e.end<=a.start)t.push(a);else if(a.start===e.start)a.end===e.end?e.bitsPerSec+=a.bitsPerSec:a.end<e.end||(e.bitsPerSec+=a.bitsPerSec,a.start=e.end,n(r,a));else{var s=e.end,o=e.bitsPerSec,i=(e.end=a.start,{start:a.start,end:Math.min(s,a.end),bitsPerSec:a.bitsPerSec+o});if(t.push(i),s!==a.end){let e=0,t=0,i=0;i=s<a.end?(e=s,t=a.end,a.bitsPerSec):(e=a.end,t=s,o),n(r,{start:e,end:t,bitsPerSec:i})}}}return t}(this.Kl),r=this.Kl.filter(e=>e.bitsPerSec*(e.end-e.start)>=this.Zl).map(({start:e,end:t,bitsPerSec:i})=>({timestamp:t,duration:t-e,value:i})),{avgLatencyMs:t(i,e,this.Gl),avgBandwidth:t(r,e,this.Gl)})}getLatest(){var e,t;return 0===this.Ql.length?{avgLatencyMs:NaN,avgBandwidth:NaN}:(e=this.Ql[this.Ql.length-1],t=this.Kl[this.Kl.length-1],{avgLatencyMs:e.end-e.start,avgBandwidth:t.bitsPerSec})}tu(e,t){Op(this.Ql,{start:e,end:t},Ep),this.ou(t)}nu(e,t,i){Op(this.Kl,{start:e,end:t,bitsPerSec:i},Ep),this.ou(t)}au(e){this.uu=setTimeout(this.Yl,Math.max(e-performance.now(),0)),this.du=e}fu(){void 0!==this.uu&&(clearTimeout(this.uu),this.uu=void 0),this.du=void 0}ou(e){e+=this.Gl;(!this.du||e<this.du)&&(this.fu(),this.au(e))}Yl(){this.fu();const t=performance.now()-this.Gl;if(this.Ql=this.Ql.filter(e=>e.end>=t),this.Kl=this.Kl.filter(e=>e.end>=t),this.Jl.closed||this.Jl.next(this.getEstimate()),0<this.Ql.length||0<this.Kl.length){const t=Math.min(...this.Ql.map(e=>e.end),...this.Kl.map(e=>e.end));this.ou(t)}}destroy(){this.fu(),this.Jl.complete(),this.Ql=[],this.Kl=[]}}class Rp{constructor(e=0){this.vu=e,this.mu=0,this.yu=Number.NEGATIVE_INFINITY,this.Su=0}get avg(){return this.Su<this.vu?NaN:this.mu/this.Su}get max(){return 0<this.count?this.yu:NaN}get count(){return this.Su}reset(){this.mu=0,this.Su=0,this.yu=Number.NEGATIVE_INFINITY}add(e){this.mu+=e,this.yu=Math.max(this.yu,e),++this.Su}}class Mp{constructor(e,t,i){this.Me=e,this.id=t,this.R=i}getBandwidthEstimate(e,t=!0){var i=null!=(i=Object.assign({},null==(i=this.statsEntity)?void 0:i.bandwidthEstimate))?i:{};return fe(i.avgBandwidth)&&fe(i.avgLatencyMs)?{avgBandwidth:i.avgBandwidth,avgLatencyMs:i.avgLatencyMs}:null!=e&&e.storage&&t?P(i,mp.getBandwidthEstimate(e,this.R,this.id)):(i.avgBandwidth=NaN,i.avgLatencyMs=NaN,{avgBandwidth:i.avgBandwidth,avgLatencyMs:i.avgLatencyMs})}getPlaylistEstimate(e,t=!0){let i=null!=(r=Object.assign({},null==(r=this.statsEntity)?void 0:r.playlistEstimate))?r:{};var r=e=>fe(e.avgPlaylistLoadTimeMs)&&fe(e.avgPlaylistParseTimeMs);if(!r(i)){if(null!=e&&e.storage&&t){const t=P(i,mp.getPlaylistEstimate(e,this.R,this.id));if(r(t))return t}if(null!=e&&e.statDefaults){const t=e.statDefaults;i=P(i,{avgPlaylistLoadTimeMs:t.playlistLoadTimeMs,avgPlaylistParseTimeMs:t.playlistParseTimeMs})}}return i}getBufferEstimate(e,t=!0){let i=null!=(r=Object.assign({},null==(r=this.statsEntity)?void 0:r.bufferEstimate))?r:{};var r=e=>fe(e.avgBufferCreateMs)&&fe(e.avgDataFragAppendMs)&&fe(e.avgInitFragAppendMs);if(!r(i)){if(null!=e&&e.storage&&t){const t=P(i,mp.getBufferEstimate(e,this.R,this.id));if(r(t))return t}if(null!=e&&e.statDefaults){const t=e.statDefaults;i=P(i,{avgBufferCreateMs:t.fragBufferCreationDelayMs,avgInitFragAppendMs:t.initFragAppendMs,avgDataFragAppendMs:t.dataFragAppendMs})}}return i}getFragEstimate(e,t=!0){let i=null!=(r=Object.assign({},null==(r=this.statsEntity)?void 0:r.fragEstimate))?r:{};var r=e=>fe(e.maxDurationSec)&&fe(e.avgParseTimeMs);if(!r(i)){if(null!=e&&e.storage&&t){const t=P(i,mp.getFragEstimate(e,this.R,this.id));if(r(t))return t}null!=e&&e.statDefaults&&(i=P(i,{avgParseTimeMs:e.statDefaults.fragParseTimeMs,maxDurationSec:e.defaultTargetDuration}))}return i}getCombinedEstimate(e,t=!0){return Object.assign(Object.assign(Object.assign(Object.assign({},this.getFragEstimate(e,t)),this.getPlaylistEstimate(e,t)),this.getBufferEstimate(e,t)),this.getBandwidthEstimate(e,t))}get statsEntity(){var e;return null==(e=this.Me)?void 0:e.getEntity(this.id)}hasEntity(e){var t;return null!=(null==(t=this.Me)?void 0:t.getEntity(e))}get bandwidthStatus(){var e;return null!=(e=null==(e=this.statsEntity)?void 0:e.bandwidthStatus)?e:{bandwidthSampleCount:0,instantBw:0}}}class Pp extends class{constructor(){this.storage=new Map}get activeId(){return this.$s}set activeId(e){this.$s=e}getEntity(e){return this.storage.get(e)}setEntity(e,t){this.storage.set(e,t)}setActive(e){this.activeId=e}getActive(){var e=this.activeId;if(null!=e)return this.getEntity(e)}updateActive(e){var t=this.activeId;t&&this.updateEntity(t,e)}updateEntity(e,t){if("function"==typeof t){var i=this.storage.get(e);i&&t(i)}else if("object"==typeof t){var r,n=this.storage.get(e);if(n)for(const e in t)Object.prototype.hasOwnProperty.call(t,e)&&(r=t[e],n[e]=r)}}add(e){this.storage.set(e.id,e)}remove(e){void 0===e?this.removeAll():this.storage.delete(e),e===this.activeId&&(this.activeId=void 0)}removeAll(){this.storage.clear(),this.activeId=void 0}}{static createEmptyEntity(e){return{id:e,bandwidthStatus:{bandwidthSampleCount:0,instantBw:NaN},bandwidthEstimate:{avgLatencyMs:NaN,avgBandwidth:NaN},fragEstimate:{maxDurationSec:NaN,avgParseTimeMs:NaN},playlistEstimate:{avgPlaylistLoadTimeMs:NaN,avgPlaylistParseTimeMs:NaN},bufferEstimate:{avgBufferCreateMs:NaN,avgInitFragAppendMs:NaN,avgDataFragAppendMs:NaN}}}initStatsForService(e){this.getEntity(e)||this.setEntity(e,Pp.createEmptyEntity(e))}}class Cp{constructor(e,t,i){this.wu=e,this.R=t,this.Iu=new Map,this.Tu=new Rp(i.minPlaylistCount),this.Ou=new Rp(i.minPlaylistCount),this.Mu=new Rp,this.Au=new Rp(i.minFragmentCount),this.Eu=new wp(i,{avgLatencyMs:NaN,avgBandwidth:NaN}),this.Nu=new Rp,this.Ru=new Rp,this.Pu=new Rp(i.minFragmentCount)}getQueryForId(e){let t=this.Iu.get(e);return t||(t=new Mp(this.wu,e,this.R),this.Iu.set(e,t)),t}remove(e){this.Iu.delete(e),this.wu.remove(e)}removeAll(){this.Iu.clear(),this.wu.removeAll()}destroy(){this.wu.removeAll(),this.Eu.destroy(),this.Iu.clear()}updateBandwidthEstimate(e){const t=null==(i=this.wu.getActive())?void 0:i.id;if(t){var i=this.getQueryForId(t);if(i){if(e.mediaOptionType===we.Variant){const t=null!=(i=null==(r=i.bandwidthStatus)?void 0:r.bandwidthSampleCount)?i:0;var r={bandwidthSampleCount:t+1,instantBw:8e3*e.loaded/(e.tload-e.tfirst)};this.setBandwidthStatus(r)}if(e.complete){const i=8*e.loaded,r=(this.Eu.record({trequest:e.trequest,tfirst:e.tfirst,tload:e.tload,bitsDownloaded:i}),this.Eu.getEstimate());this.setBandwidthEstimate(r)}}}}updateFragEstimate(e){var t;null!=(t=this.wu.getActive())&&t.id&&(this.Mu.add(e.durationSec),this.Au.add(e.parseTimeMs),this.setFragEstimate({maxDurationSec:this.Mu.max,avgParseTimeMs:this.Au.avg}))}updatePlaylistEstimate(e){var t;if(null!=(t=this.wu.getActive())&&t.id){this.Tu.add(e.playlistLoadTimeMs),this.Ou.add(e.playlistParseTimeMs);const t={avgPlaylistLoadTimeMs:this.Tu.avg,avgPlaylistParseTimeMs:this.Ou.avg};this.setPlaylistEstimate(t)}}updateBufferEstimate(e){var t;null!=(t=this.wu.getActive())&&t.id&&(fe(e.bufferCreationStart)&&fe(e.bufferCreationEnd)&&this.Nu.add(e.bufferCreationEnd-e.bufferCreationStart),fe(e.startInitAppend)&&fe(e.endInitAppend)&&this.Ru.add(e.endInitAppend-e.startInitAppend),fe(e.startDataAppend)&&fe(e.endDataAppend)&&this.Pu.add(e.endDataAppend-e.startDataAppend),this.setBufferEstimate({avgBufferCreateMs:this.Nu.avg,avgInitFragAppendMs:this.Ru.avg,avgDataFragAppendMs:this.Pu.avg}))}setBandwidthEstimate(t){var e;se(null==(e=this.wu.getActive())?void 0:e.bandwidthEstimate,t)||this.wu.updateActive(e=>{e.bandwidthEstimate=t})}setBandwidthStatus(t){this.wu.updateActive(e=>{e.bandwidthStatus=t})}setFragEstimate(t){var e;se(null==(e=this.wu.getActive())?void 0:e.fragEstimate,t)||this.wu.updateActive(e=>{e.fragEstimate=t})}setPlaylistEstimate(t){var e;se(null==(e=this.wu.getActive())?void 0:e.playlistEstimate,t)||this.wu.updateActive(e=>{e.playlistEstimate=t})}setBufferEstimate(t){var e;se(null==(e=this.wu.getActive())?void 0:e.bufferEstimate,t)||this.wu.updateActive(e=>{e.bufferEstimate=t})}setActive(e){this.wu.setActive(e),this.wu.initStatsForService(e)}addEmptyEntity(e){this.wu.initStatsForService(e),this.setActive(e)}}const kp={af:"afr",am:"amh",ar:"ara",as:"asm",ay:"aym",az:"aze",be:"bel",bg:"bul",bh:"bih",bn:"ben",bo:"bod",br:"bre",bs:"bos",ca:"cat",ce:"che",co:"cos",cs:"ces",cy:"cym",da:"dan",de:"deu",dz:"dzo",el:"ell",en:"eng",eo:"epo",es:"spa",et:"est",eu:"eus",fa:"fas",fi:"fin",fo:"fao",fr:"fra",ga:"gle",gd:"gla",gl:"glg",gn:"grn",gu:"guj",gv:"glv",he:"heb",hi:"hin",hr:"hrv",hu:"hun",hy:"hye",ia:"ina",id:"ind",ie:"ile",is:"isl",it:"ita",iu:"iku",ja:"jpn",jv:"jav",ka:"kat",kk:"kaz",kl:"kal",km:"khm",kn:"kan",ko:"kor",ks:"kas",ku:"kur",kw:"cor",ky:"kir",la:"lat",lb:"ltz",lo:"lao",lt:"lit",lv:"lav",mg:"mlg",mk:"mkd",ml:"mal",mn:"mon",mo:"mol",mr:"mar",ms:"msa",mt:"mlt",my:"mya",nb:"nob",ne:"nep",nl:"nld",nn:"nno",ny:"nya",oc:"oci",om:"orm",or:"ori",pa:"pan",pl:"pol",ps:"pus",pt:"por",qu:"que",rm:"roh",rn:"run",ro:"ron",ru:"rus",rw:"kin",sa:"san",sd:"snd",se:"sme",si:"sin",sk:"slk",sl:"slv",so:"som",sq:"sqi",sr:"srp",su:"sun",sv:"swe",sw:"swa",ta:"tam",te:"tel",tg:"tgk",th:"tha",ti:"tir",tk:"tuk",tl:"tgl",to:"ton",tr:"tur",tt:"tat",ug:"uig",uk:"ukr",ur:"urd",uz:"uzb",vi:"vie",yi:"yid",zh:"zho",dv:"div",ig:"ibo",kr:"kau",ve:"ven",ii:"iii",fy:"fry",ht:"hat",an:"arg",li:"lim",wa:"wln",io:"ido",nr:"nbl",nd:"nde",ae:"ave",bm:"bam",ch:"cha",cu:"chu",cv:"chv",hz:"her",ho:"hmo",ki:"kik",kv:"kom",kj:"kua",mh:"mah",mi:"mri",nv:"nav",ng:"ndo",os:"oss",pi:"pli",sc:"srd",ty:"tah",ak:"aka",av:"ava",cr:"cre",ee:"ewe",ff:"ful",kg:"kon",lu:"lub",lg:"lug",oj:"oji",za:"zha"},Lp={no:"nor",tl:"tgl",tw:"twi",nor:"nor",tgl:"tgl",twi:"twi"},Dp={mapValue(e){var t;if(e)return e=e.split("-")[0],null!=(t=Lp[e])?t:kp[e]}},xp={"art-lojban":"jbo","en-gb-oed":"en-GB-oxendict","i-ami":"ami","i-bnn":"bnn","i-hak":"hak","i-klingon":"tlh","i-lux":"lb","i-navajo":"nv","i-pwn":"pwn","i-tao":"tao","i-tay":"tay","i-tsu":"tsu","no-bok":"nb","no-nyn":"nn","sgn-be-fr":"sfb","sgn-be-nl":"vgt","sgn-ch-de":"sgg","zh-guoyu":"cmn","zh-hakka":"hak","zh-minnan":"nan","zh-min-nan":"nan","zh-xiang":"hsn"},Np={afr:"af",aka:"ak",amh:"am",ara:"ar",arg:"an",asm:"as",ava:"av",ave:"ae",aym:"ay",aze:"az",bam:"bm",bel:"be",ben:"bn",bih:"bh",bod:"bo",bos:"bs",bre:"br",bul:"bg",cat:"ca",ces:"cs",cha:"ch",che:"ce",chu:"cu",chv:"cv",cor:"kw",cos:"co",cre:"cr",cym:"cy",dan:"da",deu:"de",div:"dv",dzo:"dz",ell:"el",eng:"en",epo:"eo",est:"et",eus:"eu",ewe:"ee",fao:"fo",fas:"fa",fin:"fi",fra:"fr",fry:"fy",ful:"ff",gla:"gd",gle:"ga",glg:"gl",glv:"gv",grn:"gn",guj:"gu",hat:"ht",heb:"he",her:"hz",hin:"hi",hmo:"ho",hrv:"hr",hun:"hu",hye:"hy",ibo:"ig",ido:"io",iii:"ii",iku:"iu",ile:"ie",ina:"ia",ind:"id",isl:"is",ita:"it",jav:"jv",jpn:"ja",kal:"kl",kan:"kn",kas:"ks",kat:"ka",kau:"kr",kaz:"kk",khm:"km",kik:"ki",kin:"rw",kir:"ky",kom:"kv",kon:"kg",kor:"ko",kua:"kj",kur:"ku",lao:"lo",lat:"la",lav:"lv",lim:"li",lit:"lt",ltz:"lb",lub:"lu",lug:"lg",mah:"mh",mal:"ml",mar:"mr",mkd:"mk",mlg:"mg",mlt:"mt",mol:"mo",mon:"mn",mri:"mi",msa:"ms",mya:"my",nav:"nv",nbl:"nr",nde:"nd",ndo:"ng",nep:"ne",nld:"nl",nno:"nn",nob:"nb",nya:"ny",oci:"oc",oji:"oj",ori:"or",orm:"om",oss:"os",pan:"pa",pli:"pi",pol:"pl",por:"pt",pus:"ps",que:"qu",roh:"rm",ron:"ro",run:"rn",rus:"ru",san:"sa",sin:"si",slk:"sk",slv:"sl",sme:"se",snd:"sd",som:"so",spa:"es",sqi:"sq",srd:"sc",srp:"sr",sun:"su",swa:"sw",swe:"sv",tah:"ty",tam:"ta",tat:"tt",tel:"te",tgk:"tg",tgl:"tl",tha:"th",tir:"ti",ton:"to",tuk:"tk",tur:"tr",uig:"ug",ukr:"uk",urd:"ur",uzb:"uz",ven:"ve",vie:"vi",wln:"wa",yid:"yi",zha:"za",zho:"zh"},Fp={in:"id",iw:"he",ji:"yi",jw:"jv",mo:"ro",scc:"sr",scr:"hr",aam:"aas",adp:"dz",aue:"ktz",ayx:"nun",bgm:"bcg",bjd:"drl",ccq:"rki",cjr:"mom",cka:"cmr",cmk:"xch",coy:"pij",cqu:"quh",drh:"mn",gav:"dev",gfx:"vaj",ggn:"gvr",gti:"nyc",guv:"duz",hrr:"jal",ibi:"opa",ilw:"gal",jeg:"oyb",kgc:"tdf",kgh:"kml",koj:"kwv",krm:"bmf",ktr:"dtp",kvs:"gdj",kwq:"yam",kxe:"tvd",kzj:"dtp",kzt:"dtp",lii:"raq",lmm:"rmx",meg:"cir",mst:"mry",mwj:"vaj",myt:"mry",nad:"xny",ncp:"kdz",nnx:"ngv",nts:"pij",oun:"vaj",pcr:"adx",pmc:"huw",pmu:"phr",ppa:"bfy",ppr:"lcq",pry:"prt",puz:"pub",sca:"hle",skk:"oyb",tdu:"dtp",thc:"tpo",thx:"oyb",tie:"ras",tkk:"twm",tlw:"weo",tmp:"tyj",tne:"kak",tsf:"taj",uok:"ema",xba:"cax",xia:"acn",xkh:"waw",xsj:"suj",ybd:"rki",yma:"lrr",ymt:"mtm",yos:"zom",yuu:"yug",asd:"snz",dit:"dif",llo:"ngt",myd:"aog",nns:"nbr",no:"nb",tl:"fil",aju:"jrb",als:"sq",arb:"ar",ayr:"ay",azj:"az",bcc:"bal",bcl:"bik",bxk:"luy",bxr:"bua",cld:"syr",cmn:"zh",cwd:"cr",dgo:"doi",dhd:"mwr",dik:"din",diq:"zza",lbk:"bnc",ekk:"et",emk:"man",esk:"ik",fat:"ak",fuc:"ff",gaz:"om",gbo:"grb",gno:"gon",gug:"gn",gya:"gba",hdn:"hai",hea:"hmn",ike:"iu",kmr:"ku",knc:"kr",kng:"kg",knn:"kok",kpv:"kv",lvs:"lv",mhr:"chm",mup:"raj",khk:"mn",npi:"ne",ojg:"oj",ory:"or",pbu:"ps",pes:"fa",plt:"mg",pnb:"lah",quz:"qu",rmy:"rom",spy:"kln",src:"sc",swh:"sw",ttq:"tmh",tw:"ak",umu:"del",uzn:"uz",xpe:"kpe",xsl:"den",ydd:"yi",zai:"zap",zsm:"ms",zyb:"za",him:"srx",mnk:"man",bh:"bho",aar:"aa",abk:"ab",bak:"ba",bis:"bi",fij:"fj",hau:"ha",ipk:"ik",lat:"la",lin:"ln",nau:"na",nor:"nb",sag:"sg",smo:"sm",sna:"sn",ssw:"ss",sot:"st",tsn:"tn",tso:"ts",twi:"ak",vol:"vo",wol:"wo",xho:"xh",yor:"yo",zul:"zu",alb:"sq",arm:"hy",baq:"eu",bur:"my",chi:"zh",cze:"cs",dut:"nl",fre:"fr",geo:"ka",ger:"de",gre:"el",ice:"is",mac:"mk",mao:"mi",may:"ms",per:"fa",rum:"ro",slo:"sk",tib:"bo",wel:"cy"},Bp=[[{lang:"drw"},{lang:"fa",region:"af"}],[{lang:"tnf"},{lang:"fa",region:"af"}],[{lang:"sgn",region:"br"},{lang:"bzs"}],[{lang:"sgn",region:"co"},{lang:"csn"}],[{lang:"sgn",region:"de"},{lang:"gsg"}],[{lang:"sgn",region:"dk"},{lang:"dsl"}],[{lang:"sgn",region:"fr"},{lang:"fsl"}],[{lang:"sgn",region:"gb"},{lang:"bfi"}],[{lang:"sgn",region:"gr"},{lang:"gss"}],[{lang:"sgn",region:"ie"},{lang:"isg"}],[{lang:"sgn",region:"it"},{lang:"ise"}],[{lang:"sgn",region:"jp"},{lang:"jsl"}],[{lang:"sgn",region:"ni"},{lang:"ncs"}],[{lang:"sgn",region:"nl"},{lang:"dse"}],[{lang:"sgn",region:"no"},{lang:"nsi"}],[{lang:"sgn",region:"pt"},{lang:"psr"}],[{lang:"sgn",region:"se"},{lang:"swl"}],[{lang:"sgn",region:"us"},{lang:"ase"}],[{lang:"sgn",region:"za"},{lang:"sfs"}],[{baseName:"no-bokmal"},{lang:"nb"}],[{baseName:"no-nynorsk"},{lang:"nn"}],[{baseName:"aa-saaho"},{lang:"ssy"}],[{lang:"sh"},{lang:"sr",script:"latn"}],[{lang:"cnr"},{lang:"sr",region:"me"}],[{lang:"az",region:"az"},{lang:"az",script:"latn",region:"az"}],[{lang:"bs",region:"ba"},{lang:"bs",script:"latn",region:"ba"}],[{lang:"ha",script:"latn",region:"gh"},{lang:"ha",region:"gh"}],[{lang:"ha",script:"latn",region:"ne"},{lang:"ha",region:"ne"}],[{lang:"ha",script:"latn",region:"ng"},{lang:"ha",region:"ng"}],[{lang:"kk",script:"cyrl",region:"kz"},{lang:"kk",region:"kz"}],[{lang:"kk",script:"cyrl",region:"kg"},{lang:"kk",region:"kg"}],[{lang:"ks",script:"arab",region:"in"},{lang:"ks",region:"in"}],[{lang:"mn",script:"cyrl",region:"mn"},{lang:"mn",region:"mn"}],[{lang:"ms",script:"latn",region:"bn"},{lang:"ms",region:"bn"}],[{lang:"ms",script:"latn",region:"my"},{lang:"ms",region:"my"}],[{lang:"ms",script:"latn",region:"my"},{lang:"ms",region:"my"}],[{lang:"ms",script:"latn",region:"sg"},{lang:"ms",region:"sg"}],[{lang:"pa",region:"in"},{lang:"pa",script:"guru",region:"in"}],[{lang:"pa",region:"pk"},{lang:"pa",script:"arab",region:"pk"}],[{lang:"shi",region:"ma"},{lang:"shi",script:"tfng",region:"ma"}],[{lang:"sr",region:"ba"},{lang:"sr",script:"cyrl",region:"ba"}],[{lang:"sr",region:"me"},{lang:"sr",script:"latn",region:"me"}],[{lang:"sr",region:"rs"},{lang:"sr",script:"cyrl",region:"rs"}],[{lang:"sr",region:"xk"},{lang:"sr",script:"cyrl",region:"xk"}],[{lang:"tzm",script:"latn",region:"ma"},{lang:"tzm",region:"ma"}],[{lang:"ug",script:"arab",region:"cn"},{lang:"ug",region:"cn"}],[{lang:"uz",region:"af"},{lang:"uz",script:"arab",region:"af"}],[{lang:"uz",region:"uz"},{lang:"uz",script:"latn",region:"uz"}],[{lang:"vai",region:"lr"},{lang:"vai",script:"vaii",region:"lr"}],[{lang:"yue",region:"cn"},{lang:"yue",script:"hans",region:"cn"}],[{lang:"yue",region:"hk"},{lang:"yue",script:"hant",region:"hk"}],[{lang:"zh",region:"cn"},{lang:"zh",script:"hans",region:"cn"}],[{lang:"zh",region:"hk"},{lang:"zh",script:"hant",region:"hk"}],[{lang:"zh",region:"mo"},{lang:"zh",script:"hant",region:"mo"}],[{lang:"zh",region:"sg"},{lang:"zh",script:"hans",region:"sg"}],[{lang:"zh",region:"tw"},{lang:"zh",script:"hant",region:"tw"}],[{lang:"prs"},{lang:"fa",region:"af"}],[{lang:"swc"},{lang:"sw",region:"cd"}],[{lang:"hbs"},{lang:"sr",region:"latn"}]],Up={qaai:"zinh"},_p={bu:"mm",ct:"ki",dd:"de",dy:"bj",fx:"fr",hv:"bf",jt:"um",mi:"um",nh:"vu",nq:"aq",pu:"um",pz:"pa",qu:"eu",rh:"zw",tp:"tl",uk:"gb",vd:"vn",wk:"um",yd:"ye",zr:"cd"},Vp=["mni-beng-in","mni-mtei-in","sat-deva-in","sat-olck-in","shi-latn-ma","shi-tfng-ma","vai-latn-lr","vai-vaii-lr","yue-hans-cn","yue-hant-hk","az-arab-ir","az-cyrl-az","az-latn-az","bm-nkoo-ml","bs-cyrl-ba","bs-latn-ba","en-dsrt-us","ff-adlm-gn","ff-latn-sn","ha-arab-ng","hi-latn-in","iu-latn-ca","ks-arab-in","ks-deva-in","mn-mong-cn","ms-arab-my","pa-arab-pk","pa-guru-in","sd-arab-pk","sd-deva-in","sr-cyrl-rs","sr-latn-rs","su-latn-id","uz-arab-af","uz-cyrl-uz","uz-latn-uz","zh-hans-cn","zh-hant-tw","mni-beng","sat-olck","shi-tfng","vai-vaii","yue-hant","az-latn","bs-latn","ff-latn","jbo-001","ks-arab","pa-guru","prg-001","sd-arab","sr-cyrl","su-latn","uz-latn","zh-hans","agq-cm","ar-001","arn-cl","asa-tz","ast-es","bas-cm","bem-zm","bez-tz","bgn-pk","blt-vn","brx-in","bss-cm","byn-er","cad-us","cch-ng","ccp-bd","ceb-ph","cgg-ug","chr-us","cic-us","ckb-iq","dav-ke","dje-ne","doi-in","dsb-de","dua-cm","dyo-sn","ebu-ke","eo-001","ewo-cm","fil-ph","fur-it","gaa-gh","gez-et","gsw-ch","guz-ke","haw-us","hsb-de","ia-001","ife-tg","io-001","jgo-cm","jmc-tz","kab-dz","kaj-ng","kam-ke","kcg-ng","kde-tz","kea-cv","ken-cm","khq-ml","kkj-cm","kln-ke","kok-in","kpe-lr","ksb-tz","ksf-cm","ksh-de","lag-tz","lkt-us","lrc-ir","luo-ke","luy-ke","mai-in","mas-ke","mer-ke","mfe-mu","mgh-mz","mgo-cm","moh-ca","mua-cm","mus-us","myv-ru","mzn-ir","naq-na","nds-de","nmg-cm","nnh-cm","nqo-gn","nso-za","nus-ss","nyn-ug","osa-us","pcm-ng","quc-gt","rof-tz","rwk-tz","sah-ru","saq-ke","sbp-tz","scn-it","sdh-ir","seh-mz","ses-ml","sid-et","sma-se","smj-se","smn-fi","sms-fi","ssy-er","syr-iq","szl-pl","teo-ug","tig-er","trv-tw","trw-pk","twq-ne","tzm-ma","vo-001","vun-tz","wae-ch","wal-et","wbp-au","xog-ug","yav-cm","yi-001","zgh-ma","aa-et","af-za","ak-gh","am-et","an-es","as-in","ba-ru","be-by","bg-bg","bm-ml","bn-bd","bo-cn","br-fr","ca-es","ce-ru","co-fr","cs-cz","cu-ru","cv-ru","cy-gb","da-dk","dv-mv","dz-bt","ee-gh","el-gr","et-ee","eu-es","fa-ir","fy-nl","ga-ie","gd-gb","gl-es","gn-py","gu-in","gv-im","ha-ng","he-il","hi-in","hy-am","id-id","ig-ng","ii-cn","iu-ca","ja-jp","jv-id","ka-ge","ki-ke","kk-kz","kl-gl","km-kh","kn-in","ko-kr","ku-tr","kw-gb","ky-kg","lb-lu","lg-ug","ln-cd","lo-la","lt-lt","lu-cd","mi-nz","ml-in","mr-in","ms-my","mt-mt","my-mm","nb-no","nd-zw","ne-np","nn-no","nr-za","nv-us","ny-mw","oc-fr","om-et","or-in","os-ge","ps-af","qu-pe","rm-ch","rn-bi","sa-in","sc-it","se-no","sg-cf","si-lk","sl-si","sn-zw","sq-al","ss-za","st-za","sv-se","sw-tz","ta-in","te-in","tg-tj","th-th","ti-et","tk-tm","tn-za","ts-za","tt-ru","ug-cn","uk-ua","ur-pk","ve-za","vi-vn","wa-be","wo-sn","xh-za","yo-ng","zu-za"];function Qp(e){return e.lang+(e.script?"-"+e.script:"")+(e.region?"-"+e.region:"")}function Hp(e,t=!1){let i,r,n;var e=function(e){let t=0,i=-1;for(var r=[];t<e.length;++t)if(45===e.charCodeAt(t)){const n=e.slice(i+1,t);r.push(n),i=t}if(i<t-1){const n=e.slice(i+1,t);r.push(n),i=t}return r}(e.toLowerCase()),a=e.length,s=e[0];let o={baseName:n=3<=a?3<e[2].length?3<e[1].length?s+"-"+(r=e[1]):s+"-"+(i=e[1]):(i=e[2],s+"-"+(r=e[1])+"-"+i):2===a?3<e[1].length?s+"-"+(r=e[1]):(i=e[1],e[0]+"-"+i):e[0],lang:s,script:r,region:i};return o=t?((a=o).lang=null==(e=a.lang)?void 0:e.toLowerCase(),a.script=(e=null!=(e=a.script)?e:"").length?e[0].toUpperCase()+e.substring(1):"",a.region=null==(e=a.region)?void 0:e.toUpperCase(),a.lang&&(a.baseName=Qp(a)),a):o}const qp={},Kp={is3LetterLangCode:e=>e in Np,toLocale(e,t=!1){let i={baseName:void 0,lang:void 0,script:void 0,region:void 0};return e&&(r=e.toLowerCase(),e=null!=(n=xp[r])?n:r,(i=Hp(e)).baseName=void 0,(i=function(t,e){if((o=t).lang&&o.lang in Fp&&(o.lang=Fp[o.lang]),t=o,e)for(let e=0;e<Bp.length;++e){var[i,r]=Bp[e],i=function(e,t){let i=[];e.baseName=void 0;for(const n in e)if(Object.prototype.hasOwnProperty.call(e,n)){var r=e[n];if(r!==t[n]){i=null;break}r&&i.push(n)}return i}(i,t);if(i&&0<i.length){s=a=n=void 0;var n=t,a=r,s=i;for(const l in n)Object.prototype.hasOwnProperty.call(n,l)&&s.includes(l)&&(n[l]=a[l]);break}}var o;return t}(i,t)).lang&&Kp.is3LetterLangCode(i.lang)&&(i.lang=Np[i.lang]),i=Hp(function(t){for(let e=0;e<Vp.length;++e)t===Vp[e]&&(t=t.split("-").slice(0,-1).join("-"));return t}(Qp(i=function(e){for(const t in _p)if(Object.prototype.hasOwnProperty.call(_p,t)&&e.region===t){e.region=_p[t];break}for(const i in Up)if(Object.prototype.hasOwnProperty.call(Up,i)&&e.script===i){e.script=Up[i];break}return e}(i))),!0)),i;var r,n},shortenLanguageCode(e){if(!e)return"";let t=qp[e];return null==t&&(qp[e]=t=null!=(e=null==(e=this.toLocale(e))?void 0:e.baseName)?e:""),t}},jp={isWebkitMediaElement:e=>"webkitDroppedFrameCount"in e,isHtmlVideoElement:e=>"getVideoPlaybackQuality"in e,timeRangeToArray(t){var i=[];for(let e=0;e<t.length;e++)i.push([t.start(e),t.end(e)]);return i}};(r=fp=fp||{})[r.Low=100]="Low",r[r.Normal=500]="Normal",r[r.High=900]="High",(a=gp=gp||{})[a.ContentSteering=0]="ContentSteering",a[a.RateChange=1]="RateChange",a[a.VariantSwitch=2]="VariantSwitch",a[a.AudioSwitch=3]="AudioSwitch",a[a.SubtitleIdle=4]="SubtitleIdle",a[a.RendererSwitch=5]="RendererSwitch",a[a.Idle=6]="Idle";class $p extends class{constructor(){this._queue=[],this._add$=new Ie,this._update$=new Ie,this._empty$=new jr(!0)}empty(){return 0===this.length()}length(){return this._queue.length}front(){return this._queue[0]}_onUpdate(){this.empty()!==this._empty$.value&&this._empty$.next(this.empty()),this._update$.next()}dequeue(){var e=this._queue.shift();return this._onUpdate(),e}enqueue(e){this._queue.push(e),this._onUpdate(),this._add$.next()}clear(){this.empty()||(this._queue=[],this._onUpdate())}values(){return this._queue}filter(e){e=this._queue.filter(e);e.length<this.length()&&(this._queue=e,this._onUpdate())}get add$(){return this._add$}get update$(){return this._update$}get empty$(){return this._empty$}}{constructor(e,t){super(),this.state=e,this.Pi=t,this._u=new Ie,this.Cu=0,this.xu=Math.ceil(performance.now()),this.Pi&&(this.Pi=this.Pi.child({name:"operation"})),this.Du=this.Du.bind(this),this.Lu=this.Lu.bind(this)}queueService$(e=!1){return e&&this.clear(),this.Cu=0,this.Du().pipe(zr(),Hr(this.clear.bind(this)))}Du(){return new F(this.Lu)}Lu(e){const t=this.Fu=this.dequeue();if(!t)return this.add$.pipe(Dr(1),Ae(this.Du)).subscribe(e);var i={next:e.complete.bind(e)};e.add(this._u.subscribe(i));const r=t.yield$;return r&&e.add(this.empty$.pipe(Ae(e=>e?Se:r)).subscribe(i)),t.execute(t,this.Cu++,this.state).subscribe(e),()=>{this.Fu===t&&(this.Fu=void 0)}}currentOperation(){return this.Fu}ju(){this._u.next()}enqueue(e){let t=!1;this.Fu&&e.priority>this.Fu.priority&&(t=!0),this._queue.push(Object.assign(Object.assign({},e),{id:this.xu++})),1<this._queue.length&&this._queue.sort((e,t)=>t.priority-e.priority||e.id-t.id),t&&this.ju(),this._onUpdate(),this._add$.next()}clear(){super.clear(),this.ju()}}function Gp(e){return null!=e&&void 0!==e.partTargetDuration}function Wp(e){return e.every(e=>null==e||!1===e.liveOrEvent)}function zp(e){return e.every(e=>null==e||e.ptsKnown)}function Yp(e,t){switch(e){case U.SendAlternateToPenaltyBox:e=U.RetryRequest,401!==t&&403!==t&&407!==t&&t!==pe.CorruptStream&&t!==pe.LivePlaylistUpdateError||(e=U.SendEndCallback);break;case U.RemoveAlternatePermanently:e=U.SendEndCallback}return e}function Xp(t,i,r,n,a,s,o,l,d,u=!1){var c;if(!fe(a))return t;var h=s.mediaOptionListQueries[a].mediaOptionFromId(n);if(!h)return t;if(t.errorActionFlags===vp.MoveAllAlternatesMatchingHost){const i=s.mediaOptionListQueries[a],r=i.filteredMediaOptionList,o=i.mediaOptionFromId(n);r.some(e=>!za(e,o))||(t.errorActionFlags&=~vp.MoveAllAlternatesMatchingHost)}const p=0!=(t.errorActionFlags&vp.MoveAllAlternatesMatchingHost),m=o.getFallbackMediaOptionTupleFromMediaOptionId(s,a,n,h.backingMediaOptionId,!1,p,u);let{errorAction:f,errorActionFlags:g}=t;if(s.isValidMediaOptionTuple(m))s.enabledVariantMediaOption&&za(s.enabledVariantMediaOption,m[a])&&(g&=~vp.MoveAllAlternatesMatchingHost);else{i||(f=Yp(f,r),g=0);const m=null==(c=s.mediaOptionListQueries[we.Variant].mediaOptionListInfo)?void 0:c.pathwayPriority;let e;if(wa(h))e=h.pathwayID,!0===h.iframes?(f=U.DoNothing,g=0):!i&&o.canSwitchToSDR(s,n,p,u)&&(f=t.errorAction,g=vp.SwitchToSDR);else{const i=s.enabledMediaOptionIdByType(we.Variant),r=s.variantMediaOptionById(i);if(!r)return t;e=null==r?void 0:r.pathwayID}i=null==(h=null==(c=s.getErrorInfoByType(a))?void 0:c.timeouts)?void 0:h[l],n=!!fe(i)&&i<d,u=f===U.RetryRequest;if((!n||!u)&&m&&e&&o.isContentSteeringEnabled()&&m.indexOf(e)<m.length-1)return f=U.SendPathwayToPenaltyBox,g=vp.SwitchPathway,{errorAction:f,errorActionFlags:g};r===pe.ContentHasGap&&(f=U.DoNothing,g=0)}return{errorAction:f,errorActionFlags:g}}function Jp(e){let t,i=0;switch(e){case 0:t=U.SendAlternateToPenaltyBox,i=vp.MoveAllAlternatesMatchingHost;break;case 410:t=U.RemoveAlternatePermanently;break;case 500:case 502:case 503:case 504:case 404:case 409:case 401:case 403:case 407:case pe.LivePlaylistUpdateError:case pe.PlaylistNotReceived:default:t=U.SendAlternateToPenaltyBox,i=0}return{errorAction:t,errorActionFlags:i}}function Zp(e){var t=Jp(e.response)["errorAction"];return{errorAction:Yp(t,e.response),errorActionFlags:0}}function em(e,t,i,r,n,a){if(e instanceof io)return{errorAction:U.DoNothing,errorActionFlags:vp.DoNothing};var s=e.response,{mediaOptionId:o,mediaOptionType:l}=e;let d=Jp(s);return t?d.errorActionFlags&=~vp.MoveAllAlternatesMatchingHost:d=function(e,t,i,r,n){let{errorAction:a,errorActionFlags:s}=t;if(e.isTimeout){const t=e["mediaOptionType"],o=null!=(n=null==(e=n.getErrorInfoByType(t))?void 0:e.timeouts.load)?n:0;!i&&r<=o&&(a=U.SendEndCallback,s=0)}return{errorAction:a,errorActionFlags:s}}(e,d,t,i,r),d=Xp(d,t,s,o,l,r,n,a,i,e.isTimeout),e instanceof Js&&!e.fatal&&(null!=(t=n.rtcService)&&t.report(hs,{url:e.url})),d}function tm(i,r,n,a,s,o,l){r.fatal||null==(d=a.rtcService)||d.report(us,{hlsError:r});var d,{errorAction:u,errorActionFlags:c}=i;let e=!0;switch(u){case U.RemoveAlternatePermanently:case U.SendAlternateToPenaltyBox:{if(null==s||null==o)return r.handled=!1;const i=n.itemId,d=n.mediaOptionListQueries[s];let e=o,t=d.mediaOptionFromId(o);null!=t&&t.backingMediaOptionId&&(e=t.backingMediaOptionId,t=d.mediaOptionFromId(e));var h=0!=(c&vp.MoveAllAlternatesMatchingHost),p=0!=(c&vp.MoveAllAlternatesMatchingHDCP),m=0!=(c&vp.SwitchToSDR),f=u===U.RemoveAlternatePermanently;if(t&&p&&"hdcpLevel"in t&&null!=t.hdcpLevel){const r=Vu.getNextLowerHdcpLevel(t.hdcpLevel);a.setMaxHdcpLevel(i,r)}m&&a.switchToSDROnly(i),h&&t?a.moveAllWithMatchingHosts(i,s,t,f):f?a.removePermanently(i,s,e):a.addToPenaltyBox(i,s,e),n.enabledMediaOptionIdByType(s)===o&&(p=[Me,Me,Me],p=a.getFallbackMediaOptionTupleFromMediaOptionId(n,s,o,void 0,m,h,l),n.isValidMediaOptionTuple(p)||(r.fatal=!0),r.fatal||a.setEnabledMediaOptions(n.itemId,p));break}case U.SendPathwayToPenaltyBox:{if(null==s||null==o)return r.handled=!1;let e=n.mediaOptionListQueries[s].mediaOptionFromId(o);if(!wa(e)){const r=n.enabledMediaOptionIdByType(we.Variant);e=n.variantMediaOptionById(r)}wa(e)&&a.addToPathwayPenaltyBox(n.itemId,e),0!=(c&vp.SwitchPathway)&&a.doPathwaySwitch(n.itemId);break}case U.SendEndCallback:r.fatal=!0;break;case U.RetryRequest:case U.DoNothing:default:e=!1}r.handled=e}function im(e,t){t instanceof Xs||t instanceof Js||t instanceof eo||(t instanceof cl||t instanceof ul||t instanceof hl)&&z(t.keyuri)}function rm(e,t,i,r,n){if(e.fatal||null==n||n.report(us,{hlsError:e}),e.handled=!0,i&&t<i.maxNumRetry&&fe(i.retryDelayMs))return n="linear"===i.backoff?(t+1)*i.retryDelayMs:Math.pow(2,t)*i.retryDelayMs,n=Math.min(i.maxRetryDelayMs,n),im(0,e),rr(n);throw e.fatal=!0,im(0,e),e}function nm(e,t,i,r,n,a,s,o,l=!1){return(null==r?void 0:r.errorAction)===U.RetryRequest?rm(e,t,i,a.logger,a.rtcService):am(e,0,r,n,a,s,o,l)}function am(e,t,i,r,n,a,s,o=!1){var l;const d=new $r;return i||e.fatal||null==(l=n.rtcService)||l.report(us,{hlsError:e}),Oe(()=>{i&&(im(n.logger,e),tm(i,e,r,n,a,s,o)),d.error(e)}),d}function sm(e,t,i,r,n,a,s,o){return am(e,0,Xp({errorAction:U.RemoveAlternatePermanently,errorActionFlags:0},!1,e.response,i,t,a,n,s,o),a,n,t,i).pipe(ye(e=>{throw!1===e.fatal&&r.resetMediaSource(),e}))}(As=yp=yp||{}).LowBandwidth="LowBandwidth",As.HighBandwidth="HighBandwidth",As.PreferredListChanged="PreferredListChanged",As.IframeModeChange="IframeModeChange",As.None="",As.Seek="Seek",As.Always="Always",(Ss=U=U||{})[Ss.DoNothing=0]="DoNothing",Ss[Ss.SendEndCallback=1]="SendEndCallback",Ss[Ss.SendAlternateToPenaltyBox=2]="SendAlternateToPenaltyBox",Ss[Ss.RemoveAlternatePermanently=3]="RemoveAlternatePermanently",Ss[Ss.InsertDiscontinuity=4]="InsertDiscontinuity",Ss[Ss.RetryRequest=5]="RetryRequest",Ss[Ss.SendPathwayToPenaltyBox=6]="SendPathwayToPenaltyBox",(e=vp=vp||{})[e.DoNothing=0]="DoNothing",e[e.MoveAllAlternatesMatchingHost=1]="MoveAllAlternatesMatchingHost",e[e.MoveAllAlternatesMatchingHDCP=2]="MoveAllAlternatesMatchingHDCP",e[e.SwitchToSDR=4]="SwitchToSDR",e[e.SwitchPathway=8]="SwitchPathway";const om=.1;function lm(r,n,a=!1,s){var{discoToMSNMap:o,endSN:l}=r,d=(null!=s&&s.child({name:"discoSeqNumForTime"}),Object.keys(o));for(let i=0;i<d.length;i++){var u=+d[i],c=o[u][0];let e=o[u][1];if(!a&&l<c)return;let t=i===d.length-1;if(!a&&e>l&&(t=!0,e=l),t){const a=Mm(r,e),s=a&&(a.isLastFragment||r.liveOrEvent)?1:0;if((null==a?void 0:a.start)+(null==a?void 0:a.duration)+s>n)return u}else{const a=Rm(r,o[+d[i+1]][0]);if((null==a?void 0:a.start)>n)return u}}}function dm(e,t,i){var r=0<i.duration,n=i.start+i.duration,e=null==e||e<n||e-n<1&&i.isLastFragment,n=!fe(t)||i.discoSeqNum===t;return r&&e&&n}function um(t,i,r,n=!1){for(let e=t.length-1;0<=e;e--){var a=t[e];if(o=i,l=r,(s=a).frag.itemId===o.itemId&&(lh(s.frag,o)||uh(s.frag,o)||(l=Math.min(l,om*o.duration),o.part&&!s.frag.part?o.start>=s.startPTS-l&&o.start+o.duration<s.endPTS+l:Math.abs(s.startPTS-o.start)<l&&Math.abs(s.endPTS-o.start-o.duration)<l)))return n||!a.evicting?a:void 0;if(a.startPTS<i.start-r)return}var s,o,l}function cm(e,t,i,r=!1){var n=null==(n=i.discoToMSNMap[t])?void 0:n[0],[a,s,o=NaN,l=!1]=[i,dm.bind(null,e,t),n,r],d=a.fragments;for(let e=o>a.startSN?o-a.startSN:0;e<d.length;++e){const a=d[e],o=a["start"];if(s(a))return{timelineOffset:o,mediaFragment:a}}if(l&&null!=(l=a.parts)&&l.length){const l=a.parts;for(let e=0;e<l.length;++e)if(!fe(o)||l[e].mediaSeqNum>=o){const o=l[e];if(s(o)){const a=o["start"];return{timelineOffset:a,mediaFragment:o}}}}return null}function hm(e,t,i,r,n,a,s){var o;return n=null!=n?n:[],o=e,nh.isTimeRangeContainedInRanges(n,{start:o.start,end:o.start+o.duration})?{shouldLoad:!1,alreadyBuffered:!1}:({buffered:n,overlappingSegment:o}=function(e,t,i,r){if(s)return{buffered:!1};let n;if(e.part){if(null!=(n=um(i,e,r,!1))&&(lh(n.frag,e)||uh(n.frag,e)))return{buffered:!0,overlappingSegment:n}}else if(null!=(n=um(i,e,r,!0))&&lh(n.frag,e))return{buffered:(e=e,t=t,a=n,i=i,r=r,!(a.evicting||!a.rebuffered&&function(e,t,i,r,n){if(t&&fe(i.appendEnd)&&fe(i.appendStart)){const a=t["end"],{appendStart:s,appendEnd:o,frag:l}=i;return a+n<s&&a>=e.start?!0:(t=e.start+e.duration,o<=a&&a+n<t||s<=a&&a<=o&&o+n<t&&r.some(e=>{return t=l,e=e.frag,t.itemId===e.itemId&&t.mediaOptionId===e.mediaOptionId&&t.mediaSeqNum===e.mediaSeqNum+1&&t.discoSeqNum===e.discoSeqNum;var t})||e.isLastFragment)}return!1}(e,t,a,i,r))),overlappingSegment:n};var a;return{buffered:!1,overlappingSegment:n}}(e,i,r,a),r=s||!i.len?t:i.end,a=!n&&dm(r,e.discoSeqNum,e)&&(!o||o.evicting),{shouldLoad:!n&&a,alreadyBuffered:n})}function pm(e,t){var i=e.start+e.duration/2;let r=null,n=!1;for(let e=t.length-1;0<=e&&(null==r||!n);--e){var a=t[e];!r&&a.startPTS<i&&a.endPTS>i&&!a.evicting&&(r=a),n=n||0<a.frag.framesWithoutIDR}return(null==r?void 0:r.frag.mediaOptionId)!==e.mediaOptionId&&n}function mm(e,t,i){return e.iframe&&(0<i&&t>=e.start+e.duration||i<0&&t<e.start)}function fm(e){var t,i,r,n,a,s,o,l,d,u;return e?({itemId:e,mediaOptionId:t,mediaSeqNum:i,discoSeqNum:r,iframe:n,start:a,duration:s,mediaOptionType:o,isLastFragment:l,part:d,partIndex:u}=e,{itemId:e,mediaOptionId:t,mediaSeqNum:i,discoSeqNum:r,iframe:n,start:a,duration:s,mediaOptionType:o,isLastFragment:l,part:d,partIndex:u}):null}function gm(e){return!0===(null==e?void 0:e.userInitiated)}function ym(e){return gm(null==e?void 0:e.switchContext)}function vm(i,e,t){var e=wo.search(e,e=>{var t=e.start,e=t+e.duration;return t<=i&&i<e?0:i-t}),r=fh(t);return!e||r&&mm(e,i,t)?null:e}function Im(o,l,t,i,r,n,a,s){var d,u;const[c,e]=o,h=c.iframesOnly,p=c.itemId,{maxBufferHole:m,maxFragLookUpTolerance:f,liveAllowLowLatencyPlayback:g}=a,y=a["firstAudioMustOverlapVideoStart"],v=t.getBufferInfo(l.pos,m,n?p:void 0),I=t.desiredRate,S=g&&c.liveOrEvent&&gh(I),b=i.map(ym),T=v.reduce((e,t,i)=>{const r=b[i],n=o[i],a=S||i===we.AltAudio&&y?0:f,s=function(e,t,i,r){if(!t)return Number.POSITIVE_INFINITY;r=null!=r?r:{start:e,end:e,len:0};t=null!=t&&t.iframesOnly?0:a;return i||0===r.len?e:r.end+t}(l.pos,n,r,t.buffered);return Math.min(s,e)},1/0);let A=NaN,E=NaN,O=NaN;if(h)A=r.getCurrentTime().seconds,E=T,O=lm(c,A);else if(A=T,E=T,fe(l.discoSeqNum))O=l.discoSeqNum;else if(fe(O=lm(c,A,S,s))&&null!=e){const o=lm(e,A);o>O&&o in c.discoToMSNMap&&(O=o)}if(!fe(O))return null;var w=[null,null],R=[null,null];for(let e=0;e<=R.length;++e){const i=o[e];if(null!=i){const r=null==(d=i.discoToMSNMap[O])?void 0:d[0];if(!fe(r))return null;const a=vm(A,i.fragments,I),s=Math.sign(I),u=i.discoToMSNMap[O][1],c=a?Math.max(a.mediaSeqNum-s,r):0<=s?r:u;if(h){const o=t.desiredRate;w[e]=R[e]=fm(bm(i,c,A,o,v[e].buffered,v[e].bufferedSegments,[],f,b[e]))}else{const o=t.getBufferInfo(A,m,n?p:void 0)[e],{buffered:r,bufferedSegments:a}=o,s=bm(i,c,A,1,r,a,t.getContentGapRanges(),f,b[e],0,S);(null==s?void 0:s.discoSeqNum)===O&&(R[e]=fm(s),(y||s.start+s.duration<A)&&e===we.Variant)&&(E=A=Math.min(s.start,A))}}}for(let e=0;!h&&e<w.length;++e){const t=o[e];if(t){const i=R[e],r=(null==i?void 0:i.start)+(null==i?void 0:i.duration)>E&&(null==i?void 0:i.start)<=E?i:null==(u=cm(E,O,t,S))?void 0:u.mediaFragment;if(w[e]=fm(r),!r)return null}}return{pos:E,discoSeqNum:O,anchorFrags:w,nextFrags:R,iframeMode:h,switchInfo:i}}function Sm(t,i,r,n){let a=t;if(t.iframe){var s=t.start,o=r.end,i=t.duration/Math.abs(i);let e=1/n;r.len<.75&&(e=Math.max(e,.25));n=Math.max(i,e);a=Object.assign(Object.assign({},t),{iframeOriginalStart:s,start:o,iframeMediaStart:o,iframeMediaDuration:n})}return{foundFrag:{mediaFragment:a,timelineOffset:a.start},nextDisco:NaN}}function bm(i,r,n,a,s,o,l,d,u,c,h=!1){var p=0<=a?1:-1;let m=null;var t=u?n:Math.max(0,n+s.len*a);let e=!1;var{fragments:f,parts:g}=i;if(h&&gh(a)&&0<(null==g?void 0:g.length)){const r=g[g.length-1],n=r.start+r.duration,a=f[f.length-1],s=a.start+a.duration;e=t>=(fe(i.tloadMillis)?(performance.now()-i.tloadMillis)/1e3:0)+g[0].start+n-s}if(!e){const{startSN:c,endSN:h}=i;let t=null;for(let e=r;e>=c&&e<=h&&null==m;e+=p){const r=Oc(i.fragments,e);if(null!=r&&r.iframe)(!mm(r,Math.max(0,n+s.len*a),a)||0<a&&r===i.fragments[i.fragments.length-1])&&(m=r);else if(r){const{shouldLoad:a,alreadyBuffered:c}=hm(r,n,s,o,l,d,u);c||t||!(a||i.liveOrEvent&&!i.ptsKnown)||(t=r),a&&(m=r)}}if(!1===(null==m?void 0:m.iframe)&&!u){const r=Oc(i.fragments,m.mediaSeqNum-p);(null==r?void 0:r.discoSeqNum)===m.discoSeqNum&&pm(r,o)&&(m=r)}return m=!m&&t?t:m}let y=null;for(let e=0;e<(null==g?void 0:g.length)&&null==m;e++){const n=g[e],{mediaSeqNum:a,partIndependent:c}=n;if(!(a<r-1)){const h=hm(n,t,s,o,l,d,u)["shouldLoad"];c&&(y=n),a>=r&&h&&(m=n)}}return m=m&&!m.partIndependent&&y&&m.discoSeqNum===y.discoSeqNum&&!um(o,y,d,!1)?y:m}function Tm(e,t=!1){var i;let r=1/0,n=(null!=(i=e.fragments)&&i.length&&(r=e.fragments[0].start),1/0);return null!=(i=e.parts)&&i.length&&t&&(n=e.parts[0].start),fe(r)||fe(n)?Math.min(r,n):0}function Am(e,t=!1){var i;let r=-1/0;if(null!=(i=e.fragments)&&i.length){const t=e.fragments[e.fragments.length-1];r=t.start+t.duration}let n=-1/0;if(null!=(i=e.parts)&&i.length&&t){const t=e.parts[e.parts.length-1];n=t.start+t.duration}return fe(r)||fe(n)?Math.max(r,n):0}function Em(e,t=!1){return Am(e,t)-Tm(e,t)}function Om(e,t){const{discoToMSNMap:i,pdtToMSN:r}=e,n=i[t];if(null!=n)return wo.search(r,([,e])=>e>=n[0]&&e<=n[1]?0:n[0]-e)}function wm(e){var{fragments:e,parts:t}=e;let i=NaN,r=NaN;return e.length&&(i=e[0].discoSeqNum,r=(null!=t&&t.length?t[t.length-1]:e[e.length-1]).discoSeqNum),[i,r]}function Rm(e,t){var{fragments:e,parts:i,endSN:r}=e;return t<=r?Oc(e,t):0<(null==i?void 0:i.length)?Oc(i,t,0):void 0}function Mm(e,t){var{fragments:e,parts:i,endSN:r}=e;return t<=r?Oc(e,t):ee(i,e=>e.mediaSeqNum===t)}function Pm(e,t){var{fragments:i,parts:r}=e,e=e.discoToMSNMap[t];if(e){i=Oc(i,e[0]);if(!i&&r)for(const e of r){if(e.discoSeqNum===t)return e;if(e.discoSeqNum>t)return}return i}}function Cm(e,t,i){return e*i.instantBwDurationFactor*1e3/t}function km(e,n,i,a,t,r,s=!1){var{pos:o,combined:i,playingFrags:l}=i;if(!i||0===i.len)return!1;let d=fh(a)||i.len>=t;var i=n["avDetails"],[u,c]=i,i=Wp(i);let h=Am(u,s),p=(c&&(h=Math.min(h,Am(c,s))),NaN);for(const n of e)if(null!=n){p=n.discoSeqNum;break}if(i)d=d||o>=h-t;else{let e=Oc(u.fragments,u.endSN),t=u.targetduration;if(s){const i=u.parts;null!=i&&i.length&&0<(null==i?void 0:i.length)&&(e=i[i.length-1]),t=null!=(c=u.partTargetDuration)?c:null==e?void 0:e.duration}const i=e?e.duration:t;d=d&&o<=h-(null!=i?i:0)}return d=d||l.every((e,t)=>{var i,r,t=n.avDetails[t];return null==t||null!=e&&(i=e["discoSeqNum"],!(t.discoToMSNMap[i]&&(!fe(p)||i===p))||([i,r]=t.discoToMSNMap[i],a<0&&e.mediaSeqNum===i)||0<=a&&e.mediaSeqNum===r&&(!t.liveOrEvent||e.mediaSeqNum!==t.endSN))}),d=r&&!d?!0:d}function Lm(r,e,t,i){if(!e||!t)return NaN;let n=null!=(e=null==(e=Oc(e.fragments,t.mediaSeqNum,t.partIndex))?void 0:e.bitrate)?e:NaN;if(!fe(n))if(i||t.mediaOptionType===we.AltAudio){const e=function(){var e=r.audioCodec,t=r.bitrate;if(!t)return NaN;let i=128e3;return e&&(ge.isEC3(e)?i=768e3:ge.isAC3(e)&&(i=64e4)),Math.min(t/2,i)}();n=t.mediaOptionType===we.Variant?r.bitrate-e:e}else n=r.bitrate;return n}function Dm(e,t,i,r,n,a,s,o=!1){var l=e[i];if(!l)return 1/0;var d=l.state;let u=l.tstart,c=0;switch(d){case"loading":c=function(e,t,i,r,n,a=!1){var s=e[i];if(!s)return 0;var{bwSample:s,duration:o}=s,l=xm(s),o=Nm(s,t[i],o),d=n.avgBandwidth;let u=d,c=0;if(s&&fe(null==s?void 0:s.tfirst)){const e=performance.now()-s.tfirst;if(e>=r&&0<e){const t=l/e*1e3;u=a?t:Math.min(t,d)}}else c+=n.avgLatencyMs/1e3;s=B.AltAudio-i,l=e[s];if(u===d&&null!=l&&l.bwSample){const e=t[s],i=Nm(l.bwSample,e,l.duration),r=Math.min(i,o);c+=r/(.5*u)+(o-r)/u}else c+=o/u;return c}(e,t,i,r,n,o),u=l.tstart+1e3*c;case"loaded":case"parsing":c+=bc(u,a),u=l.tstart+1e3*c;case"parsed":case"appending":c+=Tc(u,s);break;default:c=1/0}return c}function xm(e){return e&&fe(null==e?void 0:e.loaded)?8*e.loaded:0}function Nm(e,t,i){return t=t,i=i,((r=e)&&fe(null==r?void 0:r.total)?8*r.total:Math.ceil(i*t))-xm(e);var r}function Fm(e,t,i,r,n,a,s){var o=r.mediaQuery,t=(t=t.child({name:"haveEnough"}),o.getMediaBufferInfo(o.desiredPos,e.maxBufferHole)),l=i.enabledVariantMediaOption,d=i.enabledAlternateMediaOptionByType(we.AltAudio),u=l?n.getQueryForOption(l).mediaOptionDetails:null,n=null!=d&&d.url?n.getQueryForOption(d).mediaOptionDetails:void 0,d=o.haveEnough,s=null!=s?s:i.getInFlightFrags();return l&&u&&s&&(l={variant:l,avDetails:i=[u,n]},u=o.desiredRate,n=null!=(n=null==(n=s[we.Variant])?void 0:n.duration)?n:i[we.Variant].targetduration,d=!!o.withinFragDurationOfContentGap(o.currentTime,n)||function(g,y,v,I,e,S,b,T,t){var i;const r=I["combined"],n=null!=(i=null==r?void 0:r.len)?i:0,A=vc(g,v.avDetails[we.Variant],I);let a=km(y,v,I,e,A,t);if(!a&&y.some(e=>e)){const e=y.map((e,t)=>{{var i=y,r=v,n=A,a=I,s=S,o=b,l=T,d=g,u,{sbTuple:c,pos:h}=a,p=d["maxBufferHole"],c;if(null!=(c=null==(c=c[t])?void 0:c.buffered)&&c.len&&c.len>=n)return 0;const{avDetails:m,variant:f}=r;return m[t]?(r=i[t],c&&r&&(u=r.start+r.duration)>c.end&&(r.start-c.end<=p||r.start<=c.end)&&n<=u-h?0===c.len&&"appending"===r.state?0:(p=m.map((e,t)=>{return Lm(f,null!=e?e:void 0,null!=(e=i[t])?e:void 0,null!=m[we.AltAudio])}),n=Cm(r.duration,a.playbackRate,d),Dm(i,p,t,n,s,o,l)):1/0):0}});a=e.reduce((e,t)=>Math.max(e,t),0)<=n}return a}(e,s,l,t,u,a.getBandwidthEstimate(e,!1),a.getFragEstimate(e,!1),a.getBufferEstimate(e,!1),r.mediaQuery.waitingForDisco),r.haveEnough=d),d}const Bm=3,Um=2;function _m(e,t){let i=Bm*e.targetduration;return e.serverControls&&fe(e.serverControls.holdBack)&&(i=Math.max(i,e.serverControls.holdBack)),fe(t.liveSyncDuration)?i=Math.max(i,t.liveSyncDuration):fe(t.liveSyncDurationCount)&&(i=Math.max(i,t.liveSyncDurationCount*e.targetduration)),i}function Vm(e){let t=Um*e.partTargetDuration;return t=fe(t)&&e.serverControls&&fe(e.serverControls.partHoldBack)?Math.max(t,e.serverControls.partHoldBack):t}function Qm(e,t){var i;let r=_m(e,t);t=t["liveAllowLowLatencyPlayback"];if(t&&Gp(e)){const t=Vm(e);fe(t)&&(r=t)}return Math.max(null!=(i=null==(i=e.fragments[0])?void 0:i.start)?i:0,Am(e,t)-r)}function Hm(e,t){var i=Tm(e,t.liveAllowLowLatencyPlayback),r=Am(e,t.liveAllowLowLatencyPlayback),t=Qm(e,t);return{start:i,end:r,edge:t,boundary:Math.max(0,t-2*e.targetduration)}}function qm(e,t){var i=Hm(e[we.Variant],t),r=e[we.AltAudio];if(r){const e=Hm(r,t);i.start=Math.max(i.start,e.start),i.end=Math.max(i.start,Math.min(i.end,e.end)),i.edge=Math.max(i.start,Math.min(i.edge,e.edge)),i.boundary=Math.min(i.boundary,e.boundary)}return i}function Km(e,t,i){t=qm(t,i);return Math.max(t.start,Math.min(t.edge,e))}function jm(e,t,i){return!(e.start>t.end+i||e.end<t.start-i)}function $m(){return[new Qu({name:"Remove Filter",priority:0,filterFn:(t,e,i)=>!i||i.removed.every(e=>t.mediaOptionId!==e)}),new Qu({name:"Penalty Box Filter",priority:1,filterFn:(t,e,i)=>{const r=performance.now();return!i||i.penaltyBoxQueue.every(e=>e.expiry<=r||t.mediaOptionId!==e.id)}}),new Qu({name:"Compatible IDs Filter",priority:1,filterFn:(t,e,i)=>!i||null==i.compatibleIds||i.compatibleIds.some(e=>e===t.mediaOptionId)})]}class Gm extends ga{constructor(e,t,i){super(e),this.itemId=t,this.mediaOptionType=i,this.Bu=[],this.allowFilters=this._initFilters()}get mediaOptionList(){var e;return(null==(e=this.mediaOptionListInfo)?void 0:e.mediaOptions)||null}get mediaOptionList$(){return this.mediaOptionListInfo$.pipe(ve(({mediaOptions:e})=>e))}mediaOptionFromId(t){var e;return null==(e=this.mediaOptionList)?void 0:e.find(e=>e.mediaOptionId===t)}get hasOptionWithUrl(){var e;return this.mediaOptionList&&null==this.Uu&&(this.Uu=this.mediaOptionList.some(Us)),null!=(e=this.Uu)&&e}_getFilteredList(e){return Hu(e.mediaOptions,this.allowFilters,e)}_infoChanged(i){var e=this._cachedInfo;return null!=e&&null==i||null==e&&null!=i||e&&i&&(e.mediaOptions!==i.mediaOptions||e.penaltyBoxQueue.length!==i.penaltyBoxQueue.length||e.penaltyBoxQueue.some((e,t)=>i.penaltyBoxQueue[t]!==e)||e.removed.length!==i.removed.length||e.removed.some((e,t)=>i.removed[t]!==e)||e.compatibleIds!==i.compatibleIds)}dispose(){this._cachedInfo=void 0,this.Bu=[]}get filteredMediaOptionList(){const t=performance.now();var e,i;return this.mediaOptionListInfo?({penaltyBoxQueue:i,removed:e}=this.mediaOptionListInfo,i=i.filter(e=>!(e.expiry<=t)),i=Object.assign(Object.assign({},this.mediaOptionListInfo),{penaltyBoxQueue:i,removed:e.slice()}),this._infoChanged(i)&&(this._cachedInfo=i,this.Bu=this._getFilteredList(this.mediaOptionListInfo))):(this._cachedInfo=void 0,this.Bu=[]),this.Bu}getFilteredMediaOptionList$(e=!1){return(e?this.mediaOptionListInfo$.pipe(tn(1)):this.mediaOptionListInfo$).pipe(Ae(e=>{var t=[Pe],i=performance.now();for(const r of e.penaltyBoxQueue)fe(r.expiry)&&r.expiry>i&&t.push(rr(r.expiry-i));return Bn(...t).pipe(ve(()=>this.filteredMediaOptionList))}),Te((e,i)=>e===i||(null==e?void 0:e.length)===(null==i?void 0:i.length)&&(null==e?void 0:e.every((e,t)=>e===i[t]))))}triggerPenaltyBoxExpiry(e){var t=[],i=performance.now();for(const r of e)fe(r.expiry)&&r.expiry>i&&t.push(rr(r.expiry-i));const r=be(e),n=Bn(...t).pipe(ve(()=>e));return Bn(r,n).pipe(ve(e=>e.filter(e=>!(e.expiry<=performance.now()))))}get penaltyBoxChanged$(){return this.mediaOptionListInfo$.pipe(Ae(e=>this.triggerPenaltyBoxExpiry(e.penaltyBoxQueue)),fn())}get removedListChanged$(){return this.mediaOptionListInfo$.pipe(ve(e=>null==e?void 0:e.removed),fn())}get compatibleIdsListChanged$(){return this.mediaOptionListInfo$.pipe(ve(e=>null==e?void 0:e.compatibleIds),fn())}get commonFilterParamChanges$(){return _n([this.penaltyBoxChanged$,this.removedListChanged$,this.compatibleIdsListChanged$])}}function Wm(e){return"PQ"===e.videoRange||"HLG"===e.videoRange}function zm(e,{hasScore:t,pivotVariant:i,pathwayPriority:r,enableSteering:n,preferHostOverQuality:a,preferCloseToPivotQuality:s}={hasScore:!1,pivotVariant:null,pathwayPriority:null,enableSteering:!1,preferHostOverQuality:!0,preferCloseToPivotQuality:!1}){var o=[...e];return o.sort(hc(e.length,{hasScore:t,pivotVariant:i,pathwayPriority:r,enableSteering:n,preferHostOverQuality:a,preferCloseToPivotQuality:s})),o}function Ym(e,t){return(t.hasHdrLevels&&t.preferHDR)===Wm(e)}(bs=Ip=Ip||{})[bs.Better=1]="Better",bs[bs.Same=0]="Same",bs[bs.Worse=-1]="Worse";class Xm extends Gm{constructor(e,t){super(e,t,we.Variant)}static makeFilters(){return[...$m().concat([new Qu({name:"HDR Filter",priority:1,filterFn:(e,t,i)=>!i||Ym(e,i)}),new Qu({name:"Viewport Filter",priority:1,firstPassFn:(e,t,i)=>{if(i&&e&&!e.iframes&&e.videoCodec){const t=!i.lowestBitrate||e.bitrate<i.lowestBitrate?e.bitrate:i.lowestBitrate;i.lowestBitrate=t}},filterFn:(e,t,i)=>!(e&&i&&i.viewportInfo&&e.videoCodec&&i.lowestBitrate)||dc({width:e.width,height:e.height},i.viewportInfo)||e.bitrate===i.lowestBitrate}),new Qu({name:"HDCP Filter",priority:2,filterFn:(e,t,i)=>!i||Vu.isAllowed(e.hdcpLevel,i.maxHdcpLevel)})])].sort((e,t)=>{return(null!=(e=e.priority)?e:Number.MAX_SAFE_INTEGER)-(null!=(e=t.priority)?e:Number.MAX_SAFE_INTEGER)})}_initFilters(){return Xm.kAllowFilters}get mediaOptionListInfo(){var e;return null!=(e=null==(e=this.getEntity(this.itemId))?void 0:e.mediaOptionListTuple[we.Variant])?e:null}get mediaOptionListInfo$(){return this.selectEntity(this.itemId,e=>{return null==(e=null==e?void 0:e.mediaOptionListTuple)?void 0:e[we.Variant]}).pipe(Yl())}_infoChanged(i){var e,t=this._cachedInfo;return super._infoChanged(i)||null!=t&&null!=i&&(t.hasHdrLevels!==i.hasHdrLevels||t.preferHDR!==i.preferHDR||t.maxHdcpLevel!==i.maxHdcpLevel||(null==(e=t.viewportInfo)?void 0:e.height)!==(null==(e=i.viewportInfo)?void 0:e.height)||(null==(e=t.viewportInfo)?void 0:e.width)!==(null==(e=i.viewportInfo)?void 0:e.width)||t.hasScore!==i.hasScore||(null==(e=t.pathwayPriority)?void 0:e.length)!==(null==(e=i.pathwayPriority)?void 0:e.length)||(null==(e=t.pathwayPriority)?void 0:e.some((e,t)=>i.pathwayPriority[t]!==e)))||t.pathwayPenaltyBox.length!==i.pathwayPenaltyBox.length||t.pathwayPenaltyBox.some((e,t)=>i.pathwayPenaltyBox[t]!==e)}get hdrMode$(){return this.mediaOptionListInfo$.pipe(ve(e=>!0===e.preferHDR&&e.hasHdrLevels),Te())}get maxHdcpLevel$(){return this.selectEntity(this.itemId,e=>{e=null==(e=null==e?void 0:e.mediaOptionListTuple)?void 0:e[we.Variant];return null==e?void 0:e.maxHdcpLevel}).pipe(Te())}get viewportInfo$(){return this.selectEntity(this.itemId,e=>{e=null==(e=null==e?void 0:e.mediaOptionListTuple)?void 0:e[we.Variant];return null==e?void 0:e.viewportInfo}).pipe(Yl(),Te((e,t)=>e.width===t.width&&e.height===t.height))}get pathwayPenaltyBoxChanged$(){return this.selectEntity(this.itemId,e=>e.mediaOptionListTuple[we.Variant].pathwayPenaltyBox).pipe(Ae(e=>this.triggerPenaltyBoxExpiry(e=null!=e?e:[])),fn())}listFallbackVariants(t,e,i,r,n,a=void 0){var s,o=this.mediaOptionListInfo,l=null==(l=this.mediaOptionList)?void 0:l.find(e=>e.mediaOptionId===t);return l&&o?(e=this.$u(l,e,a)).length<1?e:({hasScore:o,pathwayPriority:s}=o,Xm._listFallbackVariants(e,l,o,s,n,i,r,a)):[]}$u(e,t,i=void 0){if(!e||!this.mediaOptionList||!this.mediaOptionListInfo)return[];e=Object.assign({},this.mediaOptionListInfo);t&&(e.compatibleIds=null,e.preferHDR=!1);let r=Hu(Array.from(this.mediaOptionList),this.allowFilters,e);return r.length<1||i&&0<i.length&&(r=r.filter(e=>!i.includes(e.mediaOptionId))),r}get hasIframes(){return this.filteredMediaOptionList.some(e=>e.iframes)}static _listFallbackVariants(e,n,t,i,r,a,s=!1,o=null){let l=!1;const d=[];e.forEach(e=>{var t,i=!(e.iframes!==n.iframes||a&&za(n,e)),r=(t=e,r=n.stableVariantID&&t.stableVariantID===n.stableVariantID,s?!r&&t.bitrate<n.bitrate:r||t.bitrate<=n.bitrate||Math.abs(t.bitrate-n.bitrate)<=1||d.some(e=>Math.abs(t.bitrate-e.bitrate)<=1)),i=i&&r;n.mediaOptionId!==e.mediaOptionId?i&&d.push(e):l=i});e=zm(d,{pivotVariant:n,hasScore:t,pathwayPriority:i,enableSteering:r,preferHostOverQuality:!a,preferCloseToPivotQuality:!0});return!l||o&&o.includes(n.mediaOptionId)||e.push(n),e}getMatchingVariant(e,t){var i,r,n=this.mediaOptionFromId(e),a=t.mediaOptionType===we.AltAudio?"audioAlternates":"subtitleAlternates";let s=null;this.mediaOptionListInfo.hasScore;for(const e of this.filteredMediaOptionList)if((e[a]&&0<e[a].length?e[a][0].groupId:void 0)===t.groupId){if(!n){s=e;break}o=n,i=e;var o=!(r=s)||i.bitrate>r.bitrate&&i.bitrate<=o.bitrate?Ip.Better:i.bitrate===r.bitrate?Ip.Same:Ip.Worse;o!==Ip.Better&&(o!==Ip.Same||s.mediaOptionId===n.mediaOptionId||e.mediaOptionId!==n.mediaOptionId&&!za(n,e))||(s=e)}return s}}Xm.kAllowFilters=Xm.makeFilters(),(n=Sp=Sp||{})[n.Auto=0]="Auto",n[n.Emergency=1]="Emergency";const Jm={name:"abr"};function Zm(e,t,i){let r;return r=i||(r=of(t,e)).altAudio&&r.subtitle?r:void 0}function ef(e){return fe(null==e?void 0:e.avgBandwidth)}function tf(e){return 0!==e.playbackRate?Math.abs(e.playbackRate):1}function rf(e,t){return e.getCurrentWaterLevelByType(B.Variant,t)/tf(e)}function nf(e,t){t=e.getCombinedBufferInfo(e.currentTime,t);return t?t.len/tf(e):0}function af(t,i,e,r){if(e)return t;let n=-1;if(!(t<0))for(let e=t;e<i.length;++e){const t=of(i[e],r);if(t.altAudio&&t.subtitle){n=e;break}}return n}function sf(t,i,r,n,a){if(n.enableBoss&&i){const s=r?ys.ABRIframe:ys.ABR;let e=i.getQuery(t.itemId,a).variantsFor(s);if(0===e.length){const n=r?ys.ABRIframeLowestLevel:ys.ABRLowestLevel;e=i.getQuery(t.itemId,a).variantsFor(n)}const o=t.rootPlaylistEntity.mediaOptionListTuple[we.Variant];return e.sort(hc(e.length,{hasScore:o.hasScore,pivotVariant:t.enabledVariantMediaOption,pathwayPriority:o.pathwayPriority,enableSteering:n.enableContentSteering,preferHostOverQuality:!0,preferCloseToPivotQuality:!1})),e}const s=t.enabledVariantMediaOption,e=t.mediaOptionListQueries[we.Variant].filteredMediaOptionList.filter(e=>e.iframes===r);let o=e.filter(e=>za(s,e));return o=r&&!o.length?null!=t.currentPathwayID?e.filter(e=>Wa(e.pathwayID,t.currentPathwayID)):e:o}function of(e,t){var i=t.enabledMediaOptionKeys,r=i[we.AltAudio],r=Bs(r)?t.mediaOptionListQueries[we.AltAudio].getMatchingAlternate(r.mediaOptionId,e):Me,i=i[we.Subtitle];return{altAudio:r,subtitle:Bs(i)?t.mediaOptionListQueries[we.Subtitle].getMatchingAlternate(i.mediaOptionId,e):Me}}function lf(e,t,i){var{abrBandWidthFactor:i,abrBandWidthUpFactor:r,abrLowSampleCount:n,abrLowSampleBandwidthFactor:a}=i;let s,o;return n<t?(s=e*r,o=e*i):s=o=a*e,{bwUp:s,bwDown:o}}function df(t,e){let i=1/0;if(t!==Me.mediaOptionId){var r=e.find(e=>e.mediaOptionId===t);if(!r)return 1/0;const n=r.iframes,a=r.bitrate,s=r.frameRate,o=e.find(e=>e.iframes===n&&(void 0===s||!fe(e.frameRate)||e.frameRate>=s)&&e.bitrate>a);o&&(i=o.bitrate)}return i}function uf(e,t,i){var{config:r,mediaLibraryService:e,mediaSink:n,rootPlaylistQuery:a,statsService:s}=e,n=n["mediaQuery"],s=s.getQueryForId(a.statsId),o=a.enabledMediaOptionIdByType(we.Variant),a=a.variantMediaOptionById(o),o=a&&a.iframes===i,e=e.getQueryForOption(a),a=o?rf(n,r.maxBufferHole):0,o=s.getCombinedEstimate(),t=t===Sp.Emergency,l=(t&&(o.avgBandwidth=s.bandwidthStatus.instantBw),e.mediaOptionDetails),d=Rc(r.liveAllowLowLatencyPlayback,n.isPlayingAtLive,null!=(e=null==(e=null==l?void 0:l.parts)?void 0:e.length)?e:0);let u,c=0===a?r.maxStarvationDelay:a;if(Gp(l)&&d&&(c=Math.min(Vm(l)/r.liveSyncDurationCount,a)),i){const e=r.desiredIframeFPS;u=l?l.targetduration/e:r.defaultTargetDuration/8,u=Math.max(1/e,u)}else{const e=wc(l,r,d);u=null!=l||d?e:xe(o.maxDurationSec,e)}return{currentFragDuration:u,maxFetchDuration:c,isLiveOrEvent:Boolean(null==l?void 0:l.liveOrEvent),playbackRate:tf(n),iframeMode:i,estimate:o,bwStatus:s.bandwidthStatus,bwFactor:t?1:r.abrBandWidthFactor,bwUpFactor:t?1:r.abrBandWidthUpFactor,isInstantBw:t}}class cf{findBestVariant(e,t,i){return this.Vu(e,t,i)}findBestVariantForEmergency(e,t,i){return this.Vu(e,t,i)}Vu(i,e,r){var n,a,s,o,l,d;const{bwStatus:u,iframeMode:c,estimate:h,bwFactor:p,bwUpFactor:m,maxFetchDuration:U}=r,f=u.bandwidthSampleCount,{config:g,mediaLibraryService:y,mediaSink:v,rootPlaylistQuery:I,rootPlaylistService:S}=e,b=v["mediaQuery"],_=b.maxBufferSize,V=null!=(r=S.abrController.status)?r:{fragDownloadSlow:!1,fragDownloadTooSlow:!1},Q=g.minTargetDurations||1,H=I.mediaOptionListQueries[we.Variant].mediaOptionListInfo.hasScore;if(!i.length)return{variantMediaOption:Me.mediaOptionId,holdOffDuration:-1,lowestCandidate:null};const T=I.enabledMediaOptionIdByType(we.Variant),A=I.variantMediaOptionById(T),q=null!=i.find(e=>e.mediaOptionId===T),E=A&&A.iframes===c,O=A&&E?A.score:void 0,w=A&&E?A.frameRate:void 0,R=A&&E?A.height:void 0,M=y.getQueryForOption(A),P=M.mediaOptionDetailsEntityRecord,C=E?rf(b,g.maxBufferHole):0,K=b.getMediaBufferInfo(b.desiredPos,g.maxBufferHole),k=Rc(g.liveAllowLowLatencyPlayback,b.isPlayingAtLive,null!=(s=null==(a=null==(n=M.mediaOptionDetails)?void 0:n.parts)?void 0:a.length)?s:0),L={abrBandWidthFactor:p,abrBandWidthUpFactor:m,abrLowSampleBandwidthFactor:g.abrLowSampleBandwidthFactor,abrLowSampleCount:g.abrLowSampleCount},j=lf(h.avgBandwidth,f,L);let $;for(let t=i.length-1;0<=t;t--){const r=i[t];let e=r.mediaOptionId;const n=r.score,a=P&&P[e]?P[e].mediaOptionDetails:void 0,s=P&&P[e]?P[e].lastUpdateMillis:null,D=wc(a,g,k),p=no(r,g.fragLoadPolicy).maxLoadTimeMs,f=null!=A&&r.bitrate>A.bitrate,x=null!=A&&r.bitrate<A.bitrate,y=!(null!=w&&(f&&r.frameRate<w||x&&r.frameRate>w)),v=!(f&&null!=R&&R>r.height),S=!(x&&(r.bitrate===A.bitrate-1||r.bitrate===A.bitrate+1)),b=!(H&&f&&null!=O&&(n<O||n===O&&A&&r.bitrate>=A.bitrate)),M=r.iframes===c;if(fe(D)&&M&&y&&v&&S&&b){const L=Zm(I,r,c),N=!c,{adjustedbw:G,adjustedBitrate:F,fetchDuration:B,rejectLevelDueToPeakBW:W,canFitMultipleSegments:z,validFlowRate:Y}=function(e,t,i,r,n,a,s,o,l,d,u,c,h,p){var s=s?d.bwUp:d.bwDown,d=e["trickPlaybackConfig"],m=fc(t,d),f=wc(i,e,u),{totalTime:i,avgTime:u,peakTotalTime:n,peakAvgTime:h}=yc(e,t,i,u,l,n,h,o),d=fc({bitrate:t.bandwidth,iframes:t.iframes,frameRate:t.frameRate},d),e=e.abrSafeDurationCountForPeakBitrate*f,a=a*((d||t.bitrate||0)*f)/8<=c;let g=!0;return p&&(g=t.bitrate*f/l.avgBandwidth<p/1e3),{adjustedbw:s,adjustedBitrate:m,fetchDuration:o?i:u,rejectLevelDueToPeakBW:s<d&&(r<e||r-(o?n:h)+f<e),canFitMultipleSegments:a,validFlowRate:u<f&&i<f&&g}}(g,r,a,C,K,Q,f,(null==A?void 0:A.mediaOptionId)!==r.mediaOptionId,h,j,k,_,s,p);if((c||N&&Boolean(L))&&($=e),F<G&&z&&!W&&Y&&(!N||Boolean(L))&&(c||!B||B<U)){if(o=r.bitrate,l=V,d=(d=u).instantBw,(l.fragDownloadSlow||l.fragDownloadTooSlow||fe(d)&&d<o)&&q&&E)if(C<=2*D&&f)e=T;else if(m*u.instantBw<F)continue;return{variantMediaOption:e,holdOffDuration:B,alternates:L}}}}return{variantMediaOption:Me.mediaOptionId,holdOffDuration:-1,lowestCandidate:$}}}(t=bp=bp||{})[t.STARTUP=0]="STARTUP",t[t.STEADY=1]="STEADY";class hf{constructor(e,t){this.zu=new Set,this.Hu=Object.create(null);for(const t of e)this.Hu[t]=0,this.zu.add(t);void 0!==t&&(this.Hu[t]=1)}static from(e){return new hf(e.activeIdIterator())}*[Symbol.iterator](){for(const e of this.zu[Symbol.iterator]())yield{mediaOptionId:e,weight:this.Hu[e]}}activeIdIterator(){return this.zu[Symbol.iterator]()}clear(){this.Hu=Object.create(null),this.zu.clear()}normalize(i){if(0===this.zu.size)this.zu.add(i),this.Hu[i]=1;else{var r=[];let e=0,t=0;for(const i of this.activeIdIterator()){const n=Math.max(xe(this.Hu[i],0),0);r[e]=n,t+=n,e++}if(t<=0||!fe(t))this.zu.add(i),this.Hu[i]=1;else{const n=function(t){var i=t.length;let r=!1;var n=t.slice();t.sort(function(e,t){return t-e});let a=0,s=0;var o=[];for(let e=0;e<i-1;++e)if(a+=t[e],(s=(a-1)/(e+1))>=t[e+1]){r=!0;break}r||(s=(a+t[i-1]-1)/i);for(let e=0;e<i;++e)o[e]=Math.max(n[e]-s,0);return o}(r);e=0;for(const i of this.activeIdIterator())this.Hu[i]=Math.max(0,n[e]),e++}}}renormalize(e,t){var i=new Set(e);for(const e of this.zu)i.has(e)||delete this.Hu[e];for(const e of i)this.zu.has(e)||this.set(e,0);this.normalize(t)}get(e){return this.zu.has(e)?this.Hu[e]:0}set(e,t){this.Hu[e]=t}}class pf{constructor(){this.Qu=new cf,this.Ku=bp.STARTUP,this.Wu=0}findBestVariant(t,e,i){const{config:r,rootPlaylistQuery:n}=e,{estimate:a,bwStatus:s,playbackRate:o,currentFragDuration:l,isLiveOrEvent:d}=i;if(!d)return this.Qu.findBestVariant(t,e,i);e=3*l,i=xe(null==s?void 0:s.instantBw,a.avgBandwidth);if(t.length<=1){const e=0<t.length?t[0]:Me;return{variantMediaOption:e.mediaOptionId,holdOffDuration:0,alternates:of(e,n),lowestCandidate:e.mediaOptionId}}function*u(){for(const e of t.values())yield e.mediaOptionId}var c=n.enabledVariantMediaOption,h=Math.pow(e,.9),p=1/(2*Math.max(Math.pow(e,.9),h*Math.sqrt(e))),m=Math.abs(o);if(this.Gu?this.Gu.renormalize(u(),c.mediaOptionId):this.Gu=new hf(u(),c.mediaOptionId),this.Ku===bp.STARTUP)return this.Wu=h,this.Ku=bp.STEADY,{variantMediaOption:c.mediaOptionId,holdOffDuration:0,alternates:c.iframes?void 0:of(c,n),lowestCandidate:c.mediaOptionId};var f=r.abrBandWidthFactor*i,g=l,y=this.Gu,v=hf.from(y);for(const e of t){const{mediaOptionId:t,bitrate:i}=e,r=g*m*i/f,O=Math.sign(e.bitrate-f)*r,n=-Math.log(1+i/1e6),a=y.get(t)-p*(n+(this.Wu+h)*O);v.set(t,a)}v.renormalize(u(),c.mediaOptionId);let I=0,S=0,b=0;var T=m*g/f;for(const{mediaOptionId:e,bitrate:i}of t){const t=y.get(e),r=v.get(e);I+=t*T,S+=(r-t)*T,b+=r*i}e=I-g;this.Wu=Math.max(0,e+S),this.Gu=v;let A=Me,E=Number.MAX_SAFE_INTEGER;for(const e of t){const t=Math.abs(e.bitrate-b);t<E&&e.bitrate<f&&(E=t,A=e)}return A.bitrate>=f&&(this.Wu=3*Math.max(h,this.Wu)),{variantMediaOption:A.mediaOptionId,holdOffDuration:0,lowestCandidate:t[0].mediaOptionId}}findBestVariantForEmergency(e,t,i){return this.findBestVariant(e,t,i)}}class mf{constructor(){this.nextMaxAutoOptionId=Me.mediaOptionId,this.nextMinAutoOptionId=Me.mediaOptionId,this.status={fragDownloadSlow:!1,fragDownloadTooSlow:!1},this.highBwTrigger=NaN}nextAutoMediaOption(e,t,i){var r,n=this.nextMaxAutoOptionId;const a=this.status["fragDownloadTooSlow"],{config:s,rootPlaylistService:o,rootPlaylistQuery:l,statsService:d}=t,u=d.getQueryForId(l.statsId);if(n===Me.mediaOptionId||!a&&ef(u.getBandwidthEstimate(s)))return e.length?(r=uf(t,Sp.Auto,i),this.Xu(e,t,r,Sp.Auto)):{variantMediaOption:Me.mediaOptionId,holdOffDuration:0,lowestCandidate:void 0};if(i)return{variantMediaOption:n,holdOffDuration:0,lowestCandidate:void 0,alternates:void 0};{const e=l.variantMediaOptionById(n),t=l.enabledAlternateMediaOptionByType(we.Subtitle),i=l.enabledAlternateMediaOptionByType(we.AltAudio),a=null==i?void 0:i.persistentID,s=null==t?void 0:t.persistentID,c=!l.preferHDR,d=o.getBestMediaOptionTupleFromVariantAndPersistentId(l,e,a,s,void 0,[],void 0,c,!1,!1,!1);return l.isValidMediaOptionTuple(d)?{variantMediaOption:d[we.Variant].mediaOptionId,holdOffDuration:0,alternates:{altAudio:d[we.AltAudio],subtitle:d[we.Subtitle]},lowestCandidate:void 0}:{variantMediaOption:l.enabledMediaOptionKeys[we.Variant].mediaOptionId,holdOffDuration:0,lowestCandidate:void 0}}}Xu(e,t,i,r){var n=t["rootPlaylistQuery"],a=i.iframeMode;let s=0;const o=this.nextMinAutoOptionId;if(o!==Me.mediaOptionId){const t=e.findIndex(e=>e.mediaOptionId===o);0<=t&&(s=t)}if((s=af(s,e,a,n))<0)return{variantMediaOption:Me.mediaOptionId,holdOffDuration:0,lowestCandidate:null};let l=e.length-1;const d=this.nextMaxAutoOptionId;if(d!==Me.mediaOptionId){const t=e.findIndex(e=>e.mediaOptionId===d);0<=t&&(l=t)}var u=Math.max(0,Math.min(e.length-1,l)),c=Math.max(0,Math.min(e.length-1,s)),c=e.slice(c,u+1),u=this.findBestVariant(c,t,i,r);return u.variantMediaOption===Me.mediaOptionId&&0<=s&&(u.variantMediaOption=e[s].mediaOptionId,u.alternates=a?void 0:of(e[s],n)),u}getImplementation(e){return e===_a.L2A?this.Yu||(this.Yu=new pf):this.Yu||(this.Yu=new cf),this.Yu}findBestVariant(e,t,i,r){var n;return e.length?(n=t["config"],n=this.getImplementation(n.abrAlgorithm),r===Sp.Auto?n.findBestVariant(e,t,i):n.findBestVariantForEmergency(e,t,i)):{variantMediaOption:Me.mediaOptionId,holdOffDuration:-1,lowestCandidate:null}}reset(e){this.highBwTrigger=NaN,this.status={fragDownloadSlow:!1,fragDownloadTooSlow:!1},this.resetLevelCaps()}resetLevelCaps(){this.nextMaxAutoOptionId=Me.mediaOptionId,this.nextMinAutoOptionId=Me.mediaOptionId}}function ff(e){return"loading"===(null==e?void 0:e.state)&&fe(null==(e=e.bwSample)?void 0:e.trequest)}function gf(e,t){e.fragDownloadSlow=t.fragDownloadSlow||e.fragDownloadSlow,e.fragDownloadTooSlow=t.fragDownloadTooSlow||e.fragDownloadTooSlow}const yf=2e3,vf=1e3,If=100,Sf=25;function bf(e,t,i,r){let{fragDownloadSlow:n,fragDownloadTooSlow:a}=t;t=i.variantMediaOptionById(e.mediaOptionId),i=null==t?void 0:t.bitrate,t=e.bwSample,r=r.child(Jm),r=function(e,t,i){let r=0;i=fe(t)?Math.round(i*t/8):null;return e&&(fe(e.total)?r=e.total:fe(e.loaded)&&fe(i)?r=Math.max(e.loaded,i):fe(e.loaded)?r=e.loaded:fe(i)&&(r=i)),r}(t,i,e.duration),i=t&&t.complete?t.tload:performance.now(),i=t&&fe(t.tfirst)?i-t.tfirst:0,t=t&&fe(t.loaded)&&0<r?t.loaded*e.duration*1e3/r:0;return(e.part&&i>=If&&i-t>=Sf||i>=yf&&i-t>=vf)&&(n=!0),i>=1e3*e.duration&&(a=!0),{fragDownloadSlow:n,fragDownloadTooSlow:a}}function Tf(e,t,i){var{rootPlaylistService:r,rootPlaylistQuery:n}=i,e=Af(e,i);return e&&r.setEnabledMediaOptions(n.itemId,e),null!=e}function Af(e,t){var i,{rootPlaylistService:r,mediaSink:n,rootPlaylistQuery:p,statsService:a,config:s,mediaSelectionBossService:m}=t,n=n.mediaQuery,f=r.logger.child(Jm),o=n.isIframeRate,l=p.enabledMediaOptionKeys[we.Variant];if(e===yp.None)return null;if(o&&e!==yp.IframeModeChange&&n.getBufferedSegmentsByType(B.Variant).filter(e=>e.frag.iframe).length%s.minFramesBeforeSwitchingLevel!=0)return null;var n=a.getQueryForId(null!=(u=p.statsId)?u:""),d=[Me,Me,Me];if(e===yp.IframeModeChange){const e=p.enabledMediaOptionsBeforeTrickplay;if(r.saveEnabledOptionsForTrickplay(p.itemId,o),!o&&e){const t=function(e,t,i){const r=sf(p,m,!1,t,f),n=t.targetStartupMs,a={avgPlaylistParseTimeMs:0,avgPlaylistLoadTimeMs:0},s=i.getFragEstimate(t),o={avgBufferCreateMs:0,avgInitFragAppendMs:0,avgDataFragAppendMs:0},l=s.maxDurationSec,d=i.getBandwidthEstimate(t),u={enableAdaptiveStartup:!0,defaultTargetDuration:l,targetStartupMs:n,heuristicStartupRestrictions:{minValidBitrate:0,minValidHeight:0,maxValidHeight:1/0,maxValidBitrate:1/0,maxPreferredBitrate:1/0},enableBoss:t.enableBoss,enableContentSteering:t.enableContentSteering},c=r.filter(e=>!e.iframes&&(!e.width||!e.height||e.width*e.height<=2488320));let h=e;0<c.length&&(h=c[0].mediaOptionId);i=c.filter(e=>tc(e,u,d,a,s,o));return h=0<i.length?i[i.length-1].mediaOptionId:h}(e[we.Variant].mediaOptionId,s,n);if(t){r.setNextMaxAutoOptionId(t);const e=p.variantMediaOptionById(t);null!=m&&m.setTransformer(p.itemId,Re.BitrateFilter,new Wc(0,null!=(a=null==e?void 0:e.bitrate)?a:0))}}}var u=sf(p,m,o,s,f),c=r.abrController.nextAutoMediaOption(u,t,o);if(o||e!==yp.IframeModeChange||(r.setNextMaxAutoOptionId(Me.mediaOptionId),null==m)||m.removeTransformer(p.itemId,Re.BitrateFilter),e===yp.HighBandwidth&&c.variantMediaOption===Me.mediaOptionId)return null;if(c.variantMediaOption===l.mediaOptionId)return null;if(c.variantMediaOption===Me.mediaOptionId&&!c.lowestCandidate){const e=o?ys.ABRIframeLowestLevel:ys.ABRLowestLevel,t=m.getQuery(p.itemId,f).variantFor(e),u=Zm(p,t,o);c.alternates=u,c.lowestCandidate=t.mediaOptionId}n=c.variantMediaOption!==Me.mediaOptionId?c.variantMediaOption:c.lowestCandidate;d[we.Variant]={itemId:p.itemId,mediaOptionId:n};for(const e of[we.AltAudio,we.Subtitle]){const t=p.enabledMediaOptionIdByType(e);if(t!==Me.mediaOptionId){const u=e===we.AltAudio?null==(i=c.alternates)?void 0:i.altAudio:null==(i=c.alternates)?void 0:i.subtitle;d[e]=u||{itemId:p.itemId,mediaOptionId:t}}}return d}function Ef(e){return 1e3*(e.averagetargetduration||e.targetduration)}function Of(e,t,i){var r;return e.liveOrEvent&&(null!=(r=e.serverControls)&&r.canBlockReload&&i||(r=Ef(e),performance.now()-t>=r))}function wf(e,t){return null==e||t.endSN!==e.endSN||t.liveOrEvent!==e.liveOrEvent}function Rf(e,t){return null==e||e.partEndSN!==t.partEndSN||e.partEndIndex!==t.partEndIndex}const Mf={NONE:"","AES-128":"","ISO-23001-7":"","SAMPLE-AES":"","SAMPLE-AES-CTR":""},Pf={getRichestVideoCodec(e){if(e&&e.length)return e&&N(e,Pc)},getRichestAudioCodec(e){if(e&&e.length)return e&&N(e,kc)},getAlternateWithRichestChannelLayoutForGroupId(e){if(e&&e.length)return N(null!=e?e:[],e=>ge.getChannelCount(e.channels))}};function Cf(e){return new j(K.MEDIA_ERROR,q.STEERING_MANIFEST_PARSING_ERROR,!1,pe.FormatError,e)}function kf(t){var i=Object.keys(t);for(let e=0;e<i.length;e++){var r=i[e];if("string"!=typeof r||"string"!=typeof t[r])return Cf(`invalid steering manifest URI-REPLACEMENT item data type, `+r)}}function Lf(e){return"string"!=typeof e?Cf("invalid steering manifest PATHWAY-PRIORITY list item data type"):/^[\w\-\.]+$/.test(e)?void 0:Cf("steering manifest contains invalid pathway ID: "+e)}function Df(t,i,r,n){let a,s,o;n.child({name:"content-steering"});try{try{a=JSON.parse(t)}catch(t){throw Cf("steering manifest JSON format is malformed")}if(null==a)throw Cf("steering manifest is empty");if(o={version:a.VERSION,ttl:a.TTL,universal:a.UNIVERSAL,pathwayPriority:a["PATHWAY-PRIORITY"]},null!=a["RELOAD-URI"]){if("string"!=typeof a["RELOAD-URI"])throw Cf("invalid steering manifest RELOAD-URI data type");o.reloadURI=La.buildAbsoluteURL(i,a["RELOAD-URI"])}if(null!=a["PATHWAY-CLONES"]){const t=a["PATHWAY-CLONES"];o.pathwayClones=[];for(let e=0;e<t.length;e++){const n=t[e],a=Object.prototype.hasOwnProperty.call(n,"BASE-ID"),s=Object.prototype.hasOwnProperty.call(n,"ID"),j=Object.prototype.hasOwnProperty.call(n,"URI-REPLACEMENT");if(!(a&&s&&j))throw Cf("invalid steering manifest PATHWAY-CLONE required attributes missing");l=void 0;var l=n;if("string"!=typeof l["BASE-ID"])throw Cf("invalid steering manifest PATHWAY-CLONES list item data type");if("string"!=typeof l.ID)throw Cf("invalid steering manifest PATHWAY-CLONES list item data type");if("object"!=typeof l["URI-REPLACEMENT"])throw Cf("invalid steering manifest URI-REPLACEMENT data type");if(!r.has(n.ID)){const t=n["URI-REPLACEMENT"],i={"BASE-ID":n["BASE-ID"],ID:n.ID,"URI-REPLACEMENT":{}},a=function(e){if(e["URI-REPLACEMENT"].HOST&&"string"!=typeof e["URI-REPLACEMENT"].HOST)return Cf("invalid steering manifest URI-REPLACEMENT item data type");if(e["URI-REPLACEMENT"].PARAMS&&"object"!=typeof e["URI-REPLACEMENT"].PARAMS)return Cf("invalid steering manifest URI-REPLACEMENT item data type");if(e["URI-REPLACEMENT"].PARAMS&&"object"==typeof e["URI-REPLACEMENT"].PARAMS){var t=kf(e["URI-REPLACEMENT"].PARAMS);if(null!=t)return t}if(e["URI-REPLACEMENT"]["PER-RENDITION-URIS"]&&"object"!=typeof e["URI-REPLACEMENT"]["PER-RENDITION-URIS"])return Cf("invalid steering manifest URI-REPLACEMENT item data type");if(e["URI-REPLACEMENT"]["PER-RENDITION-URIS"]&&"object"==typeof e["URI-REPLACEMENT"]["PER-RENDITION-URIS"]){t=kf(e["URI-REPLACEMENT"]["PER-RENDITION-URIS"]);if(null!=t)return t}if(e["URI-REPLACEMENT"]["PER-VARIANT-URIS"]&&"object"!=typeof e["URI-REPLACEMENT"]["PER-VARIANT-URIS"])return Cf("invalid steering manifest URI-REPLACEMENT item data type");if(e["URI-REPLACEMENT"]["PER-VARIANT-URIS"]&&"object"==typeof e["URI-REPLACEMENT"]["PER-VARIANT-URIS"]){t=kf(e["URI-REPLACEMENT"]["PER-VARIANT-URIS"]);if(null!=t)return t}}(n);if(null!=a)throw a;for(const r of["HOST","PARAMS","PER-VARIANT-URIS","PER-RENDITION-URIS"])"HOST"===r&&t[r]?i["URI-REPLACEMENT"].HOST=t[r]:"PARAMS"!==r&&"PER-VARIANT-URIS"!==r&&"PER-RENDITION-URIS"!==r||!t[r]||(i["URI-REPLACEMENT"][r]=t[r]);o.pathwayClones.push(i)}}}const n=function(e){if("number"!=typeof e.version)return Cf("invalid steering manifest VERSION data type");if(e.version<1||1<e.version)return Cf("steering manifest VERSION "+e.version+" is unsupported");if("number"!=typeof e.ttl)return Cf("invalid steering manifest TTL data type");if(e.ttl<0)return Cf("invalid steering manifest TTL value");if(null!=e.reloadURI&&"string"!=typeof e.reloadURI)return Cf("invalid steering manifest RELOAD-URI data type");if(null!=e.universal&&"boolean"!=typeof e.universal)return Cf("invalid steering manifest UNIVERSAL data type");if(!jt(e.pathwayPriority))return Cf("invalid steering manifest PATHWAY-PRIORITY data type");for(const t of e.pathwayPriority){const e=Lf(t);if(null!=e)return e}return e.pathwayClones&&!jt(e.pathwayClones)?Cf("invalid steering manifest PATHWAY-CLONES data type"):void 0}(o);if(null!=n)throw n;return o}catch(t){throw s=t instanceof j?t:Cf(`unknown exception when parsing steering manifest: `+t)}}class xf{constructor(){this.Ju=null,this.Zu=null,this.relurl="",this.baseurl=null,this.isInitSegment=!1,this.mediaSeqNum=NaN,this.discoSeqNum=NaN,this.iframe=!1,this.bitrate=NaN,this.start=NaN,this.duration=NaN,this.lastByteRangeEndOffset=NaN,this.gap=!1,this.part=!1,this.partIndependent=!1,this.partGap=!1,this.partIndex=NaN,this.iframe=!1}getMediaFragment(e,t,i){i={mediaOptionType:i,relativeUrl:this.relurl,start:this.start,duration:this.duration,mediaSeqNum:this.mediaSeqNum,discoSeqNum:this.discoSeqNum,mediaOptionId:t,itemId:e,isLastFragment:!1,isInitSegment:this.isInitSegment,gap:this.gap};return this.part&&(i.part=this.part,i.partIndependent=this.partIndependent,i.partGap=this.partGap,i.partIndex=this.partIndex),null!=(t=this.byteRange)&&t.length&&fe(this.byteRangeStartOffset)&&fe(this.byteRangeEndOffset)&&(i.byteRangeOffset={start:this.byteRangeStartOffset,end:this.byteRangeEndOffset}),this.iframe&&(i.iframe=this.iframe),this.levelkey&&(i.keyTagInfo=this.levelkey),this.programDateTime&&(i.programDateTime=this.programDateTime),fe(this.bitrate)&&(i.bitrate=this.bitrate),i}get programDateTime(){return!this.Ju&&this.rawProgramDateTime&&(this.Ju=Date.parse(this.rawProgramDateTime)),this.Ju}get byteRange(){var e,t,i;return!this.Zu&&this.rawByteRange&&(e=new Array(2),1===(t=this.rawByteRange.split("@",2)).length?(i=this["lastByteRangeEndOffset"],e[0]=i||0):e[0]=parseInt(t[1]),e[1]=parseInt(t[0])+e[0],this.Zu=e),this.Zu}get byteRangeStartOffset(){var e;return null==(e=this.byteRange)?void 0:e[0]}get byteRangeEndOffset(){var e;return null==(e=this.byteRange)?void 0:e[1]}get rangeString(){return 0<=this.start&&0<=this.duration?this.start.toFixed(2)+`-`+(this.start+this.duration).toFixed(2):"N/A"}get fragTag(){return`msn/dsn/partIndex: ${this.mediaSeqNum}/${this.discoSeqNum}/`+this.partIndex}}const Nf={parseMediaCharacteristics:e=>e?e.split(/\s*,\s*/):new Array,addMediaToSelectionArray(e,t,i){var r;if(void 0===e)return-1;e=e.MediaSelectionGroupOptions;let n=e.find(e=>e.MediaSelectionOptionsMediaType===t.mediaType&&e.MediaSelectionOptionsName===t.name&&e.MediaSelectionOptionsExtendedLanguageTag===t.lang);return n||(n={MediaSelectionOptionsMediaType:null!=(r=t.mediaType)?r:Is.UNKNOWN,MediaSelectionOptionsExtendedLanguageTag:t.lang,MediaSelectionOptionsLanguageCode:Dp.mapValue(t.lang),MediaSelectionOptionsIsDefault:null!=(r=t.default)&&r,MediaSelectionOptionsName:t.name,MediaSelectionOptionsPersistentID:i,MediaSelectionOptionsTaggedMediaCharacteristics:null!=(r=t.characteristics)?r:[],MediaSelectionOptionsIsAutoSelect:null!=(r=t.autoselect)&&r,MediaSelectionOptionsInterstitialId:t.interstitialId},t.mediaType===Is.SUBTITLE&&(n.MediaSelectionOptionsDisplaysNonForcedSubtitles=t.forced?vs.NO:vs.YES),i++,e.push(n)),t.persistentID=n.MediaSelectionOptionsPersistentID,i},makeDefaultClosedCaptionOption(e,t,i){var{interstitialId:i,interstitialAssetId:r}=null!=i?i:{};return{itemId:e,mediaOptionType:we.Subtitle,id:0,mediaOptionId:"cc1_"+va(),mediaType:Is.CLOSEDCAPTION,inStreamID:"CC1",groupId:"cc",name:"English-CC",type:"CLOSED-CAPTIONS",default:!1,autoselect:!1,forced:!1,lang:"en",characteristics:["public.accessibility.transcribes-spoken-dialog","public.accessibility.describes-music-and-sound"],persistentID:t,relativeUrl:void 0,interstitialId:i,interstitialAssetId:r}}},Ff=/^(\d+)x(\d+)$/,Bf=/\s*(.+?)\s*=((?:\".*?\")|.*?)(?:,|$)/g;class Uf{constructor(e){this.tc=e}get keys(){return Object.keys(this.tc)}hasKey(e){return e in this.tc}getInt(e){var e=this.tc[e];if(e)return(e=parseInt(e))>Number.MAX_SAFE_INTEGER?1/0:e}getFloat(e){e=this.tc[e];if(e)return parseFloat(e)}getResolution(e){e=this.tc[e],e=Ff.exec(e);let t;return t=null!==e?{width:parseInt(e[1],10),height:parseInt(e[2],10)}:t}getHex(e){const t=this.tc[e];if(t){var i=(1&(i=(t||"0x").slice(2)).length?"0":"")+i,r=new Uint8Array(i.length/2);for(let e=0;e<i.length/2;e++){const t=parseInt(i.slice(2*e,2*e+2),16);if(!fe(t))return;r[e]=t}return r}}getString(e,t=!0){let i=this.tc[e];if(i)return 34===i.charCodeAt(0)&&34===i.charCodeAt(i.length-1)&&(i=i.slice(1,-1)),t?X(i):i}matchesEnum(e,t){e=this.tc[e];return null!=e&&e===t}}class _f{static parseTags(e){var t,i={};if(e)for(Bf.lastIndex=0;null!==(t=Bf.exec(e));){const e=t[1],r=t[2];i[e]=r}return new Uf(i)}}const Vf={ExtractVariableParameter:/{\$(.*?)}/g,LevelPlaylistFast:/#EXTINF:(\d*(?:\.\d+)?)(?:,(.*))?|(?!#)(\S.+)|#EXT-X-BYTERANGE:(.+)|#EXT-X-PROGRAM-DATE-TIME:(.+)|#EXT-X-BITRATE:(.+)|#EXT-X-DATERANGE:(.+)|#EXT-X-PART:(.+)|(#EXT-X-.*)/g,LevelPlaylistSlow:/#EXT-X-(PLAYLIST-TYPE|MEDIA-SEQUENCE|TARGETDURATION|KEY|START|DISCONTINUITY-SEQUENCE|DISCONTINUITY|VERSION|MAP|DEFINE|ENDLIST|I-FRAMES-ONLY|GAP|SERVER-CONTROL|PART-INF|SKIP|RENDITION-REPORT|PRELOAD-HINT)(?::(.+)){0,1}/,MasterPlaylist:/#EXT-X-STREAM-INF:([^\n\r]*)[\r\n]+([^\r\n]+)|#EXT-X-I-FRAME-STREAM-INF:([^\r\n]+)|#EXT-X-DEFINE:([^\n\r]*)|#EXT-X-CONTENT-STEERING:([^\n\r]*)|#EXT-X-START:([^\n\r]*)/g,MasterPlaylistAlternateMedia:/#EXT-X-MEDIA:(.*)/g,SessionData:/#EXT-X-SESSION-DATA[^:]*:(.*)/g,SessionKeys:/#EXT-X-SESSION-KEY:([^\n\r]*)/g,VARIABLE_PLAYLIST_REGEX:/(NAME|VALUE)=\"(.*)\",(NAME|VALUE)=\"(.*)\"|(IMPORT)=\"(.*)\"/};(Ts=Tp=Tp||{})[Ts.Audio=0]="Audio",Ts[Ts.Subtitle=1]="Subtitle";class Qf{static isValidPlaylist(e){return e.startsWith("#EXTM3U")}static isMediaPlaylist(e){return 0<e.indexOf("#EXTINF:")||0<e.indexOf("#EXT-X-PLAYLIST-TYPE:")}static replaceVariables(e,t,i){let r=e?X(e):void 0;return r=r&&0<Object.keys(t).length?r.replace(Vf.ExtractVariableParameter,e=>{Vf.ExtractVariableParameter.lastIndex=0;e=Vf.ExtractVariableParameter.exec(e),e=null==e?void 0:e[1];if(e&&"string"==typeof t[e])return t[e];throw new j(K.MEDIA_ERROR,i?q.MANIFEST_PARSING_ERROR:q.LEVEL_LOAD_ERROR,!1,pe.PlaylistErrorInvalidEXTXDEFINE)}):r}static parseDecryptData(e,t,i,r){var n;const a=_f.parseTags(t),s=a.getString("METHOD"),o=(t=s)&&t in Mf?s:null;var l=null!=(n=a.getString("KEYFORMAT"))?n:"";if(o&&Qf.shouldSelectKeyTag(l,o,r)){const t=a.getString("URI"),r=a.getHex("IV");if(t&&a.hasKey("IV")&&!r){const e=new j(K.MEDIA_ERROR,q.MANIFEST_PARSING_ERROR,!0,pe.PlaylistErrorInvalidEntry,`Invalid IV: `+a.getString("IV",!1));throw e.url=i,e}const n=t?La.buildAbsoluteURL(i,t,{alwaysNormalize:!0}):"",s=(a.getString("KEYFORMATVERSIONS")||"1").split("/").map(Number).filter(isFinite);return new nl(e,o,n,r,l,s)}}static shouldSelectKeyTag(e,t,i){return"AES-128"===t||"NONE"===t||null==i||e===zu.getKeySystemFormat(i)}static optOutClosedCaption(t){let i=!1,r=!1;if(t)for(let e=0;e<t.length;++e){var n=t[e];if(n.videoCodec&&(r=!0)!==n.iframes&&n.closedcaption&&"none"===n.closedcaption.toLowerCase()){i=!0;break}}return!r||i}static parseRootPlaylistAlternateMediaOptions(o,l,d,u,c,h,p){var m,f={MediaSelectionGroupAllowEmptySelection:1,MediaSelectionGroupMediaCharacteristics:["public.audible"],MediaSelectionGroupMediaType:Is.AUDIO,MediaSelectionGroupOptions:[]},g={MediaSelectionGroupAllowEmptySelection:1,MediaSelectionGroupMediaCharacteristics:["public.legible"],MediaSelectionGroupMediaType:Is.SUBTITLE,MediaSelectionGroupOptions:[]},y={videoAlternateOptions:[],audioAlternateOptions:[],subtitleAlternateOptions:[],audioMediaSelectionGroup:f,subtitleMediaSelectionGroup:g,audioGroupMapping:new Map,subtitleGroupMapping:new Map};let v=0;for(Vf.MasterPlaylistAlternateMedia.lastIndex=0;null!=(I=Vf.MasterPlaylistAlternateMedia.exec(l));){const l=Qf.replaceVariables(I[1],c,!0),d=_f.parseTags(l);let e,t,i,r=Is.UNKNOWN;const A=Nf.parseMediaCharacteristics(d.getString("CHARACTERISTICS")),E=d.getString("GROUP-ID"),O=d.getString("CHANNELS");let n,a=[];var I=d.getString("TYPE");switch(I){case"VIDEO":r=Is.VIDEO,n=we.Variant,t=y.videoAlternateOptions;break;case"AUDIO":r=Is.AUDIO,n=we.AltAudio,t=y.audioAlternateOptions,i=f;const o=u.find(e=>{return(null==(e=h.get(e.mediaOptionId))?void 0:e[0])===E});a=o&&null!=(m=o.audioCodecList)?m:[];break;case"SUBTITLES":r=Is.SUBTITLE,n=we.Subtitle,t=y.subtitleAlternateOptions,i=g;break;case"CLOSED-CAPTIONS":r=Is.CLOSEDCAPTION,n=we.Subtitle,e=d.getString("INSTREAM-ID"),t=y.subtitleAlternateOptions,i=g}if(null==n||!E||!I||!t)break;var S=Kp.shortenLanguageCode(null!=(S=d.getString("LANGUAGE"))?S:"");let s=null!=(b=d.getString("NAME"))?b:"";""===s&&(s=S,I===Is.CLOSEDCAPTION)&&(s+=" CC");var{interstitialId:b,interstitialAssetId:T}=null!=p?p:{},I={itemId:o,mediaOptionType:n,mediaType:r,relativeUrl:d.getString("URI"),groupId:E,channels:O,groupCodecList:a,name:s,type:I,default:d.matchesEnum("DEFAULT","YES"),autoselect:d.matchesEnum("AUTOSELECT","YES"),forced:d.matchesEnum("FORCED","YES"),characteristics:A,persistentID:v,id:t.length,mediaOptionId:n+`_`+t.length.toString(16),lang:S,interstitialId:b,interstitialAssetId:T},S=d.getString("STABLE-RENDITION-ID");S&&(I.stableRenditionID=S),I.mediaType===Is.CLOSEDCAPTION&&e&&(I.inStreamID=e),t.push(I),y.audioGroupMapping&&I.mediaOptionType===we.AltAudio&&(y.audioGroupMapping.has(E)?null!=(b=y.audioGroupMapping.get(E))&&b.push(I):y.audioGroupMapping.set(E,[I])),y.subtitleGroupMapping&&I.mediaOptionType===we.Subtitle&&(y.subtitleGroupMapping.has(E)?null!=(T=y.subtitleGroupMapping.get(E))&&T.push(I):y.subtitleGroupMapping.set(E,[I])),v=Nf.addMediaToSelectionArray(i,I,v)}return{alternateMediaInfo:y}}static parseMediaOptionPlaylist(n,a,s,o,l,d,u,c,B,U,h=0,p=!1,m){var f,g;let y=0,v=0;const{interstitialId:I,interstitialAssetId:e}=null!=c?c:{},S={itemId:l,mediaOptionId:d,mediaOptionType:u,type:"",version:0,url:a,relativeUrl:a,initSegments:{},fragments:[],liveOrEvent:!0,startSN:0,endSN:0,iframesOnly:p,targetduration:0,totalduration:0,averagetargetduration:0,ptsKnown:!1,discoToMSNMap:{},pdtToMSN:[],interstitialId:I,interstitialAssetId:e};let t,i,b=new nl(B,"NONE"),T=!1,A=!1,E=0,r=null,O=new xf,w=NaN;var R={};let M,_,V=!0,P=!0,C=!1,k=0,L=0;Vf.LevelPlaylistFast.lastIndex=0;for(var Q=()=>new j(K.MEDIA_ERROR,q.MANIFEST_PARSING_ERROR,!0,pe.IncompatibleAsset,"Invalid key system preference for the playlist");null!==(t=Vf.LevelPlaylistFast.exec(n));){const n=t[1];if(n)O.duration=parseFloat(n),O.title=X(t[2]);else if(t[3]||t[8]){if(t[8]&&(O.part=!0),O.part){const n=t[8],a=_f.parseTags(n),s=a.getFloat("DURATION");if(!fe(s))break;O.duration=s,(M=Qf.replaceVariables(a.getString("URI",!1),R,!1))&&(O.relurl=M),O.partIndependent=a.matchesEnum("INDEPENDENT","YES"),S.hasPartIndependentTag=S.hasPartIndependentTag||null!=a.getString("INDEPENDENT");const o=a.getString("BYTERANGE");if(o&&(O.rawByteRange=o,r)){const n=r.byteRangeEndOffset;n&&(O.lastByteRangeEndOffset=n)}O.partGap=a.matchesEnum("GAP","YES")}if(fe(O.duration)){if(A&&!T)throw Q();T=!1,A=!1;let e=0;if(O.part?(e=y,fe(S.partStartSN)||(S.partStartSN=e),O.partIndex=k++,O.start=v+L+h,S.partEndSN=e,S.partEndIndex=O.partIndex):(e=y++,k=0,L=0,O.start=v+h,(M=Qf.replaceVariables(t[3],R,!1))&&(O.relurl=M)),O.levelkey=b,O.mediaSeqNum=e,O.discoSeqNum=E,O.iframe=S.iframesOnly,O.baseurl=a,fe(O.byteRangeEndOffset)&&fe(O.byteRangeStartOffset)?O.bitrate=8*(O.byteRangeEndOffset-O.byteRangeStartOffset)/O.duration:O.bitrate=w,!(C=m&&S.startSN>=m.startSN&&S.startSN<=m.endSN?!0:C)||!O.part&&m&&e>m.endSN||O.part&&m&&fe(m.partEndSN)&&fe(m.partEndIndex)&&(e>m.partEndSN||e===m.partEndSN&&O.partIndex>m.partEndIndex)){if(null!=i&&(O.rawProgramDateTime=i,(null==r?void 0:r.discoSeqNum)!==E)){const n=O.programDateTime;fe(n)&&S.pdtToMSN.push([n,O.mediaSeqNum])}S.discoToMSNMap[O.discoSeqNum]?S.discoToMSNMap[O.discoSeqNum][1]=O.mediaSeqNum:S.discoToMSNMap[O.discoSeqNum]=[O.mediaSeqNum,O.mediaSeqNum],O.part?(S.parts||(S.parts=[]),L+=O.duration,S.parts.push(O.getMediaFragment(l,d,u))):(S.fragments.push(O.getMediaFragment(l,d,u)),v+=O.duration)}if(i=void 0,r=O,V||!S.initSegments[E]||P)if(S.iframesOnly&&O.byteRangeStartOffset&&0<O.byteRangeStartOffset&&!S.initSegments[E]&&!P){const n=new xf;if(n.relurl=O.relurl,n.rawByteRange=Math.min(O.byteRangeStartOffset,1316)+"@0",n.baseurl=a,n.isInitSegment=!0,n.discoSeqNum=E,n.levelkey=b,n.iframe=!0,A&&!T)throw Q();T=!1,A=!1,S.initSegments[E]=Object.assign(Object.assign({},n.getMediaFragment(l,d,u)),{isInitSegment:!0})}else _&&(S.initSegments[E]=Object.assign(Object.assign({},_),{discoSeqNum:E,isInitSegment:!0}));V=!1,P=!1,O=new xf}}else if(t[4]){if(O.rawByteRange=X(t[4]),r){const n=r.byteRangeEndOffset;n&&(O.lastByteRangeEndOffset=n)}}else if(t[5])i=X(t[5]);else if(t[6]){const n=parseInt(t[6]);fe(n)&&(w=1e3*n)}else if(t[7]){const n=t[7],a=Qf.replaceVariables(n,R,!1),s=_f.parseTags(a),o=s.getString("ID"),l=s.getString("START-DATE");if(o&&l){let e={ID:o,"START-DATE":l};for(const a of s.keys)switch(a){case"ID":case"START-DATE":break;case"DURATION":case"PLANNED-DURATION":e[a]=s.getFloat(a);break;default:e[a]=s.getString(a)}S.daterangeTags||(S.daterangeTags={}),S.daterangeTags[o]&&(e=Qf.validateAndUpdateDateRangeTag(S.daterangeTags[o],e,U)),S.daterangeTags[o]=e}}else if(null!=(t=t[9].match(Vf.LevelPlaylistSlow))){const n=t[1],c=Qf.replaceVariables(t[2],R,!1);switch(n){case"PLAYLIST-TYPE":S.type=null==c?void 0:c.toUpperCase(),"VOD"===S.type&&(S.liveOrEvent=!1);break;case"MEDIA-SEQUENCE":0===S.fragments.length&&c&&(y=S.startSN=parseInt(c));break;case"TARGETDURATION":c&&(S.targetduration=parseFloat(c));break;case"VERSION":c&&(S.version=parseInt(c));break;case"ENDLIST":S.liveOrEvent=!1;break;case"DISCONTINUITY":E++,V=!0;break;case"DISCONTINUITY-SEQUENCE":c&&(E=parseInt(c));break;case"KEY":const n=c;if(A=!0,!T){const o=Qf.parseDecryptData(B,n,a,s);o&&(b=o,T=!0)}break;case"START":const U=c,h=_f.parseTags(U).getFloat("TIME-OFFSET");fe(h)&&(S.startTimeOffset=h);break;case"I-FRAMES-ONLY":S.iframesOnly=!0;break;case"MAP":const p=_f.parseTags(c),f=p.getString("URI"),g=(f&&(O.relurl=f),O.rawByteRange),v=O.lastByteRangeEndOffset;if(O.rawByteRange=p.getString("BYTERANGE"),O.baseurl=a,O.isInitSegment=!0,O.levelkey=b,A&&!T)throw Q();T=!1,A=!1,_=O.getMediaFragment(l,d,u),P=!0,(O=new xf).rawByteRange=g,O.lastByteRangeEndOffset=v;break;case"DEFINE":const I=Vf.VARIABLE_PLAYLIST_REGEX.exec(null!=c?c:"");let e,t,i,r;if(I&&(e="NAME"===I[1]?I[2]:I[4],t="VALUE"===I[1]?I[2]:I[4],i=I[5],r=I[6]),!e&&!t&&"IMPORT"===i&&r&&o.hasOwnProperty(r))R[r]=o[r];else{if(!e||i||(null==I?void 0:I[1])===(null==I?void 0:I[3])||R.hasOwnProperty(e)||!t)throw new j(K.MEDIA_ERROR,q.MANIFEST_PARSING_ERROR,!0,pe.PlaylistErrorMissingImportReference);R[e]=t}break;case"GAP":O.gap=!0;break;case"SERVER-CONTROL":S.serverControls={canSkipUntil:NaN,canSkipDateRanges:!1,canBlockReload:!1};const w=_f.parseTags(c),M=w.getFloat("CAN-SKIP-UNTIL"),C=(fe(M)&&(S.serverControls.canSkipUntil=M),S.serverControls.canSkipDateRanges=w.matchesEnum("CAN-SKIP-DATERANGES","YES"),w.getFloat("HOLD-BACK")),k=(fe(C)&&(S.serverControls.holdBack=C),w.getFloat("PART-HOLD-BACK"));fe(k)&&(S.serverControls.partHoldBack=k),S.serverControls.canBlockReload=w.matchesEnum("CAN-BLOCK-RELOAD","YES");break;case"PART-INF":const L=_f.parseTags(c).getFloat("PART-TARGET");fe(L)&&(S.partTargetDuration=L);break;case"SKIP":var D=_f.parseTags(c),x=D.getInt("SKIPPED-SEGMENTS"),x=(fe(x)&&(S.skippedSegments=x,y+=x),D.getString("RECENTLY-REMOVED-DATERANGES"));if(x&&(S.recentlyRemovedDateranges=x),m&&m.daterangeTags){S.daterangeTags||(S.daterangeTags={});const n=new Set(null==x?void 0:x.split("\t"));for(const a of Object.keys(m.daterangeTags))S.daterangeTags[a]||n.has(a)||(S.daterangeTags[a]=m.daterangeTags[a])}break;case"RENDITION-REPORT":D=_f.parseTags(c),x=D.getString("URI");x&&(N={relUri:x,lastMSN:D.getInt("LAST-MSN"),lastPart:D.getInt("LAST-PART")},S.renditionReports?S.renditionReports.push(N):S.renditionReports=[N]);break;case"PRELOAD-HINT":var H,N=_f.parseTags(c),F=N.getString("TYPE");if(F){const X=N.getString("URI");X&&(F={resourceType:F,Uri:X},fe(H=N.getInt("BYTERANGE-START"))&&(F.byteRangeStart=H),fe(H=N.getInt("BYTERANGE-LENGTH"))&&(F.byteRangeLength=H),S.preloadHints?S.preloadHints.push(F):S.preloadHints=[F])}}}}if((O=r?r:O)&&!O.relurl&&(O.part?(null!=(f=S.parts)&&f.pop(),L-=O.duration):(S.fragments.pop(),v-=O.duration)),!S.liveOrEvent&&0<S.fragments.length&&(S.fragments[S.fragments.length-1].isLastFragment=!0),S.totalduration=v,S.averagetargetduration=v/S.fragments.length,S.endSN=y-1,null!=(g=S.parts)&&g.length){const n=S.parts.length-1;S.partEndSN=S.parts[n].mediaSeqNum,S.partEndIndex=S.parts[n].partIndex}return{mediaOptionDetails:S,isDeltaPlaylist:C}}static parseRootPlaylistWithAlternates(e,t,i,r){var n,a=Qf.parseRootPlaylist(e,t,i,r);if(a.playlistParsingError)throw a.playlistParsingError;var{variantMediaOptions:s,masterVariableList:o,variantIdToAlternateGroupIdTuple:l}=a,t=Qf.parseRootPlaylistAlternateMediaOptions(e,t,i,a.variantMediaOptions,o,l,r),{audioGroupMapping:d,subtitleGroupMapping:u,subtitleAlternateOptions:i,subtitleMediaSelectionGroup:o}=t.alternateMediaInfo;let c,h,p;0!==i.length||Qf.optOutClosedCaption(s)||(c=Nf.makeDefaultClosedCaptionOption(e,0,r),i.push(c),u.set(c.groupId,[c]),Nf.addMediaToSelectionArray(o,c,0));for(const e of s){c&&(e.closedcaption=c.groupId);const t=null==(n=l.get(e.mediaOptionId))?void 0:n[Tp.Audio],i=null==(n=l.get(e.mediaOptionId))?void 0:n[Tp.Subtitle],r=e.closedcaption;if(t&&d&&(e.audioAlternates=null!=(n=d.get(t))?n:[]),t||(h=h||this.consolidateAlterateEntries(d),e.audioAlternates=h),i&&u&&(e.subtitleAlternates=null!=(n=u.get(i))?n:[]),r&&u)if(e.subtitleAlternates&&0<e.subtitleAlternates.length){const t=u.get(r);t&&0<t.length&&(e.subtitleAlternates=e.subtitleAlternates.concat(t))}else e.subtitleAlternates=u.get(r);i||r||(p=p||this.consolidateAlterateEntries(u),e.subtitleAlternates=p)}return Object.assign(Object.assign({},a),t)}static consolidateAlterateEntries(e){var t;let i=[];for(const r of e.keys())i=i.concat(null!=(t=e.get(r))?t:[]);return i}static parseRootPlaylist(t,i,e,r){const n=[],a={},s=new Map,o={};let l,d,u,c,h=0,p=null,m=!0,f=NaN;for(Vf.MasterPlaylist.lastIndex=0;null!=(l=Vf.MasterPlaylist.exec(i));)if(l[4]){let e,t,i;if((l=Vf.VARIABLE_PLAYLIST_REGEX.exec(l[4]))&&(e="NAME"===l[1]?l[2]:l[4],t="VALUE"===l[1]?l[2]:l[4],i=l[5]),!e||a.hasOwnProperty(e)||i||(null==l?void 0:l[1])===(null==l?void 0:l[3])||!t){c=new j(K.MEDIA_ERROR,q.MANIFEST_PARSING_ERROR,!0,pe.PlaylistErrorInvalidEXTXDEFINE);break}a[e]=t}else if(l[5]){const t=Qf.replaceVariables(l[5],a,!0),i=_f.parseTags(t),r=i.getString("SERVER-URI");if("string"!=typeof r){c=new j(K.MEDIA_ERROR,q.MANIFEST_PARSING_ERROR,!0,pe.PlaylistErrorInvalidSERVERURI);break}const g=i.getString("PATHWAY-ID");if(i.hasKey("PATHWAY-ID")&&"string"!=typeof g){c=new j(K.MEDIA_ERROR,q.MANIFEST_PARSING_ERROR,!0,pe.PlaylistErrorInvalidPATHWAYID);break}p={serverURI:qa(r,e),initPathwayID:g||".",initPathwayPriority:[]}}else if(l[6]){const t=_f.parseTags(l[6]).getFloat("TIME-OFFSET");fe(t)&&(f=t)}else{u=Qf.replaceVariables(l[1]||l[3],a,!0);const i=_f.parseTags(u),e=(d=Qf.replaceVariables(l[2]||i.getString("URI"),a,!0),i.getFloat("SCORE"));if(void 0!==e&&!fe(e)||e&&e<0){c=new j(K.MEDIA_ERROR,q.MANIFEST_PARSING_ERROR,!0,pe.PlaylistErrorInvalidSCORE),m=!1;break}m&&void 0===e&&(m=!1);const p=i.getInt("BANDWIDTH"),f=i.getInt("AVERAGE-BANDWIDTH"),T=f||p;if(!T)continue;var g=null!=(g=i.getString("VIDEO-RANGE"))?g:"SDR";if(null==(y=g)||!Oa.includes(y))continue;var y=we.Variant+`_`+n.length.toString(16),v=(s.set(y,[void 0,void 0]),i.getString("AUDIO"));if(v){const t=s.get(y);t&&(t[Tp.Audio]=v)}v=i.getString("SUBTITLES");if(v){const t=s.get(y);t&&(t[Tp.Subtitle]=v)}var v=i.getString("CODECS"),{interstitialId:I,interstitialAssetId:S}=null!=r?r:{},b={itemId:t,mediaOptionId:y,mediaOptionType:we.Variant,relativeUrl:null!=d?d:"",name:i.getString("NAME"),iframes:!!l[3],bandwidth:p||T,avgBandwidth:f,bitrate:T,videoRange:g,frameRate:i.getFloat("FRAME-RATE"),allowedCPCMap:Qf.parseAllowedCPC(i.getString("ALLOWED-CPC",!1)),closedcaption:i.getString("CLOSED-CAPTIONS"),levelCodec:v,score:i.getFloat("SCORE"),pathwayID:i.getString("PATHWAY-ID")||".",interstitialId:I,interstitialAssetId:S},y=i.getString("STABLE-VARIANT-ID"),g=(y&&(b.stableVariantID=y),i.getString("HDCP-LEVEL")),I=(Vu.isRestrictedLevel(g)&&(b.hdcpLevel=g),i.getResolution("RESOLUTION"));if(I&&(b.width=I.width,b.height=I.height),v){b.videoCodecList=new Array,b.audioCodecList=new Array;const t=v.split(/[ ,]+/),i=t["length"];for(let e=0;e<i;e++){const i=t[e];switch(i.slice(0,4)){case"avc1":b.videoCodec=ge.avc1toavcoti(i),b.videoCodecList.push(b.videoCodec);break;case"mjpg":case"jpeg":b.imageCodec=i;case"avc3":case"dvav":case"dva1":case"hev1":case"hvc1":case"dvh1":case"dvhe":case"vp09":case"av01":b.videoCodec=i,b.videoCodecList.push(b.videoCodec);break;case"mp4a":case"ec-3":case"ac-3":b.audioCodec=i,b.audioCodecList.push(b.audioCodec);break;case"stpp":case"wvtt":break;default:b.audioCodec=i,b.audioCodecList.push(b.audioCodec)}}1<b.audioCodecList.length&&(b.audioCodec=Pf.getRichestAudioCodec(b.audioCodecList)),1<b.videoCodecList.length&&(b.videoCodec=Pf.getRichestVideoCodec(b.videoCodecList))}if(null!=(c=Lf(b.pathwayID)))break;Object.prototype.hasOwnProperty.call(o,b.pathwayID)||(o[b.pathwayID]=h++),n.push(b)}null!=(null==p?void 0:p.initPathwayID)&&(o[p.initPathwayID]=-1,p.initPathwayPriority=Object.keys(o).sort((e,t)=>o[e]-o[t]));const T={variantMediaOptions:n,contentSteeringOption:p,masterVariableList:a,variantIdToAlternateGroupIdTuple:s,playlistParsingError:c,scoreAvailable:m};return fe(f)&&(T.startTimeOffset=f),T}static parseAllowedCPC(e){if("string"==typeof e){const r={};return e.split(",").forEach(e=>{e=e.split(":");let t,i;if(2===e.length)t=e[0].trim(),i=e[1].trim();else{if(!(2<e.length))return;i=e[e.length-1].trim(),e.pop(),t=e.join(":")}if(!(t in r)){let e=new Array;""!==i&&(e=X(i).split("/").map(e=>e.trim())),r[X(t)]=e}}),r}}static parseSessionKeys(e,t,i,r){var n,a=[];for(Vf.SessionData.lastIndex=0;n=Vf.SessionKeys.exec(e);)try{const e=Qf.parseDecryptData(r,n[1],t,i);e&&e.isEncrypted&&a.push(e)}catch(e){}return a}static parseSessionData(t,i,r,n){let a;var s=[],o=new Set;for(Vf.SessionData.lastIndex=0;null!=(a=Vf.SessionData.exec(t));){const t=_f.parseTags(a[1]);let e=t.getString("LANGUAGE");const r=t.getString("DATA-ID");if(null!=r){const n=(e=Kp.shortenLanguageCode(e))?r+"|"+e:void 0;if(!n||!o.has(n)){const a={"DATA-ID":r,LANGUAGE:e};for(const i of t.keys){const n=t.getString(i);"VALUE"===i&&n&&"com.apple.hls.other-tags"===r&&(a[i]=function(t){let i;try{i=JSON.parse(Zo.base64DecodeToStr(t))}catch(e){i=t}return i}(n)),i in a||(a[i]=n)}s.push(a),n&&o.add(n)}}else n.error(`Error processing DATA-ID ${r} and LANGUAGE `+e)}return{itemList:s,baseUrl:i,appItemId:r}}static validateAndUpdateDateRangeTag(e,t,i){let r=!0;var n=Object.assign({},e);for(const e in t)if("ID"!==e){var a=t[e];if(Object.prototype.hasOwnProperty.call(n,e)){if(n[e]!==a){i.error(`Date Range Tag for attribute: "${e}" does not match for ID: "${t.ID}". This violates HLS spec`),r=!1;break}}else n[e]=a}return r?n:e}}var Hf,qf,Kf,jf,$f,Gf,Wf=Qf;function zf(e){var{tloadMillis:e,age:t,partTargetDuration:i=NaN,targetduration:r}=e;return!(!fe(e)||!fe(t))&&(1e3*i<(i=performance.now()-e+1e3*t)||1e3*r<i)}const Yf=(e,t,o,i,r,l,n,a,d,u,c,s,h,p,m)=>{const{itemId:f,mediaOptionId:g,mediaOptionType:y,relativeUrl:v}=e;if(!v)return Fr(()=>new zs("Missing URL in loadMediaOptionDetails",400));const I=!!wa(e)&&e.iframes,S=no(e,n);let b=null!=(n=e.url)?n:qa(v,t);p&&p.liveOrEvent&&null!=(e=p.serverControls)&&e.canBlockReload?b=function(e,t,i){var r,n,a=new URL(e);if(i.liveAllowLowLatencyPlayback){const{nextMSN:e,nextPart:i}=function(e){var t,i,r,n=zf(e),{endSN:a,partEndSN:s=NaN,partEndIndex:o=NaN}=e,l=fe(null==e?void 0:e.partEndIndex);return n?({tloadMillis:n,age:e,partTargetDuration:i=NaN,targetduration:t}=e,n=performance.now()-n+1e3*e,l?(0,e=Math.round(t/i),i=Math.round(n/(1e3*i)),r=o+1,{nextMSN:s+Math.floor((i+r)/e),nextPart:(i+r)%e}):{nextMSN:a+Math.floor(n/(1e3*t))+1,nextPart:NaN}):l?s===a?{nextMSN:s+1,nextPart:0}:{nextMSN:s,nextPart:o+1}:{nextMSN:a+1,nextPart:NaN}}(t);if(fe(e)&&(a.searchParams.set("_HLS_msn",e.toString()),fe(i))&&a.searchParams.set("_HLS_part",i.toString()),fe(null==(r=null==t?void 0:t.serverControls)?void 0:r.canSkipUntil)&&fe(t.tloadMillis)&&t.fragments.length){const e=performance.now()-t.tloadMillis,i=t.fragments[t.fragments.length-1],r=i.start+i.duration,s=r+e/1e3-(null!=(n=null==(n=null==t?void 0:t.serverControls)?void 0:n.canSkipUntil)?n:0)<r;s&&!1===(null==(n=t.serverControls)?void 0:n.canSkipDateRanges)&&a.searchParams.set("_HLS_skip","YES"),s&&null!=(n=t.serverControls)&&n.canSkipDateRanges&&a.searchParams.set("_HLS_skip","V2")}}else a.searchParams.set("_HLS_msn",(t.endSN+1).toString());return a.href}(b,p,r):null!=m&&m.renditionReports&&(b=function(t,e,i){var r,n,a=null==(r=e.renditionReports)?void 0:r.find(e=>Va.buildAbsoluteURL(t,e.relUri,{alwaysNormalize:!0})===t);if(a){const s=new URL(t),r=i&&null!=(n=e.partEndSN)?n:e.endSN,o=null!=(n=a.lastMSN)?n:r,l=o===e.partEndSN?e.partEndIndex:0,d=null!=(n=a.lastPart)?n:l;return s.searchParams.set("_HLS_msn",o.toString()),i&&fe(d)&&s.searchParams.set("_HLS_part",d.toString()),s.href}return t}(b,m,r.liveAllowLowLatencyPlayback));const{interstitialId:T,interstitialAssetId:A}=jd(f),E=null!=T&&0<T.length&&null!=A&&0<A.length?{interstitialId:T,interstitialAssetId:A}:void 0;return Lo({url:b,xhrSetup:r.xhrSetup,appItemId:i},S,s,a).pipe(pr(Rn),ve(({responseText:e,stats:t})=>{var i=performance.now(),e=Qf.parseMediaOptionPlaylist(e,b,u,null!=c?c:{},f,g,y,E,h,d,o,I,p);let r=[];y===we.Variant&&(r=Jh(e.mediaOptionDetails,l)),lo(e.mediaOptionDetails);var n=performance.now(),a=e["mediaOptionDetails"],s=(a.tloadMillis=t.tload,fe(t.age)&&(a.age=t.age),null!=(s=a.serverControls)&&s.canBlockReload?t.tfirst:t.trequest),s={playlistLoadTimeMs:t.tload-s,playlistParseTimeMs:n-i,tparsed:{tbegin:i,tend:n}};return{mediaOptionDetails:a,isDeltaPlaylist:e.isDeltaPlaylist,interstitials:r,bwSample:t,playlistSample:s}}),so(y,g,!1,b))},Xf=(m,e,f,t,g)=>be(e).pipe(Ae(e=>{const{keyTagInfo:t,isInitSegment:i,iframe:r,byteRangeOffset:n}=m,a=null==t?void 0:t.method,{start:s,end:o}=null!=n?n:{};if("AES-128"!==a)return be(e);{null==t||!t.uri||t.iv||t.format&&"identity"!==t.format||(t.iv=function(t){var i=new Uint8Array(16);for(let e=12;e<16;e++)i[e]=t>>8*(15-e)&255;return i}(m.mediaSeqNum));const n=e.buffer,a=null==(e=null==t?void 0:t.key)?void 0:e.buffer,l=null==(e=null==t?void 0:t.iv)?void 0:e.buffer,d=fe(s)&&fe(o)&&(r||i)?o-s:0,u=!f.enableWebCrypto||!!d,c=null!=(e=null==a?void 0:a.slice(0))?e:new ArrayBuffer(0),h=null!=(e=null==l?void 0:l.slice(0))?e:new ArrayBuffer(0),p={useJSCrypto:u,plainTextLength:d};return g.decrypt(c,h,"AES-CBC",n,p)}}));function Jf(e,t,i){return e.findIndex(e=>e.mediaSeqNum===t&&e.partIndex===i)}function Zf(e){const{itemId:t,mediaOptionId:i,mediaOptionType:r,relativeUrl:n,byteRangeOffset:a}=e;let s=t+i+r.toString()+n;if(fe(null==a?void 0:a.start)){const{start:e,end:t}=a;s=s+e.toString()+t.toString()}return s}function eg(e){var{relativeUrl:e,byteRangeOffset:t}=e;z(e);fe(null==t?void 0:t.start)&&(t.start,t.end)}function tg(e,t){if(t.part){const i=e.parts;return lh(t,i[Jf(i,t.mediaSeqNum,t.partIndex)])}const i=e.fragments,r=t.mediaSeqNum-e.startSN;return 0<=r&&r<e.fragments.length&&lh(t,i[r])}function ig(i,e,r,t,n=!1,a=!1){var{startPts:s,endPts:e}=e,o=i[r];o.startPts=s,o.endPts=e,o.start=t,o.duration=_(e,s);for(let e=r,t=!0;0<e&&(a||t);e--)t=ng(i,e,e-1,s.timescale,n);for(let e=r,t=!0;e<i.length-1&&(a||t);e++)t=ng(i,e,e+1,s.timescale,n)}function rg(t,i,r,n=!1,a=!1,e=!1){if(tg(t,i)){if(i.part){let e=t.parts;var s=Jf(e,i.mediaSeqNum,i.partIndex),o=e[s];n&&((e=t.parts=t.parts.slice())[s]=Object.assign({},o)),ig(e,i,s,r,n,a)}else{let e=t.fragments;o=i.mediaSeqNum-t.startSN,s=Oc(e,i.mediaSeqNum);n&&((e=t.fragments=t.fragments.slice())[o]=Object.assign({},s)),ig(e,i,o,r,n,a)}t.totalduration=Em(t,e),t.ptsKnown=!0}}function ng(e,t,i,r,n=!1){var a=e[t];let s=e[i],o=void s.start;o=t<i?a.start+a.duration:Math.max(a.start-s.duration,0);t=fe(r)?1/r:Number.EPSILON;return!!(Math.abs(s.start-o)>t)&&((s=n?e[i]=Object.assign({},s):s).start=o,!0)}function ag(t,i,e,r,n){return e=>e.pipe(ye(e=>{if(t.logger.error(`Got demux error `+e.message),e instanceof O||e instanceof D)return U.SendAlternateToPenaltyBox,am(e,0,{errorAction:e.fatal?U.SendEndCallback:e instanceof D?U.SendAlternateToPenaltyBox:U.RemoveAlternatePermanently,errorActionFlags:0},i,t,r,n);throw e}))}function sg(i,r,p,m,f,g,y,v){return m=Math.max(0,m),e=>{let t=e.pipe(Yr({delay:(n,a)=>{{var s=n,o=a-1,l=(a=ao(n,p),n=f,m),d=g,u=y,c=v,h;if(!(s instanceof Ys))throw s;let e,t,i,r=!1;if(s instanceof Js||s instanceof eo||s instanceof io){({mediaOptionType:t,mediaOptionId:e,isTimeout:r}=s);const o=null==(h=d.mediaOptionListQueries[t])?void 0:h.mediaOptionFromId(e);if(!n&&s.isTimeout&&null!=o&&(!("iframes"in o)||!0!==o.iframes)&&(u.updateConsecutiveTimeouts(d.itemId,s.mediaOptionType,!0,"load"),s instanceof eo)&&s.stats){const o=performance.now();c.updateBandwidthEstimate(Object.assign(Object.assign({},s.stats),{tfirst:s.stats.tfirst||o,tload:s.stats.tload||o,complete:!0,mediaOptionType:t}))}i=em(s,n,l,d,u,"load")}else i=Zp(s);return nm(s,o,a,i,d,u,t,e,r)}}}));return t=null!=r?t.pipe(Ee(()=>{y.updateConsecutiveTimeouts(i,r,!1,"load")})):t}}function og(r,n,a,s,e=!1){var t=r.mediaOptionId===n.mediaOptionId;if(s=s.child({name:"live"}),"VOD"!==r.type&&r.iframesOnly===n.iframesOnly&&(!a||t)){let i=fe(null==(s=n.parts)?void 0:s.length);e||i&&(n.parts=[],n.partStartSN=n.partEndSN=n.partEndIndex=NaN,n.partTargetDuration=NaN,i=!1);var s=r.fragments,o=n.fragments,l=null!=(l=r.parts)?l:[],d=null!=(d=n.parts)?d:[],u=fe(null==o?void 0:o.length)&&0<o.length;if(t){let e,t;if(u&&(e=dg(s,o)),i&&(t=dg(l,d)),e||t){if(t&&(rg(n,t,t.start,!1,!0),!e)&&u&&0===t.partIndex&&(e=Oc(o,t.mediaSeqNum,NaN))&&(ug(e,t),rg(n,e,e.start,!1,!0)),e&&(rg(n,e,e.start,!1,!0),!t)&&i){const r=Jf(d,e.mediaSeqNum,0);0<=r&&(ug(t=d[r],e),rg(n,t,t.start,!1,!0))}}else lg(r,n);if(a){var c=r;var h=n;var p,m,f,g,s=c.fragments,l=h.fragments,u=null!=(g=c.parts)?g:[],y=null!=(y=h.parts)?y:[],o=h.startSN-c.startSN;if(0<=o){const v=null==(d=s[o])?void 0:d.discoSeqNum;if(fe(v)){for(const[g,y]of Object.entries(c.initSegments)){const c=Number(g);c>=v&&!h.initSegments[c]&&(h.initSegments[c]=y)}for(const[g,y]of Object.entries(c.discoToMSNMap)){const c=Number(g);if(c>=v){const v=Math.max(h.startSN,Math.min(null!=(p=null==(p=h.discoToMSNMap[c])?void 0:p[0])?p:1/0,y[0])),g=null!=(p=null==(p=h.discoToMSNMap[c])?void 0:p[1])?p:y[1];h.discoToMSNMap[c]=[v,g]}}}const g=s.slice(o);if(g.length){const c=g[g.length-1].keyTagInfo;if(c)for(const h of l){if((null==(m=h.keyTagInfo)?void 0:m.uri)!==c.uri||(null==(m=h.keyTagInfo)?void 0:m.iv)!==c.iv)break;h.keyTagInfo=c}}h.fragments=g.concat(l)}if(0<y.length){const v=Jf(null!=(g=c.parts)?g:[],h.partStartSN,0);if(0<=v){const c=1<u.length?u.slice(v):u,g=c[c.length-1].keyTagInfo;if(g)for(const c of y){if((null==(f=c.keyTagInfo)?void 0:f.uri)!==g.uri||(null==(f=c.keyTagInfo)?void 0:f.iv)!==g.iv)break;c.keyTagInfo=g}h.parts=c.concat(y)}}h.fragments.length?h.averagetargetduration=(Am(h,!1)-Tm(h,!1))/h.fragments.length:h.averagetargetduration=h.targetduration,(0<h.pdtToMSN.length||0<c.pdtToMSN.length)&&(h.pdtToMSN=function(i,r){var n=i.fragments;let e=i.pdtToMSN;if(r.startSN>i.startSN){const l=r.fragments[0],t=r.startSN,a=i.pdtToMSN.findIndex(([,e])=>{if(e>=t)return!0});if(!(e=-1!==a?i.pdtToMSN.slice(a):[]).length||e[0][1]!==t){let t=l.programDateTime;if(!fe(t)){let e=0;i.pdtToMSN.length&&(e=i.pdtToMSN[0][0]),t=e+1e3*(l.start-n[0].start)}e.unshift([t,r.startSN])}}const t=Rm(i,i.endSN),a=null==t?void 0:t.discoSeqNum,s=r.pdtToMSN,o=s.findIndex(([,e])=>{e=Rm(r,e),e=null==e?void 0:e.discoSeqNum;if(fe(e)&&fe(a)&&e>a)return!0});return e=-1!==o?e.concat(s.slice(o)):e.concat(s)}(c,h))}}else lg(r,n);a=Tm(n,e),d=Am(n,e);n.ptsKnown=n.ptsKnown||t&&!0===r.ptsKnown&&r.endSN>=n.startSN,n.totalduration=d-a}}function lg(e,t){var i;let r=!1;if(!(r=(r=function(e,t){const[i,r]=wm(e),[n,a]=wm(t);if(e.ptsKnown&&i<r&&n<a&&i<=n&&n<r){const s=n===i?n+1:n,r=Pm(e,s),a=Pm(t,s);return hg(t,r.start-a.start),!0}return!1}(e,t))||function(t,i){if(!(t.pdtToMSN.length<=0||i.pdtToMSN.length<=0)){const r=wm(t),n=wm(i),a=Math.max(r[0],n[0]),s=Math.min(r[1],n[1]);for(let e=a;e<=s;e++){const r=Om(t,e),n=Om(i,e);if(null!=r&&null!=n){const[o,a]=r,[s,l]=n,d=Oc(t.fragments,a).start;return hg(i,(s-o)/1e3-(Oc(i.fragments,l).start-d)),!0}}}return!1}(e,t))){const n=e.fragments,a=t.fragments,s=null!=(i=e.parts)?i:[],o=null!=(i=t.parts)?i:[];a.length&&cg(n,a,e),0<o.length&&cg(s,o,e),r=!0}r}function dg(t,i){let r;for(let e=0;e<(null==i?void 0:i.length);e++){var n=i[e],a=Oc(t,n.mediaSeqNum,n.partIndex);n&&null!=(null==a?void 0:a.startPts)&&(n.start=a.start,n.duration=a.duration,n.startPts=a.startPts,n.endPts=a.endPts,r=n)}return r}function ug(e,t){e.start=t.start,e.startPts=t.startPts,b(t.startPts)&&(e.endPts=u(t.startPts,e.duration))}function cg(e,t,i){var r,n,a,s,o=t[0],l=Math.max(0,o.start);let d=0;const u=Oc(e,o.mediaSeqNum,o.partIndex);if(u)d=u.start-l;else if(o.part){const t=e[e.length-1];if(t){const e=t.mediaSeqNum,c=t.partIndex,u=null!=(r=o.partIndex)?r:0;if(e===o.mediaSeqNum&&c===u-1||e===o.mediaSeqNum-1&&0===o.partIndex)d=t.start+t.duration-l;else{const e=null!=(a=i.partTargetDuration)?a:1;if(null!=(n=i.fragments)&&n.length){const t=Am(i,!1),c=o.mediaSeqNum-i.endSN-1,r=null!=(a=o.partIndex)?a:0;d=t+c*i.averagetargetduration+r*e-l}else{const t=Am(i,!0),c=null!=(s=i.partEndSN)?s:0,r=null!=(s=i.partEndIndex)?s:0,a=null!=(s=o.partIndex)?s:0,n=Math.ceil(i.targetduration/e);d=t+((o.mediaSeqNum-c-1)*n+n-r-1+a)*e-l}}}}else d=Am(i)+(o.mediaSeqNum-i.endSN-1)*i.averagetargetduration-l;pg(t,d)}function hg(e,t){var{fragments:e,parts:i}=e;pg(e,t),i&&pg(i,t)}function pg(t,i){if(!(0===t.length||t[0].start+i<0))for(let e=0;e<t.length;++e)t[e].start+=i}class mg extends ga{constructor(e,t){super(e);var{itemId:e,mediaOptionId:t}=this.mediaOption=t;this.mediaOption={itemId:e,mediaOptionId:t}}get itemId(){var e;return null==(e=this.mediaOption)?void 0:e.itemId}get mediaOptionId(){return this.mediaOption.mediaOptionId}get initSegmentEntities(){var e;return null==(e=this.mediaOptionDetailsEntity)?void 0:e.initSegmentCacheEntities}get mediaLibraryEntity(){return this.getEntity(this.itemId)}get mediaOptionDetailsEntityRecord(){var e;return null==(e=this.mediaLibraryEntity)?void 0:e.mediaOptionDetailsEntityRecord}lastUpdatedDetailsEntityByType(t){var i,r=this.mediaOptionDetailsEntityRecord;if(r){let e;for(const a of Object.keys(r)){var n=r[a];(t===(null==(i=n.mediaOptionDetails)?void 0:i.mediaOptionType)&&n&&!e||n&&e&&(null==n?void 0:n.lastUpdateMillis)<(null==e?void 0:e.lastUpdateMillis))&&(e=n)}return e}}static mediaOptionIdToKey(e,t){if(t&&t!==Fs.mediaOptionId)return{itemId:e,mediaOptionId:t}}lastLoadedMediaOptionByType(e){var t;return mg.mediaOptionIdToKey(this.itemId,null==(t=this.mediaLibraryEntity)?void 0:t.lastLoadedMediaOptionIds[e])}lastLoadedMediaOptionByType$(t){return this.selectEntity(this.itemId,e=>null==e?void 0:e.lastLoadedMediaOptionIds[t]).pipe(ve(e=>mg.mediaOptionIdToKey(this.itemId,e)))}lastLoadedMediaOptionDetails(e){var t=null==(t=this.mediaLibraryEntity)?void 0:t.lastLoadedMediaOptionIds[e];return t&&(null==(e=null==(e=this.mediaLibraryEntity)?void 0:e.mediaOptionDetailsEntityRecord[t])?void 0:e.mediaOptionDetails)}get mediaOptionDetailsEntity(){return this.mediaOptionDetailsEntityRecord?this.mediaOptionDetailsEntityRecord[this.mediaOptionId]:null}get mediaOptionDetails(){var e;return null==(e=this.mediaOptionDetailsEntity)?void 0:e.mediaOptionDetails}get playlistDuration(){var e;return null==(e=this.mediaOptionDetailsEntity)?void 0:e.playlistDuration}get mediaOptionDetailsEntity$(){const{itemId:e,mediaOptionId:t}=this;return this.selectEntity(e,e=>null==e||!e.mediaOptionDetailsEntityRecord||null==e?void 0:e.mediaOptionDetailsEntityRecord[t])}get mediaOptionDetails$(){return this.selectEntity(this.itemId,e=>{return null==(e=null==e?void 0:e.mediaOptionDetailsEntityRecord[this.mediaOptionId])?void 0:e.mediaOptionDetails}).pipe(Yl())}get playlistDuration$(){return this.mediaOptionDetailsEntity$.pipe(ve(e=>null==e?void 0:e.playlistDuration),Yl(),Te())}get live$(){return this.mediaOptionDetails$.pipe(ve(e=>null==e?void 0:e.liveOrEvent),Te())}get liveEdgeGrows$(){return this.mediaOptionDetails$.pipe(ve(e=>e.endSN),Te((e,t)=>t<=e),tn(1),xr(!0))}get iframesOnly(){var e;return null!=(e=null==(e=this.mediaOptionDetails)?void 0:e.iframesOnly)&&e}}class fg extends ua{constructor(){super({},{name:"media-library-store",idKey:"itemId"})}}(i=Hf=Hf||{})[i.DISABLED=0]="DISABLED",i[i.ERRORED=1]="ERRORED",i[i.SUCCESS=2]="SUCCESS",i[i.IN_PROGRESS=3]="IN_PROGRESS",(r=qf=qf||{}).Manifest="Manifest",r.VariantPlaylist="VariantPlaylist",r.VariantSegment="VariantSegment",r.AltAudioPlaylist="AltAudioPlaylist",r.AltAudioSegment="AltAudioSegment";const gg=Object.values(qf);(a=Kf=Kf||{})[a.ONE_SHOT=0]="ONE_SHOT",a[a.HOLD=1]="HOLD";class yg{constructor(e,t,i=!1){this.id=e,this.factory=t,this.result$=new $r,i&&this.subscribe()}subscribe(){this.unsubscribe(),this.ec=this.factory().pipe(Dr(1)).subscribe(this.result$)}unsubscribe(){this.ec&&this.ec.unsubscribe()}}function vg(e){return Ig(e)}function Ig(e){var t;return null!=(t=e.appItemId)?t:e.itemId}function Sg(e){return e.mediaOptionId}function bg(e){return sh(e)}function Tg(e,t){var i=e[t];i&&i.unsubscribe(),delete e[t]}function Ag(e,t){var{trequest:t,tfirst:i,tload:r,loaded:n}=t;e.trequest=t,e.tfirst=i,e.tload=r,e.loaded=n}function Eg(e){return e.itemId+e.mediaOptionId}class Og{constructor(e,t){this.ic=e,this.nc=t,this.inFlightDetails=null,this.rc={},this.ac=[void 0,void 0],this.Iu=new Map,this.lc=null,this.inFlightFragStats=[],this.prefetchItems={},this.preloadHints={},this._i=new ga(e)}get query(){return this._i}getQueryForItem(e){return this.getQueryForOption({itemId:e,mediaOptionId:Fs.mediaOptionId})}getQueryForOption(e){var t=Eg(e);let i=this.Iu.get(t);return i||(i=new mg(this.ic,{itemId:e.itemId,mediaOptionId:e.mediaOptionId}),this.Iu.set(t,i)),i}createMediaLibraryEntity(e){this.ic.add({itemId:e,mediaOptionDetailsEntityRecord:{},lastLoadedMediaOptionIds:[void 0,void 0,void 0]})}uc(t,i,r){var n=t["mediaOptionId"],t=this.getQueryForOption(t);if(r||null!=(r=t.mediaOptionDetailsEntityRecord)&&r[n]){r=t.mediaOptionDetailsEntityRecord;let e=null==r?void 0:r[n];return e=e||{initSegmentCacheEntities:{},unchangedCount:0},{mediaOptionDetailsEntityRecord:Object.assign(Object.assign({},r),{[n]:Object.assign(Object.assign({},e),i)})}}}cc(e,t,i){t=this.uc(e,t,i);t&&this.ic.update(e.itemId,t)}setDetailsLoading(e,t=!0){this.cc(e,{detailsLoading:t},!0)}setLastAccessed(e){var t=Eg(e);this.lc!==t&&(this.lc=t,this.cc(e,{lastAccessedMillis:performance.now()},!1))}retrieveMediaOptionDetails(e,r,t=!1,i=!1){if(null==r||!Bs(r))return be(null);const{itemId:n,mediaOptionType:a}=r,s=this.getQueryForOption(r),{rootPlaylistQuery:o,logger:l,config:d,playerEvents:u}=(s.hasEntity(n)||this.createMediaLibraryEntity(n),e);if(d.enableItemPreloading){const e=a===we.Variant?qf.VariantPlaylist:qf.AltAudioPlaylist,t=vg(o),i=Sg(r),s=this.recallPrefetchCacheEntry(t,e,i,l);if(s)return s.pipe(ve(e=>{e.fragments.forEach(e=>{e.start+=o.itemStartPosition});var t={tfirst:0,tload:0,tdataack:0,total:1,trequest:0,loaded:1,complete:!0},t=(this.archiveMediaOptionDetails(e,t,!0),null!=u&&u.handleLevelLoaded(r,e,t),r.mediaOptionId),i=this.uc({itemId:n,mediaOptionId:t},{},!1),i=null==(i=null==i?void 0:i.mediaOptionDetailsEntityRecord)?void 0:i[t];return 0!==(null==i?void 0:i.unchangedCount)||null!=u&&u.handleLevelUpdated(e),e}))}var c=s.mediaOptionDetailsEntity,h=s.mediaOptionDetails;return null==h||i||"VOD"!==h.type&&(!h.liveOrEvent||Of(h,c.lastUpdateMillis,d.liveAllowLowLatencyPlayback))?(this.setDetailsLoading(r),this.hc(d.livePreloadHintCacheAge,r,l),this.dc(e,r,t)):(this.setLastAccessed(r),be(h).pipe().pipe(Dr(1)))}dc(e,t,i){const{logger:r,config:n,rootPlaylistQuery:a,rootPlaylistService:s,statsService:o,rtcService:l,interstitialService:d,customUrlLoader:u,playerEvents:c}=e,h=n.playlistLoadPolicy,p=n.keySystemPreference,m=a.masterVariableList,f=this.nc.query.extendMaxTTFB,g=this.getQueryForOption(t),y=null==g?void 0:g.mediaOptionDetails,v=null==g?void 0:g.lastUpdatedDetailsEntityByType(t.mediaOptionType),I=null==v?void 0:v.mediaOptionDetails,S=(null!=c&&c.handleLevelLoading(t),{trequest:NaN,tfirst:NaN,tload:NaN,tparse:NaN,tparsed:NaN,loaded:0});return Yf(t,a.baseUrl,a.itemStartPosition,a.appItemId,n,n,h,u,r,p,m,f,e.keyTracker,y,I).pipe(ve(e=>(Ag(S,e.bwSample),S.tparsed=performance.now(),S.tparse=S.tparsed-e.playlistSample.playlistParseTimeMs,null!=l&&l.report(9,e.playlistSample.tparsed),wg(t,0,this,d,o,c,n,r)(e))),sg(t.itemId,t.mediaOptionType,no(t,h),n.maxNumAddLevelToPenaltyBox,i,a,s,o))}archiveMediaOptionDetails(r,n,a,e=!1){const{itemId:s,mediaOptionId:o}=r,l=performance.now(),d=Am(r,e);Object.isFrozen(r)||Object.freeze(r),Oe(()=>{this._i.hasEntity(s)||this.createMediaLibraryEntity(s);var e,t=this._i.getEntity(s),i=this.uc(r,{detailsLoading:!1,lastUpdateMillis:l,lastAccessedMillis:l,stats:n},!0);i&&(i.lastLoadedMediaOptionIds=[...t.lastLoadedMediaOptionIds],i.lastLoadedMediaOptionIds[r.mediaOptionType]=o,e=(t=i.mediaOptionDetailsEntityRecord)[o],a?(e.mediaOptionDetails=r,e.playlistDuration=d,e.unchangedCount=0,i.liveOrEvent=r.liveOrEvent):++e.unchangedCount,function(t,i,r,n=2){var a=[],s=Object.values(t).filter(e=>{var t;return(null==(t=e.mediaOptionDetails)?void 0:t.mediaOptionType)===i&&(null==(t=e.mediaOptionDetails)?void 0:t.iframesOnly)===r&&null!=e.lastAccessedMillis}).sort((e,t)=>e.lastAccessedMillis-t.lastAccessedMillis);for(let e=0;e<s.length-n;++e){const r=s[e].mediaOptionDetails;a.push(r),delete t[r.mediaOptionId]}return a}(t,r.mediaOptionType,r.iframesOnly).forEach(e=>{e=Eg(e);this.Iu.delete(e)}),this.ic.update(s,i))})}archiveInitSegmentEntity(e,t){var i,r,n,a,s;(e||t)&&({itemId:i,mediaOptionId:r,discoSeqNum:n}=e||t,s=null==(s=null==(a=this.uc({itemId:i,mediaOptionId:r},{},!1))?void 0:a.mediaOptionDetailsEntityRecord)?void 0:s[r])&&(s.initSegmentCacheEntities=Object.assign(Object.assign({},s.initSegmentCacheEntities),{[n]:[e,t]}),this.ic.update(i,a))}retrieveInitSegmentCacheEntity(e,t,i){var{mediaOptionDetailsEntityRecord:r,mediaOptionDetails:n}=this.getQueryForOption(t),a=t["mediaOptionId"];if(null==r||!r[a])throw new me(!1,pe.NoSegmentDetailsEntity);if(!n)throw new me(!1,pe.NoSegmentDetails);r=r[a]["initSegmentCacheEntities"];if(r[i]){const[e,t]=r[i];return be(t||e)}return this.fetchInitSegmentCacheEntity(e,n,t,i)}fetchInitSegmentCacheEntity(r,e,n,t){if(!e)throw new me(!1,pe.NoSegmentDetails);const i=e["initSegments"],a=i[t];if(!Rg(a))return be(null);const s=sh(a);let o=this.rc[s];return(o=o||(this.rc[s]=new yg(s,()=>{const i={trequest:NaN,tfirst:NaN,tload:NaN,tparse:NaN,tparsed:NaN,loaded:0};return Pg(r,a,!1,!1).pipe(pr(Rn),Ae(({loadedData:e,bwSample:t})=>(Ag(i,t),i.tparse=performance.now(),this.parseInitSegment($(e),a,n,r))),Ee(()=>{i.tparsed=performance.now()}),Hr(()=>{delete this.rc[s]}))},!0))).result$}parseInitSegment(e,t,i,r){var{rootPlaylistService:n,rootPlaylistQuery:a,mediaParser:s}=r,{mediaOptionId:o,mediaOptionType:l}=t,e={segment:void 0,initSegment:e,frag:t,ptsKnown:void 0,seeking:void 0,live:void 0,totalDuration:void 0};return performance.now(),s.parseInitSegment(e).pipe(ve(e=>(performance.now(),this.archiveInitSegment(e,t,i,r))),ag(n,a,t.iframe,l,o))}archiveInitSegment(e,t,i,r){var{gaplessInstance:r,config:n}=r;if(!n.supportGaplessVideo){const t=e["track"];r.inGaplessMode&&ge.isVideoCodec(t.codec)&&!n.enableInterstitialPlayback&&r.dequeueSource("InvalidFormat")}n=Mg(e,t,i);return this.archiveInitSegmentEntity(n),n}cacheFrag(e,t){const i=sh(t),a=t["mediaOptionType"];if(e.logger.child({name:"media-lib-cache"}),a!==we.Subtitle&&!this.isCachingFrag(t)){var r,n;if(this.clearCacheFragRequest(t.mediaOptionType),!Rg(t))return r=new $r,n=a===we.Variant?{getData:!1,cb:(e,t,i,r)=>{var n=null==(n=this.ac[a])?void 0:n.onProgressCb;return!!n&&n(e,t,i,r)},samplePeriodMs:e.config.abrSamplePeriodMs}:void 0,this.ac[a]=new yg(i,this.fc.bind(this,e,!0,t,n),!0),r;this.retrieveInitSegmentCacheEntity(e,t,t.discoSeqNum)}}isCachingFrag(e){var t=e["mediaOptionType"];return t!==we.Subtitle&&(null==(t=this.ac[t])?void 0:t.id)===sh(e)}clearCacheFragRequest(e){e!==we.Subtitle&&this.ac[e]&&(this.ac[e].unsubscribe(),this.ac[e]=void 0)}vc(e,t){return e.sessionData.itemList.some(e=>"com.apple.hls.AudioSessionKeyInfo"===e["DATA-ID"]||"com.apple.hls.audioAssetMetadata"===e["DATA-ID"])}mc(t,e,i,r,n,a){var{mediaOptionId:s,mediaOptionType:o,duration:l}=e,n=n.partialAppendDurationSec;let d=!1,u=0;if(t&&this.vc(r,a)&&fe(n)&&0<n&&o===we.Variant&&!i.liveOrEvent&&0===e.start&&!fe(e.startPts)){const t=r.variantMediaOptionById(s);u=xe(t.avgBandwidth,t.bandwidth);let e=1;const i=r.enabledAlternateMediaOptionByType(we.AltAudio);i&&(e=Us(i)&&Bs(i)?2:1),d=1===e&&!t.videoCodec&&fe(u)&&0<u&&n<l}let c=e.byteRangeOffset.end;if(d){const t=e.byteRangeOffset.start+Math.floor(u/8*n);t>=c?d=!1:c=t}return d?{partial:!0,duration:n,end:c}:{partial:!1,duration:e.duration,end:c}}gc(e,t,i,r){const n=sh(i);if(!Rg(i)||this.rc[n])return null;{const e={start:i.byteRangeOffset.start,end:r.end},n=Object.assign(Object.assign({},t),{duration:r.duration,byteRangeOffset:e,dataOffset:t.byteRangeOffset.start-i.byteRangeOffset.start});return r.partial&&(n.partialFrag=!0),n}}yc(s,o){return e=>e.pipe(pr(Rn),Ae(e=>{var t,i,r,{mediaFragment:n,loadedData:a}=e;return fe(n.dataOffset)?(r=n.dataOffset,t=Object.assign(Object.assign({},o),{keyTagInfo:n.keyTagInfo}),i=G(a,r),a=G(a,0,r),r=Object.assign(Object.assign({},e),{loadedData:i}),Pn([this.parseInitSegment(a,t,t,s),be(r)])):Pn([this.retrieveInitSegmentCacheEntity(s,n,n.discoSeqNum),be(e)])}))}bc(r,n,a,t){var i;const{logger:s,rootPlaylistQuery:o,config:l}=r,d=a.mediaOptionType;if(d===we.Subtitle)throw new me(!1,pe.InvalidMediaOptionType);if(l.enableItemPreloading){const t=d===we.Variant?qf.VariantSegment:qf.AltAudioSegment,l=vg(o),pe=bg(a);let e=this.recallPrefetchCacheEntry(l,t,pe,s);if(e){const t=a["keyTagInfo"];if(null!=t&&t.uri){const n=r.keySystemAdapter.ksQuery;(!n.hasEntity(t.uri)||null!=(i=n.getKeyInfo(t.uri))&&i.error)&&(e=e.pipe(Ae(e=>Pn(e.map(e=>be(e).pipe(Lg(r,a,l,!1)))))))}return e.pipe(Ae(e=>{var[e,t]=e,i=n.initSegments[a.discoSeqNum];return e?Pn([this.parseInitSegment($(e.loadedData),i,a,r),be(t)]):be(t).pipe(this.yc(r,i))}))}}if(this.isCachingFrag(a))return this.ac[d].onProgressCb=null==t?void 0:t.cb,this.ac[d].result$.pipe(Hr(()=>{this.isCachingFrag(a)&&this.clearCacheFragRequest(d)}));this.ac[d]&&this.clearCacheFragRequest(d)}recallPrefetchCacheEntry(e,t,i,r){const n=this.prefetchItems[e],a=null==n?void 0:n.cache;if(a){var s=a[t];if(s){const a=`prefetch:`+e,o=r.child({name:a}),l=n["cacheOptions"];if(s.id===i)return s.result$.pipe(Hr(()=>{this.deletePrefetchCacheEntry(e,t,o)}));l.recallStrategy===Kf.ONE_SHOT&&this.deletePrefetchCacheEntry(e,t,o)}}}fc(e,t,i,r){var n,a;const{config:s,rootPlaylistQuery:o,logger:l}=e,d=i["mediaOptionType"],u=this.getQueryForOption(i),{mediaOptionId:c,discoSeqNum:h}=i,p=u.mediaOptionDetails;if(d===we.Subtitle)throw new me(!1,pe.InvalidMediaOptionType);var m=this.bc(e,p,i,r);if(m)return m;if((null==(a=null==(n=u.mediaOptionDetailsEntityRecord[c])?void 0:n.initSegmentCacheEntities)||!a[h])&&kg(p,i)){const n=p.initSegments[i.discoSeqNum],a=this.mc(t,i,u.mediaOptionDetails,o,s,l),pe=this.gc(e,i,n,a);if(pe)return Pg(e,pe,null==e.rtcService.serverInfoInstance,t,r).pipe(this.yc(e,n))}if(i.part){eg(i);const t=Zf(i),n=this.preloadHints[t];if(n){const a=n.cache,s=a.result$,o=(a.onProgressCb=null==r?void 0:r.cb,s.pipe(ve(e=>{var t=e["bwSample"];return e.mediaFragment=i,e.bwSample=Object.assign(Object.assign({},t),{trequest:t.tfirst}),e}),ye(()=>Se),Hr(()=>{delete this.preloadHints[t]})));return Pn([this.retrieveInitSegmentCacheEntity(e,i,i.discoSeqNum),o])}}return Pn([this.retrieveInitSegmentCacheEntity(e,i,i.discoSeqNum),Pg(e,i,null==e.rtcService.serverInfoInstance,t,r)])}retrieveMediaFragmentCacheEntity(B,U,e,t){if(U===we.Subtitle)throw new me(!0,pe.InvalidMediaOptionType);const _=B["rootPlaylistQuery"],{timelineOffset:V,mediaFragment:i}=e.foundFrag,Q=i["discoSeqNum"],r=this.fc(B,!1,i,t).pipe(Ae(([F,{mediaFragment:t,loadedData:i,bwSample:r,serverInfo:e}])=>{if(this.inFlightFragStats[U]&&Ag(this.inFlightFragStats[U],r),B.statsService.updateBandwidthEstimate(Object.assign(Object.assign({},r),{mediaOptionType:t.mediaOptionType})),e)if(null==B.rtcService.serverInfoInstance)B.rtcService.serverInfoInstance=e;else for(const U of Object.keys(e))B.rtcService.serverInfoInstance[U]=e[U];var n=B.statsService.getQueryForId(_.statsId);B.playerEvents.triggerFragLoaded(t,r,n.bandwidthStatus,n.getBandwidthEstimate()),Ug(B,U,t,"parsing",null);{var a=$(i),s=null==(r=_.getInitPTS(Q))?void 0:r.offsetTimestamp,v=(n=F,t),I=V;const{legibleSystemAdapter:o,rootPlaylistService:l,mediaSink:d,mediaParser:S,rootPlaylistQuery:u,mediaLibraryService:b}=i=B,c=d["mediaQuery"],T=b.getQueryForOption(v),{mediaOption:h,mediaOptionDetails:p,mediaOptionDetailsEntityRecord:m}=T,f=p["initSegments"],{itemId:A,mediaOptionId:E}=h,g=m[E]["initSegmentCacheEntities"],{discoSeqNum:O,mediaSeqNum:w,mediaOptionType:R,isLastFragment:M,part:P,partIndex:C}=v,y=c.seeking,k=p.liveOrEvent,L=f[O],D=g[O],x=R===we.Variant&&p.ptsKnown,N={segment:a,frag:v,seeking:y,live:k,ptsKnown:x,totalDuration:p.totalduration,defaultInitPTS:s,iframeMediaStart:oh(v)?v.iframeMediaStart:void 0,iframeDuration:oh(v)?v.iframeMediaDuration:void 0,iframeOriginalStart:oh(v)?v.iframeOriginalStart:void 0};let e;if(null!=n&&(null==(s=v.keyTagInfo)?void 0:s.uri)===(null==(s=n.keyTagInfo)?void 0:s.uri)&&(null==(s=v.keyTagInfo)?void 0:s.iv)===(null==(s=n.keyTagInfo)?void 0:s.iv)){if(e=be(n),D){const a=D[0];if(a){const s=a["data"];N.initSegment=s}}}else if(null!=n&&Rg(n.fragment)){const s=Object.assign(Object.assign({},n.fragment),{keyTagInfo:v.keyTagInfo}),I=L?G(n.data):a;e=b.parseInitSegment(I,s,h,i),N.initSegment=I}else Rg(v)?(e=b.parseInitSegment(a,v,h,i),N.initSegment=a):e=be(null);return e.pipe(Ae(g=>{const y=performance.now();return R!==we.Variant||null!=o&&o.setupForFrag(v),S.parseSegment(N,"").pipe(ve(e=>{var t;const i=performance.now(),{startPTS:r,startDTS:n,endPTS:a,endDTS:s,firstKeyframePts:o,framesWithoutIDR:l,largestVideoSampleSize:d,dropped:u,data1:c,data2:h,captionData:p,id3Samples:m,parsedInitSegment:f}=e;if(f){const{track:y,moovData:e,mimeType:I}=f,t=y["initSegment"],i=(g=null===g?Mg(f,v,T):{itemId:A,mediaOptionId:E,discoSeqNum:O,initParsedData:e,data:t,mimeType:I,keyTagInfo:v.keyTagInfo,fragment:v},D?D[0]:null);b.archiveInitSegmentEntity(i,g)}e=v.keyTagInfo,e={itemId:A,mediaOptionId:E,mediaOptionType:R,mediaSeqNum:w,discoSeqNum:O,part:P,partIndex:C,startDtsTs:n,endDtsTs:s,timelineOffset:I,firstKeyframePts:o,framesWithoutIDR:l,largestVideoSampleSize:d,dropped:u,data1:c,data2:h,startPts:r,endPts:a,keyTagInfo:e,isLastFragment:M,iframe:null!=(t=v.iframe)&&t,duration:v.duration,iframeMediaDuration:oh(v)?v.iframeMediaDuration:void 0,iframeOriginalStart:oh(v)?v.iframeOriginalStart:void 0,captionData:p,id3Samples:m};return v.partialFrag&&(e.partialFrag=!0,S.reset()),{initSegmentCacheEntity:g,mediaFragmentCacheEntity:e,initSegmentParseStats:null==f?void 0:f.stats.tparsed,dataSegmentParseStats:{tbegin:y,tend:i}}}))}),ag(l,u,v.iframe,R,E))}}));return r}updatePTSDTS(e,t,i,r,n=!1){t=null==(e=this.getQueryForOption({itemId:e,mediaOptionId:t}))?void 0:e.mediaOptionDetails;if(t&&tg(t,r)&&!i.iframeMode&&!r.iframe){var{startDtsTs:e,mediaSeqNum:a,part:s,partIndex:o}=r,{variantDTS:i,timelineOffset:l}=i,i=_(e,i)+l,l=Object.assign({},t);if(rg(l,r,i,!0,!1,n),!s&&0<(null==(e=l.parts)?void 0:e.length)){const e=l["parts"],t=Jf(e,a,0);-1!==t&&rg(l,Object.assign(Object.assign({},e[t]),{startPts:r.startPts,endPts:u(r.startPts,e[t].duration),startDtsTs:r.startDtsTs}),i,!0,!1,n)}else if(s){const e=l["fragments"];if(0===o){const t=Oc(e,a);t&&rg(l,Object.assign(Object.assign({},t),{startPts:r.startPts,endPts:u(r.startPts,t.duration),startDtsTs:r.startDtsTs}),i,!0,!1,n)}}t=Am(l,n);this.cc(l,{mediaOptionDetails:l,playlistDuration:t},!1)}}remove(e){this.ic.remove(e)}clear(e,t=!0,i=!0){this.ac.forEach((e,t)=>this.clearCacheFragRequest(t)),t&&this.clearPrefetchCache(e),i&&this.Sc();for(const e of Object.values(this.rc))e.unsubscribe();this.rc={},this.ic.remove(),this.Iu.clear(),this.lc=null}clearPrefetchCache(i){Object.keys(this.prefetchItems).forEach(e=>{for(const t of gg)this.deletePrefetchCacheEntry(e,t,i)}),this.prefetchItems={}}createPrefetchItemCache(e,t,i,r=Kf.ONE_SHOT){r={cache:{},cacheOptions:{recallStrategy:r},status:Hf.IN_PROGRESS};this.prefetchItems[e]=r}wc(e){if(null!=e)return this.prefetchItems[e]}getSegmentRecord(e){return this.wc(e)}getPrefetchCache(e){return null==(e=this.getSegmentRecord(e))?void 0:e.cache}getPrefetchCacheEntry(e,t){e=this.getPrefetchCache(e);if(e)return e[t]}deletePrefetchCacheEntry(e,t,i){var r=this.getPrefetchCache(e);r&&(Tg(r,t),0===Object.keys(r).length)&&delete this.prefetchItems[e]}cachePrefetchRequest(e,r,n,t){const i=this.wc(e);if(i){const a=this.getPrefetchCache(e);return Mn(()=>{return e=a,i=n,Tg(e,t=r),(e[t]=i).subscribe(),n.result$;var e,t,i}).pipe(Ee(()=>{r===qf.VariantSegment&&(i.status=Hf.SUCCESS)}))}}prefetchFragmentAndInitSegment(e,t,i,r,n){var a;const s=e["statsService"],o=n["mediaOptionType"];if(o===we.Subtitle)throw new me(!1,pe.InvalidMediaOptionType);var l=null!=(u=r.url)?u:qa(r.relativeUrl,t),d=null==e.rtcService.serverInfoInstance;if(kg(r,n)){const t=r.initSegments[n.discoSeqNum],u={start:t.byteRangeOffset.start,end:null==(a=n.byteRangeOffset)?void 0:a.end,duration:n.duration,partial:!1},pe=this.gc(e,n,t,u);if(pe)return Cg(e,l,pe,d).pipe(Lg(e,pe,i,!0)).pipe(ve(e=>[null,e]),Ee(([,e])=>{s.updateBandwidthEstimate(Object.assign(Object.assign({},e.bwSample),{mediaOptionType:o}))}))}var u=r.initSegments[n.discoSeqNum];return Pn([u?Cg(e,l,u,d).pipe(Lg(e,u,i,!0)):be(null),Cg(e,l,n,d).pipe(Lg(e,n,i,!0),Ee(e=>{s.updateBandwidthEstimate(Object.assign(Object.assign({},e.bwSample),{mediaOptionType:o}))}))])}setPrefetchErrored(e,t,i){var r=this.wc(e);if(r){r.status=Hf.ERRORED;const e=r["cache"];Tg(e,i)}}Sc(){for(const e of Object.values(this.preloadHints))e.cache.unsubscribe(),e.cache=null;this.preloadHints={}}hc(e,t,i){for(const[i,r]of Object.entries(this.preloadHints))(performance.now()-r.tloadMillis>1e3*e||t.mediaOptionId!==r.fragment.mediaOptionId&&t.mediaOptionType===r.fragment.mediaOptionType)&&(r.cache.unsubscribe(),r.cache=null,delete this.preloadHints[i])}getPreloadHintRecord(e){return this.preloadHints[e]}getPreloadHintCache(e){return null==(e=this.getPreloadHintRecord(e))?void 0:e.cache}createPreloadHints(r,n){const a=r["rootPlaylistQuery"],s=a.baseUrl;for(const e of n.preloadHints){const a=function(e,t){var{itemId:e,mediaOptionId:i,mediaOptionType:r}=e,{resourceType:t,Uri:n,byteRangeStart:a,byteRangeLength:s}=t,i={itemId:e,mediaOptionId:i,mediaOptionType:r,relativeUrl:n,start:NaN,duration:NaN,mediaSeqNum:NaN,discoSeqNum:NaN,isLastFragment:!1,isInitSegment:"MAP"===t,byteRangeOffset:{start:NaN,end:NaN}};if(fe(a)){const e=a,t=fe(s)?e+s:Number.MAX_SAFE_INTEGER;i.byteRangeOffset={start:e,end:t}}return i}(n,e),o=Zf(a);if(!this.preloadHints[o]){eg(a);const e=()=>{var e,t,i=n["mediaOptionType"];return i===we.Subtitle?Se:(i=i===we.Variant?{getData:!1,cb:(e,t,i,r)=>{var n=null==(n=null==(n=this.preloadHints[o])?void 0:n.cache)?void 0:n.onProgressCb;return!!n&&n(e,t,i,r)},samplePeriodMs:r.config.abrSamplePeriodMs}:void 0,e=null!=(e=n.url)?e:qa(n.relativeUrl,s),t=null==r.rtcService.serverInfoInstance,function(e,t,i,r,n){const{config:a,customUrlLoader:s,rootPlaylistQuery:o}=e,l=a.preloadHintLoadPolicy;return new F(e=>{To(i,t,o.appItemId,a,l,s,0,n,r).pipe().subscribe(e)})}(r,e,a,t,i).pipe(oo(a,!1)))},t={tloadMillis:n.tloadMillis,fragment:a,cache:new yg(o,e,!0)};this.preloadHints[o]=t}}}}function wg(c,e,h,p,m,f,g,y){return e=>{const t=h.getQueryForOption(c),i=t.mediaOptionDetails,{mediaOptionDetails:r,interstitials:n,isDeltaPlaylist:a}=e,{bwSample:s,playlistSample:o}=e;let l=!0;if(r.liveOrEvent||null!=i&&i.liveOrEvent)if(r.endSN<(null==i?void 0:i.endSN)||r.partEndSN<(null==i?void 0:i.partEndSN)||r.partEndSN===(null==i?void 0:i.partEndSN)&&r.partEndIndex<(null==i?void 0:i.partEndIndex))l=!1;else{const c=r["mediaOptionType"],e=(!(l=wf(i,r))&&g.liveAllowLowLatencyPlayback&&(l=Rf(i,r)),""===r.type&&(r.type="LIVE"),i&&og(i,r,a,y,g.liveAllowLowLatencyPlayback),t.lastLoadedMediaOptionByType(c)),p=e?h.getQueryForOption(e).mediaOptionDetails:null;!r.ptsKnown&&p&&p.mediaOptionId!==(null==i?void 0:i.mediaOptionId)&&og(p,r,a,y,g.liveAllowLowLatencyPlayback)}else""===r.type&&(r.type="VOD");const d=p.interstitialQuery,u=d.getInterstitialAssetForId(r.itemId);if(null!=u){const c=d.getInterstitialForId(u.parentIdentifier),e=u.duration||0,h=Em(r,g.liveAllowLowLatencyPlayback),m=c.duration||0;Oe(()=>{p.updateInterstitialAsset(u.identifier,{duration:h}),p.updateInterstitial(c.identifier,{duration:Math.max(m-e,0)+h})})}Oe(()=>{r&&h.archiveMediaOptionDetails(r,s,l,g.liveAllowLowLatencyPlayback),n&&0<n.length&&p.addInterstitials(n),m.updatePlaylistEstimate(o)}),null!=f&&f.handleLevelLoaded(c,r,s);e=t.mediaOptionDetailsEntity;if(null!=e&&e.detailsLoading||0!==(null==e?void 0:e.unchangedCount)||null==f||f.handleLevelUpdated(r),!l&&t.mediaOptionDetailsEntity.unchangedCount>=g.liveMaxUnchangedPlaylistRefresh)throw new Js(!1,pe.LivePlaylistUpdateError,c.mediaOptionType,c.mediaOptionId,i.url);return r}}function Rg(e){return!0===(null==e?void 0:e.isInitSegment)}function Mg(e,t,i){var{itemId:i,mediaOptionId:r}=i,{keyTagInfo:n,discoSeqNum:a}=t,{track:e,moovData:s,mimeType:o}=e,e=e["initSegment"];return{itemId:i,mediaOptionId:r,discoSeqNum:a,initParsedData:s,data:e,mimeType:o,keyTagInfo:n,fragment:t}}function Pg(n,t,i,e,r){var a;const{rootPlaylistQuery:s,rootPlaylistService:o,config:l,statsService:d,customUrlLoader:u,hlsService:c}=n,{itemId:h,mediaOptionType:p,mediaOptionId:m}=t,f=t.part?l.partLoadPolicy:l.fragLoadPolicy,g=fe(t.mediaSeqNum),y=s.mediaOptionListQueries[p].mediaOptionFromId(m),v=null!=(a=y.url)?a:qa(y.relativeUrl,s.baseUrl),I=!e&&"mediaSink"in n,S=new F(e=>{if(To(t,v,s.appItemId,l,f,u,0,r,i,c.query.extendMaxTTFB).pipe(sg(h,p,no(t,f),l.maxNumAddLevelToPenaltyBox,!1,s,o,d),Dr(1),Ee(({mediaFragment:e})=>{g&&I&&Ug(n,e.mediaOptionType,e,"loaded",null)})).subscribe(e),g&&I&&(Ug(n,p,t,"loading",null),t.mediaOptionType!==we.Subtitle)){const{start:i,duration:e}=t;n.mediaSink.updateInFlightRange(t.mediaOptionType,{start:i,end:i+e})}});if("AES-128"!==(null==(a=t.keyTagInfo)?void 0:a.method))return S;{const{itemId:i,mediaOptionId:e,mediaOptionType:r}=t;return Pn([xg(n,t.keyTagInfo,{itemId:i,mediaOptionId:e,mediaOptionType:r,appItemId:s.appItemId}),S]).pipe(Ae(([e,t])=>{var{mediaFragment:i,loadedData:r}=t;return i.keyTagInfo.key=e.key,Xf(i,r,l,n.logger,n.rpcClients.crypto).pipe(ve(e=>Object.assign(Object.assign({},t),{loadedData:$(e)})))}))}}function Cg(e,t,i,r,n){const{config:a,customUrlLoader:s,hlsService:o,rootPlaylistQuery:l}=e,d=i.part?a.partLoadPolicy:a.fragLoadPolicy;return new F(e=>{To(i,t,l.appItemId,a,d,s,0,n,r,o.query.extendMaxTTFB).pipe().subscribe(e)})}function kg(e,t){var i;return e&&null!=(e=e.initSegments[t.discoSeqNum])&&null!=e.byteRangeOffset&&e.byteRangeOffset.end===(null==(i=t.byteRangeOffset)?void 0:i.start)&&e.url===t.url}function Lg(o,l,d,u=!1){return e=>{const{config:t,keySystemAdapter:i}=o,r=i.ksQuery,n=l.keyTagInfo;if(n&&n.uri&&("AES-128"===n.method||u&&0<t.keyPrefetchMinHoldTimeBeforeCleanup&&!r.hasEntity(n.uri)&&r.getCount()<6)){const{itemId:i,mediaOptionId:r,mediaOptionType:a}=l,s=u?t.keyPrefetchMinHoldTimeBeforeCleanup:t.keyMinHoldTimeBeforeCleanup;return Pn([xg(o,n,{itemId:i,appItemId:d,mediaOptionId:r,mediaOptionType:a},s),e]).pipe(Ae(([e,t])=>{var{mediaFragment:i,loadedData:r}=t;return i.keyTagInfo.key=e.key,Xf(i,r,o.config,o.logger,o.rpcClients.crypto).pipe(ve(e=>Object.assign(Object.assign({},t),{loadedData:$(e)})))}))}return e}}const Dg=(e,t,i)=>{const r=e["mediaLibraryService"],n={trequest:NaN,tfirst:NaN,tload:NaN,tparse:NaN,tparsed:NaN,loaded:0},a=Pg(e,i,!1,!1).pipe(ve(e=>(Ag(n,e.bwSample),{initPTS:t,data:e,mediaFragment:i})));return r.retrieveInitSegmentCacheEntity(e,i,i.discoSeqNum).pipe(Ae(e=>Pn([be(e),a])))};function xg(e,t,i,r){var{keySystemAdapter:e,config:n}=e,{keyLoadPolicy:a,certLoadPolicy:s}=n,r=xe(r,n.keyMinHoldTimeBeforeCleanup);return e.getKeyFromDecryptData(t,i,{keyLoadPolicy:a,certLoadPolicy:s},r)}function Ng(t){return e=>e.pipe(ve(e=>Us(e)&&Bs(e)?t.getQueryForOption(e):null))}function Fg(i,r=NaN){return e=>{let t=e.pipe(Ng(i),Ae(e=>e?e.mediaOptionDetails$:be(null)));return t=fe(r)&&0<=r?t.pipe(Dr(r)):t}}function Bg(e,t){return br([e.enabledMediaOptionByType$(we.Variant).pipe(Fg(t)),e.hasAlternateWithUrl(we.AltAudio)?e.enabledMediaOptionByType$(we.AltAudio).pipe(Fg(t)):sl])}function Ug(e,t,i,r,n,a=!0){var{rootPlaylistQuery:s,logger:o,mediaLibraryService:l}=e,d=s.itemId;if(performance.now(),e.rootPlaylistService.updateInflightFrag(d,t,i,r,null,n),a&&t!==we.Subtitle){const t=s.getInFlightFrags(),{config:i,mediaSink:r,statsService:n}=e;Fm(i,o,s,r,l,n.getQueryForId(s.statsId),t)}}const _g={name:"avpipe"},Vg=(o,l)=>e=>{var t;const{config:u,mediaSink:i,iframeClock:c,rootPlaylistQuery:h,rootPlaylistService:r,mediaLibraryService:p,itemQueue:n}=o,m=o.logger.child({name:"anchor"}),f=i.mediaQuery,g=h.isInterstitial,a=f.desiredRate,s=o.config.liveAllowLowLatencyPlayback&&(0===a||1===a);return gr(f.readyState>=HTMLMediaElement.HAVE_METADATA&&!fe(null==(t=f.seekTo)?void 0:t.pos)&&null==o.hlsQuery.pendingSeek?Bn(e.pipe(Dr(1),Ae(e=>{var t=n.getQueueItemForId(e[0].itemId),e=qm(e,u),t=xe(t.initialSeekTime,f.currentTime);return be({pos:Math.max(e.start,Math.min(e.end,t)),fromEvent:!1})})),f.seekTo$):f.seekTo$,Rn).pipe(Te((e,t)=>Math.abs((null==e?void 0:e.pos)-(null==t?void 0:t.pos))<Number.EPSILON&&(null==e?void 0:e.discoSeqNum)===(null==t?void 0:t.discoSeqNum)),Yl(),ve((e,t)=>({seekTo:e,switchInfo:0===t?l:[null,null],seekIdx:t}))).pipe(Ae(({seekTo:o,switchInfo:l,seekIdx:d})=>e.pipe(Te((e,r)=>e&&r&&zp(e)===zp(r)&&Wp(e)===Wp(r)&&e.every((e,t)=>{var i;return!((null==e?void 0:e.endSN)!==(null==(i=r[t])?void 0:i.endSN)||s&&Rf(e,r[t]))})),Ae(e=>ol(f.updating$,e=>!e).pipe(xr(e))),Ae(e=>{var t=h.enabledMediaOptionKeys,i=e[we.Variant];if((null!=(n=null==i?void 0:i.mediaOptionId)?n:Me.mediaOptionId)!==(null==(n=t[we.Variant])?void 0:n.mediaOptionId))return Se;t=i.iframesOnly;let r=!1;var n=Im(e,o,f,l,c,g,u,m);if(!n)return Se;var i=h.getInFlightFrags(),a=t||function(r,n,e,a,t,s){var i=e.some(e=>null!=e)&&e.every((e,t)=>!e||dh(e,n[t])||dh(e,r.anchorFrags[t])),[o,l]=e;if(!i&&(null==o?void 0:o.discoSeqNum)===r.discoSeqNum&&(null==l?void 0:l.discoSeqNum)===r.discoSeqNum&&(!t||l.start<=o.start)){const n=r.pos;let t=-1/0,i=!0;if(e.forEach(e=>{t=Math.max(e.start),i=i&&e.start<=n&&e.start+e.duration>n}),i||a&&n<=t&&t-n<=s)return!1}return!i}(n,null!=(a=n.nextFrags)?a:[null,null],i,f.getBufferInfo(n.pos,u.maxBufferHole).every(e=>{return null==(e=null==(e=null==e?void 0:e.buffered)?void 0:e.len)||e}),u.firstAudioMustOverlapVideoStart,u.maxSeekHole);let s=!1;if(u.enableItemPreloading){const o=vg(h);s=null!=p.getPrefetchCacheEntry(o,qf.VariantSegment)}if(!s&&0<d&&f.readyState>=HTMLMediaElement.HAVE_METADATA&&null!=(i=f.combinedBuffer)&&i.length&&!t){const l=f.getMediaBufferInfo(o.pos,u.maxBufferHole);r=(l.combined.len||0)<vc(u,e[we.Variant],l)}return be({anchorInfo:n,checkForSwitch:r,shouldUpdateAnchor:a,gotValidAnchor:zp(e)||e[we.Variant].iframesOnly})}),sn(({gotValidAnchor:e})=>!e,!0))),la(({anchorInfo:e,checkForSwitch:t,shouldUpdateAnchor:i})=>{i&&(t&&Tf(yp.Seek,h.enabledVariantMediaOption,o)&&(e=null),r.setAVAnchor(h.itemId,e))}))};function Qg(e,t,i,r,n){const a=t.start,s=i&&i.start+i.duration>a||(null==r?void 0:r.some(e=>a>=e.start&&a<e.end)),o=null==n||n<=cu.LowWater;return!i||s||(t=i,!!(r=e.getQueryForOption(t).mediaOptionDetails)&&r.discoToMSNMap[t.discoSeqNum][1]===t.mediaSeqNum)||o}function Hg(t,i,r,n,a){const s=r.start,o=r.duration,l=Ks(r.mediaOptionType);let d=a.highWaterLevelSeconds;if(a.gotQuotaExceeded(l)){let e=0;fe(null==(u=r.byteRangeOffset)?void 0:u.start)&&fe(null==(u=r.byteRangeOffset)?void 0:u.end)?e=r.byteRangeOffset.end-r.byteRangeOffset.start:fe(r.bitrate)&&(e=r.bitrate*r.duration/8);const{likelyToExceed:s,safeWaterLevel:o}=a.likelyToExceedBuffer(t,l,e,n,i);s&&(d=o)}var u=xe(a.lowWaterLevelSeconds,o);return{lowWaterLevelSeconds:u,highWaterLevelSeconds:d=Math.max(u,xe(d,o)),stopStreamingHighWaterLevelSeconds:Math.min(Math.max(s-t-o,u),d)}}function qg(e,t,i,r){let n=t;return r.stopStreaming?n=i:r.paused&&0===r.desiredRate&&(n=e),n}function Kg(o,e,t,i,l,d){if(null==t)return null;const{mediaSink:r,config:u,interstitialController:n,rootPlaylistQuery:c}=o,h=r.mediaQuery,a=fh(i),p=t["mediaOptionType"],s=n.fragmentIsInterstitialBoundary(t,Object.assign(Object.assign({},o),{iframeMode:a,isAnchor:d})),m=Ks(p);if(p===we.Subtitle)return null;if(t.gap){if(!t.iframe){const e=new eo(!1,pe.ContentHasGap,{mediaOptionId:t.mediaOptionId,mediaOptionType:t.mediaOptionType},Qa(t.url)),i=em(e,!1,u.maxNumAddLevelToPenaltyBox,o.rootPlaylistQuery,o.rootPlaylistService,void 0);i.errorAction===U.DoNothing?r.updateContentGapRanges(Ks(p),{start:t.start,end:t.start+t.duration}):tm(i,e,o.rootPlaylistQuery,o.rootPlaylistService,p,t.mediaOptionId,!1),e.handled=!0}return null}const f=Sm(t,i,l,u.trickPlaybackConfig.minIframeDuration);let g=f.foundFrag.mediaFragment;return a&&p===we.AltAudio&&(g=Object.assign(Object.assign({},g),{start:l.end})),Ug(o,p,g,"waiting",null,!1),s.pipe(Ae(r=>{const e=c.enabledMediaOptionSwitchContexts[p];if(r)return Se;const n=gm(e),a=null==e?void 0:e.triggerEvent,t=[],i=2===h.expectedSbCount;if(!d&&!n){const r=g.start,e=h.desiredPos,{lowWaterLevelSeconds:n,highWaterLevelSeconds:d,stopStreamingHighWaterLevelSeconds:a}=Hg(e,l,g,u.maxBufferHole,h),s=qg(n,d,a,h);if(r-e>=s&&t.push(ol(h.timeupdate$,e=>{let t=e;var i=h.desiredPos;return 0===e&&i!==e&&(t=i),r-t<qg(n,d,a,h)})),i){const r=o["mediaLibraryService"],e=we.AltAudio-p;Qg(r,g,c.getInFlightFragByType(e),h.getBufferedRangeByType(e),h.waterLevelForType(m))||t.push(ol(br([c.getInFlightFragByType$(e).pipe(Te(lh)),h.getBufferedRangeByType$(e),h.waterLevelChangedForType$(m)]),([e,t,i])=>Qg(r,g,e,t,i)))}}return t.length?Pn(t).pipe(pr(Rn),Ae(()=>Zg(0,o,f,p,n,a))):Zg(0,o,f,p,n,a)}))}function jg(i,e,r,n,a,s){const{mediaSink:o,rootPlaylistQuery:l,rootPlaylistService:d,rtcService:u,statsService:c}=i;return e=>{let t=e.pipe((D=i,x=n,N=s,e=>{const{rootPlaylistQuery:M,rootPlaylistService:P,mediaSink:C,legibleSystemAdapter:k,itemQueue:L}=D;return e.pipe(Ae(R=>new F(function(e){var t,i=null!=x?performance.now():NaN;let r=NaN;for(const D of R){const x=null==(t=null==D?void 0:D[0])?void 0:t.discoSeqNum;!fe(r)&&fe(x)&&(r=x)}var n=ey(D.logger,D,r,R);if(!n)return e.next(!1),e.complete();const{appendDataTuple:a,inFlightFrags:s,initPTSInfo:o}=n,l=[];s.forEach((e,t)=>{if(e){const i=C.isCompatibleWithSourceBuffers(a)["compatible"];Ug(D,t,e,"appending",i,!0)}const i=function(e,t){if(t)return e=e.getQueryForOption(t).mediaOptionDetails,(!fe(t.partIndex)||Mm(e,t.mediaSeqNum).partIndex===t.partIndex)&&(e=Rm(e,t.mediaSeqNum+1))&&e.discoSeqNum!==t.discoSeqNum?e:void 0}(D.mediaLibraryService,e);i&&l.push(i)}),a.forEach(e=>{var t=null==e?void 0:e.dataSeg;if(t&&o){const e=o.offsetTimestamp,i=L.getQueueItemForId(t.itemId),r=i&&ke(i);k.addLegibleSamples(e,t.captionData,t.id3Samples,t.startPts,t.endPts,r)}});d=s,u=C,c=M,h=P;var d,u,c,h,p,m,f,g,y,v,I,S,b,T=(e,t,i,r,n)=>{var I,S,b,T,A,E,O,w,R,a=null!=(a=null==(a=d[t])?void 0:a.targetDuration)?a:10;return I=u,S=e,b=t,T=i,A=a,E=r,O=c,w=h,R=n,e=>e.pipe(Ee(()=>{w.updateConsecutiveTimeouts(O.itemId,b,!1,"append")}),Xr(e=>e.pipe(Ae((i,r)=>{var n=i instanceof Ch&&i.isTimeout;if(w.updateConsecutiveTimeouts(O.itemId,b,n,"append"),n){var n=i,a=r,s=E,o=b,l=T,d=R,u=O,c=w;let e={errorAction:U.SendAlternateToPenaltyBox,errorActionFlags:0};var h=(d=d.getCurrentWaterLevel(s.maxBufferHole))<s.almostDryBufferSec;let t=NaN;var s=s.appendErrorMaxRetry,p=(p=u.getErrorInfoByType(o))?p.timeouts.append:0,h=(h&&s<=p||s<=a?e.errorAction=U.SendEndCallback:t=1e3*d,{retryDelayMs:t,maxNumRetry:s,maxRetryDelayMs:t});return nm(n,a,h,e=Xp(e,!1,n.response,l,o,u,c,"append",h.maxNumRetry),u,c,o,l).pipe()}if(i instanceof kh){var p=i,d=S,s=r,a=A,e=E,n=b,h=T,u=R,c=O,o=w;const t=u.currentTime,m=d.type,f=u.getBufferInfo(t,e.maxBufferHole)[m].buffered;if(f.len>=e.almostDryBufferSec&&!u.isIframeRate){const e=1e3*a,t={errorAction:U.RetryRequest,errorActionFlags:0},m={retryDelayMs:e,maxNumRetry:1/0,maxRetryDelayMs:e};if(1e3*f.len<e){if(!o.hasFallbackMediaOptionTuple(c,n,h,!1))return t.errorAction=U.SendEndCallback,nm(p,s,m,t,c,o,n,h);t.errorAction=U.SendAlternateToPenaltyBox}const g=c.getInFlightFragByType(js(d.type)),y=function(e,t,i,r,n,a){let s=Pe;var o=t.end-t.len;if(1===a){const i=o-r;t.start<i&&(s=e.remove(0,i))}else if(2===a){const r=o+n;t.end>r&&r>=i.start&&(s=e.remove(r,Number.POSITIVE_INFINITY))}return s}(d,f,g?{start:g.start,end:g.start+g.duration}:{start:NaN,end:NaN},u.lowWaterLevelSeconds,u.highWaterLevelSeconds,s),v=nm(p,s,m,t,c,o,n,h);return y===Pe?v:y.pipe(Ae(()=>v))}return s<e.appendErrorMaxRetry?d.remove(0,Number.POSITIVE_INFINITY):(p.fatal=!0,Fr(p))}if(i instanceof Dh){const{mediaOptionType:S,mediaOptionId:b}=i;return sm(i,S,b,I,w,O,"append",E.appendErrorMaxRetry)}throw i}))))},A=Ks(x),E=L.getQueueItemForId(null==(E=null==(E=null==a?void 0:a[0])?void 0:E.dataSeg)?void 0:E.itemId),T=C.avAppend(A,a,T,E,M.highestVideoCodec),E=a[B.AltAudio];let O,w;if(null!=E&&E.dataSeg){const D=E.dataSeg,{itemId:x,mediaOptionId:N,flushBeforeAppend:R,switchPosition:M,triggerEvent:P}=D;O={itemId:x,mediaOptionId:N,flushBeforeAppend:R,switchPosition:M,triggerEvent:P}}if(null==A&&n.appendDataTuple.some(e=>null!=(null==e?void 0:e.dataSeg))){w={start:Number.POSITIVE_INFINITY,end:Number.POSITIVE_INFINITY};for(const D of n.appendDataTuple){const{start:x,end:N}=w;w.start=null!=D&&D.dataSeg.startPts?Math.min(_(D.dataSeg.startPts,D.offsetTimestamp),x):x,w.end=null!=D&&D.dataSeg.endPts?Math.min(_(D.dataSeg.endPts,D.offsetTimestamp),N):N}}T.pipe(function(t,y,v,I,S,b,T,A){const{mediaSink:i,rootPlaylistService:s,rootPlaylistQuery:o}=y;return e=>{var r,n,a,e=e.pipe(ve(e=>{{var r=y,t=v,n=I,i=S,a=b,s=e,o=T;e=A;const{mediaSink:l,rootPlaylistQuery:d,rootPlaylistService:u,interstitialController:c,rtcService:h,statsService:p,playerEvents:m}=r,f=[B.Variant,B.AltAudio].map(e=>l.mediaQuery.getBufferedRangeByType(e)),g={};if(Oe(()=>{n.forEach((e,t)=>{e&&(Ug(r,t,e,"appended",null,!0,g),t!==we.Variant&&t!==we.AltAudio||(l.updateInFlightRange(t,null),c.fragmentAppended({isLastFragment:e.isLastFragment,type:e.mediaOptionType,itemId:e.itemId})))});for(const r of s){var e;r&&(e=xe(o,r.startDataAppend),n[r.fragmentType]&&null!=h&&h.report(17,{fragmentType:r.fragmentType,startAppend:e,endAppend:r.endDataAppend,bytesAppend:r.dataBytesAppend,fragStart:n[r.fragmentType].start,fragDuration:n[r.fragmentType].duration,fragId:sh(n[r.fragmentType])}),e=e!==r.startDataAppend?Object.assign(Object.assign({},r),{startDataAppend:e}):r,p.updateBufferEstimate(e),null!=h)&&h.report(7,e)}if(a){const{flushBeforeAppend:r,switchPosition:t,triggerEvent:n}=a;if(r||fe(t)||n){const{itemId:r,mediaOptionId:i}=a;u.setEnabledMediaOptionSwitchContextByType(r,we.AltAudio,i,void 0)}}}),null!=a&&a.triggerEvent){const r=d.enabledAlternateMediaOptionByType(we.AltAudio);m.postAudioTrackSwitched(t,r)}m.triggerBufferAppended({fragments:n,buffered:f,appItemId:d.appItemId});for(const t of e)r.mediaLibraryService.cacheFrag(r,t);return i&&l.adjustJaggedStart(i),!0}}));return null==t&&e.pipe((r=i,n=s,a=o,e=>e.pipe(ye(e=>{var t,i;if(e instanceof Ph)return{mediaOptionType:t,mediaOptionId:i}=e,sm(e,t,i,r,n,a,void 0,0);throw e})))),e}}(A,D,N,s,w,O,i,l)).subscribe(e);for(const x of l)p=D,m=x,f=void 0,g=void 0,y=void 0,v=void 0,I=void 0,S=void 0,b=void 0,m&&({logger:f,mediaLibraryService:g}=p,y=g.getQueryForOption(m).mediaOptionDetails,{itemId:v,mediaOptionType:I,mediaOptionId:S}=m,b=p.rootPlaylistQuery.appItemId,xg(p,m.keyTagInfo,{itemId:v,appItemId:b,mediaOptionId:S,mediaOptionType:I}),g.retrieveInitSegmentCacheEntity(p,y,m.discoSeqNum))})))}),ye(e=>{var t;if(e instanceof io)return t=c.getQueryForId(l.statsId),u.report(36,{fragId:e.fragId,instantBandwidth:t.bandwidthStatus.instantBw,avgBandwidth:t.getBandwidthEstimate().avgBandwidth,observedBitrateIncludingLatency:oe(e.bwSample.trequest,e.bwSample.tload,e.bwSample.loaded),latency:e.bwSample.tfirst-e.bwSample.trequest,isAbort:!0}),(t=e.candidateMediaOptions)?(d.setEnabledMediaOptions(i.rootPlaylistQuery.itemId,t),Se):be(!1);if(e instanceof v&&!e.fatal)return be(!1);throw e}),Ee(e=>{e||Hs.forEach(e=>{null!=n&&e!==n||Ug(i,e,null,null,!1,!1)})}),Hr(()=>{Oe(()=>{Hs.forEach(e=>{o.updateInFlightRange(e,null)})})}));var D,x,N;return(t=n===we.Variant?t.pipe(Ae(e=>{var t;return a&&(t=$g(i,0,r))&&d.setEnabledMediaOptions(l.itemId,t),be(e)})):t).pipe(Hr(()=>{null!=n&&n!==we.Variant||d.setFragLoadSlow({fragDownloadSlow:!1,fragDownloadTooSlow:!1})}))}}function $g(c,e,t){var{config:i,mediaSelectionBossService:r,mediaSink:n,platformService:a,rootPlaylistService:s,rootPlaylistQuery:o,statsService:l}=c,n=n.mediaQuery,l=l.getQueryForId(o.statsId);if(o.getEntity(o.itemId).manualMode||n.isIframeRate&&i.abrTrickplayLevelLocked)return null;var h=o.enabledVariantMediaOption;if(h.mediaOptionId!==t)return null;let d=yp.None;t=s.abrController,s=o.itemId;if(i.abrAlgorithm===_a.L2A){const e=Af(yp.Always,c);return Wg(c),e}var u=l.getBandwidthEstimate(i),p=t.highBwTrigger,m=(null==(o=l.bandwidthStatus)?void 0:o.bandwidthSampleCount)||0,l=(!function(e){var{config:e,mediaLibraryService:t,mediaSink:i,rootPlaylistQuery:r,rootPlaylistService:n}=e,i=i["mediaQuery"],{estimate:a,isLiveOrEvent:s}=uf(c,Sp.Auto,h.iframes),o=r.enabledVariantMediaOption;if(!o)return!1;var l=t.getQueryForOption(o),d=l.mediaOptionDetails,l=null==(l=l.mediaOptionDetailsEntity)?void 0:l.lastUpdateMillis,s=!!s&&Rc(e.liveAllowLowLatencyPlayback,i.isPlayingAtLive,(null==(s=null==d?void 0:d.parts)?void 0:s.length)||0);let u=yc(e,o,d,s,a,i.getMediaBufferInfo(i.desiredPos,e.maxBufferHole),l,!1)["avgTime"];o=r.getInFlightFragByType(we.Variant);if(d&&o&&"appended"!==o.state&&!o.iframe&&!o.part){const e=Oc(d.fragments,o.mediaSeqNum+1);t.isCachingFrag(e)&&(u-=a.avgDataFragAppendMs/1e3)}return(i=n.abrController.status)&&(i.fragDownloadSlow||i.fragDownloadTooSlow)||u>wc(d,e,s)}(c)?function(e,t){var{bandwidthEstimate:i,bandwidthSampleCount:r,highBwTrigger:n}={bandwidthEstimate:u,bandwidthSampleCount:m,highBwTrigger:p};return ef(i)&&(i=lf(i.avgBandwidth,r,e)["bwUp"],i>fc(Object.assign(Object.assign({},t),{bitrate:n}),e.trickPlaybackConfig))}(i,h)&&function(){var e,{config:t,mediaSink:i,mediaLibraryService:r,rootPlaylistQuery:n}=c,i=i.mediaQuery,a=n.enabledVariantMediaOption,s=n.enabledAlternateMediaOptionByType(we.AltAudio);return a&&(e=r.getQueryForOption(a).mediaOptionDetails)&&(r=null!=s&&s.url?r.getQueryForOption(s).mediaOptionDetails:void 0,s=i.desiredPos,s=i.getMediaBufferInfo(s,t.maxBufferHole),e=vc(t,(a={variant:a,avDetails:[e,r]}).avDetails[we.Variant],s),km(n.getInFlightFrags(),a,s,i.desiredRate,e,i.waitingForDisco,t.liveAllowLowLatencyPlayback))}()&&(d=yp.HighBandwidth,null!=r&&r.setTransformer(s,Re.BitrateFilter,new Wc(h.bitrate,Number.POSITIVE_INFINITY)),t.nextMinAutoOptionId=h.mediaOptionId):(d=yp.LowBandwidth,t.nextMaxAutoOptionId===Me.mediaOptionId&&(null!=r&&r.setTransformer(s,Re.BitrateFilter,new Wc(0,h.bitrate)),t.nextMaxAutoOptionId=h.mediaOptionId)),Af(d=Yg(a,n,i)?yp.PreferredListChanged:d,c));return Wg(c),l}function Gg(e,t){var i,r,n;return!!e&&(!(e.part&&(!e.part||!1!==(null==t?void 0:t.hasPartIndependentTag))&&(i=xe(e.partIndex,0),t=null!=(t=t.parts)?t:[],r=e.mediaSeqNum,n=i,i=t.find(e=>e.mediaSeqNum===r&&e.partIndex===n+1||e.mediaSeqNum===r+1&&0===e.partIndex)))||i.partIndependent)}function Wg(e){var{mediaSelectionBossService:e,rootPlaylistQuery:t,rootPlaylistService:i}=e;null!=e&&e.removeTransformer(t.itemId,Re.BitrateFilter),i.abrController.resetLevelCaps()}const zg=(P,C,e)=>e=>{const{discoSeqNum:g,anchorFrags:t,iframeMode:y,switchInfo:v}=C,u=t.map(e=>{var{mediaSeqNum:e=NaN,part:t,partIndex:i}=e||{};return{msn:e,part:t,partIndex:i}}),I=t[0].mediaOptionId,{iframeClock:p,mediaSink:n,rootPlaylistQuery:m,config:f,mediaLibraryService:S,interstitialController:a,itemQueue:s}=P,{itemId:b,appItemId:c}=m,T=n.mediaQuery,A=T.desiredRate,i=A<0?-1:1,{maxBufferHole:E,maxFragLookUpTolerance:O,liveAllowLowLatencyPlayback:r}=P.config,w=r&&(1===A||0===A),R={firstDisco:!0,discoSeqNum:g,complete:!1,step:i,msnsInDisco:[{startMSN:u[0].msn,startPartIndex:u[0].partIndex,length:0,partlength:NaN},{startMSN:u[1].msn,startPartIndex:u[1].partIndex,length:0,partlength:NaN}],nextAnchor:{discoSeqNum:NaN,anchorFrags:[null,null],iframeMode:C.iframeMode,switchInfo:[]}},o=e.pipe(Te((r,e)=>null==e?void 0:e.every((e,t)=>{var i=r[t];return null==i&&null==e||null!=r[t]&&!(i.mediaOptionId!==e.mediaOptionId||wf(i,e)||w&&Rf(i,e))})),Pr((s,h)=>{var a,t;const p=null!=(a=C.pos)?a:T.currentTime;if(R.firstDisco=0===h,0!==h)return be(s);{const h=[null,null],a=(Hs.forEach(e=>{var t,i,r,n,a=s[e];a&&({msn:t,part:i,partIndex:r}=u[e],n=null,n=fe(r)?Oc(a.parts,t,r):Oc(a.fragments,t))&&(h[e]=n)}),(n.needSourceBuffers||!fe(C.pos))&&h.every((e,t)=>{var i=t===we.Variant?qf.VariantSegment:qf.AltAudioSegment,t=null==(t=null==(t=s[t])?void 0:t.initSegments[e.discoSeqNum])?void 0:t.isInitSegment;return null==e||t&&!S.getPrefetchCacheEntry(c,i)})),o=[],l=[sl,sl],d=[sl,sl],m=T.getBufferInfo(p,E,M?b:void 0),f=T.getContentGapRanges(),R=(h.forEach((e,t)=>{var i;if(e){const r=m[t].buffered;if(a){const{itemId:i,mediaOptionId:r,mediaOptionType:n}=e;o.push(xg(P,e.keyTagInfo,{itemId:i,mediaOptionId:r,mediaOptionType:n,appItemId:c}).pipe(Ae(()=>Se))),l[t]=S.retrieveInitSegmentCacheEntity(P,e,e.discoSeqNum).pipe(ve(e=>[null==(null==e?void 0:e.initParsedData)?null:e,null]))}d[t]=null!=(i=Kg(P,0,e,A,r,!0))?i:sl}}),null==(t=null==v?void 0:v[we.AltAudio])?void 0:t.switchContext);let r=Gg(h[we.Variant],s[we.Variant]);let e=Pn(l).pipe(Ae(e=>{const t=ey(P.logger,P,g,e),c=null==t||n.isCompatibleWithSourceBuffers(t.appendDataTuple).compatible,i=d.map((e,t)=>{var i,r,n,a,s,o,l,d,u;return i=p,r=h[t],n=v,a=g,s=y,t=m[t],o=c,l=f,d=O,!!r&&(u=gm(null==(u=n[we.AltAudio])?void 0:u.switchContext),!(o&&(r.mediaOptionType!==we.AltAudio||!u))||({buffered:o,bufferedSegments:u}=t,t=ym(n[r.mediaOptionType]),s?r.mediaOptionType!==we.AltAudio||u.every(e=>e.frag.discoSeqNum!==a)||0===o.len:(n=hm(r,i,o,u,l,d,t).shouldLoad,s=pm(r,u),n||s)))?e:sl});return r=i[we.Variant]!==sl&&r,t?Lr(be(e),Pn(i)):Pn(i)}));return(e=o.length?Bn(...o,e):e).pipe(jg(P,0,I,null,!1,R),qr(1),Ae(()=>{var e,t,i;return r&&({rootPlaylistQuery:e,rootPlaylistService:t}=P,i=$g(P,0,I))?(t.setEnabledMediaOptions(e.itemId,i),Se):be(s)}))}}),function(e,t){return ti(Or(e,t,2<=arguments.length,!0))}((c,h)=>(Hs.forEach(i=>{var e,r=h[i];if(r){const{step:s,discoSeqNum:o,msnsInDisco:t,nextAnchor:l}=c,d=t[i],u=r.discoToMSNMap[o];if(u){let e=u[0];0<s&&(e=Math.min(u[1],r.endSN)),d.length=Math.abs(e-d.startMSN)+1,d.partlength=NaN,w&&u[1]>r.endSN&&(u[1]===r.partEndSN?(d.length=u[1]-d.startMSN,d.partlength=r.partEndIndex+1):(d.partlength=NaN,d.length=u[1]-d.startMSN+1))}var n=l.anchorFrags;if(!n[i]){var a;const t=0<(null==(e=r.parts)?void 0:e.length);a=w&&t?null==(e=Oc(r.parts,r.partEndSN,r.partEndIndex))?void 0:e.discoSeqNum:null==(e=Oc(r.fragments,0<s?r.endSN:r.startSN))?void 0:e.discoSeqNum;for(let t=o+s;null!=a&&(0<s?t<=a:t>=a);t+=s){const h=r.discoToMSNMap[t];if(h&&(!fe(c.nextAnchor.discoSeqNum)||t===c.nextAnchor.discoSeqNum)){const c=h[0<s?0:1];let e=Oc(r.fragments,c);e=e||Oc(r.parts,c,0),n[i]=fm(e),l.discoSeqNum=t;break}}}}}),(Wp(h)||fe(c.nextAnchor.discoSeqNum)&&c.nextAnchor.anchorFrags.every((e,t)=>null==h[t]||null!=e))&&(c.complete=!0),c),R),sn(({complete:e})=>!e,!0),en({bufferSize:1,refCount:!0})),M=m.isInterstitial,l=[];return Hs.forEach(u=>{var e=t[u];if(null!=e){const c=S.getQueryForOption(t[u]),h={frag:1,part:NaN};e.part&&(h.frag=0,h.part=e.partIndex);e=o.pipe(Ee(({firstDisco:e})=>{var t=T.getBufferedSegmentsByType(Ks(u))[0];null!=t&&t.partialFrag&&e&&(h.frag=0)}),Vr(({msnsInDisco:e,nextAnchor:t,discoSeqNum:l,step:d,complete:i})=>gr(be(e[u]),Rn).pipe(Qr(e=>{var t=c.mediaOptionDetails;if(!t||t.mediaOptionId!==m.enabledMediaOptionIdByType(u))return Se;if(h.frag>e.length||w&&h.frag===e.length&&!fe(e.partlength)||w&&fe(e.partlength)&&h.frag===e.length&&h.part>e.partlength)return Se;var i=T.currentTime,r=!0===(null==p?void 0:p.isStarted),n=r?p.getCurrentTime().seconds:i,{buffered:i,bufferedSegments:a}=T.getBufferInfo(i,E,M?b:void 0)[u],s=r?[]:T.getContentGapRanges(),r=r?Math.max(0,n+i.len*A):i.end,o={msns:e,idx:h,step:d,allowParts:w,desiredRate:A},o=bm(t,function(e,t,i,r){var{msns:i,idx:n,step:a,desiredRate:s}=i,i=i.startMSN+n.frag*a;let o=i;n=Oc(t,i);if(n&&r+e.maxBufferHole<n.start){const e=vm(r,t,s);e&&(o=e.mediaSeqNum)}return o}(f,t.fragments,o,r),n,A,i,a,s,O,!1,h,w);if(!o||o.discoSeqNum!==l)return h.frag=e.length,h.part=e.partlength,Se;null!=o&&o.part?(h.frag=Math.abs(o.mediaSeqNum-e.startMSN),h.part=o.partIndex):(h.frag=Math.abs(o.mediaSeqNum-e.startMSN)+1,h.part=NaN);r=Gg(o,t);return(null!=(n=Kg(P,0,o,A,i,!1))?n:sl).pipe(ve(e=>u===we.Variant?[e,null]:[null,e]),jg(P,0,I,u,r),ve(()=>e))},1),ve(()=>({nextAnchor:t,type:u,complete:i})))),Ee(({nextAnchor:e})=>{var t;if(r&&(!e||e.anchorFrags.every(e=>!e))){const e=c.mediaOptionDetails;null!=e&&e.liveOrEvent&&0<(null==(t=e.preloadHints)?void 0:t.length)&&S.createPreloadHints(P,e)}}),qr(1));l.push(e)}}),0<l.length?(1===l.length?l[0]:Bn(...l).pipe(sn(({type:e,complete:t})=>!y||e!==we.Variant||!t,!0))).pipe(qr(1),ve(({nextAnchor:e,complete:t})=>{var i=s.activeItem;if(t&&f.interstitialsConfiguredForAirPlayReceiver&&ke(i)&&!fe(i.itemTimelineEndPosition)){const e=a.getCurrentBufferOffsets(T,Ia.Midroll);if(fe(e[we.Variant])){const t=i.itemStartOffsets[we.Variant],r=fe(t)?t:0,n=e[we.Variant]-r;s.updateItemById(i.itemId,{itemTimelineEndPosition:n})}}return e}),Hr(()=>{Oe(()=>{Hs.forEach(e=>{Ug(P,e,null,null,null,!1)})})})):Se};function Yg(e,t,i){var r=null==t?void 0:t.clientWidth,t=null==t?void 0:t.clientHeight,n="object"==typeof window&&window.devicePixelRatio?window.devicePixelRatio:1,r=r&&t?{width:r*n,height:t*n}:void 0,t=e.query.viewportInfo||{},n=t&&r&&(t.width!==r.width||t.height!==r.height);return i.useViewportSizeForLevelCap&&n&&(e.updateViewportInfo(r),!0)}function Xg(e,t,i,r,n,a,s){var o=e["rootPlaylistQuery"],l=o.itemId,d=t.mediaOptionType,l=(e.rootPlaylistService.updateInflightFrag(l,d,t,"loading",a,null),o.getInFlightFrags());if(d!==we.Variant&&"loading"===(null==(t=l[we.Variant])?void 0:t.state)||Fm(e.config,e.logger,e.rootPlaylistQuery,e.mediaSink,e.mediaLibraryService,e.statsService.getQueryForId(o.statsId),l),d===we.Variant){var u=e;a=l;var c,h,p,m,{config:t,mediaSink:o,rootPlaylistQuery:d,rootPlaylistService:e}=u,o=o.mediaQuery,l=u.logger.child(Jm),f=e.getAbrStatus(),f={fragDownloadSlow:null!=(g=null==f?void 0:f.fragDownloadSlow)&&g,fragDownloadTooSlow:null!=(g=null==f?void 0:f.fragDownloadTooSlow)&&g},[g]=a;if(g&&ff(g)&&(!o.isIframeRate||!t.abrTrickplayLevelLocked))try{gf(f,(h=d,p=l,m=f,ff(c=g)?bf(c,m,h,p):m)),gf(f,function(a,s,o){var l=s.mediaSink.mediaQuery,{rootPlaylistQuery:d,config:u,logger:c,mediaSelectionBossService:h}=s,p=l.desiredRate,t=a[we.Variant];if(0===p||!ff(t))return o;var{tfirst:p,trequest:m}=t.bwSample,f=fe(p),f=performance.now()-(f?p:m),p=Cm(t.duration,l.playbackRate,u),m=1e3*Ic(t.duration,u.maxStarvationDelay);if(f<Math.min(m,p))return o;f=sf(d,h,l.isIframeRate,u,c);if(0===f.length||f[0].mediaOptionId===t.mediaOptionId)return o;{var g=o,y=a,v=f,m=s;let{fragDownloadSlow:e,fragDownloadTooSlow:r}=g;var{config:p,rootPlaylistService:d,rootPlaylistQuery:h,mediaSink:l,statsService:u,mediaLibraryService:I,mediaSelectionBossService:c,hlsService:t}=m,o=m.logger.child(Jm),l=l.mediaQuery,[a]=y,f=null==a?void 0:a.bwSample;if(!f||!fe(null==f?void 0:f.tfirst))return g;var s=performance.now(),S=s-f.tfirst,b=Ic(a.duration,p.maxStarvationDelay);if(l.paused&&S/1e3<b)return g;var T=we.Variant,A=a.mediaOptionId,E=h.variantMediaOptionById(A);if(!E)return g;var O=d.abrController,w=I.getQueryForOption(E),R=a.itemId,M=u.getQueryForId(h.statsId),P=M.getCombinedEstimate(p,!1),C=Math.max(1,8e3*f.loaded/S),k=[],i=null!=(null==(L=h.enabledAlternateMediaOptionByType(we.AltAudio))?void 0:L.url);for(const g of y)if(g){const y=I.getQueryForOption(g).mediaOptionDetails;y&&k.push(Lm(E,y,g,i))}var L=Dm(y,k,B.Variant,0,P,P,P,!0),D=rf(l,p.maxBufferHole);let n;if(fe(D)&&0<D&&!fe(null==(x=l.seekTo)?void 0:x.pos))n=D;else{const g=S/1e3;n=g<b?b-g:b}({fragDownloadSlow:e,fragDownloadTooSlow:r}=bf(a,g,h,o));var x=w.mediaOptionDetails,o=Rc(p.liveAllowLowLatencyPlayback,l.isPlayingAtLive,null!=(b=null==(S=null==x?void 0:x.parts)?void 0:S.length)?b:0),g=2*(wc(x,p,!1)||a.duration);if(o&&P.avgLatencyMs/1e3+E.bitrate/C>a.duration||D<=g&&(L>=n||e)){let i;e=!0,t.query.extendMaxTTFB||t.setExtendMaxTTFB(6e5);w=Object.assign(Object.assign({},P),{avgBandwidth:C}),S=M.bandwidthStatus,b=E.iframes,D=L>=n&&!b,P=af(0,v,b,h);if(!(P<0)){let t=v.length-1;for(let e=0;e<v.length;e++){const y=v[e];if(y.mediaOptionId===E.mediaOptionId)t=e-1;else if(y.mediaOptionId===O.nextMaxAutoOptionId){t=e;break}}C=Math.max(P,t),M=v.slice(P,C+1),g={currentFragDuration:a.duration,maxFetchDuration:n,iframeMode:b,estimate:w,bwStatus:S,bwFactor:1,bwUpFactor:1,isInstantBw:!0,playbackRate:tf(l),isLiveOrEvent:Boolean(null==x?void 0:x.liveOrEvent)};if(D){let e=O.findBestVariant(M,m,g,Sp.Emergency);const y=Me.mediaOptionId;e.variantMediaOption!==y?i=e.variantMediaOption:(g.maxFetchDuration=L,e=O.findBestVariant(M,m,g,Sp.Emergency)),i=e.variantMediaOption!==y?e.variantMediaOption:e.lowestCandidate}else{const g=af(0,[...M].reverse(),b,h);(0<=g||C===P)&&(i=v[C-g].mediaOptionId)}if(null!=i&&i!==O.nextMaxAutoOptionId){O.nextMaxAutoOptionId=i;const g=h.variantMediaOptionById(i);null!=c&&c.setTransformer(R,Re.BitrateFilter,new Wc(0,(null==g?void 0:g.bitrate)||0))}let e=!1;if(D&&null!=i&&i!==Me.mediaOptionId&&i!==A){const g=h.variantMediaOptionById(i),v=yc(p,g,I.getQueryForOption(g).mediaOptionDetails,o,w,l.getMediaBufferInfo(l.desiredPos,p.maxBufferHole),NaN,!0)["totalTime"];v<Dm(y,k,B.Variant,0,w,w,w,!0)&&(e=!0)}if(e&&null!=i&&i!==Me.mediaOptionId&&i!==A){u.updateBandwidthEstimate(Object.assign(Object.assign({},f),{tfirst:f.tfirst||s,tload:f.tload||s,complete:!0,mediaOptionType:T})),r=!0;const g=i?d.getEnabledAlternatesForVariant(h,i):[Me,Me,Me];if(h.isValidMediaOptionTuple(g))throw new io({mediaOptionType:T,mediaOptionId:A},g,Object.assign(Object.assign({},f),{tfirst:f.tfirst||s,tload:f.tload||s}),sh(a),pe.FragmentAbortError)}}}else t.query.extendMaxTTFB&&t.setExtendMaxTTFB(0);return{fragDownloadSlow:e,fragDownloadTooSlow:r}}}(a,u,f))}catch(u){if(u instanceof io){const u={fragDownloadSlow:!0,fragDownloadTooSlow:!0};e.setFragLoadSlow(u)}throw u}e.setFragLoadSlow(f)}return!1}function Jg(e,t,i,r,n,a,s,o){var l=e["mediaFragmentCacheEntity"];{var o,l,n,t,l;r&&(l.switchPosition=o.currentTime,l.flushBeforeAppend={start:0,end:Number.POSITIVE_INFINITY}),l.triggerEvent=n,null!=t&&(r=t,{mediaLibraryService:o,rootPlaylistQuery:l,mediaSink:n,config:t}=i,l=l.itemId,null==r||!n.mediaQuery.isIframeRate&&r.iframeMode||(n=e["mediaFragmentCacheEntity"])&&!fe(n.iframeMediaDuration)&&(performance.now(),o.updatePTSDTS(l,n.mediaOptionId,r,n,t.liveAllowLowLatencyPlayback)))}var o=i,l=a,r=s,{statsService:n,rtcService:t}=o,{mediaFragmentCacheEntity:i,initSegmentParseStats:a,dataSegmentParseStats:s}=e,{largestVideoSampleSize:d,startPts:u,endPts:c}=i,s=s["tbegin"],h=performance.now(),c={durationSec:_(c,u),parseTimeMs:h-s,tparsed:{tbegin:s,tend:h},fragId:l,type:r};return n.updateFragEstimate(c),null!=t&&t.report(cs,{largestVideoSampleSize:d,initFragSample:a&&{tparsed:a},fragSample:c}),Ug(o,i.mediaOptionType,fm(i),"parsed",null),[e.initSegmentCacheEntity,e.mediaFragmentCacheEntity]}function Zg(i,u,e,r,n,a){const{mediaSink:t,rootPlaylistQuery:s,config:c,mediaLibraryService:o,statsService:h}=u;if(e&&null!=e.foundFrag){const i=t.mediaQuery,h=e.foundFrag["mediaFragment"],{itemId:l,mediaOptionId:d,mediaOptionType:p}=h,m=xg(u,h.keyTagInfo,{itemId:l,mediaOptionId:d,mediaOptionType:p,appItemId:s.appItemId}),f={getData:!1,cb:Xg.bind(null,u,fm(h),r===we.Variant?i.waterLevelForType(B.Variant):void 0),samplePeriodMs:c.abrSamplePeriodMs},g=o.retrieveMediaFragmentCacheEntity(u,r,e,f);const y=t.mediaQuery.isIframeRate,v=e.foundFrag.mediaFragment.discoSeqNum,I=sh(h);return e=r===we.Variant?g.pipe(ve(e=>{var t=function(t,i,r){var n;if(!i)return null;const{rootPlaylistService:a,rootPlaylistQuery:s,mediaLibraryService:e}=t,o=s.itemId,{mediaOptionId:l,iframe:d}=i,u=e.getQueryForOption(i);let c=s.getInitPTS(r);if(!c||!d&&c.iframeMode||i.mediaOptionId!==c.mediaOptionId&&null!=(n=u.mediaOptionDetails)&&n.liveOrEvent){const h=null!=(t=i.startDtsTs)?t:null;if(null==h)return null;let e=null!=(t=i.timelineOffset)?t:0;d&&(e=null!=(t=i.iframeOriginalStart)?t:0),h.timescale<1e3&&(h.timescale=1e3*h.timescale,h.baseTime=1e3*h.baseTime);const n=x(e,h.timescale),s={variantDTS:h,timelineOffset:e,offsetTimestamp:{baseTime:h.baseTime-n.baseTime,timescale:h.timescale},iframeMode:d,mediaOptionId:l};a.setInitPTS(o,r,s),c=s}return c}(u,e.mediaFragmentCacheEntity,v);return Jg(e,y?void 0:t,u,n,a,I,r,i)})):y?g.pipe(ve(e=>Jg(e,void 0,u,n,a,I,r,i))):Pn([g,ol(s.initPTS$(v),e=>null!=e&&(y||!e.iframeMode))]).pipe(ve(([e,t])=>Jg(e,t,u,n,a,I,r,i))),Pn([m,e]).pipe(ve(e=>{{var t,i,r,n,a,s,o,l,d;c.attemptNextFragPreload&&(t=u,i=h,{config:a,mediaSink:s,mediaLibraryService:o,rootPlaylistQuery:l,statsService:d}=t,i.iframe||i.part||(s=s.mediaQuery,d=d.getQueryForId(l.statsId),l=Ks(i.mediaOptionType),l=s.getCurrentWaterLevelByType(l,a.maxBufferHole),r=s.getBufferInfo(s.desiredPos,a.maxBufferHole)[i.mediaOptionType].buffered,{lowWaterLevelSeconds:r,highWaterLevelSeconds:a,stopStreamingHighWaterLevelSeconds:n}=Hg(s.desiredPos,r,i,a.maxBufferHole,s),r=qg(r,a,n,s),a=d.getBufferEstimate().avgDataFragAppendMs,n=l+i.duration-a/1e3,null!=l&&r<=n)||(s=o.getQueryForOption(i).mediaOptionDetails)&&(d=Oc(s.fragments,i.mediaSeqNum+1))&&o.cacheFrag(t,d))}return e[1]}))}return sl}function ey(i,v,r,n){const{rootPlaylistQuery:a,mediaSink:e,config:I,mediaLibraryService:S}=v,b=e.mediaQuery,s=b.isIframeRate,T=a.isInterstitial;if(n.every(e=>null==(null==e?void 0:e[0])&&null==(null==e?void 0:e[1])))return null;const A=[null,null],o=a.getInitPTS(r),E=[null,null];if(n.every(e=>null==(null==e?void 0:e[1])))return n.forEach((t,i)=>{if(t){var[t]=t;let e=NaN;t&&(e=S.getQueryForOption(t).playlistDuration),A[i]={initSeg:t,dataSeg:void 0,offsetTimestamp:void 0,duration:e}}}),{appendDataTuple:A,initPTSInfo:o,inFlightFrags:E};if(null==o)return null;var r=n[we.Variant],l=null==r?void 0:r[1];if(l&&l.iframe!==s)return null;if(r){const[i,v]=r;let e=o.offsetTimestamp;if(s){const i=v.startDtsTs,n=v.timelineOffset,a=Math.round(n*i.timescale);e={baseTime:i.baseTime-a,timescale:i.timescale}}let t=NaN;v&&(t=S.getQueryForOption(v).playlistDuration),A[B.Variant]={initSeg:i,dataSeg:v,offsetTimestamp:e,duration:t}}l=n[we.AltAudio];if(null!=l){const[i,v]=l;let e=NaN,t=(v&&(e=S.getQueryForOption(v).playlistDuration),o.offsetTimestamp);if(s){const i=b.getBufferInfo(b.desiredPos,0)[B.AltAudio].buffered.end,r=v.startPts,a=x(i,r.timescale);t={baseTime:r.baseTime-a.baseTime,timescale:r.timescale}}A[B.AltAudio]={initSeg:i,dataSeg:v,offsetTimestamp:t,duration:e}}const O=e.isCompatibleWithSourceBuffers(A).compatible;return A.forEach((e,t)=>{var i,r=null==e?void 0:e.dataSeg;if(r){var{itemId:n,mediaOptionId:a,mediaSeqNum:s,discoSeqNum:o,startPts:l,endPts:d,duration:u,isLastFragment:c,part:h,partIndex:p}=r,e=e["offsetTimestamp"],l=_(l,e),d=_(d,e),e=S.getQueryForOption(r),m=null!=r.iframeMediaDuration,f=(b.getBufferedRangeByType(t),A[0]),g=!f||!f.dataSeg.dropped,y=b.getBufferInfo(l,I.maxBufferHole,T?n:void 0);if(O&&g&&!r.flushBeforeAppend&&(null==(g=null==(i=y[t])?void 0:i.buffered)?void 0:g.len)>=d-l){let e;if(f){const v=l+(d-l)/2,i=b.getBufferedSegmentsByType(t).find(e=>e.startPTS<v&&e.endPTS>v);e=f.dataSeg.mediaOptionId===(null==i?void 0:i.frag.mediaOptionId)}if(!f||e)return A[t]=null,Ug(v,t,null,null,!1,!1),null}E[t]={start:l,duration:m?u:d-l,itemId:n,mediaOptionId:a,mediaSeqNum:s,discoSeqNum:o,targetDuration:e.mediaOptionDetails.targetduration,isLastFragment:c,mediaOptionType:t,part:h,partIndex:p}}return null}),E.every(e=>!e)?null:{appendDataTuple:A,inFlightFrags:E,initPTSInfo:o}}function ty(e,t,i,r){if(200===t&&r&&10<r.length){if(Wf.isValidPlaylist(r))return!0;{const t=new j(K.NETWORK_ERROR,q.MANIFEST_PARSING_ERROR,!0,pe.PlaylistErrorMissingEXTM3U);throw t.url=e,t}}return!1}function iy(e){return!e.iframes||!e.width||!e.height||e.width*e.height<=2488320}function ry(y,v,I,S,b){return ni(this,void 0,void 0,function*(){if(0===y.length)return{hdrMediaOptions:[],sdrMediaOptions:[],imageIframeVariants:[]};try{const c=(null==I?void 0:I.maxHdcpLevel)||void 0,j=null==I?void 0:I.maxSecurityLevel,h=null==S?void 0:S.keySystemPreference,p=e=>!0;let e=p,t=(0<S.disableAudioCodecList.size&&(e=t=>{{var i=S.disableAudioCodecList;let e=!0;return e=!t.iframes&&t.audioCodec?t.audioCodecList.every(e=>{e=kc(e);return!i.has(e)}):e}}),p),i=(0<S.disableVideoCodecList.size&&(t=t=>{{var i=S.disableVideoCodecList;let e=!0;return e=t.videoCodec?t.videoCodecList.every(e=>{e=Pc(e);return!i.has(e)}):e}}),p),r=(c&&Vu.isRestrictedLevel(c)&&(i=e=>{return t=c,e=e.hdcpLevel,!Vu.isRestrictedLevel(e)||Vu.isAllowed(e,t);var t}),p);j&&h&&nc(j,h)&&(r=t=>{{var i=j,r=h;function n(e){return nc(e,r)?a[e]:-1}const a=jl.getKeySystemSecurityLevel(r),s=jl.getKeySystemFormat(r),o=n(i),l=t.allowedCPCMap;if(!l)return!0;let e=!0;for(const i of null!=(t=l[s])?t:[])if(e=n(i)<=o,!e)break;return e}});const m=[],f=(t,i,e,r)=>{let n=0,a=0;for(let e=0;e<i.length;e++){const r=i[e];r&&!t(r)?(i[e]=void 0,n++):!1===(null==r?void 0:r.iframes)&&a++}if(m.push([e,n]),0===a)throw new A(r,m)};let n=[...y];for(const{filterFn:y,filterName:v,errResponse:I}of[{filterFn:e,errResponse:pe.UnsupportedAudioCodec,filterName:hu.AudioCodec},{filterFn:t,errResponse:pe.UnsupportedVideoCodec,filterName:hu.VideoCodec},{filterFn:i,errResponse:pe.UnsupportedHDCPLevel,filterName:hu.HdcpLevel},{filterFn:r,errResponse:pe.UnsupportedSecurityLevel,filterName:hu.SecurityLevel}])f(y,n,v,I);if(n=n.filter(e=>null!=e),null!=S&&S.useMediaKeySystemAccessFilter&&h&&navigator&&"function"==typeof navigator.requestMediaKeySystemAccess){const y=n.length,v=[],I=new Map;for(const y of n)if(y.iframes&&y.imageCodec)v.push(Promise.resolve(y));else{const S=rl.getCapabilities(y.videoCodecList,y.audioCodecList),g=JSON.stringify(S);let e=I.get(g);e||(e=function(n,a){var s="object"==typeof a;return new Promise((e,t)=>{var i,r=!1;n.subscribe({next:e=>{i=e,r=!0},error:t,complete:()=>{r?e(i):s?e(a.defaultValue):t(new _r)}})})}(jl.requestKeySystemAccess(h,S,void 0,b,null)).then(()=>!0).catch(e=>!1),I.set(g,e));const A=e.then(e=>e?y:null);v.push(A)}if(n=(n=yield Promise.all(v)).filter(e=>null!=e),m.push([hu.KeySystemAccess,y-n.length]),0===n.length||oc(n))throw new A(pe.UnsupportedKeySystemAccess,m)}let a=n.filter(e=>e.iframes&&e.imageCodec);var o=navigator&&navigator.mediaCapabilities,l=!(null==S||!S.useMediaCapabilities)&&o&&"function"==typeof o.decodingInfo;if(l){const y=n.length;if(n=yield function(s){var o;return ni(this,void 0,void 0,function*(){const e=ic(),t=function(){const d=new Map,u=navigator&&navigator.mediaCapabilities;return(i,e,t,r)=>{var n,a,s={type:"media-source"},o=(t?s.video=function(e){var t={contentType:`video/mp4;codecs=`+e,width:i.width,height:i.height,bitrate:i.bandwidth||i.avgBandwidth,framerate:i.iframes?8:i.frameRate};if(i.videoRange)switch(i.videoRange){case"PQ":ge.isDolby(e)?(t.hdrMetadataType=jf.DoVi,t.colorGamut="rec2020"):(ge.isHEVC(e)||ge.isVP09(e)||ge.isAV1(e))&&(t.hdrMetadataType=jf.HDR10,t.colorGamut="rec2020"),t.transferFunction="pq";break;case"HLG":t.colorGamut="rec2020",t.transferFunction="hlg"}return t}(e):s.audio=(n=i,a={contentType:`audio/mp4;codecs=`+(e=e)},n=Pf.getAlternateWithRichestChannelLayoutForGroupId(n.audioAlternates),(o=null==n?void 0:n.channels)&&(a.channels=ge.getChannelCount(o).toString(),a.spatialRendering=ge.isDolbyAtmos(e,o)),(e=null==n?void 0:n.sampleRate)&&(a.samplerate=e),a),JSON.stringify(s));let l;d.has(o)?l=d.get(o):(l=u&&"function"==typeof u.decodingInfo?u.decodingInfo(s).then(e=>!e||e.supported&&(!t||e.powerEfficient)):Promise.resolve(!0),d.set(o,l)),r.push(l)}}();let i={};var r=[];for(const a of s)if(e(a)){const s=[Promise.resolve(!0)];if(null!=(o=a.videoCodecList)&&o.length)for(const e of a.videoCodecList)t(a,e,!0,s);if(0<(null==(o=a.audioCodecList)?void 0:o.length)){const e=Pf.getRichestAudioCodec(a.audioCodecList);t(a,e,!1,s),i.richestAudioCodec=e}var n=Promise.all(s).catch(e=>[!1]).then(e=>e.every(e=>e)?a:null);r.push(n)}else i={audioCodecList:a.audioCodecList,videoCodecList:a.videoCodecList};return(yield Promise.all(r)).filter(e=>null!=e)})}(n),m.push([hu.MediaCapabilities,y-n.length]),0===n.length||oc(n))throw new A(pe.UnsupportedByMediaCapabilities,m)}else{const y=ic(),v=e=>y(e),I=function(){const s=new Set,o=new Set,l=Ju(),d=!l.isTypeSupported('audio/mp4; codecs="mp4a.40.2"; channels="-1"'),u=d&&!l.isTypeSupported('audio/mp4; codecs="mp4a.40.2"; channels="2"; features="INVALID"');let r;return e=>{let t=!1;var i;return e.audioCodecList&&e.audioAlternates&&(i=null==(i=Pf.getAlternateWithRichestChannelLayoutForGroupId(e.audioAlternates))?void 0:i.channels,0<e.audioCodecList.length)&&i&&(e=Pf.getRichestAudioCodec(e.audioCodecList),t=((e,t)=>{var i,r,n,a=ge.isDolbyAtmos(e,t);if(u||d&&!a){n=(i=e)+`/`+(r=t),s.has(n)||o.has(n)||(((e,t)=>{var i=t.split("/"),r=parseInt(i[0]);let n,a;if(1<i.length){const t=i[1].split(",")[0];n=`audio/mp4;codecs="${e}";channels="${r}";features="${t}"`,a=`audio/mp4;codecs="${e}";channels="8";features="${t}"`}else n=`audio/mp4;codecs="${e}";channels="${r}"`;let s=l.isTypeSupported(n);return s=!s&&a?l.isTypeSupported(a):s})(i,r)?s:o).add(n);const d=e+`/`+t;return o.has(d)}return!!a})(e,i))&&(r={richestCodec:e,channels:i}),!t}}();f(e=>v(e)&&I(e),n,hu.MediaSource,pe.UnsupportedByMediaSource)}f(e=>iy(e)&&function(e,t){var i=0<(null==v?void 0:v.length),e=e?(a=null!=(a=t.videoCodec)?a:"",n=t.videoRange,r=e.videoDynamicRangeFormats,e=e.videoCodecs,a=function(e,t,i,r){if(!r&&!i)return{};i=i?rc(i,t):{},t=r?rc(r,e):{};let n,a;a=e===at.SDR?(n=i,t):(n=t,i);var s=Object.assign({},n),o=a,l={},r=Object.entries(s);for(const[s,o]of r)!fe(o)&&"object"!=typeof o||(l[s]=o);return Object.assign(Object.assign({},o),l)}(ge.getDynamicRangeType(n,a),n=ge.getCompressionType(a),e,r),n!==st.VP09&&(a.highestPlayablePeakBitRateForClearContent=void 0),a):{highestPlayableAverageBitRate:void 0,highestPlayablePeakBitRate:void 0,highestPlayableWidth:void 0,highestPlayableHeight:void 0,highestPlayableFrameRate:void 0},{highestPlayablePeakBitRateForClearContent:r,highestPlayablePeakBitRate:n,highestPlayableAverageBitRate:a}=e,s=t.frameRate,o=sc(a,s),l=sc(n,s),s=sc(r,s),i=t.allowedCPCMap||i,l=ac(t.bandwidth,l);return(i||!r?l:l||ac(t.bandwidth,s))&&ac(t.avgBandwidth,o)&&ac(t.width,e.highestPlayableWidth)&&ac(t.height,e.highestPlayableHeight)&&ac(t.frameRate,e.highestPlayableFrameRate)}(I,e),n,hu.PlatformCaps,pe.UnsupportedByPlatformCaps),n=n.filter(e=>null!=e),a=a.filter(e=>iy(e));let s=(null==I?void 0:I.videoDynamicRangeFormats)||[];l&&0===s.length&&(s=[{type:at.SDR},{type:at.HDR},{type:at.HDR10},{type:at.DolbyVision},{type:at.HLG}]);var{hdrMediaOptions:d,sdrMediaOptions:u}=function(e,i){var t,{doViSupported:r,hdr10Supported:n,hlgSupported:a}=function(){var e={doViSupported:!1,hdr10Supported:!1,hlgSupported:!1};for(const t of i)switch(t.type){case at.DolbyVision:e.doViSupported=!0;break;case at.HDR10:e.hdr10Supported=!0;break;case at.HLG:e.hlgSupported=!0}return e}(),s={hdrMediaOptions:new Array,sdrMediaOptions:new Array};for(const i of e)switch(ge.getDynamicRangeType(i.videoRange,null!=(t=i.videoCodec)?t:"")){case at.HDR:case at.HDR10:n&&s.hdrMediaOptions.push(i);break;case at.DolbyVision:r&&s.hdrMediaOptions.push(i);break;case at.HLG:a&&s.hdrMediaOptions.push(i);break;default:"SDR"!==i.videoRange&&null!=i.videoRange||s.sdrMediaOptions.push(i)}return s}(n,s);if(m.push([hu.VideoRange,n.length-(d.length+u.length)]),0===d.length&&0===u.length||oc(d)&&oc(u))throw new A(pe.UnsupportedVideoDynamicRange,m);return{hdrMediaOptions:d,sdrMediaOptions:u,imageIframeVariants:a}}catch(e){throw e instanceof j&&(e.fatal=!0,e.response=pe.IncompatibleAsset),e}})}(As=jf=jf||{}).HDR10="smpteSt2086",As.DoVi="smpteSt2094-10",As.HDR10Plus="smpteSt2094-40";class ny extends Gm{constructor(e,t,i,r,n){super(e,t,i),this.Ic=r,this.R=n}static makeFilters(){return $m()}_initFilters(){return ny.kAllowFilters}get Tc(){return this.mediaOptionType}get mediaOptionListInfo(){var e;return null!=(e=null==(e=this.getEntity(this.itemId))?void 0:e.mediaOptionListTuple[this.Tc])?e:null}get mediaOptionListInfo$(){return this.selectEntity(this.itemId,e=>e&&e.mediaOptionListTuple?e.mediaOptionListTuple[this.Tc]:null).pipe(Yl())}getMatchingAlternateWithPersistentId(e,i,t,r,n){if(!t)return null;var a=this.Tc,s=Hu(a===we.AltAudio?t.audioAlternates:t.subtitleAlternates,ny.kAllowFilters,this.mediaOptionListInfo);if(a===we.Subtitle||n)return null!=(a=s.find((e,t)=>!(0<(null==r?void 0:r.length)&&r.includes(e.mediaOptionId)||fe(i)&&e.persistentID!==i)))?a:null;const o=ge.getStickyAtmosStatus(this.Ic.useStickyAtmosFilter,t.audioCodec,null==e?void 0:e.channels);let l=null;a=null!=(n=s.find((e,t)=>!(0<(null==r?void 0:r.length)&&r.includes(e.mediaOptionId)||fe(i)&&e.persistentID!==i||(l=l||e,null!=o&&o!==ge.isJOCChannels(e.channels)))))?n:null;return!a&&o?l:a}getMatchingAlternate(e,t){e=this.mediaOptionFromId(e);return this.getMatchingAlternateWithPersistentId(e,null==e?void 0:e.persistentID,t,[],!1)}packageAlternateMediaOption(e,t){var i=null!=(i=null==(i=this.getEntity(this.itemId))?void 0:i.mediaOptionListTuple[we.Subtitle])?i:null,e=Hu(null!=(e=null==e?void 0:e.subtitleAlternates)?e:[],ny.kAllowFilters,i);return t.mediaType===Is.CLOSEDCAPTION?this.Oc(e,t):t}Oc(e,t){e=this.kc(t,e);return e?Object.assign(Object.assign({},t),{url:e.url,relativeUrl:e.relativeUrl,backingMediaOptionId:e.mediaOptionId}):t}kc(e,t){let i;return i=e&&e.mediaType===Is.CLOSEDCAPTION?ny.pairForcedSubtitleMediaOptionWithClosedCaptionInList(e,t,this.R):i}static pairForcedSubtitleMediaOptionWithClosedCaptionInList(t,e,i){return e.find(function(e){return e.mediaType===Is.SUBTITLE&&e.lang===t.lang&&e.forced&&e.autoselect})}}ny.kAllowFilters=ny.makeFilters();class ay extends xc{constructor(e){super(),this.pathwayPriority=e,this.id=Re.PathwayFilter,this.initFn=e=>({pathwayRanking:uc(this.pathwayPriority)}),this.firstPassFn=(e,t,i,r)=>{var n=r.pathwayRanking(e.pathwayID);(null==r.selectedPathwayRanking||n>r.selectedPathwayRanking)&&(r.selectedPathway=e.pathwayID,r.selectedPathwayRanking=n)},this.filterFn=(e,t,i,r)=>e.pathwayID===r.selectedPathway}}class sy extends ga{constructor(e,t,i,r){super(e),this.Mc=e,this.itemId=t,this.logger=r,this.Ac=[],this.mediaOptionListQueries=[new Xm(e,this.itemId),new ny(e,this.itemId,we.AltAudio,i,this.logger),new ny(e,this.itemId,we.Subtitle,i,this.logger)]}get rootPlaylistEntity(){return this.getEntity(this.itemId)}get parentItemId(){var e;return null==(e=this.rootPlaylistEntity)?void 0:e.parentItemId}get statsId(){var e;return null==(e=this.rootPlaylistEntity)?void 0:e.statsId}get appItemId(){var e;return null==(e=this.rootPlaylistEntity)?void 0:e.appItemId}get rootMediaOptionsTuple(){var e=null==(e=this.rootPlaylistEntity)?void 0:e.mediaOptionListTuple;return e?[e[0].mediaOptions,e[1].mediaOptions,e[2].mediaOptions]:[[],[],[]]}get itemStartOffsets(){var e;return null!=(e=this.rootPlaylistEntity)&&e.itemStartOffsets?this.rootPlaylistEntity.itemStartOffsets.map(e=>fe(e)?e:0):[0,0]}get itemStartPosition(){return this.itemStartOffsets[0]}get startTimeOffset(){var e;return null==(e=this.rootPlaylistEntity)?void 0:e.startTimeOffset}get highestVideoCodec(){var e;return null==(e=this.rootPlaylistEntity)?void 0:e.highestVideoCodec}get baseUrl(){var e;return null==(e=this.rootPlaylistEntity)?void 0:e.baseUrl}get avAnchor(){var e;return null==(e=this.rootPlaylistEntity)?void 0:e.avAnchor}get audioMediaSelectionGroup(){var e;return null!=(e=null==(e=this.rootPlaylistEntity)?void 0:e.audioMediaSelectionGroup)?e:null}get subtitleMediaSelectionGroup(){var e;return null!=(e=null==(e=this.rootPlaylistEntity)?void 0:e.subtitleMediaSelectionGroup)?e:null}get audioMediaSelectionOptions(){var e;return null!=(e=null==(e=null==(e=this.rootPlaylistEntity)?void 0:e.audioMediaSelectionGroup)?void 0:e.MediaSelectionGroupOptions)?e:[]}get subtitleMediaSelectionOptions(){var e;return null!=(e=null==(e=null==(e=this.rootPlaylistEntity)?void 0:e.subtitleMediaSelectionGroup)?void 0:e.MediaSelectionGroupOptions)?e:[]}get contentSteeringOption(){var e;return null==(e=this.rootPlaylistEntity)?void 0:e.contentSteeringOption}get masterVariableList(){var e;return null==(e=this.rootPlaylistEntity)?void 0:e.masterVariableList}get loadStats(){var e;return null==(e=this.rootPlaylistEntity)?void 0:e.loadStats}get isMediaPlaylist(){var e;return null==(e=this.rootPlaylistEntity)?void 0:e.isMediaPlaylist}getInitPTS(e){var t;return null==(t=this.rootPlaylistEntity)?void 0:t.initPtsRecord[e]}initPTS$(t){return this.selectEntity(this.itemId,({initPtsRecord:e})=>e[t])}get rootPlaylistEntity$(){return this.selectEntity(this.itemId).pipe(Yl())}get rootPlaylistEntityAdded$(){return this.selectEntityAction(qn.Add).pipe(ve(e=>e.map(e=>this.getEntity(e))))}get rootMediaOptionsTuple$(){return this.selectEntity(this.itemId,e=>[e.mediaOptionListTuple[0].mediaOptions,e.mediaOptionListTuple[1].mediaOptions,e.mediaOptionListTuple[2].mediaOptions])}get sessionData(){var e;return null==(e=this.rootPlaylistEntity)?void 0:e.sessionData}get sessionData$(){return this.selectEntity(this.itemId,({sessionData:e})=>e).pipe(Yl())}get avAnchor$(){return this.selectEntity(this.itemId,"avAnchor")}get enabledMediaOptionKeys$(){return this.selectEntity(this.itemId,"enabledMediaOptionKeys").pipe(Yl())}get enabledMediaOptionKeys(){var e;return null!=(e=null==(e=this.getEntity(this.itemId))?void 0:e.enabledMediaOptionKeys)?e:[Me,Me,Me]}get enabledMediaOptionSwitchContexts(){var e;return null!=(e=null==(e=this.getEntity(this.itemId))?void 0:e.mediaOptionSwitchContexts)?e:[null,null,null]}get enabledMediaOptions$(){return br([this.enabledMediaOptionByType$(we.Variant),this.enabledMediaOptionByType$(we.AltAudio),this.enabledMediaOptionByType$(we.Subtitle)])}Ec(t){let e=this.Ac[t];return e=e||(this.Ac[t]=this.selectEntity(this.itemId,e=>{var e=e.enabledMediaOptionKeys[t];return Bs(e)&&(e=this.enabledMediaOptionKeys[t]["mediaOptionId"],null!=(e=this.mediaOptionListQueries[t].mediaOptionFromId(e)))?e:Me}).pipe(Yl(),en({bufferSize:1,refCount:!0})))}enabledMediaOptionByType$(e){return this.Ec(e).pipe(Te((e,t)=>e.mediaOptionId===t.mediaOptionId&&e.relativeUrl===t.relativeUrl))}enabledMediaOptionSwitchForType$(r){return this.Ec(r).pipe(Xl(void 0,(e,t)=>(null==e?void 0:e.mediaOptionId)===(null==t?void 0:t.mediaOptionId),([e,t])=>{var i=null==(i=this.enabledMediaOptionSwitchContexts)?void 0:i[r];return{fromId:null==e?void 0:e.mediaOptionId,toId:null==t?void 0:t.mediaOptionId,switchContext:i}}))}enabledMediaOptionsSwitchInfo$(){return this.hasAlternateWithUrl(we.AltAudio)?this.selectEntity(this.itemId,i=>Hs.map(e=>{let t=i.enabledMediaOptionKeys[e];return{option:t=Bs(t)?t:Me,switchContext:i.mediaOptionSwitchContexts[e]}})).pipe(Xl(void 0,(e,i)=>e&&i&&e.every((e,t)=>e.option.mediaOptionId===i[t].option.mediaOptionId),([t,i])=>Hs.map(e=>({fromId:null==t?void 0:t[e].option.mediaOptionId,toId:null==i?void 0:i[e].option.mediaOptionId,switchContext:null==i?void 0:i[e].switchContext})))):br([this.enabledMediaOptionSwitchForType$(we.Variant),be({fromId:void 0,toId:Fs.mediaOptionId,switchContext:void 0})])}enabledMediaOptionIdByType(e){var t;return null==(t=this.getEntity(this.itemId))?void 0:t.enabledMediaOptionKeys[e].mediaOptionId}get enabledMediaOptionsBeforeTrickplay(){var e;return null==(e=this.getEntity(this.itemId))?void 0:e.enabledMediaOptionsBeforeTrickplay}variantMediaOptionById(e){return this.mediaOptionListQueries[we.Variant].mediaOptionFromId(e)}alternateMediaOptionById(e,t){return this.mediaOptionListQueries[e].mediaOptionFromId(t)}enabledAlternateMediaOptionByType(e){var t=this.enabledMediaOptionIdByType(e);return this.alternateMediaOptionById(e,t)}enabledMediaSelectionOptionByType(e){const t=this.enabledAlternateMediaOptionByType(e);return(e===we.AltAudio?this.audioMediaSelectionOptions:this.subtitleMediaSelectionOptions).find(e=>e.MediaSelectionOptionsPersistentID===t.persistentID)}get enabledVariantMediaOption(){var e=this.enabledMediaOptionIdByType(we.Variant);return this.variantMediaOptionById(e)}get enabledVariantMediaOption$(){return this.enabledMediaOptionKeys$.pipe(ve(e=>{var e=e[we.Variant];return Bs(e)&&null!=(e=this.mediaOptionListQueries[we.Variant].mediaOptionFromId(e.mediaOptionId))?e:Me}))}get filteredMediaOptions$(){return br([this.mediaOptionListQueries[0].getFilteredMediaOptionList$(),this.mediaOptionListQueries[1].getFilteredMediaOptionList$(),this.mediaOptionListQueries[2].getFilteredMediaOptionList$()])}getDisabledMediaOption(e){return{itemId:this.itemId,mediaOptionType:e,mediaOptionId:"Nah",relativeUrl:void 0}}getEnabledMediaOptionMask(){return this.enabledMediaOptionKeys.map(e=>Bs(e))}get isInterstitial(){var e=null==(e=this.getEntity(this.itemId))?void 0:e.interstitialId;return!!e&&0<e.length}get interstitialId(){var e;return null==(e=this.getEntity(this.itemId))?void 0:e.interstitialId}get interstitialAssetId(){var e;return null==(e=this.getEntity(this.itemId))?void 0:e.interstitialAssetId}altMediaOptionHasValidUrl(e,t){return Us(this.alternateMediaOptionById(e,t))}hasAlternateWithUrl(e){return this.mediaOptionListQueries[e].hasOptionWithUrl}hasClosedCaption(){return!!this.rootMediaOptionsTuple[we.Subtitle].some(e=>e.mediaType===Is.CLOSEDCAPTION)}get hdrMode$(){return this.mediaOptionListQueries[we.Variant].hdrMode$}get pathwayPenaltyBox$(){return this.mediaOptionListQueries[we.Variant].pathwayPenaltyBoxChanged$}get viewportInfo$(){return this.mediaOptionListQueries[we.Variant].viewportInfo$}get variantRemoved$(){return this.mediaOptionListQueries[we.Variant].removedListChanged$}get variantCompatibleIds$(){return this.mediaOptionListQueries[we.Variant].compatibleIdsListChanged$}get variantPenaltyBox$(){return this.mediaOptionListQueries[we.Variant].penaltyBoxChanged$}get combinedVariantFilterChange$(){return this.mediaOptionListQueries[we.Variant].commonFilterParamChanges$}get combinedAltAudioFilterChange$(){return this.mediaOptionListQueries[we.AltAudio].commonFilterParamChanges$}get combinedSubtitleFilterChange$(){return this.mediaOptionListQueries[we.Subtitle].commonFilterParamChanges$}get maxHdcpLevel$(){return this.mediaOptionListQueries[we.Variant].maxHdcpLevel$}get currentPathwayID(){var e;return null==(e=this.enabledVariantMediaOption)?void 0:e.pathwayID}get currentPathwayID$(){return this.enabledVariantMediaOption$.pipe((i="pathwayID",Te((e,t)=>e[i]===t[i])),ve(e=>e.pathwayID));var i}getErrorInfoByType(e){var t;return null==(t=null==(t=this.rootPlaylistEntity)?void 0:t.errorsByType)?void 0:t[e]}getInFlightFrags(){return[this.Mc.inFlightFragTuple[0].value,this.Mc.inFlightFragTuple[1].value]}getInFlightFragByType(e){return e!==we.Subtitle&&null!=(e=this.getInFlightFrags()[e])?e:null}getInFlightFragByType$(e){return e===we.Subtitle?sl:this.Mc.inFlightFragTuple[e]}matchAlternates(e,t,i,r){var n=this.enabledAlternateMediaOptionByType(we.AltAudio),a=(null==n?void 0:n.persistentID)!==t,n=fe(t)?this.mediaOptionListQueries[we.AltAudio].getMatchingAlternateWithPersistentId(n,t,e,r,a):void 0,t=this.enabledAlternateMediaOptionByType(we.Subtitle),a=fe(i)?this.mediaOptionListQueries[we.Subtitle].getMatchingAlternateWithPersistentId(t,i,e,r,!1):void 0;return[n||Me,a||Me]}getLegacyMatchingAlternateWithPersistentId(e,t,i){var r=this.enabledAlternateMediaOptionByType(e),n=e===we.AltAudio&&(null==r?void 0:r.persistentID)!==t;let a=this.mediaOptionListQueries[e].getMatchingAlternateWithPersistentId(r,t,i,[],n);return a=a||this.mediaOptionListQueries[e].getMatchingAlternateWithPersistentId(r,t,void 0,[],n)}isValidMediaOptionTuple(i,e=void 0){const r=e||this.getEnabledMediaOptionMask();return[we.Variant,we.AltAudio,we.Subtitle].reduce((e,t)=>e&&r[t]===Bs(i[t]),!0)}matchGroup(t,i,r,n){{var a=t,s=i,o=r,l=n;let e=!1;switch(a.type){case"CLOSED-CAPTIONS":e=!l||a.groupId===l;break;case"SUBTITLES":e=!o||a.groupId===o;break;case"AUDIO":e=!s||a.groupId===s}return e}}get preferHDR(){return this.mediaOptionListQueries[we.Variant].mediaOptionListInfo.preferHDR}get hasHdrLevels(){return this.mediaOptionListQueries[we.Variant].mediaOptionListInfo.hasHdrLevels}}class oy extends ua{constructor(){super({},{name:"root-playlist-store",idKey:"itemId",resettable:!0}),this.inFlightFragTuple=[new jr(void 0),new jr(void 0)]}setInFlightFrag(e,t){this.inFlightFragTuple[e].next(t)}}function ly(e,t){t=Ka(e,t);return e.url!==t?Object.assign(Object.assign({},e),{url:t,relativeUrl:t}):e}(Ss=$f=$f||{})[Ss.NoMatch=0]="NoMatch",Ss[Ss.BaseNameMatch=1]="BaseNameMatch",Ss[Ss.LanguageTagMatch=2]="LanguageTagMatch";class dy{constructor(e,t,i,r,n,a,s,o){this.Me=e,this.hlsService=t,this.logger=i,this.Zt=r,this.rtcService=n,this.Nc=a,this.mediaSelectionBossService=s,this.Rc=o,this.Iu=new Map,this.abrController=new mf,this._i=new ga(e)}isContentSteeringEnabled(){return this.Zt.enableContentSteering}get query(){return this._i}getQueryForId(e){let t=this.Iu.get(e);return t||(t=new sy(this.Me,e,this.Zt,this.logger),this.Iu.set(e,t)),t}removeItems(e){this.Me.remove(e);Array.isArray(e)?e.forEach(e=>{this.Iu.get(e)&&this.Iu.delete(e)}):this.Iu.get(e)&&this.Iu.delete(e);for(const e of[])e.dispose()}removeAll(){this.Me.remove(),this.Iu.forEach(e=>{e.mediaOptionListQueries.forEach(e=>e.dispose())}),this.Iu.clear(),this.abrController.reset(this.logger),this.Me.reset()}setRootPlaylistEntity(e,t){Oe(()=>{this.query.hasEntity(e)?this.Me.replace(e,t):this.Me.add(t),this.setActive(e)})}setActive(e){const t=this.query.getActive();if(!t||e!==t.itemId){const t=this.query.getEntity(e);this.Pc(t)}this.Me.setActive(e)}setSessionData(e,t){this.Me.update(e,{sessionData:t})}setAVAnchor(e,t){this.Me.update(e,{avAnchor:t})}setEnabledMediaOptionSwitchContextByType(e,t,i,r){var n=this.getQueryForId(e);n.enabledMediaOptionKeys[t].mediaOptionId===i&&(i=null==(i=n.enabledMediaOptionSwitchContexts)?void 0:i[t],null!=r||null!=i)&&((i=n.rootPlaylistEntity?[...n.rootPlaylistEntity.mediaOptionSwitchContexts]:[null,null,null])[t]=null!=r?r:null,this.Me.update(e,{mediaOptionSwitchContexts:i}))}clearMediaOptionSwitchContextByType(e,t){var i=null==(i=this._i.getEntity(e))?void 0:i.mediaOptionSwitchContexts;null!=(null==i?void 0:i[t])&&((i=i.slice())[t]=null,this.Me.update(e,{mediaOptionSwitchContexts:i}))}saveEnabledOptionsForTrickplay(e,t){t=t?this.getQueryForId(e).enabledMediaOptionKeys:null;this.Me.update(e,{enabledMediaOptionsBeforeTrickplay:t})}setEnabledMediaOptionByType(e,t,i,r=!1,n=void 0){i=i||{itemId:e,mediaOptionId:"Nah"};var a=this.getQueryForId(e).rootPlaylistEntity;if(a){var[s,o,l]=null!=(s=a.enabledMediaOptionKeys)?s:[Fs,Fs,Fs],s=[s,o,l],o=(s[t]={itemId:e,mediaOptionId:i.mediaOptionId},this._c(a,s));if(r){const e=null!=(i=null==(l=a.mediaOptionSwitchContexts)?void 0:l.slice())?i:[null,null,null];e[t]=null!=n?n:null,o.mediaOptionSwitchContexts=e}this.Me.update(e,o)}}Cc(e,t,i,r){if((null==i?void 0:i.mediaType)===Is.CLOSEDCAPTION){t=r.variantMediaOptionById(t),r=r.mediaOptionListQueries[we.Subtitle].packageAlternateMediaOption(t,i);if(r.relativeUrl!==i.relativeUrl)return yy(t,r,e,this.logger)}return null}_c(i,e){var r,n;const a={mediaOptionListTuple:[...i.mediaOptionListTuple],enabledMediaOptionKeys:null!=(n=null==(r=i.enabledMediaOptionKeys)?void 0:r.slice())?n:[Fs,Fs,Fs]},s=a.enabledMediaOptionKeys;let o;for(let t=0;t<e.length;++t){const n=e[t],c=s[t].mediaOptionId!==n.mediaOptionId;c&&(s[t]=n,a.mediaOptionListTuple=uy(a.mediaOptionListTuple,t,{},e=>e.mediaOptionId===n.mediaOptionId?ly(e,i.baseUrl):e));var l=this.getQueryForId(n.itemId);if(t===we.Variant){const i=a.mediaOptionListTuple[we.Variant].mediaOptions.find(e=>e.mediaOptionId===s[t].mediaOptionId),e=(this.Zt.enableBoss&&this.mediaSelectionBossService.setTransformer(n.itemId,Re.HostRankFilter,new qc(null!=(d=i.url)?d:i.relativeUrl,l.baseUrl)),this.abrController);if(c){const e=a.mediaOptionListTuple[we.Variant],{mediaOptions:r,hasScore:n,pathwayPriority:d}=e,s=zm(r,{hasScore:n,pivotVariant:i,pathwayPriority:d,enableSteering:this.Zt.enableContentSteering,preferHostOverQuality:!0,preferCloseToPivotQuality:!1});s.some((e,t)=>r[t]!==e)&&(e.mediaOptions=s)}var d=l.mediaOptionListQueries[t].mediaOptionList,u=df(n.mediaOptionId,d);e.highBwTrigger=u,o=n}else if(t===we.Subtitle&&Bs(n)){const i=l.alternateMediaOptionById(t,n.mediaOptionId),e=this.Cc(a.mediaOptionListTuple[t].mediaOptions,o.mediaOptionId,i,l);e&&(a.mediaOptionListTuple[t]=Object.assign(Object.assign({},a.mediaOptionListTuple[t]),{mediaOptions:e}))}}return a}setManualMode(e,t){this.Me.update(e,{manualMode:t})}setEnabledMediaOptions(e,t){var i=this.getQueryForId(e).rootPlaylistEntity;i&&(t=t.map(({mediaOptionId:e,itemId:t})=>({mediaOptionId:e,itemId:t})),i=this._c(i,t),this.Me.update(e,i))}setEnabledMediaOptionsAndSwitchContexts(e,t,i){var r=this.getQueryForId(e).rootPlaylistEntity;r&&(t=t.map(({mediaOptionId:e,itemId:t})=>({mediaOptionId:e,itemId:t})),(r=this._c(r,t)).mediaOptionSwitchContexts=i,this.Me.update(e,r))}setViewportInfo(e,t){var i=this.getQueryForId(e).rootPlaylistEntity;i&&(i=uy(i.mediaOptionListTuple,we.Variant,{viewportInfo:t}),this.Me.update(e,{mediaOptionListTuple:i}))}static doUpdateRootHDRSwitch(e,t,i,r,n,a,s,o,l){a=uy(e.mediaOptionListTuple,we.Variant,{preferHDR:a,hasHdrLevels:s}),s=t.getQueryForId(e.statsId).getCombinedEstimate(l),t=vy(Object.assign(Object.assign({},e),{mediaOptionListTuple:a}));return Iy(t,null,i,r,n,o,l,s,!1),t}switchToSDROnly(e){var t;if(this.Zt.enableBoss){const i=new Map([[Re.HDRFilter,new _c(!1,!1)],[Re.CompatibleIdsFilter,new Fc(null)]]);null!=(t=this.mediaSelectionBossService)&&t.setMultipleTransformers(e,i)}const i=this.getQueryForId(e).rootPlaylistEntity,r=dy.doUpdateRootHDRSwitch(i,this.Nc,this.mediaSelectionBossService,this.hlsService,this.Rc,!1,!1,this.logger,this.Zt)["mediaOptionListTuple"];this.Me.update(e,{mediaOptionListTuple:r})}doPathwaySwitch(e,t,i){var e=this.getQueryForId(e),r=e.rootPlaylistEntity;r&&(t=t||r.mediaOptionListTuple[we.Variant].pathwayPriority)&&0<t.length&&(t=vy(r,t),r=this.Nc.getQueryForId(r.statsId).getCombinedEstimate(),Iy(t,null,this.mediaSelectionBossService,this.hlsService,this.Rc,this.logger,this.Zt,r,!0===(null==(r=e.enabledVariantMediaOption)?void 0:r.iframes),i),this.setRootPlaylistEntity(e.itemId,t))}setHDRPreference(e,t){var i,r,n=this.getQueryForId(e).rootPlaylistEntity,a=null==(a=null==n?void 0:n.mediaOptionListTuple)?void 0:a[we.Variant];!a||a.preferHDR===t||t&&!a.hasHdrLevels||(a=n.mediaOptionListTuple[we.Variant],i=new _c(a.hasHdrLevels,t),null!=(r=this.mediaSelectionBossService)&&r.setTransformer(e,Re.HDRFilter,i),r=dy.doUpdateRootHDRSwitch(n,this.Nc,this.mediaSelectionBossService,this.hlsService,this.Rc,t,a.hasHdrLevels,this.logger,this.Zt),this.Me.update(e,r))}setPathwayPriority(e,t){var i=this.getQueryForId(e).rootPlaylistEntity;i&&(i=uy(i.mediaOptionListTuple,we.Variant,{pathwayPriority:t}),this.Me.update(e,{mediaOptionListTuple:i}))}setInitPTS(e,t,i){var r=this.getQueryForId(e).rootPlaylistEntity;r&&((r=Object.assign({},r.initPtsRecord))[t]=i,this.Me.update(e,{initPtsRecord:r}))}static prunePenaltyBox(e,t){return e?e.filter(e=>e&&!(e.expiry<=t)):[]}static addToPenaltyBox(e,t,i,r=12e4){i={id:i,expiry:t+r};return null==e?[i]:e.push(i)}addToPenaltyBox(e,t,i){var r=this.getQueryForId(e).rootPlaylistEntity;if(r){var n=r.mediaOptionListTuple[t].penaltyBoxQueue,a=performance.now(),n=dy.prunePenaltyBox(n,a),a=(dy.addToPenaltyBox(n,a,i),uy(r.mediaOptionListTuple,t,{penaltyBoxQueue:n}));if(this.Me.update(e,{mediaOptionListTuple:a}),this.Zt.enableBoss){const i=new Bc([...this.getQueryForId(e).mediaOptionListQueries[t].mediaOptionListInfo.penaltyBoxQueue]);null!=(r=this.mediaSelectionBossService)&&r.setTransformer(e,Re.PenaltyBoxFilter,i)}}}addToPathwayPenaltyBox(e,t){var i=this.getQueryForId(e).rootPlaylistEntity;if(i){var r=performance.now(),n=i.mediaOptionListTuple[we.Variant].pathwayPenaltyBox.slice(),r=(dy.addToPenaltyBox(n,r,t.pathwayID,3e5),uy(i.mediaOptionListTuple,we.Variant,{pathwayPenaltyBox:n})),t=(this.Me.update(e,{mediaOptionListTuple:r}),this.Zt.enableBoss),i=this.Zt.enableContentSteering;if(t&&i){const t=new Uc(this.getQueryForId(e).mediaOptionListQueries[we.Variant].mediaOptionListInfo.pathwayPenaltyBox);null!=(n=this.mediaSelectionBossService)&&n.setTransformer(e,Re.PathwayPenaltyBoxFilter,t)}}}prunePathwayPenaltyBox(e){var t,i,r=this.getQueryForId(e).rootPlaylistEntity;r&&(i=performance.now(),t=r.mediaOptionListTuple[we.Variant].pathwayPenaltyBox)&&0!==t.length&&(t=dy.prunePenaltyBox(t.slice(),i),i=uy(r.mediaOptionListTuple,we.Variant,{pathwayPenaltyBox:t}),this.Me.update(e,{mediaOptionListTuple:i}))}prunePenaltyBox(e,i=null){var r=this.getQueryForId(e).rootPlaylistEntity;if(r){let t=r.mediaOptionListTuple;var n=performance.now();if(i){const e=t[i];t=uy(t,i,{penaltyBoxQueue:dy.prunePenaltyBox(e.penaltyBoxQueue,n)})}else for(let e=0;e<t.length;e++){const i=t[e];t=uy(t,e,{penaltyBoxQueue:dy.prunePenaltyBox(i.penaltyBoxQueue,n)})}this.Me.update(e,{mediaOptionListTuple:t})}}removePermanently(e,t,i){var r=this.getQueryForId(e).rootPlaylistEntity;if(r){var n=r.mediaOptionListTuple,n=new Set(n[t].removed),i=(n.add(i),uy(r.mediaOptionListTuple,t,{removed:Array.from(n)}));if(this.Me.update(e,{mediaOptionListTuple:i}),this.Zt.enableBoss){const i=new Nc([...this.getQueryForId(e).mediaOptionListQueries[t].mediaOptionListInfo.removed]);null!=(r=this.mediaSelectionBossService)&&r.setTransformer(e,Re.PermanentRemovalFilter,i)}}}moveAllWithMatchingHosts(e,t,i,r){const n=this.getQueryForId(e).rootPlaylistEntity;if(n){var a=n.mediaOptionListTuple[t],s=a.mediaOptions.filter(e=>za(i,e)).map(e=>e.mediaOptionId),o={removed:a.removed,penaltyBoxQueue:null!=(a=a.penaltyBoxQueue)?a:[]};if(r){const e=new Set([...o.removed,...s]);o.removed=Array.from(e)}else{const e=performance.now(),t=o.penaltyBoxQueue.slice();o.penaltyBoxQueue=dy.prunePenaltyBox(t,e);for(const t of s)dy.addToPenaltyBox(o.penaltyBoxQueue,e,t)}a=uy(n.mediaOptionListTuple,t,o,e=>ly(e,n.baseUrl));if(this.Me.update(e,{mediaOptionListTuple:a}),this.Zt.enableBoss){const i=new Bc([...this.getQueryForId(e).mediaOptionListQueries[t].mediaOptionListInfo.penaltyBoxQueue]);null!=(r=this.mediaSelectionBossService)&&r.setTransformer(e,Re.PenaltyBoxFilter,i)}}}setMaxHdcpLevel(e,t,i=!1){var r=this.getQueryForId(e).rootPlaylistEntity;if(r){var n=r.mediaOptionListTuple[we.Variant].maxHdcpLevel;if(i||Vu.isRestrictedLevel(t)&&!Vu.isRestrictedLevel(n)||!Vu.isAllowed(n,t)){const i=uy(r.mediaOptionListTuple,we.Variant,{maxHdcpLevel:t});this.Me.update(e,{mediaOptionListTuple:i})}!this.Zt.enableBoss||null!=(i=this.mediaSelectionBossService)&&i.setTransformer(e,Re.HDCPFilter,new Hc(t))}}updateConsecutiveTimeouts(e,t,i,r){var n=this.getQueryForId(e),a=null==(a=null==(a=n.getErrorInfoByType(t))?void 0:a.timeouts)?void 0:a[r];(i||0!==a&&null!=a)&&(a=Y(n.rootPlaylistEntity.errorsByType)||[{timeouts:{load:0,append:0,key:0}},{timeouts:{load:0,append:0,key:0}},{timeouts:{load:0,append:0,key:0}}],i?++a[t].timeouts[r]:a[t].timeouts[r]=0,this.Me.update(e,{errorsByType:a}))}updateInflightFrag(t,i,r,n,a,s){if(!(i===we.Subtitle||r&&r.itemId!==t)){var o=this.Me.inFlightFragTuple[i].value;if(o||r){if(a&&null!=o&&o.bwSample){let e=Object.keys(a).length!==Object.keys(o.bwSample).length;if(!e)for(const[i,r]of Object.entries(o.bwSample))if(a[i]!==r){e=!0;break}if(!e)return}if(r){var{start:r,duration:l,mediaOptionId:d,mediaSeqNum:u,discoSeqNum:c,iframe:h,isLastFragment:p,mediaOptionType:m}=r;let e=null==o?void 0:o.tstart;t={itemId:t,mediaOptionId:d,mediaOptionType:m,mediaSeqNum:u,discoSeqNum:c,start:r,duration:l,tstart:e=n!==(null==o?void 0:o.state)?performance.now():e,state:n,iframe:h,isLastFragment:p,compatible:s,bwSample:a?Object.assign({},a):null};this.Me.setInFlightFrag(i,t)}else this.Me.setInFlightFrag(i,void 0)}}}Pc(e){var t=e.enabledMediaOptionKeys[we.Variant],e=e.mediaOptionListTuple[we.Variant].mediaOptions,t=df(t.mediaOptionId,e);this.abrController.reset(this.logger),this.setHighBWTrigger(t)}setNextMaxAutoOptionId(e){this.abrController.nextMaxAutoOptionId=e}setNextMinAutoOptionId(e){this.abrController.nextMinAutoOptionId=e}setHighBWTrigger(e){this.abrController.highBwTrigger=e}getAbrStatus(){return this.abrController.status}setFragLoadSlow(e){var t=this.abrController,i=t.status;(null==e?void 0:e.fragDownloadSlow)===(null==i?void 0:i.fragDownloadSlow)&&(null==e?void 0:e.fragDownloadTooSlow)===(null==i?void 0:i.fragDownloadTooSlow)||(t.status=e)}pickMediaOptionTupleByAlternateMatchingInfo(e,t,i,r=!1,n=!1){var a=e.enabledMediaOptionIdByType(we.Variant),a=e.variantMediaOptionById(a),i=t===we.AltAudio?null==(l=i.audioMatchingInfo)?void 0:l.persistentId:null==(l=i.subtitleMatchingInfo)?void 0:l.persistentId;let s,o;if(t===we.AltAudio){const t=e.enabledAlternateMediaOptionByType(we.Subtitle);o=null==t?void 0:t.persistentID,s=i}else{const t=e.enabledAlternateMediaOptionByType(we.AltAudio);s=null==t?void 0:t.persistentID,o=i}var l=e.getEnabledMediaOptionMask();return l[t]=!!(fe(i)&&0<=i),a?this.getBestMediaOptionTupleFromVariantAndPersistentId(e,a,s,o,l,void 0,void 0,r,n,!1,!0):[Me,Me,Me]}getFallbackMediaOptionTupleFromMediaOptionId(e,t,i,r,n=!1,a=!1,s=!1,o=!1){var r=r?[r]:[i],l=e.enabledMediaOptionIdByType(we.Variant),l=e.variantMediaOptionById(l),d=t===we.AltAudio?e.alternateMediaOptionById(we.AltAudio,i):e.enabledAlternateMediaOptionByType(we.AltAudio),d=null==d?void 0:d.persistentID,i=t===we.Subtitle?e.alternateMediaOptionById(we.Subtitle,i):e.enabledAlternateMediaOptionByType(we.Subtitle),i=null==i?void 0:i.persistentID;return l?this.getBestMediaOptionTupleFromVariantAndPersistentId(e,l,d,i,void 0,r,t,n,a,s,o):[Me,Me,Me]}hasFallbackMediaOptionTuple(e,t,i,r){var n=e.mediaOptionListQueries[t].mediaOptionFromId(i);return e.isValidMediaOptionTuple(this.getFallbackMediaOptionTupleFromMediaOptionId(e,t,i,n.backingMediaOptionId,!1,r))}xc(e,t,i,r,n=void 0){var a=e.enabledMediaOptionIdByType(we.Variant),a=e.variantMediaOptionById(a),e=e.getLegacyMatchingAlternateWithPersistentId(i,r,a);e&&this.setEnabledMediaOptionByType(t,i,e,!0,n)}setEnabledMediaOptionTupleWithMatchedGroups(t,i,e,r,n=void 0){const a=r.getQueryForId(t),s=i===we.AltAudio?null==(r=e.audioMatchingInfo)?void 0:r.persistentId:null==(r=e.subtitleMatchingInfo)?void 0:r.persistentId,o=this.pickMediaOptionTupleByAlternateMatchingInfo(a,i,e);if(!a.isValidMediaOptionTuple(o))return this.xc(a,t,i,s,n);Oe(()=>{this.setEnabledMediaOptionByType(t,i,o[i],!0,n);var e=o[we.Variant],e=(this.setEnabledMediaOptionByType(t,we.Variant,e),i===we.AltAudio?we.Subtitle:we.AltAudio);o[e].mediaOptionId!==a.enabledMediaOptionIdByType(e)&&this.setEnabledMediaOptionByType(t,e,o[e],!1)})}canSwitchToSDR(e,t,i,r=!1){var n=e.mediaOptionListQueries[we.Variant].mediaOptionFromId(t);return!!n&&!!Wm(n)&&(t=this.getFallbackMediaOptionTupleFromMediaOptionId(e,we.Variant,t,n.backingMediaOptionId,!0,i,r),e.isValidMediaOptionTuple(t))}getBestMediaOptionTupleFromVariantAndPersistentId(t,i,r,n,a,s,o,l,d,u,c){let h;const p=this.Zt,m=t.mediaOptionListQueries[we.Variant];if(p.enableBoss){const o=null==(f=this.mediaSelectionBossService)?void 0:f.getQuery(t.itemId,this.logger),c={hasScore:t.mediaOptionListQueries[we.Variant].mediaOptionListInfo.hasScore,pivotVariant:i,pathwayPriority:t.mediaOptionListQueries[we.Variant].mediaOptionListInfo.pathwayPriority,enableSteering:p.enableContentSteering,preferHostOverQuality:!0,preferCloseToPivotQuality:!0},m=new Map([[Re.ValidFallbackFilter,new Kc(i,d,u,s)],[Re.FallbackSelector,new Jc(c)]]),g=t.enabledMediaOptionKeys[we.AltAudio],y=Bs(g)?t.alternateMediaOptionById(we.AltAudio,g.mediaOptionId):null,v=ge.getStickyAtmosStatus(p.useStickyAtmosFilter,i.audioCodec,null==y?void 0:y.channels),I=[t.mediaOptionListQueries[we.AltAudio].mediaOptionListInfo.penaltyBoxQueue,t.mediaOptionListQueries[we.AltAudio].mediaOptionListInfo.removed,t.mediaOptionListQueries[we.AltAudio].mediaOptionListInfo.compatibleIds],S=[t.mediaOptionListQueries[we.Subtitle].mediaOptionListInfo.penaltyBoxQueue,t.mediaOptionListQueries[we.Subtitle].mediaOptionListInfo.removed,t.mediaOptionListQueries[we.Subtitle].mediaOptionListInfo.compatibleIds],b=(null==y?void 0:y.persistentID)!==r,T=new Zc(v,I,S,r,n,a||t.getEnabledMediaOptionMask(),s,b);m.set(Re.ErrorHandlingValidAlternatesFilter,T),m.set(Re.ValidAlternatesFilter,T),null!=(f=this.mediaSelectionBossService)&&f.setMultipleTransformers(t.itemId,m);let e=[Me,Me,Me];var f=l?o.variantFor(ys.ErrorHandlingSdrOnly):o.variantFor(ys.ErrorHandling);return f&&(h=t.matchAlternates(f,r,n,s),e=[f,...h]),e}const g=m.listFallbackVariants(i.mediaOptionId,l,d,u,this.Zt.enableContentSteering,s);let y=[Me,Me,Me];for(let e=g.length;0<e--;){const o=g[e],l=(h=t.matchAlternates(o,r,n,s),cy(t,o,r,n,a,s));if(l){y=l;break}}return y=c&&!t.isValidMediaOptionTuple(y,a)?function(e,t,i,r,n,a,s){let o=Number.POSITIVE_INFINITY;const l=t.filteredMediaOptionList;let d=[Me,Me,Me];for(const t of l){const l=cy(i,t,r,n,a,s),u=Math.abs(t.bitrate-e.bitrate);l&&u<o&&(d=l,o=u)}return d}(i,m,t,r,n,a,s):y}getAlternatesForVariant(e,t,i,r){var n=e.variantMediaOptionById(t),a=this.Zt;if(a.enableBoss){const t={hasScore:e.mediaOptionListQueries[we.Variant].mediaOptionListInfo.hasScore,pivotVariant:n,pathwayPriority:e.mediaOptionListQueries[we.Variant].mediaOptionListInfo.pathwayPriority,enableSteering:a.enableContentSteering,preferHostOverQuality:!0,preferCloseToPivotQuality:!0},s=new Map([[Re.ValidFallbackFilter,new Kc(n,!1,!1,[])],[Re.FallbackSelector,new Jc(t)]]),o=e.enabledMediaOptionKeys[we.AltAudio],l=Bs(o)?e.alternateMediaOptionById(we.AltAudio,o.mediaOptionId):null,d=ge.getStickyAtmosStatus(a.useStickyAtmosFilter,n.audioCodec,null==l?void 0:l.channels),u=[e.mediaOptionListQueries[we.AltAudio].mediaOptionListInfo.penaltyBoxQueue,e.mediaOptionListQueries[we.AltAudio].mediaOptionListInfo.removed,e.mediaOptionListQueries[we.AltAudio].mediaOptionListInfo.compatibleIds],c=[e.mediaOptionListQueries[we.Subtitle].mediaOptionListInfo.penaltyBoxQueue,e.mediaOptionListQueries[we.Subtitle].mediaOptionListInfo.removed,e.mediaOptionListQueries[we.Subtitle].mediaOptionListInfo.compatibleIds],h=(null==l?void 0:l.persistentID)!==i,p=new Zc(d,u,c,i,r,e.getEnabledMediaOptionMask(),[],h);s.set(Re.ErrorHandlingValidAlternatesFilter,p),s.set(Re.ValidAlternatesFilter,p),null!=(a=this.mediaSelectionBossService)&&a.setMultipleTransformers(e.itemId,s)}return[n,...e.matchAlternates(n,i,r,[])]}getEnabledAlternatesForVariant(e,t){var i=e.enabledAlternateMediaOptionByType(we.AltAudio),i=null!=(i=null==i?void 0:i.persistentID)?i:void 0,r=e.enabledAlternateMediaOptionByType(we.Subtitle),r=null!=(r=null==r?void 0:r.persistentID)?r:void 0;return this.getAlternatesForVariant(e,t,i,r)}setLoading(e){this.Me.setLoading(e)}pruneVariants(e){var t=this.getQueryForId(e).getEntity(e);if(t){const a=t.mediaOptionListTuple[we.Variant],s=a.mediaOptions.filter(e=>Ym(e,a));if(s.length!==a.mediaOptions.length){const o=[...t.mediaOptionListTuple],l={mediaOptionListTuple:o};var{audioAlternateOptions:i,subtitleAlternateOptions:r}=fy(s,o[we.AltAudio].mediaOptions,o[we.Subtitle].mediaOptions);if(n(we.Variant,s),n(we.AltAudio,i),n(we.Subtitle,r),this.mediaSelectionBossService){this.mediaSelectionBossService.getQuery(e,this.logger);const a=t.iframeVariants;this.mediaSelectionBossService.setVariants(e,s.concat(a))}function n(e,t){o[e]=Object.assign(Object.assign({},o[e]),{mediaOptions:t})}this.Me.update(e,l)}}}}function uy(e,t,i,r){var[n,a,s]=e,o=r?e=>e.map(r):e=>e;switch(t){case we.Variant:return[Object.assign(Object.assign(Object.assign({},n),i),{mediaOptions:o(n.mediaOptions)}),a,s];case we.AltAudio:return[n,Object.assign(Object.assign(Object.assign({},a),i),{mediaOptions:o(a.mediaOptions)}),s];case we.Subtitle:return[n,a,Object.assign(Object.assign(Object.assign({},s),i),{mediaOptions:o(s.mediaOptions)})];default:return e}}function cy(e,t,i,r,n,a){i=e.matchAlternates(t,i,r,a);return e.isValidMediaOptionTuple([t,...i],n)?[t,...i]:null}function hy(e,t,i,r,n){let a;return a=!(a=fe(null==i?void 0:i.persistentId)?null==r?void 0:r.find(function(e){return e.MediaSelectionOptionsPersistentID===i.persistentId}):a)&&r?n&&i?function(t,i,r=!1){let n=null;const{baseName:a,lang:s,region:o}=Kp.toLocale(t.language),l=[!0,!1];for(let e=0;e<l.length;++e){const h=l[e];for(let e=0;e<i.length;e++){const l=i[e];if(!(l.MediaSelectionOptionsIsAutoSelect!==h||r&&l.MediaSelectionOptionsDisplaysNonForcedSubtitles)){d={baseName:a,lang:s,region:o},u=l,c=void 0;const t=(c=Kp.toLocale(u.MediaSelectionOptionsExtendedLanguageTag)).baseName&&d.baseName&&c.baseName===d.baseName?{matchType:$f.BaseNameMatch,option:u}:c.lang===d.lang?{matchType:$f.LanguageTagMatch,option:u}:null;if((null==t?void 0:t.matchType)===$f.BaseNameMatch){n=t.option;break}(null==t?void 0:t.matchType)===$f.LanguageTagMatch&&(n=t.option)}}if(n)break}var d,u,c;return n}(i,r):r.find(function(e){return e.MediaSelectionOptionsIsDefault}):a}const py=(e,i,r,n,t,a)=>{if(r){let t=hy(0,0,i,r.MediaSelectionGroupOptions,a.enableInterstitialPlayback);return t=t||r.MediaSelectionGroupOptions[0],n.find(e=>e.persistentID===(null==t?void 0:t.MediaSelectionOptionsPersistentID))}};const my=(t,i,r,n,a,e,s)=>{if(n){const t=hy(0,0,i,n.MediaSelectionGroupOptions,s.enableInterstitialPlayback);let e;return e=t?a.find(e=>e.mediaType===Is.CLOSEDCAPTION?(!r||e.groupId===r)&&e.persistentID===t.MediaSelectionOptionsPersistentID:e.mediaType===Is.SUBTITLE?e.persistentID===t.MediaSelectionOptionsPersistentID:void 0):e}};function fy(e,t,i,r){const n=[new Set,new Set];for(const t of e){const e=null==r?void 0:r.get(t.mediaOptionId);if(e&&(n[Tp.Audio].add(e[Tp.Audio]),n[Tp.Subtitle].add(e[Tp.Subtitle])),t.audioAlternates)for(const e of t.audioAlternates)n[Tp.Audio].add(e.groupId);if(t.subtitleAlternates)for(const e of t.subtitleAlternates)n[Tp.Subtitle].add(e.groupId)}return{audioAlternateOptions:t.filter(e=>n[Tp.Audio].has(e.groupId)),subtitleAlternateOptions:i.filter(e=>n[Tp.Subtitle].has(e.groupId))}}function gy(e,t,i,r,n,a,s,o){var l=e.mediaOptionListTuple[we.Variant];let d;var u=e.itemId;if(i.enableBoss&&r){if(null!=a){const e=new Qc(a,s);r.setTransformer(u,e.id,e)}else r.removeTransformer(u,Re.ResolutionTierFilter);const e=new _c(l.hasHdrLevels,l.preferHDR),i=(r.setTransformer(u,e.id,e),r.getQuery(u,t));return d=i.variantsFor(ys.MaybeCompatibleOptions),{firstVariant:i.variantFor(o?ys.FirstSelectionIframe:ys.FirstSelection),filteredVariants:d}}var c,h,r=[...Xm.kAllowFilters],u=(e.contentSteeringOption&&i.enableContentSteering&&r.push(new Qu({name:"Content Steering Pathway Filter",priority:5,initFn:(e,t={})=>{var i=uc(t.pathwayPriority);return Object.assign(Object.assign({},t),{pathwayRanking:i})},firstPassFn(e,t,i,r){var n=i.pathwayRanking(e.pathwayID);(null==i.selectedPathwayRanking||n>i.selectedPathwayRanking)&&(i.selectedPathway=e.pathwayID,i.selectedPathwayRanking=n)},filterFn:(e,t,i)=>e.pathwayID===i.selectedPathway})),null!=a&&r.push((c=a,h=s,new Qu({name:"Resolution Tier Filter",initFn:()=>({preferredResolution:c,resolutionLimits:h}),filterFn:(e,t,i)=>Xu(e.width,e.height,i.resolutionLimits)===i.preferredResolution}))),function(e,t,i,r,n,a,s,o){var l,d,u,c,h,p,m,f,g,y,v,I;if(!(!e||e.length<1||e.every(e=>e.iframes)))return(i?(m=r,f=t,g=n,y=a,v=s,I=o,e.reduceRight((e,t)=>{if(m!==t.iframes)return e;let i=e;r=t.score,n=tc(t,f,g,y,v,I)?Ba.VALID:Ba.INVALID;var r,n=new Dc(n,r);return i=!e||n.isGreaterThan(e.bestRank)||n.isEqualTo(e.bestRank)&&t.bandwidth<e.selected.bandwidth?{selected:t,bestRank:n}:i},null)):(l=r,d=t,u=n,c=a,h=s,p=o,e.reduceRight((e,t)=>{if(l!==t.iframes)return e;let i=e;var r=function(e,t,i,r,n,a){var s=ec(t,i,r,n,a),o=t.heuristicStartupRestrictions,l=s||Zu(e.bitrate,e.height,o)?Ba.VALID:Ba.INVALID,d=Lc(e.videoRange),{videoCodecRank:u,audioCodecRank:c}={videoCodecRank:Pc((u=e).videoCodec),audioCodecRank:kc(u.audioCodec)},s=s||e.bitrate<o.maxPreferredBitrate?Ba.VALID:Ba.INVALID,o=e.audioChannelCount||1,t=tc(e,t,i,r,n,a)?Ba.VALID:Ba.INVALID;return new Dc(l,d,u,o,c,t,s,e.height)}(t,d,u,c,h,p);return i=!e||r.isGreaterThan(e.bestRank)||r.isEqualTo(e.bestRank)&&t.bitrate>e.selected.bitrate?{selected:t,bestRank:r}:i},null))).selected}(d=Hu(l.mediaOptions,r,Object.assign(Object.assign({},l),{compatibleIds:null})),i,l.hasScore,o,n,n,n,n));return{firstVariant:u,filteredVariants:d}}function yy(e,t,i,r){if((null==t?void 0:t.mediaType)===Is.CLOSEDCAPTION){e=ny.pairForcedSubtitleMediaOptionWithClosedCaptionInList(t,null!=(e=e.subtitleAlternates)?e:[],r);if(e)return t=Object.assign(Object.assign({},t),{url:e.url,relativeUrl:e.relativeUrl,backingMediaOptionId:e.mediaOptionId}),i.map(e=>e.mediaOptionId===t.mediaOptionId?t:e)}return null}function vy(e,t){var[i,r,n]=e.mediaOptionListTuple,t=Object.assign(Object.assign({},e),{mediaOptionListTuple:[Object.assign(Object.assign({},i),{mediaOptions:[...i.mediaOptions],pathwayPriority:null!=t?t:i.pathwayPriority}),Object.assign(Object.assign({},r),{compatibleIds:null}),Object.assign({},n)]}),i=e.audioMediaSelectionGroup,r=null==i?void 0:i.MediaSelectionGroupOptions;return r&&(t.audioMediaSelectionGroup=Object.assign(Object.assign({},i),{MediaSelectionGroupOptions:[...r]})),t}function Iy(t,e,i,r,n,a,s,o,l,d){var{itemId:u,interstitialId:c,mediaOptionListTuple:h,interstitialAssetId:p}=t,[h,m,f]=h,g=s,y=(null==d?void 0:d.size)||0,{firstVariant:o,filteredVariants:l}=function(r,n,a,s,o,l,d,u){var e=r.mediaOptionListTuple[we.Variant];if(a.enableBoss&&s){const n=new Map([[Re.PermanentRemovalFilter,new Nc(e.removed)],[Re.CompatibleIdsFilter,new Fc(null)],[Re.PenaltyBoxFilter,new Bc(e.penaltyBoxQueue)],[Re.ViewportFilter,new Vc(e.viewportInfo)],[Re.HDCPFilter,new Hc(e.maxHdcpLevel)],[Re.FirstLevelSelector,new Yc(a,o,o,o,o)]]);a.enableContentSteering&&n.set(Re.PathwayFilter,new ay(e.pathwayPriority)),s.setMultipleTransformers(r.itemId,n)}function t(){let e,t=[],i=l;for(;{firstVariant:e,filteredVariants:t}=gy(r,n,a,s,o,i,d,u),null!=i&&++i,i<=gs.SD&&!e;);return{firstVariant:e,filteredVariants:t}}let{firstVariant:i,filteredVariants:c}=t();if(!i){const r=e.preferHDR;e.preferHDR=!r&&e.hasHdrLevels,e.preferHDR!==r&&({firstVariant:i,filteredVariants:c}=t())}if(i)return{firstVariant:i,filteredVariants:c};throw new me(!0,0===c.length?pe.NoValidAlternates:pe.NoValidFirstAlternate)}(t,a,g,i,o,!1===s.allowKeySwitch?gs.HD:void 0,s.resolutionLimits,l),v={itemId:u,mediaOptionId:o.mediaOptionId},y=((null==d?void 0:d.size)||0)-y;if(y){var I=d;d=y,y=t;const E=new Map,O=new Map,w=y.mediaOptionListTuple[we.Variant],R=Array.from(I.values());let e=I.size-d;for(;e<I.size;e++){const I=R[e];w.mediaOptions=w.mediaOptions.concat(I),I.forEach(e=>{var t;null!=(t=e.audioAlternates)&&t.forEach(e=>{var t=e.groupId+`_`+e.persistentID;E.has(t)||E.set(t,e)}),null!=(t=e.subtitleAlternates)&&t.forEach(e=>{var t=e.groupId+`_`+e.persistentID;O.has(t)||O.set(t,e)})})}var d=y.mediaOptionListTuple[we.AltAudio],S=Array.from(E.values()),d=(d.mediaOptions=d.mediaOptions.concat(S),y.mediaOptionListTuple[we.Subtitle]),S=Array.from(O.values());d.mediaOptions=d.mediaOptions.concat(S)}let b=r.query.alternateMatchingInfo;if(0<(null==c?void 0:c.length)){const{audioMatchingInfo:t,subtitleMatchingInfo:e}=n.interstitialQuery.getAlternateMatchingInfoForInterstitialAssetId(p,c),i=b?Object.assign({},b):{};i.audioMatchingInfo=Object.assign(Object.assign({},b.audioMatchingInfo),{persistentId:null==t?void 0:t.persistentId}),i.subtitleMatchingInfo=Object.assign(Object.assign({},b.subtitleMatchingInfo),{persistentId:null==e?void 0:e.persistentId}),b=i}var{firstAudio:y,firstSubtitle:d}=function(e,t,i,r,n,a,s,o,l){t=e.audioAlternates?Hu(e.audioAlternates,ny.kAllowFilters,t):[],i=t.length?py(a,null==s?void 0:s.audioMatchingInfo,i,t,l,o):null,t=e.subtitleAlternates?Hu(e.subtitleAlternates,ny.kAllowFilters,r):[];return{firstAudio:i,firstSubtitle:t.length?my(a,null==s?void 0:s.subtitleMatchingInfo,e.closedcaption,n,t,l,o):null}}(o,m,t.audioMediaSelectionGroup,f,t.subtitleMediaSelectionGroup,e,b,s,a),S=null==y?void 0:y.mediaOptionId,n=S?{itemId:u,mediaOptionId:S}:Me,p=d?d.mediaOptionId:null,p=p?{itemId:u,mediaOptionId:p,mediaOptionType:we.Subtitle}:Me,{mediaOptions:l,audioGroups:T}=function(e,t,i,r,n){var a,s,o,l={mediaOptions:new Array,audioGroups:new Set,subtitleGroups:new Set,closedCaptionGroups:new Set};for(const u of e){if(Yu(t,u)&&(a=r,d=n,s=t,o=u,i||Xu(s.width,s.height,d)===Xu(o.width,o.height,d)&&s.hdcpLevel===o.hdcpLevel&&function(e,t,i){const r=zu.getKeySystemFormat(i),n=null==e?void 0:e[r],a=null==t?void 0:t[r];return n==a||null!=n&&null!=a&&n.length===a.length&&n.every((e,t)=>e===a[t])}(s.allowedCPCMap,o.allowedCPCMap,a))){const e=u.audioAlternates&&0<u.audioAlternates.length?u.audioAlternates[0].groupId:void 0;e&&l.audioGroups.add(e),l.mediaOptions.push(u)}const e=u.subtitleAlternates&&0<u.subtitleAlternates.length?u.subtitleAlternates[0].groupId:void 0;e&&l.subtitleGroups.add(e);var d=u.closedcaption;d&&l.closedCaptionGroups.add(d)}return l}(l,o,s.allowKeySwitch,s.keySystemPreference,s.resolutionLimits),l=(h.compatibleIds=l.map(e=>e.mediaOptionId),h.mediaOptions);for(const e of l)null==e.url&&null!=e.relativeUrl&&(e.url=qa(e.relativeUrl,t.baseUrl));l.sort(hc(l.length,{hasScore:h.hasScore,pivotVariant:o,pathwayPriority:h.pathwayPriority,enableSteering:g.enableContentSteering,preferHostOverQuality:!0,preferCloseToPivotQuality:!1}));const A=function(e,t){var i={filteredAudioMediaOptions:new Array,compatibleIds:new Array,persistentIds:new Set,altAudio:!1};for(const r of e)t.has(r.groupId)&&(i.persistentIds.add(r.persistentID),i.compatibleIds.push(r.mediaOptionId),i.filteredAudioMediaOptions.push(r),i.altAudio||(i.altAudio=!!r.relativeUrl));return i}(m.mediaOptions,T);m.compatibleIds=A.compatibleIds;var h=t.audioMediaSelectionGroup,T=null==h?void 0:h.MediaSelectionGroupOptions,m=(T&&(h.MediaSelectionGroupOptions=T.filter(e=>A.persistentIds.has(e.MediaSelectionOptionsPersistentID))),yy(o,d,f.mediaOptions,a)),h=(m&&(f.mediaOptions=m),s.useHighestVideoCodecPrivate?function(t){const i=new Map,r=t.length,n=e=>{var t=Cc(e),t=i.get(t);return ge.isHigherCodecByFamily(t,e)?1:0};for(let e=0;e<r;e++){const r=t[e].videoCodecList;if(r){const t=N(r,n);i.set(Cc(t),t)}}return i}(l):new Map),{firstMatchingInfo:l,mediaOptionSwitchContexts:h}=(t.highestVideoCodec=h,T=u,a=d,f=e,m={},(s=y)&&(m.audioMatchingInfo={itemId:T,persistentId:s.persistentID,language:s.lang,name:s.name,characteristics:s.characteristics}),a&&(m.subtitleMatchingInfo={itemId:T,persistentId:a.persistentID,language:a.lang,name:a.name,forced:a.forced,characteristics:a.characteristics}),{firstMatchingInfo:m,mediaOptionSwitchContexts:f?[null,f.userSwitchAudioTrack&&s?{userInitiated:!0,triggerEvent:!0}:null,f.userSwitchSubtitleTrack&&a?{userInitiated:!0,triggerEvent:!0}:null]:[null,s?{triggerEvent:!0}:null,a?{triggerEvent:!0}:null]});null==c&&r.setAlternateMatchingInfo(l),t.mediaOptionSwitchContexts=h,t.enabledMediaOptionKeys=[v,n,p],g.enableBoss&&(i.setTransformer(o.itemId,Re.HostRankFilter,new qc(null!=(u=o.url)?u:o.relativeUrl,t.baseUrl)),null!=i)&&i.setTransformer(o.itemId,Re.MatchingPathwayFilter,new th(o.pathwayID))}function Sy(p,n,m,f,g,y,e,v,I,S,b,T,t,A,E,O,w,i){const R=Ns(p);let r=function(R,e,M,P,t,C){const{url:k,appItemId:i}=R,r=no(R,n);return Lo({url:k,onProgress:{getData:!0,cb:ty},xhrSetup:P.xhrSetup,appItemId:null!=i?i:""},r,t,e).pipe(ve(e=>{{var t=k,i=e,r=R,n=(e=C,P),a=M;const s=i.responseURL,o=(s||(i.responseURL=t),n)["keySystemPreference"],{responseText:l,responseURL:d,stats:u}=i,{itemId:c,appItemId:h,itemStartOffsets:p,interstitialId:m,interstitialAssetId:f,parentItemId:g}=r,y=Ns(r),v=Object.assign(Object.assign({},u),{tparsed:{tbegin:NaN,tend:NaN},tfiltered:NaN}),I=null!=m&&0<m.length&&null!=f&&0<f.length?{interstitialId:m,interstitialAssetId:f}:void 0;if(Wf.isMediaPlaylist(l)){const i="media-pl-"+va(),r=performance.now(),u=Wf.parseMediaOptionPlaylist(l,s,o||void 0,{},c,i,we.Variant,I,e,a,p[we.Variant]),S=performance.now();n=Jh(u.mediaOptionDetails,n),t=(lo(u.mediaOptionDetails),{itemId:c,mediaOptionId:i,mediaOptionType:we.Variant,url:t,relativeUrl:t,bandwidth:0,bitrate:0,iframes:u.mediaOptionDetails.iframesOnly,interstitialId:m,interstitialAssetId:f,pathwayID:"."});return v.tparsed={tbegin:r,tend:S},{parentItemId:g,itemId:c,statsId:y,appItemId:h,itemStartOffsets:p,rootMediaOptionsTuple:[[t],[],[]],stats:v,interstitials:n,responseUrl:d,initialDetails:u.mediaOptionDetails,isMediaPlaylist:!0,variantIdToAlternateGroupIdTuple:new Map}}{const t=performance.now(),i=Wf.parseSessionData(l,d,null!=h?h:"",a),r=Wf.parseSessionKeys(l,d,o||void 0,e),n=Wf.parseRootPlaylistWithAlternates(c,l,d,I),s=performance.now(),{variantMediaOptions:u,contentSteeringOption:m,masterVariableList:f,startTimeOffset:b,variantIdToAlternateGroupIdTuple:T}=n,{audioAlternateOptions:A,subtitleAlternateOptions:E,audioMediaSelectionGroup:O,subtitleMediaSelectionGroup:w}=n.alternateMediaInfo;return v.tparsed={tbegin:t,tend:s},{parentItemId:g,itemId:c,statsId:y,appItemId:h,itemStartOffsets:p,interstitials:[],rootMediaOptionsTuple:[u.reverse(),null!=A?A:[],null!=E?E:[]],stats:v,responseUrl:d,audioMediaSelectionGroup:O,subtitleMediaSelectionGroup:w,contentSteeringOption:null!=m?m:void 0,sessionData:i,sessionKeys:r,masterVariableList:f,startTimeOffset:b,variantIdToAlternateGroupIdTuple:T}}}}),e=>e.pipe(ye(e=>{if(e instanceof to)throw new Xs(!1,pe.ManifestTimeoutError,e.isCustomUrl,e.timeoutType);if(e instanceof zs)throw new Xs(!1,e.statusCode,e.isCustomUrl,void 0,e.message);throw e})))}(p,e,m,S,I.query.extendMaxTTFB,t);return(r=i?r.pipe(i):r).pipe(Ae(function(h){return ni(this,void 0,void 0,function*(){null!=A&&A.triggerManifestLoaded(h),h.isMediaPlaylist&&null!=A&&A.handleLevelLoaded(h.rootMediaOptionsTuple[0][0],h.initialDetails,h.stats);var e,t,i,r,n,a,s,{initialDetails:o,stats:l,interstitials:d}=h,{displaySupportsHdr:o,platformInfo:l}=(o&&g&&(g.archiveMediaOptionDetails(o,Object.assign({},l),!0,S.liveAllowLowLatencyPlayback),y)&&S.enableInterstitialPlayback&&0<d.length&&y.addInterstitials(d),b),d=(()=>{var e=h["rootMediaOptionsTuple"];let t=Array.from(e[we.Variant]),i=!1,r=!1;return(t=t.filter(e=>{if(e.audioCodecList&&e.audioAlternates){var t=e.audioAlternates&&0<e.audioAlternates.length?e.audioAlternates[0]:void 0,t=null==t?void 0:t.channels;if(t){var i=ge.getImmersiveAudioType(t);if(!ge.isCompatibleImmersiveAudioType(i))return!1;e.audioChannelCount=parseInt(t)}}return e})).forEach(e=>{i=i||Boolean(e.videoCodec),r=r||Boolean(e.audioCodec)||Boolean(e.audioAlternates)}),{variantMediaOptions:t=i&&r?t.filter(({videoCodec:e})=>Boolean(e)):t}})()["variantMediaOptions"],u=ke(p)?{interstitialId:p.interstitialId,interstitialAssetId:p.interstitialAssetId}:void 0,l=yield function(T,A,E,O,w,R,M,P){return ni(this,void 0,void 0,function*(){var{hdrMediaOptions:e,sdrMediaOptions:t,imageIframeVariants:i}=yield ry(M,T.sessionKeys,A,O,P),t=e.concat(t),e=0<e.length,r=t.concat(i),r=(!O.enableBoss||null!=E&&E.setVariants(T.itemId,r),T),n=w,a=R,s=null==A?void 0:A.maxHdcpLevel,{parentItemId:o,itemId:l,statsId:d,itemStartOffsets:u,rootMediaOptionsTuple:c,audioMediaSelectionGroup:h,subtitleMediaSelectionGroup:p,startTimeOffset:m=NaN,appItemId:f,variantIdToAlternateGroupIdTuple:g}=r,{audioAlternateOptions:c,subtitleAlternateOptions:g}=fy(t,c[we.AltAudio],c[we.Subtitle],g),y=t.every(e=>fe(e.score)),v=Va.getBaseURL(r.responseUrl)||r.responseUrl,I=null==(I=r.contentSteeringOption)?void 0:I.initPathwayPriority,S=r.sessionData,{interstitialId:a,interstitialAssetId:b}=null!=a?a:{};return{parentItemId:o,itemId:l,statsId:d,appItemId:f,baseUrl:v,mediaOptionListTuple:[{mediaOptions:t,hasHdrLevels:e,hasScore:y,preferHDR:n,compatibleIds:null,penaltyBoxQueue:[],removed:[],pathwayPriority:I,pathwayPenaltyBox:[],maxHdcpLevel:s},{mediaOptions:c,compatibleIds:null,penaltyBoxQueue:[],removed:[]},{mediaOptions:g,penaltyBoxQueue:[],removed:[]}],audioMediaSelectionGroup:h,subtitleMediaSelectionGroup:p,enabledMediaOptionKeys:[Me,Me,Me],mediaOptionSwitchContexts:[null,null,null],avAnchor:null,itemStartOffsets:u,startTimeOffset:m,initPtsRecord:{},contentSteeringOption:r.contentSteeringOption,masterVariableList:r.masterVariableList,loadStats:r.stats,isMediaPlaylist:r.isMediaPlaylist,interstitialId:a,interstitialAssetId:b,iframeVariants:i,sessionData:S}})}(h,l,v,S,o,u,d,m);let c=null;return S.enableAdaptiveStartup&&(c=T.getQueryForId(R).getCombinedEstimate(S)),l.loadStats&&!Object.isFrozen(l.loadStats)&&(l.loadStats.tfiltered=performance.now()),o=l,u=E,d=I,e=v,t=y,i=b,xe(O,performance.now()),r=S,n=c,a=w,s=m,performance.now(),o.mediaOptionListTuple[we.Variant].viewportInfo=i.viewportInfo,Iy(o,u,e,d,t,s,r,n,a),f&&f.setRootPlaylistEntity(l.itemId,l),l})}))}function by(e,t,a){const{config:i,mediaSink:r,itemQueue:s,gaplessInstance:n}=e,o=r["mediaQuery"],l=_n([s.activeItemById$,o.desiredRate$,o.waterLevelChangedForType$(B.Variant),o.isBufferedToEnd$(i.maxBufferHole,!n.inGaplessMode)]).pipe(ve(([e,t,i,r])=>{var n=s.prefetchItem,n=e&&n&&vg(e)===vg(s.prefetchItem);return!!(r||n&&0===t)||!fh(t)&&!s.isPreloading()&&(!fe(i)||(a===qf.AltAudioSegment||a===qf.VariantSegment?i>=cu.AboveHighWater:i>=cu.HighWater))}));return ol(l,e=>e).pipe(Ae(()=>t))}function Ty(r,n,a,s){const{config:o,logger:l,mediaLibraryService:d}=r;return e=>e.pipe(Yr({delay:(e,t)=>{if(e instanceof me||!(e instanceof v))return e.handled=!0,e.fatal=!1,d.setPrefetchErrored(n,l,s),e;let i;switch(s){case qf.Manifest:i=no({url:a},o.manifestLoadPolicy);break;case qf.VariantPlaylist:case qf.AltAudioPlaylist:i=no({url:a},o.playlistLoadPolicy);break;case qf.VariantSegment:case qf.AltAudioSegment:i=no({url:a},o.fragLoadPolicy);break;default:throw e}return i.maxLoadTimeMs=xe(i.maxLoadTimeMs,2e4),rm(e,t-1,ao(e,i),0,null).pipe(Ae(()=>by(r,be(Hf.IN_PROGRESS),s).pipe(ve(()=>0))))}}))}function Ay(v,I,r,n){const{config:S,logger:a,mediaLibraryService:s}=v;return Di(Ae(e=>{if(!e)throw new me(!1,pe.NoVariantMediaOptionToPrefetch);const{mediaOptionType:f,mediaOptionId:g}=e;if(f===we.Subtitle)return sl;const y=Ka(e,n),t=e.mediaOptionType===we.Variant?qf.VariantPlaylist:qf.AltAudioPlaylist,i=s.cachePrefetchRequest(r,t,new yg(Sg(e),()=>{{var a=I.itemId,s=g,o=f,e=v,t=S,l=y,d=v.keyTracker;const{logger:u,hlsService:i,customUrlLoader:r,rootPlaylistQuery:n}=e,{playlistLoadPolicy:c,keySystemPreference:h}=t,p=no({url:l},c),m=i.query.extendMaxTTFB;return Lo({url:l,xhrSetup:t.xhrSetup,appItemId:n.appItemId},p,m,r).pipe(ve(({responseText:e,responseURL:t,stats:i})=>{t=t||l;var r=performance.now(),e=Qf.parseMediaOptionPlaylist(e,null!=t?t:l,h,{},a,s,o,void 0,d,u,0,!1),t=performance.now(),n=e["mediaOptionDetails"],r={playlistLoadTimeMs:i.tload-i.trequest,playlistParseTimeMs:t-r,tparsed:{tbegin:r,tend:t}};return{mediaOptionDetails:n,isDeltaPlaylist:e.isDeltaPlaylist,interstitials:[],bwSample:i,playlistSample:r}}),ve(e=>e.mediaOptionDetails),so(o,s,!1,l))}}),a);return i?i.pipe(Ty(v,r,y,t)):sl}))}function Ey(e,t){var i=e.seekable;let r=0;return fe(r=0<i.length?i.end(i.length-1):r)||(r=e.mediaElementDuration),Math.max(0,r-(t.leftMediaTimeToAutoPause||0))}function Oy(t){var{seekTo:t,timeline:i,currentSegmentAndTime:r,itemQueue:n,interstitialController:a,logger:s,interstitialService:o}=t,{segment:s,targetTime:r}=(null!=s&&s.child({name:"Integrated Timeline Seek"}),r),e=t-r<0;if(i.segments.length<2)return{seekTo:t+Le(n.playingItem),isSeekBackwards:e,newItem:void 0};var l=Ry(t,i);if(l){var{source:d,target:u}=l.timeMapping,u=t-u.start,d=d.start+u;if(l.interstitialEventIdentifier){var c=l;u=s;var h=r;l=d;s=t;var p=n;var m=a;var f=o;const b=c["interstitialEventIdentifier"],{activeItem:T,queueItems:A}=p,E=s<h,O=A.filter(e=>e.interstitialId===b),w=m.interstitialQuery.getInterstitialForId(b);if(E){if(u=u,(y=c)&&u&&y.segmentType===u.segmentType&&y.interstitialEventIdentifier===u.interstitialEventIdentifier&&y.startDate.toString()===u.startDate.toString()&&se(y.timeMapping.source,u.timeMapping.source)&&se(y.timeMapping.target,u.timeMapping.target))return null!=O&&O.find(e=>e.itemTimelineStartPosition<=h&&h<e.itemTimelineEndPosition),{seekTo:s,isSeekBackwards:!1,newItem:void 0};const P=w&&w.startTime?C(w.startTime):c.timeMapping.target.start,b=Math.max(0,P-m.config.adjustedSeekToleranceMs/1e3),T=p.getQueueItemForTime(b);return f.removeInterstitialsFromPastEventsFromTime(b),m.interstitialSeekInfo={identifier:c.interstitialEventIdentifier,time:l},{seekTo:b,isSeekBackwards:E,newItem:T}}if(0<O.length){const c=O.find(e=>e.itemTimelineStartPosition<=h&&h<e.itemTimelineEndPosition);if(c)return{seekTo:l+c.itemStartOffsets[B.Variant],isSeekBackwards:E,newItem:void 0}}const R=w&&w.startTime?C(w.startTime):c.timeMapping.target.start,M=Math.max(R-m.config.adjustedSeekToleranceMs/1e3,0);let e;return m.interstitialSeekInfo={identifier:c.interstitialEventIdentifier,time:l},T&&ke(T)&&(e=A.find(e=>!ke(e)&&e.itemTimelineStartPosition<M&&M<e.itemTimelineEndPosition)),{seekTo:M,isSeekBackwards:E,newItem:e};return}else{var g=i;var y=d;u=n;s=a;p=o;var{activeItem:f,playingItem:m}=u,c=y<r;let e=y;v=r,I=y,S=s.interstitialQuery;var v,I,S,g=g.segments.find(e=>{var t,i=e.interstitialEventIdentifier,i=S.getInterstitialForId(null!=i?i:"");return!!i&&(t=i.cueType===Ia.Midroll,e=e.timeMapping.target.start,i=i.referenceRestrictions===ba.Jump||i.referenceRestrictions===ba.SkipJump,t)&&i&&v<e&&e<=I});if(g)return s.updateSavedSeekValueForInterstitialId(g.interstitialEventIdentifier,y),e=g.timeMapping.target.start-s.config.adjustedSeekToleranceMs/1e3,{seekTo:e+=Le(u.getQueueItemForTime(e)),isSeekBackwards:c,newItem:void 0};let t;if(c){const g=u.getQueueItemForTime(y);null!=g&&g.itemId&&g.itemId!==f.itemId&&(t=g),p.removeInterstitialsFromPastEventsFromTime(y)}else!ke(m)&&(null==m?void 0:m.itemId)===(null==f?void 0:f.itemId)||(t=u.queueItems.find(e=>!ke(e)));return{seekTo:e,isSeekBackwards:c,newItem:t};return}}return{seekTo:t,isSeekBackwards:e,newItem:void 0}}function wy(a,s,t,i,o){return t?Hs.map(e=>{e=t.getBufferedSegmentsByType(Ks(e)).reduce((e,t)=>{var i;const r=s.getQueueItemForId(t.frag.itemId),n="string"==typeof o;if(r&&r.interstitialId===a&&(!n||r.interstitialAssetId===o)){const a=Le(r),s=null!=(i=t.appendStart)?i:0,o=null!=(i=t.appendEnd)?i:0,n={start:Math.max(0,s-a),end:Math.max(0,o-a)};e.push(n)}return e},[]);return nh.getBufferedTimeRanges(e,i)}):[null,null]}function Ry(r,e){var e=e["segments"],t=e.length-1;if(0!=t&&fe(r))return 1==t?e[0]:e.find(e=>{var e=e.timeMapping["target"],{start:e,end:t}=e,i=t-e;return fe(i)&&0<i&&e<=r&&r<t})}function My(e,t){var i=e["operationQueue"];i.empty()&&i.enqueue(function(I,S){var i,r,n,a,{rootPlaylistQuery:e,mediaLibraryService:t,mediaSink:s,config:o}=I;return{operation:gp.Idle,priority:fp.Normal,execute:(e,t)=>{{var a=I,i=S;const s=a.logger.child(_g),{rootPlaylistService:o,rootPlaylistQuery:l,config:r,interstitialController:n,mediaSink:d}=a,u=l.itemId,c=r.liveAllowLowLatencyPlayback,h=(Wg(a),null!=i&&i.every(e=>e)?i:Hs.map(e=>({fromId:l.enabledMediaOptionIdByType(e),toId:l.enabledMediaOptionIdByType(e),switchContext:l.enabledMediaOptionSwitchContexts[e]}))),p=Te((e,t)=>!(e.mediaOptionId!==t.mediaOptionId||e.ptsKnown!==t.ptsKnown||wf(e,t)||c&&Rf(e,t))),m=Ur(e=>{return!(e&&e.liveOrEvent&&(e=e,t=r,i=null!=(i=e.tloadMillis)?i:0,performance.now()-i>1e3*_m(e,t)));var t,i}),f=be(l.variantMediaOptionById(h[we.Variant].toId)).pipe(Fg(a.mediaLibraryService),p,m),g=l.alternateMediaOptionById(we.AltAudio,h[we.AltAudio].toId),y=br([f,Us(g)?be(g).pipe(Fg(a.mediaLibraryService),p,m):sl]),v=y.pipe(Vg(a,h));let e=l.avAnchor$.pipe(tn(1),Ae(function(e,t){if(!e||!fe(e.discoSeqNum))return Se;const{anchorFrags:i,switchInfo:r}=e,n=l.enabledMediaOptionKeys;return i.some((e,t)=>{var i=r[t],i=i&&e&&e.mediaOptionId!==i.toId,e=t===we.Variant&&(e||Me).mediaOptionId!==n[t].mediaOptionId;return i||e})?Se:y.pipe(zg(a,e,s)).pipe(Ee(e=>{var t;(null==(t=null==e?void 0:e.anchorFrags[we.Variant])?void 0:t.mediaOptionId)===(null==(t=l.enabledVariantMediaOption)?void 0:t.mediaOptionId)&&o.setAVAnchor(u,e)}))}));return Bn(e=r.enableInterstitialPlayback&&r.interstitialsConfiguredForAirPlayReceiver?e.pipe(an(n.reachedTimeToPauseBuffer$(d.mediaQuery,o))):e,v)}},yield$:(i=e,r=t,n=s.mediaQuery,a=o,n.gotFirstAppend$().pipe(Ae(()=>n.combinedBuffer$),Ae(()=>{var e=i.enabledVariantMediaOption,e=r.getQueryForOption(e).mediaOptionDetails,t=nf(n,a.maxBufferHole);return e&&t>=Math.min(a.minSteeringRunway*e.targetduration,a.maxBufferLength/2)?Pe:Se})))}}(e,t))}function Py(i,e,t){const{rootPlaylistQuery:r,statsService:n,mediaSink:a}=i,s=[];e.forEach((e,t)=>{t=function(t,i,r,n,a){var s,o,l,d,u,c,h,p,m,f;const{rootPlaylistQuery:g,rootPlaylistService:y,mediaSink:v,mediaParser:I,config:S,iframeClock:b,mediaLibraryService:T,itemQueue:A}=t,E=v.mediaQuery;if(!n||!a||n===a&&(r===we.AltAudio||!b.isStarted))return null;switch(r){case we.Variant:{n!==a&&I.reset(we.Variant);const t=Ks(r),y=g.variantMediaOptionById(n),O=g.variantMediaOptionById(a);if(null==O||null==y)return Pe;if(y.iframes!==O.iframes||O.iframes)return v.mediaQuery.flushing?ol(v.mediaQuery.flushing$,e=>!e).pipe(ve(()=>{})):Pe;const b=!S.enableInterstitialPlayback||(null==(s=A.playingItem)?void 0:s.itemId)===A.activeItem.itemId;if(!S.allowFastSwitchUp||O.iframes||!b)return Pe;if(null!=T.getQueryForOption(y).mediaOptionDetails&&O.bitrate/y.bitrate>=S.minQualityRatioForFastSwitchUp){const r=T.getQueryForOption(O),n=r.mediaOptionDetails,a=(null==(o=r.mediaOptionDetailsEntity)?void 0:o.lastUpdateMillis)||0,s=E.getCurrentWaterLevelByType(t,S.maxBufferHole),I=(o=S,l=y,d=O,u=n,c=i,h=E,p=a,f=c.getCombinedEstimate(o,!1),(l.mediaOptionId!==d.mediaOptionId&&fe(f.avgBandwidth)&&(c=lf(f.avgBandwidth,c.bandwidthStatus.bandwidthSampleCount,o),m=function(){let e=0;var{avgPlaylistLoadTimeMs:t,avgLatencyMs:i}=f;return fe(t)?e=t:fe(i)&&(e=i),e}(),l=d.bitrate>l.bitrate?c.bwUp:c.bwDown,null==u||!u.liveOrEvent||u.ptsKnown&&!Sc(u.totalduration,m,p))?(m=fe(null==(c=h.seekTo)?void 0:c.pos)?c.pos:h.currentTime,c=h.getMediaBufferInfo(m,o.maxBufferHole),yc(o,d,u,Rc(o.liveAllowLowLatencyPlayback,h.isPlayingAtLive,null!=(d=null==(m=null==u?void 0:u.parts)?void 0:m.length)?d:0),Object.assign(Object.assign({},f),{avgBandwidth:l}),c,p,!0).totalTime):Number.POSITIVE_INFINITY)+S.maxStarvationDelay),b=Math.max(g.itemStartOffsets[t]||0,E.currentTime)+I,A=null==(h=null==(o=E.sourceBufferEntityByType(t))?void 0:o.bufferedSegments)?void 0:h.find(e=>e.startPTS>=b);let e;if(A){const t=A.endPTS-A.startPTS;e=A.startPTS+Math.min(Math.max(t-S.maxFragLookUpTolerance,.5*t),.75*t)}if(fe(e)&&s>=I)return v.flushData(t,e,1/0)}}break;case we.AltAudio:s=g,u=a,d=Us("Nah"===(m=n)?null:s.alternateMediaOptionById(we.AltAudio,m)),m=Us("Nah"===m?null:s.alternateMediaOptionById(we.AltAudio,u)),!d||m?a&&"Nah"!==a||y.clearMediaOptionSwitchContextByType(g.itemId,we.AltAudio):(y.setEnabledMediaOptionSwitchContextByType(g.itemId,we.AltAudio,a,void 0),b.isStarted||v.resetMediaSource(E.currentTime)),I.reset(we.AltAudio)}return Pe}(i,n.getQueryForId(r.statsId),t,e.fromId,e.toId);t&&s.push(t)});var o=r.altMediaOptionHasValidUrl(we.AltAudio,null==(o=e[we.AltAudio])?void 0:o.toId)?2:1,o=(a.setExpectedSbCount(o),My.bind(null,i,e));return s.length?Pn(s).pipe(Ee(o)):(o(),Se)}class Cy{constructor(e){this.Dc=e}destroy(){this.Dc=void 0}recoverFromFatalError(){this.Dc.recoverFromFatalError()}shouldAttemptErrorRecovery(e){return this.Dc.shouldAttemptErrorRecovery(e)}}function ky(e,t,i,r){var n=null!=(n=null==e?void 0:e.mediaOptionKeys)?n:[];for(const{mediaOptionId:e}of n)for(const n of i.mediaOptionListQueries)null!=n.mediaOptionFromId(e)&&r.updateConsecutiveTimeouts(i.itemId,n.mediaOptionType,t,"key")}function Ly(t,i,r,n,a){const s=n.query.getActiveId(),o=t.keyuri,e=a.getKeyInfo(o);if(!e||!e.mediaOptionKeys.some(({itemId:e})=>e===s))return Se;const l=n.getQueryForId(s),d=n.logger,u=l.enabledMediaOptionKeys,c=[];for(const i of t.mediaOptionIds){const t=u.some(e=>e.mediaOptionId===i),r=l.mediaOptionListQueries.find(e=>null!=e.mediaOptionFromId(i));if(r){const n=r.mediaOptionType,a={mediaOptionId:i,mediaOptionType:n};t?c.push(a):c.unshift(a)}}let h,p=!1;if(Oe(()=>{const e=t instanceof ul;ky(a.getKeyInfo(o),e,l,n);for(const{mediaOptionId:e,mediaOptionType:a}of c)h=function(e,t,i,r,n,a,s){let o={errorAction:U.SendAlternateToPenaltyBox,errorActionFlags:0},l=!1;if(e instanceof ul)o.errorAction=U.SendAlternateToPenaltyBox,l=!0;else{const t=e.isOkToRetry;e.response===pe.KeySystemOutputRestricted?(o.errorAction=U.RemoveAlternatePermanently,o.errorActionFlags|=vp.MoveAllAlternatesMatchingHDCP):t?o=Jp(e.response):o.errorAction=U.RemoveAlternatePermanently}o.errorActionFlags&=~vp.MoveAllAlternatesMatchingHost;var d=r.enabledMediaOptionIdByType(i);return t===d?Xp(o,!1,e.response,d,i,r,n,a,s,l):o}(t,e,a,l,n,"key",(null==r?void 0:r.maxNumRetry)||0),d.error(`[Keys] handleKeyError uri=${z(t.keyuri)} mediaOptionId=${e} mediaOptionType=${a} action=`+JSON.stringify(h)),h.errorAction===U.RetryRequest&&(p=!0),tm(h,t,l,n,a,e)}),p)return rm(t,i,r,n.logger,n.rtcService);throw im(0,t),t}class Dy{constructor(e,t,i,r,n,a,s,o){this.Yi=e,this.R=t,this.ir=i,this.Ke=r,this.Lc=n,this.Fc=a,this.Nc=s,this.Zt=o,this.pn=new Ie,this.jc=new jr(null),this.Bc=new jr(null),this.Uc=new jr(null),this.$c=new jr(null),this.Vc=NaN,this.qc=new Ie,this.R=t.child({name:"hls-player-events"}),this.zc()}destroy(){this.pn.next(),this.setRootPlaylistQuery(null),this.setMediaElementQuery(null),this.setInterstitialQuery(null),this.Yi=void 0}setRootPlaylistQuery(e){this.jc.next(e)}setMediaElementQuery(e){this.Bc.next(e)}setInterstitialQuery(e){this.Uc.next(e)}setInterstitialController(e){this.$c.next(e)}zc(){var e=[this.Ke.gotRequest$.pipe(Ee(this.Hc.bind(this))),this.Qc(this.Yi.itemQueue),this.Kc(),this.jc.pipe(Ae(this.Wc.bind(this))),this.Bc.pipe(Ae(this.Gc.bind(this)))];this.Zt.enableInterstitialPlayback&&e.push(br([this.Uc,this.$c]).pipe(Ae(([e,t])=>this.Xc(e,t,this.Yi.itemQueue)))),Bn(...e).pipe(ye(e=>{var t=e.message;return this.R.error(`Got error in HlsPlayerEvents `+t,e),Se}),an(this.pn),Hr(()=>{})).subscribe()}Qc(e){return e.activeItemById$.pipe(Yl(),Ee(e=>{e=e.url;this.Yi.trigger(c.MANIFEST_LOADING,{url:e})}))}postSubtitleTracksCreated(e,t){var{appItemId:t,interstitialId:i,interstitialAssetId:r}=t;this.Yc({eventName:c.SUBTITLE_TRACKS_UPDATED,payload:{subtitleTracks:e,appItemId:t,interstitialId:i,interstitialAssetId:r}}),this.Yc({eventName:c.SUBTITLE_TRACKS_CREATED})}Hc(e){this.Yi.trigger(c.UNRESOLVED_URI_LOADING,e)}Wc(t){var e,i,r,n;return t?(e=t.enabledMediaOptionByType$(we.Variant).pipe(Ee(function(e){if(!e)return Se;e.url&&null!=(t=this.ir)&&t.report(12,e.url);var t=Object.assign(Object.assign({},e),{appItemId:this.Yi.appItemIdFromItemId(e.itemId)});this.Yi.trigger(c.LEVEL_SWITCHING,t)}.bind(this))),i=[],r=(t.sessionData&&i.push(ol(t.sessionData$,e=>null!=e.complete).pipe(Ee(e=>{this.Yi.trigger(c.SESSION_DATA_COMPLETE,Object.assign(Object.assign({},e),{appItemId:t.appItemId}))}))),t)["mediaOptionListQueries"],[r,n]=r,i.push(r.getFilteredMediaOptionList$(!0).pipe(Ee(e=>{var t,i=null==(i=this.Yi.itemQueue.activeItem)?void 0:i.interstitialId,r=null==(r=this.Yi.itemQueue.activeItem)?void 0:r.interstitialAssetId;null!=(t=this.ir)&&t.report(13,e),e.forEach(e=>{});let n="";0<e.length&&(n=this.Yi.appItemIdFromItemId(e[0].itemId)),this.Yi.trigger(c.LEVELS_CHANGED,{requiresReset:!1,levels:e,appItemId:n,interstitialId:i,interstitialAssetId:r})}))),i.push(n.getFilteredMediaOptionList$(!1).pipe(Ee(e=>{var t=null==(t=this.Yi.itemQueue.activeItem)?void 0:t.interstitialId,i=null==(i=this.Yi.itemQueue.activeItem)?void 0:i.interstitialAssetId;let r="";0<e.length&&(r=this.Yi.appItemIdFromItemId(e[0].itemId)),this.Yi.trigger(c.AUDIO_TRACKS_UPDATED,{audioTracks:e,interstitialId:t,interstitialAssetId:i,appItemId:r})}))),Bn(e,gr(Bn(...i),Zi))):Se}Jc(){var e;null!=(e=this.ir)&&e.report(1,{mediaDur:this.Yi.bufferedDuration,currentTime:this.Yi.realCurrentTime,forInterstitial:this.Yi.interstitialActive})}Gc(s){if(!s)return Se;var e=s.desiredRate$.pipe(rn(0),Kr(),Ee(([e,t])=>this.desiredRateChanged(e,t))),t=s.seekTo$.pipe(Ee(e=>{var t;e&&fe(e.pos)?(null!=(t=this.ir)&&t.report(15,{event:"SEEKING",seekInfo:e,combinedBuffer:s.combinedBuffer}),this.Yi.trigger(c.SEEKING,{seekToPos:e.pos,appItemId:null==(t=this.Yi.itemQueue.activeItem)?void 0:t.appItemId})):(null!=(t=this.ir)&&t.report(15,{event:"SEEKED",seekInfo:e,combinedBuffer:null}),this.Yi.trigger(c.SEEKED))})),i=s.playbackLikelyToKeepUp$.pipe(Ee(e=>{return this.Yi.trigger(c.PLAYER_STATE_CHANGE,{playbackLikelyToKeepUp:e,appItemId:null==(e=this.Yi.itemQueue.activeItem)?void 0:e.appItemId})}));let r=s.gotPlaying?s.gotPlaying$:s.gotPlaying$.pipe(tn(1));r=r.pipe(Ee(e=>{e&&this.Jc()}));var n=s.gotFirstAppend$(Zi).pipe(Ae(()=>{var e=[],t=null==s.stallInfo?s.stallInfo$.pipe(tn(1)):s.stallInfo$;return e.push(t.pipe(Ee(function(e){var t;e?(null!=(t=this.ir)&&t.report(18,{stallInfo:e,bufferLen:null!=(t=null==(t=s.getCombinedBufferInfo(e.currentTime,0))?void 0:t.len)?t:0,mediaElementPaused:s.paused,mediaElementSeeking:s.seeking,mediaElementReadyState:s.readyState,haveEnough:s.haveEnough,seekInfo:s.seekTo}),this.Yi.trigger(c.STALLED,Object.assign(Object.assign({},e),{appItemId:null==(t=this.Yi.itemQueue.playingItem)?void 0:t.appItemId}))):this.Jc()}.bind(this)))),e.push(Bn(s.timeupdate$.pipe(ln(1e3,void 0,{leading:!0,trailing:!0})),s.gotPlaying$.pipe(Ur(e=>!!e))).pipe(ve(()=>{const t=s.currentTime,e=s.getBufferedSegmentsByType(B.Variant);return null==e?void 0:e.find(e=>e.startPTS<=t&&e.endPTS>t)}),rn(null),Kr(),Ee(([e,t])=>{var i;const r=null==t?void 0:t.frag,n=null==e?void 0:e.frag;if(r&&!lh(n,r)){const a=this.Fc.getQueryForOption(r);null!=n&&n.discoSeqNum,r.discoSeqNum;e=this.Yi.itemQueue.getQueueItemForId(a.itemId);if(this.Yi.trigger(c.FRAG_CHANGED,Object.assign(Object.assign({},t),{appItemId:null==e?void 0:e.appItemId})),!this.Yi.inGaplessMode||this.Zt.enableInterstitialPlayback||this.Zc(s,t,this.R),!n||r.mediaOptionId!==n.mediaOptionId){const s=this.Lc.query.getEntity(r.itemId),e=null==s?void 0:s.mediaOptionListTuple[we.Variant].mediaOptions.find(e=>e.mediaOptionId===r.mediaOptionId);if(e){const t=n?n.mediaOptionId:"",a=r.mediaOptionId;e.url&&null!=(i=this.ir)&&i.report(11,{url:e.url,mediaOptionId:e.mediaOptionId,oldVariant:""!==t?t:void 0,newVariant:a}),this.Yi.trigger(c.LEVEL_SWITCHED,Object.assign(Object.assign({},e),{appItemId:this.Yi.appItemIdFromItemId(e.itemId)}))}}}}))),this.Yi.inGaplessMode&&!this.Zt.enableInterstitialPlayback&&e.push(gr(s.isBufferedToEnd$(this.Yi.config.maxBufferHole,!1),Zi).pipe(Ur(e=>!0===e),Ee(e=>{if(e&&!this.Yi.itemQueue.isPreloading()&&this.Yi.inGaplessMode){const e=s.getCombinedBufferInfo(s.currentTime,0);var t,i=0;e&&(i=e.end,t=s.mediaElementDuration,0<i)&&t-s.currentTime<10&&this.Yi.trigger(c.READY_FOR_NEXT_ITEM,{duration:i,appItemId:null==(t=this.Yi.itemQueue.playingItem)?void 0:t.appItemId})}}))),Bn(...e)}));return gr(Bn(e,t,i,r,n),Rn)}Xc(l,e,d){return l&&e?Bn(l.interstitials$.pipe(Ee(e=>{var t=l.integratedTimeline;this.Yi.trigger(c.INTERSTITIALS_UPDATED,{events:e,integratedTimeline:t,appItemId:null==(e=d.activeItem)?void 0:e.appItemId})})),l.playingInterstitialId$.pipe(Kr(),cn(d.activeItemById$),Ee(([[e,t],i])=>{var r=null!=(r=null==i?void 0:i.parentItemId)?r:null==i?void 0:i.itemId;if(!r)return Se;var n=d.getQueueItemForId(r);if(null==e&&null!=t){const e=l.getInterstitialForId(t)||{identifier:t};this.Yi.trigger(c.INTERSTITIAL_STARTED,{event:e,appItemId:null==n?void 0:n.appItemId}),!r||null!=(i=this.ir)&&i.report(31,{itemId:r})}else if(null!=e&&null==t){const d=l.getInterstitialForId(e)||{identifier:e};this.Yi.trigger(c.INTERSTITIAL_ENDED,d?{event:d,appItemId:null==n?void 0:n.appItemId}:void 0),!r||null!=(i=this.ir)&&i.report(34,{itemId:r})}else if(null!=e&&null!=t&&e!==t){const d=l.getInterstitialForId(e)||{identifier:e},i=l.getInterstitialForId(t)||{identifier:t};this.Yi.trigger(c.INTERSTITIAL_ENDED,d?{event:d,appItemId:null==n?void 0:n.appItemId}:void 0),this.Yi.trigger(c.INTERSTITIAL_STARTED,i?{event:i,appItemId:null==n?void 0:n.appItemId}:void 0),r&&(null!=(e=this.ir)&&e.report(34,{itemId:r}),null!=(t=this.ir))&&t.report(31,{itemId:r})}})),l.playingInterstitialAssetId$.pipe(Kr(),cn(l.playingInterstitialId$,d.activeItemById$),Ee(([[e,t],i,r])=>{var n,a=null!=(n=null==r?void 0:r.parentItemId)?n:null==r?void 0:r.itemId;if(!a)return Se;var s=d.getQueueItemForId(a),o=l.getInterstitialForId(i);if(null==e&&null!=t){const e=o||{identifier:t},d=l.getInterstitialAssetForId(t)||{identifier:Kd(t)};this.Yi.trigger(c.INTERSTITIAL_ASSET_STARTED,{asset:d,event:e,appItemId:null==s?void 0:s.appItemId}),!a||null!=(n=this.ir)&&n.report(32,{itemId:a})}else if(null!=e&&null==t){const d=o||{identifier:e},t=l.getInterstitialAssetForId(e);this.Yi.trigger(c.INTERSTITIAL_ASSET_ENDED,{asset:t,event:d,appItemId:null==s?void 0:s.appItemId}),a&&t&&null!=(r=this.ir)&&r.report(33,{itemId:a,playTime:t.duration})}else if(null!=e&&null!=t&&e!==t){const d=o||{identifier:t},i=o||{identifier:e},r=l.getInterstitialAssetForId(e)||{identifier:Kd(e)},n=l.getInterstitialAssetForId(t)||{identifier:Kd(t)};if(this.Yi.trigger(c.INTERSTITIAL_ASSET_ENDED,{asset:r,event:i,appItemId:null==s?void 0:s.appItemId}),a&&r){const l=null!=(o=r)&&null!=o.identifier&&null!=o.url&&null!=o.duration?r.duration:NaN;null!=(e=this.ir)&&e.report(33,{itemId:a,playTime:l})}this.Yi.trigger(c.INTERSTITIAL_ASSET_STARTED,{asset:n,event:d,appItemId:null==s?void 0:s.appItemId}),!a||null!=(t=this.ir)&&t.report(32,{itemId:a})}}))):Se}desiredRateChanged(e,t){var i;fh(e)!==fh(t)?this.Vc=performance.now():this.Vc=NaN,null!=(i=this.ir)&&i.report(16,{oldRate:e,newRate:t}),this.Yi.trigger(c.DESIRED_RATE_CHANGED,{oldRate:e,newRate:t,appItemId:null==(i=this.Yi.playingItem)?void 0:i.appItemId})}Zc(e,i,t){if(i&&i.frag){var r=e.currentTime,r=e.getCombinedBufferInfo(r,0);if(r){var r=r.len?r.end:0,n=e.mediaElementDuration,a=e.bufferMonitorInfo;if(a){var a=Math.max(a.almostDryWaterLevelSeconds,a.lowWaterLevelSeconds/2),s=null==(l=this.Yi.itemQueue.playingItem)?void 0:l.itemId,o=e.getBufferedSegmentsByType(B.Variant);let t=!1;for(let e=o.length-1;0<=e;e--){const i=o[e];if(!i.evicting&&i.frag.itemId===s&&i.frag.isLastFragment){t=!0;break}}var l=n-i.endPTS;(0<r&&l<=a&&t||i.frag.isLastFragment&&i.frag.itemId===s)&&this.Yi.inGaplessMode&&!this.Yi.isPreloading&&this.Yi.trigger(c.READY_FOR_NEXT_ITEM,{duration:r,appItemId:null==(e=this.Yi.itemQueue.playingItem)?void 0:e.appItemId})}}}}Kc(){return this.qc.pipe(pr(Zi),Ee(e=>{this.Yi.trigger(e.eventName,e.payload)}))}handleLevelLoading(e){var{itemId:e,mediaOptionId:t,mediaOptionType:i,url:r}=e,e=this.Yi.itemQueue.getQueueItemForId(e),r={url:z(r),level:t,type:Vs[i],appItemId:null==e?void 0:e.appItemId};this.Yi.trigger(c.LEVEL_LOADING,r)}handleLevelLoaded(e,t,i){var{itemId:e,mediaOptionId:r}=e,n=(i=i||{complete:!1,loaded:NaN,tfirst:NaN,tload:NaN,tdataack:NaN,total:NaN,trequest:NaN},this.Yi.itemQueue.getQueueItemForId(e)),{interstitialId:a,interstitialAssetId:s}=null!=n?n:{},r={mediaOptionId:r,details:t,playlistType:t.type,stats:i,interstitialId:a,interstitialAssetId:s,appItemId:this.Yi.appItemIdFromItemId(t.itemId)},n=null!=(i=null!=(i=null==n?void 0:n.parentItemId)?i:null==n?void 0:n.itemId)?i:e;if(null!=(i=this.ir)&&i.report(8,{itemId:n,mediaOptionDetails:t,stats:r.stats}),this.Yi.trigger(c.LEVEL_LOADED,r),(null==t?void 0:t.mediaOptionType)===we.Variant&&null!=t&&t.daterangeTags){const e={daterangeTags:t.daterangeTags,itemId:t.itemId,interstitialId:a,interstitialAssetId:s,appItemId:this.Yi.appItemIdFromItemId(t.itemId),baseUrl:t.url};this.Yi.trigger(c.DATERANGE_UPDATED,e)}}handleLevelUpdated(e){e={level:e.mediaOptionId,details:e,appItemId:this.Yi.appItemIdFromItemId(e.itemId)};this.Yi.trigger(c.LEVEL_UPDATED,e)}Yc(e){this.qc.next(e)}postSubtitleTrackSwitch(e,t){var i=this.Yi.itemQueue.activeItem;"persistentID"in t?this.Yc({eventName:c.SUBTITLE_TRACK_SWITCH,payload:{track:Object.assign({},t),hidden:!1,interstitialId:t.interstitialId,interstitialAssetId:t.interstitialAssetId,appItemId:null==i?void 0:i.appItemId}}):this.Yc({eventName:c.SUBTITLE_TRACK_SWITCH,payload:{track:void 0,hidden:!1,interstitialId:null==i?void 0:i.interstitialId,interstitialAssetId:null==i?void 0:i.interstitialAssetId,appItemId:null==i?void 0:i.appItemId}})}postAudioTrackSwitched(e,t){if(t){const e=this.Yi.itemQueue.activeItem;this.Yc({eventName:c.AUDIO_TRACK_SWITCHED,payload:{id:t.id,track:t,interstitialId:t.interstitialId,interstitialAssetId:t.interstitialAssetId,appItemId:null==e?void 0:e.appItemId}})}}triggerBufferAppended(e){this.Yi.trigger(c.BUFFER_APPENDED,e)}triggerBufferedToInterstitialBoundary(e,t,i,r){this.Yi.trigger(c.BUFFERED_TO_INTERSTITIAL_BOUNDARY,{id:e,type:t,timestamp:i,willResetMediaSource:r,appItemId:null==(e=this.Yi.itemQueue.activeItem)?void 0:e.appItemId})}triggerReachedTimeToPauseBuffer(e,t){this.Yi.trigger(c.REACHED_TIME_TO_PAUSE_BUFFER,{timestamp:e,snapTimestamp:t,appItemId:null==(e=this.Yi.itemQueue.activeItem)?void 0:e.appItemId})}triggerManifestLoaded(e){var t=e.rootMediaOptionsTuple[we.Variant],i=t.filter(e=>e.iframes),r=e.appItemId,{interstitialId:n,interstitialAssetId:a}=jd(e.itemId),i={levels:t,audioTracks:e.rootMediaOptionsTuple[we.AltAudio],subtitleTracks:e.rootMediaOptionsTuple[we.Subtitle],iframeVariants:i,url:e.responseUrl,audioMediaSelectionGroup:e.audioMediaSelectionGroup,subtitleMediaSelectionGroup:e.subtitleMediaSelectionGroup,stats:e.stats,isMediaPlaylist:null!=(t=e.isMediaPlaylist)&&t,interstitialId:n,interstitialAssetId:a,appItemId:r};this.Yi.trigger(c.MANIFEST_LOADED,i)}triggerManifestParsed(e){var t={levels:e.mediaOptionListQueries[we.Variant].filteredMediaOptionList,firstLevel:0,audio:!1,video:!0,altAudio:!1,audioTracks:e.mediaOptionListQueries[we.AltAudio].filteredMediaOptionList,subtitleTracks:e.mediaOptionListQueries[we.Subtitle].filteredMediaOptionList,iframeVariants:null!=(t=null==(t=e.rootPlaylistEntity)?void 0:t.iframeVariants)?t:[],audioMediaSelectionGroup:e.audioMediaSelectionGroup,subtitleMediaSelectionGroup:e.subtitleMediaSelectionGroup,stats:e.loadStats,interstitialId:e.interstitialId,interstitialAssetId:e.interstitialAssetId,appItemId:e.appItemId,itemId:e.itemId};this.Yi.trigger(c.MANIFEST_PARSED,t),null!=(e=this.ir)&&e.report(14,{manifestParsedData:t})}triggerFragLoaded(e,t,i,r){var n,a={frag:e,stats:t,appItemId:this.Yi.appItemIdFromItemId(e.itemId)},s=this.Yi.itemQueue.getQueueItemForId(e.itemId),s=null!=(n=null!=(n=null==s?void 0:s.parentItemId)?n:null==s?void 0:s.itemId)?n:e.itemId;null!=(n=this.ir)&&n.report(5,{itemId:s,frag:e,stats:t,bwStatus:i,bwEstimate:r}),this.Yi.trigger(c.FRAG_LOADED,a)}triggerPrefetchNextItem(e){this.Yi.trigger(c.READY_TO_PREFETCH_NEXT_ITEM,{appItemId:e})}}class xy extends ga{constructor(e){super(e)}get currentConfig(){var e;return null==(e=this.getActive())?void 0:e.config}get extendMaxTTFB(){var e;return null==(e=this.getActive())?void 0:e.extendMaxTTFB}get activeDequeueCount(){var e;return null!=(e=null==(e=this.getActive())?void 0:e.activeDequeueCount)?e:0}get activeDequeueCount$(){return this.selectActive(e=>{return null!=(e=null==e?void 0:e.activeDequeueCount)?e:0})}get holdingAirplayInterstitialSeek(){var e;return null==(e=this.getActive())?void 0:e.holdingAirplayInterstitialSeek}get config$(){return this.selectActive(e=>null==e?void 0:e.config)}get pendingSeek(){var e;return null==(e=this.getActive())?void 0:e.userSeek}get pendingSeek$(){return this.selectActive(e=>null==e?void 0:e.userSeek)}get alternateMatchingInfo(){var e;return null==(e=this.getActive())?void 0:e.alternateMatchingInfo}get alternateMatchingInfo$(){return this.selectActive(e=>null==e?void 0:e.alternateMatchingInfo)}}class Ny extends ua{constructor(){super({},{name:"hls-store"})}}class Fy{constructor(e){this.Me=e,this._i=new xy(e)}get query(){return this._i}setHlsEntity(e){const t=e.id;Oe(()=>{this.Me.add(Y(e)),this.Me.setActive(t)})}removeEntity(e){this.Me.remove(e)}setUserSeek(e){this.Me.updateActive({userSeek:e})}setExtendMaxTTFB(e){this.Me.updateActive({extendMaxTTFB:e})}incrementActiveDequeueCount(){var e=this.query.activeDequeueCount+1;this.Me.updateActive({activeDequeueCount:e})}decrementActiveDequeueCount(){var e=this.query.activeDequeueCount-1;this.Me.updateActive({activeDequeueCount:e})}addHoldingInterstitialSeek(e,t,i){this.Me.updateActive({holdingAirplayInterstitialSeek:{originalSeekTo:e,itemId:t,isInterstitial:i}})}clearHoldingInterstitialSeek(){this.Me.updateActive({holdingAirplayInterstitialSeek:void 0})}set config(e){this.Me.updateActive({config:e})}setAlternateMatchingInfo(e){this.Me.updateActive({alternateMatchingInfo:e})}setAudioAlternateMatchingInfo(e){var t=this._i.getActive();t&&(t=Object.assign(Object.assign({},t.alternateMatchingInfo),{audioMatchingInfo:e}),this.Me.updateActive({alternateMatchingInfo:t}))}setSubtitleAlternateMatchingInfo(e){var t=this._i.getActive();t&&(t=Object.assign(Object.assign({},t.alternateMatchingInfo),{subtitleMatchingInfo:e}),this.Me.updateActive({alternateMatchingInfo:t}))}reset(){this._i.getActive()&&this.Me.updateActive({alternateMatchingInfo:void 0,userSeek:void 0,extendMaxTTFB:void 0})}destroy(){this.Me.destroy()}}class By{constructor(e){this.eh=e}updateInterstitialAudioSelectedPersistentId(e,t,i,r){var n="string"==typeof i,e={persistentId:e,language:void 0,name:void 0,characteristics:void 0},{itemQueue:a,interstitialService:s,mediaElementQuery:o,config:l}=this.eh,o=wy(t,a,o,l.maxBufferHole,i),d=a.activeItem,u=a.playingItem;let c,h=-1;if(u.interstitialId===t)c=u,h=a.queueItems.findIndex(e=>e.itemId===t);else{const e=n?a.getItemDetailsForAssetId(i):a.getFirstItemDetailsForInterstitialId(t);c=e.item,h=e.index}const p=Le(c),m=ke(d)||ke(u)||o.find(e=>e&&nh.isTimeRangeContainedInRanges(e,{start:r+p,end:r+p}));n?s.updateAltAudioSelectedMatchingInfoForInterstitialAsset(i,e):s.updateAltAudioSelectedMatchingInfoForInterstitial(t,e),m&&c&&(l.interstitialsConfiguredForAirPlayReceiver?this.ih(we.AltAudio,c,h,r):this.sh(we.AltAudio,c,r))}updateInterstitialSubtitleSelectedPersistentId(e,t,i,r){var{itemQueue:n,mediaElementQuery:a,config:s,interstitialService:o}=this.eh,l="string"==typeof i,e=-1===e?null:{persistentId:e,language:void 0,name:void 0,forced:!1,characteristics:void 0},a=wy(t,n,a,s.maxBufferHole,i),d=n.activeItem,u=n.playingItem;let c,h=-1;if(u.interstitialId===t)c=u,h=n.queueItems.findIndex(e=>e.interstitialId===t);else{const e=l?n.getItemDetailsForAssetId(i):n.getFirstItemDetailsForInterstitialId(t);c=e.item,h=e.index}const p=Le(c),m=ke(d)||ke(u)||a.find(e=>e&&nh.isTimeRangeContainedInRanges(e,{start:r+p,end:r+p}));l?o.updateSubtitleSelectedMatchingInfoForInterstitialAsset(i,e):o.updateSubtitleSelectedMatchingInfoForInterstitial(t,e),m&&c&&(s.interstitialsConfiguredForAirPlayReceiver?this.ih(we.Subtitle,c,h,r):this.sh(we.Subtitle,c,r))}getCurrentIntegratedTimelineSegmentAndCurrentTime(t,i){const{itemQueue:e,interstitialService:r}=this.eh,n=r.interstitialQuery,a=null!=t?t:n.integratedTimeline;if(!a||0===a.segments.length)return{segment:null,targetTime:i,sourceTime:i};if(1===a.segments.length)return{segment:a.segments[0],targetTime:i,sourceTime:i};var s=e.playingItem;if(s&&ke(s)){const t=s.interstitialId,e=a.segments.find(e=>e.interstitialEventIdentifier===t);if(!e)return{segment:null,targetTime:i,sourceTime:i};const r=e.timeMapping["target"];return{segment:e,targetTime:Math.min(r.end,r.start+i),sourceTime:i}}let o=ee(a.segments,e=>{var t=e.timeMapping["source"];return!e.interstitialEventIdentifier&&t.start<=i&&i<=t.end});return(o=o||ee(a.segments,e=>{e=e.timeMapping["target"];return e.start!==e.end&&e.start<=i&&i<=e.end}))?({source:t,target:s}=o.timeMapping,t=(o.segmentType===Eo.Interstitial?s:t).start,{segment:o,targetTime:Math.max(0,i-t)+s.start,sourceTime:i}):{segment:null,targetTime:i,sourceTime:i}}ih(e,t,i,r){var{itemQueue:n,rootPlaylistService:a,legibleSystemAdapter:s}=this.eh,o=n.playingItem,l=n.activeItem,d=o.itemId===t.itemId,r=d?r+Le(o):t.itemStartOffsets[0],o=(a.setAVAnchor(null==l?void 0:l.itemId,null),{parentItemId:t.parentItemId,itemId:t.itemId}),u=(e===we.AltAudio&&(o.userSwitchAudioTrack=!0),e===we.Subtitle&&(o.userSwitchSubtitleTrack=!0,s.removeLaterCues(r)),n.setActive(null,{itemStartOffsets:t.itemStartOffsets}),d?n.setActiveWithContext(t.itemId,o,{itemTimelineEndPosition:1/0,initialSeekTime:r,seekImmediately:!0}):n.setActiveWithContext(t.itemId,o,{itemTimelineEndPosition:1/0}),n.queueItems);for(let e=i+1;e<u.length;e++){const t=u[e].itemId;n.updateItemById(t,{itemStartOffsets:[0,0],itemTimelineEndPosition:1/0,initialSeekTime:0})}}sh(e,t,i){const{itemQueue:r,legibleSystemAdapter:n,interstitialController:a,interstitialService:s,mediaElementAdapter:o,rootPlaylistService:l}=this.eh,d=r.playingItem,u=t.interstitialId,c=this.getCurrentIntegratedTimelineSegmentAndCurrentTime(void 0,i)["sourceTime"],h=Le(t),p=Math.max(h-1,0);e===we.Subtitle&&n.removeLaterCues(p),d.interstitialId===u&&(a.interstitialSeekInfo={identifier:u,time:c}),a.reset(!0),s.setActiveInterstitialAssetId(null),s.setActiveInterstitialId(null),s.removeInterstitialsFromPastEventsFromTime(p),o.flushAndCallback(p,1/0,()=>{Oe(()=>{var e;if(d.interstitialId===u)l.setAVAnchor(null==(e=r.activeItem)?void 0:e.itemId,null),r.setActive(t.parentItemId,{itemTimelineEndPosition:1/0,initialSeekTime:p,seekImmediately:!0}),r.setPlayingItem(r.getQueueItemForId(t.parentItemId)),1<r.queueItems.length&&r.removeQueueItemsAfterId(t.parentItemId);else if(ke(d)){const e=r.getPrimaryItemBeforeItem(t);e&&(r.setActive(e.itemId),1<r.queueItems.length)&&r.removeQueueItemsAfterId(e.itemId)}else{const e=Le(d);r.setActive(d.itemId,{itemTimelineEndPosition:1/0,initialSeekTime:c+e,seekImmediately:!0}),1<r.queueItems.length&&r.removeQueueItemsAfterId(d.itemId)}})})}}(e=void 0||{}).AlmostDryWaterLevel="AlmostDryWaterLevel",e.LowWaterLevel="LowWaterLevel",e.HighWaterLevel="HighWaterLevel",(bs=Gf=Gf||{})[bs.Enter=0]="Enter",bs[bs.Exit=1]="Exit";class Uy extends ga{}function _y(e,t,i,r,n,a,s,o){var{appItemId:l,clientName:d,serviceName:u,platformInfo:c}=e,o={appItemId:null!=o?o:l,clientName:d,serviceName:u,platformInfo:c,initialRate:i,initialSeekTime:r,timeToPauseBuffer:n,snapIn:s,playoutLimit:a};return t&&(o.parentItemId=null!=(l=e.parentItemId)?l:e.itemId),o}class Vy{constructor(e,t,i){this.oh=e,this.R=t,this.ah=i,this.lh=!0,this.uh=null,this.playing$=new jr(null),this.hh=new jr(null),this._i=new Uy(e)}static createItem(e,t,i,r,n={}){var a,s=new Date,s=`${s.getHours()}:${s.getMinutes()}:${s.getSeconds()}.`+s.getMilliseconds(),o=(o=t,(o=null==(o=La.parseURL(o))?void 0:o.fragment.substr(1))&&0!==o.length&&(o=new URLSearchParams(o)).has("t")&&fe(o=Number(o.get("t")))?o:null);let l=null!=(a=n.initialSeekTime)?a:NaN;fe(l)||(fe(o)?l=o:fe(i.startPosition)&&(l=i.startPosition));var o=0<(null!=(a=n.interstitialId)?a:"").length;return{itemId:e+`_`+s,parentItemId:n.parentItemId,clientName:n.clientName,serviceName:n.serviceName,appItemId:n.appItemId,initialRate:n.initialRate,platformInfo:n.platformInfo,loopCount:n.loopCount,itemStartOffsets:n.itemStartOffsets||[0,0],seekImmediately:n.seekImmediately,initialSeekTime:l,name:e,url:t,config:{},interstitialId:n.interstitialId,interstitialAssetId:n.interstitialAssetId,itemTimelineStartPosition:null,itemTimelineEndPosition:1/0,timeToPauseBuffer:o?n.playoutLimit:n.timeToPauseBuffer,snapOut:n.snapOut,snapIn:n.snapIn,playoutLimit:o?n.playoutLimit:void 0,replaceItemAction:n.replaceItemAction}}get query(){return this._i}get activeItemById$(){return this._i.selectActiveId().pipe(ve(e=>this._i.getActive()))}get activeItem$(){return this._i.selectActive()}get removedItems$(){return this._i.selectEntityAction(qn.Remove).pipe(ve(e=>e))}get activeItem(){return this._i.getActive()}getQueueItemForId(e){return this._i.getEntity(e)}getQueueItemForItemIdentifier(e){var{itemId:e,appItemId:t,interstitialAssetId:i}=e;return e?this.getQueueItemForId(e):t?this.getQueueItemForAppItemId(t):i?this.getQueueItemForInterstitialAssetId(i):void 0}get queueItems$(){return this._i.selectAll().pipe(ve(e=>null!=e?e:[]))}get queueItems(){return this._i.getAll()}get isFirstItem(){return this.lh}get playingItem(){var e=this.playing$.getValue();return this.getQueueItemForId(null==e?void 0:e.itemId)}get loadingItem(){var e,t;return null==this.playingItem||(e=(t=this._i.getAll()).findIndex(e=>{return e.itemId===(null==(e=this.playingItem)?void 0:e.itemId)}))<0||e>=t.length-1||(t=t[e+1],this.ah.interstitialsConfiguredForAirPlayReceiver&&!fe(t.itemTimelineStartPosition))?null:t}addQueueItem(e,t,i,r={}){let n;return this.prefetchItem&&r.appItemId&&this.prefetchItem.appItemId===r.appItemId?(n=Object.assign(Object.assign({},this.prefetchItem),r),this.hh.next(null)):n=Vy.createItem(e,t,i,this.R,r),null!=this.playingItem&&(n.initialSeekTime=void 0),null!=r&&r.itemStartOffsets&&(n.itemStartOffsets=r.itemStartOffsets,this.lh=!1,this.playing$.next(null!=(e=this.activeItem)?e:null)),Oe(()=>{this.oh.add(n),this.oh.setActive(n.itemId)}),n}addPrefetchItem(t,i,r,n,a={}){var s=a.appItemId;if(null!=s){let e;var o=this.activeItem;return o&&o.appItemId===s?e=Object.assign(Object.assign(Object.assign({},o),a),{itemId:o.itemId}):(e=Vy.createItem(t,i,r,this.R,a),null!=a&&a.itemStartOffsets&&(e.itemStartOffsets=a.itemStartOffsets)),this.hh.next({item:e,recallStrategy:n}),e}}clearPrefetchItem(){this.hh.next(null)}get prefetchItemInfo$(){return this.hh.asObservable()}get prefetchItem(){var e;return null==(e=this.hh.getValue())?void 0:e.item}get primaryItem(){var e=null!=(e=null==(e=this.playingItem)?void 0:e.parentItemId)?e:null==(e=this.playingItem)?void 0:e.itemId;return e?this._i.getEntity(e):this.queueItems[0]}insertQueueItem(e){this.oh.add(e)}setPlayingItem(e){this.playing$.next(e)}getItemTimelineEndPosition(e){e=this.getQueueItemForId(e);return null==e?void 0:e.itemTimelineEndPosition}updatePlayingItemId(e=!0){this.playing$.next(this.loadingItem),e&&this.clearAllButActive()}resetLoadingItem(e=!0){Oe(()=>{this.loadingItem&&e&&this.removeQueueItem(this.loadingItem.itemId),this.playingItem&&this.oh.setActive(this.playingItem.itemId)})}getQueueItemForTime(r,n=!1){return ee(this.queueItems,e=>{var t=!fe(e.itemTimelineEndPosition)||r<=e.itemTimelineEndPosition,i=ke(e);if(fe(e.itemTimelineStartPosition)&&r>=e.itemTimelineStartPosition&&t&&(!i||i&&n))return!0})}getPrimaryItemBeforeItem(t){let i,r=!1;for(let e=this.queueItems.length-1;0<e;e--){var n=this.queueItems[e];if(r){if(null==n.interstitialId){i=n;break}}else t.itemId===n.itemId&&(r=!0)}return i}getQueueItemForInterstitialAssetId(t){return this.queueItems.find(e=>0<e.itemId.indexOf(t))}getQueueItemForAppItemId(t){return this.queueItems.find(e=>e.appItemId===t)}getFirstItemDetailsForInterstitialId(t){var e=this.queueItems.findIndex(e=>e.itemId.startsWith(`interstitial:${t}:`));return{item:this.queueItems[e],index:e}}getItemDetailsForAssetId(t){var e=this.queueItems.findIndex(e=>0<e.itemId.indexOf(`:asset_`+t));return{item:this.queueItems[e],index:e}}getLastItemDetailsForInterstitialId(t){for(let e=this.queueItems.length-1;0<=e;e--){var i=this.queueItems[e];if(0===(null==i?void 0:i.itemId.indexOf(`interstitial:${t}:`)))return{item:i,index:e}}return{item:void 0,index:-1}}dh(e,t={}){var{initialSeekTime:t,itemStartOffsets:i,seekImmediately:r,itemTimelineEndPosition:n,itemTimelineStartPosition:a,replaceItemAction:s,timeToPauseBuffer:o}=t,l=this._i.getEntity(e);this.lh=!1;const d={initialSeekTime:null!=t?t:null==l?void 0:l.initialSeekTime,itemStartOffsets:null!=i?i:null==l?void 0:l.itemStartOffsets,seekImmediately:null!=r?r:null==l?void 0:l.seekImmediately,itemTimelineStartPosition:null!=a?a:null==l?void 0:l.itemTimelineStartPosition,itemTimelineEndPosition:null!=n?n:null==l?void 0:l.itemTimelineEndPosition,replaceItemAction:null!=s?s:null==l?void 0:l.replaceItemAction,timeToPauseBuffer:null!=o?o:null==l?void 0:l.timeToPauseBuffer};Oe(()=>{null!==e&&this.oh.update(e,d),this.oh.setActive(e),d.seekImmediately&&this.setPlayingItem(this._i.getEntity(e))})}setActiveWithContext(e,t,i={}){this.uh&&this.uh.itemId===e&&null!=e?(this.uh.parentItemId=(null==t?void 0:t.parentItemId)||this.uh.parentItemId,this.uh.userSwitchAudioTrack=(null==t?void 0:t.userSwitchAudioTrack)||this.uh.userSwitchAudioTrack,this.uh.userSwitchSubtitleTrack=(null==t?void 0:t.userSwitchSubtitleTrack)||this.uh.userSwitchSubtitleTrack,this.uh.reloadedForCapChangeOrErrorRecovery=(null==t?void 0:t.reloadedForCapChangeOrErrorRecovery)||this.uh.reloadedForCapChangeOrErrorRecovery):this.uh=t,this.dh(e,i)}reset(){Oe(()=>{this.resetInternal(),this.playing$.next(null)})}resetInternal(){this.clearQueue(),this.uh=null,this.lh=!0}setActive(e,t={}){var i;(null==(i=this.uh)?void 0:i.itemId)!==e&&null!=e&&(this.uh=null),this.dh(e,t)}getActiveItemContext(e){var t;return(null==(t=this.uh)?void 0:t.itemId)===e&&null!=e?this.uh:null}clearActiveItemContext(e){var t;(null==(t=this.uh)?void 0:t.itemId)===e&&null!=e&&(this.uh=null)}updateItemById(e,t){this.oh.update(e,t)}isPreloading(){return null!=this.playingItem&&null!=this.loadingItem}setQueueItem(e,t,i,r){var n;let a;this.prefetchItem&&r.appItemId&&this.prefetchItem.appItemId===r.appItemId?(a=Object.assign(Object.assign(Object.assign({},this.prefetchItem),r),{initialSeekTime:null!=(n=r.initialSeekTime)?n:0}),this.hh.next(null)):a=Vy.createItem(e,t,i,this.R,r),Oe(()=>{this.oh.remove(),this.oh.add(a),this.oh.setActive(a.itemId)}),this.playing$.next(null!=(n=this.activeItem)?n:null)}removeQueueItem(e){this.oh.remove(e)}removeQueueItemsAfterId(i){let r=-1;this.queueItems.forEach((e,t)=>{r<0&&e.itemId===i?r=t:0<=r&&t>r&&this.removeQueueItem(e.itemId)})}clearQueue(){this.oh.remove()}clearAllButActive(){var e;const t=null==(e=this.activeItem)?void 0:e.itemId;Oe(()=>{this._i.getAll().forEach(e=>{e.itemId!==t&&this.oh.remove(e.itemId)})})}}class Qy{constructor(e,t,i,r,n,a,s,o,l,d,u){this.fh=e,this.Rc=t,this.ph=i,this.gh=r,this.Fc=n,this.yh=a,this._o=s,this.Sh=o,this.Ke=l,this.wh=d,this.activeInterstitialId=null,this._primaryQueueItem=null,this.readyForQueueInterstitialSource=!1,this.Ih=NaN,this.Th=null,this.Oh=-1,this.kh=new Ie,this.Mh=[],this.Ah=null,this.Eh=[null,null],this.savedSeekValueById={},this.Nh=null,this.Rh=new Ie,this.Ph=[!1,!1],this._h=[!1,!1],this.Ch={},this.xh=new Ie,this.R=u.child(Qy.loggerName),this.Dh=new Set}get config(){return this.yh}reset(e=!1){this.Th=null,this.Oh=-1,this.Ah=null,this.Eh=[null,null],this.Ch={},this.Mh=[],this.activeInterstitialId=null,this._primaryResumptionTime=void 0,e||(this.Nh=null),this._h=[!1,!1],this.Ph=[!1,!1]}set mediaQuery(e){this.jr=e}set interstitialSeekInfo(e){this.Nh=e}get interstitialQuery(){return this.Rc.interstitialQuery}get activeInterstitial(){return this.activeInterstitialId?this.Rc.interstitialQuery.getInterstitialForId(this.activeInterstitialId):null}interstitialEpic(i){return e=>e.pipe(Yl(),Ae(e=>{this.mediaQuery=e;var t,n,e=this.config.interstitialsConfiguredForAirPlayReceiver?Se:(t=e,e=this.fh,n=this.Fc,e.playing$.pipe(Yl(),Ae(r=>ke(r)&&r.playoutLimit?t.gotFirstAppend$(Zi).pipe(Ae(()=>ol(t.timeupdate$,e=>{return!(!(r&&ke(r)&&r.playoutLimit)||(t=C(r.playoutLimit),e-Le(r)<t));var t})),ve(e=>{var t=n.getQueryForItem(r.itemId),i=t.mediaLibraryEntity.lastLoadedMediaOptionIds[we.Variant],t=t.mediaLibraryEntity.mediaOptionDetailsEntityRecord[i],i=null==t?void 0:t.mediaOptionDetails,i=null!=(t=null==i?void 0:i.fragments)?t:[],t=i[i.length-1];if(t)return t.start+t.duration})):Se)).pipe(Ee(e=>{fe(e)&&i.setUserSeek(e)})));return ll(this.Lh,this.Fh,this.jh,e,this.Bh,this.Uh,this.$h,this.Vh,this.integratedTimeline$,this.qh)}))}reachedTimeToPauseBuffer$(p,m){return this.config.interstitialsConfiguredForAirPlayReceiver?br([p.updating$,p.timeupdate$,p.desiredRate$]).pipe(Ae(([e,o,i])=>{const l=this.fh.activeItem,r=this.fh.playingItem;if(!e){const d=p.expectedSbCount,n=ke(l),a=l.timeToPauseBuffer,u=a?C(a):NaN;let s;if(fe(u)){const c=l.itemId===(null==r?void 0:r.itemId)?o:l.initialSeekTime,h=p.getBufferInfo(c,this.config.maxBufferHole);let e,t;if((t=fh(i)&&this.wh.isStarted&&this.wh.forward?this.wh.getCurrentTime().seconds>=u:Hs.every(t=>{if(t===d||0===u)return!0;var i=h[t],r=h[Math.abs(t-1)],n=Le(l),a=u+n;if(fe(o-n)&&0<(null==i?void 0:i.bufferedSegments.length)){const{start:o,end:l}=i.buffered;let e=o;if(t<d&&0<(null==r?void 0:r.bufferedSegments.length)){const p=r.buffered["start"];e=Math.min(o,p)}if(e<=a&&l>=a)return t===we.Variant&&(s=this.Hh(p,a,n)),!0}return!1}))&&!n&&(e=fe(s)&&l.snapOut?x(s,1e3):void 0,this.Sh.triggerReachedTimeToPauseBuffer(a,e)),t&&l&&fe(u)){const p=!ke(l)&&fe(s)&&l.snapOut?s:u;return this.fh.updateItemById(l.itemId,{itemTimelineEndPosition:p,snapTimeToPauseBuffer:e}),m.setAVAnchor(l.itemId,null),be(!0)}}}return Se})):Se}get Lh(){return this.config.interstitialsConfiguredForAirPlayReceiver?this.Qh.pipe(cn(this.gh),Ae(([{nextItem:t,nextItemOffsets:i},r])=>{if(r){var n=null!=i?i:this.getCurrentBufferOffsets(r,Ia.Midroll,t).map((e,t,i)=>fe(e)&&0!==e?e:i[we.Variant]);let e;if(ke(t))this.Kh(t)&&this.Rc.updateRealCurrentTimeOffsetMap(t.interstitialId,n);else{const i=n[we.Variant];e=fe(i)&&fe(t.initialSeekTime)?i+t.initialSeekTime:void 0}r.getCurrentWaterLevel(this.config.maxBufferHole);i=0===n[we.Variant]?Ua.FLUSH_ALL:Ua.DO_NOTHING,r=Math.max(fe(e)?e-n[we.Variant]:n[we.Variant],0);this.fh.setActive(t.itemId,{itemStartOffsets:n,initialSeekTime:e,itemTimelineStartPosition:r,itemTimelineEndPosition:1/0,replaceItemAction:i})}return Se})):Se}Kh(t){var e;return!!t&&(e=this.fh.queueItems.findIndex(e=>e.itemId===t.itemId),e=this.fh.queueItems[e-1])&&(null==e?void 0:e.interstitialId)!==t.interstitialId}cancelInterstitial(e,t,i,r){this.Rh.next({all:e,seekTo:t,initialRate:i,seekImmediately:r})}get Vh(){return this.config.interstitialsConfiguredForAirPlayReceiver?this.Rc.interstitialQuery.playingInterstitialId$.pipe(tn(1),Ee(i=>{const e=this.fh.queueItems,t=this.fh.activeItem;if(null==i&&1<e.length&&t){const i=e.findIndex(e=>e.itemId===t.itemId);i&&e.forEach((e,t)=>{ke(e)&&t<i&&this.fh.removeQueueItem(e.itemId)})}})):Se}get jh(){return br([this.ph,this.gh]).pipe(Ae(([e,t])=>{if(!e)return Se;const{config:a,Fc:i}=this;return a.enableInterstitialPlayback&&!a.interstitialsConfiguredForAirPlayReceiver&&t?_n([i.query.selectEntity(e.itemId).pipe(ve(e=>null==e?void 0:e.liveOrEvent)),this.Rc.interstitialQuery.playableInterstitials$,t.isBufferedToEnd$(a.maxBufferHole,!1)]).pipe(Ae(([e,t,i])=>{var r=this.fh.playingItem,n=r&&ke(r);if(e||!i||this.activeInterstitial||n)return Se;this._primaryQueueItem&&this._primaryQueueItem.itemId===(null==r?void 0:r.itemId)||(this._primaryQueueItem=r);e=t.filter(e=>e.cueType===Ia.Postroll);return e.length<1?Se:this.Wh(e,void 0,[],[],a).pipe(Ae(e=>(0<e.length&&null!=this.Ah&&(this.Ah=null),0!==e.length&&(this.Th=e,this.Gh(this.mediaQuery,1/0)),Se)))})):Se}))}fragmentIsInterstitialBoundary(a,m){var f,e;const{config:g,mediaLibraryService:t,mediaSink:i,iframeMode:r,isAnchor:y}=m,n=be(!1);if(a.iframe||a.mediaOptionType===we.Subtitle||r)return n;const v=a.mediaOptionType,s=this.Rc.interstitialQuery,o=g.enableInterstitialPlayback&&!g.interstitialsConfiguredForAirPlayReceiver?s.playableInterstitials:[],l=s.integratedTimeline;if(0===o.length)return n;var d=this.fh.getQueueItemForId(a.itemId);if(!d)return n;const I=a.start,S=I+a.duration,b=t.getQueryForOption(a).mediaOptionDetails,T=null!=(f=null==b?void 0:b.fragments)?f:[],A=null!=(m=null==b?void 0:b.pdtToMSN)?m:[];if(ke(d)){if(this.activeInterstitial){const a=s.getInterstitialForId(this.activeInterstitial.identifier);if(null!=a&&a.playoutLimit){const m=C(a.playoutLimit),f=this.getInterstitialStartTime(a,A,T);I>=f+m&&this.cancelInterstitial(!1)}}return n}this._primaryPlaylistType=null==b?void 0:b.type,this._primaryQueueItem&&this._primaryQueueItem.itemId===d.itemId||(this._primaryQueueItem=d);let E=NaN,u=this.Ah;const O=null!=(m=null==(f=this.jr)?void 0:f.expectedSbCount)?m:0,w=C(Qy.kInterstitialPrecisionStartTolerance),R=C(Qy.kFragStartTolerance);if(null==u){let h=NaN;const m=(null==(e=i.mediaQuery)?void 0:e.desiredPos)-Le(d),f=Ry(m,l);let p;if((null==f?void 0:f.segmentType)===Eo.Interstitial){const a=o.find(e=>e.identifier===f.interstitialEventIdentifier);a&&(p=this.getInterstitialStartTime(a,A,T))}u=o.filter(t=>{var e,i=t.cueType===Ia.Preroll,r=t.cueType===Ia.Midroll,n=null!=(n=t.snapOptions)?n:Sa.None,a="VOD"===this._primaryPlaylistType&&this._primaryQueueItem?this._primaryQueueItem.itemStartOffsets:[0,0],s=this.getInterstitialStartTime(t,A,T),o=!fe(h)||s===h,a=a[v]+s,l=Math.abs(I-a)<=R,d=fe(p)&&s===p,r=d||(l||I<=a)&&S+w>a&&r,u=!fe(m)||0==m||0<=a-m;let c=!1;if(g.enablePartialInterstitialPlaybackForLiveEdge&&null!=b&&b.liveOrEvent&&fe(t.duration)){c=a<=I&&a+t.duration>I;const h=(null==(e=b.fragments[b.fragments.length-1])?void 0:e.start)||0,m=Am(b,g.liveAllowLowLatencyPlayback)-Qm(b,g),f=h-a;E=Math.max(0,f-m)}if((i||r||c||d)&&o&&!this.activeInterstitial&&(u||d)){const p=y&&1<O&&!d;return f&&d&&!this.Nh&&(this.Nh={identifier:f.interstitialEventIdentifier,time:m}),!!(i||l||c||d)||(this.Ah||(h=s,this.Ah=[]),(0===this.Ah.length||this.Ah.findIndex(e=>e.identifier===t.identifier)<0)&&this.Ah.push(t),this.Eh[v]||(this.Eh[v]=S-a),n===Sa.Out||n===Sa.InOut?a-I<S-a?(this.Ah=null,v===we.Variant&&(this.Ch[t.identifier]=x(I,1e3),this.Eh[v]=0),!0):(v===we.Variant&&(this.Ch[t.identifier]=x(S,1e3)),p):p)}return!1})}if(null==u||0===u.length)return n;const c=u[0],h=c.cueType===Ia.Preroll,p=("VOD"===this._primaryPlaylistType?this._primaryQueueItem.itemStartOffsets[v]:0)+this.getInterstitialStartTime(c,A,T),M=c.snapOptions===Sa.Out||c.snapOptions===Sa.InOut,P=I<=p-w&&S>p-w;return h||fe(this.Eh[v])||!P||(this.Eh[v]=S-p),(I>=p-R||P&&M)&&(this._h[v]=!0),(this.Th&&0!==this.Th.length?be(this.Th):this.Wh(u,E,A,T,g)).pipe(cn(this.gh),ve(([e,t])=>{if(0===e.length||!e.some(e=>0<e.assets.length))return this.reset(),!1;if(this.Th=e,!h&&!this._h.every((e,t)=>t>=O||e))return this._h[v];this.Ah=null;var e=e[0].interstitial,i=e.snapOptions,i=i===Sa.In||i===Sa.InOut;let r=0;var n=this.getInterstitialStartTime(e,A,T);if(e.cueType!==Ia.Preroll&&(r=i?a.start:n),null!=b&&b.liveOrEvent){const e=Am(b,g.liveAllowLowLatencyPlayback);this.Ih=e-a.start-r}return this.Xh(this.Ch),this.Ch={},this.Gh(t,r)}))}get dequeueSequence(){return this.xh.pipe(Pr(e=>e?e.interstitialId?(this.Dh.add(e.interstitialId),this.dequeueInterstitialWithInterstitialId(e.interstitialId,e.mediaElementAdapter,e.hlsService,e.rootPlaylistService)):e.assetId?(this.Dh.add(e.assetId),this.dequeueInterstitialWithAssetId(e.assetId,e.mediaElementAdapter,e.hlsService,e.rootPlaylistService)):be(void 0):be(void 0)),Ee(e=>{this.Dh.delete(e)}))}fragmentAppended(e){this.kh.next(e)}get integratedTimeline$(){var e=this.Rc.interstitialQuery.interstitials$.pipe(Te((i,e)=>!e.some((e,t)=>{t=i[t];return e.duration!==(null==t?void 0:t.duration)||e.identifier!==(null==t?void 0:t.identifier)})));return br([this.ph,e]).pipe(Ae(([e,i])=>!e||e.isInterstitial?Se:Bg(e,this.Fc).pipe(Te(([e],[t])=>Am(e,!0)===Am(t,!0)),ve(([e])=>{var t=this.fh.getQueueItemForId(e.itemId),t=Uo(e.totalduration,i,t.itemStartOffsets[B.Variant],e.pdtToMSN,e.fragments,this.config);return this.Rc.updateIntegratedTimeline(t),t}))))}get qh(){return this.ph.pipe(Ae(e=>e?Bg(e,this.Fc).pipe(Te(([e],[t])=>Am(e,!0)===Am(t,!0)),Ae(([e])=>{if(!this.Th||0===this.Th.length)return Se;var t=this.Th[this.Th.length-1];if(!t)return Se;const i=Qo(t.interstitial,this.interstitialQuery.playableInterstitials,e.pdtToMSN,e.fragments,this.Rc,this.config);return 0===i.length?Se:xo({interstitials:i},null==(t=this.fh.activeItem)?void 0:t.appItemId,this.config,this.config,this.config.playlistLoadPolicy,this.Ke,this.R).pipe(Ee(r=>{var e=i.reduce((e,t)=>{var i=r[t.identifier];return i&&e.push({interstitial:t,assets:i}),e},[]);0<e.length&&this.Th.push(...e)}))})):Se))}Wh(e,t,i,r,n){var a=e.length;return a<1?be([]):(a=Qo(e[a-1],this.interstitialQuery.playableInterstitials,i,r,this.Rc,n),xo({interstitials:[...e,...a],startOffset:t},null==(i=this.fh.activeItem)?void 0:i.appItemId,n,n,n.playlistLoadPolicy,this.Ke,this.R).pipe(ve(r=>e.reduce((e,t)=>{var i=r[t.identifier];return i&&e.push({interstitial:t,assets:i}),e},[]))))}Gh(r,n){return!(!this.Th||this.Oh>this.Th.length||!this.Th.find(()=>{var e,t=null==(e=this.Th)?void 0:e[++this.Oh];if(t){const{interstitial:e,assets:i}=t;if(this.Nh&&this.Nh.identifier!==e.identifier)return!1;if(this.Yh(e,i,n,r))return!0}return!1}))}get Qh(){return this.fh.queueItems$.pipe(Ae(e=>{var n;const a=this.fh.activeItem;if(fe(null==a?void 0:a.itemTimelineEndPosition)){let r;if(a.playoutLimit){const n=a.interstitialId;let i=-1;r=e.find((e,t)=>{if(0<i&&t>i){if(!ke(e))return!0;if(r.interstitialId!==n)return!0}else e.itemId===a.itemId&&(i=t);return!1})}else{const n=e.findIndex(e=>e.itemId===a.itemId);r=e[n+1]}if(r){const e=null!=(n=a.snapTimeToPauseBuffer)?n:a.timeToPauseBuffer,t=e?C(e):NaN,i=fe(t)?a.itemStartOffsets.map(e=>e+t):null;return be({curItem:a,nextItem:r,nextItemOffsets:i})}}else if(!a&&1<this.fh.queueItems.length){const e=this.fh.queueItems,n=function(t){if(Array.isArray(t)&&!(t.length<1))for(let e=t.length-1;0<=e;e--)if(!fe(t[e].itemTimelineEndPosition))return e}(e),a=e[n],r=e[n-1];if(a){let e=null;if(r&&!ke(r)){const n=r.timeToPauseBuffer?C(r.timeToPauseBuffer):NaN;e=fe(n)?r.itemStartOffsets.map(e=>e+n):null}return be({curItem:null,nextItem:a,nextItemOffsets:e})}}return Se}))}get Bh(){const r=this.Rc.interstitialQuery;return r.activeInterstitialId$.pipe(pr(Zi),Yl(),cn(this.gh),ve(([e,t])=>{var i,e=r.getInterstitialForId(e);return[null!=(i=null==(i=null==e?void 0:e.assets)?void 0:i.map(e=>this.fh.getQueueItemForId(e)).filter(e=>!!e))?i:[],t,null!=(i=null==e?void 0:e.cueType)?i:Ia.Midroll]}),Ae(([a,s,o])=>{var e;return a.length<1?Se:(e=null!=(e=No(a,null!=(e=r.activeInterstitialAssetId)?e:"").element)?e:a[0],this.Jh(e,!0,s,o,!1),this.Mh=a,e=this.kh.pipe(Yl(),Ae(i=>{const{itemId:e,type:t,isLastFragment:r}=i;if(t!==we.Subtitle&&r){const i=null!=(n=null==(n=this.jr)?void 0:n.expectedSbCount)?n:0,r=this.fh.getQueueItemForId(e);this.Ph[t]=!0;var n=this.Ph.every((e,t)=>t>=i||e);if(r&&ke(r)&&n){this._h=[!1,!1],this.Ph=[!1,!1];const i=No(a,r.itemId).index,n=a[i+1];return this.Jh(n,!1,s,o,!1),be(!0)}}return Se}),an(this.Rh)),ll(this.Rh.pipe(Ee(e=>{this.savedSeekValueById[this.activeInterstitialId]=e.seekTo,this.Jh(null,!1,s,o,e.all,e.seekTo,e.initialRate,e.seekImmediately)})),e))}))}get Uh(){return this.fh.playing$.pipe(Yl(),rn(null),Kr(),cn(this.gh),ve(([[e,t],i])=>this.Zh(e,t,i.currentTime)),Te())}get Fh(){return this.mediaQuery?this.mediaQuery.stallInfo$.pipe(Ee(e=>{var t;if(e){var i=this.fh.playingItem;if(i&&!this.fh.isPreloading()&&ke(i)&&i.itemId===(null==(t=this.fh.activeItem)?void 0:t.itemId)){const t=this.mediaQuery.getCombinedBufferInfo(e.currentTime,this.config.maxBufferHole);t.len<this.config.maxBufferHole&&!t.nextStart&&(this.Rc.setActiveInterstitialAssetId(null),this.Rc.setPlayingInterstitialAssetId(null))}}})):Se}get $h(){return br([this.ph,this.gh]).pipe(Ur(e=>!!e&&!!e[0]&&!!e[1]),Ae(([e,s])=>e.getInFlightFragByType$(we.Variant).pipe(Ur(e=>"appending"===(null==e?void 0:e.state)),ve(e=>e),Ae(({itemId:e,compatible:t})=>{var i=this.fh.getQueueItemForId(e);if(i){var e=s.sourceBufferEntityByType(B.Variant),r=i.itemStartOffsets[we.Variant],n=ke(i),e=null==e?void 0:e.bufferedSegments[(null==e?void 0:e.bufferedSegments.length)-1];if(!e&&n){const e=null!=(a=i.interstitialId)?a:"";this.Sh.triggerBufferedToInterstitialBoundary(e,Gf.Enter,x(r,1e3),!t)}else{var e=this.fh.getQueueItemForId(null!=(a=null==e?void 0:e.frag.itemId)?a:""),a=e&&ke(e);if(r-=Le(e),n!==a){const e=n?null!=(a=i.interstitialId)?a:"":i.itemId,s=n?Gf.Enter:Gf.Exit;this.Sh.triggerBufferedToInterstitialBoundary(e,s,x(r,1e3),!t)}}}return Se}))))}interstitialIsPlaying(){var e=this.fh.playingItem;return e&&ke(e)}itemIdIsInterstitial(e){e=this.fh.getQueueItemForId(e);return e&&ke(e)}handleError(e,t){var i;const r=!(e instanceof v)||e.fatal,n=this.activeInterstitial,a=this.fh.activeItem,s=a&&ke(a);if(r&&(n||s)&&a){if(this.config.interstitialsConfiguredForAirPlayReceiver){this.R.error({name:"AirPlay Interstitial"},"Error during interstitial, ending current item");const[e]=this.getCurrentBufferOffsets(t,Ia.Midroll),i=fe(e)?e-a.itemStartOffsets[we.Variant]:a.itemTimelineStartPosition;this.fh.updateItemById(a.itemId,{itemTimelineEndPosition:i})}else{this.R.error("Error during interstitial, switching to next available asset or primary content");const e=null!=(i=this.Rc.interstitialQuery.activeInterstitialAssetId)?i:"",r=No(this.Mh,e).index+1,v=(this.fh.removeQueueItem(e),this.Mh[r]);if(v&&v.interstitialId!==this.activeInterstitialId){const e=this.interstitialQuery.getInterstitialForId(v.interstitialId);e&&n.startTime&&e.startTime&&C(n.startTime)!==C(e.startTime)&&this.cancelInterstitial(!1)}else this.Jh(v,!1,t,n.cueType,!1)}return{handled:!0,error:e}}return{handled:!1,error:e}}snapIn(e,t){const i=e["initialSeekTime"];if(!fe(i))return NaN;if(null!=t&&!t.iframesOnly&&t.mediaOptionType!==we.Subtitle){var t=(null==t?void 0:t.fragments)||[],r=wo.search(t,e=>{var t=e.start,e=t+e.duration,t=i-t;return 0<=t&&0<=e-i?0:t});if(r){const t=r.start;return this.fh.updateItemById(e.itemId,{initialSeekTime:t}),t}}return i}getInterstitialStartTime(e,t,i){t=Bo(e,t,i);return e.startTime||this.Rc.updateInterstitial(e.identifier,{startTime:{baseTime:t,timescale:1}}),t}Zh(e,t,i){var r,n;let a=!1;var s=this.Rc.interstitialQuery.playingInterstitialId;if(null==e&&null!=t)if(ke(t)){const e=t.interstitialId;s!==e&&(null!==s&&(this._o.interstitialPlayTime(null!=(r=t.parentItemId)?r:t.itemId),this.Rc.interstitialQuery.getInterstitialForId(s),this.Rc.clearRealCurrentTimeOffsetMap(s)),this.Rc.interstitialQuery.getInterstitialForId(null!=e?e:""),this.Rc.setPlayingInterstitialId(e,this.config.interstitialsConfiguredForAirPlayReceiver),this.Rc.setPlayingInterstitialAssetId(t.itemId,this.config.interstitialsConfiguredForAirPlayReceiver),a=!s)}else s&&(this.Rc.setPlayingInterstitialAssetId(null),this.Rc.setPlayingInterstitialId(null),a=!0);else if(null!=e&&null!=t&&e&&t&&e.itemId!==t.itemId){this.td(e,t),this._o.interstitialPlayTime(null!=(n=null==e?void 0:e.parentItemId)?n:e.itemId);const i=e.interstitialId,r=t.interstitialId;!i&&r?s!==r&&(this.Rc.interstitialQuery.getInterstitialForId(null!=r?r:""),this.Rc.setPlayingInterstitialId(r,this.config.interstitialsConfiguredForAirPlayReceiver),this.Rc.setPlayingInterstitialAssetId(t.itemId,this.config.interstitialsConfiguredForAirPlayReceiver),a=!0):i&&r?(i&&r&&i!==r&&(this.Rc.interstitialQuery.getInterstitialForId(i),this.Rc.clearRealCurrentTimeOffsetMap(i),this.Rc.interstitialQuery.getInterstitialForId(r),this.Rc.setPlayingInterstitialId(r,this.config.interstitialsConfiguredForAirPlayReceiver)),this.Rc.setPlayingInterstitialAssetId(t.itemId,this.config.interstitialsConfiguredForAirPlayReceiver)):i&&!r&&(this.Rc.interstitialQuery.getInterstitialForId(null!=i?i:""),this.Rc.clearRealCurrentTimeOffsetMap(i),this.Rc.setPlayingInterstitialAssetId(null),this.Rc.setPlayingInterstitialId(null),a=!0)}return a}td(i,r){let n=NaN,a=NaN;this.fh.queueItems.forEach((e,t)=>{e.itemId===i.itemId&&(a=t),e.itemId===r.itemId&&(n=t)});for(let e=a+1;e<n;e++){const r=this.fh.queueItems[e],n=this.fh.queueItems[e-1];this.Dh.has(r.interstitialAssetId)||this.Dh.has(r.interstitialId)||this.ed(n,r)}}ed(e,t){var i;ke(t)&&(e=e.interstitialId,(i=t.interstitialId)!==e&&(this.Rc.clearRealCurrentTimeOffsetMap(e),this.Rc.setPlayingInterstitialId(i,this.config.interstitialsConfiguredForAirPlayReceiver)),this.Rc.setPlayingInterstitialAssetId(t.itemId,this.config.interstitialsConfiguredForAirPlayReceiver))}Jh(r,n,e,a,t,i,s,o){var l;let d=a===Ia.Postroll?[e.mediaElementDuration,e.mediaElementDuration]:this.getCurrentBufferOffsets(e,a);var[u,c]=d;!fe(c)&&fe(u)&&(d=[u,u]);const h=this.Rc.interstitialQuery;let p=null!=i?i:0;c=null!=(c=this.activeInterstitial)?c:h.getInterstitialForId(null!=(u=h.playingInterstitialId)?u:""),u=null!=(u=null==c?void 0:c.duration)?u:0;c&&!i&&(p=(null!=(f=this.Th)?f:[]).reduce((e,t)=>e+Do(h.getInterstitialForId(t.interstitial.identifier)),0));let m=d[we.Variant]+p;if("VOD"===this._primaryPlaylistType)switch(a){case Ia.Preroll:0!==p||i||(m=NaN);break;case Ia.Midroll:m+=!fe(i)&&null!=(l=this._primaryResumptionTime)?l:0;break;case Ia.Postroll:m=-.5}else m=i?m:-(null!=(f=this.Ih)?f:0)-(p-u);var f=this.savedSeekValueById[null==c?void 0:c.identifier],u=fe(f)?f+p+d[we.Variant]:null;let g;if(c){const r=c.cueType===Ia.Preroll?0:C(c.startTime);g=r+p}else g=1/0;if(r)Oe(()=>{var e=r.itemStartOffsets.find(fe)?r.itemStartOffsets:d,t=r.interstitialId,t=(this.Rc.updateRealCurrentTimeOffsetMap(t,e),n&&this.fh.updateItemById(null!=(t=null==(t=this._primaryQueueItem)?void 0:t.itemId)?t:"",{itemTimelineEndPosition:g}),a===Ia.Preroll?NaN:void 0),i=!!fe(t)||void 0;this.fh.setActive(r.itemId,{itemStartOffsets:e,initialSeekTime:t,seekImmediately:i}),this.Rc.setActiveInterstitialAssetId(r.itemId)});else if(t||!this.Gh(e)){const r=this._primaryQueueItem,n=Vy.createItem(r.name,r.url,this.config,this.R,Object.assign(Object.assign({},_y(r,!0)),{initialSeekTime:null!=i?i:this._primaryResumptionTime,initialRate:s,itemTimelineEndPosition:r.itemTimelineEndPosition,seekImmediately:o})),a=(n.itemStartOffsets=d,n.initialSeekTime=fe(u)?u:m,n.itemTimelineStartPosition=g,null!=(f=null==c?void 0:c.snapOptions)?f:Sa.None);n.snapIn=a===Sa.In||a===Sa.InOut,Oe(()=>{var e;this.fh.insertQueueItem(n),this.fh.setActive(n.itemId,{itemStartOffsets:n.itemStartOffsets,initialSeekTime:n.initialSeekTime,seekImmediately:o}),o&&this.fh.setPlayingItem(n),null!=(e=this.Th)&&e.forEach(({interstitial:e})=>{this.Rc.updateInterstitial(e.identifier,{hasPlayed:!0}),this.Rc.addInterstitialToPastEvents(e.identifier)}),this.Rc.setActiveInterstitialAssetId(null),this.Rc.setActiveInterstitialId(null)}),this.reset(),this.updateSavedSeekValueForInterstitialId(null==c?void 0:c.identifier,null)}}getCurrentBufferOffsets(r,e,t){const i=r.currentTime,n=e===Ia.Preroll||0===i?0:Number.POSITIVE_INFINITY,a=[n,n];let s=null==(e=this.fh.activeItem)?void 0:e.itemId;if(!s&&t){const r=ee(this.fh.queueItems,e=>fe(e.itemTimelineEndPosition)&&(null==e?void 0:e.itemId)!==(null==t?void 0:t.itemId));s=r.itemId}return Hs.forEach(e=>{var t=r.getBufferedSegmentsByType(Ks(e)).filter(e=>e.frag.itemId===s);if(t&&0<t.length){const r=t[t.length-1],i=xe(r.appendEnd,r.endPTS);a[e]=i}}),a}Yh(s,e,t,o){const l=this._primaryQueueItem;if(l&&s&&0<e.length){const d=[],u=[];let a=0;return Oe(()=>{if(e.forEach((e,t)=>{var i=`interstitial:${s.identifier}:asset_`+(t+1),r=_y(l,!0),i=(r.interstitialId=s.identifier,r.interstitialAssetId=i,Vy.createItem(i,e.uri,this.config,this.R,r)),r=s.cueType===Ia.Preroll?0:Number.POSITIVE_INFINITY;let n=[r,r];this.Eh.find(fe)&&0===this.Oh&&0===t&&(n=this.getCurrentBufferOffsets(o,s.cueType).map((e,t)=>{t=null!=(t=this.Eh[t])?t:0;return Math.max(0,e-t)})),i.itemStartOffsets=n;r=e.duration||0,t=null==(t=this.Nh)?void 0:t.time;if(fe(t)){if(!(a<=t&&t<=r))return;const s=xe(n[0],0);i.initialSeekTime=t+s,i.seekImmediately=!0,this.Nh=null}this.Rc.addInterstitialAsset({parentIdentifier:s.identifier,identifier:i.itemId,url:e.uri,duration:e.duration}),this.fh.insertQueueItem(i),u.push(i.itemId),d.push(e.uri),a+=r}),0<u.length){const e=Math.max(a,s.duration||0);this.Rc.updateInterstitial(s.identifier,{urls:d,assets:u,duration:e}),this.Rc.setActiveInterstitialId(s.identifier)}}),!this._primaryResumptionTime&&fe(t)&&(this._primaryResumptionTime=t),0===u.length?null:(this.activeInterstitialId=s.identifier,s)}return s&&this.Rc.removeInterstitials([s.identifier]),null}rd(i){var e;let r;null!=(e=this.Th)&&e.find(({interstitial:e},t)=>{if(e.identifier===i.identifier)return r=t,!0}),fe(r)&&(this.Oh=r)}od(i,e){return e.filter(e=>{var t=i.startTime,e=e.startTime;return t&&e&&C(t)===C(e)})}reloadPlayingItem(t,i,r,e,n){const a=this.fh.playingItem;if(a){if(ke(a)){const i=this.Rc.interstitialQuery,u=i.playingInterstitialId,c=i.getInterstitialForId(null!=u?u:"");if(c){const u=a.itemId;return n.removeLaterCues(t),e.flushAndCallback(Math.max(t-1,0),1/0,()=>{Oe(()=>{var e=i.playableInterstitials;this.od(c,e),this.rd(c),this.Rc.setActiveInterstitialAssetId(a.interstitialAssetId),this.Rc.setActiveInterstitialId(c.identifier),this.Rc.removeInterstitialsFromPastEvents([c.identifier]),this.fh.setActiveWithContext(u,r,{itemStartOffsets:a.itemStartOffsets,initialSeekTime:t-1})})}),void this.updateSavedSeekValueForInterstitialId(c.identifier,null)}}const u=this.fh.activeItem,c=(u&&ke(u)&&(Oe(()=>{var e;this.Rc.removeInterstitialsFromPastEvents([null!=(e=u.interstitialId)?e:""]),this.Rc.setActiveInterstitialId(null),this.Rc.setActiveInterstitialAssetId(null)}),this.Oh=-1,this.reset(),this.updateSavedSeekValueForInterstitialId(u.interstitialId,null)),n=a,l=4,d=20,JSON.stringify(n,(e,t)=>{if(""===e||!isNaN(e)||!(s&&-1===s.indexOf(e)||o&&-1!==o.indexOf(e))){if(-1!==Q.indexOf(e)){if("string"==typeof t)return z(t);if(Array.isArray(t))return t.map(z)}return ArrayBuffer.isView(t)||t instanceof ArrayBuffer?t.byteLength>d?`arrayBuffer<${t.byteLength}>`:M.hexDump(t):!isNaN(t)&&null!=t&&t.toFixed?Number(null==t?void 0:t.toFixed(l)):t}}));var s,o,l,d;fe(t)?e.flushAndCallback(Math.max(t-1,0),1/0,()=>{this.fh.setActiveWithContext(a.itemId,r,{itemStartOffsets:a.itemStartOffsets,initialSeekTime:i,seekImmediately:!1,itemTimelineEndPosition:1/0})}):(this.R.error(`flushTime unknown: failed to flush before loading primary item `+JSON.stringify(c)),this.fh.setActiveWithContext(a.itemId,r,{itemStartOffsets:a.itemStartOffsets,initialSeekTime:i,seekImmediately:!1,itemTimelineEndPosition:1/0}))}}updateSavedSeekValueForInterstitialId(e,t){e&&(this.savedSeekValueById[e]=t)}Xh(i){Oe(()=>{for(var[e,t]of Object.entries(i))this.Rc.updateInterstitial(e,{startTime:t})})}dequeueInterstitial(e,t,i,r,n){this.xh.next({mediaElementAdapter:e,hlsService:t,rootPlaylistService:i,interstitialId:r,assetId:n})}dequeueInterstitialWithInterstitialId(t,e,i,r){const n=e.mediaQuery,{item:a,index:s}=this.fh.getFirstItemDetailsForInterstitialId(t),{item:o,index:l}=this.fh.getLastItemDetailsForInterstitialId(t),d=l+1,u=this.fh.queueItems[d];let c,h=!1;const p=this.fh.playingItem,m=this.fh.queueItems.findIndex(e=>e.itemId===p.itemId),f=fe(null==o?void 0:o.itemTimelineEndPosition)?o.itemTimelineEndPosition+o.itemStartOffsets[we.Variant]:null;return fe(f)&&n.currentTime>f?be(t):a&&(m>=s&&m<=l&&(h=!0),Oe(()=>{var t;for(let e=l;e>=s;e--){var i=this.fh.queueItems[e];i.itemId===(null==(t=this.fh.activeItem)?void 0:t.itemId)?c=i.itemId:this.fh.removeQueueItem(i.itemId)}}),n)?this.ad(n,a,s,o,u,e,i,r,h,c).pipe(ve(e=>(this.ld(a,s),t))):(this.ld(a,s),be(t))}ad(a,s,o,e,l,t,d,u,c,h){const i=!!a.getBufferedSegmentsByType(B.Variant).find(e=>e.frag.itemId===s.itemId),p=this.fh.queueItems[o-1];let m=!1;if(i||h===s.itemId){const a=[];let n=this.fh.queueItems.length-1;if(h){o++;const a=this.fh.queueItems[o],l=null!=e?e:s;a&&l&&(m=!ke(a)&&!fe(l.itemTimelineEndPosition))}else Oe(()=>{for(;this.fh.queueItems.length>o;){var t=this.fh.queueItems[n];if(h!==t.itemId){let e;var i=l&&ke(l),r=t&&ke(t);if(i)r||(e=t.itemTimelineStartPosition);else{const a=t.itemStartOffsets[we.Variant]-s.itemStartOffsets[we.Variant];e=fe(a)?Math.max(0,t.initialSeekTime-a):t.initialSeekTime}var i=_y(t,!0,t.initialRate,e,t.timeToPauseBuffer),r=Vy.createItem(t.name,t.url,this.config,this.R,i);r.itemTimelineStartPosition=t.itemTimelineStartPosition,r.interstitialId=t.interstitialId,r.interstitialAssetId=t.interstitialAssetId,a.unshift(r),t.itemId===(null==(i=this.fh.activeItem)?void 0:i.itemId)?(h=t.itemId,o++):this.fh.removeQueueItem(t.itemId),n=this.fh.queueItems.length-1-(h?1:0)}}a.forEach(e=>{this.fh.insertQueueItem(e)})});const f=this.fh.queueItems[o],r=e=>{const t={itemStartOffsets:s.itemStartOffsets,seekImmediately:c};m&&(t.initialSeekTime=s.itemStartOffsets[we.Variant]+f.initialSeekTime);var i={},r=d.query.holdingAirplayInterstitialSeek;if(r&&!r.isInterstitial&&f&&!ke(f)){const e=r.originalSeekTo;i.initialSeekTime=s.itemStartOffsets[we.Variant]+e,i.seekImmediately=!0,d.clearHoldingInterstitialSeek()}if(f)return this.fh.setActiveWithContext(f.itemId,null,Object.assign(Object.assign({},t),i)),this.Kh(f)&&this.Rc.updateRealCurrentTimeOffsetMap(f.interstitialId,t.itemStartOffsets),!0;if(this.fh.playingItem.itemId!==s.itemId)return this.ud(u,s),!1;{const t=fe(e)?e:p.itemTimelineEndPosition+p.itemStartOffsets[we.Variant];return this.fh.setPlayingItem(p),d.setUserSeek(t),this.fh.activeItem.itemId!==s.itemId||(this.ud(u,s),!1)}};if(!i){const a=r(NaN);return this.hd(h,a)}const g=s.itemStartOffsets[we.Variant];return t.flushAll(Math.max(g,0),1/0).pipe(Ae(()=>{var e=r(g);return this.hd(h,e)}))}return i||this.Rc.interstitialQuery.playingInterstitialId===s.interstitialId&&l&&this.fh.setPlayingItem(l),be(!0)}hd(t,e){return t?e?this.ph.pipe(Ur(e=>e&&t!==e.itemId),ve(e=>(this.fh.removeQueueItem(t),!0)),Dr(1)):(this.fh.removeQueueItem(t),be(!0)):be(!0)}ud(e,t){return t.itemTimelineEndPosition=t.itemTimelineStartPosition,e.setAVAnchor(t.itemId,null),!1}dequeueInterstitialWithAssetId(t,e,i,r){const n=e.mediaQuery,{item:a,index:s}=this.fh.getItemDetailsForAssetId(t),o=s+1,l=this.fh.queueItems[o];let d,u=!1;var c=this.fh.playingItem,h=fe(null==a?void 0:a.itemTimelineEndPosition)?a.itemTimelineEndPosition+a.itemStartOffsets[we.Variant]:null;return fe(h)&&n.currentTime>h?be(t):a&&((null==c?void 0:c.itemId)===a.itemId&&(u=!0),a.itemId===(null==(h=this.fh.activeItem)?void 0:h.itemId)?d=a.itemId:this.fh.removeQueueItem(a.itemId),n)?this.ad(n,a,s,void 0,l,e,i,r,u,d).pipe(ve(e=>(this.ld(a,s,!0),t))):(this.ld(a,s,!0),be(t))}ld(e,t,i=!1){var r;e&&e.itemId!==this.fh.playingItem.itemId&&fe(null==e?void 0:e.itemTimelineStartPosition)&&(!i||(r=this.fh.queueItems[t],t=this.fh.queueItems[t-1],i&&(null==r?void 0:r.interstitialId)!==e.interstitialId&&(null==t?void 0:t.interstitialId)!==e.interstitialId))&&this.Rc.clearRealCurrentTimeOffsetMap(e.interstitialId)}Hh(e,t,i){var e=ee(e.getBufferedSegmentsByType(B.Variant),e=>e.startPTS<=t&&t<=e.endPTS),r=null!=(r=null==e?void 0:e.firstKeyframePts)?r:null==e?void 0:e.startPTS,e=null==e?void 0:e.endPTS;if(fe(r)&&fe(e))return Math.abs(t-r)<Math.abs(t-e)?r:e}}Qy.loggerName={name:"Interstitials"},Qy.kFragStartTolerance={baseTime:10,timescale:100},Qy.kInterstitialPrecisionStartTolerance={baseTime:1,timescale:1e3};var Hy={findFragmentBySNAndBuffer:function(e,t,i=0,r=0,n=0){let a;e=e?t[e.mediaSeqNum-t[0].mediaSeqNum+1]:null;return a=i<r?(r-n<i&&(n=0),e&&!this.fragmentWithinToleranceTest(i,n,e)?e:Ao.search(t,this.fragmentWithinToleranceTest.bind(null,i,n))):t[t.length-1]},fragmentWithinToleranceTest:function(e,t,i){t=Math.min(t,i.duration);return i.start+i.duration-t<=e?1:i.start-t>e&&i.start?-1:0}};function qy(t,u,i,c,r){const{legibleSystemAdapter:h,mediaSink:e}=t,n=e.mediaQuery,p=n.seekTo?n.seekTo.pos:n.currentTime;return u?Mn(function(){var e=h.findFrags$(u,i,p);if(null!=e&&e.foundFrags){var r=t,n=p,a=c.offsetTimestamp,s=e,o=u;const l=r["legibleSystemAdapter"],d=s.foundFrags;let i=d.length;return Bn(...d.map(t=>{if(t.gap){const a=r["mediaSink"];var e;return e.frag=t,e.cueRange=void 0,a.updateContentGapRanges(B.Variant,{start:t.start,end:t.start+t.duration}),be(e)}return function(e,t,i){const{rootPlaylistQuery:d,legibleSystemAdapter:u}=e;return Mn(()=>Dg(e,t,i).pipe(Ae(([e,{initPTS:t,data:i,mediaFragment:r}])=>{var n,a,s,o=d.enabledAlternateMediaOptionByType(we.Subtitle);let l=!0;return null!=(e=null==e?void 0:e.initParsedData)&&e.ttml&&(l=!1),[e,o,t,i,n,a,s=!0]=[o,r,t,$(i.loadedData),u,d.appItemId,l],(e?n.processSubtitleFrag(e,o,t,i,a,s):be(void 0)).pipe(ve(e=>({frag:r,cueRange:e})))})))}(r,a,t).pipe(Nr(e=>l.checkReadyToLoadNextSubtitleFragment$(t,d).pipe(Ur(e=>e))),Ee(()=>{i--}))}),r.config.vttConcurrentLoadCount).pipe(Ae(e=>{if(l.reviewParsedFrag(n,e,s,o,i)!==Qd.CloseEnough){const n=e.frag,t=o.fragments[n.mediaSeqNum-1];if(l.isFragLoadingNeeded(t,s))return be(Hd.TryAgain)}return 0<i?Se:be(Hd.Complete)}),Dr(1),Hr(()=>{}))}return be(Hd.Complete)}).pipe(ye(e=>{if(r.error(`Got error in loadSubtitleInDiscontinuity ${e.message} fatal:${null==e?void 0:e.fatal} handled:`+(null==e?void 0:e.handled)),e instanceof Ys&&!e.fatal&&e.handled)return be(Hd.Complete);throw e}),zr({delay:()=>rr(0)}),sn(e=>e!==Hd.Complete,!0),Hr(()=>{})):Se}const Ky={name:"seek"};function jy(e,t,i,r,n,a,s){var o=Wp(i),l=i[we.Variant],d=l.totalduration,u=n.itemStartPosition,c=n.startTimeOffset,h=r["liveEdgeForZeroStartPositon"];if(o){if(fe(e)){if(0<=e){if(e>Am(l)){const t=ke(null==a?void 0:a.playingItem)?r.maxBufferHole:l.targetduration;e=Math.max(l.fragments[0].start,Am(l)-t)}return e}return u+(d+e)}return u+$y(l,c)}{const n=!fe(e)||e<0;if(t&&(n||0===e&&h&&"LIVE"===l.type)){if(e=1/0,fe(l.startTimeOffset)||fe(c)){const t=$y(l,c);e=Math.max(0,null==(o=l.fragments[0])?void 0:o.start)+t}}else n&&(e=1/0);return s?e:Km(e,i,r)}}function $y(e,t=NaN){let i=0;if(fe(e.startTimeOffset))i=e.startTimeOffset;else{if(!fe(t))return i;i=t}t=e.totalduration;let r=(i=Math.abs(i)>t?0<=i?t:-1*t:i)<0?t-Math.abs(i):i;return r=e.liveOrEvent?Math.min(r,t-3*e.targetduration):r}function Gy(t,i){return Di(Yr({delay:function(e){if(t.error(`Got error in ${i} ${e.message} fatal:${null==e?void 0:e.fatal} handled:`+(null==e?void 0:e.handled)),e instanceof v&&!e.fatal)return e.handled?Pe:Se;throw e}}))}function Wy(e,R,t){var i=new F(t=>{{var i=R,r,n;const{config:m,platformService:f,rootPlaylistQuery:g}=i,y=g["itemId"],v=(e=i["operationQueue"],Ce(t,e.queueService$(!0)),function(e,t){var i,r,n,a=t["rootPlaylistQuery"];if(Ce(e,a.enabledMediaOptionsSwitchInfo$().pipe(Ee(function(e,t){var i=e["operationQueue"],r=function(){if(t[we.Variant].toId)return{operation:gp.VariantSwitch,priority:fp.High,execute:Py.bind(null,e,t)}}();r&&i.enqueue(r)}.bind(null,t)))),a.hasClosedCaption||a.hasAlternateWithUrl(we.Subtitle)){a=t,t=e;const{config:s,logger:o,rootPlaylistQuery:l,rootPlaylistService:d,legibleSystemAdapter:u,itemQueue:c,playerEvents:h}=a,p=c.getQueueItemForId(l.itemId),m=l.enabledAlternateMediaOptionByType(we.Subtitle),f=l.mediaOptionListQueries[we.Subtitle].filteredMediaOptionList,g=null==p?void 0:p.interstitialId;if(!p||u.gotTracks&&"string"!=typeof g||h.postSubtitleTracksCreated(f,p),p&&ke(p)){if(0===f.length)return;u.setInterstitialTracks(f,m,l.getDisabledMediaOption(we.Subtitle))}else u.endLoadingInterstitials(),u.gotTracks?m?u.selectedTrack=m:d.clearMediaOptionSwitchContextByType(p.itemId,we.Subtitle):u.setTracks(f,m,l.getDisabledMediaOption(we.Subtitle));i=u,r=d,n=s,Ce(t,i.nativeSubtitleTrackChange$.pipe(Ee(e=>{n.enableInterstitialPlayback?o.error("native video controller subtitle selection is incompatible with interstitials playback"):e.mediaOptionId!==i.selectedMediaOption.mediaOptionId&&r.setEnabledMediaOptionByType(e.itemId,we.Subtitle,e,!0,{userInitiated:!0})}))),e=l.enabledMediaOptionByType$(we.Subtitle).pipe(ve(e=>{var t=null==(t=l.enabledMediaOptionSwitchContexts)?void 0:t[we.Subtitle],e=Bs(e)?l.alternateMediaOptionById(we.Subtitle,e.mediaOptionId):e;return u.selectedMediaOption=e,h.postSubtitleTrackSwitch(t,e),d.clearMediaOptionSwitchContextByType(p.itemId,we.Subtitle),e}),Te((e,t)=>(null==e?void 0:e.mediaOptionId)===(null==t?void 0:t.mediaOptionId))),Ce(t,e.pipe(function(d){const{mediaSink:e,rootPlaylistQuery:u,mediaLibraryService:t,subtitleOperationQueue:c}=d,h=e.mediaQuery,p=d.logger.child({name:"subtitle"});return Di(Ae(e=>Us(e)&&Bs(e)?t.getQueryForOption(e).mediaOptionDetails$.pipe(Ae(l=>new F(function(e){e=dl(e);Ce(e,c.queueService$(!0)),Ce(e,u.avAnchor$.pipe(ve((t,i)=>{if(t||!(0<i||h.readyState<HTMLMediaElement.HAVE_METADATA)){let e=null==t?void 0:t.discoSeqNum;if(!fe(e)&&!fe(e=lm(l,h.currentTime)))return Se;r=e,n=l,a=u,s=d,o=p;var r,n,a,s,o,i={operation:gp.SubtitleIdle,priority:fp.Normal,execute:()=>{var e=a.getInitPTS(r);return!1===(null==e?void 0:e.iframeMode)?qy(s,n,r,e,o):ol(a.initPTS$(r),e=>!1===(null==e?void 0:e.iframeMode)).pipe(Ae(e=>qy(s,n,r,e,o)))}};fe(null==t?void 0:t.pos)&&c.clear(),c.enqueue(i)}})))}))):Se))}(a)))}}(t,i),f.query),I=g.mediaOptionListQueries[we.Variant],S=I.filteredMediaOptionList,b=I.mediaOptionListInfo.hasHdrLevels&&v.supportsHdrMediaQuery;if(b){var a=i;const{rootPlaylistQuery:T,platformService:A,operationQueue:E}=a,O=A.query;let e=O.displaySupportsHdr$;Ce(t,(e=O.displaySupportsHdr===T.preferHDR?e.pipe(tn(1)):e).pipe(Te(),Ee(e=>{e=function(r,n,a){const s=r["rootPlaylistService"];return{operation:gp.RendererSwitch,priority:fp.High,execute:(e,t,i)=>(s.setHDRPreference(n,a),My(r,void 0),Se)}}(a,T.itemId,e);E.enqueue(e)})))}var s,{keySystemAdapter:e,logger:o}=i;if(Ce(t,gr(e.keyStatusChange$.pipe((s=i,e=>e.pipe(Er((e,t)=>{var{decryptdata:e,status:i,error:r}=e;if("needs-renewal"===i)return xg(s,e,void 0);if("error"!==i||!(r instanceof cl||r instanceof ul||r instanceof hl)||r.handled)return Se;{const{rootPlaylistService:e,keySystemAdapter:t}=s;return Ly(r,0,null,e,t.ksQuery)}}),Ae(()=>Se))),Gy(o,"keyStatusChange")),Rn)),Ce(t,function(u){const{rootPlaylistQuery:c,mediaSink:h,mediaLibraryService:e,config:p,itemQueue:m}=u,{livePlaylistUpdateStaleness:a,liveAllowLowLatencyPlayback:f}=p,g=h.mediaQuery,t=br([c.enabledMediaOptionByType$(we.Variant).pipe(Yy(e,f)),c.hasAlternateWithUrl(we.AltAudio)?c.enabledMediaOptionByType$(we.AltAudio).pipe(Yy(e,f)):sl]);return br([t,g.msReadyState$,g.desiredRate$]).pipe(Ae(([e,t])=>"open"!==t||!e[we.Variant]||e.some(e=>{return null!=e&&!0===e.mediaOptionDetails.liveOrEvent&&([e,t,i=!1]=[e,a,f],!((n=null==e?void 0:e.mediaOptionDetails)&&(r=performance.now(),e=e.lastUpdateMillis||r,i&&Gp(n)?r-e<t*n.partTargetDuration*1e3:r-e<t*n.targetduration*1e3)));var t,i,r,n})?Se:ol(g.updating$,e=>!e).pipe(xr(e),la(([e,t])=>{var i,r;const n=g.bufferedRangeTuple,a=[e.mediaOptionDetails,null==t?void 0:t.mediaOptionDetails],s=!Wp(a),o=zp(a);let l=!0,d=NaN;if(s){const u=h.liveSeekableRange;if(o){const u=qm(a,p),m=Math.max(e.lastUpdateMillis,null!=(r=null==t?void 0:t.lastUpdateMillis)?r:-1/0);h.updateLiveSeekableRange(u.start,u.end,u.edge,u.boundary,m),function(e,s,o,l){if(1!==l.desiredRate)return!1;const t=l.desiredPos,d=o.maxSeekHole,u={avgPlaylistLoadTimeMs:0,avgPlaylistParseTimeMs:0},c=l.getBufferInfo(t,d);return e.map(e=>e&&e.mediaOptionDetails?Hm(e.mediaOptionDetails,o):null),!e.every((e,t)=>{var i,r,n,a=null==e?void 0:e.mediaOptionDetails;return!(null!=a&&!l.canContinuePlaybackWithoutGap(a,null!=(e=null==e?void 0:e.lastUpdateMillis)?e:0,u,d))||(e=s[t],t=null==(t=c[t])?void 0:t.buffered,!(!e||!t)&&a.itemId===e.itemId&&a.mediaOptionId===e.mediaOptionId&&({part:r,mediaSeqNum:i,partIndex:n}=e,r?i>=a.partStartSN&&(i<a.partEndSN||i===a.partEndSN&&n<=a.partEndIndex):i>=a.startSN&&i<=a.endSN)&&(r={start:e.start,end:e.start+e.duration},n=Hm(a,o),jm(r,t,d)&&jm(r,n,d)))})}([e,t],c.getInFlightFrags(),p,g)&&(d=p.liveResumeAtWindowStart?0:1/0)}else{if(6e4<performance.now()-(null==u?void 0:u.tupdate)){const{start:c,end:e,edge:p,boundary:t,tupdate:m}=u,i=performance.now()-m,f=i/1e3;h.updateLiveSeekableRange(c+f,e+f,p+f,t+f,m+i),h.msDuration+=f,d=p+f}l=!1}}else h.clearLiveSeekableRange();if(l){const u=n[B.Variant],c=n[B.AltAudio],e=null!=(r=null==(i=null==u?void 0:u[u.length-1])?void 0:i.end)?r:0,p=null!=(i=null==(i=null==c?void 0:c[c.length-1])?void 0:i.end)?i:0,t=Math.max(e,p),g=isNaN(h.msDuration)?0:h.msDuration,s=Math.max(Am(a[we.Variant],f),a[we.AltAudio]?Am(a[we.AltAudio],f):0),o=(h.msDuration=Math.max(g,s,t),Le(m.getQueueItemForId(a[we.Variant].itemId))||0);h.primaryContentDuration=s-o}return isNaN(d)||u.interstitialController.interstitialIsPlaying()||h.seekWithOptions(d,void 0,!0),Se}))))}(i)),m.useViewportSizeForLevelCap&&S.some(e=>fe(e.width)&&fe(e.height))){const w=i["rootPlaylistService"];r=y,e=v,n=w,Ce(t,e.viewportInfo$.pipe(Te((e,t)=>e&&t&&e.width===t.width&&e.height===t.height),Ee(e=>{n.setViewportInfo(r,e)})))}var l,d,u,c,h,p,o=S.some(e=>null!=e.hdcpLevel);if(b||o){const{mediaSink:w,mediaParser:m,itemQueue:f,gaplessInstance:v}=i;e=t,l=y,i=o,d=w,u=m,c=g,h=f,p=v,((t=b)||i)&&(o=[],t&&o.push(c.hdrMode$),i&&o.push(c.maxHdcpLevel$.pipe(Te())),Ce(e,(1!==o.length?br(o):o[0]).pipe(tn(1),Ee(e=>{var t;if((null==(t=null==h?void 0:h.playingItem)?void 0:t.itemId)!==l)return Se;p.inGaplessMode||0!==c.itemStartPosition||(d.resetMediaSource(),u.reset())}))))}}});Ce(e,i.pipe(Yr(t)))}function zy(e,t,i){let r=e.currentTime-t;e=null==(t=e.getCombinedBufferInfo(e.currentTime,i))?void 0:t.start;return r=fe(e)&&e>r?e:r}function Yy(i,r=!1){return e=>{return e.pipe((t=i,e=>e.pipe(Ng(t),Ae(e=>e?e.mediaOptionDetailsEntity$.pipe(Yl()):be(null)))),Ur(e=>null==e||null!=e.mediaOptionDetails),Te((e,t)=>{var e=null==e?void 0:e.mediaOptionDetails,t=null==t?void 0:t.mediaOptionDetails,i=(null==e?void 0:e.endSN)===(null==t?void 0:t.endSN)&&(null==e?void 0:e.ptsKnown)===(null==t?void 0:t.ptsKnown)&&(null==e?void 0:e.liveOrEvent)===(null==t?void 0:t.liveOrEvent),e=!r||(null==e?void 0:e.partEndSN)===(null==t?void 0:t.partEndSN)&&(null==e?void 0:e.partEndIndex)===(null==t?void 0:t.partEndIndex);return i&&e}));var t}}const Xy=(e,t)=>{let i,r="";return i=e.videoCodec&&e.audioCodec?(r=e.videoCodec+`, `+e.audioCodec,t=null!=t?t:"video/mp4","audiovideo"):e.videoCodec?(r=``+e.videoCodec,t=null!=t?t:"video/mp4","video"):(r=``+(null!=(e=e.audioCodec)?e:""),t=null!=t?t:"audio/mp4","audio"),{mimeType:t+`;codecs=`+r,codec:r,container:t,type:i}};class Jy{constructor(e,t,i){this.Zt=e,this.R=t,this.fd=i,this.pe=[],this.pd=[],this.md=[]}parseInitSegment(d){return new F(e=>{const t=d["frag"],{keyTagInfo:i,mediaOptionType:r}=t,n=performance.now();let a;if(this.pd[r]=t,Pt.probeInitSegment(d.initSegment)){const e=Et.remuxInitSegment(d.initSegment,this.R,i),t=Pt.parseInitSegment(e,this.R),{mimeType:r,type:s,codec:o,container:l}=Xy(t,null);a={moovData:t,mimeType:r,track:{type:s,codec:o,initSegment:e,container:l},stats:{tparsed:{tbegin:n,tend:performance.now()}}}}else{const e=performance.now();a={moovData:null,mimeType:null,track:{type:null,codec:null,initSegment:d.initSegment,container:null},stats:{tparsed:{tbegin:n,tend:e}}}}e.next(a),e.complete()})}parseSegment(b,e){return this.bd(b,this.md,e,this.fd).pipe(Ae(({demuxer:e,contiguous:t,trackSwitch:i,discontinuity:r,accurateTimeOffset:n})=>{const{frag:v,defaultInitPTS:a}=b,{keyTagInfo:s,start:o,duration:I,mediaOptionType:l}=v;let S;this.md[l]=v;var d=yl(e.observer);return be(d.event(E.FRAG_PARSING_INIT_SEGMENT).pipe(Ae(e=>{var t;return e.track.initSegment.byteLength!==(null==(t=b.initSegment)?void 0:t.byteLength)&&(S=this.Sd(e)),Se})),d.event(E.FRAG_PARSING_DATA).pipe(ve(i=>{if(!i)throw new O(!1,pe.FailedDemuxerSanityCheck,`Failed demuxer sanity check, parsedData==null/undefined frag=${ch(v)}}`);var{startPTS:e,startDTS:t,firstKeyframePts:r,framesWithoutIDR:n,largestVideoSampleSize:a,dropped:s,data1:o,data2:l,captionData:d,id3Samples:u,audioTrackInfo:c}=i;let{endPTS:h,endDTS:p}=i;if(fe(h.baseTime)||(i.endPTS=h=Object.assign(Object.assign({},e),{baseTime:e.baseTime+x(I,e.timescale).baseTime})),fe(p.baseTime)||(i.endDTS=p=Object.assign(Object.assign({},t),{baseTime:t.baseTime+x(I,t.timescale).baseTime})),!fe(b.iframeMediaStart)){var m=v,f=b.iframeMediaStart,g=this.Zt.audioPrimingDelay;let e=NaN,t=NaN;fe(f)&&(t=f,e=.01,fe(t))&&fe(g)&&(t+=g);var{startPTS:f,startDTS:g,endPTS:i,endDTS:y}=i;if(!(void 0!==f&&void 0!==g&&0<=f.baseTime&&0<=g.baseTime&&0<m.duration&&(null==i||0<_(i,f))&&(null==y||0<_(y,g)))||fe(e)&&fe(t)&&!(Math.abs(C(g)-t)<=e))throw new O(!1,pe.FailedDemuxerSanityCheck,`Failed demuxer sanity check frag=${ch(m)} parsed=${JSON.stringify({startPTS:f,endPTS:i,startDTS:g,endDTS:y})} `+V({expectedStartDTS:t,fudge:e}))}return v.mediaOptionType===we.Variant&&(this.gt=c),{startPTS:e,endPTS:h,startDTS:t,endDTS:p,firstKeyframePts:r,framesWithoutIDR:n,largestVideoSampleSize:a,dropped:s,data1:o,data2:l,captionData:d,id3Samples:u,parsedInitSegment:S}})),d.event(L.INTERNAL_ERROR).pipe(Ae(this.wd)),e.push(b.segment,s,b.initSegment,o,r,i,t,b.totalDuration,n,a,b.iframeMediaStart,b.iframeDuration,this.gt).pipe(Ae(()=>Se))).pipe(Mr(),Dr(1))}))}reset(e=void 0){var t;null==e?(this.pe.forEach(e=>{e&&e.destroy()}),this.pe=[]):(null!=(t=this.pe[e])&&t.destroy(),delete this.pe[e])}willBeTrackSwitch(e,t){var{mediaOptionType:e,mediaOptionId:i}=e,t=(t||this.md)[e];return!(t&&t.mediaOptionId===i)}bd(e,r,t,i){const{frag:n,ptsKnown:a,seeking:s,live:o}=e,{discoSeqNum:l,mediaSeqNum:d,mediaOptionType:u}=n;return Mn(()=>{const e=this.pe[u];if(e)return be(e);if(!Jy.typeSupported){const e=Ju();Jy.typeSupported={mp4:e.isTypeSupported("video/mp4"),mpeg:e.isTypeSupported("audio/mpeg"),mp3:e.isTypeSupported('audio/mp4; codecs="mp3"'),ac3:e.isTypeSupported('audio/mp4; codecs="ac-3"'),ec3:e.isTypeSupported('audio/mp4; codecs="ec-3"')}}return i.init(Jy.typeSupported,this.Zt,t).pipe(Ee(e=>this.pe[u]=e))}).pipe(ve(e=>{var t=r[u],i=this.willBeTrackSwitch(n,r);return{demuxer:e,trackSwitch:i,discontinuity:!(t&&l===t.discoSeqNum),contiguous:!!t&&!i&&t.mediaSeqNum+1===d,accurateTimeOffset:!s&&(a||!o)}}))}Sd(e){var e=e["track"],t=e["initSegment"],i=performance.now(),r=Pt.parseInitSegment(t,this.R),{mimeType:n,type:a,codec:s,container:o}=Xy(r,e.container),l=performance.now();return{moovData:r,mimeType:n,track:Object.assign(Object.assign({},e),{type:a,codec:s,initSegment:t,container:o}),stats:{tparsed:{tbegin:i,tend:l}}}}wd(e){return Fr(e)}}class Zy{constructor(e,t,i,r){this.Yi=e,this.Ur=t,this.Zt=i,this.R=r,this.pn=new Ie,this.Id(),this.Td()}destroy(){this.Ur.destroy(),this.pn.next(),this.Yi=void 0}Td(){var e=yl(this.Yi,this),t=[e.event(L.KEY_REQUEST_STARTED,this.Od,this),e.event(L.KEY_LOADED,this.kd,this)];try{"object"==typeof window&&window.BeforeUnloadEvent&&t.push(Dn(window,"beforeunload").pipe(Ee(this.Md.bind(this))))}catch(e){}finally{Bn(...t).pipe(an(this.pn)).subscribe()}}Id(){this.Yi.itemQueue.activeItemById$.pipe(Yl(),Ee(t=>{var i=this.Yi.itemQueue.getActiveItemContext(t.itemId);if((null==i||!i.reloadedForCapChangeOrErrorRecovery)&&t&&!t.parentItemId){let e=!1;if(this.Yi.userInfo?this.Yi.userInfo.internalBuild?e=!0:this.Yi.userInfo.diagnosticsAndUsage&&(e=this.Zt.enableRtcReporting):e=this.Zt.enableRtcReporting,e){const t=this.Yi.reportingAgent;t&&this.Ur.setReportingAgent(t)}else this.Ur.setReportingAgent(null);this.Ur.serverInfoInstance=null;var i=t.itemId,r=!!t.loopCount&&0<t.loopCount;this.Ur.rtcStore.createEntity(i,this.Ur.hlsjsVersion,this.Zt.enableInterstitialPlayback,r,this.Zt.testGroupId,null==(r=t.platformInfo)?void 0:r.maxHdcpLevel),!this.Yi.isFirstItem&&this.Yi.inGaplessMode||this.Ur.setPeriodic(i)}}),an(this.pn)).subscribe()}Od(e){this.Ur.report(29,{timestamp:performance.now(),keyuri:e.keyuri,forInterstitial:this.Yi.interstitialActive})}kd(e){var t;this.Ur.report(30,{keyFormat:"AES-128"===(null==(t=e.decryptdata)?void 0:t.method)?"identity":null,keyuri:e.keyuri,timestamp:performance.now(),adt:e.adt,mediaOptionId:e.mediaOptionId,currentTime:this.Yi.realCurrentTime,forInterstitial:this.Yi.interstitialActive})}Md(){var e;this.Zt.rtcUseSendBeacon&&null!=(e=this.Yi.reportingAgent)&&e._useSendBeaconForRemainingRequests(),this.Ur.detachMedia()}}function ev(n,a,s){return e=>{var t,i,r;return t=n,i=a,r=s,br([e.pipe(Ae(e=>{return e?Bn(e=new tu(e,t,i,r),be(e)):be(null)})),e]).pipe(ve(([e,t])=>({legibleSystemAdapter:e,mediaSink:t})))}}Zy.loggerName={name:"rtc-service"};fl;class tv{constructor(e){this.Dc=e}destroy(){this.Dc=void 0}get inGaplessMode(){return Boolean(this.Dc&&this.Dc.inGaplessMode)}get isFirstItem(){return Boolean(this.Dc&&this.Dc.isFirstItem)}get isPreloading(){return Boolean(this.Dc&&this.Dc.isPreloading)}get loadingItem(){return this.Dc&&this.Dc.loadingItem}get playingItem(){return this.Dc&&this.Dc.playingItem}dequeueSource(e){var t;null!=(t=this.Dc)&&t.dequeueSource(e)}queueSource(e,t){var i;null!=(i=this.Dc)&&i.queueSource(e,t)}endSource(){var e;null!=(e=this.Dc)&&e.endSource()}}return class dv extends fl{constructor(e={},t,i,r,n=va()){var a,s,o,l,d,u,c;if(super(),this.sessionID=n,this.pn=new Ie,this.Ad=new jr(null),this.jc=new jr(null),this.Bc=new jr(null),this.Uc=new jr(null),this.Ed=null,this.Ao=null,this.Nd=null,this.nc=new Fy(new Ny),this.Rd=(f=this.nc,new Og(new fg,f)),this.Pd=new Wh(new Gh),this.Rc=new Po(new Ro),this._d=new al,this.Cd=null,this.xd=null,this.wh=new Ws,this.Dd=!0,this.Qr=new Ih,this.Ld=!1,this.Fd=new jr(void 0),this.jd=[],this.Bd=new Ie,this.Ud=new jr(!0),this.$d=new tv(this),this.Vd=new jr(null),this.qd=new Cy(this),e.liveSyncDurationCount&&e.liveSyncDuration)throw new me(!0,pe.MixedLiveSyncDurationConfig);let h="silent";e.debug&&(h=e.debugLevel),this.zd=new $s(null!=(f=e.rtcLogHistoryNumLines)?f:ks.rtcLogHistoryNumLines),this.logger=null!=(f=this.logger)?f:([f,c={},u]=[n,function(r){const e=r["consoleOverride"],n=new Set(r.allowed),a=new Set(r.disallowed);return Object.assign({name:"hls",timestamp:r.sendLogs?mu.stdTimeFunctions.epochTime:mu.stdTimeFunctions.isoTime,browser:{asObject:!0,serialize:!0,transmit:{send:(e,t)=>{var i=null!=(i=null==(i=t.messages[0])?void 0:i.name)?i:t.bindings[t.bindings.length-1].name;n.size&&!n.has(i)||a.size&&a.has(i)||null==(i=r.storeLogs)||i.call(r,t)}},write:{debug:Mu.bind(null,Ru(e||console,"debug"),"debug",n,a),info:Mu.bind(null,Ru(e||console,"info"),"info",n,a),warn:Mu.bind(null,Ru(e||console,"warn"),"warn",n,a),error:Mu.bind(null,Ru(e||console,"error"),"error",n,a),fatal:Mu.bind(null,Ru(e||console,"error"),"fatal",n,a)}}},r)}({allowed:e.allowedLogs,buildType:e.buildType,consoleOverride:"boolean"!=typeof e.debug?e.debug:void 0,disallowed:e.disallowedLogs,level:"log"===h?"debug":h,sendLogs:e.sendLogs||null,storeLogs:this.zd.recordLogs.bind(this.zd)}),this.Ud],(d=mu(([d={}]=[c],Object.assign(Object.assign({},d),{customLevels:Object.assign(Object.assign({},d.customLevels||{}),{qe:35,timing:35})}))).child({sessionId:f,name:"hls",isEnabled:u})).qe=function(t,e=[],i=[]){const r=new Set(e),n=new Set(i);return e=>{r.size&&!r.has(e.name)||n.has(e.name)||t.info(e)}}(d,c.allowed,c.disallowed),(a=d).perf=function(e){var t;null!=(t=e)&&"object"==typeof t&&"critical"in t&&"name"in t&&"data"in t?e.data.tnow=performance.now():"object"!=typeof e||"tnow"in e||(e.tnow=performance.now()),a.info(e)},d.sessionId=f,"function"!=typeof d.isLevelEnabled&&(d.isLevelEnabled=function(e){return this.levels.values[e]>=this.levelVal||this.levelVal<=35&&("qe"===e||"perf"===e)}.bind(d)),d);const p=function(i,e,t,r){if(r.child({name:"remote-config"}),!(i&&t&&(r=i,o=Cs,null!=r)&&r.BagDict&&r.ConfigurationDict&&(r=r.Version)&&o&&(r=r.split("."),o=o.supportedStorebagVersion.split("."),r[0]===o[0])))return{};const n=i.ConfigurationDict;let a={};var s,o=(r=i.BagDict[t.clientName])?r[t.serviceName]:null;if(function(t,i){if(!t||!i)return!1;const r=t.VersionRange;if(!r)return!1;const n=r[0],e=r[1];if(!(n&&e&&au(n,e)))return!1;var a=t.SamplingThreshold;if(!(fe(a)&&a<=1&&0<=a))return!1;if(!(a=t.Configurations))return!1;let s=0;for(const t of a){if(!t)return!1;const l=t[0],r=t[1],n=l?i[l]:null;let e=!1;if(!(e=n?null!=n.GroupId&&"string"==typeof n.GroupId&&n.GroupId.length<20:e))return!1;if(!(l&&n&&n.Patch&&fe(r)))return!1;s+=r}var o=Math.abs(1-s)<=Number.EPSILON;return a&&0<a.length&&o&&(a=new Date(t.ExpirationDate))&&a.getTime()>Date.now()}(o,n)&&o){const i=Math.max(0,Math.min(o.SamplingThreshold,1)),t=0===su([i,1-i]);if(r=e,e=o.VersionRange,s=e[0],e=e[1],(null==s||au(r,s))&&(null==e||au(e,r))&&t){s=o.Configurations.map(e=>[n[e[0]],e[1]]),r=su(s.map(([,e])=>e));const i=s[r][0],e=Object.keys(i.Patch).filter(e=>e in ks&&!nu.has(e)).reduce((e,t)=>(Object.prototype.hasOwnProperty.call(i.Patch,t)&&(e[t]=i.Patch[t]),e),{});a.testGroupId=i.GroupId,a=Object.assign(a,e)}}return a}(r,dv.version,i,this.logger),m=Object.assign(Object.assign(Object.assign({},ks),e),p);if(m.maxRequiredStartDuration<m.minRequiredStartDuration||m.minRequiredStartDuration<0||m.minRequiredStartDuration<m.minRequiredStartDurationLLHLS)throw new me(!0,pe.InvalidRequiredStartDuration);this.ah=m,this.itemQueue=(u=this.logger,c=this.ah,f=new ua({},{name:"item-queue",idKey:"itemId",resettable:!0}),new Vy(f,u,c)),this.Hd=new $p(void 0,this.logger),this.Nc=(d=this.logger,r=this.ah,new Cp(new Pp,d,r)),i=m.buildType,W="production"===i,Xn=!1,Wn&&(delete window.$$stores,delete window.$$queries),this.ah.audioPrimingDelay=0,this.Qd=new dp(this,n,this.logger),this.Ur=new pp(this,m,dv.version,this.Qd,this.logger,this.zd.getLogs.bind(this.zd)),this.Kd=new Zy(this,this.Ur,m,this.logger),m.enableBoss&&(this.Wd=new rh(new Fu)),this.Lc=this.Lc=(e=this.nc,f=this.logger,r=m,i=this.Ur,s=this.Nc,o=this.Wd,l=this.Rc,new dy(new oy,e,f,r,i,s,o,l)),this.Ke=new iu(this.logger,m.useCustomURLLoaderForAuthOrCORSErrors),this.Gd=new ru(vo,this.Ke.load,this.logger),this.nc.setHlsEntity({id:n,config:m});var e=this.Pd.query,f=this.Rc.interstitialQuery,r=(this.Uc.next(f),this.Sh=new Dy(this,this.logger,this.Ur,this.Ke,this.Lc,this.Rd,this.Nc,m),this.Xd=new Qy(this.itemQueue,this.Rc,this.jc,this.Bc,this.Rd,m,this.Ur.rtcQuery,this.Sh,this.Ke,this.wh,this.logger),this.Sh.setInterstitialController(this.Xd),this.Sh.setInterstitialQuery(f),this.Yd=new ci,this.Jd={error:e=>{this.logger.error(`Final error `+(null==e?void 0:e.message)),this.Yd.unsubscribe()}},this.Zd=this.Zd.bind(this),this.tf(),this.ef(m));this.Cd=this.if(r,m,e),this.nf(r,m),this.Ao=(()=>{let e=null;return null!=m.createRPCService&&(e=op(m.createRPCService,np)),(e=null==(e=m.enableWorker&&null==e?lp:e)?np:e)(this.logger)})(),this.Nd=(i=this.Ao,{crypto:new ep(i),mux:new tp(i)}),this.Yd.add(this.sf.bind(this))}get rootPlaylistQuery$(){return gr(this.jc.pipe(ha),Zi)}get mediaElementQuery$(){return gr(this.Bc.pipe(ha),Zi)}get interstitialQuery$(){return gr(this.Uc.pipe(ha),Zi)}get activeRootPlaylistQuery(){return this.jc.value}rf(e){return this.Lc.getQueryForId(e)}get lf(){return this.Bc.value}static get version(){return"2.920.4"}static get Events(){return c}static get ErrorTypes(){return K}static get ErrorDetails(){return q}get Events(){return dv.Events}get ErrorTypes(){return dv.ErrorTypes}get ErrorDetails(){return dv.ErrorDetails}static get DefaultConfig(){return Y(ks)}get DefaultConfig(){return dv.DefaultConfig}static isSupported(){try{var e=Ju(),t=window.SourceBuffer||window.WebKitSourceBuffer,i=e&&"function"==typeof e.isTypeSupported&&e.isTypeSupported('video/mp4; codecs="avc1.42E01E,mp4a.40.2"'),r=!t||t.prototype&&"function"==typeof t.prototype.appendBuffer&&"function"==typeof t.prototype.remove;return!!i&&!!r}catch(e){return!1}}static loadRemoteConfigurations(e,t,i){var r,n,a,s={maxNumRetry:0,maxRetryDelayMs:0,retryDelayMs:0};return r=e,n={xhrSetup:i},a=Object.assign(Object.assign({},t),{autoRetry:!1,timeoutRetry:s,errorRetry:s}),Mn(()=>vo({url:r,xhrSetup:n.xhrSetup,method:"GET",responseType:"text",extendMaxTTFB:0},a).pipe(ve(([e])=>JSON.parse(e.responseText))))}uf(e,t){this.Yd.add(e.subscribe(t||this.Jd))}tf(){this.uf(this.Bd.pipe(Pr(()=>0===this.jd.length?Se:this.jd.shift())),void 0)}ef(t){var i,r,n,a,s,o,e=this.Ad.pipe((i=t,n=(r=this).qd,a=this.logger,s=this.Qr,o=this.Ur,e=>e.pipe(Ae(e=>e?((e=new Hh(e,new mh,i,r,n,a,s,o)).openMediaSource(),Bn(e,be(e))):be(null)))),Ee(e=>{e&&Yg(this.Pd,e.mediaQuery,t),e=null!=(e=null==e?void 0:e.mediaQuery)?e:null,this.Sh.setMediaElementQuery(e),this.Bc.next(e)}),Hr(()=>{this.Sh.setInterstitialQuery(null),this.Bc.next(null)}),Jr());return this.uf(e,void 0),e}if(e,t,i){const r=new ed(new Zl),n=new zl(r,e,t,i,this,this.Ur,this.Ke,this.logger,(o=t.keyLoadPolicy,l=this.Lc,d=r.query,e=>e.pipe(la(e=>{const t=l.query.getActiveId(),i=d.getKeyInfo(e.uri);i&&i.mediaOptionKeys.some(({itemId:e})=>e===t)&&ky(i,!1,l.getQueryForId(t),l)}),Yr({delay:(e,t)=>{if(e instanceof ul||e instanceof cl||e instanceof hl)return Ly(e,t-1,ao(e,no({url:e.keyuri},o)),l,d);throw e}}))),(a=this.Ur,s=this.logger,t=>e=>e.pipe(Yr({delay:function(e,t,i,r,n){if(r instanceof Ys){if(n--,e=ao(r,e),Zp(r).errorAction===U.RetryRequest)return rm(r,n,e,0,t);r.fatal=!0,im(0,r)}throw r}.bind(null,t,a,s)}))));var a,s,o,l,d;const u=this.Qr;return this.Yd.add(function(){u.wrap(n.destroy()).subscribe()}),n}nf(e,t){const i=new ci,r={add:i.add.bind(i),error:e=>{i.unsubscribe(),this.uf(this.Zd(e))}};var n,a,s;this.cf(r),this.hf(r,t),this.df(r,e,t),this.vf(r,t.enablePerformanceLogging,t.attemptErrorRecovery),t.enableInterstitialPlayback&&(Ce(r,this.Bc.pipe(this.Xd.interstitialEpic(this.nc))),Ce(r,this.Xd.dequeueSequence.pipe(Ee(e=>{var t=this.nc.query,i=(this.nc.decrementActiveDequeueCount(),t.holdingAirplayInterstitialSeek);if(0===t.activeDequeueCount&&i){this.nc.clearHoldingInterstitialSeek();const e=Le(this.itemQueue.getQueueItemForId(i.itemId));this.itemQueue.updateItemById(i.itemId,{initialSeekTime:i.originalSeekTo+e}),this.pf(i.originalSeekTo)}}),Jr()))),Ce(r,this.itemQueue.activeItemById$.pipe(ve(e=>e?Ns(e):void 0),Yl(),Te(),(n=t,a=this.Nc,s=this.logger,e=>e.pipe(Te(),Ae(r=>new F(()=>{var e,t;t=r,(e=a).getQueryForId(t).hasEntity(t)?e.setActive(t):e.addEmptyEntity(t);const i=a.getQueryForId(r);return()=>{Ap.setCombinedEstimate(n,Object.assign({},i.getCombinedEstimate()),s,r),a.remove(r)}})))))),this.Yd.add(i)}cf(e){t=this.Pd;var t,i="boolean"!=typeof(i=(()=>{if("function"==typeof matchMedia){var e=matchMedia("(dynamic-range: high)"),t=matchMedia("bad query");if(e.media!==t.media)return t="function"==typeof e.addEventListener?Dn(e,"change"):"function"==typeof e.addListener?Nn(e.addListener.bind(e),e.removeListener.bind(e)):Se,Bn(be(e.matches),t.pipe(ve(jh)))}return!0})())?i.pipe(Ee(e=>{t.updateSupportsHdr(e,!0)})):void t.updateSupportsHdr(i,!1);i&&Ce(e,i)}hf(e,n){Ce(e,this.itemQueue.removedItems$.pipe(Er(t=>{Oe(()=>{var e;this.Rd.remove(t),this.Lc.removeItems(t),this.Ur.removeItemList(t),n.enableBoss&&null!=(e=this.Wd)&&e.destroyItems(t)});var e=n.minRequiredStartDuration;let i=rr(1e3*e);var r=this.currentItem;if(r){const t=Le(r)+e;i=ol(null==(r=this.Ed)?void 0:r.mediaQuery.timeupdate$,e=>e>t)}return i.pipe(Ae(()=>this.Cd.removeItemsAndKeys(t)))})))}df(e,t,i){var r=this.itemQueue.activeItemById$.pipe(tn(1),Ae(e=>br([this.mf(e,this.itemQueue,this.Ed,this.logger),new F(this.gf.bind(this,e,this.itemQueue.isPreloading(),i))]).pipe(ve(([,e])=>e))),Yr({delay:this.Zd}));Ce(e,br([r,t.pipe(ev(i,this,this.logger),Ee(({legibleSystemAdapter:e,mediaSink:t})=>{this.xd=e,this.Ed=t}))]).pipe(Ee(([e,t])=>{var i,r,{legibleSystemAdapter:t,mediaSink:n}=t;e&&this.Cd&&t&&n?({rootPlaylistQuery:e,mediaParser:i,config:r}=e,this.Fd.next({logger:this.logger,config:r,hlsService:this.nc,platformService:this.Pd,statsService:this.Nc,rtcService:this.Ur,rpcClients:this.Nd,hlsQuery:this.nc.query,rootPlaylistService:this.Lc,rootPlaylistQuery:e,mediaLibraryService:this.Rd,keySystemAdapter:this.Cd,legibleSystemAdapter:t,mediaSink:n,mediaParser:i,iframeClock:this.wh,playerEvents:this.Sh,mediaSelectionBossService:this.Wd,interstitialService:this.Rc,interstitialController:this.Xd,customUrlLoader:this.Ke,gaplessInstance:this.$d,itemQueue:this.itemQueue,errorRecovery:this.qd,operationQueue:this.Hd,subtitleOperationQueue:new $p(void 0,this.logger),keyTracker:this._d})):this.Fd.next(void 0)})))}vf(e,t,i){Ce(e,this.Fd.pipe(Ae(e=>new F(this.yf.bind(this,t,i,e)))))}yf(e,t,i,r){if(!i)return r.complete();if(i.rootPlaylistQuery.itemId!==(null==(T=this.itemQueue.activeItem)?void 0:T.itemId))return r.complete();var n,F,a,o,l,B,U,s,_,d,V,u,Q,c,h,p,m,H,f,g,q,K,j,y,v,E,I,S,b,{rootPlaylistService:$,rootPlaylistQuery:T,mediaSink:G,itemQueue:A,logger:W,config:O,mediaSelectionBossService:z}=i,Y=G.mediaQuery,X=T.mediaOptionListQueries[we.Variant].hasIframes,w=dl(r),r=A.activeItem;if(T.isInterstitial||this.Ld||this.bf(W),this.Sf=new By({itemQueue:this.itemQueue,interstitialService:this.Rc,interstitialController:this.Xd,rootPlaylistService:this.Lc,legibleSystemAdapter:this.xd,mediaElementQuery:this.lf,mediaElementAdapter:this.Ed,logger:this.logger,config:this.ah}),this.Ed.addAirPlaySource(r.url),y=this.nc,Ce(w,(v=A,I=(E=i).rootPlaylistQuery.itemId,C=v.getQueueItemForId(I),S=(null==(S=v.playingItem)?void 0:S.itemId)===I,b=S||null!=C&&C.seekImmediately?null==C?void 0:C.initialSeekTime:null,E.logger.child(Ky),(S||null!=C&&C.seekImmediately)&&v.updateItemById(I,{initialSeekTime:void 0,seekImmediately:void 0}),S=y.query,null!=b&&null==S.pendingSeek&&y.setUserSeek(b),S.pendingSeek$.pipe(function(v){const{config:I,mediaSink:S,rootPlaylistQuery:b,mediaLibraryService:T,itemQueue:A}=E;return E.logger.child(Ky),e=>e.pipe(Te((e,t)=>e===t||Number.isNaN(e)&&Number.isNaN(t)),Ae((e,i)=>{var t,r,n,a,s,o,l,d,u,c,h,p,m,f,g,y;return null==e?Se:(t=S.mediaQuery.seekTo$.pipe(tn(1),Yl(),ve(()=>{})),r=0===i,n=I,a=b,s=T,o=S.mediaQuery,l=A,Wr([e instanceof Date?(f=e,g=r,y=n,Bg(a,s).pipe(ve(e=>{var t=e[we.Variant],i=Wp(e);let r=Ne(t.pdtToMSN,t.fragments,f),n=NaN;return i||(r=Km(r,e,y)),g&&(n=i?Am(t):qm(e,y).end),{seekTo:r,playlistEnd:n}}),Dr(1))):(d=e,u=r,c=n,p=o,m=l,Bg(h=a,s).pipe(Ur(e=>null!=e[we.Variant]),Ur(e=>{return t=e[we.Variant],!(c.liveAllowLowLatencyPlayback&&t.liveOrEvent&&t.parts&&0<t.parts.length&&(!fe(d)||d<0||0===d&&c.liveEdgeForZeroStartPositon)&&zf(e[we.Variant]));var t}),Dr(1),ve(e=>{var t=null!=p.liveSeekableRange,i=Wp(e);let r=NaN;return{seekTo:jy(d,u,e,c,h,m,t),playlistEnd:r=u?i?Am(e[we.Variant]):qm(e,c).end:r}}))),t]).pipe(Dr(1),ve(e=>{var t;if(e)return{seekTo:e,playlistEnd:t}=e,fe(t)&&0===i&&(S.msDuration=t),S.seekWithOptions(null!=e?e:NaN,void 0,!0),null!=e?e:void 0}),Hr(()=>{v.setUserSeek(void 0)})))}))}(y)))),Wy(w,i,{delay:this.Zd}),null!=T.contentSteeringOption&&(C=i["config"],Ce(w,be(i).pipe((j=(K=C).steeringManifestLoadPolicy,e=>e.pipe(Ae(i=>{const{logger:t,operationQueue:r,rootPlaylistQuery:e,statsService:n,itemQueue:a,customUrlLoader:p,hlsService:s}=i,o=e["itemId"],l=e["rootPlaylistEntity"],d=l["contentSteeringOption"],m=new Map;if(null==d||!i.config.enableContentSteering)return Un;const u=a.getQueueItemForId(o),f=n.getQueryForId(Ns(u)),c=new jr(3e5);let g=d["serverURI"],y=l["baseUrl"];const v=s.query.extendMaxTTFB;return Pe.pipe(Ae(()=>{return i=g,r=y,n=e.appItemId,a=K,s=j,o=p,l=e.currentPathwayID,d=new Set([...m.keys()]),u=f.getBandwidthEstimate(K),c=v,h=t,Mn(()=>{var e,t=rl.convertDataUriToArrayBytes(i);return null!=t?be({responseText:De.utf8arrayToStr(t),responseURL:i}):(t=[],(e=La.parseURL(i))&&""!==e.query&&"?"!==e.query&&t.push(e.query.substr(1)),null!=l&&t.push(`_HLS_pathway=`+encodeURIComponent(l)),null!=u&&fe(u.avgBandwidth)&&t.push(`_HLS_throughput=`+Math.round(u.avgBandwidth)),0<t.length&&e&&(e.query="?"+t.join("&"),i=La.buildURLFromParts(e)),t=no({url:i},s),Lo({url:i,xhrSetup:a.xhrSetup,appItemId:n},t,c,o))}).pipe(ve(({responseText:e,responseURL:t})=>({steeringManifest:Df(e,r,d,h),responseURL:t})));var i,r,n,a,s,o,l,d,u,c,h}),Ee(({steeringManifest:e,responseURL:t})=>{y=t,null!=e.reloadURI&&(g=e.reloadURI),c.next(1e3*e.ttl),t=function(r,n,a){const{config:s,rootPlaylistQuery:o,rootPlaylistService:l,mediaSelectionBossService:d}=r;return{operation:gp.ContentSteering,priority:fp.Low,execute:(e,t,i)=>(Oe(()=>{var e,t=n["pathwayPriority"],i=(i=o["rootPlaylistEntity"]).mediaOptionListTuple[we.Variant],r=null!=(r=n.pathwayClones)?r:[];(!function(t=[],i=[]){if(t.length!==i.length)return!1;for(let e=0;e<t.length;e++)if(t[e]!==i[e])return!1;return!0}(i.pathwayPriority,t)||r.length)&&(i=s.enableBoss,e=s.enableContentSteering,i&&e&&null!=d&&d.setTransformer(o.itemId,Re.ContentSteeringPathwayCloner,new ih(r,o.baseUrl,a)),l.doPathwaySwitch(o.itemId,t,a))}),My(r,void 0),Se)}}(i,e,m),r.enqueue(t)}),ye(e=>(t.error("error in Content Steering epic:",e),Pe)),(h=()=>c.pipe(sn(e=>0<e),Ae(e=>rr(e))),ti((e,t)=>{var i,r,n=!1,a=!1,s=!1,o=()=>s&&a&&(t.complete(),!0),l=()=>{s=!1,i=e.subscribe(ji(t,void 0,()=>{s=!0,o()||(r||(r=new Ie,h().subscribe(ji(t,()=>{i?l():n=!0},()=>{a=!0,o()}))),r.next())})),n&&(i.unsubscribe(),i=null,n=!1,l())};l()})));var h}),nn(Un)))))),O.enableBoss&&z&&(v=$,I=O,Ce(b=w,(q=S=z,(g=y=T).hdrMode$.pipe(Ae(e=>{var t=new _c(g.hasHdrLevels,g.preferHDR);return null!=q&&q.setTransformer(g.itemId,Re.HDRFilter,t),Se})))),Ce(b,(f=S,(H=y).maxHdcpLevel$.pipe(Ae(e=>(e=new Hc(e),null!=f&&f.setTransformer(H.itemId,Re.HDCPFilter,e),Se))))),Ce(b,(h=v,m=S,(p=y).pathwayPenaltyBox$.pipe(Ae(e=>{var t;return null!=h&&h.isContentSteeringEnabled()&&(t=new Uc(e),null!=m&&m.setTransformer(p.itemId,Re.PathwayPenaltyBoxFilter,t),function(e,i){if(e.rootPlaylistEntity){const t=e.rootPlaylistEntity.mediaOptionListTuple[we.Variant].pathwayPriority;if(t&&t.find(t=>!i.find(e=>e.id===t))!==e.currentPathwayID)return!0}return!1}(p,e))&&h.doPathwaySwitch(p.itemId),Se})))),Ce(b,(c=S,(Q=y).viewportInfo$.pipe(Ae(e=>(e=new Vc(e),null!=c&&c.setTransformer(Q.itemId,Re.ViewportFilter,e),Se))))),Ce(b,(u=S,(V=y).variantRemoved$.pipe(Ae(e=>(e=new Nc(e),null!=u&&u.setTransformer(V.itemId,Re.PermanentRemovalFilter,e),Se))))),Ce(b,(d=S,(_=y).variantCompatibleIds$.pipe(Ae(e=>(e=new Fc(e),null!=d&&d.setTransformer(_.itemId,Re.CompatibleIdsFilter,e),Se))))),Ce(b,(s=S,(U=y).variantPenaltyBox$.pipe(Ae(e=>(e=new Bc(e),null!=s&&s.setTransformer(U.itemId,Re.PenaltyBoxFilter,e),Se))))),Ce(b,(l=S,B=I,I=(o=y).enabledMediaOptionKeys$.pipe(Te((e,t)=>e[we.AltAudio].mediaOptionId===t[we.AltAudio].mediaOptionId&&e[we.Subtitle].mediaOptionId===t[we.Subtitle].mediaOptionId)),_n([o.combinedAltAudioFilterChange$,o.combinedSubtitleFilterChange$,I]).pipe(Ae(([e,t,i])=>{var r=o.mediaOptionListQueries,n=o.getEnabledMediaOptionMask(),a=o.enabledVariantMediaOption,s=o.enabledMediaOptionKeys[we.AltAudio],s=Bs(s)?o.alternateMediaOptionById(we.AltAudio,s.mediaOptionId):null,a=ge.getStickyAtmosStatus(B.useStickyAtmosFilter,a.audioCodec,null==s?void 0:s.channels),s=r[we.AltAudio].mediaOptionFromId(i[we.AltAudio].mediaOptionId),r=r[we.Subtitle].mediaOptionFromId(i[we.Subtitle].mediaOptionId),i=new Zc(a,e,t,null==s?void 0:s.persistentID,null==r?void 0:r.persistentID,n,[null==r?void 0:r.backingMediaOptionId],!1),a=new Map([[Re.ValidAlternatesFilter,i],[Re.ErrorHandlingValidAlternatesFilter,i]]);return null!=l&&l.setMultipleTransformers(o.itemId,a),Se})))),Ce(b,(n=v,a=S,(F=y).currentPathwayID$.pipe(Ae(e=>(null!=n&&n.isContentSteeringEnabled()&&null!=a&&a.setTransformer(F.itemId,Re.MatchingPathwayFilter,new th(e)),Se)))))),this.inGaplessMode||O.enableInterstitialPlayback){const{interstitialService:e,legibleSystemAdapter:t,rtcService:r,gaplessInstance:T}=i;this.wf(w,A,$,Y,e,t,r,O,T,W)}X&&(Ce(w,function(s){const{config:o,iframeClock:l,mediaSink:e}=i,d=e["mediaQuery"];return d.desiredRate$.pipe(Ae(a=>fh(a)?rr(0,Math.abs(1e3/a)).pipe(ve(()=>{let t;var i=d.seekable;if(l.isStarted&&!(i.length<1)){var r=null==(r=l.getCurrentTime())?void 0:r.seconds;if(fe(r)){var n=null!=(n=Le(s.getQueueItemForTime(r)))?n:0;let e=i.start(0);fe(e)||(e=0),i=Ey(d,o),1<a&&i<=r?(t={newRate:0,postFlushSeek:i},l.pause()):a<0&&r-n-e<a/-2&&(t={newRate:1,postFlushSeek:e})}}return t}),Yl(),Dr(1)):l.isStarted?be({oldRate:l.timeline.rate,newRate:a,postFlushSeek:l.getCurrentTime().seconds}):Se))}(this.itemQueue).pipe(Ee(({oldRate:e,newRate:t,postFlushSeek:i})=>{this.If(null!=e?e:this.desiredRate,t,i)}))),fh(r.initialRate))&&this.setRate(r.initialRate),(this.ah.enableInterstitialPlayback||this.inGaplessMode&&this.isPreloading)&&this.Tf(w,T,G,Y,i.interstitialController,A,i.gaplessInstance,O,this.ah.interstitialsConfiguredForAirPlayReceiver,this.logger);var R,M,J,P,Z,C=r.loopCount;fe(C)&&0<C&&(R=Y,M=A,J=this.ah,P=O,Z=W,Ce(w,R.isBufferedToEnd$(P.maxBufferHole).pipe(Ur(e=>e),ve(e=>{const t=M.activeItem,i=Le(t),r=R.minSBDuration-i;if(Math.abs(r)<P.maxBufferHole)return null;var n=null==t?void 0:t.loopCount;if(fe(n)&&0<n||n===1/0){const e=R.getBufferInfo(R.currentTime,P.maxBufferHole),M=[null!=(n=null==(n=e[we.Variant])?void 0:n.buffered.end)?n:0,null!=(n=null==(n=e[we.AltAudio])?void 0:n.buffered.end)?n:0],i=Object.assign(Object.assign({},_y(t,!1)),{itemStartOffsets:M,initialSeekTime:fe(t.initialSeekTime)?t.initialSeekTime-Le(t)+M[we.Variant]:NaN,parentItemId:null!=(n=t.parentItemId)?n:t.itemId,loopCount:t.loopCount-1,seekImmediately:!1});return{activeItem:t,nextItem:Vy.createItem(t.name,t.url,J,Z,i)}}}),Yl(),la(({nextItem:e})=>{M.insertQueueItem(e),M.setActive(e.itemId,{itemStartOffsets:e.itemStartOffsets,initialSeekTime:e.initialSeekTime})})))),t&&this.Of(w,T);{var k=w,L=i,ee=this.nc.query,te=this.Gd,ie=this.Ad.value,re=e,ne=X;const{rootPlaylistService:ae,rootPlaylistQuery:D,itemQueue:se,logger:oe,gaplessInstance:le,playerEvents:de,rtcService:ue,mediaSink:ce,config:x}=L,N=ce.mediaQuery,he=N.gotFirstAppend$(Zi).pipe(Ee(function(){Ce(k,function(e){const t=e.mediaSink.mediaQuery,i=e.rootPlaylistQuery.statsId;return i?gr(Bn(t.seekTo$.pipe(Ur(e=>fe(null==e?void 0:e.pos))),t.flushing$.pipe(Kr(),Ur(([e,t])=>!0===e&&!1===t))).pipe(Ee(()=>Fm(e.config,e.logger,e.rootPlaylistQuery,e.mediaSink,e.mediaLibraryService,e.statsService.getQueryForId(i)))),Zi):Se}(L)),Ce(k,function(n){const{rootPlaylistQuery:a,mediaLibraryService:r,mediaSink:s,config:o}=n,l=s["mediaQuery"];return ol(r.getQueryForItem(a.itemId).lastLoadedMediaOptionByType$(we.Variant),e=>!!e).pipe(Ae(e=>{if(!(e=r.getQueryForOption(e).mediaOptionDetails))return Se;s.startMonitors(),s.bufferMonitorTargetDuration=Math.max(e.targetduration,vc(o,e,l.getMediaBufferInfo(l.desiredPos,o.maxBufferHole)));const t=performance.now(),i=[];return Qs.forEach(e=>{e!==we.Variant&&!a.hasAlternateWithUrl(e)||i.push(a.enabledMediaOptionByType$(e).pipe(Ng(r),Ae(e=>e?e.mediaOptionDetailsEntity$:Se),Te((e,t)=>(null==e?void 0:e.lastUpdateMillis)===(null==t?void 0:t.lastUpdateMillis)),Ur(e=>!1===(null==e?void 0:e.detailsLoading)&&e.lastUpdateMillis>t)))}),Bn(...i).pipe(pr(Zi),Ee(e=>{var t=s.mediaQuery,i=n.legibleSystemAdapter,r=e.mediaOptionDetails,e=e.lastUpdateMillis;if(r.liveOrEvent&&i&&t.readyState>=HTMLMediaElement.HAVE_METADATA)if(r.mediaOptionType!==we.Variant||Bs(a.enabledMediaOptionKeys[we.Subtitle])){if(r.mediaOptionType===we.Subtitle){const n=zy(t,o.liveOldCueRemovalOffsetSec,o.maxBufferHole);i.removeEarlierCues(n)}}else{const n=zy(t,o.liveOldCueRemovalOffsetSec,o.maxBufferHole);i.removeEarlierId3Cues(n)}if(function(e,t,i,r,l){return t=function(e,t,i,r,n){if(!t.ptsKnown)return 0;var a=t.targetduration,s=Hm(t,l).start,n=n.canContinuePlaybackWithoutGap(t,i,{avgPlaylistLoadTimeMs:0,avgPlaylistParseTimeMs:0},r);let o=Math.max(0,e-a);return o=e<s&&!n?s:o}(r.desiredPos,e,t,i,r),i=Hm(e,l).end,{expired:e.liveOrEvent&&e.ptsKnown&&i<t,windowEnd:i,minPosition:t}}(r,e,o.maxBufferHole,t,o).expired)throw new Js(!1,pe.LivePlaylistTooFar,r.mediaOptionType,r.mediaOptionId,r.url)}))}))}(L).pipe(Gy(oe,"enabledOptions"))),Ce(k,N.ended$.pipe(Ae(e=>e?Se:ol(_n([N.gotPlaying$,N.readyState$]),([e,t])=>!0===e||t>=HTMLMediaElement.HAVE_METADATA).pipe(Ae(()=>rr(0,1e3)),Ee(()=>{{var n=ie,a=N,s=ue,o=ke(se.playingItem),l=re,d=x.maxBufferHole,u=x.liveLowLatencyThreshold;let e=NaN,t=0;if(a.isPlayingAtLive){const n=a.liveSeekableRange,s=n.edge;n.end-s<u&&(t=1),e=(u=xe(s+(performance.now()-n.tupdate)/1e3,s)-a.currentTime,c=Math.pow(10,3),Math.round(u*c)/c)}var u=n.readyState>=n.HAVE_FUTURE_DATA,c=a.haveEnough&&u,h=a.seekableTimeRanges||[],u={readyToPlay:u,playbackLikelyToKeepUp:c,rate:n.playbackRate,paused:n.paused,position:n.currentTime,duration:n.duration,seekableTimeRanges:h.map(e=>[e.start,e.end]),loadedTimeRanges:jp.timeRangeToArray(n.buffered),interstitialActive:o,liveEdgeDistance:e,llState:t};let i=0,r=0;if(jp.isHtmlVideoElement(n)){const a=n.getVideoPlaybackQuality;if(a&&typeof a==typeof Function){const a=n.getVideoPlaybackQuality();i=u.droppedVideoFrames=a.droppedVideoFrames,u.corruptedVideoFrames=a.corruptedVideoFrames,u.totalVideoFrames=a.totalVideoFrames,r=u.totalVideoFrames-i}}else jp.isWebkitMediaElement(n)&&(i=u.droppedVideoFrames=n.webkitDroppedFrameCount,r=u.decodedFrameCount=n.webkitDecodedFrameCount);l&&a.getCombinedMediaSourceBufferInfo(d),null!=s&&s.report(19,{droppedVideoFrames:i,decodedFrameCount:r,liveEdgeDist:e,llState:t,bufferedRangeTuple:a.bufferedRangeTuple})}}))))),le.inGaplessMode||Ce(k,function(){const{config:e,mediaSink:t,rootPlaylistQuery:i,mediaLibraryService:r,gaplessInstance:n}=L,a=t["mediaQuery"];return br([Bg(i,r),a.msReadyState$,a.updating$,a.isIframeRate$,a.isBufferedToEnd$(e.maxBufferHole,!n.inGaplessMode)]).pipe(Ur(([,e,t,i,r])=>"open"===e&&!1===t&&!i&&r),Ee(([e])=>{null!=e[0]&&e.every(e=>null==e||!1===e.liveOrEvent&&!1===e.iframesOnly)&&!n.inGaplessMode&&t.endStream()}),nn(Se))}()),ne&&x.enableIFramePreloading&&Ce(k,(o=>{const{config:e,logger:r,mediaLibraryService:n,rootPlaylistQuery:a}=o;var t;return e.enableIFramePreloading?(t=a.enabledMediaOptionByType$(we.Variant).pipe(Ae(e=>{return e=n.getQueryForOption(e),t=a,i=t.mediaOptionListQueries[we.Variant].hasIframes,e=null!=(t=null==(e=e.getEntity(t.itemId))?void 0:e.liveOrEvent)&&t,i&&!e?function(e){var{config:t,rootPlaylistService:i,rootPlaylistQuery:r,logger:n,mediaLibraryService:a,mediaSelectionBossService:s}=e,s=sf(r,s,!0,t,n),t=i.abrController.nextAutoMediaOption(s,e,!0);return(n=r.variantMediaOptionById(t.variantMediaOption))?a.retrieveMediaOptionDetails(e,n,!0,!1):Se}(o).pipe(Dr(1),Vr(e=>{var t,i,r=o,{mediaSink:n,mediaLibraryService:a,rootPlaylistQuery:s}=r;if(null!=(n=cm(n=(n=n["mediaQuery"]).currentTime,null!=(n=lm(e,n))?n:-1,e))&&n.mediaFragment)return{itemId:n,mediaOptionId:t,mediaOptionType:i}=e=n.mediaFragment,Pn([e.keyTagInfo?xg(r,e.keyTagInfo,{itemId:n,mediaOptionId:t,mediaOptionType:i,appItemId:s.appItemId}):Se,a.retrieveInitSegmentCacheEntity(r,e,e.discoSeqNum)]).pipe(ve(()=>Hf.SUCCESS));throw new me(!1,pe.NoIframeFragmentToPrefetch)}),ye(e=>(r.error(`Got error ${e.message} in prefetch`),be(Hf.ERRORED)))):be(Hf.DISABLED);var t,i})),by(o,t,qf.VariantPlaylist).pipe(Dr(1),Hr(()=>{}))):be(Hf.DISABLED)})(L)),x.enableItemPreloading&&(de.triggerPrefetchNextItem(se.activeItem.appItemId),Ce(k,(s=>{const{config:e,logger:o,mediaLibraryService:l,itemQueue:t}=s;return e.enableItemPreloading?t.prefetchItemInfo$.pipe(Yl(),Te(),Ae(({item:e,recallStrategy:t})=>{var i=null==e?void 0:e.url;if(!i)return be(Hf.DISABLED);const r=vg(e),n=o.child({name:`prefetch:`+r}),a=Object.assign(Object.assign({},s),{logger:n});return null==r?be(Hf.DISABLED):(l.createPrefetchItemCache(r,i,n,t),by(a,function(l,d){const{logger:u,mediaLibraryService:e,config:c,rootPlaylistQuery:h}=d,t=l.url,i=vg(l),r=Va.getBaseURL(t)||t,n=Ig(h);let a;if(null!=i&&i===n)a=h.rootPlaylistEntity$;else{const h=c.manifestLoadPolicy,t=()=>{var e=l,t=h,{mediaSelectionBossService:i,statsService:r,hlsService:n,platformService:a,customUrlLoader:s,keyTracker:o}=d;return Sy(e,t,u,void 0,void 0,void 0,s,i,n,c,a.query,r,o,void 0,null,NaN,!1)};a=e.cachePrefetchRequest(i,qf.Manifest,new yg(Ig(l),t),u)}return a.pipe(Ty(d,i,t,qf.Manifest),ve(e=>{const{enabledMediaOptionKeys:t,mediaOptionListTuple:i}=e,[r,n]=t;return[null!=(e=i[we.Variant].mediaOptions.find(e=>e.mediaOptionId===r.mediaOptionId))?e:Me,null!=(e=i[we.AltAudio].mediaOptions.find(e=>e.mediaOptionId===n.mediaOptionId))?e:Me]}),(s=d,g=i,y=r,v=(o=l).initialSeekTime,Di(Ae(t=>{const{logger:n,mediaLibraryService:a}=s,i=[sl,sl];for(let e=0;e<Hs.length;e++){const n=t[e];if(n&&n.relativeUrl){const t=a.getQueryForOption(n).mediaOptionDetails;t&&n.mediaOptionType!==we.Subtitle?i[e]=be(t):i[e]=be(n).pipe(Ay(s,o,g,y))}}return Pn(i).pipe(Ae(e=>{var p,m,f,r,t=be(e).pipe((p=s,m=g,f=y,r=v,Di(Ae(e=>{var t=e[we.Variant];if(!t)throw new me(!1,pe.NoVariantMediaOptionToPrefetch);const{config:s,logger:o,mediaLibraryService:l}=p,d=be(Hf.SUCCESS),u=be(Hf.ERRORED),c=t.liveOrEvent,h=Im(e,{pos:c?Km(xe(r,-1),e,s):xe(r,0),fromEvent:!1},p.mediaSink.mediaQuery,[],void 0,!0,s,o),i=e.map((e,t)=>{if(!e)return d;const i=null==h?void 0:h.anchorFrags[t],r=i?Oc(e.fragments,i.mediaSeqNum,i.partIndex):void 0;var n,a;return r?c?xg(p,r.keyTagInfo,Object.assign(Object.assign({},r),{appItemId:m}),s.keyPrefetchMinHoldTimeBeforeCleanup).pipe(ve(()=>Hf.SUCCESS)):(t=Ka(e,f),t=Ka(r,t),n=r.mediaOptionType===we.Variant?qf.VariantSegment:qf.AltAudioSegment,(a=l.cachePrefetchRequest(m,n,new yg(bg(r),()=>l.prefetchFragmentAndInitSegment(p,f,m,e,r).pipe(oo(r,!1))),o))?a.pipe(ve(()=>Hf.SUCCESS),Ty(p,m,t,n)):u):u});return Pn(i).pipe(ve(e=>e.every(e=>e===Hf.SUCCESS)?Hf.SUCCESS:Hf.ERRORED))}))));let i=Se;return e[we.Variant].liveOrEvent&&(i=ll(...e.map(e=>rr(Ef(e)).pipe(Ee(()=>{e.mediaOptionType===we.Variant?a.deletePrefetchCacheEntry(g,qf.VariantPlaylist,n):a.deletePrefetchCacheEntry(g,qf.AltAudioPlaylist,n)}))))),by(s,Bn(t,i),e[0].liveOrEvent?qf.VariantPlaylist:qf.VariantSegment)}))}))));var s,o,g,y,v}(e,a),qf.Manifest).pipe(ye(e=>(n.error(`[prefetch] Caught unhandled error in item prefetch epic: `+e),be(Hf.ERRORED)))))}),Hr(()=>{})):be(Hf.DISABLED)})(L))),D.sessionData&&Ce(k,gr(ol(N.gotPlaying$,e=>e),Zi).pipe(Ae(()=>br([D.sessionData$,ee.config$])),Dr(1),Ae(([e,t])=>te.loadSessionData(e,t)),Ee(e=>{ae.setSessionData(D.itemId,e)}),ye(e=>(oe.error(`SessionData err:`+e.message),Se)))),L.platformService.query.supportsHdrMediaQuery||L.rootPlaylistService.pruneVariants(D.itemId)}));Ce(k,he)}}wf(e,t,i,s,a,o,l,d,u,r){Ce(e,t.playing$.pipe(Yl(),Te((e,t)=>e.itemId===t.itemId),Ae(r=>{const n=i.getQueryForId(r.itemId);return ol(n.rootPlaylistEntity$,e=>!!e).pipe(Ae(e=>{if(d.enableInterstitialPlayback){const e=a.interstitialQuery.playingInterstitialId,t=Le(r),i=n.enabledAlternateMediaOptionByType(we.Subtitle),d=(o.handlePlayingItemChanged({playingInterstitialId:e,startTime:t,subtitleMediaOption:i}),r.itemId),u=(ke(r),{itemId:d,interstitialId:r.interstitialId,interstitialAssetId:r.interstitialAssetId,appItemId:this.appItemIdFromItemId(d)});this.trigger(c.ITEM_PLAYING,u)}return u.inGaplessMode?be(r):Se}))}),Kr(),Ee(([e,t])=>{var i=e.itemId,r=t.itemId;if(Fo(r)&&!t.parentItemId){const e=Le(t),n=s.msDuration-e,a={prevItemId:i,prevAppItemId:this.appItemIdFromItemId(i),nextItemId:r,nextAppItemId:this.appItemIdFromItemId(r),nextStartTime:e,nextDuration:n};d.enableInterstitialPlayback||(this.trigger(c.ITEM_TRANSITIONED,a),l.itemTransitioned(i,r,s.getBufferedDuration(),s.currentTime,ke(r))),o.removeEarlierCues(e)}})))}Tf(e,t,i,a,r,s,n,o,l,d){let u="Gapless";o.enableInterstitialPlayback&&(u=l?"AirPlay Interstitial":"Interstitials"),null!=d&&d.child({name:u});const c=ol(a.timeupdate$,e=>{var t=s.playingItem,i=s.activeItem,r=s.loadingItem;return!!(n.inGaplessMode&&n.isPreloading&&r&&fe(r=Le(r,(ke(r)?o.interstitialEarlyStartMs:0)/1e3))&&r<=e&&(null==t?void 0:t.itemId)!==(null==i?void 0:i.itemId))}),h=this.Ad.pipe(Ae(t=>t?yl(t).event("waiting").pipe(ve(e=>vl(t,"waiting",e)),Ae(e=>{var t=s.loadingItem;if(o.enableInterstitialPlayback&&"waiting"===e.type&&t){const e=a.currentTime,i=Le(t),r=a.getCombinedBufferInfo(e,o.maxBufferHole).end;if(Math.abs(i-r)<o.maxBufferHole&&Math.abs(r-e)<o.maxBufferHole)return be(!0)}return Se})):Se)),p=ol(a.stallInfo$,e=>{var t=s.loadingItem;if(!t||a.waitingForDisco)return!1;{const a=null!=(e=null==e?void 0:e.currentTime)?e:0,i=this.realCurrentTime,r=Le(t,(ke(t)?o.interstitialEarlyStartMs:0)/1e3),n=a+Le(s.playingItem);return 0<i&&n>=r-o.maxBufferHole}});Ce(e,s.playing$.pipe(Ae(()=>Wr(c,h,p).pipe(Dr(1),Ae(()=>{var e=s.loadingItem;return this.kf(e,r,t,i)}))))),Ce(e,this.mediaElementQuery$.pipe(Ae(e=>e.gotPlaying$),Ee(e=>{var t=this.itemQueue.activeItem;e&&t&&fh(t.initialRate)&&this.itemQueue.updateItemById(t.itemId,{initialRate:void 0})})))}Of(e,t){Ce(e,t.variantPenaltyBox$.pipe(Ee(e=>{const t=this.Vd.value;t&&!e.find(e=>e.id===t)&&this.Vd.next(null)})))}sf(){var e,t,i,r;try{this.detachMedia(),this.trigger(c.DESTROYING),this.$d.destroy(),null!=(e=this.xd)&&e.destroy(),this.qd.destroy(),this.Sh.destroy(),null!=(t=this.Qd)&&t.destroy(),null!=(i=this.Kd)&&i.destroy(),this.Wd&&this.Wd.destroy(),this.Rd.clear(this.logger),this.Lc.removeAll(),this.Nc.destroy(),this.itemQueue.clearQueue(),this.nc.removeEntity(this.sessionID),this.Rc.reset(),this.Xd.reset(),this.jd=[],this.jc.next(null),this.Bc.next(null),this.Uc.next(null),null!=(r=this.Mf)&&r.reset(),this._d.clear(),this.ah.xhrSetup=void 0,this.Qd.reset()}catch(e){this.logger.error(`Got error in finalize `+e.message)}}mf(e,t,i,r){if(!i||!e)return Pe;var n=i.mediaQuery.combinedBuffer.length;if(n&&e.replaceItemAction==Ua.RESET_MEDIASOURCE){t.updateItemById(e.itemId,{replaceItemAction:Ua.DO_NOTHING});const r=e.initialSeekTime||0;return i.resetMediaSource(r),Pe}return n&&e.replaceItemAction==Ua.FLUSH_ALL?(t.updateItemById(e.itemId,{replaceItemAction:Ua.DO_NOTHING}),i.flushAll(0,1/0).pipe(Ae(()=>ol(this.Ed.mediaQuery.updating$,e=>!e)),ve(()=>{this.Ed.msDuration=0}))):Pe}kf(n,i,e,a){let s=n.initialSeekTime;const o=a.mediaQuery,t=o.getBufferedSegmentsByType(B.Variant).find(e=>e.frag.itemId===n.itemId);return ol(null!=t&&t.frag?be(t.frag):this.Rd.getQueryForItem(e.itemId).lastLoadedMediaOptionByType$(we.Variant),e=>!!e).pipe(Ae(e=>{if(null!=(e=null==(e=this.Rd.getQueryForOption(e))?void 0:e.mediaOptionDetails)&&e.liveOrEvent){const n=Qm(e,this.ah);s=Math.min(n,s)}this.ah.enableInterstitialPlayback&&n.snapIn&&i&&(s=i.snapIn(n,e));var e=null==(e=this.itemQueue.playingItem)?void 0:e.interstitialId,t=i.savedSeekValueById[e];fe(t)&&(s=t+Le(n),i.updateSavedSeekValueForInterstitialId(e,null));const r=this.ah.maxTotalDurationTolerance;return ol(o.mediaElementDuration$,e=>(!fe(s)||e>s-r)&&0<e).pipe(Ae(e=>{const t=(s=e<s?e-r:s)<0?Math.max(Le(n),e+s):s,i=this.Af(Le(n),t,o);return Oe(()=>{fe(i)&&i>=o.currentTime-this.ah.maxSeekHole&&a.seekWithOptions(i,void 0,!0,!1),this.itemQueue.updatePlayingItemId(!this.ah.enableInterstitialPlayback)}),Se}))}))}Af(e,t,i){const r=fe(t)?t:e,n=i.getCombinedBufferInfo(r,this.ah.maxBufferHole),a=n.nextStart;if(fe(a)){const e=i.getBufferedSegmentsByType(B.Variant).find(e=>e.startPTS<=r&&e.endPTS>r),s=e&&e.startPTS<=a&&e.endPTS>a;0!==n.len&&!s||(t=a)}return t}bf(e){fe(t=null==(t=null==(t=this.nc.query.alternateMatchingInfo)?void 0:t.audioMatchingInfo)?void 0:t.persistentId)&&(this.audioSelectedPersistentID=t);var t=null==(t=null==(t=this.nc.query.alternateMatchingInfo)?void 0:t.subtitleMatchingInfo)?void 0:t.persistentId;fe(t)&&(this.subtitleSelectedPersistentID=t),this.Ld=!0}Ef(t){var e=this.lf.getBufferedSegmentsByType(B.Variant).find(e=>e.startPTS<=t&&t<e.endPTS);if(e)return e.frag.mediaOptionId}recoverFromFatalError(){var e,t,i=this.playingItem;i&&(e=i.itemId,t=this.Ef(this.realCurrentTime))&&(this.Lc.addToPenaltyBox(e,we.Variant,t),this.reloadPlayingItem({parentItemId:i.parentItemId,itemId:e,reloadedForCapChangeOrErrorRecovery:!0},this.lf.currentTime))}shouldAttemptErrorRecovery(e){if(!this.config.attemptErrorRecovery)return!1;if(0!==this.desiredRate&&1!==this.desiredRate)return!1;let i=null;var t,r,n=null==(n=this.activeRootPlaylistQuery)?void 0:n.mediaOptionListQueries[we.Variant].filteredMediaOptionList.reduce((e,t)=>t.iframes?e:(i=t.mediaOptionId,e+1),0),a=this.Ef(this.realCurrentTime);return!!a&&!(0===n||1===n&&i&&i===a||!e.fatal||!(e.type===K.MEDIA_ERROR&&e.details===q.BUFFER_STALLED_ERROR||e instanceof s)||(n=this.Vd.value,t=null==(t=this.itemQueue.playingItem)?void 0:t.itemId,r=null==(r=this.itemQueue.playingItem)?void 0:r.url,n?(null!=(n=this.Ur)&&n.report(0,{hlsError:e,isFirstAttempt:!1,itemId:t,level:a,contentUrl:r}),1):(null!=(n=this.Ur)&&n.report(0,{hlsError:e,isFirstAttempt:!0,itemId:t,level:a,contentUrl:r}),this.Vd.next(a),0)))}Zd(t){var r,n,a;try{let i,e=t.message;if(t instanceof v?(i=t,e+=`type=${t.type} details=`+t.details):i=new me(!0,pe.InternalError,t.message,t.stack),i.appItemId=null==(r=this.itemQueue.activeItem)?void 0:r.appItemId,this.logger.error(`Got unhandled or fatal error: ${e}, fatal: ${i.fatal}, isHlsError: ${t instanceof v}, isInterstitial: `+this.interstitialActive),i instanceof s)return i.handled=!0,this.trigger(c.ERROR,i),Se;if(i.fatal&&this.isPreloading&&!this.ah.enableInterstitialPlayback&&this.dequeueSource("FatalErrorWhileLoading"),i.fatal){const{handled:t,error:r}=this.Xd.handleError(i,this.lf);if(t){const t=Object.assign(Object.assign({},r),{fatal:!1,interstitial:!0,message:r.message,appItemId:null==(n=this.itemQueue.activeItem)?void 0:n.appItemId});return null!=(a=this.Ur)&&a.report(us,{hlsError:t,forInterstitial:!0}),this.trigger(c.ERROR,t),Pe}let e=be(r);return(e=this.Ed&&this.Ed.mediaQuery.gotPlaying&&0<nf(this.Ed.mediaQuery,this.ah.maxBufferHole)?ol(this.Ed.mediaQuery.stallInfo$,e=>null!=e).pipe(ve(()=>r)):e).pipe(Er(e=>{var t;return null!=(t=this.Ur)&&t.report(2,{hlsError:i,forInterstitial:this.interstitialActive,contentUrl:null==(t=this.itemQueue.playingItem)?void 0:t.url}),e.appItemId=null==(t=this.itemQueue.activeItem)?void 0:t.appItemId,this.trigger(c.ERROR,e),Se}))}this.trigger(c.ERROR,i)}catch(t){throw this.logger.error(`Error thrown inside _handleError `+t.message),t}return Se}get currentItem(){return this.isPreloading?this.playingItem:this.itemQueue.activeItem}get realCurrentTime(){var t;const i=this.lf;if(!i){const a=this.itemQueue.activeItem;return null!=(n=null==a?void 0:a.initialSeekTime)?n:NaN}if(this.wh.isStarted){const n=i.seekable,a=0<n.length?xe(n.start(0),0):0,t=Ey(i,this.ah),r=this.wh.getCurrentTime().seconds-Le(this.playingItem);return Math.max(a,Math.min(t,r))}let r=i.desiredPos;var n=Le(this.playingItem);if(fe(r)&&fe(n)){let e=n;if(this.ah.enableInterstitialPlayback&&this.interstitialActive){const t=this.Rc.interstitialQuery,i=t.playingInterstitialId;i&&(e=(null!=(a=t.realCurrentTimeOffsetMap[i])?a:[0,0])[we.Variant])}r-=e}var n=(null==(t=this.playingItem)?void 0:t.initialSeekTime)-Le(this.playingItem),a=fe(n)?n:0;return Math.max(a,r)}set realCurrentTime(e){var t=Le(this.playingItem);!this.ah.enableInterstitialPlayback&&fe(t)&&(e+=t),this.seekTo=e}getCurrentIntegratedTimelineSegmentAndCurrentTime(e){if(this.Sf)return this.Sf.getCurrentIntegratedTimelineSegmentAndCurrentTime(e,this.realCurrentTime);{const e=this.realCurrentTime;return{segment:null,targetTime:e,sourceTime:e}}}get realDuration(){return this.lf?this.lf.primaryContentMediaElementDuration:1/0}get gapRanges(){return this.lf.getContentGapRanges()}get bufferedDuration(){var e=this.lf;return null!=(e=null==e?void 0:e.getBufferedDuration())?e:0}get sessionData(){var e=this.activeRootPlaylistQuery;return null==e?void 0:e.sessionData}get supportedFrameRates(){var e;const t=this.ah.trickPlaybackConfig["enabled"],i=this.ah["liveAllowTrickplay"],r=[0,1],n=this.activeRootPlaylistQuery,a=this.Rd.query;if(t&&n){const t=a.getEntity(null!=(e=null==n?void 0:n.itemId)?e:"noop");!t||t.liveOrEvent&&!i||r.push(8,24,48,96)}return r}loadSource(e,i,t,r){i&&Object.keys(i).filter(e=>0<=["itemId","streamID"].indexOf(e)).reduce((e,t)=>t in i?Object.assign(e,{[t]:i[t]}):e,{}),this.jd=[Mn(this.Nf.bind(this,{url:e,itemOptions:i,initialSeekTime:t,timeToPauseBuffer:r}))],this.Bd.next()}appItemIdFromItemId(e){return null==(e=this.itemQueue.getQueueItemForId(e))?void 0:e.appItemId}Rf(e){return null!=e?e:va()}Pf(e,t={},i,r){var n,a,s,o;if("playready"===this.ah.keySystemPreference&&!this.ah.enablePlayReadyKeySystem)throw new me(!0,pe.UnsupportedKeySystemError);if(!e||!e.trim().length)throw new me(!0,pe.EmptyLoadSourceError);if(e=Va.buildAbsoluteURL(window.location.href,e,{alwaysNormalize:!0}),null!=(n=null==t?void 0:t.appData)&&n.reportingAgent&&(this.reportingAgent=t.appData.reportingAgent),null!=t&&t.userInfo&&(this.userInfo=t.userInfo),null!=(n=this.Qd)&&n.setupReporter(null==t?void 0:t.appData),null!=t&&t.platformInfo&&this.Pd.updatePlatformInfo(t.platformInfo),function(e,t){if(t){const t=ja(e);return void 0!==$a.find(e=>new RegExp(e).exec(null!=t?t:""))}return!1}(e,this.ah.enableQueryParamsForITunes)){const i={language:t.language,dsid:t.dsid,subs:t.subs};n=e,a=null==t?void 0:t.platformInfo,d=i,o=a.model,l=a.manufacturer,o&&l&&(o=n,l=a.model,a=a.manufacturer,s=-1!==o.indexOf("?"),l=encodeURIComponent(null!=l?l:""),a=encodeURIComponent(null!=a?a:""),n=(o=s?o:o+"?")+Ga.deviceName+a+Ga.deviceModel+l),e=n=function(e,t){var i;let r;for(r in e=-1!==e.indexOf("?")?e:e+"?",t)t[r]&&(e+=Ga[r]+("subs"===r?encodeURIComponent(null!=(i=t[r])?i:""):t[r]));return e}(n,d)}this.Ld=!1;var l={initialSeekTime:i,initialRate:null==t?void 0:t.initialRate,platformInfo:null==t?void 0:t.platformInfo,clientName:null==(s=null==t?void 0:t.appData)?void 0:s.clientName,serviceName:null==(o=null==t?void 0:t.appData)?void 0:o.serviceName,appItemId:null==t?void 0:t.itemId,appName:null==(a=null==t?void 0:t.appData)?void 0:a.appName,loopCount:null==t?void 0:t.loopCount,replaceItemAction:null==t?void 0:t.replaceItemAction},d=this.Rf(null==t?void 0:t.itemId);this.itemQueue.setQueueItem(d,e,this.ah,l)}prefetchSource(e,t,i){var r;return null==e?(this.itemQueue.clearPrefetchItem(),this.Rd.clearPrefetchCache(this.logger),!1):null!=(null==t?void 0:t.itemId)&&(r=this.Rf(null==t?void 0:t.itemId),i={itemStartOffsets:[0,0],initialSeekTime:i,platformInfo:null==t?void 0:t.platformInfo,clientName:null==(i=null==t?void 0:t.appData)?void 0:i.clientName,serviceName:null==(i=null==t?void 0:t.appData)?void 0:i.serviceName,appItemId:null==t?void 0:t.itemId,appName:null==(i=null==t?void 0:t.appData)?void 0:i.appName,loopCount:null==t?void 0:t.loopCount},this.itemQueue.addPrefetchItem(r,e,this.ah,Kf.ONE_SHOT,i),!0)}prefetchPosition(e){var t=this.itemQueue.activeItem;return fe(e)&&t?(e=Object.assign(Object.assign({},t),{itemId:t.appItemId,initialSeekTime:e}),this.itemQueue.addPrefetchItem(e.itemId,t.url,this.ah,Kf.HOLD,e),!0):(this.itemQueue.clearPrefetchItem(),this.Rd.clearPrefetchCache(this.logger),!1)}queueSource(e,t,i){var r;null!=t&&t.userInfo&&(this.userInfo=t.userInfo);const n=null==(r=this.lf)?void 0:r.getBufferInfo(null==(r=this.lf)?void 0:r.currentTime,0),a=Hs.map(e=>null!=(e=null==(e=n[e])?void 0:e.buffered.end)?e:0),s={itemStartOffsets:a,initialSeekTime:i,platformInfo:null==t?void 0:t.platformInfo,clientName:null==(r=null==t?void 0:t.appData)?void 0:r.clientName,serviceName:null==(i=null==t?void 0:t.appData)?void 0:i.serviceName,appItemId:null==t?void 0:t.itemId,appName:null==(r=null==t?void 0:t.appData)?void 0:r.appName,loopCount:null==t?void 0:t.loopCount},o=this.Rf(null==t?void 0:t.itemId);this.itemQueue.addQueueItem(o,e,this.ah,s)}dequeueSource(e="ApplicationInitiated"){if(!this.ah.enableInterstitialPlayback)return this.ah.supportGaplessVideo||this.isPreloading||"InvalidFormat"!==e||!this.isFirstItem?void(this.isPreloading&&(this.jd.push(this._dequeueSource(e)),this.Bd.next())):(this.logger.error("First item has invalid format for gapless. Probably video. Disabling gapless."),void(this.Dd=!1))}_dequeueSource(e="ApplicationInitiated"){const t=this.loadingItem.url,i=this.loadingItem.itemId,r=Le(this.loadingItem);return this.Ed.flushAll(r,1/0).pipe(Ee(()=>{this.Ed.msDuration=r,this.xd.removeLaterCues(this.Ed.msDuration),this.itemQueue.resetLoadingItem(),"InvalidFormat"!==e&&"FatalErrorWhileLoading"!==e||(this.Dd=!1),this._f({url:t,itemId:i},e)}))}_f(e,t){null===e?this.logger.error("dequeueSource called with no playing or loading item"):(t={url:e.url,evictedItemId:e.itemId,reason:t,evictedAppItemId:this.appItemIdFromItemId(e.itemId)},Object.assign(Object.assign({},t),{url:z(e.url)}),this.trigger(c.ITEM_EVICTED,t))}endSource(){if(this.Dd=!1,this.isPreloading){const e=Le(this.loadingItem);this.Ed.flushAndCallback(e,1/0,()=>{this.Ed.msDuration=e,this.xd.removeLaterCues(this.Ed.msDuration),this.itemQueue.resetLoadingItem()})}}get inGaplessMode(){return this.ah.gapless&&this.Dd}get isPreloading(){return this.itemQueue.isPreloading()}get isFirstItem(){return this.itemQueue.isFirstItem}get loadingItem(){return this.itemQueue.loadingItem}get playingItem(){return this.itemQueue.playingItem}get Cf(){var e;return null!=(e=null==(e=this.itemQueue.activeItem)?void 0:e.parentItemId)?e:null==(e=this.itemQueue.activeItem)?void 0:e.itemId}get url(){return this.playingItem?this.playingItem.url:this.loadingItem?this.loadingItem.url:void 0}destroy(){const t=this["logger"];return this.Fd.next(void 0),this.Yd.unsubscribe(),this.pn.next(),null!=this.Ao&&(this.Qr.add(),this.Ao.teardown(e=>{e&&t.error("RPCService teardown error:",e),this.Qr.done()}),this.Ao=null),this.toggleLogging(!1),this.wh.stop(),this.Qr.toPromise()}attachMedia(e){this.trigger(c.MEDIA_ATTACHING,{media:e}),this.Ad.next(e),this.trigger(c.MEDIA_ATTACHED,{media:e})}detachMedia(){var e;this.Ad.getValue()&&(this.Fd.next(void 0),this.trigger(c.MEDIA_DETACHING),null!=(e=this.Ur)&&e.detachMedia(),this.wh.stop(),this.Ad.next(null),this.trigger(c.MEDIA_DETACHED))}xf(e){}handleResolvedUri(e,t){this.xf("handleResolvedUri"),this.Ke.setCustomUrlResponse(e,t)}get levels(){var e;return null!=(e=null==(e=this.activeRootPlaylistQuery)?void 0:e.mediaOptionListQueries[we.Variant].filteredMediaOptionList)?e:[]}get audioTracks(){var e;return null!=(e=null==(e=this.activeRootPlaylistQuery)?void 0:e.mediaOptionListQueries[we.AltAudio].filteredMediaOptionList)?e:[]}get audioMediaOptions(){var e;return null!=(e=null==(e=this.activeRootPlaylistQuery)?void 0:e.audioMediaSelectionOptions)?e:[]}get subtitleMediaOptions(){var e;return null!=(e=null==(e=this.activeRootPlaylistQuery)?void 0:e.subtitleMediaSelectionOptions)?e:[]}getAudioMediaOptionsForItem(e){return this.Df(we.AltAudio,e)}getSubtitleMediaOptionsForItem(e){return this.Df(we.Subtitle,e)}Df(e,t){return(t=(t=this.itemQueue.getQueueItemForItemIdentifier(t))&&this.rf(t.itemId))&&null!=(e=e===we.AltAudio?t.audioMediaSelectionOptions:t.subtitleMediaSelectionOptions)?e:[]}getEnabledAudioMediaOptionForItem(e){return this.Lf(we.AltAudio,e)}getEnabledSubtitleMediaOptionForItem(e){return this.Lf(we.Subtitle,e)}Lf(e,t){return(t=(t=this.itemQueue.getQueueItemForItemIdentifier(t))&&this.rf(t.itemId))?t.enabledMediaSelectionOptionByType(e):void 0}get playbackLikelyToKeepUp(){var e;return null!=(e=null==(e=this.lf)?void 0:e.playbackLikelyToKeepUp)&&e}get bufferedRangesMap(){var e;return this.lf?(e=this.lf.getBufferedSegmentsByType(B.Variant).reduce((e,t)=>{if(r=this.itemQueue.getQueueItemForId(t.frag.itemId)){var i=null!=(i=r.interstitialAssetId)?i:r.name,r=Le(r),n=null!=(n=t.appendStart)?n:0,t=null!=(t=t.appendEnd)?t:0,n={start:Math.max(0,n-r),end:Math.max(0,t-r)};if(Object.prototype.hasOwnProperty.call(e,i)){const t=e[i];e[i]=[...t,n]}else e[i]=[n]}return e},{}),Object.entries(e).reduce((e,t)=>{var[t,i]=t;return e[t]=nh.getBufferedTimeRanges(i,this.ah.maxBufferHole),e},{})):{}}get seekableTimeRangesMap(){return this.itemQueue.queueItems.reduceRight((e,t)=>{var i,r,n,a=null!=(i=t.interstitialAssetId)?i:t.name;if(!Object.prototype.hasOwnProperty.call(e,a)){const i=this.Rd.getQueryForItem(t.itemId).lastLoadedMediaOptionDetails(we.Variant);i&&(t=Le(t),r=null!=(r=null==(r=(n=null!=(n=null==i?void 0:i.fragments)?n:[])[0])?void 0:r.start)?r:0,n=(n=n[n.length-1])&&fe(n.start)&&fe(n.duration)?n.start+n.duration:0,e[a]={start:Math.max(r-t,0),end:Math.max(n-t,0)})}return e},{})}set desiredRate(e){null!=e&&this.setRate(e)}get desiredRate(){var e;return null!=(e=null==(e=this.lf)?void 0:e.desiredRate)?e:0}get effectiveRate(){var e;return null!=(e=null==(e=this.lf)?void 0:e.effectiveRate)?e:0}get iframeMode(){var e;return null!=(e=null==(e=this.lf)?void 0:e.isIframeRate)&&e}get accessLog(){var e,t,i;return this.Qd&&this.activeRootPlaylistQuery&&(t=this.activeRootPlaylistQuery.itemId,i=null!=(e=null!=(e=null==(i=this.itemQueue.getQueueItemForId(t))?void 0:i.parentItemId)?e:null==i?void 0:i.itemId)?e:t,this.Qd)&&this.activeRootPlaylistQuery?this.Qd.getAccessLog(i):[]}getAccessLogForAppItemId(e){return e=this.itemQueue.getQueueItemForAppItemId(e),this.Qd&&e?this.Qd.getAccessLog(e.itemId):[]}get errorLog(){return this.Qd?this.Qd.errorLog:[]}setRate(e){this.logger.child({name:"iframes"});const t=this.desiredRate;if(e===t)return-2;if(!this.Ed||isNaN(e))return-1;e=Number(e);const i=Math.abs(e);if(!this.supportedFrameRates.some(e=>e===i))return-3;var r=fh(e),n=this.getCurrentIntegratedTimelineSegmentAndCurrentTime();if(r){if(this.interstitialActive)return this.Xd.cancelInterstitial(!0,n.targetTime,e,!0),0;if(this.playingItem&&this.itemQueue.activeItem&&this.playingItem.itemId!==this.itemQueue.activeItem.itemId){const t=this.Lc.getQueryForId(this.playingItem.itemId);if(null==t||!t.mediaOptionListQueries[we.Variant].hasIframes)return-1;if(this.loadingItem&&ke(this.loadingItem))return this.Xd.cancelInterstitial(!0,n.targetTime,e,!0),0}else{const e=this.activeRootPlaylistQuery;if(null==e||!e.mediaOptionListQueries[we.Variant].hasIframes)return-1}}return this.If(t,e),0}If(e,t,i){var T,A,E,O,w,r=fh(t),n=this.getCurrentIntegratedTimelineSegmentAndCurrentTime();r?this.wh.start({rootTimeSeconds:null!=i?i:n.targetTime+Le(this.playingItem),rate:t}):this.wh.stop(),(r=this.Fd.value)&&function(r,n,a,s,o,e,t,i){if(i||0!==e||1!==t)return i=fh(e),(e=fh(t))||i!==e;{const e=Hs.every(e=>{var t,e=r.enabledMediaOptionKeys[e],e=a.getQueryForOption(e),i=s.getQueryForId(r.statsId),e=e.mediaOptionDetailsEntity;return!(null!=(t=null==e?void 0:e.mediaOptionDetails)&&t.ptsKnown)||n.canContinuePlaybackWithoutGap(e.mediaOptionDetails,null!=(t=e.lastUpdateMillis)?t:0,i.getPlaylistEstimate(o),o.maxBufferHole)});return!e}}(r.rootPlaylistQuery,r.mediaSink.mediaQuery,r.mediaLibraryService,r.statsService,r.config,e,t,this.Xd.interstitialIsPlaying())?this.Hd.enqueue((T=r,A=e,E=t,O=i,w=n,{operation:gp.RateChange,priority:fp.High,execute:()=>(()=>{const{mediaSink:e,config:t,rootPlaylistService:i,rootPlaylistQuery:r,logger:n,interstitialController:a,iframeClock:s,mediaSelectionBossService:o,interstitialService:l,itemQueue:d}=T,u=r.itemId,c=e.mediaQuery,h=fh(A),p=fh(E);let m,f=NaN;if(p!==h){const T=e.mediaQuery;if(p)f=T.getBufferInfo(0,0)[we.Variant].buffered.end;else{const T=s.getCurrentTime().seconds-Le(d.playingItem);f=xe(O,Math.max(0,T))}if(t.enableInterstitialPlayback&&fe(f)){const T=l.interstitialQuery.integratedTimeline,A=Le(d.playingItem),E=Oy({seekTo:f+A,timeline:T,currentSegmentAndTime:w,itemQueue:d,interstitialController:a,interstitialService:l,logger:n});E&&(f=E.seekTo)}m=Mn(()=>(e.haveEnough=!1,e.pause(),e.flushAll(0,1/0)))}else if(p){const T=1/t.trickPlaybackConfig.minIframeDuration;m=e.flushData(B.Variant,c.currentTime+T,1/0)}else m=Mn(()=>(e.haveEnough=!1,e.pause(),e.flushAll(0,1/0,!0)));if(e.desiredRate=E,p!==h){var g=u,y=i,v=o,I=h,S=p;if(I!==S&&S){const b=y.getQueryForId(g),I=y.abrController,S=b.enabledVariantMediaOption;I.nextMaxAutoOptionId===Me.mediaOptionId&&(null!=v&&v.setTransformer(g,Re.BitrateFilter,new Wc(0,S.bitrate)),y.setNextMaxAutoOptionId(S.mediaOptionId))}Tf(yp.IframeModeChange,r.enabledVariantMediaOption,T),e.toggleTrickPlaybackMode(p)}if(null==m)return fe(f)&&(e.seekTo=f),Pe;{const T=[m];return fe(f)&&T.push(Mn(()=>c.flushing?(e.seekTo=f,Pe):Wr([ol(c.seekTo$.pipe(tn(1)),e=>fe(null==e?void 0:e.pos)),ol(c.updating$,e=>!e).pipe(Ee(()=>e.seekTo=f))]))),Pn(T)}})().pipe(Ee(My.bind(null,T,void 0)))})):this.Ed&&(this.Ed.desiredRate=t)}toggleLogging(e){this.Ud.next(e)}set skip(e){this.lf&&(this.wh.isStarted&&this.wh.start({rootTimeSeconds:this.realCurrentTime+e,rate:this.desiredRate}),this.realCurrentTime=Math.max(0,this.realCurrentTime+e))}Ff(e){const t=Le(this.playingItem);if(fe(t)&&e<t&&(e=t),this.isPreloading){e>Le(this.loadingItem)&&(e=Le(this.loadingItem));const t=this.lf.getBufferInfo(this.lf.currentTime,this.ah.maxBufferHole)[we.Variant];t&&e<t.buffered.start&&this.dequeueSource("SeekToUnbufferedTimeRanges")}this.nc.setUserSeek(e)}pf(r){var e=this.itemQueue.playingItem;if(e){var t=null==(t=this.logger)?void 0:t.child({name:"seek"}),n=this.Rc.interstitialQuery.integratedTimeline,a=this.realCurrentTime;let i=!1;if(!(this.ah.interstitialsConfiguredForAirPlayReceiver&&(ke(e)&&r<0&&(r=0),ke(e)&&e.itemTimelineEndPosition&&r>e.itemTimelineEndPosition&&(r=e.itemTimelineEndPosition),!ke(e)&&!fe(e.itemTimelineEndPosition)&&r<e.itemTimelineStartPosition&&0<=r&&(i=!0),!ke(e)&&fe(e.itemTimelineEndPosition)&&r>e.itemTimelineEndPosition&&(r=e.itemTimelineEndPosition),!ke(e))&&fe(e.itemTimelineEndPosition)&&r<e.itemTimelineStartPosition)){const s=this.getCurrentIntegratedTimelineSegmentAndCurrentTime(),o=Oy({seekTo:r,timeline:n,currentSegmentAndTime:s,itemQueue:this.itemQueue,interstitialController:this.Xd,interstitialService:this.Rc,logger:t}),{seekTo:l,newItem:d,isSeekBackwards:u}=o,c=null==d?void 0:d.itemId,h=l;if(u||0===l||c){const t=Math.min(l,a);this.Ed.flushAndCallback(Math.max(t-1,0),1/0,()=>{var t;if(c&&c!==(null==(t=this.itemQueue.activeItem)?void 0:t.itemId))Oe(()=>{var e;this.ah.interstitialsConfiguredForAirPlayReceiver||(this.Xd.reset(!0),this.Rc.setActiveInterstitialAssetId(null),this.Rc.setActiveInterstitialId(null)),this.Lc.setAVAnchor(null==(e=this.itemQueue.activeItem)?void 0:e.itemId,null),1<this.itemQueue.queueItems.length&&this.itemQueue.removeQueueItemsAfterId(c),this.itemQueue.setActive(c,{itemTimelineEndPosition:1/0,initialSeekTime:l,seekImmediately:!0}),this.itemQueue.setPlayingItem(d)});else{const t=this.itemQueue.playingItem,e=this.itemQueue.activeItem;t&&t.itemId!==(null==e?void 0:e.itemId)?Oe(()=>{var e={itemTimelineEndPosition:1/0,initialSeekTime:l,seekImmediately:!0};this.itemQueue.updateItemById(t.itemId,e),this.itemQueue.setPlayingItem(t),this.itemQueue.resetLoadingItem(!1),!ke(t)&&1<this.itemQueue.queueItems.length&&!this.ah.interstitialsConfiguredForAirPlayReceiver&&this.itemQueue.removeQueueItemsAfterId(t.itemId)}):(i&&Oe(()=>{var e={itemTimelineEndPosition:1/0,initialSeekTime:l,itemTimelineStartPosition:r};this.itemQueue.updateItemById(t.itemId,e)}),this.nc.setUserSeek(l))}})}else this.nc.setUserSeek(h)}}else this.nc.setUserSeek(r)}set seekTo(e){var t=Number(e);fe(t)?this.ah.enableInterstitialPlayback?0<this.nc.query.activeDequeueCount?this.itemQueue.playingItem&&this.nc.addHoldingInterstitialSeek(t,this.itemQueue.playingItem.itemId,ke(this.itemQueue.playingItem)):this.pf(t):this.inGaplessMode?this.Ff(t):(this.wh.isStarted&&this.wh.start({rootTimeSeconds:t,rate:this.desiredRate}),this.nc.setUserSeek(t)):this.logger.error(`[seek] got invalid seek value `+e)}seekToDate(e){e instanceof Date&&fe(e.getTime())&&this.nc.setUserSeek(e)}get availableProgramDateTime(){return new Map(this.jf)}get jf(){var e,t=this.Bf;if(!t)return[];const i=this.Cf,r=this.itemQueue.getQueueItemForId(i),n=null!=(e=null==t?void 0:t.pdtToMSN)?e:[],a=this.ah.enableInterstitialPlayback?Le(r):0,s=null!=(e=null==t?void 0:t.fragments)?e:[],o=null==t?void 0:t.startSN;return 0===n.length||0===s.length?[]:n.map(([e,t])=>[e,(null==(e=s[t-o])?void 0:e.start)-a])}get Bf(){var e;if(this.activeRootPlaylistQuery&&this.playingItem)return e=this.Cf,this.Rd.getQueryForItem(e).lastLoadedMediaOptionDetails(we.Variant)}get playingDate(){var e,t=this.Bf;if(t)return e=this.Cf,e=this.itemQueue.getQueueItemForId(e),e=this.ah.enableInterstitialPlayback?Le(e):0,Z(t.pdtToMSN,t.fragments,this.realCurrentTime+e)}get seekableTimeRanges(){var e;return null!=(e=null==(e=this.lf)?void 0:e.seekableTimeRanges)?e:[]}get isLive(){var e;return!!this.playingItem&&(e=ke(this.playingItem)?this.playingItem.parentItemId:this.playingItem.itemId,null!=(e=null==(e=this.Rd.query.getEntity(e))?void 0:e.liveOrEvent))&&e}get isPlayingAtLive(){var e;return null!=(e=null==(e=this.lf)?void 0:e.isPlayingAtLive)&&e}set variantId(e){}selectPersistentID(t,e,i){var r;const n=this.activeRootPlaylistQuery,a=null==(r=this.playingItem)?void 0:r.itemId,s=null==(r=this.playingItem)?void 0:r.parentItemId;if(!n||Fo(a)){const r=null==n?void 0:n.itemId;if(!n||Fo(r))t===we.AltAudio?this.primaryAudioSelectedPersistentID=e:this.primarySubtitleSelectedPersistentID=e;else{const r=we.AltAudio===t?this.audioSelectedPersistentID:this.subtitleSelectedPersistentID;!fe(r)&&fe(e)&&e<0||r===e||null!=a&&(this.logger.error(`[${Vs[t]}] reloading playingItem ${a} to load persistentID ${e}, selectedMediaArray=`+JSON.stringify(i)),Oe(()=>{this.Uf(a,i);var e={parentItemId:s,itemId:a};t===we.AltAudio?e.userSwitchAudioTrack=!0:e.userSwitchSubtitleTrack=!0,this.reloadPlayingItem(e,this.lf.currentTime)}))}}else this.logger.error(`[${Vs[t]}] attempting to set persistentID ${e} when playing interstitial `+a)}get audioSelectedPersistentID(){var e;return null==(e=null==(e=this.nc.query.alternateMatchingInfo)?void 0:e.audioMatchingInfo)?void 0:e.persistentId}set audioSelectedPersistentID(e){var t=[{MediaSelectionGroupMediaType:Is.AUDIO,MediaSelectionOptionsPersistentID:e}];this.selectPersistentID(we.AltAudio,e,t)}set primaryAudioSelectedPersistentID(t){var e,i=this.activeRootPlaylistQuery,r=null==i?void 0:i.mediaOptionListQueries[we.AltAudio].filteredMediaOptionList,n=null==i?void 0:i.itemId;if(r)t!==(null==(e=i.enabledAlternateMediaOptionByType(we.AltAudio))?void 0:e.persistentID)&&(e={itemId:n,language:null==(i=r.find(e=>e.persistentID===t))?void 0:i.lang,name:null==i?void 0:i.name,persistentId:t,characteristics:null==i?void 0:i.characteristics},this.nc.setAudioAlternateMatchingInfo(e),r=this.nc.query.alternateMatchingInfo,this.Lc.setEnabledMediaOptionTupleWithMatchedGroups(n,we.AltAudio,r,this.Lc,{userInitiated:!0,triggerEvent:!0}));else if(fe(t)&&!(t<0)){const e={itemId:n,language:void 0,name:void 0,persistentId:t,characteristics:void 0};this.nc.setAudioAlternateMatchingInfo(e)}}setInterstitialAudioSelectedPersistentId(e,t,i){var r=this.getInterstitialAudioSelectedPersistentId(e,i);fe(r)&&r===t||this.Sf&&this.Sf.updateInterstitialAudioSelectedPersistentId(t,e,i,this.realCurrentTime)}getInterstitialAudioSelectedPersistentId(e,t){var i=this.Rc.interstitialQuery;return"string"==typeof t?null==(t=i.getAltAudioSelectedMatchingInfoForInterstitialAssetId(t,e))?void 0:t.persistentId:null==(t=i.getAltAudioSelectedMatchingInfoForInterstitialId(e))?void 0:t.persistentId}get subtitleSelectedPersistentID(){var e;return null==(e=null==(e=this.nc.query.alternateMatchingInfo)?void 0:e.subtitleMatchingInfo)?void 0:e.persistentId}set subtitleSelectedPersistentID(e){var t=[{MediaSelectionGroupMediaType:Is.SUBTITLE,MediaSelectionOptionsPersistentID:e,MediaSelectionOptionsDisplaysNonForcedSubtitles:vs.YES}];this.selectPersistentID(we.Subtitle,e,t)}set primarySubtitleSelectedPersistentID(t){var e;const i=this.activeRootPlaylistQuery,r=null==i?void 0:i.mediaOptionListQueries[we.Subtitle].filteredMediaOptionList;if(r){if(t!==(null==(e=i.enabledAlternateMediaOptionByType(we.Subtitle))?void 0:e.persistentID)){var n=i.itemId;if(0!==r.length||fe(t)&&!(t<0))if(fe(t)&&-1!==t){const e=r.find(e=>e.persistentID===t),i={itemId:n,language:null==e?void 0:e.lang,name:null==e?void 0:e.name,forced:null==e?void 0:e.forced,persistentId:t,characteristics:null==e?void 0:e.characteristics};this.nc.setSubtitleAlternateMatchingInfo(i);var a=this.nc.query.alternateMatchingInfo;this.Lc.setEnabledMediaOptionTupleWithMatchedGroups(n,we.Subtitle,a,this.Lc,{userInitiated:!0})}else this.nc.setSubtitleAlternateMatchingInfo(null),this.Lc.setEnabledMediaOptionByType(n,we.Subtitle,Me)}}else if(fe(t)&&!(t<0)){const e={language:void 0,name:void 0,forced:void 0,persistentId:t,characteristics:void 0};this.nc.setSubtitleAlternateMatchingInfo(e)}}setInterstitialSubtitleSelectedPersistentId(e,t,i){var r=this.getInterstitialSubtitleSelectedPersistentId(e,i);fe(r)&&r===t||!fe(t)||this.Sf&&this.Sf.updateInterstitialSubtitleSelectedPersistentId(t,e,i,this.realCurrentTime)}getInterstitialSubtitleSelectedPersistentId(e,t){var i=this.Rc.interstitialQuery;return"string"==typeof t?null==(t=i.getSubtitleSelectedMatchingInfoForInterstitialAssetId(t,e))?void 0:t.persistentId:null==(t=i.getSubtitleSelectedMatchingInfoForInterstitialId(e))?void 0:t.persistentId}get iframeVariants(){var e=this.$f;return e?this.ah.enableBoss?this.Wd.getQuery(e.itemId,this.logger).variantsFor(ys.ImageVariant):e.rootPlaylistEntity.iframeVariants:[]}loadImageIframeData$(u,c){const h=this.$f;if(!h)return Fr(()=>new me(!1,pe.InvalidLoadImageIframe));const n=function(e,t){if(!e.length)throw new TypeError("Expected variant array");var i=t?e.find(e=>e.mediaOptionId===t):e[0];if(i)return i;throw new me(!1,pe.IFrameVariantNotFound,`Could not find image I-frame variant "${t}" of ${e.length} avaiable variants`)}(this.iframeVariants,null==c?void 0:c.variantId),e=function(a,s,o,l,d,u,c,h,p,m){var e=a["itemId"],t=o.getQueryForOption(a);t.hasEntity(e)||o.createMediaLibraryEntity(e);const f=t.mediaOptionDetails;return f&&("VOD"===f.type||f.liveOrEvent&&!Of(f,t.mediaOptionDetailsEntity.lastUpdateMillis,c.liveAllowLowLatencyPlayback))?(o.setLastAccessed(a),be(f)):null!==(e=o.inFlightDetails)&&_s(e.mediaOption,a)?e.request:(t=Mn(()=>{var{playlistLoadPolicy:e,keySystemPreference:t}=c,i=s.masterVariableList,r=u.query.extendMaxTTFB,n=a.mediaOptionType;return o.setDetailsLoading(a),Yf(a,s.baseUrl,s.itemStartOffsets[n],s.appItemId,c,c,e,h,m,t,i,r,p,f).pipe(ve(wg(a,0,o,l,d,void 0,c,m)),ye(e=>{if(f)return be(f);throw e}),Hr(()=>{o.inFlightDetails=null,o.setDetailsLoading(a,!1)}))}).pipe(Jr()),o.inFlightDetails={mediaOption:a,request:t},t)}(n,h,(this.Lc,this.Rd),this.Rc,this.Nc,this.nc,this.ah,this.Ke,this._d,this.logger).pipe(Dr(1),Ae(e=>{{var[e,r,t,n,a,s=0]=[u,e,h.appItemId,this.ah,this.Ke,(this.logger,h.itemStartPosition)];const o=r.fragments,l=e+(s||0),d=Math.min(1,Math.max(0,(null==c?void 0:c.snapToNextFrameFactor)||0));let i=wo.search(o,function(e,t,i){var r=i.start,i=i.duration;return r<=(e+=i*t)&&e<r+i?0:e-r}.bind(null,l,d));if(!i){let e=NaN,t=NaN;if(o.length){const r=o[o.length-1];e=o[0].start,t=r.start+r.duration,l<t&&l+1>e?i=o[0]:l>e&&l-1<t&&(i=o[o.length-1])}if(!i)return Fr(()=>new me(!1,pe.NoFragmentFoundAtSearchPositionInPlaylist,`Could not find fragment at pos ${l} in playlist "${r.mediaOptionId}" [${e}-${t}]`))}return To(i,r.url||"",t,n,n.fragLoadPolicy,a).pipe(ve(({mediaFragment:e,loadedData:t,bwSample:i})=>s?[Object.assign(Object.assign({},e),{start:e.start-s}),t,i]:[e,t,i]))}}),un((null==c?void 0:c.timeoutMs)||5e3),ve(e=>{var[[e,t,i],r]=[e,n];if(t=H.findFirstBox(new Uint8Array(t),["mdat"]))return{fragment:e,data:t,stats:i,variant:r};throw new me(!1,pe.MdatNotFound)}));return Wr([e,this.pn]).pipe(ve(e=>{if(e)return e;throw new me(!1,pe.InvalidLoadImageIframe)}))}get $f(){let e;var t=null!=(t=null==(t=this.itemQueue.activeItem)?void 0:t.parentItemId)?t:null==(t=this.itemQueue.activeItem)?void 0:t.itemId;return this.ah.enableInterstitialPlayback?t&&(e=this.Lc.getQueryForId(t)):e=this.activeRootPlaylistQuery,e}get selectedMediaArray(){var e=this.itemQueue.primaryItem;return e?this.getSelectedMediaArrayForItemId({itemId:e.itemId}):[]}set selectedMediaArray(e){this.activeRootPlaylistQuery&&e.forEach(e=>{e.MediaSelectionGroupMediaType===Is.AUDIO||e.MediaSelectionOptionsMediaType===Is.AUDIO?this.audioSelectedPersistentID=e.MediaSelectionOptionsPersistentID:e.MediaSelectionGroupMediaType!==Is.SUBTITLE&&e.MediaSelectionOptionsMediaType!==Is.SUBTITLE&&e.MediaSelectionOptionsMediaType!==Is.CLOSEDCAPTION||(this.subtitleSelectedPersistentID=e.MediaSelectionOptionsPersistentID)})}getSelectedMediaArrayForItemId(e){return(e=this.itemQueue.getQueueItemForItemIdentifier(e))&&this.Lc.getQueryForId(e.itemId)?this.Vf(e):[]}getHTMLTextTrack(e){return this.xd.getExistingHTMLTextTrackWithSubtitleTrackId(e)}get keysystems(){return this.Cd.availableKeySystems}setProtectionData(e){this.Cd.initialize(e)}generateKeyRequest(e,t){this.xf("generateKeyRequest"),this.Cd.generateRequest(e,t)}setLicenseResponse(e,t){this.xf("setLicenseResponse"),this.Cd.setLicenseResponse(e,t)}get interstitialActive(){var e=this.itemQueue.playingItem;return!!e&&ke(e)}removeInterstitials(e){this.Rc.removeInterstitials(e)}cancelInterstitial(e,t){var i=this.Rc.interstitialQuery.getInterstitialForId(e),r=this.itemQueue.playingItem,n=this.itemQueue.activeItem;if(r&&n&&i)if(t=null!=t?t:C(i.startTime)+Do(i),i=r.interstitialId,n&&ke(n)&&i===e)this.Xd.cancelInterstitial(!1,t,null,!0);else{const e=n.itemStartOffsets[we.Variant]+t;this.itemQueue.updateItemById(n.itemId,{initialSeekTime:e}),this.nc.setUserSeek(e)}}createInterstitials(e){e=e.filter(e=>zh(e)),this.Rc.addInterstitials(e)}updateInterstitial(e,t){this.Rc.updateInterstitial(e,t)}setTimeToPauseBuffer(e,t=!1){if(!this.ah.enableInterstitialPlayback||!this.ah.interstitialsConfiguredForAirPlayReceiver)throw new me(!1,pe.UnableToSetTimeToPauseBufferIncorrectConfiguration,"API is only available if config.enableInterstitialPlayback and config.interstitialsConfiguredForAirPlayReceiver is set to true");var i=function(t,e){return(e=ee(e,e=>!ke(e)||e.itemId===t.itemId))&&!ke(e)?e:void 0}(this.itemQueue.activeItem,this.itemQueue.queueItems);i&&this.itemQueue.updateItemById(i.itemId,{timeToPauseBuffer:e,snapOut:t})}queueInterstitialSource(e,t,i,r,n,a,s){var o,t=t&&0<t.length?t:void 0,i=i&&0<i.length?i:void 0,l=this.itemQueue.primaryItem;if(!this.ah.enableInterstitialPlayback||!this.ah.interstitialsConfiguredForAirPlayReceiver)throw new me(!1,pe.UnableToQueueInterstitialSourceIncorrectConfiguration,"API is only available if config.enableInterstitialPlayback and config.interstitialsConfiguredForAirPlayReceiver is set to true");if(l)return o=t?`interstitial:${t}:asset_`+i:l.name,e=t?e:l.url,(l=_y(l,!0,this.desiredRate,r,n,a,s,i)).interstitialId=t,l.interstitialAssetId=i,r=Vy.createItem(o,e,this.ah,this.logger,l),this.itemQueue.insertQueueItem(r),r.itemId;throw new me(!1,pe.UnableToQueueInterstitialSourceMissingPrimaryItem,"Unable to add interstitial to queue, primary item is missing, make sure to call loadSource with primary item url first")}dequeueInterstitialSource(e,t){if(!this.ah.enableInterstitialPlayback||!this.ah.interstitialsConfiguredForAirPlayReceiver)throw new me(!1,pe.UnableToQueueInterstitialSourceIncorrectConfiguration,"API is only available if config.enableInterstitialPlayback and config.interstitialsConfiguredForAirPlayReceiver is set to true");if(!this.Ed)throw new me(!1,pe.UnableToDeQueueInterstitialSourceMissingMediaElementAdaptor,"Missing media element adaptor, this method cannot be called if media element is detached");this.nc.incrementActiveDequeueCount(),this.Xd.dequeueInterstitial(this.Ed,this.nc,this.Lc,e,t)}get integratedTimeline$(){return this.Rc.interstitialQuery.integratedTimeline$}createIntegratedTimeline(e){if(this.logger.child({name:"AirPlay Interstitial"}),this.ah.enableInterstitialPlayback&&this.ah.interstitialsConfiguredForAirPlayReceiver){var t=this.itemQueue.queueItems.find(e=>!e.parentItemId);if(t){var i=t.itemId;if(i=this.Rd.getQueryForItem(i)){var r,n=i.mediaLibraryEntity.lastLoadedMediaOptionIds[we.Variant];if(n&&"Nah"!==n)if(i=i.mediaLibraryEntity.mediaOptionDetailsEntityRecord[n])if(n=i.mediaOptionDetails)return{totalduration:i,pdtToMSN:n,fragments:r}=n,Uo(i,e,t.itemStartOffsets[B.Variant],n,r,this.ah)}}}}redoPlatformCapabilities(){var e=this.playingItem||this.itemQueue.activeItem;if(e)return this.reloadPlayingItem({parentItemId:e.parentItemId,itemId:e.itemId,reloadedForCapChangeOrErrorRecovery:!0},null!=(e=null==(e=this.lf)?void 0:e.currentTime)?e:0)}Vf(e){const{itemId:t,interstitialId:i,interstitialAssetId:r}=e,n=[];let a;if(Fo(t))a=this.nc.query.alternateMatchingInfo;else{const e=this.Rc.interstitialQuery;if(i||r)a=e.getAlternateMatchingInfoForInterstitialAssetId(r,i);else{const{interstitialId:i,interstitialAssetId:r}=jd(t);a=e.getAlternateMatchingInfoForInterstitialAssetId(r,i)}}if(!a)return[];var s=a.audioMatchingInfo,o=a.subtitleMatchingInfo;if(s){const e={MediaSelectionGroupMediaType:Is.AUDIO,MediaSelectionOptionsPersistentID:s.persistentId,MediaSelectionOptionsExtendedLanguageTag:s.language,MediaSelectionOptionsName:s.name,MediaSelectionOptionsTaggedMediaCharacteristics:s.characteristics,MediaSelectionOptionsLanguageCode:Dp.mapValue(s.language)};n.push(e)}if(o){const e={MediaSelectionGroupMediaType:Is.SUBTITLE,MediaSelectionOptionsPersistentID:o.persistentId,MediaSelectionOptionsForced:o.forced,MediaSelectionOptionsExtendedLanguageTag:o.language,MediaSelectionOptionsName:o.name,MediaSelectionOptionsTaggedMediaCharacteristics:o.characteristics,MediaSelectionOptionsLanguageCode:Dp.mapValue(o.language)};n.push(e)}return n}Uf(r,e){var n,a,s,o,l=this.itemQueue.getQueueItemForId(r),d=this.Lc.getQueryForId(null==l?void 0:l.itemId);if(d&&l){const u=e.find(e=>e.MediaSelectionGroupMediaType===Is.AUDIO);let t;if(u){let e=u.MediaSelectionOptionsExtendedLanguageTag;if(!e){const r=(null!=(n=d.audioMediaSelectionOptions)?n:[]).find(e=>e.MediaSelectionOptionsPersistentID===u.MediaSelectionOptionsPersistentID);e=null==r?void 0:r.MediaSelectionOptionsExtendedLanguageTag}const s=u.MediaSelectionOptionsPersistentID,o=null==(a=this.getAudioMediaOptionsForItem({itemId:l.itemId}).find(e=>e.MediaSelectionOptionsPersistentID==s))?void 0:a.MediaSelectionOptionsTaggedMediaCharacteristics;t={itemId:r,language:e,name:u.MediaSelectionOptionsName,persistentId:s,characteristics:o}}const c=e.find(e=>e.MediaSelectionGroupMediaType===Is.SUBTITLE);let i;if(c){let e=c.MediaSelectionOptionsExtendedLanguageTag;if(!e){const r=(null!=(s=d.subtitleMediaSelectionOptions)?s:[]).find(e=>e.MediaSelectionOptionsPersistentID===c.MediaSelectionOptionsPersistentID);e=null==r?void 0:r.MediaSelectionOptionsExtendedLanguageTag}const n=c.MediaSelectionOptionsPersistentID,a=null==(o=this.getSubtitleMediaOptionsForItem({itemId:l.itemId}).find(e=>e.MediaSelectionOptionsPersistentID==n))?void 0:o.MediaSelectionOptionsTaggedMediaCharacteristics;i={itemId:r,language:e,name:c.MediaSelectionOptionsName,persistentId:n,forced:!c.MediaSelectionOptionsDisplaysNonForcedSubtitles,characteristics:a}}Oe(()=>{u&&this.nc.setAudioAlternateMatchingInfo(t),c&&this.nc.setSubtitleAlternateMatchingInfo(i)})}}changeTracks(e,t=!0){var i;const r=this.playingItem?this.playingItem.itemId:null==(i=this.loadingItem)?void 0:i.itemId,n=null==(i=this.itemQueue.primaryItem)?void 0:i.itemId,a=t?n:r,s=Kp.toLocale(e).baseName;let o=[];e&&(o=[{MediaSelectionGroupMediaType:Is.AUDIO,MediaSelectionOptionsExtendedLanguageTag:s},{MediaSelectionGroupMediaType:Is.SUBTITLE,MediaSelectionOptionsExtendedLanguageTag:s,MediaSelectionOptionsDisplaysNonForcedSubtitles:vs.YES}]),Oe(()=>{var e;a&&this.Uf(a,o),this.playingItem&&this.reloadPlayingItem({parentItemId:this.playingItem.parentItemId,itemId:this.playingItem.itemId,userSwitchAudioTrack:!0,userSwitchSubtitleTrack:!0},null!=(e=null==(e=this.lf)?void 0:e.currentTime)?e:0)})}reloadPlayingItem(e,t){var i,r,n;this.lf?(n=null==(r=this.itemQueue.activeItem)?void 0:r.itemId,this.ah.enableInterstitialPlayback?(this.Lc.setAVAnchor(null==(i=this.itemQueue.activeItem)?void 0:i.itemId,null),this.Xd.reloadPlayingItem(t,this.realCurrentTime,e,this.Ed,this.xd)):(this.itemQueue.setActive(null,{itemStartOffsets:r.itemStartOffsets}),this.itemQueue.setActiveWithContext(n,e,{itemStartOffsets:r.itemStartOffsets,initialSeekTime:t,seekImmediately:!0,replaceItemAction:Ua.RESET_MEDIASOURCE}))):this.logger.error("mediaSink not ready yet")}endItem(){this.jd=[Mn(this.Nf.bind(this,void 0))],this.Bd.next()}Nf(i){var e;const r=null==(e=this.itemQueue.activeItem)?void 0:e.itemId,n=!!i,a=!!this.Rd.getSegmentRecord(null==(e=null==i?void 0:i.itemOptions)?void 0:e.itemId),s=[];return Oe(()=>{var e,t;if(r){const i=this.nc.query.currentConfig,t=(this.Fd.next(void 0),!this.ah.enableItemPreloading||!a);if(this.Rd.clear(this.logger,t),this.Lc.removeAll(),this.nc.reset(),i.enableInterstitialPlayback&&(null!=(e=this.Rc)&&e.reset(),null!=(e=this.Xd))&&e.reset(),null!=(e=this.xd)&&e.reset(),null!=(e=this.Ed)&&e.reset(),this.itemQueue.resetInternal(),i.enableBoss&&null!=(e=this.Wd)&&e.destroyItem(r),this.Ur.endItem(r),this.Ed){const i=this.Ed.mediaQuery;if(i.combinedBuffer.length){let e;this.Ed.haveEnough=!1,i.paused||this.Ed.pause(),n?this.ah.replaceItemAction===Ua.DO_NOTHING&&(e=this.Ed.flushAll(0,1/0)):e=this.Ed.flushAll(0,1/0).pipe(Ae(()=>ol(this.Ed.mediaQuery.updating$,e=>!e)),ve(()=>{this.Ed.msDuration=0})),e&&s.unshift(e)}}}if(n){const e=null!=(t=i.itemOptions)?t:{};r&&this.ah.replaceItemAction&&(e.replaceItemAction=this.ah.replaceItemAction),this.Pf(i.url,e,i.initialSeekTime,i.timeToPauseBuffer)}}),0<s.length?Pn(s).pipe(ve(()=>{})):Pe}levelWithPersistentId(e){this.xf("levelWithPersistentId")}startLoad(e){this.xf("startLoad"),fe(e)&&(this.seekTo=e)}stopLoad(){}get config(){return this.ah}get media(){return null!=this.Ad.value}set subtitleDisplay(e){this.xf("set subtitleDisplay")}gf(p,e,m,f){if(this.Sh.setRootPlaylistQuery(null),this.jc.next(null),null!=(t=this.Mf)&&t.reset(),this.Hd.clear(),this.xd&&p&&this.xd.removeLaterCues(p.itemStartOffsets[we.Variant]),!p)return f.next(null),f.complete();const g=dl(f),y=Object.assign({},m);if(ke(p))for(const p of fs){const e=m[p].interstitial,f=m[p];y[p]=Object.assign(Object.assign({},f),{default:e,customURL:e})}var t=function(r,e,n,t,a,i,s,o,l,d,u,c,h,p,m,f){const g=r["itemId"],y=n.getQueryForId(g),v=n["logger"],I=p.getActiveItemContext(g);if(y.hasEntity(g)){n.setActive(g);const e=y.mediaOptionListQueries[we.Variant].hasIframes;if(fh(r.initialRate)&&e){const r=Af(yp.IframeModeChange,{rootPlaylistService:n,rootPlaylistQuery:y,mediaLibraryService:t,mediaSelectionBossService:s,hlsService:o,config:l,statsService:c,logger:v,mediaSink:m});r&&n.setEnabledMediaOptions(y.itemId,r)}else{let i=u.alternateMatchingInfo;if(ke(r)){const{audioMatchingInfo:n,subtitleMatchingInfo:t}=a.interstitialQuery.getAlternateMatchingInfoForInterstitialAssetId(r.interstitialAssetId,r.interstitialId);i?(n&&(i.audioMatchingInfo=n),t&&(i.subtitleMatchingInfo=t)):i={audioMatchingInfo:n,subtitleMatchingInfo:t}}if(i){const r=[null,null!=I&&I.userSwitchAudioTrack?{userInitiated:!0,triggerEvent:!0}:null,null!=I&&I.userSwitchSubtitleTrack?{userInitiated:!0}:null];{var S=g,b=(p=i,m=r,u=y,n),T=l,A=[!0,Boolean(p.audioMatchingInfo),Boolean(p.subtitleMatchingInfo)],E=u.preferHDR,O=u.enabledVariantMediaOption,w=p.audioMatchingInfo,R=p.subtitleMatchingInfo;let e=null==w?void 0:w.persistentId,t=null==R?void 0:R.persistentId;if(!fe(e)){const S=hy(0,0,p.audioMatchingInfo,null==(w=u.audioMediaSelectionGroup)?void 0:w.MediaSelectionGroupOptions,T.enableInterstitialPlayback);e=null==S?void 0:S.MediaSelectionOptionsPersistentID}if(!fe(t)){const S=hy(0,0,p.subtitleMatchingInfo,null==(R=u.subtitleMediaSelectionGroup)?void 0:R.MediaSelectionGroupOptions,T.enableInterstitialPlayback);t=null==S?void 0:S.MediaSelectionOptionsPersistentID}w=b.getBestMediaOptionTupleFromVariantAndPersistentId(u,O,e,t,A,[],null,!E,!1,!1,!1),Bs(w[we.Variant])&&b.setEnabledMediaOptionsAndSwitchContexts(S,w,m)}}}return be(y.getEntity(g))}let M;if(n.setLoading(!0),p=Ig(r),R=l.enableItemPreloading?t.recallPrefetchCacheEntry(r.appItemId,qf.Manifest,p,v):void 0)M=R.pipe(ve(e=>((e=Object.assign({},e)).itemStartOffsets=r.itemStartOffsets,n.setRootPlaylistEntity(g,e),e)));else{t.clearPrefetchCache(v);const u=fh(r.initialRate);M=Sy(r,e,v,n,t,a,i,s,o,l,d,c,f,h,I,performance.now(),u,sg(g,null,no(r,e),0,!1,y,n,c))}return M.pipe(Hr(()=>{n.setLoading(!1)}))}(p,m.manifestLoadPolicy,this.Lc,this.Rd,this.Rc,this.Ke,this.Wd,this.nc,m,this.Pd.query,this.nc.query,this.Nc,this.Sh,this.itemQueue,this.Ed,this._d);Ce(g,t.pipe(Ee(e=>{var t=this.Lc.getQueryForId(e.itemId),i=(this.Sh.setRootPlaylistQuery(t),this.jc.next(t),this.Sh.triggerManifestParsed(t),Ce(g,function(t,i,e,r,n,a,s,o,l,d,u,c,h,p){const m=i["canUseNetworkResourcesForLiveStreamingWhilePaused"],f={rootPlaylistQuery:r,rootPlaylistService:e,statsService:a,rtcService:s,logger:t,config:i,interstitialService:o,customUrlLoader:u,itemQueue:c,hlsService:l,playerEvents:h,keyTracker:p},g=[];return Qs.forEach(e=>{e!==we.Variant&&!r.hasAlternateWithUrl(e)||g.push(r.enabledMediaOptionByType$(e).pipe(Ae(function(e){return Us(e)&&Bs(e)?n.retrieveMediaOptionDetails(f,e,!1,!1).pipe(Qr(t=>function(e,t){if(!e)return Se;var{mediaOptionDetails:e,lastUpdateMillis:i,unchangedCount:r}=e;if(null==e||!e.liveOrEvent)return Se;if(Of(e,null!=i?i:0,t))return rr(0).pipe();let n=Ef(e);return 0<r&&(n/=2,n=Math.max(n,5e3)),n=n-(performance.now()-(null!=i?i:0))+0,rr(n=Math.max(1e3,Math.round(n))).pipe()}(n.getQueryForOption(t).mediaOptionDetailsEntity,i.liveAllowLowLatencyPlayback).pipe(Ae(()=>m?be(!0):d.pipe(Ae(e=>e?e.desiredRate$:be(0))).pipe(ve(e=>0!==e),Te())),Ae(e=>e?n.retrieveMediaOptionDetails(f,t,!1,!0):Se),Dr(1)),1)):Se}),Gy(t,"loadMediaOptions")))}),Bn(...g)}(this.logger,y,this.Lc,t,this.Rd,this.Nc,this.Ur,this.Rc,this.nc,this.mediaElementQuery$,this.Ke,this.itemQueue,this.Sh,this._d)),null==this.Mf&&(this.Mf=new Jy(m,this.logger,this.Nd.mux)),this.Mf),e={logger:this.logger,config:m,statsService:this.Nc,rootPlaylistQuery:t,rootPlaylistService:this.Lc,interstitialService:this.Rc,mediaParser:i,gaplessInstance:this.$d,keySystemAdapter:this.Cd,rpcClients:this.Nd,rtcService:this.Ur,customUrlLoader:this.Ke,itemQueue:this.itemQueue,hlsService:this.nc,playerEvents:this.Sh,mediaLibraryService:this.Rd,keyTracker:this._d};if(e.config.enableItemPreloading){const e=p.name;if(this.Rd.getPrefetchCacheEntry(e,qf.VariantPlaylist))return f.next({rootPlaylistQuery:t,mediaParser:i,config:m})}{var r=g,n=this.Rd,a=this.Cd,s=this.nc.query,o=p.initialSeekTime,l=this.desiredRate;const{rootPlaylistQuery:d,logger:u}=e,c=function(a,s,o,l,d,u){const{rootPlaylistQuery:c,config:h}=o,p=c.appItemId;return e=>e.pipe(Fg(a,1),Ae((i,r)=>{if(i&&0===r){const r=Object.values(i.initSegments);let e,t=NaN;if(i.liveOrEvent)1===r.length&&(t=r[0].discoSeqNum);else{const a=l.pendingSeek;n=a instanceof Date?Ne(i.pdtToMSN,i.fragments,a):jy(null!=(n=null!=a?a:d)?n:0,!0,[i,null],h,c,void 0,!1),e=Hy.findFragmentBySNAndBuffer(void 0,i.fragments,n,Am(i)),t=xe(null==e?void 0:e.discoSeqNum,NaN)}var n=new Array;if(e){const s=Sm(e,u,{start:0,end:0,len:0},h.trickPlaybackConfig.minIframeDuration);n.push(a.cacheFrag(o,s.foundFrag.mediaFragment))}else fe(t)&&n.push(a.retrieveInitSegmentCacheEntity(o,i,t));if(null!=e&&e.keyTagInfo&&s){const a=e.keyTagInfo,{itemId:s,mediaOptionId:l,mediaOptionType:d}=e;n.push(xg(o,a,{itemId:s,mediaOptionId:l,mediaOptionType:d,appItemId:p}))}if(0<n.length)return Pn(n)}return Pe}),Dr(1))}(n,a,e,s,o,l),h={add:r.add,error:e=>{u.error(`prefetchFirstSegAndKey: err=`+e.message)}};Ce(h,d.enabledMediaOptionByType$(we.Variant).pipe(c)),d.hasAlternateWithUrl(we.AltAudio)&&Ce(h,d.enabledMediaOptionByType$(we.AltAudio).pipe(c))}f.next({rootPlaylistQuery:t,mediaParser:i,config:m})}))),null==this.Mf&&(this.Mf=new Jy(m,this.logger,this.Nd.mux))}}},"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||hv).Hls=t()}(!1);
